{
  "circa": {
    "title": "Livepeer Onchain Treasury Upgrade",
    "sponsor": "Livepeer",
    "slug": "2023-08-livepeer",
    "date": "2023-10-17",
    "findings": "https://github.com/code-423n4/2023-08-livepeer-findings/issues",
    "contest": 282
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit outlined in this document, C4 conducted an analysis of the Livepeer Onchain Treasury Upgrade smart contract system written in Solidity. The audit took place between August 31—September 6 2023.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>30 Wardens contributed reports to the Livepeer Onchain Treasury Upgrade:</p>\n<ol>\n<li><a href=\"https://code4rena.com/@Banditx0x\">Banditx0x</a></li>\n<li><a href=\"https://code4rena.com/@ladboy233\">ladboy233</a></li>\n<li><a href=\"https://code4rena.com/@Vagner\">Vagner</a></li>\n<li><a href=\"https://code4rena.com/@bronze_pickaxe\">bronze_pickaxe</a></li>\n<li><a href=\"https://code4rena.com/@Krace\">Krace</a></li>\n<li><a href=\"https://code4rena.com/@VAD37\">VAD37</a></li>\n<li><a href=\"https://code4rena.com/@ether_sky\">ether_sky</a></li>\n<li><a href=\"https://code4rena.com/@rvierdiiev\">rvierdiiev</a></li>\n<li><a href=\"https://code4rena.com/@ADM\">ADM</a></li>\n<li><a href=\"https://code4rena.com/@Sathish9098\">Sathish9098</a></li>\n<li><a href=\"https://code4rena.com/@catellatech\">catellatech</a></li>\n<li><a href=\"https://code4rena.com/@twicek\">twicek</a></li>\n<li><a href=\"https://code4rena.com/@HChang26\">HChang26</a></li>\n<li><a href=\"https://code4rena.com/@JayShreeRAM\">JayShreeRAM</a></li>\n<li><a href=\"https://code4rena.com/@Proxy\">Proxy</a></li>\n<li><a href=\"https://code4rena.com/@c3phas\">c3phas</a></li>\n<li><a href=\"https://code4rena.com/@kaveyjoe\">kaveyjoe</a></li>\n<li><a href=\"https://code4rena.com/@0x3b\">0x3b</a></li>\n<li><a href=\"https://code4rena.com/@favelanky\">favelanky</a></li>\n<li><a href=\"https://code4rena.com/@nadin\">nadin</a></li>\n<li><a href=\"https://code4rena.com/@DavidGiladi\">DavidGiladi</a></li>\n<li><a href=\"https://code4rena.com/@0x11singh99\">0x11singh99</a></li>\n<li><a href=\"https://code4rena.com/@SAQ\">SAQ</a></li>\n<li><a href=\"https://code4rena.com/@hunter_w3b\">hunter_w3b</a></li>\n<li><a href=\"https://code4rena.com/@0xta\">0xta</a></li>\n<li><a href=\"https://code4rena.com/@turvy_fuzz\">turvy_fuzz</a></li>\n<li><a href=\"https://code4rena.com/@ReyAdmirado\">ReyAdmirado</a></li>\n<li><a href=\"https://code4rena.com/@JCK\">JCK</a></li>\n<li><a href=\"https://code4rena.com/@lsaudit\">lsaudit</a></li>\n<li><a href=\"https://code4rena.com/@K42\">K42</a></li>\n</ol>\n<p>This audit was judged by <a href=\"https://code4rena.com/@hickuphh3\">hickuphh3</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/liveactionllama\">liveactionllama</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 5 unique vulnerabilities. Of these vulnerabilities, 2 received a risk rating in the category of HIGH severity and 3 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 7 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 13 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2023-08-livepeer\">C4 Livepeer Onchain Treasury Upgrade repository</a>, and is composed of 3 interfaces and 7 smart contracts written in the Solidity programming language and includes 2,602 lines of Solidity code.</p>\n<p>In addition to the known issues identified by the project team, a Code4rena bot race was conducted at the start of the audit. The winning bot, <strong>henry</strong> from warden hihen, generated the <a href=\"https://gist.github.com/code423n4/7ad0b8f1cbfb9c35cebefdaedcf04d3c\">Automated Findings report</a> and all findings therein were classified as out of scope.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities based on three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>For more information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>, specifically our section on <a href=\"https://docs.code4rena.com/awarding/judging-criteria/severity-categorization\">Severity Categorization</a>.</p>\n<h1 id=\"high-risk-findings-2\" style=\"position:relative;\"><a href=\"#high-risk-findings-2\" aria-label=\"high risk findings 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (2)</h1>\n<h2 id=\"h-01-underflow-in-updatetranscoderwithfees-can-cause-corrupted-data-and-loss-of-winning-tickets\" style=\"position:relative;\"><a href=\"#h-01-underflow-in-updatetranscoderwithfees-can-cause-corrupted-data-and-loss-of-winning-tickets\" aria-label=\"h 01 underflow in updatetranscoderwithfees can cause corrupted data and loss of winning tickets permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/165\">[H-01] Underflow in <code>updateTranscoderWithFees</code> can cause corrupted data and loss of winning tickets</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/165\">bronze_pickaxe</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/234\">VAD37</a>, <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/184\">ether_sky</a>, and <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/75\">Krace</a></em></p>\n<p><code>updateTranscoderWtihFees</code> can underflow because MathUtils is used instead of PreciseMathUtils.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>According to <a href=\"https://github.com/livepeer/LIPs/blob/master/LIPs/LIP-92.md\">LIP-92</a> the initial <code>treasuryRewardCutRate</code> will be set to <code>10%</code>.</p>\n<p><code>treasuryRewardCutRate</code> is set with the <code>setTreasuryRewardCutRate()</code>function, which calls the internal function <code>_setTreasuryRewardCutRate()</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">file: </span><span class=\"mtk7\">2023</span><span class=\"mtk1\">-</span><span class=\"mtk7\">08</span><span class=\"mtk1\">-</span><span class=\"mtk12\">livepeer</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">bonding</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BondingManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_setTreasuryRewardCutRate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_cutRate</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">PreciseMathUtils</span><span class=\"mtk1\">.</span><span class=\"mtk11\">validPerc</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_cutRate</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;_cutRate is invalid precise percentage&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>In this function the value will be checked if it’s a valid <code>PreciseMathUtils</code> percentage (&#x3C;<code>100%</code> specified with 27-digits precision):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">file: </span><span class=\"mtk7\">2023</span><span class=\"mtk1\">-</span><span class=\"mtk7\">08</span><span class=\"mtk1\">-</span><span class=\"mtk12\">livepeer</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PreciseMathUtils</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">library</span><span class=\"mtk1\"> </span><span class=\"mtk12\">PreciseMathUtils</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Divisor used for representing percentages</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">PERC_DIVISOR</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">10</span><span class=\"mtk1\">**</span><span class=\"mtk7\">27</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">validPerc</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">PERC_DIVISOR</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// ...</span></span></span></code></pre>\n<p>However, in <code>updateTranscoderWithFees</code>, to calculate <code>treasuryRewards</code>, <code>MathUtils</code> is used instead of <code>PreciseMathUtils</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">file: </span><span class=\"mtk7\">2023</span><span class=\"mtk1\">-</span><span class=\"mtk7\">08</span><span class=\"mtk1\">-</span><span class=\"mtk12\">livepeer</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">bonding</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BondingManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">updateTranscoderWithFees</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_transcoder</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_fees</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_round</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">whenSystemNotPaused</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyTicketBroker</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">treasuryRewards</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">MathUtils</span><span class=\"mtk1\">.</span><span class=\"mtk11\">percOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rewards</span><span class=\"mtk1\">, </span><span class=\"mtk12\">treasuryRewardCutRate</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">rewards</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">rewards</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sub</span><span class=\"mtk1\">(</span><span class=\"mtk12\">treasuryRewards</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><code>MathUtils</code> uses a <code>PREC_DIVISOR</code> of <code>1000000</code> instead of <code>10 ** 27</code> from the <code>PreciseMathUtils</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">file: </span><span class=\"mtk7\">2023</span><span class=\"mtk1\">-</span><span class=\"mtk7\">08</span><span class=\"mtk1\">-</span><span class=\"mtk12\">livepeer</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MathUtils</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">library</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MathUtils</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">PERC_DIVISOR</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1000000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// ...</span></span></span></code></pre>\n<p>This leads to <code>treasuryRewards</code> value being bigger than expected. Here is a <a href=\"https://gist.github.com/bronzepickaxe/60063c47c327a1f2d4ee3dbd6361049b\">gist of the POC</a>. Running the POC it shows that the current usage of <code>MathUtils</code> when calculating <code>treasuryRewards</code> will always cause an underflow in the next line of code.</p>\n<p><code>updateTranscoderWithFees</code> is called every time a winning ticket is redeemed. Whenever the transcoder has skipped the previous round reward call, this function has to re-calculate the rewards, as documented in <a href=\"https://github.com/livepeer/LIPs/blob/master/LIPs/LIP-92.md?plain=1#L130\">LIP-92</a>. This re-calculation will always fail due to the underflow shown above.</p>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>This will lead to accounting errors, unexpected behaviours and can cause a loss of winning tickets.</p>\n<p>Firstly, the accounting errors and unexpected behaviours: these are all the storage values getting updated in <code>updateTranscoderWithFees</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">file: </span><span class=\"mtk7\">2023</span><span class=\"mtk1\">-</span><span class=\"mtk7\">08</span><span class=\"mtk1\">-</span><span class=\"mtk12\">livepeer</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">bonding</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BondingManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">updateTranscoderWithFees</span><span class=\"mtk1\">( </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_transcoder</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_fees</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_round</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">whenSystemNotPaused</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyTicketBroker</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// transcoder &amp; earningsPool.data</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">L314: </span><span class=\"mtk12\">Transcoder</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">t</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">transcoders</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_transcoder</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">L321: </span><span class=\"mtk12\">EarningsPool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Data</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">earningsPool</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">t</span><span class=\"mtk1\">.</span><span class=\"mtk12\">earningsPoolPerRound</span><span class=\"mtk1\">[</span><span class=\"mtk12\">currentRound</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">//accounting updates happen here</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">L377: </span><span class=\"mtk12\">t</span><span class=\"mtk1\">.</span><span class=\"mtk12\">cumulativeFees</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">t</span><span class=\"mtk1\">.</span><span class=\"mtk12\">cumulativeFees</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span><span class=\"mtk12\">transcoderRewardStakeFees</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t  .</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span><span class=\"mtk12\">transcoderCommissionFees</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">L382: </span><span class=\"mtk12\">earningsPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">updateCumulativeFeeFactor</span><span class=\"mtk1\">(</span><span class=\"mtk12\">prevEarningsPool</span><span class=\"mtk1\">,</span><span class=\"mtk12\">delegatorsFees</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">L384: </span><span class=\"mtk12\">t</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lastFeeRound</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">currentRound</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<ul>\n<li>Let <code>currentRound() - 1</code> be the previous round where the transcoder skipped the reward call</li>\n<li>Let <code>currentRound()</code> be current round</li>\n<li>Let <code>currentRound() + 1</code> be the next round</li>\n</ul>\n<p>During <code>currentRound()</code> it won’t be possible to update the <code>Transcoder</code> storage or <code>earningsPool.data</code> storage because of the underflow that will happen because <code>currentRound() - 1</code> reward call has been skipped by the transcoder.</p>\n<p>During <code>currentRound() + 1</code> it will be possible to call <code>updateTranscoderWithFees</code>, however, L382 will only update the <code>prevEarningsPool</code>, which in this case will be <code>currentRound()</code>, not <code>currentRound - 1</code>. Therefor, the <code>EarningsPool.data.cumulativeRewardFactor</code> won’t be updated for <code>currentRound() - 1</code>.</p>\n<p>Lastly, the validity of a ticket is two rounds as per the <a href=\"https://github.com/livepeer/wiki/blob/master/spec/streamflow/pm.md?plain=1#L107\">specs</a>. This means that a transcoder that receives a winning ticket in <code>currentRound() - 1</code> should be able to redeem it in <code>currentRound() - 1</code> and <code>currentRound()</code>. However, a transcoder that receives a winning ticket in <code>currentRound() - 1</code> wont be able to redeem it in <code>currentRound()</code> because of the underflow that happens while redeeming a winning ticket in <code>currentRound()</code>. The transcoder wont be able to redeem it after <code>currentRound + 1..N</code> because the ticket will be expired.</p>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Use <code>PreciseMathLib</code> instead of <code>MathLib</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">file: </span><span class=\"mtk7\">2023</span><span class=\"mtk1\">-</span><span class=\"mtk7\">08</span><span class=\"mtk1\">-</span><span class=\"mtk12\">livepeer</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">bonding</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BondingManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">L355: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">- </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">treasuryRewards</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">MathUtils</span><span class=\"mtk1\">.</span><span class=\"mtk11\">percOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rewards</span><span class=\"mtk1\">, </span><span class=\"mtk12\">treasuryRewardCutRate</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+ </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">treasuryRewards</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">PreciseMathUtils</span><span class=\"mtk1\">.</span><span class=\"mtk11\">percOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rewards</span><span class=\"mtk1\">, </span><span class=\"mtk12\">treasuryRewardCutRate</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h3 id=\"assessed-type\" style=\"position:relative;\"><a href=\"#assessed-type\" aria-label=\"assessed type permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Library</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/165#issuecomment-1714255659\">victorges (Livepeer) commented</a>:</strong></p>\n<blockquote>\n<p>Can confirm this issue!</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/165\">victorges (Livepeer) mitigated</a>:</strong></p>\n<blockquote>\n<p><a href=\"https://github.com/livepeer/protocol/pull/624\">https://github.com/livepeer/protocol/pull/624</a></p>\n</blockquote>\n<hr>\n<h2 id=\"h-02-by-delegating-to-a-non-transcoder-a-delegator-can-reduce-the-tally-of-someone-elses-vote-choice-without-first-granting-them-any-voting-power\" style=\"position:relative;\"><a href=\"#h-02-by-delegating-to-a-non-transcoder-a-delegator-can-reduce-the-tally-of-someone-elses-vote-choice-without-first-granting-them-any-voting-power\" aria-label=\"h 02 by delegating to a non transcoder a delegator can reduce the tally of someone elses vote choice without first granting them any voting power permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/96\">[H-02] By delegating to a non-transcoder, a delegator can reduce the tally of someone else’s vote choice without first granting them any voting power</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/96\">Banditx0x</a></em></p>\n<p>A delegate can subtract their own voting weight from the voting choice of another delegate, even if that user isn’t a transcoder. Since they are not a transcoder, they don’t have their votes initially increased by the amount delegated to them, voting weight is still subtracted from the tally of their vote choice.</p>\n<p>Maliciously, this could be used to effectively double one’s voting power, by delegating their votes to a delegator who is about to vote for the choice which they don’t want. It can also occur accidentally, for example when somebody delegates to a transcoder who later switches role to delegate.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>When a user is not a transcoder, their votes are determined by the amount they have delegated to the delegatedAddress, and does not increase when a user delegates to them:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bondedAmount</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">isTranscoder</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">bond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delegatedAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">delegatorCumulativeStakeAt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bond</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_round</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>Let’s say that this delegator (Alice) has 100 votes and votes <code>For</code>, then another delegator(Bob) has delegated 1000 votes to Alice. As stated above, Alice doesn’t get the voting power of Bob’s 1000 votes, so the <code>For</code> count increases by 100.</p>\n<p>Bob now votes, and <code>_handleVotesOverrides</code> is called. In this function, the first conditional, <code>if isTranscoder</code> will return false as Bob is not self-delegating.</p>\n<p>Then, there is a check that the address Bob has delegated to has voted. Note that there is a missing check of whether the delegate address is a transcoder. Therefore the logic inside <code>if (delegateVoter.hasVoted)</code> is executed:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">delegateVoter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hasVoted</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// this is a delegator overriding its delegated transcoder vote,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// we need to update the current totals to move the weight of</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// the delegator vote to the right outcome.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">VoteType</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delegateSupport</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">delegateVoter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">support</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">delegateSupport</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">VoteType</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Against</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_tally</span><span class=\"mtk1\">.</span><span class=\"mtk12\">againstVotes</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">_weight</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">delegateSupport</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">VoteType</span><span class=\"mtk1\">.</span><span class=\"mtk12\">For</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_tally</span><span class=\"mtk1\">.</span><span class=\"mtk12\">forVotes</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">_weight</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">assert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">delegateSupport</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">VoteType</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Abstain</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_tally</span><span class=\"mtk1\">.</span><span class=\"mtk12\">abstainVotes</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">_weight</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span></code></pre>\n<p>The logic reduces the tally of whatever choice Alice voted for by Bob’s weight. Alice initially voted <code>For</code> with 100 votes, and then the For votes is reduced by Bob’s <code>1000 votes</code>. Lets say that Bob votes <code>Against</code>. This will result in an aggregate 900 vote reduction in the <code>For</code> tally and +1000 votes for <code>Agaisnt</code> after Alice and Bob has finished voting.</p>\n<p>If Alice was a transcoder, Bob will be simply reversing the votes they had delegated to Alice. However since Alice was a delegate, they never gained the voting power that was delegated to her.</p>\n<p>Bob has effectively gained the ability to vote against somebody else’s votes (without first actually increasing their voting power since they are not a transcoder) and can vote themselves, which allows them to manipulate governance.</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>There should be a check that a delegate is a transcoder before subtracting the tally. Here is some pseudocode:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if (delegateVoter.hasVoted &amp;&amp; ---delegate is transcoder ---)</span></span></code></pre>\n<p>This is an edit of the conditional of the function <code>_handleOverrides</code>. This ensures that the subtraction of vote tally is only performed when the delegate is a voter AND the delegate is a transcoder. This should fix the accounting/subtraction issue of vote tally for non-transcoder delegates.</p>\n<h3 id=\"assessed-type-1\" style=\"position:relative;\"><a href=\"#assessed-type-1\" aria-label=\"assessed type 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Invalid Validation</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/96#issuecomment-1720114654\">victorges (Livepeer) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/96\">victorges (Livepeer) mitigated</a>:</strong></p>\n<blockquote>\n<p><a href=\"https://github.com/livepeer/protocol/pull/625\">https://github.com/livepeer/protocol/pull/625</a>\n<a href=\"https://github.com/livepeer/protocol/pull/626\">https://github.com/livepeer/protocol/pull/626</a></p>\n</blockquote>\n<hr>\n<h1 id=\"medium-risk-findings-3\" style=\"position:relative;\"><a href=\"#medium-risk-findings-3\" aria-label=\"medium risk findings 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (3)</h1>\n<h2 id=\"m-01-the-logic-in-_handlevoteoverride-to-determine-if-an-account-is-the-transcoder-is-not-consistent-with-the-logic-in-the-bondmanagersol\" style=\"position:relative;\"><a href=\"#m-01-the-logic-in-_handlevoteoverride-to-determine-if-an-account-is-the-transcoder-is-not-consistent-with-the-logic-in-the-bondmanagersol\" aria-label=\"m 01 the logic in _handlevoteoverride to determine if an account is the transcoder is not consistent with the logic in the bondmanagersol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/206\">[M-01] The logic in <code>_handleVoteOverride</code> to determine if an account is the transcoder is not consistent with the logic in the <code>BondManager.sol</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/206\">ladboy233</a></em></p>\n<p>In the current implementation, when voting, the function <a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/treasury/GovernorCountingOverridable.sol#L151\">_countVote is triggered</a>, this function is overridden in the function GovernorCountingOverridable.sol</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_weight</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_handleVoteOverrides</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_proposalId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tally</span><span class=\"mtk1\">, </span><span class=\"mtk12\">voter</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_weight</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>This is calling:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_handleVoteOverrides</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_proposalId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ProposalTally</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_tally</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ProposalVoterState</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_voter</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_account</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_weight</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">timepoint</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">proposalSnapshot</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_proposalId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delegate</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">votes</span><span class=\"mtk1\">().</span><span class=\"mtk11\">delegatedAt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">timepoint</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// @audit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// is transcoder?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">isTranscoder</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_account</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">delegate</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">isTranscoder</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// deduce weight from any previous delegators for this transcoder to</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// make a vote</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_weight</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">_voter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">deductions</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span></code></pre>\n<p>The logic to determine if an account is the transcoder is too simple in this <a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/treasury/GovernorCountingOverridable.sol#L184\">line of code</a>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// @audit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// is transcoder?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">isTranscoder</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_account</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">delegate</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>And does not match the logic that determine if the address is an registered transcorder and an active transcoder in the bondManager.sol.</p>\n<p>In BondManager.sol, the function that used to check if a transcoder is registered is in this <a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L1156\">line of code</a>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     * </span><span class=\"mtk4\">@notice</span><span class=\"mtk3\"> Return whether a transcoder is registered</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     * </span><span class=\"mtk4\">@param</span><span class=\"mtk3\"> </span><span class=\"mtk12\">_transcoder</span><span class=\"mtk3\"> Transcoder address</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     * </span><span class=\"mtk4\">@return</span><span class=\"mtk3\"> true if transcoder is self-bonded</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">isRegisteredTranscoder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_transcoder</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Delegator</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">d</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">delegators</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_transcoder</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">d</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delegateAddress</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">_transcoder</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">d</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bondedAmount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>The function that is used to check if a transcoder is active is in <a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L1145\">this line of code</a>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">isActiveTranscoder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_transcoder</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Transcoder</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">t</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">transcoders</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_transcoder</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentRound</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">roundsManager</span><span class=\"mtk1\">().</span><span class=\"mtk11\">currentRound</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">t</span><span class=\"mtk1\">.</span><span class=\"mtk12\">activationRound</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">currentRound</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">currentRound</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">t</span><span class=\"mtk1\">.</span><span class=\"mtk12\">deactivationRound</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>Missing the check in the delegator’s bond amount (delegators[_transcoder].bondeAmount > 0).</p>\n<p>The code incorrectedly counts regular delegator as transcoder and does not update the deduction power correctly.</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Reuse the function isRegisteredTranscoder and isActiveTranscoder to determine if an account is a registered and active transcoder when counting the voting power.</p>\n<h3 id=\"assessed-type-2\" style=\"position:relative;\"><a href=\"#assessed-type-2\" aria-label=\"assessed type 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Governance</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/206#issuecomment-1721637789\">victorges (Livepeer) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>There is in fact an issue with the inconsistency with the <code>isRegisteredTranscodeer</code> function. This report didn’t manage to go specifically into that issue, but still pointed a valid problem which is in a sense the root cause there. FTR There is no problem with <code>isActiveTranscoder</code> though, since we don’t give voting power only to active transcoders. That part of this report is invalid.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/206\">victorges (Livepeer) mitigated</a>:</strong></p>\n<blockquote>\n<p><a href=\"https://github.com/livepeer/protocol/pull/626\">https://github.com/livepeer/protocol/pull/626</a></p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-fully-slashed-transcoder-can-vote-with-0-weight-messing-up-the-voting-calculations\" style=\"position:relative;\"><a href=\"#m-02-fully-slashed-transcoder-can-vote-with-0-weight-messing-up-the-voting-calculations\" aria-label=\"m 02 fully slashed transcoder can vote with 0 weight messing up the voting calculations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/194\">[M-02] Fully slashed transcoder can vote with 0 weight messing up the voting calculations</a></h2>\n<p><em>Submitted by Vagner (<a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/194\">1</a>, <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/187\">2</a>), also found by <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/224\">ladboy233</a></em></p>\n<p>If a transcoder gets slashed fully he can still vote with 0 amount of <code>weight</code> making any other delegated user that wants to change his vote to subtract their <code>weight</code> amount from other delegators/transcoders.</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>In <code>BondingManager.sol</code> any transcoder can gets slashed by a specific percentage, and that specific transcoder gets resigned and that specific percentage gets deducted from his <code>bondedAmount</code>.<br>\n<a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L394-L411\">https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L394-L411</a></p>\n<p>If any <code>bondedAmount</code> will remain then the penalty will also gets subtracted from the <code>delegatedAmount</code>, if not, nothing happens.<br>\n<a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L412-L417\">https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L412-L417</a></p>\n<p>After that the <code>penalty</code> gets burned and the fees gets paid to the finder, if that is the case.<br>\n<a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L420-L440\">https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L420-L440</a></p>\n<p>The problem relies in the fact that a fully slashed transcoder, even if it gets resigned, he is still seen as an active transcoder in the case of voting. Let’s assume this case:</p>\n<ul>\n<li>A transcoder gets fully slashed and gets resigned from the transcoder pools, getting his <code>bondedAmount</code> to 0, but he still has <code>delegatedAmount</code> to his address since nothing happens this variable.<br>\n<a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L402-L418\">https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L402-L418</a></li>\n<li>Transcoder vote a proposal and when his weighting gets calculated <a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts-upgradeable/blob/f34a3a7e5a1d698d87d517fda698d48286310bee/contracts/governance/GovernorUpgradeable.sol#L581\">here</a>, it will use the <code>_getVotes</code> from <code>GovernorVotesUpgradeable.sol</code>.<br>\n<a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts-upgradeable/blob/f34a3a7e5a1d698d87d517fda698d48286310bee/contracts/governance/extensions/GovernorVotesUpgradeable.sol#L55-L61\">https://github.com/OpenZeppelin/openzeppelin-contracts-upgradeable/blob/f34a3a7e5a1d698d87d517fda698d48286310bee/contracts/governance/extensions/GovernorVotesUpgradeable.sol#L55-L61</a></li>\n<li><code>_getVotes</code> calls <code>getPastVotes</code> on <code>BondingVotes.sol</code> <a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingVotes.sol#L167-L170\">https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingVotes.sol#L167-L170</a> which returns the amount of weight specific to this transcoder and as you can see, because the transcoder has a <code>bondedAmount</code> equal to 0, the first if statement will be true and 0 will be returned.<br>\n<a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingVotes.sol#L372-L373\">https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingVotes.sol#L372-L373</a></li>\n<li>0 weight will be passed into <code>_countVote</code> which will then be passed into <code>_handleVoteOverrides</code>.<br>\n<a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/treasury/GovernorCountingOverridable.sol#L151\">https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/treasury/GovernorCountingOverridable.sol#L151</a></li>\n<li>Then it will check if the caller is a transcoder, which will be true in our case, because nowhere in the <code>slashTranscoder</code> function, or any other function the transcoder <code>delegateAddress</code> gets changed, so this if statement will be true <a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/treasury/GovernorCountingOverridable.sol#L182-L184\">https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/treasury/GovernorCountingOverridable.sol#L182-L184</a>, which will try to deduct the weight from any previous delegators.<br>\n<a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/treasury/GovernorCountingOverridable.sol#L184-L189\">https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/treasury/GovernorCountingOverridable.sol#L184-L189</a></li>\n<li>If any delegator already overridden any amount this subtraction would revert, but if that is not the case, 0 weight will be returned, which is then used to vote <code>for</code>, <code>against</code> , <code>abstain</code>, but since 0 weight is passed no changed will be made.</li>\n<li>Now the big problem arise, if any delegator that delegated their votes to this specific transcoder want to change their vote, when his weight gets calculated, <code>delegatorCumulativeStakeAt</code> gets called <a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingVotes.sol#L459-L487\">https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingVotes.sol#L459-L487</a> which will return most of the time his <code>bondedAmount</code>, amount which is greater than 0, since he didn’t unbound.</li>\n<li>Because of that when <code>_handleVoteOverrides</code> gets called in <code>_countVote</code>, to override the vote, this if statement will be true, since the transcoder voted already, but with 0 weight <a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/treasury/GovernorCountingOverridable.sol#L195\">https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/treasury/GovernorCountingOverridable.sol#L195</a> and the delegator weight gets subtracted from the support that the transcoder used in his vote.</li>\n<li>The system in this case expects the transcoder to vote with the whole <code>delegatedAmount</code>, which will make the subtraction viable, since the weight of the delegator should be included in the full <code>delegatedAmount</code> of that specific transcoder, but since the transcoder voted with 0 weight, the subtraction would be done from other delegators/transcoders votes.</li>\n<li>Also this can be abused by a transcoder by voting a category which he knows will not get a lot of votes, if let’s say a transcoder used his 0 weight to vote for <code>abstain</code> and every other voter will vote on <code>for</code> or <code>against</code>, every time one of his delegators want to change the vote the subtraction can revert, which will force those delegators out of the vote, until they will change their transcoder.</li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>If a transcoder gets fully slashed and resigned, delete his address from <code>delegateAddress</code> so he will not appear as a transcoder in the mechanism of counting the votes. If he still wants to participate in the system he can act as a delegator to another transcoder. Another solution would be to not let 0 weight votes happen, since they don’t modify the vote state at all.</p>\n<h3 id=\"assessed-type-3\" style=\"position:relative;\"><a href=\"#assessed-type-3\" aria-label=\"assessed type 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Governance</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/194#issuecomment-1720133531\">victorges (Livepeer) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Slashing is turned off in the protocol, so this specific issue is not that important. It did point towards an issue in <code>BondingVotes</code> though in the way that the <code>getBondingState</code> function checks if transcoder is a transcoder or not and defaults to 0 when <code>bondedAmount</code> is <code>0</code>. There are other ways that this logic can be triggered (not through <code>slashTranscoder</code>) that can show inconsistencies as well, so I’m flagging this as valid for the underlying issue that it hints to, even though it does not describe a realistic scenario about how this issue could happen.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/194#issuecomment-1722731950\">hickuphh3 (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I found the POC hard to follow. A coded instance would have tremendously helped, but what I gather is:</p>\n<ul>\n<li>fully slashed transcoder that votes will do so with 0 weight.</li>\n<li>any delegator that delegated their votes to this specific transcoder intending to change their vote may face an issue with sub overflow because <code>_handleVoteOverrides()</code> uses the slashed transcoder’s <code>bondedAmount</code> instead of the 0 weight.\nso this issue seems valid, although its premise is that the slashing functionality is in place.</li>\n</ul>\n<p>The README did not indicate that slashing was turned off, though I see it’s mentioned a couple of times in the Discord channel. Should’ve been added in the “Known caveats / limitations” section.</p>\n<p>Hence, IMO it isn’t entirely fair to wardens if I invalidate their issue because they weren’t aware of this fact.</p>\n<p>Leaning towards a downgrade to M because of the external requirement of the active slashing mechanism, but am open to discussion.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/194#issuecomment-1723153394\">hickuphh3 (judge) decreased severity to Medium</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/194#issuecomment-1732530336\">hickuphh3 (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Revisiting this issue, IMO it’s unreasonable to expect the sponsor to explicitly list out all the gotchas / limitations of the protocol. Some will only pop into mind through discussions with wardens, which seemed to be the case here when the slashing deprecation was mentioned a couple of times in the Discord channel.</p>\n<p>On the flip side, the fact remains that the slashing mechanism is part of the audit scope, and was counted towards the sLOC, plus the points I raised above. There wasn’t an indication in the code that slashing had been deprecated.</p>\n<p>It’s a difficult decision here, considering the different parties’ POV. There could be some wardens who didn’t submit issues related to slashing because of what was brought up in the Discord channel, and those that did (as one can see referenced above) because they didn’t monitor the channel.</p>\n</blockquote>\n<p><strong><a href=\"\">victorges (Livepeer) mitigated</a>:</strong></p>\n<blockquote>\n<p><a href=\"https://github.com/livepeer/protocol/pull/625\">https://github.com/livepeer/protocol/pull/625</a></p>\n</blockquote>\n<hr>\n<h2 id=\"m-03-withdrawfees-does-not-update-checkpoint\" style=\"position:relative;\"><a href=\"#m-03-withdrawfees-does-not-update-checkpoint\" aria-label=\"m 03 withdrawfees does not update checkpoint permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/104\">[M-03] <code>withdrawFees</code> does not update checkpoint</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/104\">ADM</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/257\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/92\">twicek</a>, and <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/27\">HChang26</a></em></p>\n<p>BondingVotes may have stale data due to missing checkpoint in <code>BondingManager#withdrawFees()</code>.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The withdrawFee function has the autoClaimEarnings modifier:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdrawFees</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">whenSystemNotPaused</span><span class=\"mtk1\"> </span><span class=\"mtk11\">currentRoundInitialized</span><span class=\"mtk1\"> </span><span class=\"mtk11\">autoClaimEarnings</span><span class=\"mtk1\">(msg.sender) {</span></span></span></code></pre>\n<p>which calls _autoClaimEarnings:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">modifier</span><span class=\"mtk1\"> </span><span class=\"mtk11\">autoClaimEarnings</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_delegator</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_autoClaimEarnings</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_delegator</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>which calls updateDelegatorWithEarnings:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_autoClaimEarnings</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_delegator</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentRound</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">roundsManager</span><span class=\"mtk1\">().</span><span class=\"mtk11\">currentRound</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lastClaimRound</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">delegators</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_delegator</span><span class=\"mtk1\">].</span><span class=\"mtk12\">lastClaimRound</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">lastClaimRound</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">currentRound</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">updateDelegatorWithEarnings</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_delegator</span><span class=\"mtk1\">, </span><span class=\"mtk12\">currentRound</span><span class=\"mtk1\">, </span><span class=\"mtk12\">lastClaimRound</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>During updateDelegatorWithEarnings, both delegator.lastClaimRound and delegator.bondedAmount can be assigned new values.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">del</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lastClaimRound</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_endRound</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Rewards are bonded by default</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">del</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bondedAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">currentBondedAmount</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>However, during the lifecycle of all these functions, _checkpointBondingState is never called either directly or through the autoCheckpoint modifier resulting in lastClaimRound &#x26; bondedAmount’s values being stale in BondingVotes.sol.</p>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add autoCheckpoint modifier to the withdrawFees function.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/104#issuecomment-1720257628\">victorges (Livepeer) confirmed</a></strong></p>\n<p><strong><a href=\"\">victorges (Livepeer) mitigated</a>:</strong></p>\n<blockquote>\n<p><a href=\"https://github.com/livepeer/protocol/pull/623\">https://github.com/livepeer/protocol/pull/623</a></p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this audit, 7 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/150\">report highlighted below</a> by <strong>Proxy</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/86\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/249\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/214\">favelanky</a>, <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/209\">nadin</a>, <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/205\">Banditx0x</a>, and <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/158\">DavidGiladi</a>.</em></p>\n<h2 id=\"01-there-is-no-way-to-decrease-the-max-number-of-active-transcoders\" style=\"position:relative;\"><a href=\"#01-there-is-no-way-to-decrease-the-max-number-of-active-transcoders\" aria-label=\"01 there is no way to decrease the max number of active transcoders permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[01] There is no way to decrease the max number of active transcoders</h2>\n<p><a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/main/contracts/bonding/BondingManager.sol#L182-L190\"><code>setNumActiveTranscoders()</code></a> sets the maximum number of active transcoders however there is no way to decrease the number since <a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/main/contracts/libraries/SortedDoublyLL.sol#L36-L44\"><code>setMaxSize()</code></a> does not allow it.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setNumActiveTranscoders</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_numActiveTranscoders</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyControllerOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">transcoderPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setMaxSize</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_numActiveTranscoders</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ParameterUpdate</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;numActiveTranscoders&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setMaxSize</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Data</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">self</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_size</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_size</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">self</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maxSize</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;new max size must be greater than old max size&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">self</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maxSize</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_size</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h2 id=\"02-when-removing-transcoders-transcoderactivationround-should-be-set-to-0-for-inactive\" style=\"position:relative;\"><a href=\"#02-when-removing-transcoders-transcoderactivationround-should-be-set-to-0-for-inactive\" aria-label=\"02 when removing transcoders transcoderactivationround should be set to 0 for inactive permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[02] When removing transcoders <code>Transcoder.activationRound</code> should be set to 0 for inactive</h2>\n<p>Function <a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/main/contracts/bonding/BondingManager.sol#L1416-L1418\"><code>tryToJoinActiveSet()</code></a> removes a transcoder if <code>transcoderPool.isFull()</code> however it does not set <code>Transcoder.activationRound</code> of the transcoder to 0 for inactive.\nIn <a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/main/contracts/bonding/BondingManager.sol#L44\"><code>Transcoder</code></a> struct it says if a transcoder is inactive <code>activationRound</code> should be 0.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">activationRound</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// Round in which the transcoder became active - 0 if inactive</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">transcoderPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">remove</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lastTranscoder</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">transcoders</span><span class=\"mtk1\">[</span><span class=\"mtk12\">lastTranscoder</span><span class=\"mtk1\">].</span><span class=\"mtk12\">deactivationRound</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_activationRound</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// @audit Transcoder.activationRound should be 0 - for inactive</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">pendingNextRoundTotalActiveStake</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pendingNextRoundTotalActiveStake</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sub</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lastStake</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h2 id=\"03-no-function-implemented-for-setmaxearningsclaimsrounds\" style=\"position:relative;\"><a href=\"#03-no-function-implemented-for-setmaxearningsclaimsrounds\" aria-label=\"03 no function implemented for setmaxearningsclaimsrounds permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[03] No function implemented for <code>setMaxEarningsClaimsRounds()</code></h2>\n<p>The <a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/main/contracts/bonding/BondingManager.sol#L140-L148\">constructor</a> natspec says that <code>setMaxEarningsClaimsRounds()</code> should be called to initialize state variables post-deployment. However there is no such function implemented anywhere.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> * </span><span class=\"mtk4\">@notice</span><span class=\"mtk3\"> BondingManager constructor. Only invokes constructor of base Manager contract with provided Controller address</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> * </span><span class=\"mtk4\">@dev</span><span class=\"mtk3\"> This constructor will not initialize any state variables besides </span><span class=\"mtk8\">`controller`</span><span class=\"mtk3\">. The following setter functions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> * should be used to initialize state variables post-deployment:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> * - setUnbondingPeriod()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> * - setNumActiveTranscoders()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> * - setMaxEarningsClaimsRounds()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> * </span><span class=\"mtk4\">@param</span><span class=\"mtk3\"> </span><span class=\"mtk12\">_controller</span><span class=\"mtk3\"> Address of Controller that this contract will be registered with</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> */</span></span></span></code></pre>\n<h2 id=\"04-typos\" style=\"position:relative;\"><a href=\"#04-typos\" aria-label=\"04 typos permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[04] Typos</h2>\n<ul>\n<li>GovernorCountingOverriable.sol ( <a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/main/contracts/treasury/GovernorCountingOverridable.sol#L35\">#L35</a> , <a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/main/contracts/treasury/GovernorCountingOverridable.sol#L59\">#L59</a> ):</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// @audit Typo - instead of &quot;specicic&quot; use &quot;specific&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">35</span><span class=\"mtk1\">: </span><span class=\"mtk3\">// @dev Tracks state of specicic voters in a single proposal.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// @audit Typo - instead of &quot;abstain&quot; use &quot;against&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">59</span><span class=\"mtk1\">: </span><span class=\"mtk3\">// @notice The required percentage of &quot;for&quot; votes in relation to the total opinionated votes (for and abstain) for</span></span></span></code></pre>\n<ul>\n<li>BondingVotes.sol (<a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/main/contracts/bonding/BondingVotes.sol#L65-L66\">#L65-66</a>):</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// @audit Typo - instead of &quot;Notce that...&quot; use &quot;Notice that this is different&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">65</span><span class=\"mtk1\">: </span><span class=\"mtk3\">// @dev Stores a list of checkpoints for the total active stake, queryable and mapped by round. Notce that</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">66</span><span class=\"mtk1\">: </span><span class=\"mtk3\">// differently from bonding checkpoints, it&#39;s only accessible on the specific round. To access the checkpoint for a</span></span></span></code></pre>\n<h2 id=\"05-functions-need-a-more-descriptive-name\" style=\"position:relative;\"><a href=\"#05-functions-need-a-more-descriptive-name\" aria-label=\"05 functions need a more descriptive name permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[05] Functions need a more descriptive name</h2>\n<p>Some functions say they set one thing but set something different and some function names are too ambiguous.</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/main/contracts/bonding/BondingManager.sol#L167\"><code>setTreasuryRewardCutRate()</code></a> and <a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/main/contracts/bonding/BondingManager.sol#L1176\">_setTreasuryRewardCutRate()</a> set <code>nextRoundTreasuryRewardCutRate</code> not <code>treasuryRewardCutRate</code></li>\n<li><a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/main/contracts/bonding/BondingManager.sol#L198\"><code>transcoder()</code></a> and <a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/main/contracts/bonding/BondingManager.sol#L485\"><code>transcoderWithHint()</code></a> are too ambiguous</li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/150#issuecomment-1721699041\">victorges (Livepeer) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p><strong>[01]</strong><br>\nThis is known and expected behavior, which has an explicit check in the code to guarantee consistency. An improvement could be made to the code but the current one works as expected.</p>\n<p><strong>[02]</strong><br>\nValid point on doc that oversimplifies the behavior of the field and can be confusing. In the way these fields are read, that 0 value wouldn’t matter though: <a href=\"https://github.com/livepeer/protocol/blob/ca3f5bb7a65dedba0f6be6a341d184c48553be98/contracts/bonding/BondingManager.sol#L1159\">https://github.com/livepeer/protocol/blob/ca3f5bb7a65dedba0f6be6a341d184c48553be98/contracts/bonding/BondingManager.sol#L1159</a></p>\n<p><strong>[03]</strong><br>\nMisleading docs. Probably a deprecated property that doesn’t exist anymore. Here’s the deploy code of that contract for reference: <a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/23bd30274c4d426c4bb01da661ad3ef2480c6494/deploy/deploy_contracts.ts#L215-L230\">https://github.com/code-423n4/2023-08-livepeer/blob/23bd30274c4d426c4bb01da661ad3ef2480c6494/deploy/deploy_contracts.ts#L215-L230</a></p>\n<p><strong>[04]</strong><br>\nGood docs improvements.</p>\n<p><strong>[05]</strong><br>\nValid points, but expected behavior, might not fix.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/150#issuecomment-1730761507\">hickuphh3 (judge) commented</a>:</strong></p>\n<blockquote>\n<p><strong>[01]</strong>: Recommendation<br>\n<strong>[02]</strong>: Recommendation<br>\n<strong>[03]</strong>: Low<br>\n<strong>[04]</strong>: Non-Critical<br>\n<strong>[05]</strong>: Recommendation</p>\n</blockquote>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this audit, 13 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/222\">report highlighted below</a> by <strong>c3phas</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/172\">Sathish9098</a>, <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/26\">kaveyjoe</a>, <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/254\">0x11singh99</a>, <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/244\">SAQ</a>, <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/238\">hunter_w3b</a>, <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/213\">0xta</a>, <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/193\">turvy_fuzz</a>, <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/185\">ReyAdmirado</a>, <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/152\">JCK</a>, <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/132\">lsaudit</a>, <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/68\">0x3b</a>, and <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/15\">K42</a>.</em></p>\n<h2 id=\"notes-from-the-auditor\" style=\"position:relative;\"><a href=\"#notes-from-the-auditor\" aria-label=\"notes from the auditor permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Notes from the Auditor</h2>\n<h3 id=\"auditors-disclaimer\" style=\"position:relative;\"><a href=\"#auditors-disclaimer\" aria-label=\"auditors disclaimer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Auditor’s Disclaimer</h3>\n<p>While we try our best to maintain readability in the provided code snippets, some functions have been truncated to highlight the affected portions.</p>\n<p>It’s important to note that during the implementation of these suggested changes, developers must exercise caution to avoid introducing vulnerabilities. Although the optimizations have been tested prior to these recommendations, it is the responsibility of the developers to conduct thorough testing again.</p>\n<p>Code reviews and additional testing are strongly advised to minimize any potential risks associated with the refactoring process.</p>\n<h3 id=\"note-on-gas-estimates\" style=\"position:relative;\"><a href=\"#note-on-gas-estimates\" aria-label=\"note on gas estimates permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Note on Gas Estimates</h3>\n<p>We’ve tried to give the exact amount of gas being saved from running the included tests, whenever the function is within the test coverage.</p>\n<p><strong>All suggested changes have been  tested per function to ensure we don’t encounter stack too deep error.</strong><br>\nMost of the changes involve rewriting functions and as such changes are suggested on a function basis.<br>\nWe would love to look at this code again if they end up implementing the changes on this report.</p>\n<p><em>When doing the refactoring, we’ve avoided including any changes that were reported by the bot and we encourage you to go through the automated findings to maximum the amount of gas being saved.</em></p>\n<h2 id=\"g-01-function-processrebond-can-be-more-optimized-save-207-gas-on-average\" style=\"position:relative;\"><a href=\"#g-01-function-processrebond-can-be-more-optimized-save-207-gas-on-average\" aria-label=\"g 01 function processrebond can be more optimized save 207 gas on average permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-01] Function <code>processRebond()</code> can be more optimized (Save 207 Gas on average)</h2>\n<p>Gas benchmarks based on function <code>rebondWithHint()</code> which calls our function of interest.</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Min</th>\n<th>Max</th>\n<th>Avg</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>229425</td>\n<td>231632</td>\n<td>230529</td>\n</tr>\n<tr>\n<td>After</td>\n<td>229218</td>\n<td>231425</td>\n<td>230322</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">bonding</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BondingManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1564</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">processRebond</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">1565:        </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_delegator</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">1566:        </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_unbondingLockId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">1567:        </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_newPosPrev</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">1568:        </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_newPosNext</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1569</span><span class=\"mtk1\">:    ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">autoCheckpoint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_delegator</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1570</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">Delegator</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">del</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">delegators</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_delegator</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1571</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">UnbondingLock</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lock</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">del</span><span class=\"mtk1\">.</span><span class=\"mtk12\">unbondingLocks</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_unbondingLockId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1573</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">isValidUnbondingLock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_delegator</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_unbondingLockId</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;invalid unbonding lock ID&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Of interest to us is the require statement on line 1573:<br>\n<code>require(isValidUnbondingLock(_delegator, _unbondingLockId), \"invalid unbonding lock ID\");</code></p>\n<p>The statement makes a function call to <code>isValidUnbondingLock()</code> which we can see its implementation on <a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L1167-L1170\">https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L1167-L1170</a>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">bonding</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BondingManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1167</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">isValidUnbondingLock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_delegator</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_unbondingLockId</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1168</span><span class=\"mtk1\">:       </span><span class=\"mtk3\">// A unbonding lock is only valid if it has a non-zero withdraw round (the default value is zero)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1169</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delegators</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_delegator</span><span class=\"mtk1\">].</span><span class=\"mtk12\">unbondingLocks</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_unbondingLockId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">withdrawRound</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1170</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<p>Note the return statement in the above function <code>return delegators[_delegator].unbondingLocks[_unbondingLockId].withdrawRound > 0;</code>.<br>\nWe make some state reads by reading <code>delegators[_delegator]</code>.</p>\n<p>Back to our original function context, note we also made the same state read on <a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L1570\">https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L1570</a>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1570</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">Delegator</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">del</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">delegators</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_delegator</span><span class=\"mtk1\">];</span></span></span></code></pre>\n<p>The require statement ends up doing the following:<br>\n<code>require(delegators[_delegator].unbondingLocks[_unbondingLockId].withdrawRound > 0,\"invalid unbonding lock ID\");</code></p>\n<p>Note the variable <code>delegators[_delegator].unbondingLocks[_unbondingLockId]</code> is equivalent to the variable <code>lock</code> declared here  <code>UnbondingLock storage lock = del.unbondingLocks[_unbondingLockId];</code></p>\n<p>If we inline the function <code>isValidUnbondingLock()</code> we can avoid making this two state reads and take advantage of the already declared variable.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/bonding/BondingManager.sol b/contracts/bonding/BondingManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 93e06ba..2482d64 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/bonding/BondingManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/bonding/BondingManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -1569,8 +1569,7 @@ contract BondingManager is ManagerProxyTarget, IBondingManager {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) internal autoCheckpoint(_delegator) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         Delegator storage del = delegators[_delegator];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         UnbondingLock storage lock = del.unbondingLocks[_unbondingLockId];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        require(isValidUnbondingLock(_delegator, _unbondingLockId), &quot;invalid unbonding lock ID&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        require(lock.withdrawRound &gt; 0,&quot;invalid unbonding lock ID&quot;);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L249-L257\">https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L249-L257</a></p>\n<h2 id=\"g-02-function-withdrawstake-can-be-more-optimized-save-443-gas-on-average\" style=\"position:relative;\"><a href=\"#g-02-function-withdrawstake-can-be-more-optimized-save-443-gas-on-average\" aria-label=\"g 02 function withdrawstake can be more optimized save 443 gas on average permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-02] Function <code>withdrawStake()</code> can be more optimized (Save 443 Gas on average)</h2>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Min</th>\n<th>Max</th>\n<th>Avg</th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>104389</td>\n<td>121489</td>\n<td>110093</td>\n<td></td>\n</tr>\n<tr>\n<td>After</td>\n<td>103946</td>\n<td>121046</td>\n<td>109650</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">bonding</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BondingManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">249</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdrawStake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_unbondingLockId</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">whenSystemNotPaused</span><span class=\"mtk1\"> </span><span class=\"mtk11\">currentRoundInitialized</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">250</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">Delegator</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">del</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">delegators</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">251</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">UnbondingLock</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lock</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">del</span><span class=\"mtk1\">.</span><span class=\"mtk12\">unbondingLocks</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_unbondingLockId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">253</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">isValidUnbondingLock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_unbondingLockId</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;invalid unbonding lock ID&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">254</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">255</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">lock</span><span class=\"mtk1\">.</span><span class=\"mtk12\">withdrawRound</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk11\">roundsManager</span><span class=\"mtk1\">().</span><span class=\"mtk11\">currentRound</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">256</span><span class=\"mtk1\">:            </span><span class=\"mtk8\">&quot;withdraw round must be before or equal to the current round&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">257</span><span class=\"mtk1\">:        );</span></span></span></code></pre>\n<p><strong>Similar to the previous explanations with some additional refactoring</strong><br>\nAfter the refactoring explained in the previous case, the variable <code>lock.withdrawRound</code> was found to be called 3 times, with the 3rd call being a memory store ie <code>uint256 withdrawRound = lock.withdrawRound;</code>. We can optimize the code further by making this memory store call before we make our validations using the require statements and use the memory variable in the require statement instead of reading the <code>lock.withdrawRound</code>. In the worst case(sad path) where we fail on the 1st require check, we would only waste ~6 gas for <code>mstore/mload</code>. The benefit outweighs the cons thus we should refactor.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/bonding/BondingManager.sol b/contracts/bonding/BondingManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 93e06ba..5f0e073 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/bonding/BondingManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/bonding/BondingManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -249,15 +249,15 @@ contract BondingManager is ManagerProxyTarget, IBondingManager {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function withdrawStake(uint256 _unbondingLockId) external whenSystemNotPaused currentRoundInitialized {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         Delegator storage del = delegators[msg.sender];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         UnbondingLock storage lock = del.unbondingLocks[_unbondingLockId];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        require(isValidUnbondingLock(msg.sender, _unbondingLockId), &quot;invalid unbonding lock ID&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 withdrawRound = lock.withdrawRound;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        require(withdrawRound &gt; 0,&quot;invalid unbonding lock ID&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         require(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            lock.withdrawRound &lt;= roundsManager().currentRound(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            withdrawRound &lt;= roundsManager().currentRound(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             &quot;withdraw round must be before or equal to the current round&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 amount = lock.amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        uint256 withdrawRound = lock.withdrawRound;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // Delete unbonding lock</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         delete del.unbondingLocks[_unbondingLockId];</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L485-L502\">https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L485-L502</a></p>\n<h2 id=\"g-03-function-transcoderwithhint-can-be-more-optimized-save-4749-gas-on-average\" style=\"position:relative;\"><a href=\"#g-03-function-transcoderwithhint-can-be-more-optimized-save-4749-gas-on-average\" aria-label=\"g 03 function transcoderwithhint can be more optimized save 4749 gas on average permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-03] Function <code>transcoderWithHint()</code> can be more optimized (Save 4749 Gas on average)</h2>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Min</th>\n<th>Max</th>\n<th>Avg</th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>-</td>\n<td>-</td>\n<td>276355</td>\n<td></td>\n</tr>\n<tr>\n<td>After</td>\n<td>-</td>\n<td>-</td>\n<td>271606</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">bonding</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BondingManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">485</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">transcoderWithHint</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">490:    ) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">whenSystemNotPaused</span><span class=\"mtk1\"> </span><span class=\"mtk11\">currentRoundInitialized</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">491</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(!</span><span class=\"mtk11\">roundsManager</span><span class=\"mtk1\">().</span><span class=\"mtk11\">currentRoundLocked</span><span class=\"mtk1\">(), </span><span class=\"mtk8\">&quot;can&#39;t update transcoder params, current round is locked&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">492</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">MathUtils</span><span class=\"mtk1\">.</span><span class=\"mtk11\">validPerc</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_rewardCut</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;invalid rewardCut percentage&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">493</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">MathUtils</span><span class=\"mtk1\">.</span><span class=\"mtk11\">validPerc</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_feeShare</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;invalid feeShare percentage&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">494</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">isRegisteredTranscoder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;transcoder must be registered&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">496</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">Transcoder</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">t</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">transcoders</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">497</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentRound</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">roundsManager</span><span class=\"mtk1\">().</span><span class=\"mtk11\">currentRound</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">499</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">500</span><span class=\"mtk1\">:            !</span><span class=\"mtk11\">isActiveTranscoder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">) || </span><span class=\"mtk12\">t</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lastRewardRound</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">currentRound</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">501</span><span class=\"mtk1\">:            </span><span class=\"mtk8\">&quot;caller can&#39;t be active or must have already called reward for the current round&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">502</span><span class=\"mtk1\">:        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">507</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">transcoderPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">contains</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">508</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">tryToJoinActiveSet</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">509</span><span class=\"mtk1\">:                </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">510</span><span class=\"mtk1\">:                </span><span class=\"mtk12\">delegators</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">].</span><span class=\"mtk12\">delegatedAmount</span><span class=\"mtk1\">,</span></span></span></code></pre>\n<p>The require statement  on line 499 makes a call to the function <code>isActiveTranscoder(msg.sender)</code> which has the following implementation\n<a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L1145-L1149\">https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L1145-L1149</a>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">bonding</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BondingManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1145</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">isActiveTranscoder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_transcoder</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1146</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">Transcoder</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">t</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">transcoders</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_transcoder</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1147</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentRound</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">roundsManager</span><span class=\"mtk1\">().</span><span class=\"mtk11\">currentRound</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1148</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">t</span><span class=\"mtk1\">.</span><span class=\"mtk12\">activationRound</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">currentRound</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">currentRound</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">t</span><span class=\"mtk1\">.</span><span class=\"mtk12\">deactivationRound</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1149</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<p>Note the first two lines of this implementation:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1146</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">Transcoder</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">t</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">transcoders</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_transcoder</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1147</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentRound</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">roundsManager</span><span class=\"mtk1\">().</span><span class=\"mtk11\">currentRound</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p>If we look at the calling function, <code>transcoderWithHint()</code> we are making the same calls.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">496</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">Transcoder</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">t</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">transcoders</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">497</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentRound</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">roundsManager</span><span class=\"mtk1\">().</span><span class=\"mtk11\">currentRound</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p><strong>Additional optimizations</strong><br>\nOn line 494, we have a check <code>require(isRegisteredTranscoder(msg.sender), \"transcoder must be registered\");</code> that makes a function call to <code>isRegisteredTranscoder</code> which has the following implementation:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1156</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">isRegisteredTranscoder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_transcoder</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1157</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">Delegator</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">d</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">delegators</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_transcoder</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1158</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">d</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delegateAddress</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">_transcoder</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">d</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bondedAmount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1159</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<p>In our context we pass <code>msg.sender</code> as the value for <code>_transcoder</code>. If we could inline this function, we can avoid making another state read to <code>delegators[msg.sender]</code> on the line <a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L510\">510</a> in the main function. we read it here <code>delegators[msg.sender].delegatedAmount,</code>.<br>\nSince we already cache it as <code>d</code>, referencing <code>d</code> would save us some gas.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/bonding/BondingManager.sol b/contracts/bonding/BondingManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 93e06ba..3fc436b 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/bonding/BondingManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/bonding/BondingManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -491,13 +491,12 @@ contract BondingManager is ManagerProxyTarget, IBondingManager {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         require(!roundsManager().currentRoundLocked(), &quot;can&#39;t update transcoder params, current round is locked&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         require(MathUtils.validPerc(_rewardCut), &quot;invalid rewardCut percentage&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         require(MathUtils.validPerc(_feeShare), &quot;invalid feeShare percentage&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        require(isRegisteredTranscoder(msg.sender), &quot;transcoder must be registered&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        Delegator storage d = delegators[msg.sender];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        require(d.delegateAddress == msg.sender &amp;&amp; d.bondedAmount &gt; 0,&quot;transcoder must be registered&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         Transcoder storage t = transcoders[msg.sender];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 currentRound = roundsManager().currentRound();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        require(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            !isActiveTranscoder(msg.sender) || t.lastRewardRound == currentRound,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        require(!(t.activationRound &lt;= currentRound &amp;&amp; currentRound &lt; t.deactivationRound) || t.lastRewardRound == currentRound,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             &quot;caller can&#39;t be active or must have already called reward for the current round&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -507,7 +506,7 @@ contract BondingManager is ManagerProxyTarget, IBondingManager {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         if (!transcoderPool.contains(msg.sender)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             tryToJoinActiveSet(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 msg.sender,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-                delegators[msg.sender].delegatedAmount,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                d.delegatedAmount,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 currentRound.add(1),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 _newPosPrev,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 _newPosNext</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L842-L900\">https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L842-L900</a></p>\n<h2 id=\"g-04-function-rewardwithhint-optimization-save-4716-gas-on-average\" style=\"position:relative;\"><a href=\"#g-04-function-rewardwithhint-optimization-save-4716-gas-on-average\" aria-label=\"g 04 function rewardwithhint optimization save 4716 gas on average permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-04] Function <code>rewardWithHint()</code> optimization (Save 4716 Gas on average)</h2>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Min</th>\n<th>Average</th>\n<th>Median</th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>-</td>\n<td>453410</td>\n<td>-</td>\n<td>-</td>\n</tr>\n<tr>\n<td>After</td>\n<td>-</td>\n<td>448694</td>\n<td>-</td>\n<td>-</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">bonding</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BondingManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">842</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">rewardWithHint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_newPosPrev</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_newPosNext</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">847:    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">848</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentRound</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">roundsManager</span><span class=\"mtk1\">().</span><span class=\"mtk11\">currentRound</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">850</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">isActiveTranscoder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;caller must be an active transcoder&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">851</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">852</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">transcoders</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">].</span><span class=\"mtk12\">lastRewardRound</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">currentRound</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">853</span><span class=\"mtk1\">:            </span><span class=\"mtk8\">&quot;caller has already called reward for the current round&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">854</span><span class=\"mtk1\">:        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">856</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">Transcoder</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">t</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">transcoders</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">];</span></span></span></code></pre>\n<p>We look into the implementation of the function <code>isActiveTranscoder</code> which is being called in the require statement. The function has the following implementation:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1145</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">isActiveTranscoder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_transcoder</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1146</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">Transcoder</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">t</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">transcoders</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_transcoder</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1147</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentRound</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">roundsManager</span><span class=\"mtk1\">().</span><span class=\"mtk11\">currentRound</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1148</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">t</span><span class=\"mtk1\">.</span><span class=\"mtk12\">activationRound</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">currentRound</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">currentRound</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">t</span><span class=\"mtk1\">.</span><span class=\"mtk12\">deactivationRound</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1149</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<p>Put the above implementation in the context of our main function and we see two similar lines in both functions.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1146</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">Transcoder</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">t</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">transcoders</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_transcoder</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1147</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentRound</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">roundsManager</span><span class=\"mtk1\">().</span><span class=\"mtk11\">currentRound</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p>This means we are making this calls twice, one in the function being called, and the other one by the calling function.<br>\nTo avoid this, we can inline the function <code>isActiveTranscoder()</code> and refactor the code as follows:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/bonding/BondingManager.sol b/contracts/bonding/BondingManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 93e06ba..34c2832 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/bonding/BondingManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/bonding/BondingManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -846,14 +846,13 @@ contract BondingManager is ManagerProxyTarget, IBondingManager {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         autoCheckpoint(msg.sender)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 currentRound = roundsManager().currentRound();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        require(isActiveTranscoder(msg.sender), &quot;caller must be an active transcoder&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        Transcoder storage t = transcoders[msg.sender];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        require(t.activationRound &lt;= currentRound &amp;&amp; currentRound &lt; t.deactivationRound,&quot;caller must be an active transcoder&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         require(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            transcoders[msg.sender].lastRewardRound != currentRound,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            t.lastRewardRound != currentRound,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             &quot;caller has already called reward for the current round&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        Transcoder storage t = transcoders[msg.sender];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         EarningsPool.Data storage earningsPool = t.earningsPoolPerRound[currentRound];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // Set last round that transcoder called reward</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L1307-L1345\">https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L1307-L1345</a></p>\n<h2 id=\"g-05-function-increasetotalstakeuncheckpointed-can-be-more-optimized-save-148-gas-on-average\" style=\"position:relative;\"><a href=\"#g-05-function-increasetotalstakeuncheckpointed-can-be-more-optimized-save-148-gas-on-average\" aria-label=\"g 05 function increasetotalstakeuncheckpointed can be more optimized save 148 gas on average permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-05] Function <code>increaseTotalStakeUncheckpointed()</code> can be more optimized (save 148 Gas on average)</h2>\n<p>Gas benchmarks based on function <code>rewardWithHint</code> that calls our internal function.</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Min</th>\n<th>Average</th>\n<th>Median</th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>-</td>\n<td>453410</td>\n<td>-</td>\n<td>-</td>\n</tr>\n<tr>\n<td>After</td>\n<td>-</td>\n<td>453262</td>\n<td>-</td>\n<td>-</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">bonding</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BondingManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1307</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">increaseTotalStakeUncheckpointed</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">1312:    ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1318</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">isRegisteredTranscoder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_delegate</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1319</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currRound</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">roundsManager</span><span class=\"mtk1\">().</span><span class=\"mtk11\">currentRound</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1320</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nextRound</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">currRound</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1343</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// Increase delegate&#39;s delegated amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1344</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">delegators</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_delegate</span><span class=\"mtk1\">].</span><span class=\"mtk12\">delegatedAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">newStake</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1345</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<p>The if statement makes a call to a function <code>isRegisteredTranscoder(_delegate)</code> whose implementation is as follows:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1156</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">isRegisteredTranscoder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_transcoder</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1157</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">Delegator</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">d</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">delegators</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_transcoder</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1158</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">d</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delegateAddress</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">_transcoder</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">d</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bondedAmount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1159</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<p>Note in the function above, we cache <code>delegators[_transcoder]</code> with <code>_transcoder</code> being the address passed to the function, so in the context of our function it would look like <code>Delegator storage d = delegators[_delegate];</code>\nOn the calling function line 1344, we write to the state variable <code>delegators[_delegate].delegatedAmount</code>, as we already cached the variable <code>delegators[_delegate]</code> we don’t need to call it directly but instead we should use the cached reference. As the cached one is simply a pointer to the original one, we would still be writing to the state variable as required.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        if (isRegisteredTranscoder(_delegate)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        Delegator storage d = delegators[_delegate];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        if (d.delegateAddress == _delegate &amp;&amp; d.bondedAmount &gt; 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             uint256 currRound = roundsManager().currentRound();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             uint256 nextRound = currRound.add(1);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -1341,8 +1341,7 @@ contract BondingManager is ManagerProxyTarget, IBondingManager {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // Increase delegate&#39;s delegated amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        delegators[_delegate].delegatedAmount = newStake;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        d.delegatedAmount = newStake;//@audit Refactor the call due to the function call isRegisteredTranscoder?    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L745-L784\">https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L745-L784</a></p>\n<h2 id=\"g-06-refactor-the-function-unbondwithhint-save-1452-gas\" style=\"position:relative;\"><a href=\"#g-06-refactor-the-function-unbondwithhint-save-1452-gas\" aria-label=\"g 06 refactor the function unbondwithhint save 1452 gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-06] Refactor the function <code>unbondWithHint()</code> (Save 1452 Gas)</h2>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Min</th>\n<th>Average</th>\n<th>Median</th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>-</td>\n<td>509309</td>\n<td>-</td>\n<td>-</td>\n</tr>\n<tr>\n<td>After</td>\n<td>-</td>\n<td>507857</td>\n<td>-</td>\n<td>-</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">bonding</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BondingManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">745</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">unbondWithHint</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">749:    ) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">whenSystemNotPaused</span><span class=\"mtk1\"> </span><span class=\"mtk11\">currentRoundInitialized</span><span class=\"mtk1\"> </span><span class=\"mtk11\">autoClaimEarnings</span><span class=\"mtk1\">(msg.sender) </span><span class=\"mtk11\">autoCheckpoint</span><span class=\"mtk1\">(msg.sender) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">750</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">delegatorStatus</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">) == </span><span class=\"mtk12\">DelegatorStatus</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Bonded</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;caller must be bonded&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">752</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">Delegator</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">del</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">delegators</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">];</span></span></span></code></pre>\n<p>The require statement calls the function <code>delegatorStatus(msg.sender)</code> which has the implementation:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">956</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">delegatorStatus</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_delegator</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">DelegatorStatus</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">957</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">Delegator</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">del</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">delegators</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_delegator</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">959</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">del</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bondedAmount</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">960</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">// Delegator unbonded all its tokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">961</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">DelegatorStatus</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Unbonded</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">962</span><span class=\"mtk1\">:        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">del</span><span class=\"mtk1\">.</span><span class=\"mtk12\">startRound</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk11\">roundsManager</span><span class=\"mtk1\">().</span><span class=\"mtk11\">currentRound</span><span class=\"mtk1\">()) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">963</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">// Delegator round start is in the future</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">964</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">DelegatorStatus</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Pending</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">965</span><span class=\"mtk1\">:        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">969</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">DelegatorStatus</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Bonded</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">970</span><span class=\"mtk1\">:        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">971</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<p>Note we make a state read <code>Delegator storage del = delegators[_delegator];</code>.</p>\n<p>In the calling function , we pass <code>msg.sender</code> as the function parameter which means our state read in the function being called is <code>Delegator storage del = delegators[msg.sender];</code> which is the same state read we make in the main function. This means we are making this call twice(too much gas).</p>\n<p>For this to work, we introduce a new state variable to keep track of the status as shown below.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/bonding/BondingManager.sol b/contracts/bonding/BondingManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 93e06ba..3ec3b73 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/bonding/BondingManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/bonding/BondingManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -33,6 +33,7 @@ contract BondingManager is ManagerProxyTarget, IBondingManager {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     // Time between unbonding and possible withdrawl in rounds</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     uint64 public unbondingPeriod;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        DelegatorStatus delegatorStatus_;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     // Represents a transcoder&#39;s current state</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     struct Transcoder {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -742,20 +743,34 @@ contract BondingManager is ManagerProxyTarget, IBondingManager {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      * @param _newPosPrev Address of previous transcoder in pool if the caller remains in the pool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      * @param _newPosNext Address of next transcoder in pool if the caller remains in the pool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function unbondWithHint(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 _amount,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         address _newPosPrev,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         address _newPosNext</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) public whenSystemNotPaused currentRoundInitialized autoClaimEarnings(msg.sender) autoCheckpoint(msg.sender) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        require(delegatorStatus(msg.sender) == DelegatorStatus.Bonded, &quot;caller must be bonded&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         Delegator storage del = delegators[msg.sender];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         require(_amount &gt; 0, &quot;unbond amount must be greater than 0&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         require(_amount &lt;= del.bondedAmount, &quot;amount is greater than bonded amount&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 currentRound = roundsManager().currentRound();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        if (del.bondedAmount == 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            // Delegator unbonded all its tokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            delegatorStatus_ = DelegatorStatus.Unbonded;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        } else if (del.startRound &gt; currentRound) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            // Delegator unbonded all its tokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            delegatorStatus_ = DelegatorStatus.Pending;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        } else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            // Delegator round start is now or in the past</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            // del.startRound != 0 here because if del.startRound = 0 then del.bondedAmount = 0 which</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            // would trigger the first if clause</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            delegatorStatus_ = DelegatorStatus.Bonded;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        require(delegatorStatus_ == DelegatorStatus.Bonded, &quot;caller must be bonded&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         address currentDelegate = del.delegateAddress;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        uint256 currentRound = roundsManager().currentRound();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 withdrawRound = currentRound.add(unbondingPeriod);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 unbondingLockId = del.nextUnbondingLockId;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L394-L418\">https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L394-L418</a></p>\n<h2 id=\"g-07-function-slashtranscoder-can-be-optimized\" style=\"position:relative;\"><a href=\"#g-07-function-slashtranscoder-can-be-optimized\" aria-label=\"g 07 function slashtranscoder can be optimized permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-07] Function <code>slashTranscoder()</code> can be optimized</h2>\n<p><strong>Note: not covered by the tests.</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">bonding</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BondingManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">394</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">slashTranscoder</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">399:    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">whenSystemNotPaused</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyVerifier</span><span class=\"mtk1\"> </span><span class=\"mtk11\">autoClaimEarnings</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_transcoder</span><span class=\"mtk1\">) </span><span class=\"mtk11\">autoCheckpoint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_transcoder</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">400</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">Delegator</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">del</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">delegators</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_transcoder</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">402</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">del</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bondedAmount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">403</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">penalty</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">MathUtils</span><span class=\"mtk1\">.</span><span class=\"mtk11\">percOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">delegators</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_transcoder</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bondedAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_slashAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">413</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">// If still bonded decrease delegate&#39;s delegated amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">414</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">delegatorStatus</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_transcoder</span><span class=\"mtk1\">) == </span><span class=\"mtk12\">DelegatorStatus</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Bonded</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">415</span><span class=\"mtk1\">:                </span><span class=\"mtk12\">delegators</span><span class=\"mtk1\">[</span><span class=\"mtk12\">del</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delegateAddress</span><span class=\"mtk1\">].</span><span class=\"mtk12\">delegatedAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">delegators</span><span class=\"mtk1\">[</span><span class=\"mtk12\">del</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delegateAddress</span><span class=\"mtk1\">].</span><span class=\"mtk12\">delegatedAmount</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sub</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">416</span><span class=\"mtk1\">:                    </span><span class=\"mtk12\">penalty</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">417</span><span class=\"mtk1\">:                );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">418</span><span class=\"mtk1\">:            }</span></span></span></code></pre>\n<p>The function call <code>delegatorStatus(_transcoder)</code> ends up making a similar state read like the one in the calling function ie  <code>Delegator storage del = delegators[_transcoder];</code>.<br>\nWe can refactor the code to avoid this as follows.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"48\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     // Time between unbonding and possible withdrawl in rounds</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     uint64 public unbondingPeriod;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    DelegatorStatus delegatorStatus_;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function slashTranscoder(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         address _transcoder,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         address _finder,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -400,7 +402,7 @@ contract BondingManager is ManagerProxyTarget, IBondingManager {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         Delegator storage del = delegators[_transcoder];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         if (del.bondedAmount &gt; 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            uint256 penalty = MathUtils.percOf(delegators[_transcoder].bondedAmount, _slashAmount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            uint256 penalty = MathUtils.percOf(del.bondedAmount, _slashAmount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             // If active transcoder, resign it</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             if (transcoderPool.contains(_transcoder)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -410,8 +412,21 @@ contract BondingManager is ManagerProxyTarget, IBondingManager {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             // Decrease bonded stake</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             del.bondedAmount = del.bondedAmount.sub(penalty);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            if (del.bondedAmount == 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                // Delegator unbonded all its tokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                delegatorStatus_= DelegatorStatus.Unbonded;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            } else if (del.startRound &gt; roundsManager().currentRound()) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                // Delegator round start is in the future</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                delegatorStatus_ =  DelegatorStatus.Pending;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            } else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                // Delegator round start is now or in the past</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                // del.startRound != 0 here because if del.startRound = 0 then del.bondedAmount = 0 which</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                // would trigger the first if clause</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                delegatorStatus_ =  DelegatorStatus.Bonded;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             // If still bonded decrease delegate&#39;s delegated amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            if (delegatorStatus(_transcoder) == DelegatorStatus.Bonded) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            if (delegatorStatus_ == DelegatorStatus.Bonded) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 delegators[del.delegateAddress].delegatedAmount = delegators[del.delegateAddress].delegatedAmount.sub(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                     penalty</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 );</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingVotes.sol#L258-L294\">https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingVotes.sol#L258-L294</a></p>\n<h2 id=\"g-08-bondingvotessol-we-can-optimize-the-function-checkpointbondingstate\" style=\"position:relative;\"><a href=\"#g-08-bondingvotessol-we-can-optimize-the-function-checkpointbondingstate\" aria-label=\"g 08 bondingvotessol we can optimize the function checkpointbondingstate permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-08] BondingVotes.sol: We can optimize the function <code>checkpointBondingState</code></h2>\n<p><strong>Note: no gas estimates as it was not covered by the tests.</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"49\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">bonding</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BondingVotes</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">258</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">checkpointBondingState</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">266:    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyBondingManager</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">273</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">BondingCheckpoint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">previous</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">274</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">hasCheckpoint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_account</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">275</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">previous</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getBondingCheckpointAt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_startRound</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">276</span><span class=\"mtk1\">:        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">278</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">BondingCheckpointsByRound</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">checkpoints</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">bondingCheckpoints</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_account</span><span class=\"mtk1\">];</span></span></span></code></pre>\n<p>The if statement on line 274 makes two function calls <code>hasCheckpoint(_account)</code> and <code>getBondingCheckpointAt(_account, _startRound)</code>.</p>\n<p>The implementation of <code>hasCheckpoint(_account)</code>  is as below:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"50\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">315</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">hasCheckpoint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_account</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">316</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bondingCheckpoints</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_account</span><span class=\"mtk1\">].</span><span class=\"mtk12\">startRounds</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">317</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<p>We can see the return statement reads <code>bondingCheckpoints[_account]</code> which we already had cached in the main function as <code>checkpoints</code>. Inline the <code>hasCheckpoint</code> function would help us use the cached value.</p>\n<p>The next function <code>getBondingCheckpointAt()</code> has an implementation that has the following state read:<br>\n<code>BondingCheckpointsByRound storage checkpoints = bondingCheckpoints[_account];</code><br>\nWhich is equivalent to the variable we cached in the main function. Inlining this  function would avoid making two state reads which are quite expensive.</p>\n<p>We should refactor the code as follows:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"51\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/bonding/BondingVotes.sol b/contracts/bonding/BondingVotes.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 2408c66..ca92f91 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/bonding/BondingVotes.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/bonding/BondingVotes.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -271,26 +271,44 @@ contract BondingVotes is ManagerProxyTarget, IBondingVotes {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         BondingCheckpoint memory previous;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        if (hasCheckpoint(_account)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            previous = getBondingCheckpointAt(_account, _startRound);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         BondingCheckpointsByRound storage checkpoints = bondingCheckpoints[_account];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        if (checkpoints.startRounds.length &gt; 0){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+           if (_startRound &gt; clock() + 1) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                 revert FutureLookup(_startRound, clock() + 1);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            // Most of the time we will be calling this for a transcoder which checkpoints on every round through reward().</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            // On those cases we will have a checkpoint for exactly the round we want, so optimize for that.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            BondingCheckpoint storage bond = checkpoints.data[_startRound];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            if (bond.bondedAmount &gt; 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                previous = bond;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            uint256 startRoundIdx = checkpoints.startRounds.findLowerBound(_startRound);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            if (startRoundIdx == checkpoints.startRounds.length) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                // No checkpoint at or before _round, so return the zero BondingCheckpoint value. This also happens if there</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                // are no checkpoints for _account. The voting power will be zero until the first checkpoint is made.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                previous = bond;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            uint256 startRound = checkpoints.startRounds[startRoundIdx];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            previous = checkpoints.data[startRound];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        BondingCheckpoint memory bond = BondingCheckpoint({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        BondingCheckpoint memory _bond = BondingCheckpoint({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             bondedAmount: _bondedAmount,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             delegateAddress: _delegateAddress,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             delegatedAmount: _delegatedAmount,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             lastClaimRound: _lastClaimRound,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             lastRewardRound: _lastRewardRound</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        checkpoints.data[_startRound] = bond;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        checkpoints.data[_startRound] = _bond;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // now store the startRound itself in the startRounds array to allow us</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // to find it and lookup in the above mapping</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         checkpoints.startRounds.pushSorted(_startRound);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        onBondingCheckpointChanged(_account, previous, bond);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        onBondingCheckpointChanged(_account, previous, _bond);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span></code></pre>\n<h2 id=\"g-09-optimizing-check-order-for-cost-efficient-function-execution\" style=\"position:relative;\"><a href=\"#g-09-optimizing-check-order-for-cost-efficient-function-execution\" aria-label=\"g 09 optimizing check order for cost efficient function execution permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-09] Optimizing check order for cost efficient function execution</h2>\n<p>Checks that involve constants should come before checks that involve state variables, function calls, and calculations. By doing these checks first, the function is able to revert before wasting a Gcoldsload (2100 gas) in a function that may ultimately revert in the unhappy case.</p>\n<p><a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L745-L784\">https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L745-L784</a></p>\n<h3 id=\"g-09-01-validate-the-function-parameter-_amount-first-before-making-any-state-readswrites\" style=\"position:relative;\"><a href=\"#g-09-01-validate-the-function-parameter-_amount-first-before-making-any-state-readswrites\" aria-label=\"g 09 01 validate the function parameter _amount first before making any state readswrites permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-09-01] Validate the function parameter <code>_amount</code> first before making any state reads/writes</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"52\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">bonding</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BondingManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">745</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">unbondWithHint</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">749:    ) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">whenSystemNotPaused</span><span class=\"mtk1\"> </span><span class=\"mtk11\">currentRoundInitialized</span><span class=\"mtk1\"> </span><span class=\"mtk11\">autoClaimEarnings</span><span class=\"mtk1\">(msg.sender) </span><span class=\"mtk11\">autoCheckpoint</span><span class=\"mtk1\">(msg.sender) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">750</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">delegatorStatus</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">) == </span><span class=\"mtk12\">DelegatorStatus</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Bonded</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;caller must be bonded&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">752</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">Delegator</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">del</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">delegators</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">755</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;unbond amount must be greater than 0&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"53\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/bonding/BondingManager.sol b/contracts/bonding/BondingManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 93e06ba..c43f3e3 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/bonding/BondingManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/bonding/BondingManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -747,11 +747,12 @@ contract BondingManager is ManagerProxyTarget, IBondingManager {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         address _newPosPrev,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         address _newPosNext</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) public whenSystemNotPaused currentRoundInitialized autoClaimEarnings(msg.sender) autoCheckpoint(msg.sender) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        require(_amount &gt; 0, &quot;unbond amount must be greater than 0&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         require(delegatorStatus(msg.sender) == DelegatorStatus.Bonded, &quot;caller must be bonded&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         Delegator storage del = delegators[msg.sender];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        require(_amount &gt; 0, &quot;unbond amount must be greater than 0&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         require(_amount &lt;= del.bondedAmount, &quot;amount is greater than bonded amount&quot;);</span></span></span></code></pre>\n<h2 id=\"g-10-change-the-model-of-how-events-are-emitted\" style=\"position:relative;\"><a href=\"#g-10-change-the-model-of-how-events-are-emitted\" aria-label=\"g 10 change the model of how events are emitted permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-10] Change the model of how events are emitted</h2>\n<p>Currently if we look at the event declaration we see something like this <code>event ParameterUpdate(string param);</code> and the actual emit as <code>emit ParameterUpdate(\"unbondingPeriod\");</code>.<br>\nThis method seems quite interesting especially for readability as we can clearly tell what the event is about. However, this method is quite expensive and an anti pattern. We can actually achieve the same readability by using named parameters for our event argument and naming the events using a descriptive name.</p>\n<p><a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L155-L159\">https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L155-L159</a></p>\n<h3 id=\"g-10-01-bondingmanagersolsetunbondingperiod-emit-_unbondingperiod-instead-of-unbondingperiod-save-593-gas-on-average\" style=\"position:relative;\"><a href=\"#g-10-01-bondingmanagersolsetunbondingperiod-emit-_unbondingperiod-instead-of-unbondingperiod-save-593-gas-on-average\" aria-label=\"g 10 01 bondingmanagersolsetunbondingperiod emit _unbondingperiod instead of unbondingperiod save 593 gas on average permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-10-01] BondingManager.sol.setUnbondingPeriod(): emit <code>_unbondingPeriod</code> instead of <code>\"unbondingPeriod\"</code> (Save 593 Gas on average)</h3>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Min</th>\n<th>Max</th>\n<th>Avg</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>-</td>\n<td>-</td>\n<td>61189</td>\n</tr>\n<tr>\n<td>After</td>\n<td>-</td>\n<td>-</td>\n<td>60596</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"54\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">bonding</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BondingManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">155</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setUnbondingPeriod</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint64</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_unbondingPeriod</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyControllerOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">156</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">unbondingPeriod</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_unbondingPeriod</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">158</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ParameterUpdate</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;unbondingPeriod&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">159</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"55\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/bonding/BondingManager.sol b/contracts/bonding/BondingManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 93e06ba..482d4e9 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/bonding/BondingManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/bonding/BondingManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -136,6 +136,7 @@ contract BondingManager is ManagerProxyTarget, IBondingManager {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         _;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         _checkpointBondingState(_account, delegators[_account], transcoders[_account]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    event setUnbondingPeriodNewValue(uint256 unbondingPeriod);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      * @notice BondingManager constructor. Only invokes constructor of base Manager contract with provided Controller address</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -155,7 +156,7 @@ contract BondingManager is ManagerProxyTarget, IBondingManager {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function setUnbondingPeriod(uint64 _unbondingPeriod) external onlyControllerOwner {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         unbondingPeriod = _unbondingPeriod;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        emit ParameterUpdate(&quot;unbondingPeriod&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        emit setUnbondingPeriodNewValue(_unbondingPeriod);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L186-L190\">https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L186-L190</a></p>\n<h3 id=\"g-10-02-bondingmanagersolsetnumactivetranscoders-emit-_numactivetranscoders-instead-of-numactivetranscoders-save-584-gas-on-average\" style=\"position:relative;\"><a href=\"#g-10-02-bondingmanagersolsetnumactivetranscoders-emit-_numactivetranscoders-instead-of-numactivetranscoders-save-584-gas-on-average\" aria-label=\"g 10 02 bondingmanagersolsetnumactivetranscoders emit _numactivetranscoders instead of numactivetranscoders save 584 gas on average permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-10-02] BondingManager.sol.setNumActiveTranscoders(): Emit <code>_numActiveTranscoders</code> instead of <code>\"numActiveTranscoders\"</code> (Save 584 Gas on average)</h3>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Min</th>\n<th>Max</th>\n<th>Avg</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>47192</td>\n<td>64292</td>\n<td>55742</td>\n</tr>\n<tr>\n<td>After</td>\n<td>46608</td>\n<td>63708</td>\n<td>55158</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"56\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">bonding</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BondingManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">186</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setNumActiveTranscoders</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_numActiveTranscoders</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyControllerOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">187</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">transcoderPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setMaxSize</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_numActiveTranscoders</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">189</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ParameterUpdate</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;numActiveTranscoders&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">190</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"57\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            event setNumActiveTranscodersCeilingNewValue(uint256 _numActiveTranscoders);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      * @notice BondingManager constructor. Only invokes constructor of base Manager contract with provided Controller address</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -186,7 +188,7 @@ contract BondingManager is ManagerProxyTarget, IBondingManager {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function setNumActiveTranscoders(uint256 _numActiveTranscoders) external onlyControllerOwner {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         transcoderPool.setMaxSize(_numActiveTranscoders);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        emit ParameterUpdate(&quot;numActiveTranscoders&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        emit setNumActiveTranscodersCeilingNewValue(_numActiveTranscoders);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span></code></pre>\n<p><em>The following are not covered by the tests thus we couldn’t give an exact amount of gas being saved.</em></p>\n<p><a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L176-L180\">https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L176-L180</a></p>\n<h3 id=\"g-10-03-bondingmanagersolsettreasurybalanceceiling-emit-_ceiling-instead-of-treasurybalanceceiling\" style=\"position:relative;\"><a href=\"#g-10-03-bondingmanagersolsettreasurybalanceceiling-emit-_ceiling-instead-of-treasurybalanceceiling\" aria-label=\"g 10 03 bondingmanagersolsettreasurybalanceceiling emit _ceiling instead of treasurybalanceceiling permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-10-03] BondingManager.sol.setTreasuryBalanceCeiling(): Emit <code>_ceiling</code> instead of <code>\"treasuryBalanceCeiling\"</code></h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"58\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">bonding</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BondingManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">176</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setTreasuryBalanceCeiling</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_ceiling</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyControllerOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">177</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">treasuryBalanceCeiling</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_ceiling</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">179</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ParameterUpdate</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;treasuryBalanceCeiling&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">180</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"59\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        event settreasuryBalanceCeilingNewValue(uint256 treasuryBalanceCeiling);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      * @notice BondingManager constructor. Only invokes constructor of base Manager contract with provided Controller address</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      * @dev This constructor will not initialize any state variables besides `controller`. The following setter functions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -176,7 +178,7 @@ contract BondingManager is ManagerProxyTarget, IBondingManager {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function setTreasuryBalanceCeiling(uint256 _ceiling) external onlyControllerOwner {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         treasuryBalanceCeiling = _ceiling;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        emit ParameterUpdate(&quot;treasuryBalanceCeiling&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        emit settreasuryBalanceCeilingNewValue(_ceiling);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L462-L469\">https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L462-L469</a></p>\n<h3 id=\"g-10-04-bondingmanagersolsetcurrentroundtotalactivestake-emit-treasuryrewardcutrate-instead-of-treasuryrewardcutrate\" style=\"position:relative;\"><a href=\"#g-10-04-bondingmanagersolsetcurrentroundtotalactivestake-emit-treasuryrewardcutrate-instead-of-treasuryrewardcutrate\" aria-label=\"g 10 04 bondingmanagersolsetcurrentroundtotalactivestake emit treasuryrewardcutrate instead of treasuryrewardcutrate permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-10-04] BondingManager.sol.setCurrentRoundTotalActiveStake(): Emit <code>treasuryRewardCutRate</code> instead of <code>\"treasuryRewardCutRate\"</code></h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"60\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">bonding</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BondingManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">462</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setCurrentRoundTotalActiveStake</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyRoundsManager</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">463</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">currentRoundTotalActiveStake</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">nextRoundTotalActiveStake</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">465</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">nextRoundTreasuryRewardCutRate</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">treasuryRewardCutRate</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">466</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">treasuryRewardCutRate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">nextRoundTreasuryRewardCutRate</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">467</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">// The treasury cut rate changes in a delayed fashion so we want to emit the parameter update event here</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">468</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ParameterUpdate</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;treasuryRewardCutRate&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">469</span><span class=\"mtk1\">:        }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"61\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   event setCurrentRoundTotalActiveStakeNewValue(uint256 treasuryRewardCutRate);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      * @notice BondingManager constructor. Only invokes constructor of base Manager contract with provided Controller address</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -465,7 +466,7 @@ contract BondingManager is ManagerProxyTarget, IBondingManager {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         if (nextRoundTreasuryRewardCutRate != treasuryRewardCutRate) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             treasuryRewardCutRate = nextRoundTreasuryRewardCutRate;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             // The treasury cut rate changes in a delayed fashion so we want to emit the parameter update event here</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            emit ParameterUpdate(&quot;treasuryRewardCutRate&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            emit setCurrentRoundTotalActiveStakeNewValue(treasuryRewardCutRate);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L1176-L1182\">https://github.com/code-423n4/2023-08-livepeer/blob/a3d801fa4690119b6f96aeb5508e58d752bda5bc/contracts/bonding/BondingManager.sol#L1176-L1182</a></p>\n<h3 id=\"g-10-05-bondingmanagersol_settreasuryrewardcutrate-emit-_cutrate-instead-of-nextroundtreasuryrewardcutrate\" style=\"position:relative;\"><a href=\"#g-10-05-bondingmanagersol_settreasuryrewardcutrate-emit-_cutrate-instead-of-nextroundtreasuryrewardcutrate\" aria-label=\"g 10 05 bondingmanagersol_settreasuryrewardcutrate emit _cutrate instead of nextroundtreasuryrewardcutrate permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-10-05] BondingManager.sol._setTreasuryRewardCutRate(): Emit <code>_cutRate</code> instead of <code>\"nextRoundTreasuryRewardCutRate\"</code></h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"62\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">bonding</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BondingManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1176</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_setTreasuryRewardCutRate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_cutRate</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1177</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">PreciseMathUtils</span><span class=\"mtk1\">.</span><span class=\"mtk11\">validPerc</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_cutRate</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;_cutRate is invalid precise percentage&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1179</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">nextRoundTreasuryRewardCutRate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_cutRate</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1181</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ParameterUpdate</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;nextRoundTreasuryRewardCutRate&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1182</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"63\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   event setTreasuryRewardCutRateNewValue(uint256 nextRoundTreasuryRewardCutRate);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      * @notice BondingManager constructor. Only invokes constructor of base Manager contract with provided Controller address</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      * @dev This constructor will not initialize any state variables besides `controller`. The following setter functions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -1178,7 +1178,7 @@ contract BondingManager is ManagerProxyTarget, IBondingManager {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         nextRoundTreasuryRewardCutRate = _cutRate;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        emit ParameterUpdate(&quot;nextRoundTreasuryRewardCutRate&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        emit setTreasuryRewardCutRateNewValue(_cutRate);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span></code></pre>\n<h2 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p>It is important to emphasize that the provided recommendations aim to enhance the efficiency of the code without compromising its readability. We understand the value of maintainable and easily understandable code to both developers and auditors.</p>\n<p>As you proceed with implementing the suggested optimizations, please exercise caution and be diligent in conducting thorough testing. It is crucial to ensure that the changes are not introducing any new vulnerabilities and that the desired performance improvements are achieved. Review code changes, and perform thorough testing to validate the effectiveness and security of the refactored code.</p>\n<p>Should you have any questions or need further assistance, please don’t hesitate to reach out.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/222#issuecomment-1732041299\">victorges (Livepeer) acknowledged</a></strong></p>\n<hr>\n<h1 id=\"audit-analysis\" style=\"position:relative;\"><a href=\"#audit-analysis\" aria-label=\"audit analysis permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Audit Analysis</h1>\n<p>For this audit, 7 analysis reports were submitted by wardens. An analysis report examines the codebase as a whole, providing observations and advice on such topics as architecture, mechanism, or approach. The <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/243\">report highlighted below</a> by <strong>catellatech</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/226\">Sathish9098</a>, <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/5\">JayShreeRAM</a>, <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/122\">ADM</a>, <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/102\">Banditx0x</a>, <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/69\">0x3b</a>, and <a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/57\">Krace</a>.</em></p>\n<h3 id=\"description-overview-of-livepeer-onchain-treasury-upgrade\" style=\"position:relative;\"><a href=\"#description-overview-of-livepeer-onchain-treasury-upgrade\" aria-label=\"description overview of livepeer onchain treasury upgrade permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description overview of Livepeer Onchain Treasury Upgrade</h3>\n<p>The <code>Livepeer Onchain Treasury Upgrade</code> is a significant enhancement to the <code>Livepeer protocol</code>, which is a decentralized video infrastructure platform used in <code>web3's</code> social media and media applications. The primary objective of this upgrade is to create an <code>onchain community treasury</code>. This treasury is funded through a percentage of protocol rewards generated by the network.</p>\n<p>To achieve this, <code>OpenZeppelin governance</code> tools are leveraged, and a custom voting power module is implemented to facilitate onchain voting. The upgrade process is detailed in various technical documents such as <a href=\"https://github.com/livepeer/LIPs/blob/master/LIPs/LIP-91.md\">LIP-91</a>, <a href=\"https://github.com/livepeer/LIPs/blob/master/LIPs/LIP-89.md\">LIP-89</a>, and <a href=\"https://github.com/livepeer/LIPs/blob/master/LIPs/LIP-92.md\">LIP-92</a>, which provide a comprehensive blueprint for the upgrade’s implementation.</p>\n<p>A critical aspect of this upgrade is ensuring that there are no significant changes to the behavior of the <code>core protocol contract</code>, known as the <code>BondingManager</code>, except for the specific modifications required to accommodate the community treasury. Attention is also paid to maintaining the security and integrity of the protocol to avoid introducing new vulnerabilities.</p>\n<p>Additionally, it’s worth noting that Livepeer employs a unique <code>staking rewards</code> calculation system, which is used not only for distributing rewards to participants but also for funding the community treasury.</p>\n<p><img src=\"https://user-images.githubusercontent.com/98446738/275616449-59ac823b-2382-403d-abc1-9a4d349b0713.png\" alt=\"Livepeer1\"></p>\n<h3 id=\"1--system-overview\" style=\"position:relative;\"><a href=\"#1--system-overview\" aria-label=\"1  system overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1- System Overview</h3>\n<p><strong>Scope</strong></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/main/contracts/bonding/BondingManager.sol\">BondingManager.sol</a>: An existing contract that oversees the management of protocol bonds, often referred to as staking, as well as rewards. This upgrade introduces the capability to facilitate state checkpointing and the creation of treasury rewards. This contract holds paramount significance within the audit due to its pivotal role in the current protocol.</li>\n<li><a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/main/contracts/bonding/BondingVotes.sol\">BondingVotes.sol</a>: This contract stores checkpoints of the BondingManager state to facilitate an IERC5805Upgradeable (IVotes) implementation for the OpenZeppelin Governor.</li>\n<li><a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/main/contracts/bonding/libraries/EarningsPoolLIP36.sol\">EarningsPoolLIP36.sol</a>: This library offers utility functions to calculate staking rewards utilizing the LIP-36 cumulative earnings algorithm.</li>\n<li><a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/main/contracts/bonding/libraries/SortedArrays.sol\">SortedArrays.sol</a>: This library offers assistance for managing and searching within sorted arrays. It extends the functionality of Arrays.findUpperBound to include an equivalent findLowerBound for checkpoint retrieval.</li>\n<li><a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/main/contracts/treasury/GovernorCountingOverridable.sol\">GovernorCountingOverridable.sol</a>: Abstract contract that implements an OpenZeppelin Governor counting module, enabling delegators to override their delegates’ (transcoders) votes on a proposal.</li>\n<li><a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/main/contracts/treasury/Treasury.sol\">Treasury.sol</a>: This contract inherits from TimelockControllerUpgradeable to enable initialization. It is used by the governor to hold funds and execute proposals.</li>\n<li><a href=\"https://github.com/code-423n4/2023-08-livepeer/blob/main/contracts/treasury/LivepeerGovernor.sol\">LivepeerGovernor.sol</a>: This contract serves as the practical Governor implementation, bringing together both the OZ built-in and custom modules and extensions into a tangible contract that can be instantiated and utilized. It primarily handles the framework necessary to assemble these components.</li>\n</ul>\n<p><strong>Privileged Roles</strong></p>\n<p>Some privileged roles exercise powers over the Controller contract:</p>\n<ul>\n<li><strong>TicketBroker</strong></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"shell\" data-index=\"64\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Check if sender is TicketBroker</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    modifier onlyTicketBroker() {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _onlyTicketBroker();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<ul>\n<li><strong>RoundManager</strong></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"shell\" data-index=\"65\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Check if sender is RoundsManager</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    modifier onlyRoundsManager() {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _onlyRoundsManager();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<ul>\n<li><strong>Verifier</strong></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"shell\" data-index=\"66\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Check if sender is Verifier</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    modifier onlyVerifier() {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _onlyVerifier();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>We asked the sponsors about who will be responsible for these roles, and this was their response:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"shell\" data-index=\"67\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">victorges — 09/2/2023 at 12:20</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Hey warden!</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">The roles are managed by a special controller owner address which handles protocol governance. See the controller contact that holds all the contract (roles) addresses</span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"shell\" data-index=\"68\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">dob | Livepeer — 09/2/2023 at 3:29</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">I have seen a few questions come through about the Verifier role, and whether it is trusted.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Only the registered &quot;Verifier&quot; in the Controller contract can call the slashTranscoder function. The registered verifier contract is 0x0000000000.... the null address. Hence it can&#39;t be invoked right now, as slashing is not active in the protocol.</span></span></code></pre>\n<p><code>Given the level of control that these roles possess within the system, users must place full trust in the fact that the entities overseeing these roles will always act correctly and in the best interest of the system and its users.</code></p>\n<h3 id=\"2--codebase-analysis-through-diagrams\" style=\"position:relative;\"><a href=\"#2--codebase-analysis-through-diagrams\" aria-label=\"2  codebase analysis through diagrams permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2- Codebase analysis through diagrams.</h3>\n<p>The main most important contracts of <code>Livepeer Onchain Treasury Upgrade</code>.</p>\n<ul>\n<li>In this audit, the protocol provided <code>5 contracts</code> and <code>2 libraries</code>. Here’s a detailed diagrams of the essential components of each ones:</li>\n</ul>\n<p><strong>Contracts:</strong></p>\n<p><strong>1. BondingManager:</strong></p>\n<p><img src=\"https://user-images.githubusercontent.com/98446738/275616922-9865ac93-6a8d-4fc9-9136-1fcdd94d0063.png\" alt=\"BondingManager\"></p>\n<p>We have created a diagram organized into sections to facilitate understanding for both <code>developers</code> and <code>auditors</code> of the main contract. This contract is responsible for managing three fundamental areas: <code>Delegator and Transcoder Management</code>, <code>Asset and Stake Management</code>, and <code>Reward Management and State Update</code>.</p>\n<p>The contract plays a critical role in managing protocol <code>bonds</code> and <code>rewards</code>. A significant upgrade adds support for creating state checkpointing and generating rewards for the protocol’s treasury. Additionally, the code includes sections related to the management of a decentralized video transcoding system, where delegates actively participate, and transcoders compete for rewards.</p>\n<p><strong>2. BondingVotes:</strong></p>\n<p><img src=\"https://user-images.githubusercontent.com/98446738/275617082-39a44ce2-a092-43d2-bce7-f6d285756b82.png\" alt=\"BondingVotes\"></p>\n<p>In this <code>BondingVotes</code> diagram, we provide a concise description of each function implemented by the contract. <code>BondingVotes</code> is responsible for the <code>checkpointing</code> logic for the state of the <code>BondingManager</code> and its primary purpose is to perform <code>historical calculations</code> related to participation in the <code>Livepeer</code> network.</p>\n<p><strong>3. GovernorCountingOverridable:</strong></p>\n<p><img src=\"https://user-images.githubusercontent.com/98446738/275617214-09769597-c1d1-4b50-a142-e89160ebb7eb.png\" alt=\"GovernorCountingOverridable\"></p>\n<p>In this <code>diagram</code>, we review the <code>functions</code> performed in the contract and their respective purposes. The <code>GovernorCountingOverridable</code> contract serves as a foundation for implementing <code>decentralized governance systems</code> that allow <code>delegates</code> to override the votes of the <code>transcoders</code> they have delegated to. It also provides logic for <code>vote counting</code> and determining the <code>success of proposals</code>.</p>\n<p><strong>4. Treasury:</strong></p>\n<p><img src=\"https://user-images.githubusercontent.com/98446738/275617360-f2045d79-7d75-473a-ab38-d0026bb0a994.png\" alt=\"Treasury\"></p>\n<p>The <code>Treasury</code> contract is used to <code>manage treasury funds</code> and <code>governance proposals</code> in <code>Livepeer</code>, and its <code>initialization</code> function is <code>responsible</code> for <code>configuring</code> the <code>time-lock controller</code> for <code>governance</code>. The two main purposes of this contract are summarized in the provided <code>diagram</code>.</p>\n<p><strong>5. LivepeerGovernor:</strong></p>\n<p><img src=\"https://user-images.githubusercontent.com/98446738/275617505-d769c6da-dca3-48cb-b117-e6e6dfa1ae47.png\" alt=\"LivepeerGovernor\"></p>\n<p>In this <code>diagram</code>, we illustrate how the <code>LivepeerGovernor</code> contract acts as the <code>treasury governor</code> in <code>Livepeer</code>. It utilizes <code>extensions</code> and other <code>contracts</code> to implement <code>governance logic</code> and <code>vote management</code>.</p>\n<p><strong>Libraries</strong></p>\n<p><strong>1. EarningsPoolLIP36:</strong></p>\n<p><img src=\"https://user-images.githubusercontent.com/98446738/275617697-017b4e98-d9e6-4bf1-9cc7-21eff6ebe9ba.png\" alt=\"EarningsPoolLIP36\"></p>\n<p>This <code>library</code> provides functions to update and calculate cumulative <code>fee</code> and <code>reward</code> factors in an <code>EarningsPool</code> and to <code>calculate</code> the cumulative <code>stake</code> and <code>fees</code> of a <code>delegator</code> based on these factors. The <code>diagram</code> includes all the <code>functions</code> in the library.</p>\n<p><strong>2. SortedArrays:</strong></p>\n<p><img src=\"https://user-images.githubusercontent.com/98446738/275617861-d3d39b5f-f6a3-4095-a822-ea0986bbbad0.png\" alt=\"SortedArrays\"></p>\n<p>This <code>library</code> is useful for working with <code>arrays</code> of integers sorted in ascending order. In the <code>diagram</code>, we specify both the <code>findLowerBound</code> function, which is particularly useful for searching for a value in the array and finding the <code>index</code> of the last element that is less than or equal to the searched value, and the <code>pushSorted</code> function, which allows you to add values to the array while maintaining order and avoiding duplicates.</p>\n<h3 id=\"3--livepeer-onchain-treasury-upgrade-architecture\" style=\"position:relative;\"><a href=\"#3--livepeer-onchain-treasury-upgrade-architecture\" aria-label=\"3  livepeer onchain treasury upgrade architecture permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3- Livepeer Onchain Treasury Upgrade Architecture</h3>\n<p>This <code>diagram</code> illustrates the interaction among the key components of the <code>Livepeer protocol</code>. The <code>LivepeerGovernor</code> serves as the main governance system. The <code>BondingManager</code> is responsible for managing user participation, while <code>BondingVotes</code> is used to handle the voting logic. Lastly, the <code>Treasury</code> manages treasury funds and governance proposals related to the treasury. It also shows how a <code>user</code> engages with the system, all succinctly summarized in the diagram.</p>\n<p><img src=\"https://user-images.githubusercontent.com/98446738/275618065-4e310d78-2436-458d-a193-1f4cd38a4bb2.png\" alt=\"Architecture\"></p>\n<ul>\n<li>\n<p><strong>Some potential areas of improvement or consideration could include</strong>:</p>\n<ul>\n<li><strong>User Experience</strong>: Enhancing the user experience for both transcoders and token holders can attract more participants. User-friendly interfaces, improved documentation, and educational resources can be beneficial.</li>\n<li><strong>Governance Flexibility</strong>: Evaluating the governance mechanisms to ensure they are adaptable and can accommodate changes as the ecosystem evolves.</li>\n<li><strong>Interoperability</strong>: Exploring interoperability with other blockchain networks or protocols can expand Livepeer’s capabilities and reach.</li>\n<li><strong>Documentation and Education</strong>: Comprehensive documentation and educational materials can help users understand and navigate the Livepeer ecosystem more effectively.</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"4--documents\" style=\"position:relative;\"><a href=\"#4--documents\" aria-label=\"4  documents permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4- Documents</h3>\n<ul>\n<li>The documentation of the <code>Livepeer Onchain Treasury Upgrade</code> project is quite comprehensive and detailed, providing a solid overview of how <code>Livepeer</code> is structured and how its various aspects function. However, we have noticed that there is room for additional details, such as <code>diagrams</code>, to gain a deeper understanding of how different contracts interact and the functions they implement. With considerable enthusiasm, we have dedicated several days to creating diagrams for each of the contracts.\nWe are confident that these diagrams will bring significant value to the protocol as they can be seamlessly integrated into the existing <code>documentation</code>, enriching it and providing a more comprehensive and detailed understanding for <code>users</code>, <code>developers</code> and <code>auditors</code>.</li>\n</ul>\n<h3 id=\"5--systemic--centralization-risks\" style=\"position:relative;\"><a href=\"#5--systemic--centralization-risks\" aria-label=\"5  systemic  centralization risks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5- Systemic &#x26; Centralization Risks</h3>\n<p>Here’s an analysis of potential systemic and centralization risks in the provided contracts:</p>\n<p><strong>Systemic Risks:</strong></p>\n<ul>\n<li><strong>Smart Contract Vulnerability Risk</strong>: Smart contracts can contain vulnerabilities that can be exploited by attackers. If a smart contract has critical security flaws, such as <code>access errors</code> or <code>logic problems</code>, this could lead to <code>asset loss</code> or <code>system manipulation</code>. We strongly recommend that, once the protocol is audited, necessary actions be taken to <code>mitigate</code> any issues identified by <code>C4 Wardens</code>.</li>\n<li>\n<p><strong>Third-Party Dependency Risk</strong>: Contracts rely on external data sources, such as <a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/tree/v4.9.2\">@openzeppelin/contracts</a>, and there is a risk that if any <code>issues</code> are found with these <code>dependencies</code> in your contracts, the <code>Livepeer</code> protocol could also be <code>affected</code>.</p>\n<ul>\n<li>We observed that <code>old versions</code> of <code>OpenZeppelin</code> are used in the project, and these should be updated to the <code>latest version</code>:</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"69\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">54</span><span class=\"mtk1\">: </span><span class=\"mtk8\">&quot;@openzeppelin/contracts&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk8\">&quot;^4.9.2&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">55</span><span class=\"mtk1\">: </span><span class=\"mtk8\">&quot;@openzeppelin/contracts-upgradeable&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk8\">&quot;^4.9.2&quot;</span><span class=\"mtk1\">,</span></span></span></code></pre>\n<p>The latest <code>version</code> is <code>4.9.3</code> (as of July 28, 2023), while the project uses version <code>4.9.2</code>.</p>\n</li>\n<li>\n<p><strong>Update Risk</strong>: If the smart contract needs to be updated, there is a risk that updates may be implemented incorrectly or that new versions introduce vulnerabilities. Additionally, updates can lead to divisions within the user community.</p>\n<ul>\n<li>The protocol uses a <code>proxy</code>, and according to the <code>sponsor</code>, the type of <code>proxy</code> is:</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"shell\" data-index=\"70\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\">victorges | livepeer — 09/2/2023 at 11:22</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\">it&#39;s a custom proxy implemented/documented here</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"19\"></span><span class=\"grvsc-source\">https:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"20\"></span><span class=\"grvsc-source\">it&#39;s more similar to a &quot;transparent proxy&quot; pattern than UUPS, with the target contract address being managed by the controller as well</span></span></code></pre>\n<p>If the logic controlling the <code>proxy</code> is not implemented correctly, there could be <code>vulnerabilities</code> that allow an attacker to modify the underlying contract or the <code>proxy</code> itself in an unintended way.</p>\n</li>\n</ul>\n<p><strong>Centralization Risks:</strong></p>\n<ul>\n<li><strong>Participation Centralization</strong>: If a small group of <code>transcoders</code> or <code>delegators</code> controls a significant portion of <code>assets</code> or <code>participation</code> in the <code>system</code>, this could lead to significant <code>centralization</code>. This could undermine <code>decentralization</code> and <code>system security</code>.</li>\n<li><strong>Decision-Making Centralization</strong>: If a small group of actors has disproportionate control over key decisions, such as <code>system rule changes</code> or <code>reward allocation</code>, this could lead to a <code>centralized system</code> where decisions are made for the benefit of a few rather than the entire <code>community</code>.</li>\n<li><strong>Transcoder Node Centralization</strong>: If a small number of <code>transcoders</code> dominate the active set, this could lead to <code>centralization</code> in the provision of <code>transcoding services</code>, resulting in <code>higher fees</code> or the <code>exclusion</code> of smaller actors.</li>\n</ul>\n<h3 id=\"6--new-insights-and-learning-from-this-audit\" style=\"position:relative;\"><a href=\"#6--new-insights-and-learning-from-this-audit\" aria-label=\"6  new insights and learning from this audit permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>6- New insights and learning from this audit</h3>\n<p>Our latest insights from the <code>Livepeer Onchain Treasury Upgrade</code> protocol audit have been extensive. This audit has deepened our understanding of the <code>Livepeer</code> protocol <code>upgrade</code>, which introduces a community <code>treasury</code> funded by protocol <code>rewards</code>. The <code>upgrade</code> leverages <code>OpenZeppelin</code> governance primitives, underscoring the crucial role of auditing in upholding protocol integrity. It places particular emphasis on critical aspects like <code>reward</code> calculations and <code>highlights</code> security concerns, emphasizing the necessity of safeguarding against potential attacks to ensure ongoing system reliability. This audit has also showcased the protocol’s adaptability, as it can seamlessly adjust its <code>reward</code> system and incorporate a <code>community treasury</code>.</p>\n<h3 id=\"conclusion-1\" style=\"position:relative;\"><a href=\"#conclusion-1\" aria-label=\"conclusion 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h3>\n<p>Overall, the <code>Livepeer Onchain Treasury Upgrade</code> presents an interesting <code>architecture</code> aimed at establishing <code>decentralized</code> infrastructure for <code>video streaming</code> in <code>web3</code> social and media applications. The development team has done a good job with the code. However, as is common in <code>blockchain</code> projects, <code>Livepeer</code> faces risks related to the security of its <code>smart contracts</code> and the <code>centralization</code> of key actors such as <code>transcoders</code> and <code>delegators</code>. Ultimately, the continued success of <code>Livepeer</code> will depend on its ability to address these challenges, especially after potential security issues are disclosed by <code>C4 wardens</code>. This will involve maintaining <code>security</code> and <code>decentralization</code> and remaining an attractive choice for <code>web3 video streaming</code> applications.</p>\n<p><strong>Time Spent</strong></p>\n<p>A total of <code>3 days</code> were dedicated to completing this audit, distributed as follows:</p>\n<ol>\n<li>1st Day: Devoted to comprehending the protocol’s functionalities and implementation.</li>\n<li>2nd Day: Initiated the analysis process, leveraging the documentation offered by the <code>Livepeer Onchain Treasury Upgrade</code>.</li>\n<li>3rd Day: Focused on conducting a thorough analysis, incorporating meticulously crafted diagrams derived from the contracts and information provided by the protocol.</li>\n</ol>\n<h3 id=\"time-spent\" style=\"position:relative;\"><a href=\"#time-spent\" aria-label=\"time spent permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Time spent:</h3>\n<p>15 hours</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-livepeer-findings/issues/243#issuecomment-1721728619\">victorges (Livepeer) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>The detailed designs of the system don’t seem accurate, but the rest of the report and raised issues and suggestions are good.</p>\n</blockquote>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Audits incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Audit submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-2\">High Risk Findings (2)</a></p>\n<ul>\n<li><a href=\"#h-01-underflow-in-updatetranscoderwithfees-can-cause-corrupted-data-and-loss-of-winning-tickets\">[H-01] Underflow in <code>updateTranscoderWithFees</code> can cause corrupted data and loss of winning tickets</a></li>\n<li><a href=\"#h-02-by-delegating-to-a-non-transcoder-a-delegator-can-reduce-the-tally-of-someone-elses-vote-choice-without-first-granting-them-any-voting-power\">[H-02] By delegating to a non-transcoder, a delegator can reduce the tally of someone else’s vote choice without first granting them any voting power</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-3\">Medium Risk Findings (3)</a></p>\n<ul>\n<li><a href=\"#m-01-the-logic-in-_handlevoteoverride-to-determine-if-an-account-is-the-transcoder-is-not-consistent-with-the-logic-in-the-bondmanagersol\">[M-01] The logic in <code>_handleVoteOverride</code> to determine if an account is the transcoder is not consistent with the logic in the <code>BondManager.sol</code></a></li>\n<li><a href=\"#m-02-fully-slashed-transcoder-can-vote-with-0-weight-messing-up-the-voting-calculations\">[M-02] Fully slashed transcoder can vote with 0 weight messing up the voting calculations</a></li>\n<li><a href=\"#m-03-withdrawfees-does-not-update-checkpoint\">[M-03] <code>withdrawFees</code> does not update checkpoint</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#01-there-is-no-way-to-decrease-the-max-number-of-active-transcoders\">01 There is no way to decrease the max number of active transcoders</a></li>\n<li><a href=\"#02-when-removing-transcoders-transcoderactivationround-should-be-set-to-0-for-inactive\">02 When removing transcoders <code>Transcoder.activationRound</code> should be set to 0 for inactive</a></li>\n<li><a href=\"#03-no-function-implemented-for-setmaxearningsclaimsrounds\">03 No function implemented for <code>setMaxEarningsClaimsRounds()</code></a></li>\n<li><a href=\"#04-typos\">04 Typos</a></li>\n<li><a href=\"#05-functions-need-a-more-descriptive-name\">05 Functions need a more descriptive name</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#notes-from-the-auditor\">Notes from the Auditor</a></li>\n<li><a href=\"#g-01-function-processrebond-can-be-more-optimized-save-207-gas-on-average\">G-01 Function <code>processRebond()</code> can be more optimized (Save 207 Gas on average)</a></li>\n<li><a href=\"#g-02-function-withdrawstake-can-be-more-optimized-save-443-gas-on-average\">G-02 Function <code>withdrawStake()</code> can be more optimized (Save 443 Gas on average)</a></li>\n<li><a href=\"#g-03-function-transcoderwithhint-can-be-more-optimized-save-4749-gas-on-average\">G-03 Function <code>transcoderWithHint()</code> can be more optimized (Save 4749 Gas on average)</a></li>\n<li><a href=\"#g-04-function-rewardwithhint-optimization-save-4716-gas-on-average\">G-04 Function <code>rewardWithHint()</code> optimization (Save 4716 Gas on average)</a></li>\n<li><a href=\"#g-05-function-increasetotalstakeuncheckpointed-can-be-more-optimized-save-148-gas-on-average\">G-05 Function <code>increaseTotalStakeUncheckpointed()</code> can be more optimized (save 148 Gas on average)</a></li>\n<li><a href=\"#g-06-refactor-the-function-unbondwithhint-save-1452-gas\">G-06 Refactor the function <code>unbondWithHint()</code> (Save 1452 Gas)</a></li>\n<li><a href=\"#g-07-function-slashtranscoder-can-be-optimized\">G-07 Function <code>slashTranscoder()</code> can be optimized</a></li>\n<li><a href=\"#g-08-bondingvotessol-we-can-optimize-the-function-checkpointbondingstate\">G-08 BondingVotes.sol: We can optimize the function <code>checkpointBondingState</code></a></li>\n<li><a href=\"#g-09-optimizing-check-order-for-cost-efficient-function-execution\">G-09 Optimizing check order for cost efficient function execution</a></li>\n<li><a href=\"#g-10-change-the-model-of-how-events-are-emitted\">G-10 Change the model of how events are emitted</a></li>\n<li><a href=\"#conclusion\">Conclusion</a></li>\n</ul>\n</li>\n<li><a href=\"#audit-analysis\">Audit Analysis</a></li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>"
}