{
  "circa": {
    "title": "PoolTogether",
    "sponsor": "PoolTogether",
    "slug": "2023-07-pooltogether",
    "date": "2023-09-27",
    "findings": "https://github.com/code-423n4/2023-07-pooltogether-findings/issues",
    "contest": 258
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit outlined in this document, C4 conducted an analysis of the PoolTogether smart contract system written in Solidity. The audit took place between July 7 - July 14 2023.</p>\n<p>Following the C4 audit, 3 wardens (<a href=\"https://code4rena.com/@dirk_y\">dirk_y</a>, <a href=\"https://code4rena.com/@rvierdiiev\">rvierdiiev</a> and <a href=\"https://code4rena.com/@0xStalin\">0xStalin</a>) reviewed the mitigations for all identified issues; the mitigation review report is appended below the audit report.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>117 Wardens contributed reports to the PoolTogether:</p>\n<ol>\n<li><a href=\"https://code4rena.com/@dirk_y\">dirk_y</a></li>\n<li><a href=\"https://code4rena.com/@rvierdiiev\">rvierdiiev</a></li>\n<li><a href=\"https://code4rena.com/@0xStalin\">0xStalin</a></li>\n<li><a href=\"https://code4rena.com/@zzzitron\">zzzitron</a></li>\n<li><a href=\"https://code4rena.com/@KupiaSec\">KupiaSec</a></li>\n<li><a href=\"https://code4rena.com/@wangxx2026\">wangxx2026</a></li>\n<li>KIntern_NA (<a href=\"https://code4rena.com/@duc\">duc</a> and <a href=\"https://code4rena.com/@TrungOre\">TrungOre</a>)</li>\n<li><a href=\"https://code4rena.com/@pontifex\">pontifex</a></li>\n<li><a href=\"https://code4rena.com/@bin2chen\">bin2chen</a></li>\n<li><a href=\"https://code4rena.com/@shaka\">shaka</a></li>\n<li><a href=\"https://code4rena.com/@volodya\">volodya</a></li>\n<li><a href=\"https://code4rena.com/@Brenzee\">Brenzee</a></li>\n<li><a href=\"https://code4rena.com/@minhtrng\">minhtrng</a></li>\n<li><a href=\"https://code4rena.com/@yixxas\">yixxas</a></li>\n<li><a href=\"https://code4rena.com/@Aymen0909\">Aymen0909</a></li>\n<li><a href=\"https://code4rena.com/@Nyx\">Nyx</a></li>\n<li><a href=\"https://code4rena.com/@GalloDaSballo\">GalloDaSballo</a></li>\n<li><a href=\"https://code4rena.com/@ktg\">ktg</a></li>\n<li><a href=\"https://code4rena.com/@mahyar\">mahyar</a></li>\n<li>0x3e84fa45 (<a href=\"https://code4rena.com/@0xArcturus\">0xArcturus</a> and <a href=\"https://code4rena.com/@markus_ether\">markus_ether</a>)</li>\n<li><a href=\"https://code4rena.com/@seeques\">seeques</a></li>\n<li><a href=\"https://code4rena.com/@Jeiwan\">Jeiwan</a></li>\n<li><a href=\"https://code4rena.com/@RedTiger\">RedTiger</a></li>\n<li><a href=\"https://code4rena.com/@DadeKuma\">DadeKuma</a></li>\n<li><a href=\"https://code4rena.com/@xuwinnie\">xuwinnie</a></li>\n<li><a href=\"https://code4rena.com/@0xWaitress\">0xWaitress</a></li>\n<li><a href=\"https://code4rena.com/@ni8mare\">ni8mare</a></li>\n<li><a href=\"https://code4rena.com/@markus_ether\">markus_ether</a></li>\n<li><a href=\"https://code4rena.com/@Infect3d\">Infect3d</a></li>\n<li><a href=\"https://code4rena.com/@degensec\">degensec</a></li>\n<li><a href=\"https://code4rena.com/@Udsen\">Udsen</a></li>\n<li><a href=\"https://code4rena.com/@catellatech\">catellatech</a></li>\n<li><a href=\"https://code4rena.com/@josephdara\">josephdara</a></li>\n<li><a href=\"https://code4rena.com/@MiniGlome\">MiniGlome</a></li>\n<li><a href=\"https://code4rena.com/@qpzm\">qpzm</a></li>\n<li><a href=\"https://code4rena.com/@0xbepresent\">0xbepresent</a></li>\n<li><a href=\"https://code4rena.com/@0xkasper\">0xkasper</a></li>\n<li><a href=\"https://code4rena.com/@alymurtazamemon\">alymurtazamemon</a></li>\n<li><a href=\"https://code4rena.com/@Tripathi\">Tripathi</a></li>\n<li><a href=\"https://code4rena.com/@nadin\">nadin</a></li>\n<li><a href=\"https://code4rena.com/@hals\">hals</a></li>\n<li><a href=\"https://code4rena.com/@saneryee\">saneryee</a></li>\n<li><a href=\"https://code4rena.com/@3docSec\">3docSec</a></li>\n<li><a href=\"https://code4rena.com/@c3phas\">c3phas</a></li>\n<li><a href=\"https://code4rena.com/@SAQ\">SAQ</a></li>\n<li><a href=\"https://code4rena.com/@hunter_w3b\">hunter_w3b</a></li>\n<li><a href=\"https://code4rena.com/@petrichor\">petrichor</a></li>\n<li><a href=\"https://code4rena.com/@gzeon\">gzeon</a></li>\n<li><a href=\"https://code4rena.com/@Inspecktor\">Inspecktor</a></li>\n<li><a href=\"https://code4rena.com/@keccak123\">keccak123</a></li>\n<li>GREY-HAWK-REACH (<a href=\"https://code4rena.com/@Kose\">Kose</a>, <a href=\"https://code4rena.com/@aswinraj94\">aswinraj94</a>, <a href=\"https://code4rena.com/@dimulski\">dimulski</a>, <a href=\"https://code4rena.com/@0xprinc\">0xprinc</a>, <a href=\"https://code4rena.com/@aslanbek\">aslanbek</a> and <a href=\"https://code4rena.com/@escrow\">escrow</a>)</li>\n<li><a href=\"https://code4rena.com/@0xMirce\">0xMirce</a></li>\n<li><a href=\"https://code4rena.com/@ptsanev\">ptsanev</a></li>\n<li><a href=\"https://code4rena.com/@Breeje\">Breeje</a></li>\n<li><a href=\"https://code4rena.com/@Co0nan\">Co0nan</a></li>\n<li><a href=\"https://code4rena.com/@ABAIKUNANBAEV\">ABAIKUNANBAEV</a></li>\n<li><a href=\"https://code4rena.com/@squeaky_cactus\">squeaky_cactus</a></li>\n<li><a href=\"https://code4rena.com/@dacian\">dacian</a></li>\n<li><a href=\"https://code4rena.com/@kutugu\">kutugu</a></li>\n<li><a href=\"https://code4rena.com/@0xSmartContract\">0xSmartContract</a></li>\n<li><a href=\"https://code4rena.com/@peanuts\">peanuts</a></li>\n<li><a href=\"https://code4rena.com/@K42\">K42</a></li>\n<li><a href=\"https://code4rena.com/@wvleak\">wvleak</a></li>\n<li><a href=\"https://code4rena.com/@0x11singh99\">0x11singh99</a></li>\n<li><a href=\"https://code4rena.com/@dev0cloo\">dev0cloo</a></li>\n<li><a href=\"https://code4rena.com/@serial-coder\">serial-coder</a></li>\n<li><a href=\"https://code4rena.com/@Praise\">Praise</a></li>\n<li><a href=\"https://code4rena.com/@naman1778\">naman1778</a></li>\n<li><a href=\"https://code4rena.com/@Rolezn\">Rolezn</a></li>\n<li><a href=\"https://code4rena.com/@grearlake\">grearlake</a></li>\n<li><a href=\"https://code4rena.com/@Daniel526\">Daniel526</a></li>\n<li><a href=\"https://code4rena.com/@btk\">btk</a></li>\n<li><a href=\"https://code4rena.com/@0xAnah\">0xAnah</a></li>\n<li><a href=\"https://code4rena.com/@ybansal2403\">ybansal2403</a></li>\n<li><a href=\"https://code4rena.com/@SM3_SS\">SM3_SS</a></li>\n<li><a href=\"https://code4rena.com/@Raihan\">Raihan</a></li>\n<li><a href=\"https://code4rena.com/@ReyAdmirado\">ReyAdmirado</a></li>\n<li><a href=\"https://code4rena.com/@Rageur\">Rageur</a></li>\n<li><a href=\"https://code4rena.com/@SAAJ\">SAAJ</a></li>\n<li><a href=\"https://code4rena.com/@0xn006e7\">0xn006e7</a></li>\n<li><a href=\"https://code4rena.com/@LeoS\">LeoS</a></li>\n<li><a href=\"https://code4rena.com/@koxuan\">koxuan</a></li>\n<li><a href=\"https://code4rena.com/@jaraxxus\">jaraxxus</a></li>\n<li><a href=\"https://code4rena.com/@oxchsyston\">oxchsyston</a></li>\n<li><a href=\"https://code4rena.com/@neumo\">neumo</a></li>\n<li><a href=\"https://code4rena.com/@0xPsuedoPandit\">0xPsuedoPandit</a></li>\n<li><a href=\"https://code4rena.com/@namx05\">namx05</a></li>\n<li><a href=\"https://code4rena.com/@Jorgect\">Jorgect</a></li>\n<li><a href=\"https://code4rena.com/@YY\">YY</a></li>\n<li><a href=\"https://code4rena.com/@Darwin\">Darwin</a></li>\n<li><a href=\"https://code4rena.com/@lanrebayode77\">lanrebayode77</a></li>\n<li><a href=\"https://code4rena.com/@alexzoid\">alexzoid</a></li>\n<li><a href=\"https://code4rena.com/@Kaysoft\">Kaysoft</a></li>\n<li><a href=\"https://code4rena.com/@banpaleo5\">banpaleo5</a></li>\n<li><a href=\"https://code4rena.com/@MohammedRizwan\">MohammedRizwan</a></li>\n<li><a href=\"https://code4rena.com/@Bauchibred\">Bauchibred</a></li>\n<li><a href=\"https://code4rena.com/@erebus\">erebus</a></li>\n<li><a href=\"https://code4rena.com/@Vagner\">Vagner</a></li>\n<li><a href=\"https://code4rena.com/@joaovwfreire\">joaovwfreire</a></li>\n<li><a href=\"https://code4rena.com/@ayden\">ayden</a></li>\n<li><a href=\"https://code4rena.com/@ArmedGoose\">ArmedGoose</a></li>\n<li><a href=\"https://code4rena.com/@fatherOfBlocks\">fatherOfBlocks</a></li>\n<li><a href=\"https://code4rena.com/@eyexploit\">eyexploit</a></li>\n<li><a href=\"https://code4rena.com/@teawaterwire\">teawaterwire</a></li>\n<li><a href=\"https://code4rena.com/@alexweb3\">alexweb3</a></li>\n<li><a href=\"https://code4rena.com/@LuchoLeonel1\">LuchoLeonel1</a></li>\n<li><a href=\"https://code4rena.com/@Bobface\">Bobface</a></li>\n<li><a href=\"https://code4rena.com/@mahdirostami\">mahdirostami</a></li>\n<li><a href=\"https://code4rena.com/@John\">John</a></li>\n<li><a href=\"https://code4rena.com/@ravikiranweb3\">ravikiranweb3</a></li>\n</ol>\n<p>This audit was judged by <a href=\"https://twitter.com/thePicodes\">Picodes</a>.</p>\n<p>Final report assembled by thebrittfactor.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 36 unique vulnerabilities. Of these vulnerabilities, 9 received a risk rating in the category of HIGH severity and 27 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 37 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 19 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2023-07-pooltogether\">C4 PoolTogether repository</a>, and is composed of 14 smart contracts written in the Solidity programming language and includes 3324 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities based on three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>For more information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>, specifically our section on <a href=\"https://docs.code4rena.com/awarding/judging-criteria/severity-categorization\">Severity Categorization</a>.</p>\n<h1 id=\"high-risk-findings-9\" style=\"position:relative;\"><a href=\"#high-risk-findings-9\" aria-label=\"high risk findings 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (9)</h1>\n<h2 id=\"h-01-the-_currentexchangerate-of-the-vault-contract-cant-increase-and-will-always-be-lower-than-or-equal-to-_assetunit\" style=\"position:relative;\"><a href=\"#h-01-the-_currentexchangerate-of-the-vault-contract-cant-increase-and-will-always-be-lower-than-or-equal-to-_assetunit\" aria-label=\"h 01 the _currentexchangerate of the vault contract cant increase and will always be lower than or equal to _assetunit permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/443\">[H-01] The <code>_currentExchangeRate</code> of the Vault contract can’t increase and will always be lower than or equal to <code>_assetUnit</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/443\">KIntern_NA</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/382\">KupiaSec</a></em></p>\n<p>The <code>_currentExchangeRate</code> of the Vault contract can not increase and will always be lower than or equal to <code>_assetUnit</code>. Therefore, when the vault is under-collateralized (<code>_currentExchangeRate</code> &#x3C; <code>_assetUnit</code>), it can’t be further collateralized.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of concept</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_currentExchangeRate</span><span class=\"mtk1\">() </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_totalSupplyAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_totalSupply</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_totalSupplyToAssets</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_convertToAssets</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_totalSupplyAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_lastRecordedExchangeRate</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Rounding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Down</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_yieldVault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">maxWithdraw</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">_totalSupplyToAssets</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> - (</span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">_totalSupplyToAssets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_totalSupplyAmount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulDiv</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_assetUnit</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_totalSupplyAmount</span><span class=\"mtk1\">, </span><span class=\"mtk10\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Rounding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Down</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_assetUnit</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>The <code>_totalSupplyAmount != 0 &#x26;&#x26; _withdrawableAssets != 0</code>, <code>_currentExchangeRate</code> function will return a value <code>_withdrawableAssets * _assetUnit / _totalSupplyAmount</code>. However, <code>_withdrawableAssets</code> can not exceed <code>_totalSupplyToAssets</code>, which is equal to <code>_totalSupplyAmount * _lastRecordedExchangeRate / _assetUnit</code>. Therefore, <code>_currentExchangeRate</code> will always be lower than or equal to <code>_lastRecordedExchangeRate</code>.</p>\n<p>Add this assert line and run <code>forge test</code>; all tests will pass.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_totalSupplyAmount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">assert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulDiv</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_assetUnit</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_totalSupplyAmount</span><span class=\"mtk1\">, </span><span class=\"mtk10\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Rounding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Down</span><span class=\"mtk1\">) &lt;= </span><span class=\"mtk12\">_assetUnit</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulDiv</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_assetUnit</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_totalSupplyAmount</span><span class=\"mtk1\">, </span><span class=\"mtk10\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Rounding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Down</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Remove the lines of code that limit the <code>_withdrawableAssets</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">_totalSupplyToAssets</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> - (</span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">_totalSupplyToAssets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"assessed-type\" style=\"position:relative;\"><a href=\"#assessed-type\" aria-label=\"assessed type permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Context</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/443#issuecomment-1644770423\">asselstine (PoolTogether) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Hmm, I’m not sure about this one.  Will mark as confirmed and figure it out later.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/443#issuecomment-1656755616\">Picodes (judge) commented</a>:</strong></p>\n<blockquote>\n<p>@asselstine - did you figure it out?</p>\n<p>It seems to me that because of <code>if (_withdrawableAssets > _convertToAssets(_totalSupplyAmount, _lastRecordedExchangeRate, Math.Rounding.Down))</code>, the rate indeed can’t increase; which is a huge issue in case of a momentary undercollateralization. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/443#issuecomment-1670129973\">PierrickGT (PoolTogether) commented</a>:</strong></p>\n<blockquote>\n<p>@Picodes - Indeed, the exchange rate should not be greater than 1 because users should not be able to claim the yield that has accrued in the <code>YieldVault</code>.</p>\n<p>That’s why we have the following condition:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if (_withdrawableAssets &gt; _totalSupplyToAssets) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  _withdrawableAssets = _withdrawableAssets - (_withdrawableAssets - _totalSupplyToAssets);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>We subtract the yield from the total amount, with the yield being the difference between <code>_withdrawableAssets</code> and <code>_totalSupplyToAssets</code>.</p>\n<p>If the <code>YieldVault</code> becomes under-collateralized, users won’t be able to deposit anymore, but will be able to withdraw their share of the deposit. Any yield that as accrued and has not been claimed yet will be shared proportionally amongst users. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/443#issuecomment-1672327882\">PierrickGT (PoolTogether) commented</a>:</strong></p>\n<blockquote>\n<p>The code has been improved and clarified in the following PR: <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/13\">https://github.com/GenerationSoftware/pt-v5-vault/pull/13</a>.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/443#issuecomment-1676011920\">Picodes (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Keeping high severity here because of the issue in case of temporary undercollateralization.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs\">PoolTogether mitigated</a>:</strong></p>\n<blockquote>\n<p>The issue turned out not to be the case; the exchange rate is always <code>&#x3C;=</code> 1 (yield is liquidated). However, comments were added to clarify the behaviour.<br>\nPR: <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/13\">https://github.com/GenerationSoftware/pt-v5-vault/pull/13</a></p>\n</blockquote>\n<p><strong>Status</strong>: Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/37\">0xStalin</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/86\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/27\">rvierdiiev</a>.</p>\n<hr>\n<h2 id=\"h-02-a-malicious-user-can-steal-other-users-deposits-from-vaultsol\" style=\"position:relative;\"><a href=\"#h-02-a-malicious-user-can-steal-other-users-deposits-from-vaultsol\" aria-label=\"h 02 a malicious user can steal other users deposits from vaultsol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/439\">[H-02] A malicious user can steal other user’s deposits from Vault.sol</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/439\">zzzitron</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/480\">pontifex</a></em></p>\n<h3 id=\"lines-of-code\" style=\"position:relative;\"><a href=\"#lines-of-code\" aria-label=\"lines of code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lines of code</h3>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L509-L521\">https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L509-L521</a>\n<a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L407-L415\">https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L407-L415</a></p>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>When the <code>Vault.withdraw()</code> function is called, a maximum of <code>type(uint96).max</code> shares are burnt subsequently: <code>Vault.withdraw()</code>-> <code>Vault._withdraw()</code>-> <code>Vault._burn</code> burns <code>uint96(_shares)</code>, see <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L1138-L1139\">Vault.sol line 1139</a>.</p>\n<p>A malicious user can exploit this in the following way:</p>\n<ol>\n<li>A malicious user deposits, for example, two times the value of <code>type(uint96).max</code> underlying assets into the Vault; calling the function <code>Vault.deposit()</code> two times. They can’t deposit more in a single transaction because <code>type(uint96).max</code> is the maximum value to deposit.</li>\n<li>Then, the malicious user calls <code>Vault.withdraw()</code> with a higher value of assets to withdraw more than <code>type(uint96).max</code>. For example, they withdraw (<code>2 * type(uint96).max</code>), which is the total amount of assets they deposited before.</li>\n<li>Now what happens, is the Vault.sol contract only burns <code>type(uint96).max</code> shares for the user, but transfers <code>2 * type(uint96).max</code> underlying assets to the malicious user, which is the total amount they deposited before.</li>\n<li>This happens because <code>Vault._burn()</code> only burns <code>uint96(shares)</code> shares of the malicious users - see Vault.sol line 1155.</li>\n<li>Now, the malicious user has still vault shares left but they withdrew the total amount of their deposited assets.</li>\n<li>Now, the vault transferred the total amount of the malicious user’s assets back to them and the malicious user still has shares left to withdraw; with even more assets that are now being stolen from assets deposited by other users.</li>\n<li>Or, if the malicious user was the first depositor, they wait until another user deposits and the malicious user can now withdraw the other users deposited assets since the malicious user still has Vault shares left.</li>\n<li>Or, if the malicious user is not the first depositor, they use a <code>flashLoan</code> or <code>flashMint</code> to deposit multiple times <code>type(uint96).max</code> assets into the vault. Then, they can withdraw their deposit, pay back the <code>flashLoan</code> or <code>flashMint</code> and they will still have enough vault shares left to steal all other users assets by withdrawing them.</li>\n</ol>\n<p>In this way, other user’s deposited assets can be stolen, as explained above.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Here is a POC, where the problem is illustrated:</p>\n<p><a href=\"https://gist.github.com/zzzitron/397790302ca95aa3fbf05694ae1497ab\">https://gist.github.com/zzzitron/397790302ca95aa3fbf05694ae1497ab</a></p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider adjusting the <code>Vault._burn</code> function to not convert from <code>uint256</code> to <code>uint96</code> when burning shares.</p>\n<h3 id=\"assessed-type-1\" style=\"position:relative;\"><a href=\"#assessed-type-1\" aria-label=\"assessed type 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Math</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/439#issuecomment-1644753948\">asselstine (PoolTogether) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs\">PoolTogether mitigated</a>:</strong></p>\n<blockquote>\n<p>Added SafeCast<br>\nPR: <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/9\">https://github.com/GenerationSoftware/pt-v5-vault/pull/9</a></p>\n</blockquote>\n<p><strong>Status</strong>: Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/3\">dirk_y</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/28\">rvierdiiev</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/25\">0xStalin</a>.</p>\n<hr>\n<h2 id=\"h-03-_amountout-is-representing-assets-and-shares-at-the-same-time-in-the-liquidate-function\" style=\"position:relative;\"><a href=\"#h-03-_amountout-is-representing-assets-and-shares-at-the-same-time-in-the-liquidate-function\" aria-label=\"h 03 _amountout is representing assets and shares at the same time in the liquidate function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/427\">[H-03] <code>_amountOut</code> is representing assets and shares at the same time in the <code>liquidate</code> function</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/427\">Aymen0909</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/387\">KupiaSec</a>, wangxx2026 (<a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/154\">1</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/128\">2</a>), and <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/5\">0xWaitress</a></em></p>\n<p>In the <code>liquidate</code> function from the <code>Vault</code> contract, the input argument <code>_amountOut</code> is used as if it was representing a value of asset amounts and share amounts at the same time; which is impossible as there is a conversion rate between them. This error will make the <code>liquidate</code> function behave in an expected manner, not the one that was intended.</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The issue is occurring in the <code>liquidate</code> function below:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">liquidate</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_account</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_tokenIn</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amountIn</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_tokenOut</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amountOut</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_requireVaultCollateralized</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_liquidationPair</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LiquidationCallerNotLP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_liquidationPair</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_tokenIn</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_prizePool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prizeToken</span><span class=\"mtk1\">()))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LiquidationTokenInNotPrizeToken</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenIn</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_prizePool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prizeToken</span><span class=\"mtk1\">()));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_tokenOut</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LiquidationTokenOutNotVaultShare</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenOut</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_amountOut</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LiquidationAmountOutZero</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_liquidableYield</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_liquidatableBalanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenOut</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// @audit _amountOut compared with _liquidableYield which represents an asset amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// @audit _amountOut is considered as an asset amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_amountOut</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">_liquidableYield</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LiquidationAmountOutGTYield</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amountOut</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_liquidableYield</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_prizePool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">contributePrizeTokens</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_amountIn</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_yieldFeePercentage</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// @audit _amountOut used to increase fee shares so considered as representing a share amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_increaseYieldFeeBalance</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            (</span><span class=\"mtk12\">_amountOut</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">FEE_PRECISION</span><span class=\"mtk1\">) / (</span><span class=\"mtk12\">FEE_PRECISION</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">_yieldFeePercentage</span><span class=\"mtk1\">) - </span><span class=\"mtk12\">_amountOut</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_vaultAssets</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk11\">asset</span><span class=\"mtk1\">()).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// @audit _amountOut compared with _vaultAssets which represents an asset amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// @audit _amountOut is considered as an asset amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_vaultAssets</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_amountOut</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">_vaultAssets</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_yieldVault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_vaultAssets</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// @audit _amountOut representing a share amount minted to the _account</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amountOut</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>As you can see from the code above, the value of the argument <code>_amountOut</code> is used multiple times in the function logic and each time is representing either an asset amount or a share amount; which is impossible as there is a conversion formula used to transform the asset amount into the share amount (and inversely) with the function <code>_convertToShares</code> (or <code>_convertToAssets</code>).</p>\n<p>From the function comments, I couldn’t figure out what the value of <code>_amountOut</code> actually represents, but because there is also another argument given to the <code>liquidate</code> function, which is <code>_tokenOut == address(this)</code>, I’m supposing that <code>_amountOut</code> is representing as a share amount; which will mean that all the instances highlighted in the code above, when <code>_amountOut</code> is considered as an asset amount, are wrong.</p>\n<h3 id=\"instance-1\" style=\"position:relative;\"><a href=\"#instance-1\" aria-label=\"instance 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Instance 1:</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// @audit _amountOut compared with _liquidableYield which represents an asset amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_amountOut</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">_liquidableYield</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LiquidationAmountOutGTYield</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amountOut</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_liquidableYield</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h3 id=\"instance-2\" style=\"position:relative;\"><a href=\"#instance-2\" aria-label=\"instance 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Instance 2:</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// @audit _amountOut compared with _vaultAssets which represents an asset amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_vaultAssets</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_amountOut</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">_vaultAssets</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">_yieldVault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_vaultAssets</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>And before comparing <code>_amountOut</code> to the asset amount values of <code>_vaultAssets</code> and <code>_liquidableYield</code>, it’s value should be converted to an asset amount with the function <code>_convertToAssets</code>.</p>\n<p>This issue will cause problems for the protocol working, as the <code>liquidate</code> function logic will not behave as expected, because it’s comparing values that represent different things.</p>\n<p>Note: If <code>_amountOut</code> is actually representing an asset amount (not a share amount as I supposed), the issue is still valid because <code>_amountOut</code> is also used as being a share amount inside the <code>liquidate</code> function. In that case, it should first be converted to a share amount with <code>_convertToShares</code> in order to get the correct behavior of the <code>liquidate</code> function.</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>To solve this issue, I recommend to first convert the value of <code>_amountOut</code> in the <code>liquidate</code> function to an asset amount and store it in a local variable, <code>_amountOutToAsset</code>. In the function logic, use the correct variable, either <code>_amountOut</code> or <code>_amountOutToAsset</code>, when interacting with a share amount or an asset amount.</p>\n<h3 id=\"assessed-type-2\" style=\"position:relative;\"><a href=\"#assessed-type-2\" aria-label=\"assessed type 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Error</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/427#issuecomment-1644739170\">asselstine (PoolTogether) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs\">PoolTogether mitigated</a>:</strong></p>\n<blockquote>\n<p>Fixed conversion and naming of field.<br>\nPR: <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/6\">https://github.com/GenerationSoftware/pt-v5-vault/pull/6</a></p>\n</blockquote>\n<p><strong>Status</strong>: Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/4\">dirk_y</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/29\">rvierdiiev</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/36\">0xStalin</a>.</p>\n<hr>\n<h2 id=\"h-04-vaultmintyieldfee-function-can-be-called-by-anyone-to-mint-vault-shares-to-any-recipient-address\" style=\"position:relative;\"><a href=\"#h-04-vaultmintyieldfee-function-can-be-called-by-anyone-to-mint-vault-shares-to-any-recipient-address\" aria-label=\"h 04 vaultmintyieldfee function can be called by anyone to mint vault shares to any recipient address permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/396\">[H-04] <code>Vault.mintYieldFee</code> function can be called by anyone to mint <code>Vault Shares</code> to any recipient address</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/396\">Udsen</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/454\">minhtrng</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/406\">markus_ether</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/403\">GREY-HAWK-REACH</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/389\">KupiaSec</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/370\">serial-coder</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/366\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/365\">peanuts</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/335\">teawaterwire</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/329\">ni8mare</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/327\">alexweb3</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/316\">josephdara</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/308\">zzzitron</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/290\">Jeiwan</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/245\">Nyx</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/236\">keccak123</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/223\">LuchoLeonel1</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/203\">btk</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/199\">seeques</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/196\">0xPsuedoPandit</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/194\">0xMirce</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/189\">RedTiger</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/165\">Praise</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/142\">bin2chen</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/135\">ktg</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/121\">Bobface</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/120\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/111\">wangxx2026</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/100\">0xbepresent</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/94\">dirk_y</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/92\">ptsanev</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/88\">shaka</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/77\">dacian</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/49\">mahdirostami</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/35\">John</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/27\">0xStalin</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/21\">ravikiranweb3</a>, and <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/11\">Co0nan</a></em></p>\n<p>The <code>Vault.mintYieldFee</code> external function is used to mint <code>Vault shares</code> to the yield fee <code>_recipient</code>. The function is an external function and can be called by anyone since there is no access control. The function will revert only under following two conditions:</p>\n<ol>\n<li>If the Vault is under-collateralized.</li>\n<li>If the <code>_shares</code> are greater than the accrued <code>_yieldFeeTotalSupply</code>.</li>\n</ol>\n<p>The issue with this function is, it allows the caller to set the <code>_recipient</code> (address of the yield fee recipient). It does not use the <code>_yieldFeeRecipient</code> state variable, which was set in the <code>Vault.constructor</code> as the <code>yield fee recipient</code>. </p>\n<p>Which means, anyone can steal the available <code>yield fee</code> from the vault (as long as the above two revert conditions are not satisfied) by <code>minting shares</code> to their own address or to any address of their choice.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mintYieldFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_requireVaultCollateralized</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_shares</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">_yieldFeeTotalSupply</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">YieldFeeGTAvailable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_yieldFeeTotalSupply</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_yieldFeeTotalSupply</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">MintYieldFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L394-L402\">https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L394-L402</a></p>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VSCode</p>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Hence, it is recommended to use the <code>_yieldFeeRecipient</code> state variable value as the <code>yield fee recipient</code> inside the <code>Vault.mintYieldFee</code> external function and to remove the input parameter <code>address _recipient</code> from the <code>Vault.mintYieldFee</code> function; so that the caller will not be able to mint shares to any arbitrary address of their choice and steal the yield fee of the protocol.</p>\n<p>The updated function should be as follows:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mintYieldFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_requireVaultCollateralized</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_shares</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">_yieldFeeTotalSupply</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">YieldFeeGTAvailable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_yieldFeeTotalSupply</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_yieldFeeTotalSupply</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_yieldFeeRecipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">MintYieldFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  } </span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/396#issuecomment-1644711562\">asselstine (PoolTogether) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs\">PoolTogether mitigated</a>:</strong></p>\n<blockquote>\n<p>Removed recipient param.<br>\nPR: <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/7\">https://github.com/GenerationSoftware/pt-v5-vault/pull/7</a></p>\n</blockquote>\n<p><strong>Status</strong>: Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/30\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/5\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/26\">0xStalin</a>.</p>\n<hr>\n<h2 id=\"h-05-delegated-amounts-can-be-forcefully-removed-from-anyone-in-the-twabcontroller\" style=\"position:relative;\"><a href=\"#h-05-delegated-amounts-can-be-forcefully-removed-from-anyone-in-the-twabcontroller\" aria-label=\"h 05 delegated amounts can be forcefully removed from anyone in the twabcontroller permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/351\">[H-05] Delegated amounts can be forcefully removed from anyone in the <code>TwabController</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/351\">0xkasper</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/461\">minhtrng</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/408\">qpzm</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/393\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/292\">Jeiwan</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/263\">GREY-HAWK-REACH</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/241\">0xStalin</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/204\">0xbepresent</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/63\">3docSec</a>, and <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/13\">Co0nan</a></em></p>\n<p>The <code>sponsor</code> function in the <code>Vault.sol</code> contract allows anyone to remove another user’s delegation by forcing them to delegate to the sponsor address. <code>_sponsor</code> will deposit some amount from the caller for the target user and then force a delegation to the sponsor address (<code>address(1)</code>).</p>\n<p>However, this amount can just be 0 and so it becomes a function to simply force a removal of a delegation. The full delegated power gets removed, because delegations to the sponsor address are not tracked.</p>\n<p>As such, it becomes possible to call the <code>sponsor</code> function for every user and make the total delegated power supply in the <code>TwabController</code> equal to 0. The attacker can then be the only one with some delegated amount that is equal to 100% of the total supply, manipulating the process of the lottery.</p>\n<p>Rectifying the delegation requires manual interaction from the user and the exploit can be repeated anytime and continuously, further manipulating the values in the <code>TwabController</code>.</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function testPoCDelegateRemoval() public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address SPONSORSHIP_ADDRESS = address(1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint96 BALANCE = 100_000_000 ether;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    token.approve(address(vault), BALANCE);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vault.deposit(BALANCE, address(this));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    assertEq(address(this), twab_controller.delegateOf(address(vault), address(this)));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    assertEq(BALANCE, twab_controller.delegateBalanceOf(address(vault), address(this)));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // As attacker, call sponsor with 0 amount and victim address</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.prank(address(0xdeadbeef));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vault.sponsor(0, address(this));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Delegated balance is now gone</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    assertEq(SPONSORSHIP_ADDRESS, twab_controller.delegateOf(address(vault), address(this)));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    assertEq(0, twab_controller.delegateBalanceOf(address(vault), address(this)));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    assertEq(0, twab_controller.delegateBalanceOf(address(vault), SPONSORSHIP_ADDRESS));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<h3 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VSCode, Foundry.</p>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The <code>sponsor</code> function should only accept deposits if the receiver has already delegated to the sponsorship address. Otherwise, the deposit is accepted, but the delegation should not be forced.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/393#issuecomment-1644710906\">asselstine (PoolTogether) confirmed via duplicate issue #393</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/393#issuecomment-1677993136\">PierrickGT (PoolTogether) commented via duplicate issue #393</a>:</strong></p>\n<blockquote>\n<p>I’ve removed the <code>receiver</code> param in the following PR: <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/19\">https://github.com/GenerationSoftware/pt-v5-vault/pull/19</a>. </p>\n<p>This way, only the <code>msg.sender</code> can sponsor the Vault by depositing into it and delegating to the sponsorship address, if it is not already the case. If the user wants to deposit on behalf of another user, they can still use the <code>deposit</code> function. Funds will then be delegated to any address set by the <code>receiver</code>.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs\">PoolTogether mitigated</a>:</strong></p>\n<blockquote>\n<p>Removed recipient param.<br>\nPR: <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/19\">https://github.com/GenerationSoftware/pt-v5-vault/pull/19</a></p>\n</blockquote>\n<p><strong>Status</strong>: Mitigation error. Full details in report from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/31\">rvierdiiev</a>, and in the <a href=\"#mitigation-review\">Mitigation Review</a> section below.</p>\n<hr>\n<h2 id=\"h-06-resetting-delegation-will-result-in-user-funds-being-lost-forever\" style=\"position:relative;\"><a href=\"#h-06-resetting-delegation-will-result-in-user-funds-being-lost-forever\" aria-label=\"h 06 resetting delegation will result in user funds being lost forever permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/206\">[H-06] Resetting delegation will result in user funds being lost forever</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/206\">dirk_y</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/386\">KupiaSec</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/293\">Jeiwan</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/192\">0xkasper</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/152\">0xbepresent</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/144\">bin2chen</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/141\">rvierdiiev</a>, and <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/104\">xuwinnie</a></em></p>\n<h3 id=\"lines-of-code-1\" style=\"position:relative;\"><a href=\"#lines-of-code-1\" aria-label=\"lines of code 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lines of code</h3>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-twab-controller/blob/0145eeac23301ee5338c659422dd6d69234f5d50/src/TwabController.sol#L596-L599\">https://github.com/GenerationSoftware/pt-v5-twab-controller/blob/0145eeac23301ee5338c659422dd6d69234f5d50/src/TwabController.sol#L596-L599</a>\n<a href=\"https://github.com/GenerationSoftware/pt-v5-twab-controller/blob/0145eeac23301ee5338c659422dd6d69234f5d50/src/TwabController.sol#L648-L664\">https://github.com/GenerationSoftware/pt-v5-twab-controller/blob/0145eeac23301ee5338c659422dd6d69234f5d50/src/TwabController.sol#L648-L664</a></p>\n<h3 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>The default delegate value for a user is <code>address(0)</code>, which maps to the user delegating to themselves. If a user had delegated to another address and wanted to reset their delegated balance back to themselves, they would lose all of their funds contributed to the vault.</p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>As mentioned above, the default behaviour for a user is that they delegate their balance to themselves, where the actual default value in storage is the <code>0 address</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function _delegateOf(address _vault, address _user) internal view returns (address) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address _userDelegate;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (_user != address(0)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _userDelegate = delegates[_vault][_user];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // If the user has not delegated, then the user is the delegate</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      if (_userDelegate == address(0)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _userDelegate = _user;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    return _userDelegate;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p>When a user wants to delegate their balance, they call <code>delegate</code> in <code>TwabController.sol</code> and specify which vault they want to delegate the balance of and to which address they want to delegate to. This calls <code>_delegate</code> under the hood:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function _delegate(address _vault, address _from, address _to) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address _currentDelegate = _delegateOf(_vault, _from);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (_to == _currentDelegate) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      revert SameDelegateAlreadySet(_to);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    delegates[_vault][_from] = _to;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _transferDelegateBalance(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _vault,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _currentDelegate,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _to,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      uint96(userObservations[_vault][_from].details.balance)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    emit Delegated(_vault, _from, _to);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p>If a user wanted to reset the delegation to themselves, they would specify <code>_to</code> as <code>address(0)</code>. However, the issue with this is that the underlying <code>_transferDelegateBalance</code> call will mistakenly move the delegated user funds to the <code>0 address</code>.</p>\n<p>At this point, the user might try to call <code>delegate</code> again with their actual address; however, now the <code>(_to == _currentDelegate)</code> check will be true and revert because of the behaviour specified earlier. The user also can’t delegate to any other address because they don’t own their own delegate balance anymore. Their funds are officially lost forever.</p>\n<p>Below is a change to the existing test suite that can be executed with <code>forge test -vvv --match-path test/unit/Vault/Withdraw.t.sol</code> to demonstrate this issue:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">diff --git a/test/unit/Vault/Withdraw.t.sol b/test/unit/Vault/Withdraw.t.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">index 6a15a59..3cec9e3 100644</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--- a/test/unit/Vault/Withdraw.t.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+++ b/test/unit/Vault/Withdraw.t.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">@@ -47,6 +47,36 @@ contract VaultWithdrawTest is UnitBaseSetup {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     vm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+  function testFundsLostForever() external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    vm.startPrank(alice);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    uint256 _amount = 1000e18;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    underlyingAsset.mint(alice, _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    // Alice deposits as usual</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    _deposit(underlyingAsset, vault, _amount, alice);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    // Alice decides she wants to delegate to bob</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    twabController.delegate(address(vault), bob);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    // Alice now tries to reset her delegation</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    twabController.delegate(address(vault), address(0));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    // At this point the funds are lost!! Alice tries to recover her funds in any way...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    // Alice tries to delegate back to herself but can&#39;t</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    vm.expectRevert();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    twabController.delegate(address(vault), alice);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    // Alice also can&#39;t delegate to any other address</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    vm.expectRevert();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    twabController.delegate(address(vault), bob);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    // Alice can&#39;t withdraw because her funds have been lost forever :(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    // Expecting a revert with &quot;DelegateBalanceLTAmount(0, 1000000000000000000000)&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    vault.withdraw(vault.maxWithdraw(alice), alice, alice);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    vm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+  }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   function testWithdrawMoreThanMax() external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     vm.startPrank(alice);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> </span></span></code></pre>\n<h3 id=\"tools-used-2\" style=\"position:relative;\"><a href=\"#tools-used-2\" aria-label=\"tools used 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Foundry</p>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The simplest way to fix this issue is to prevent delegating back to the <code>0 address</code>. If a user delegates away from the default, then they can delegate back to themselves by specifying their own address:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">diff --git a/src/TwabController.sol b/src/TwabController.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">index a7e2d51..ae7b9ea 100644</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--- a/src/TwabController.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+++ b/src/TwabController.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">@@ -646,6 +646,7 @@ contract TwabController {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    * @param _to the address to delegate to</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   function _delegate(address _vault, address _from, address _to) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    require(_to != address(0), &quot;Cannot delegate back to 0 address&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     address _currentDelegate = _delegateOf(_vault, _from);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     if (_to == _currentDelegate) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">       revert SameDelegateAlreadySet(_to);</span></span></code></pre>\n<h3 id=\"assessed-type-3\" style=\"position:relative;\"><a href=\"#assessed-type-3\" aria-label=\"assessed type 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Invalid Validation</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/293#issuecomment-1644540389\">asselstine (PoolTogether) confirmed via duplicate issue #293</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/293#issuecomment-1666956243\">Picodes (judge) commented via duplicate issue #293</a>:</strong></p>\n<blockquote>\n<p>High severity seems justified because of the lines <code>if (_userDelegate == address(0)) { _userDelegate = _user;}</code>. It seems likely that some users are tricked into thinking that delegating back to the <code>0 address</code> will cancel their delegation.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs\">PoolTogether mitigated</a>:</strong></p>\n<blockquote>\n<p>Added check for zero address.<br>\nPR: <a href=\"https://github.com/GenerationSoftware/pt-v5-twab-controller/pull/7\">https://github.com/GenerationSoftware/pt-v5-twab-controller/pull/7</a></p>\n</blockquote>\n<p><strong>Status</strong>: Mitigation confirmed with comments. Full details in reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/39\">0xStalin</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/9\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/32\">rvierdiiev</a>.</p>\n<hr>\n<h2 id=\"h-07-_requirevaultcollateralized-is-called-at-the-beginning-of-the-functions-mintyieldfee-and-liquidate-\" style=\"position:relative;\"><a href=\"#h-07-_requirevaultcollateralized-is-called-at-the-beginning-of-the-functions-mintyieldfee-and-liquidate-\" aria-label=\"h 07 _requirevaultcollateralized is called at the beginning of the functions mintyieldfee and liquidate  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/190\">[H-07] <code>_requireVaultCollateralized()</code> is called at the beginning of the functions <code>mintYieldFee()</code> and <code>liquidate()</code> </a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/190\">RedTiger</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/307\">zzzitron</a> and <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/70\">wangxx2026</a></em></p>\n<p>The <code>liquidate()</code> and <code>mintYieldFee()</code> functions  could leave the vaults under-collateralized.</p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><code>_requireVaultCollateralized()</code>  is called at the beginning of <code>mintYieldFee()</code> and <code>liquidate()</code>. These two functions change the state and the vault could become under-collateralized at the end of the functions.</p>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L557\">https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L557</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mintYieldFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_requireVaultCollateralized</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_shares</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">_yieldFeeTotalSupply</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">YieldFeeGTAvailable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_yieldFeeTotalSupply</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L395\">https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L395</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mintYieldFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_requireVaultCollateralized</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_shares</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">_yieldFeeTotalSupply</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">YieldFeeGTAvailable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_yieldFeeTotalSupply</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Call <code>_requireVaultCollateralized()</code> at the end of these functions instead of calling it at the beginning.</p>\n<h3 id=\"assessed-type-4\" style=\"position:relative;\"><a href=\"#assessed-type-4\" aria-label=\"assessed type 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Invalid Validation</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/190#issuecomment-1666814461\">Picodes (judge) increased severity to High</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/307#issuecomment-1644572054\">asselstine (PoolTogether) confirmed via duplicate issue #307</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/307#issuecomment-1666814623\">Picodes (judge) commented via duplicate issue #307</a>:</strong></p>\n<blockquote>\n<p>Keeping High severity as this report shows how shares could be minted; although, the vault is in fact under-collateralized leading to a loss of funds for users.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/307#issuecomment-1668405365\">PierrickGT (PoolTogether) commented via duplicate issue #307</a>:</strong></p>\n<blockquote>\n<p>The warden missed the following comment:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">   * @dev - We exclude the amount of yield generated by the YieldVault, so the user can only withdraw their share of deposits.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  *      Except when the vault is under-collateralized, in this case, any unclaimed yield fee is included in the calculation.</span></span></code></pre>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/a08fe40155aa65aab202c8bda5806dd91eaa1a9a/src/Vault.sol#L1169-L1170\">https://github.com/GenerationSoftware/pt-v5-vault/blob/a08fe40155aa65aab202c8bda5806dd91eaa1a9a/src/Vault.sol#L1169-L1170</a></p>\n<p>If the Vault ends up being under-collateralized, any yield that has not been claimed will be shared proportionally between depositors.\nIf we use <code>_totalShares</code> instead of <code>_totalSupply</code>, we would account for Vault shares that have not been minted yet, since <code>_yieldFeeTotalSupply</code> keeps track of the accrued yield fee, but needs to be minted as Vault shares by calling <code>mintYieldFee</code>: <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/44a6c6b081db5cc5e2acc4757a3c9dbaa6f60943/src/Vault.sol#L395\">https://github.com/GenerationSoftware/pt-v5-vault/blob/44a6c6b081db5cc5e2acc4757a3c9dbaa6f60943/src/Vault.sol#L395</a></p>\n<p>I’ve added the following to test this scenario: <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/44a6c6b081db5cc5e2acc4757a3c9dbaa6f60943/test/unit/Vault/Withdraw.t.sol#L128\">https://github.com/GenerationSoftware/pt-v5-vault/blob/44a6c6b081db5cc5e2acc4757a3c9dbaa6f60943/test/unit/Vault/Withdraw.t.sol#L128</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/307#issuecomment-1675975308\">Picodes (judge) commented via duplicate issue #307</a>:</strong></p>\n<blockquote>\n<p>@PierrickGT - I do agree with you that the mitigation of this report is incorrect. However, my understanding is that there is still an important issue here; because <code>mintYieldFee</code> could be called even when it would lead to an under-collateralized state.</p>\n<p>So we could imagine a scenario where <code>_yieldFeeTotalSupply</code> is 4, assets in the vault are 10, and user shares are 10. Then, a call to <code>mintYieldFee</code> would mint <code>4</code> and would lead to a loss of funds for users, as it’d bring the vault into an under-collateralized state.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/307#issuecomment-1677519461\">PierrickGT (PoolTogether) commented via duplicate issue #307</a>:</strong></p>\n<blockquote>\n<p>@Picodes - Yes, exactly. This issue you are referring to was better explained in <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/435\">this issue</a>.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs\">PoolTogether mitigated</a>:</strong></p>\n<blockquote>\n<p>Fixed check for partial collateralization.<br>\nPR: <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/13\">https://github.com/GenerationSoftware/pt-v5-vault/pull/13</a></p>\n</blockquote>\n<p><strong>Status</strong>: Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/40\">0xStalin</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/87\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/33\">rvierdiiev</a>.</p>\n<hr>\n<h2 id=\"h-08-increasing-reserves-breaks-prizepool-accounting\" style=\"position:relative;\"><a href=\"#h-08-increasing-reserves-breaks-prizepool-accounting\" aria-label=\"h 08 increasing reserves breaks prizepool accounting permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/147\">[H-08] Increasing reserves breaks PrizePool accounting</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/147\">dirk_y</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/299\">Jeiwan</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/220\">0xStalin</a>, and seeques (<a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/200\">1</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/197\">2</a>)</em></p>\n<h3 id=\"lines-of-code-2\" style=\"position:relative;\"><a href=\"#lines-of-code-2\" aria-label=\"lines of code 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lines of code</h3>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L498-L502\">https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L498-L502</a>\n<a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L743-L746\">https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L743-L746</a>\n<a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L312\">https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L312</a></p>\n<h3 id=\"impact-2\" style=\"position:relative;\"><a href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>When anyone calls the <code>increaseReserve</code> method in <code>PrizePool.sol</code> the accounted balance in the prize pool isn’t properly updated. This allows a vault to effectively steal the prize token contribution and this contribution gets distributed during draws; effectively double counting the initial injection into the reserves. The actual prize token balance of the prize pool will be below the accounted balance of the prize pool as time goes on.</p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>As mentioned in the audit README:</p>\n<blockquote>\n<p>“the balance of prize tokens held by the contract must always be equal to the sum of the available tier liquidity and the reserve. When contributing liquidity, the prize pool will temporarily hold a balance greater than the accounted balance, but otherwise the two should match”.</p>\n</blockquote>\n<p>Unfortunately, this is broken when anyone contributes directly to the reserve by calling <code>increaseReserve</code>.</p>\n<p>In the normal audit flow, the reserve is increased when a draw is closed by the draw manager. During calls to <code>closeDraw</code>, the next draw is started with a given number of tiers and the contributions for the round are calculated and split across the tiers and the reserve:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">_nextDraw(_nextNumberOfTiers, uint96(_contributionsForDraw(lastClosedDrawId + 1)));</span></span></code></pre>\n<p>Under the hood, this calls <code>_computeNewDistributions</code> which calculates the amount to increase the reserves, based on the number of reserve shares and the new prize token liquidity being contributed in this round. During this flow, the actual balance of reward tokens held in the prize pool are equal to the accounted balance.</p>\n<p>The break in accounting occurs when calling <code>increaseReserve</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function increaseReserve(uint104 _amount) external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _reserve += _amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    prizeToken.safeTransferFrom(msg.sender, address(this), _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    emit IncreaseReserve(msg.sender, _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p>As you can see, the prize tokens are transferred into the pool and the reserve increased. But the accounted balance is unchanged:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function _accountedBalance() internal view returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    Observation memory obs = DrawAccumulatorLib.newestObservation(totalAccumulator);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    return (obs.available + obs.disbursed) - _totalWithdrawn;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p>Because the accounted balance is unchanged, any vault can now call <code>contributePrizeTokens</code> to effectively steal the funds meant for the reserve:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function contributePrizeTokens(address _prizeVault, uint256 _amount) external returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _deltaBalance = prizeToken.balanceOf(address(this)) - _accountedBalance();</span></span></code></pre>\n<p>This increases the relevant vault accumulator and the total accumulator; thereby, effectively double counting the same prize tokens, since we’ve already increased <code>_reserve</code>.</p>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The accounted balance of the prize pool should be updated when <code>increaseReserve</code> is called. I think the easiest way of achieving this is having a tracker for “reserve injections”:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">diff --git a/src/PrizePool.sol b/src/PrizePool.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">index a42a27e..3c14476 100644</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--- a/src/PrizePool.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+++ b/src/PrizePool.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">@@ -233,6 +233,9 @@ contract PrizePool is TieredLiquidityDistributor {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   /// @notice The total amount of prize tokens that have been claimed for all time.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   uint256 internal _totalWithdrawn;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+  /// @notice The total amount of reserve injections that have been performed for all time.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+  uint256 internal _reserveInjections;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   /// @notice The winner random number for the last closed draw.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   uint256 internal _winningRandomNumber;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">@@ -497,6 +500,7 @@ contract PrizePool is TieredLiquidityDistributor {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   /// @param _amount The amount of tokens to increase the reserve by</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   function increaseReserve(uint104 _amount) external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     _reserve += _amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    _reserveInjections += amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     prizeToken.safeTransferFrom(msg.sender, address(this), _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     emit IncreaseReserve(msg.sender, _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">@@ -742,7 +746,7 @@ contract PrizePool is TieredLiquidityDistributor {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   /// @return The balance of tokens that have been accounted for</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   function _accountedBalance() internal view returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     Observation memory obs = DrawAccumulatorLib.newestObservation(totalAccumulator);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-    return (obs.available + obs.disbursed) - _totalWithdrawn;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    return (obs.available + obs.disbursed) - _totalWithdrawn + _reserveInjections;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   /// @notice Returns the start time of the draw for the next successful closeDraw</span></span></code></pre>\n<h3 id=\"assessed-type-5\" style=\"position:relative;\"><a href=\"#assessed-type-5\" aria-label=\"assessed type 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Math</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/200#issuecomment-1642841989\">asselstine (PoolTogether) confirmed and commented via duplicate issue #200</a>:</strong></p>\n<blockquote>\n<p>Going to add some notes here:</p>\n<p>The issue is that <code>_accountedBalance()</code> computes <code>(obs.available + obs.disbursed) - _totalWithdrawn</code>, which basically means the total contributed liquidity minus the withdrawn liquidity.</p>\n<p>However, when adding liquidity manually, via <code>increaseReserve</code>, it does not increase the contributed liquidity.</p>\n<p>This issue points to back-running as the problem, but that’s not the case. The case is improper accounting, as in <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/147\">this issue</a> that was closed as a duplicate.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs\">PoolTogether mitigated</a>:</strong></p>\n<blockquote>\n<p>Fixed reserve accounting.<br>\nPR: <a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/pull/18\">https://github.com/GenerationSoftware/pt-v5-prize-pool/pull/18</a></p>\n</blockquote>\n<p><strong>Status</strong>: Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/6\">dirk_y</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/34\">rvierdiiev</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/41\">0xStalin</a>.</p>\n<hr>\n<h2 id=\"h-09-vault-is-not-compatible-with-some-erc4626-vaults\" style=\"position:relative;\"><a href=\"#h-09-vault-is-not-compatible-with-some-erc4626-vaults\" aria-label=\"h 09 vault is not compatible with some erc4626 vaults permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/79\">[H-09] <code>Vault</code> is not compatible with some ERC4626 vaults</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/79\">rvierdiiev</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/109\">Brenzee</a></em></p>\n<p>Depositors can lose funds.</p>\n<h3 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Anyone can build <code>Vault</code> with an underlying vault inside, which should earn yields. When a user deposits/withdraws then the <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L411\"><code>_convertToShares</code> function is used</a> to determine amount of shares the user will receive for the provided assets amount. This function <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L868C29-L868C49\">calls <code>_currentExchangeRate</code></a> to find out current rate.</p>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L1168-L1187\">https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L1168-L1187</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_currentExchangeRate</span><span class=\"mtk1\">() </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_totalSupplyAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_totalSupply</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_totalSupplyToAssets</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_convertToAssets</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_totalSupplyAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_lastRecordedExchangeRate</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Rounding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Down</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_yieldVault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">maxWithdraw</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">_totalSupplyToAssets</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> - (</span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">_totalSupplyToAssets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_totalSupplyAmount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulDiv</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_assetUnit</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_totalSupplyAmount</span><span class=\"mtk1\">, </span><span class=\"mtk10\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Rounding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Down</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_assetUnit</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>As you can see, in order to find the current exchange rate, function <code>_yieldVault.maxWithdraw(address(this))</code> is used. In this case, if this value (which is supposed to be a full amount of deposits + yields inside <code>_yieldVault</code>) is less than <code>_totalSupplyAmount</code> (which is the total supply <code>_lastRecordedExchangeRate</code>), then the rate will be decreased. Which means that the vault lost funds and users should receive less when they withdraw. Later, this new <code>_currentExchangeRate</code> <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L1124\">will be stored as <code>_lastRecordedExchangeRate</code></a>.</p>\n<p>Now, when I explained how rate is changed, I can also explain the problem with some ERC4626 vaults.</p>\n<p>There are some ERC4626 vaults as <code>DnGmxSeniorVault</code>, that collect deposited funds and borrow them. When you <a href=\"https://github.com/RageTrade/delta-neutral-gmx-vaults/blob/main/contracts/vaults/DnGmxSeniorVault.sol#L417-L431\">call <code>maxWithdraw</code> for such vaults</a>, if not enough funds are present (due to some borrowing percentages on the vault), then the amount returned can be less than real balance of caller.</p>\n<p>In case a such wrong value is returned, then depositors of the <code>Pool</code> vault will face losses, as their exchange rate will be less than 1. <code>DnGmxSeniorVault</code> will again have enough balance (when the debt is repaid by <code>jn</code> vault), and the exchange rate will be 1.</p>\n<p>Another problem ERC4626 vaults can create are vaults that have a withdraw limit. In that case, if the <code>Pool</code> vault has balance inside the yield vault that is bigger than the borrow limit, depositors will face the same problem, which leads to a loss of funds.</p>\n<h3 id=\"tools-used-3\" style=\"position:relative;\"><a href=\"#tools-used-3\" aria-label=\"tools used 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VsCode</p>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>You need to consider cases where some vaults can’t be used as yield vaults and be aware of vault creators for that.</p>\n<h3 id=\"assessed-type-6\" style=\"position:relative;\"><a href=\"#assessed-type-6\" aria-label=\"assessed type 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Error</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/79#issuecomment-1641108864\">asselstine (PoolTogether) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/79#issuecomment-1681363536\">asselstine (PoolTogether) commented</a>:</strong></p>\n<blockquote>\n<p>This is more of a general warning about the possible incompatibilities of 4626 vaults.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs\">PoolTogether mitigated</a>:</strong></p>\n<blockquote>\n<p>Fixed undercollateralized redemption while providing an exit.<br>\nPR: <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/37\">https://github.com/GenerationSoftware/pt-v5-vault/pull/37</a></p>\n</blockquote>\n<p><strong>Status</strong>: Not fully mitigated. Full details in reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/68\">0xStalin</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/35\">rvierdiiev</a>, and in the <a href=\"#mitigation-review\">Mitigation Review</a> section below.</p>\n<hr>\n<h1 id=\"medium-risk-findings-27\" style=\"position:relative;\"><a href=\"#medium-risk-findings-27\" aria-label=\"medium risk findings 27 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (27)</h1>\n<h2 id=\"m-01-if-the-underlying-asset-is-a-fee-on-transfer-token-it-could-break-the-internal-accounting-of-the-vault\" style=\"position:relative;\"><a href=\"#m-01-if-the-underlying-asset-is-a-fee-on-transfer-token-it-could-break-the-internal-accounting-of-the-vault\" aria-label=\"m 01 if the underlying asset is a fee on transfer token it could break the internal accounting of the vault permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/470\">[M-01] If the underlying asset is a fee on transfer token, it could break the internal accounting of the vault</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/470\">Udsen</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/357\">qpzm</a> and <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/230\">saneryee</a></em></p>\n<p>The <code>Vault._deposit</code> function is used by the users to deposit <code>_assets</code> to the vault and mint vault shares to the <code>recipient</code> address. The amount of <code>_assets</code> are transferred to the <code>Vault</code> as follows:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  SafeERC20.safeTransferFrom(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _asset,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _caller,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address(this),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _assetsDeposit != 0 ? _assetsDeposit : _assets</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  );</span></span></code></pre>\n<p>The <code>Vault.deposit</code> function uses this <code>_assets</code> amount to calculate the number of <code>shares</code> to be minted to the <code>_recipient</code> address.</p>\n<p>The issue here is if the underlying <code>_asset</code> is a fee on transfer token then the actual received amount to the vault will be less than what is referred in the <code>Vault.deposit</code> function <code>_assets</code> input parameter. But the shares to mint is calculated using the entire <code>_assets</code> amount.</p>\n<p>This issue could be further aggravated since the <code>_asset</code> is again <code>deposited</code> to the <code>_yieldVault</code> and when needing to be redeemed, will be <code>withdrawn</code> from the <code>_yieldVault</code> as well. These operations will again charge a fee if the <code>_asset</code> is a fee on transfer token. Hence, the actual <code>_asset</code> amount left for a particular user will be less than the amount they initially transferred in.</p>\n<p>Hence, when the user <code>redeems</code> the minted shares back to the <code>_assets</code>, the contract will not have enough assets to transfer to the <code>redeemer</code>, thus reverting the transaction.</p>\n<h3 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">SafeERC20</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_caller</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_assetsDeposit</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">_assetsDeposit</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">_assets</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      );</span></span></span></code></pre>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L951-L956\">https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L951-L956</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_yieldVault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_assets</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span></code></pre>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L959\">https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L959</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_yieldVault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_assets</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">SafeERC20</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk11\">asset</span><span class=\"mtk1\">()), </span><span class=\"mtk12\">_receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_assets</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L1026-L1027\">https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L1026-L1027</a></p>\n<h3 id=\"tools-used-4\" style=\"position:relative;\"><a href=\"#tools-used-4\" aria-label=\"tools used 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VSCode</p>\n<h3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>It is recommended to compute the <code>_assets</code> amount balance of the contract before and after the <code>safeTransferFrom</code> call to get the difference between the two for the “actually transferred” amount to the <code>Vault</code>. Then, the “actually transferred” amount can be converted to shares and mint the correct amount of shares to the <code>recipient</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balanceBefore</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">SafeERC20</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_caller</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_assetsDeposit</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">_assetsDeposit</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">_assets</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balanceAfter</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">transferredAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">balanceAfter</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">balanceBefore</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/470#issuecomment-1644789820\">asselstine (PoolTogether) confirmed</a></strong></p>\n<hr>\n<h2 id=\"m-02-unintended-or-malicious-use-of-prize-winners-hooks\" style=\"position:relative;\"><a href=\"#m-02-unintended-or-malicious-use-of-prize-winners-hooks\" aria-label=\"m 02 unintended or malicious use of prize winners hooks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/465\">[M-02] Unintended or malicious use of prize winners’ hooks</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/465\">wvleak</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/398\">wvleak</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/373\">serial-coder</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/291\">DadeKuma</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/224\">0xbepresent</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/213\">dirk_y</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/202\">keccak123</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/122\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/90\">shaka</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/78\">3docSec</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/400\">Udsen</a>, and <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/303\">Jeiwan</a></em></p>\n<p>The <code>setHooks</code> function in <code>Vault.sol</code> allows users to set arbitrary hooks, potentially enabling them to make external calls with unintended consequences. This vulnerability could lead to various unexpected behaviors, such as unauthorized side transactions with gas paid unbeknownst to the claimer, reentrant calls, or denial-of-service attacks on claiming transactions.</p>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L653\">Vault.sol#L653</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setHooks</span><span class=\"mtk1\">(</span><span class=\"mtk12\">VaultHooks</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">hooks</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_hooks</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">hooks</span><span class=\"mtk1\">; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">SetHooks</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">hooks</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h3 id=\"proof-of-concept-10\" style=\"position:relative;\"><a href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Consider the following side contract and malicious hook implementation:</p>\n<p><strong>Side Contract:</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// SPDX-License_Identifier: MIT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">17</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;forge-std/console.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">SideContract</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">codex</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">execute</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">codex</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Entered side contract&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong>Malicious Hook:</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// SPDX-License_Identifier: MIT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">17</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">SideContract</span><span class=\"mtk1\"> } </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;./SideContract.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ViciousHook</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">SideContract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sideContract</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">SideContract</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">beforeClaimPrize</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">winner</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tier</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">prizeIndex</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">sideContract</span><span class=\"mtk1\">.</span><span class=\"mtk11\">execute</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong>Modified Test File:</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/test/unit/Vault/Vault.t.sol b/test/unit/Vault/Vault.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index d0d6d30..65caca1 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/test/unit/Vault/Vault.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/test/unit/Vault/Vault.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -4,6 +4,7 @@ pragma solidity 0.8.17;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> import { UnitBaseSetup, LiquidationPair, PrizePool, TwabController, VaultMock, ERC20, IERC20, IERC4626 } from &quot;test/utils/UnitBaseSetup.t.sol&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> import { IVaultHooks, VaultHooks } from &quot;../../../src/interfaces/IVaultHooks.sol&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> import &quot;src/Vault.sol&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+import { ViciousHook } from &quot;./ViciousHook.sol&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> contract VaultTest is UnitBaseSetup {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   /* ============ Events ============ */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -174,6 +175,25 @@ contract VaultTest is UnitBaseSetup {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     vm.stopPrank();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  function testClaimPrize_viciousHook() public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    ViciousHook viciousHook = new ViciousHook();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    vm.startPrank(alice);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    VaultHooks memory hooks = VaultHooks({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      useBeforeClaimPrize: true,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      useAfterClaimPrize: false,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      implementation: IVaultHooks(address(viciousHook))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    vault.setHooks(hooks);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    vm.stopPrank();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    vm.startPrank(address(claimer));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    mockPrizePoolClaimPrize(uint8(1), alice, 0, address(viciousHook), 1e18, address(claimer));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    claimPrize(uint8(1), alice, 0, 1e18, address(claimer));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    vm.stopPrank();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   function testClaimPrize_beforeHook() public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     vm.startPrank(alice);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     VaultHooks memory hooks = VaultHooks({</span></span></span></code></pre>\n<p>When running the test with <code>forge test --match-test testClaimPrize_viciousHook -vv</code> the output is:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Running 1 test for test/unit/Vault/Vault.t.sol:VaultTest</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[PASS] testClaimPrize_viciousHook() (gas: 321545)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Logs:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Entered side contract</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Test result: okay. 1 passed; 0 failed; finished in 7.29ms</span></span></code></pre>\n<p>This indicates that it is possible for a hook to make an external call and modify the EVM state. With that fact, there are multiple attack vectors.</p>\n<h3 id=\"tools-used-5\" style=\"position:relative;\"><a href=\"#tools-used-5\" aria-label=\"tools used 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Foundry</p>\n<h3 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>To prevent any malicious calls, there are two possible solutions:</p>\n<ol>\n<li>Change the <code>IVaultHook.sol</code> to set the hooks as view functions and prevent EVM state changes:</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/interfaces/IVaultHooks.sol b/src/interfaces/IVaultHooks.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 15217b8..95482c1 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/interfaces/IVaultHooks.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/interfaces/IVaultHooks.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -23,7 +23,7 @@ interface IVaultHooks {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     address winner,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     uint8 tier,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     uint32 prizeIndex</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  ) external returns (address);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  ) external view returns (address);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   /// @notice Triggered after the prize pool claim prize function is called.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   /// @param winner The user who won the prize and for whom this hook is attached</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -37,5 +37,5 @@ interface IVaultHooks {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     uint32 prizeIndex,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     uint256 payout,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     address recipient</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  ) external;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  ) external view;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> }</span></span></span></code></pre>\n<ol start=\"2\">\n<li>As this solution may disturb the business logic, another solution would be to cap the gas used by the hooks. In <code>Vault.sol</code>, set a gas limit variable that can be adjusted by the owner of the vault for flexibility:</li>\n</ol>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L1053\">Vault.sol#L1053</a></p>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L1068\">Vault.sol#L1068</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_claimPrize</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_winner</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_tier</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_prizeIndex</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint96</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_fee</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_feeRecipient</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">VaultHooks</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">hooks</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_hooks</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_winner</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">hooks</span><span class=\"mtk1\">.</span><span class=\"mtk12\">useBeforeClaimPrize</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">hooks</span><span class=\"mtk1\">.</span><span class=\"mtk12\">implementation</span><span class=\"mtk1\">.</span><span class=\"mtk12\">beforeClaimPrize</span><span class=\"mtk1\">{gas: </span><span class=\"mtk12\">gasLimit</span><span class=\"mtk1\">}(</span><span class=\"mtk12\">_winner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tier</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_prizeIndex</span><span class=\"mtk1\">); @</span><span class=\"mtk12\">audit</span><span class=\"mtk1\">-</span><span class=\"mtk12\">info</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_winner</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">hooks</span><span class=\"mtk1\">.</span><span class=\"mtk12\">useAfterClaimPrize</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">hooks</span><span class=\"mtk1\">.</span><span class=\"mtk12\">implementation</span><span class=\"mtk1\">.</span><span class=\"mtk12\">afterClaimPrize</span><span class=\"mtk1\">{gas: </span><span class=\"mtk12\">gasLimit</span><span class=\"mtk1\">}( </span><span class=\"mtk3\">//@audit-info</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_winner</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_tier</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_prizeIndex</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">prizeTotal</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">_fee</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">recipient</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">prizeTotal</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/465#issuecomment-1644789666\">asselstine (PoolTogether) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Adding an internal gas limit and then catching the revert would be ideal; so the claimer won’t be grieved and can detect badly-written hooks.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/465#issuecomment-1668072193\">Picodes (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The issue here, is not the possible DoS, as a claimer can just skip one user, but the possibility of the grieving attack by, for example, front-running by a malicious hook. I’ll give partial credit to duplicates if there is too much focus on DoS.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs\">PoolTogether mitigated</a>:</strong></p>\n<blockquote>\n<p>Added hook gas limits and error handling.<br>\nPR: <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/21\">https://github.com/GenerationSoftware/pt-v5-vault/pull/21</a></p>\n</blockquote>\n<p><strong>Status</strong>: Not fully mitigated. Full details in reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/24\">dirk_y</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/42\">rvierdiiev</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/69\">0xStalin</a>, and in the <a href=\"#mitigation-review\">Mitigation Review</a> section below.</p>\n<hr>\n<h2 id=\"m-03-twablibgettwabbetween-can-return-inaccurate-balances-if-_starttime-and-_endtime-arent-safely-bound\" style=\"position:relative;\"><a href=\"#m-03-twablibgettwabbetween-can-return-inaccurate-balances-if-_starttime-and-_endtime-arent-safely-bound\" aria-label=\"m 03 twablibgettwabbetween can return inaccurate balances if _starttime and _endtime arent safely bound permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/464\">[M-03] <code>TwabLib::getTwabBetween</code> can return inaccurate balances if <code>_startTime</code> and <code>_endTime</code> aren’t safely bound</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/464\">Infect3d</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/459\">Aymen0909</a></em></p>\n<p>Here’s the documentation of the <code>TwabLib::getTwabBetween</code> function:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">twab</span><span class=\"mtk1\">-</span><span class=\"mtk12\">controller</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">TwabLib</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">278</span><span class=\"mtk1\">:   </span><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">279:    * </span><span class=\"mtk4\">@notice</span><span class=\"mtk3\"> Looks up a users TWAB for a time range.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">280:    * </span><span class=\"mtk4\">@dev</span><span class=\"mtk3\"> If the timestamps in the range are not exact matches of observations, the balance is extrapolated using the previous observation.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">281:    * </span><span class=\"mtk4\">@dev</span><span class=\"mtk3\"> Ensure timestamps are safe using isTimeRangeSafe.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">282:    * </span><span class=\"mtk4\">@param</span><span class=\"mtk3\"> </span><span class=\"mtk12\">_observations</span><span class=\"mtk3\"> The circular buffer of observations</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">283:    * </span><span class=\"mtk4\">@param</span><span class=\"mtk3\"> </span><span class=\"mtk12\">_accountDetails</span><span class=\"mtk3\"> The account details to query with</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">284:    * </span><span class=\"mtk4\">@param</span><span class=\"mtk3\"> </span><span class=\"mtk12\">_startTime</span><span class=\"mtk3\"> The start of the time range</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">285:    * </span><span class=\"mtk4\">@param</span><span class=\"mtk3\"> </span><span class=\"mtk12\">_endTime</span><span class=\"mtk3\"> The end of the time range</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">286:    * </span><span class=\"mtk4\">@return</span><span class=\"mtk3\"> twab The TWAB for the time range</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">287:    */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">288</span><span class=\"mtk1\">:   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getTwabBetween</span><span class=\"mtk1\">(  </span><span class=\"mtk3\">//@audit - M01: dev comment (isTimeRangeSafe) doesn&#39;t seems to be followed in PrizePool calling it</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">289:     </span><span class=\"mtk10\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk10\">PERIOD_OFFSET</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">290:     </span><span class=\"mtk10\">ObservationLib</span><span class=\"mtk1\">.</span><span class=\"mtk10\">Observation</span><span class=\"mtk1\">[</span><span class=\"mtk10\">MAX_CARDINALITY</span><span class=\"mtk1\">] </span><span class=\"mtk10\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_observations</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">291:     </span><span class=\"mtk10\">AccountDetails</span><span class=\"mtk1\"> </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_accountDetails</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">292:     </span><span class=\"mtk10\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_startTime</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">293:     </span><span class=\"mtk10\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_endTime</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">294</span><span class=\"mtk1\">:   ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<p><code>TwabLib::getTwabBetween</code> -function gets called in. Then, <code>PrizePool::_getVaultUserBalanceAndTotalSupplyTwab</code> gets called by <code>PrizePool::claimPrize</code>, returning twab for a specified time range, which finally is called by <code>PrizePool::isWinner</code> in <code>PrizePool::claimPrize</code>.</p>\n<p>The thing is, as explained by <a href=\"https://v4.docs.pooltogether.com/protocol/next/design/twab-controller/#sample-loss-of-historic-information\">the documentation</a>, values from balance history aren’t guaranteed to be accurate if the timestamp at which time it is queried do not fall between:</p>\n<ul>\n<li>The newest observation in a period.</li>\n<li>The end of that period (period must have ended).</li>\n</ul>\n<p>That is because until a period has ended, we cannot be sure the value we are querying hasn’t changed in the future (from pov of the timestamp).</p>\n<h3 id=\"impact-3\" style=\"position:relative;\"><a href=\"#impact-3\" aria-label=\"impact 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>This means, that if a prize is claimed, but timestamps at which the <code>twab</code> is getting requested do not follow these rules, the Prize Pool contract might distribute prizes based on inaccurate data. This could lead to the prizes being distributed to users who should not have won, or not being distributed to users who should have won.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">prize</span><span class=\"mtk1\">-</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">PrizePool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">920</span><span class=\"mtk1\">:   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_getVaultUserBalanceAndTotalSupplyTwab</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">921:     </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_vault</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">922:     </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_user</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">923:     </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_drawDuration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">924</span><span class=\"mtk1\">:   ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">twab</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">twabTotalSupply</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">925</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_endTimestamp</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint32</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_lastClosedDrawStartedAt</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">drawPeriodSeconds</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">926</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_startTimestamp</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint32</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_endTimestamp</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">_drawDuration</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">drawPeriodSeconds</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">927</span><span class=\"mtk1\">:     </span><span class=\"mtk3\">//@audit - dev comment for TwabLib::getTwabBetween doesn&#39;t seems to be followed in PrizePool calling it</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">928</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">twab</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">twabController</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getTwabBetween</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_vault</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_startTimestamp</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_endTimestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">929</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">930</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">twabTotalSupply</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">twabController</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getTotalSupplyTwabBetween</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">931</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">_vault</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">932</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">_startTimestamp</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">933</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">_endTimestamp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">934</span><span class=\"mtk1\">:     );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">935</span><span class=\"mtk1\">:   }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add a <code>isTimeRangeSafe</code> check (will depend on how devs want to handle it, either a revert or another error management solution) before <code>getTwabBetween</code> to ensure queried balances are accurate; otherwise, prize distribution could be unfair.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_getVaultUserBalanceAndTotalSupplyTwab</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_vault</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_user</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_drawDuration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">twab</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">twabTotalSupply</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_endTimestamp</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint32</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_lastClosedDrawStartedAt</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">drawPeriodSeconds</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_startTimestamp</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint32</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_endTimestamp</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">_drawDuration</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">drawPeriodSeconds</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//@audit dev comment doesn&#39;t seems to be followed in PrizePool calling it</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//@audit added isTimeRangeSafe before getTwabBetween</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">twabController</span><span class=\"mtk1\">.</span><span class=\"mtk11\">isTimeRangeSafe</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_vault</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_startTimestamp</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_endTimestamp</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Time range not safe&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">twab</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">twabController</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getTwabBetween</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_vault</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_startTimestamp</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_endTimestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">twabTotalSupply</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">twabController</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getTotalSupplyTwabBetween</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_vault</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_startTimestamp</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_endTimestamp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h3 id=\"assessed-type-7\" style=\"position:relative;\"><a href=\"#assessed-type-7\" aria-label=\"assessed type 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Invalid Validation</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/464#issuecomment-1644785229\">asselstine (PoolTogether) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs\">PoolTogether mitigated</a>:</strong></p>\n<blockquote>\n<p>Ensure search timestamps are on or at period end timestamps.<br>\nPR: <a href=\"https://github.com/GenerationSoftware/pt-v5-twab-controller/pull/5\">https://github.com/GenerationSoftware/pt-v5-twab-controller/pull/5</a></p>\n</blockquote>\n<p><strong>Status</strong>: Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/98\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/43\">rvierdiiev</a>.</p>\n<hr>\n<h2 id=\"m-04-the-deposit-function-does-not-check-for-the-maxmint-amount\" style=\"position:relative;\"><a href=\"#m-04-the-deposit-function-does-not-check-for-the-maxmint-amount\" aria-label=\"m 04 the deposit function does not check for the maxmint amount permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/458\">[M-04] The deposit function does not check for the <code>maxMint</code> amount</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/458\">ni8mare</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/435\">ni8mare</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/397\">hals</a>, and <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/89\">shaka</a></em></p>\n<p>It is theoretically possible for the deposit amount to mint shares more than the <code>maxMint</code> amount</p>\n<h3 id=\"proof-of-concept-11\" style=\"position:relative;\"><a href=\"#proof-of-concept-11\" aria-label=\"proof of concept 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The deposit function has a check for <code>maxDeposit</code> and reverts if the deposit value is more than <code>max(uint96)</code>. But, it does not check the shares to be less than <code>maxMint</code> amount and hence, bypasses the check. Theoretically, if the assets are equal to <code>max(uint96)</code> and if the vault is under-collateralized, the ratio of <code>_assetUnit</code> to <code>_exchangeRate</code> is greater than or equal to 2, then the calculation in <code>_convertToShares</code>.</p>\n<p>Function <code>_assets.mulDiv(_assetUnit, _exchangeRate, _rounding);</code> could return a value more than the <code>maxMint</code> amount. This is possible in scenarios where the <code>_assetUnit</code> is a big enough number (as there is no limit on the decimals of the underlying asset, and <code>_assetUnit = 10 ** super.decimals()</code>) and the Vault is severely under-collateralized.</p>\n<h3 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Include the <code>maxMint</code> check in the deposit function to prevent this problem.</p>\n<h3 id=\"assessed-type-8\" style=\"position:relative;\"><a href=\"#assessed-type-8\" aria-label=\"assessed type 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Invalid Validation</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/458#issuecomment-1644784889\">asselstine (PoolTogether) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs\">PoolTogether mitigated</a>:</strong></p>\n<blockquote>\n<p>Fixed 4626 compliance.<br>\nPR: <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/11\">https://github.com/GenerationSoftware/pt-v5-vault/pull/11</a></p>\n</blockquote>\n<p><strong>Status</strong>: Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/74\">0xStalin</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/7\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/44\">rvierdiiev</a>.</p>\n<hr>\n<h2 id=\"m-05-balance-invariant-between-the-individual-and-total-twabs-can-be-broken\" style=\"position:relative;\"><a href=\"#m-05-balance-invariant-between-the-individual-and-total-twabs-can-be-broken\" aria-label=\"m 05 balance invariant between the individual and total twabs can be broken permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/452\">[M-05] Balance invariant between the individual and total <code>twabs</code> can be broken</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/452\">minhtrng</a></em></p>\n<p>An edge case in the <code>TwabController._transferBalance</code> can cause the total balance for a vault account to decrease; although, it did not actually decrease. This will cause the sum of the individual <code>delegateBalances</code> for a vault to be greater than the registered total for that vault. This again will skew the odds in favor of winning a price, causing the reserve to be drained faster over the time intended.</p>\n<h3 id=\"proof-of-concept-12\" style=\"position:relative;\"><a href=\"#proof-of-concept-12\" aria-label=\"proof of concept 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The <code>TwabController._transferBalance</code> function handles the case incorrectly, where <code>_to</code> is equal to the <code>SPONSORSHIP_ADDRESS</code>. First, assume the <code>_from</code> address is an address that has a balance and delegates to itself (the default). Then, the function will decrease the balance and <code>delegateBalance</code> of <code>_from</code>. It will also decrease the total balances of the vault account (note: that <code>_toDelegate</code> will be <code>SPONSORSHIP_ADDRESS</code> due to default):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_from</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_isFromDelegate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_fromDelegate</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">_from</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">_decreaseBalances</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_vault</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_isFromDelegate</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> : </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">_isFromDelegate</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_fromDelegate</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">SPONSORSHIP_ADDRESS</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_decreaseBalances</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_vault</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_fromDelegate</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_to</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) ||</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">_toDelegate</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">SPONSORSHIP_ADDRESS</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_fromDelegate</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">SPONSORSHIP_ADDRESS</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_decreaseTotalSupplyBalances</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk12\">_vault</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk12\">_to</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) ? </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> : </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          (</span><span class=\"mtk12\">_to</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) &amp;&amp; </span><span class=\"mtk12\">_fromDelegate</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">SPONSORSHIP_ADDRESS</span><span class=\"mtk1\">) ||</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            (</span><span class=\"mtk12\">_toDelegate</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">SPONSORSHIP_ADDRESS</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_fromDelegate</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">SPONSORSHIP_ADDRESS</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ? </span><span class=\"mtk12\">_amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            : </span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>Then, the balance and <code>delegateBalance</code> of <code>SPONSORSHIP_ADDRESS</code> will be increased by the same amount. This is not supposed to happen in the first place, as this address is not meant to have any balances. However, the issue described is due to the fact that the total balances of the vault account will not be adjusted, because the condition <code>_toDelegate != SPONSORSHIP_ADDRESS</code> is not met:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_to</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_isToDelegate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_toDelegate</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">_to</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">_increaseBalances</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_vault</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_isToDelegate</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> : </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">_isToDelegate</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_toDelegate</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">SPONSORSHIP_ADDRESS</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_increaseBalances</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_vault</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_toDelegate</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_from</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) ||</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">_fromDelegate</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">SPONSORSHIP_ADDRESS</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_toDelegate</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">SPONSORSHIP_ADDRESS</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_increaseTotalSupplyBalances</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk12\">_vault</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk12\">_from</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) ? </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> : </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          (</span><span class=\"mtk12\">_from</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) &amp;&amp; </span><span class=\"mtk12\">_toDelegate</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">SPONSORSHIP_ADDRESS</span><span class=\"mtk1\">) ||</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            (</span><span class=\"mtk12\">_fromDelegate</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">SPONSORSHIP_ADDRESS</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_toDelegate</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">SPONSORSHIP_ADDRESS</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ? </span><span class=\"mtk12\">_amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            : </span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>The ratio of <code>_userTwab</code> and <code>_vaultTwabTotalSupply</code> plays a role when determining a winner in <code>TierCalculationLib.isWinner</code> and the underlying model assumes the invariant to hold true:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constrainedRandomNumber</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_userSpecificRandomNumber</span><span class=\"mtk1\"> % (</span><span class=\"mtk12\">_vaultTwabTotalSupply</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">winningZone</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">calculateWinningZone</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_userTwab</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_vaultContributionFraction</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tierOdds</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>If the sum of the individual <code>twabs</code> is higher than the sum, there will be more winners than intended, causing the described drainage of the reserve.</p>\n<h3 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Disallow <code>_to</code> to be <code>SPONSORSHIP_ADDRESS</code>.</p>\n<h3 id=\"assessed-type-9\" style=\"position:relative;\"><a href=\"#assessed-type-9\" aria-label=\"assessed type 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Invalid Validation</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/452#issuecomment-1644778105\">asselstine (PoolTogether) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs\">PoolTogether mitigated</a>:</strong></p>\n<blockquote>\n<p>Reject transfers to the sponsorship address.<br>\nPR: <a href=\"https://github.com/GenerationSoftware/pt-v5-twab-controller/pull/6\">https://github.com/GenerationSoftware/pt-v5-twab-controller/pull/6</a></p>\n</blockquote>\n<p><strong>Status</strong>: Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/73\">0xStalin</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/11\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/45\">rvierdiiev</a>.</p>\n<hr>\n<h2 id=\"m-06-drawmanager-can-be-set-to-a-malicious-address\" style=\"position:relative;\"><a href=\"#m-06-drawmanager-can-be-set-to-a-malicious-address\" aria-label=\"m 06 drawmanager can be set to a malicious address permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/431\">[M-06] <code>drawManager</code> can be set to a malicious address</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/431\">Udsen</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/476\">catellatech</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/356\">Inspecktor</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/337\">squeaky_cactus</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/322\">0xPsuedoPandit</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/318\">0x11singh99</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/297\">Tripathi</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/253\">Nyx</a>, Daniel526 (<a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/248\">1</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/244\">2</a>), <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/229\">namx05</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/228\">Jorgect</a>, Praise (<a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/164\">1</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/163\">2</a>), <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/101\">xuwinnie</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/59\">YY</a>, and <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/44\">Darwin</a></em></p>\n<p>In the <code>PrizePool.constructor</code> the <code>drawManager</code> state variable is set as follows:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">drawManager = params.drawManager;</span></span></code></pre>\n<p>But it accepts, even if the <code>params.drawManager == address(0)</code>. There is no input validation for the <code>address(0)</code> as well.</p>\n<p>The <code>PrizePool.setDrawManager</code> function is used to set the <code>drawManager</code> if not already set. But the problem here, is that there is no access control for this function and anyone can call this. A malicious user can front-run the <code>valid</code> <code>drawManager</code> assignment transaction and set a malicious address as the <code>drawManager</code>. The other issue, is once the <code>drawManager</code> is set, it can not be updated due to the following conditional check. Hence, the contract will have to redeployed.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if (drawManager != address(0)) { //@audit-issue - can be front run by a malicious user</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  revert DrawManagerAlreadySet();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>The following two functions controlled by the <code>onlyDrawManager</code> modifier will be vulnerable to attacks, since the <code>drawManager</code> is a malicious address now.</p>\n<ol>\n<li><code>PrizePool.withdrawReserve</code> can withdraw tokens from the <code>reserve</code> to any address given in the <code>_to</code> parameter. Hence, this function will be vulnerable.</li>\n<li>The <code>PrizePool.closeDraw()</code> function can close the current open draw. This function is only callable by the <code>drawManager</code> function. A malicious user can get control of this function, thus making it vulnerable.</li>\n</ol>\n<h3 id=\"proof-of-concept-13\" style=\"position:relative;\"><a href=\"#proof-of-concept-13\" aria-label=\"proof of concept 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">drawManager</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">drawManager</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">drawManager</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">DrawManagerSet</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">drawManager</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L278-L281\">https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L278-L281</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setDrawManager</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_drawManager</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">drawManager</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">DrawManagerAlreadySet</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">drawManager</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_drawManager</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">DrawManagerSet</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_drawManager</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L299-L306\">https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L299-L306</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">closeDraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">winningRandomNumber_</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyDrawManager</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L348\">https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L348</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdrawReserve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint104</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyDrawManager</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">_reserve</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InsufficientReserve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_reserve</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_reserve</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">WithdrawReserve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L335-L342\">https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L335-L342</a></p>\n<h3 id=\"tools-used-6\" style=\"position:relative;\"><a href=\"#tools-used-6\" aria-label=\"tools used 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VSCode</p>\n<h3 id=\"recommended-mitigation-steps-14\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-14\" aria-label=\"recommended mitigation steps 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>It is recommended to check for <code>address(0)</code> in the constructor when <code>drawManager</code> is set; or to implement <code>access control</code> in the <code>PrizePool.setDrawManager</code> function, so that only the admin of the contract can call this function to set the <code>drawManager</code>, if it is not set already.</p>\n<h3 id=\"assessed-type-10\" style=\"position:relative;\"><a href=\"#assessed-type-10\" aria-label=\"assessed type 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Invalid Validation</p>\n<p><strong>PoolTogether confirmed via discord communication</strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs\">PoolTogether mitigated</a>:</strong></p>\n<blockquote>\n<p>Record deployer and permission draw manager.<br>\nPR: <a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/pull/31\">https://github.com/GenerationSoftware/pt-v5-prize-pool/pull/31</a></p>\n</blockquote>\n<p><strong>Status</strong>: Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/46\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/12\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/83\">0xStalin</a>.</p>\n<hr>\n<h2 id=\"m-07-in-important-libraries-of-pooltogether-the-pow-function-of-prbmath-is-used-which-exhibits-inconsistent-return-values\" style=\"position:relative;\"><a href=\"#m-07-in-important-libraries-of-pooltogether-the-pow-function-of-prbmath-is-used-which-exhibits-inconsistent-return-values\" aria-label=\"m 07 in important libraries of pooltogether the pow function of prbmath is used which exhibits inconsistent return values permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/423\">[M-07] In important libraries of PoolTogether, the <code>pow()</code> function of PRBMath is used, which exhibits inconsistent return values</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/423\">catellatech</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/395\">Tripathi</a> and <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/6\">nadin</a></em></p>\n<h3 id=\"lines-of-code-3\" style=\"position:relative;\"><a href=\"#lines-of-code-3\" aria-label=\"lines of code 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lines of code</h3>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/libraries/DrawAccumulatorLib.sol#L406-L407\">https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/libraries/DrawAccumulatorLib.sol#L406-L407</a>\n<a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/libraries/TierCalculationLib.sol#L26\">https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/libraries/TierCalculationLib.sol#L26</a></p>\n<h3 id=\"impact-4\" style=\"position:relative;\"><a href=\"#impact-4\" aria-label=\"impact 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>The <code>DrawAccumulatorLib.sol</code> and <code>TierCalculationLib.sol</code> libraries inherit a version of <code>PRBMath</code> that contains a critical vulnerability in the <code>pow()</code> function, which can return inconsistent values. This vulnerability is of great importance to the PoolTogether protocol, as the <code>pow()</code> function is used in the computation of <code>TierCalculationLib.getTierOdds</code> and <code>DrawAccumulatorLib.computeC</code>.</p>\n<p>Recently, another protocol has also experienced the same bug and the creators of the <code>PRBMath</code> have acknowledged this situation. Here is the corresponding <a href=\"https://github.com/sablier-labs/v2-core/pull/432\">request</a>. Due to time constraints, we were unable to thoroughly address certain rounding errors with the <code>mul</code> and <code>div</code> functions of <code>SD59x18</code>. However, these errors have been corrected in PRBMath <a href=\"https://github.com/PaulRBerg/prb-math/releases/tag/v4.0.0\">V4</a>.</p>\n<h3 id=\"proof-of-concept-14\" style=\"position:relative;\"><a href=\"#proof-of-concept-14\" aria-label=\"proof of concept 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/sablier-labs/v2-core/pull/432\">Proof of the bug acknowledgment by the creator of the PRBMath</a></p>\n<p>This PR makes four significant changes:</p>\n<ul>\n<li>Upgrades to PRBMath v4.</li>\n<li>Bumps all other submodules to their most recent versions.</li>\n<li>Increases the minimum Solidity pragma to v0.8.19, since this is a requirement of PRBMath V4.</li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-15\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-15\" aria-label=\"recommended mitigation steps 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>To mitigate this issue, please update the contracts to <code>0.8.19</code> and upgrade the <code>PRBMath</code> to version <code>V4</code>.</p>\n<h3 id=\"assessed-type-11\" style=\"position:relative;\"><a href=\"#assessed-type-11\" aria-label=\"assessed type 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Math</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/423#issuecomment-1644733812\">asselstine (PoolTogether) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/423#issuecomment-1666618858\">Picodes (judge) decreased severity to Medium</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs\">PoolTogether mitigated</a>:</strong></p>\n<blockquote>\n<p>Upgrade PRBMath to v4 and Solidity to 0.8.19.<br>\nPR: <a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/commit/ba56ea8bac3bce06f1e08ae071a19954dd720b1f\">https://github.com/GenerationSoftware/pt-v5-prize-pool/commit/ba56ea8bac3bce06f1e08ae071a19954dd720b1f</a></p>\n</blockquote>\n<p><strong>Status</strong>: Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/84\">0xStalin</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/13\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/47\">rvierdiiev</a>.</p>\n<hr>\n<h2 id=\"m-08-an-attacker-can-front-run-deployvault-to-deploy-at-the-same-address\" style=\"position:relative;\"><a href=\"#m-08-an-attacker-can-front-run-deployvault-to-deploy-at-the-same-address\" aria-label=\"m 08 an attacker can front run deployvault to deploy at the same address permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/416\">[M-08] An attacker can front-run <code>deployVault</code> to deploy at the same address</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/416\">gzeon</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/350\">Inspecktor</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/238\">Breeje</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/191\">0xMirce</a>, and <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/69\">ptsanev</a></em></p>\n<p>Vaults are created from the factory via <code>CREATE1</code>. An attacker can front-run <code>deployVault</code> to deploy at the same address, but with different config. If the deployed chain reorg, a different vault might also be deployed at the same address.</p>\n<h3 id=\"proof-of-concept-15\" style=\"position:relative;\"><a href=\"#proof-of-concept-15\" aria-label=\"proof of concept 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/VaultFactory.sol#L67-L78\">https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/VaultFactory.sol#L67-L78</a></p>\n<ol>\n<li>Bob setup a bot to monitor the <code>mempool</code> when PT deploys a new vault.</li>\n<li>Bob’s bot saw a deployment by PT at <code>0x1234</code> and fires a tx to deposit immediately.</li>\n<li>Alice front-runs PT’s deployment by deploying a malicious vault at <code>0x1234</code>.</li>\n<li>Bob’s transaction ended up deposited into Alice’s malicious vault.</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-16\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-16\" aria-label=\"recommended mitigation steps 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Use <code>CREATE2</code> and the vault config as salt.</p>\n<h3 id=\"assessed-type-12\" style=\"position:relative;\"><a href=\"#assessed-type-12\" aria-label=\"assessed type 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>MEV</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/416#issuecomment-1644728305\">asselstine (PoolTogether) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>The Vault address is a derivative of the (sender address, nonce).  I don’t see how this scenario is possible?</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/416#issuecomment-1666992892\">Picodes (judge) commented</a>:</strong></p>\n<blockquote>\n<p>@asselstine - exactly. Here, it only depends on the nonce of the factory; so in case of reorg, someone could “override” a vault deployment and all following transactions would still be executed.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs\">PoolTogether mitigated</a>:</strong></p>\n<blockquote>\n<p>Used <code>CREATE2</code> for <code>VaultFactory</code>.<br>\nPR: <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/25\">https://github.com/GenerationSoftware/pt-v5-vault/pull/25</a></p>\n</blockquote>\n<p><strong>Status</strong>: Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/14\">dirk_y</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/48\">rvierdiiev</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/82\">0xStalin</a>.</p>\n<hr>\n<h2 id=\"m-09-high-prizes-might-not-be-claimed\" style=\"position:relative;\"><a href=\"#m-09-high-prizes-might-not-be-claimed\" aria-label=\"m 09 high prizes might not be claimed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/415\">[M-09] High Prizes might not be claimed</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/415\">markus_ether</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/321\">josephdara</a></em></p>\n<h3 id=\"lines-of-code-4\" style=\"position:relative;\"><a href=\"#lines-of-code-4\" aria-label=\"lines of code 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lines of code</h3>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-claimer/blob/57a381aef690a27c9198f4340747155a71cae753/src/Claimer.sol#L210\">https://github.com/GenerationSoftware/pt-v5-claimer/blob/57a381aef690a27c9198f4340747155a71cae753/src/Claimer.sol#L210</a>\n<a href=\"https://github.com/GenerationSoftware/pt-v5-claimer/blob/57a381aef690a27c9198f4340747155a71cae753/src/Claimer.sol#L173\">https://github.com/GenerationSoftware/pt-v5-claimer/blob/57a381aef690a27c9198f4340747155a71cae753/src/Claimer.sol#L173</a></p>\n<h3 id=\"impact-5\" style=\"position:relative;\"><a href=\"#impact-5\" aria-label=\"impact 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>PoolTogether V5 delegates the task of claiming the prizes to a network of <code>Claimers</code> that are incentivized to claim prizes for a share of the prize won.\nThe fees the Claimant receives is calculated based on a Dutch Auction, but then limited by the minimum prize of the prize pool.</p>\n<p>fee <code>=</code> min (fee in auction <code>= % maxFeePortionOfPrize * minPrize</code>).</p>\n<p>When the gas costs exceed the <code>minPrize</code>, the solver has no incentives to claim the price. Notice that the number of prizes only adjusts <em>after</em> very few prizes are claimed.</p>\n<h3 id=\"proof-of-concept-16\" style=\"position:relative;\"><a href=\"#proof-of-concept-16\" aria-label=\"proof of concept 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Gas prices will then rise well above the <code>minPrize</code>. The highest prize is suddenly drawn that day. The solvers have no incentive to claim the prize and the winner does not monitor the contract. As a result, no one claims the top prize. The protocol suffers a loss of reputation.</p>\n<h3 id=\"tools-used-7\" style=\"position:relative;\"><a href=\"#tools-used-7\" aria-label=\"tools used 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VS Code</p>\n<h3 id=\"recommended-mitigation-steps-17\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-17\" aria-label=\"recommended mitigation steps 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The problem is that the incentives are not exactly aligned. The user is willing to pay anything up to their price to receive their price. But the maximum the solver receives is the minimum price. We can align the two incentives by using each user’s price as an upper bound.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">function _computeMaxFee(uint8 _tier, uint8 _numTiers) internal view returns (uint256) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    uint8 _canaryTier = _numTiers - 1;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    if (_tier != _canaryTier) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      // canary tier</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-     return _computeMaxFee(prizePool.getTierPrizeSize(_canaryTier - 1));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t  return _computeMaxFee(prizePool.getTierPrizeSize(_tier));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t} else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      return _computeMaxFee(prizePool.getTierPrizeSize(_canaryTier));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>Since we already validate the inputs in <a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L417-L419\"><code>claimPrize</code></a>, the attacker can not claim more than the prize is worth.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/415#issuecomment-1644725651\">asselstine (PoolTogether) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs\">PoolTogether mitigated</a>:</strong></p>\n<blockquote>\n<p>Made <code>maxFee</code> a function of the tier’s prize size, not the smallest prize size.<br>\nPR: <a href=\"https://github.com/GenerationSoftware/pt-v5-claimer/pull/7\">https://github.com/GenerationSoftware/pt-v5-claimer/pull/7</a></p>\n</blockquote>\n<p><strong>Status</strong>: Mitigation error. Full details in report from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/15\">dirk_y</a>, and in the <a href=\"#mitigation-review\">Mitigation Review</a> section below.</p>\n<hr>\n<h2 id=\"m-10-prizepool---winners-wouldnt-be-able-to-claim-prize-correctly-in-claimprize-function-\" style=\"position:relative;\"><a href=\"#m-10-prizepool---winners-wouldnt-be-able-to-claim-prize-correctly-in-claimprize-function-\" aria-label=\"m 10 prizepool   winners wouldnt be able to claim prize correctly in claimprize function  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/399\">[M-10] <code>PrizePool</code> -> Winners wouldn’t be able to claim prize correctly in <code>claimPrize</code> function </a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/399\">mahyar</a></em></p>\n<p>In <code>PrizePool.sol</code> vaults can call the <code>claimPrize()</code> function to claim prizes for winners. The <code>claimPrize</code> calls <code>_getTier(_tier, numberOfTiers)</code> function to get back the <code>prizeSize</code> but there is a problem in the <a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/abstract/TieredLiquidityDistributor.sol#L471\"><code>_getTier</code></a> function:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"48\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_getTier</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_tier</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_numberOfTiers</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">Tier</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">Tier</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tier</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_tiers</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tier</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_lastClosedDrawId</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">lastClosedDrawId</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">tier</span><span class=\"mtk1\">.</span><span class=\"mtk12\">drawId</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">_lastClosedDrawId</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">tier</span><span class=\"mtk1\">.</span><span class=\"mtk12\">drawId</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_lastClosedDrawId</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">tier</span><span class=\"mtk1\">.</span><span class=\"mtk12\">prizeSize</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint96</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_computePrizeSize</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk12\">_tier</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk12\">_numberOfTiers</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk11\">fromUD34x4toUD60x18</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tier</span><span class=\"mtk1\">.</span><span class=\"mtk12\">prizeTokenPerShare</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk11\">fromUD34x4toUD60x18</span><span class=\"mtk1\">(</span><span class=\"mtk12\">prizeTokenPerShare</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tier</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>As you can see, it calls the <code>_computePrizeSize</code> function and downcasts the returned result. Since it returns <code>uint256</code> by downcasting it to <code>uint96</code>, it’s possible to result in the incorrect number in the value overflow. When downcasting from one type to another, Solidity will not revert, but overflows.\nThis means, there is a possibility the <code>prizeSize</code> value will result in the incorrect prize size and vaults can’t claim the prizes correctly for winners.</p>\n<h3 id=\"recommended-mitigation-steps-18\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-18\" aria-label=\"recommended mitigation steps 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Check whether the result of <code>prizeSize</code> exceeds <code>type(uint96).max</code> or not, if so, revert the tx. I recommend to use <a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/math/SafeCast.sol\">SafeCast</a> by OpenZeppelin for casting different types safely.</p>\n<p>I also found some other downcastings in the codebase, but since they are pegged to vault share values and you already check for overflows, there is no problem.</p>\n<h3 id=\"assessed-type-13\" style=\"position:relative;\"><a href=\"#assessed-type-13\" aria-label=\"assessed type 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Under/Overflow</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/399#issuecomment-1644716829\">asselstine (PoolTogether) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Hmm; looks like the Tier struct has an extra 16 bits available to pack.  Will increase <code>prizeSize</code> type to <code>uint112</code> and add safe casting.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/399#issuecomment-1666619614\">Picodes (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Downgrading to Med as there is no proof of impact or discussion about the chances of this occurring in the report.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/399#issuecomment-1683002833\">asselstine (PoolTogether) commented</a>:</strong></p>\n<blockquote>\n<p>Come to think of it, since prizes are in POOL and its supply is 10m with 18 decimals, then prizes can never be more than ~1e25.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs\">PoolTogether mitigated</a>:</strong></p>\n<blockquote>\n<p>Improved handling of prize size overflow.<br>\nPR: <a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/pull/16\">https://github.com/GenerationSoftware/pt-v5-prize-pool/pull/16</a></p>\n</blockquote>\n<p><strong>Status</strong>: Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/85\">0xStalin</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/16\">dirk_y</a>.</p>\n<hr>\n<h2 id=\"m-11-vaultmintwithpermit-can-be-dosd-\" style=\"position:relative;\"><a href=\"#m-11-vaultmintwithpermit-can-be-dosd-\" aria-label=\"m 11 vaultmintwithpermit can be dosd  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/384\">[M-11] <code>Vault.mintWithPermit()</code> can be DoS’d </a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/384\">KupiaSec</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/153\">dirk_y</a></em></p>\n<h3 id=\"lines-of-code-5\" style=\"position:relative;\"><a href=\"#lines-of-code-5\" aria-label=\"lines of code 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lines of code</h3>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/tree/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L466-L469\">https://github.com/GenerationSoftware/pt-v5-vault/tree/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L466-L469</a>\n<a href=\"https://github.com/GenerationSoftware/pt-v5-vault/tree/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L971-L974\">https://github.com/GenerationSoftware/pt-v5-vault/tree/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L971-L974</a>\n<a href=\"https://github.com/GenerationSoftware/pt-v5-vault/tree/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L882-L887\">https://github.com/GenerationSoftware/pt-v5-vault/tree/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L882-L887</a></p>\n<h3 id=\"impact-6\" style=\"position:relative;\"><a href=\"#impact-6\" aria-label=\"impact 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p><code>Vault.mintWithPermit()</code> uses a signature to approve the underlying asset. But the asset amount can be changed easily, so this method can be reverted and might be DoS’d.</p>\n<h3 id=\"proof-of-concept-17\" style=\"position:relative;\"><a href=\"#proof-of-concept-17\" aria-label=\"proof of concept 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><code>Vault.mintWithPermit()</code> gets the share amount as an input and calculates the asset amount from the share. Then, it approves the asset amount with <code>permit</code> method.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"49\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_assets</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_beforeMint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_receiver</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_permit</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20Permit</span><span class=\"mtk1\">(</span><span class=\"mtk11\">asset</span><span class=\"mtk1\">()), </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_deadline</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_v</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_r</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_s</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>The signature is generated using the exact value of the expected asset amount calculated from the share amount, and the resulting asset amount depends on the exchange rate of current vault.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"50\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_beforeMint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_receiver</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_shares</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk11\">maxMint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_receiver</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">MintMoreThanMax</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">, </span><span class=\"mtk11\">maxMint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_receiver</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_convertToAssets</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">, </span><span class=\"mtk10\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Rounding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Up</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"51\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_convertToAssets</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    Math.Rounding </span><span class=\"mtk12\">_rounding</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_convertToAssets</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">, </span><span class=\"mtk11\">_currentExchangeRate</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">_rounding</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>The resulting asset amount can be different from the value of transaction start time. Even an adversary can front-run and manipulate the exchange rate. If the resulting asset amount is different from the original one, the signature will not work as expected and <code>mintWithPermit()</code> will revert in most cases.</p>\n<h3 id=\"recommended-mitigation-steps-19\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-19\" aria-label=\"recommended mitigation steps 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>We can input an upper bound of the asset amount instead of the exact value of the asset amount.</p>\n<h3 id=\"assessed-type-14\" style=\"position:relative;\"><a href=\"#assessed-type-14\" aria-label=\"assessed type 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>DoS</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/384#issuecomment-1644706240\">asselstine (PoolTogether) confirmed</a></strong></p>\n<blockquote>\n<p>asselstine marked the issue as sponsor confirmed</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs\">PoolTogether mitigated</a>:</strong></p>\n<blockquote>\n<p>Removed <code>mintWithPermit</code>.<br>\nPR: <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/15\">https://github.com/GenerationSoftware/pt-v5-vault/pull/15</a></p>\n</blockquote>\n<p><strong>Status</strong>: Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/17\">dirk_y</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/51\">rvierdiiev</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/76\">0xStalin</a>.</p>\n<hr>\n<h2 id=\"m-12-the-tier-odds-in-tieredliquiditydistributor-are-incorrect\" style=\"position:relative;\"><a href=\"#m-12-the-tier-odds-in-tieredliquiditydistributor-are-incorrect\" aria-label=\"m 12 the tier odds in tieredliquiditydistributor are incorrect permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/352\">[M-12] The tier odds in <code>TieredLiquidityDistributor</code> are incorrect</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/352\">dirk_y</a></em></p>\n<p>The following points are stated in the docs:</p>\n<ol>\n<li>The highest standard prize tier is the most common prize: occurring every single draw.</li>\n<li>The canary tier has odds of occurring daily (as if it were the highest tier).</li>\n</ol>\n<p>Therefore, both the highest standard tier and the canary tier should have odds of 1; however, only the canary tier has odds of 1. The result is that the protocol is not distributing prizes as intended.</p>\n<h3 id=\"proof-of-concept-18\" style=\"position:relative;\"><a href=\"#proof-of-concept-18\" aria-label=\"proof of concept 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The issue with the odds calculations can be seen in the <code>TieredLiquidityDistributor.sol</code> contract. Below is a short snippet for the tier odds when there are 3 tiers:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"52\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  SD59x18 internal constant TIER_ODDS_0_3 = SD59x18.wrap(2739726027397260);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  SD59x18 internal constant TIER_ODDS_1_3 = SD59x18.wrap(52342392259021369);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  SD59x18 internal constant TIER_ODDS_2_3 = SD59x18.wrap(1000000000000000000);</span></span></code></pre>\n<p>The canary tier odds are 1 as intended; however, the highest normal prize tier odds are incorrect. If the tier odds were being calculated correctly, we should see the last two odds for each number of tiers being 1 (i.e. <code>1000000000000000000</code>).</p>\n<h3 id=\"recommended-mitigation-steps-20\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-20\" aria-label=\"recommended mitigation steps 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Since the <code>TierCalculationLib.getTierOdds</code> function only seems to be used by the <code>GenerateConstants</code> script, I suggest modifying the script used to generate the constants that are placed in <code>TieredLiquidityDistributor.sol</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"53\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">diff --git a/script/generateConstants.s.sol b/script/generateConstants.s.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">index fe1d4ed..fb9f90a 100644</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--- a/script/generateConstants.s.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+++ b/script/generateConstants.s.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">@@ -38,16 +38,24 @@ contract GenerateConstants is Script {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     MAX_TIERS = 15;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     // Precompute the odds for each tier</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     for (uint8 numTiers = MIN_TIERS; numTiers &lt;= MAX_TIERS; numTiers++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-      for (uint8 tier = 0; tier &lt; numTiers; tier++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+      for (uint8 tier = 0; tier &lt; numTiers - 1; tier++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         console.log(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">           &quot;SD59x18 internal constant TIER_ODDS_%d_%d = SD59x18.wrap(%d);&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">           uint256(tier),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">           uint256(numTiers),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">           uint256(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-            SD59x18.unwrap(TierCalculationLib.getTierOdds(tier, numTiers, GRAND_PRIZE_PERIOD_DRAWS))</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+            SD59x18.unwrap(TierCalculationLib.getTierOdds(tier, numTiers - 1, GRAND_PRIZE_PERIOD_DRAWS))</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">           )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">       }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+      console.log(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+          &quot;SD59x18 internal constant TIER_ODDS_%d_%d = SD59x18.wrap(%d);&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+          uint256(numTiers - 1),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+          uint256(numTiers),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+          uint256(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+            SD59x18.unwrap(TierCalculationLib.getTierOdds(numTiers - 1, numTiers, GRAND_PRIZE_PERIOD_DRAWS))</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+          )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> }</span></span></code></pre>\n<h3 id=\"assessed-type-15\" style=\"position:relative;\"><a href=\"#assessed-type-15\" aria-label=\"assessed type 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Math</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/352#issuecomment-1644675890\">asselstine (PoolTogether) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs\">PoolTogether mitigated</a>:</strong></p>\n<blockquote>\n<p>Recomputed Tier odds, reduced the number of tiers and made grand prize period draws configurable.<br>\nPR: <a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/pull/24\">https://github.com/GenerationSoftware/pt-v5-prize-pool/pull/24</a></p>\n</blockquote>\n<p><strong>Status</strong>: Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/90\">0xStalin</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/18\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/52\">rvierdiiev</a>.</p>\n<hr>\n<h2 id=\"m-13-users-can-manipulate-the-observation-creation\" style=\"position:relative;\"><a href=\"#m-13-users-can-manipulate-the-observation-creation\" aria-label=\"m 13 users can manipulate the observation creation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/334\">[M-13] Users can manipulate the observation creation</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/334\">Nyx</a></em></p>\n<p>Users can alter the record of their balances.</p>\n<h3 id=\"proof-of-concept-19\" style=\"position:relative;\"><a href=\"#proof-of-concept-19\" aria-label=\"proof of concept 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>If the users <code>delegateBalance</code> has changed, observations will be recorded. If there is a need for a new observation, the new observation will be created; otherwise, it will be overwritten.</p>\n<p>A new observation creation will be decided in the <code>_getNextObservationIndex()</code> function.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"54\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">currentPeriod</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">currentPeriod</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">newestObservationPeriod</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">uint16</span><span class=\"mtk1\">(</span><span class=\"mtk12\">RingBufferLib</span><span class=\"mtk1\">.</span><span class=\"mtk11\">wrap</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_accountDetails</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nextObservationIndex</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MAX_CARDINALITY</span><span class=\"mtk1\">)),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">newestObservation</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><code>newestObservationPeriod</code> is the last observations period. <code>currentPeriod</code> is a period that calculated with <code>uint32 currentTime = uint32(block.timestamp)</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"55\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentPeriod</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getTimestampPeriod</span><span class=\"mtk1\">(</span><span class=\"mtk12\">PERIOD_LENGTH</span><span class=\"mtk1\">, </span><span class=\"mtk12\">PERIOD_OFFSET</span><span class=\"mtk1\">, </span><span class=\"mtk12\">currentTime</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newestObservationPeriod</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getTimestampPeriod</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">PERIOD_LENGTH</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">PERIOD_OFFSET</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">newestObservation</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"56\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_getTimestampPeriod</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">PERIOD_LENGTH</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">PERIOD_OFFSET</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_timestamp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">period</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_timestamp</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">PERIOD_OFFSET</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Shrink by 1 to ensure periods end on a multiple of PERIOD_LENGTH.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Increase by 1 to start periods at # 1.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> ((</span><span class=\"mtk12\">_timestamp</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">PERIOD_OFFSET</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">PERIOD_LENGTH</span><span class=\"mtk1\">) + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>The problem is, if someone deposits a small amount frequently, <code>currentPeriod</code> and <code>newestObservationPeriod</code> will always be the same and a new observation won’t be created. Attackers can keep doing this until <code>closeDraw</code> and manipulate their balances.</p>\n<p>According to the docs, if a draw were to start and end within a period, a user would be able to alter the record of their balance for that draw by overwriting an Observation.</p>\n<p>It is important to note that due to Observation overwriting, average balances for a period are not finalized until a period ends. Therefore, if a draw ends but a period has not, a user would be able to manipulate their average balance for that final period of time after the draw ends. This would result in an inaccurate record of their balance held during the draw.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/334#issuecomment-1644656003\">asselstine (PoolTogether) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/334#issuecomment-1666989699\">Picodes (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<blockquote>\n<p>If someone deposits a small amount frequently, <code>currentPeriod</code> and <code>newestObservationPeriod</code> will always be the same and a new observation won’t be created<code>This only works for small deposit within the same</code>PERIOD_LENGTH`; otherwise, timestamp roundings will differ.</p>\n</blockquote>\n<p>This report shows how by leveraging the fact that new observations are not created if the previous observations falls within the same period, an attacker could modify its average balance for the final period if a draw ends within a period.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs\">PoolTogether mitigated</a>:</strong></p>\n<blockquote>\n<p>Aligned twab queries on period boundaries.<br>\nPR: <a href=\"https://github.com/GenerationSoftware/pt-v5-twab-controller/pull/5\">https://github.com/GenerationSoftware/pt-v5-twab-controller/pull/5</a></p>\n</blockquote>\n<p><strong>Status</strong>: Mitigation confirmed with comments. Full details in reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/99\">dirk_y</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/72\">0xStalin</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/53\">rvierdiiev</a>.</p>\n<hr>\n<h2 id=\"m-14-number-of-prize-tiers-always-increases-if-just-1-canary-prize-is-claimed\" style=\"position:relative;\"><a href=\"#m-14-number-of-prize-tiers-always-increases-if-just-1-canary-prize-is-claimed\" aria-label=\"m 14 number of prize tiers always increases if just 1 canary prize is claimed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/332\">[M-14] Number of prize tiers always increases if just 1 canary prize is claimed</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/332\">dirk_y</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/145\">bin2chen</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/105\">xuwinnie</a>, and <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/37\">volodya</a></em></p>\n<h3 id=\"lines-of-code-6\" style=\"position:relative;\"><a href=\"#lines-of-code-6\" aria-label=\"lines of code 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lines of code</h3>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L361\">https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L361</a>\n<a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L446-L448\">https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L446-L448</a>\n<a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L781-L810\">https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L781-L810</a></p>\n<h3 id=\"impact-7\" style=\"position:relative;\"><a href=\"#impact-7\" aria-label=\"impact 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>As mentioned in the docs:</p>\n<blockquote>\n<p>“The Canary Tier is a special prize tier that receives a smaller amount of prize liquidity. The Canary Tier informs the Prize Pool as to whether it’s worth increasing the number of prize tiers. The canary tier’s role is to let us know whether it’s worth offering n+1 tiers of prizes”.</p>\n</blockquote>\n<p>The intended behaviour is that the number of tiers only increases if a high enough portion of both the highest non-canary tier prizes and the canary tier prizes are claimed, so that prizes scale with demand and liquidity. However, there is a bug that causes the number of tiers to increase if at least 1 canary prize is claimed. Therefore, it is highly likely that it will take just 12 draws to reach the cap of 15 prize tiers (or an attacker could force the situation by claiming canary prizes); at which point the prize sizes will be broken, based on the liquidity provided and the protocol will become almost unusable.</p>\n<h3 id=\"proof-of-concept-20\" style=\"position:relative;\"><a href=\"#proof-of-concept-20\" aria-label=\"proof of concept 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>When a draw has finished/elapsed, the draw manager closes the draw by calling <code>closeDraw</code>. During this closing process the next number of tiers is computed:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"57\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">_nextNumberOfTiers = _computeNextNumberOfTiers(_numTiers);</span></span></code></pre>\n<p>Before we dive into this computation, it’s worth exploring the <code>claimPrize</code> method. Whenever a prize is claimed, there is a <code>largestTierClaimed</code> state variable that is set to the highest tier that has been claimed for; which can include the canary tier:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"58\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (largestTierClaimed &lt; _tier) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      largestTierClaimed = _tier;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>Now, the issue titled in this report exists because of how the next number of tiers is calculated in the <code>_computeNextNumberOfTiers</code> function:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"59\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function _computeNextNumberOfTiers(uint8 _numTiers) internal view returns (uint8) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    UD2x18 _claimExpansionThreshold = claimExpansionThreshold;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint8 _nextNumberOfTiers = largestTierClaimed + 2; // canary tier, then length</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _nextNumberOfTiers = _nextNumberOfTiers &gt; MINIMUM_NUMBER_OF_TIERS</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      ? _nextNumberOfTiers</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      : MINIMUM_NUMBER_OF_TIERS;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (_nextNumberOfTiers &gt;= MAXIMUM_NUMBER_OF_TIERS) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      return MAXIMUM_NUMBER_OF_TIERS;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // check to see if we need to expand the number of tiers</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _nextNumberOfTiers &gt;= _numTiers &amp;&amp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      canaryClaimCount &gt;=</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      fromUD60x18(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        intoUD60x18(_claimExpansionThreshold).mul(_canaryPrizeCountFractional(_numTiers).floor())</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      ) &amp;&amp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      claimCount &gt;=</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      fromUD60x18(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        intoUD60x18(_claimExpansionThreshold).mul(toUD60x18(_estimatedPrizeCount(_numTiers)))</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // increase the number of tiers to include a new tier</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _nextNumberOfTiers = _numTiers + 1;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    return _nextNumberOfTiers;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p>For the sake of argument, let’s say the prize pool had 3 tiers, so the canary tier is tier 2. If there is at least 1 canary tier prize that has been claimed for the previous draw, then <code>largestTierClaimed = 2</code>; therefore, <code>_nextNumberOfTiers = 4</code>. What’s interesting here, is that even if the check to expand the number of tiers fails, we still return <code>_nextNumberOfTiers</code>, which has just been set to 4. So we’re expanding the number of tiers even if the claim count isn’t higher than the claim expansion thresholds.</p>\n<p>I have made a tiny change to the existing test suite to demonstrate that the number of tiers will increase with just 1 canary prize claim. It can be executed with <code>forge test -vvv --match-path test/PrizePool.t.sol</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"60\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">diff --git a/test/PrizePool.t.sol b/test/PrizePool.t.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">index 45d8606..36063eb 100644</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--- a/test/PrizePool.t.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+++ b/test/PrizePool.t.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">@@ -561,25 +561,12 @@ contract PrizePoolTest is Test {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   function testCloseAndOpenNextDraw_expandingTiers() public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     contribute(1e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     closeDraw(1234);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-    mockTwab(address(this), address(this), 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-    claimPrize(address(this), 0, 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-    mockTwab(address(this), sender1, 1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-    claimPrize(sender1, 1, 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-    mockTwab(address(this), sender2, 1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-    claimPrize(sender2, 1, 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-    mockTwab(address(this), sender3, 1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-    claimPrize(sender3, 1, 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-    mockTwab(address(this), sender4, 1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-    claimPrize(sender4, 1, 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    // Just 1 canary prize tier claim increases the number of tiers</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     // canary tiers</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     mockTwab(address(this), sender5, 2);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     claimPrize(sender5, 2, 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-    mockTwab(address(this), sender6, 2);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-    claimPrize(sender6, 2, 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-    vm.expectEmit();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-    emit DrawClosed(2, 245, 3, 4, 7997159090909503, UD34x4.wrap(7357954545454530000), prizePool.lastClosedDrawEndedAt());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     closeDraw(245);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     assertEq(prizePool.numberOfTiers(), 4);</span></span></code></pre>\n<h3 id=\"tools-used-8\" style=\"position:relative;\"><a href=\"#tools-used-8\" aria-label=\"tools used 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Foundry</p>\n<h3 id=\"recommended-mitigation-steps-21\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-21\" aria-label=\"recommended mitigation steps 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The <code>_computeNextNumberOfTiers</code> logic should be updated to the below:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"61\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">diff --git a/src/PrizePool.sol b/src/PrizePool.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">index a42a27e..016124a 100644</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--- a/src/PrizePool.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+++ b/src/PrizePool.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">@@ -791,19 +791,22 @@ contract PrizePool is TieredLiquidityDistributor {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     // check to see if we need to expand the number of tiers</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-    if (</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-      _nextNumberOfTiers &gt;= _numTiers &amp;&amp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-      canaryClaimCount &gt;=</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-      fromUD60x18(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-        intoUD60x18(_claimExpansionThreshold).mul(_canaryPrizeCountFractional(_numTiers).floor())</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-      ) &amp;&amp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-      claimCount &gt;=</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-      fromUD60x18(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-        intoUD60x18(_claimExpansionThreshold).mul(toUD60x18(_estimatedPrizeCount(_numTiers)))</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-      )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-    ) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-      // increase the number of tiers to include a new tier</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-      _nextNumberOfTiers = _numTiers + 1;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    if (_nextNumberOfTiers &gt; _numTiers) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+      if (canaryClaimCount &gt;=</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        fromUD60x18(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+          intoUD60x18(_claimExpansionThreshold).mul(_canaryPrizeCountFractional(_numTiers).floor())</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        ) &amp;&amp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        claimCount &gt;=</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        fromUD60x18(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+          intoUD60x18(_claimExpansionThreshold).mul(toUD60x18(_estimatedPrizeCount(_numTiers)))</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+      ) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        // increase the number of tiers to include a new tier</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        return _numTiers + 1;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+      }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+      else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        return _numTiers;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+      }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     return _nextNumberOfTiers;</span></span></code></pre>\n<h3 id=\"assessed-type-16\" style=\"position:relative;\"><a href=\"#assessed-type-16\" aria-label=\"assessed type 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Math</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/332#issuecomment-1644654925\">asselstine (PoolTogether) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs\">PoolTogether mitigated</a>:</strong></p>\n<blockquote>\n<p>Superseceded by the simplification of tier expansion logic.<br>\nPR: <a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/pull/17\">https://github.com/GenerationSoftware/pt-v5-prize-pool/pull/17</a></p>\n</blockquote>\n<p><strong>Status</strong>: Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/91\">0xStalin</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/102\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/54\">rvierdiiev</a>.</p>\n<hr>\n<h2 id=\"m-15-tiers-can-be-maintained-active-to-give-unfair-advantage-to-user-through-dos\" style=\"position:relative;\"><a href=\"#m-15-tiers-can-be-maintained-active-to-give-unfair-advantage-to-user-through-dos\" aria-label=\"m 15 tiers can be maintained active to give unfair advantage to user through dos permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/331\">[M-15] Tiers can be maintained active to give unfair advantage to user through DoS</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/331\">0x3e84fa45</a></em></p>\n<p>Tiers can be maintained active by claiming a single prize of the last tier at a loss. The protocol will close tiers of the next draw based on the <a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L784\">largest tier claimed</a> of the draw being closed, which is <a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L446\">registered during the claiming of the prizes</a>.</p>\n<p>This is a symptom that liquidity is being spread too thin on the last tier, and is no longer profitable for bots to claim prizes for users since their gas costs are over the claiming fees they earn.</p>\n<p>The closing of a tier is meant to increase <code>maxFee</code>, which is the highest price a claiming fee can achieve in the reverse Dutch Auction mechanism; which in the current draw, isn’t enough for the bot to be profitable.</p>\n<p>The <a href=\"https://github.com/GenerationSoftware/pt-v5-claimer/blob/57a381aef690a27c9198f4340747155a71cae753/src/Claimer.sol#L169C1-L177C4\"><code>maxFee</code> is computed based on the last active tier’s prize size</a>, and by lowering the amount of tiers, the liquidity is going to get concentrated in less tiers and in less prizes (since the number of prizes is <code>4^tierNumber</code>); thus, making the bots profitable again and incentivizing them to claim prizes for users.</p>\n<p>During the draw where there are no incentives for bots to claim prizes, prizes won’t get claimed; which means that if someone won a high prize from a low tier, they would have to manually claim it. Otherwise, the liquidity of that prize will continue onto the next draw, leaving the user without a possibility of claiming their prize once the draw has passed.</p>\n<p><strong>A malicious actor that has deposited liquidity in the vaults that contribute to the prize pool could take advantage of this mechanic.</strong></p>\n<p>By having a bot that in this closing tier state claim their prizes when available and claim a single prize from the highest tier, they are able to maintain the tier active; which will cause following draws to fall again into the state where bots don’t claim prizes. This hugely decreases the probability of winning for users that don’t have a claiming bot while giving the malicious actor an unfair advantage.</p>\n<h3 id=\"proof-of-concept-21\" style=\"position:relative;\"><a href=\"#proof-of-concept-21\" aria-label=\"proof of concept 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><code>Draw 0</code>: <code>closeDraw</code> has just been executed and the remaining liquidity from the previous draw with the newly added liquidity for this draw computes a <code>maxFee</code> that isn’t enough to cover gas costs for bots to claim prizes. Therefore, the last tier is supposed to be closed. A malicious actor can claim a random single prize from the last tier at a loss to maintain the tier active, also claiming any prizes they may have won.</p>\n<p><code>Draw 1</code>: the new liquidity is added to the system, which will make the last tier’s prize size increase, and subsequently, the <code>maxFee</code> will increase. Depending on how much liquidity is added, <code>maxFee</code> will or won’t be enough for bots to start claiming prizes, since the last tier has accumulated the liquidity of two draws.</p>\n<p>It could be the case that the added liquidity isn’t enough and creates a draw state similar to <code>draw 0</code>. To continue with the example, let’s assume that the accumulated liquidity of two draws computes a <code>maxFee</code> that is enough to incentivize bots to claim prizes.</p>\n<p><code>Draw 1</code> behaves as expected, which means that the last tier’s liquidity would get claimed, and the following draw would rely mostly on the newly added liquidity. “Mostly” since there will be a remanent part of liquidity from the prizes that haven’t been won.</p>\n<p><code>Draw 2</code>: The situation of <code>draw 0</code> repeats itself and the added liquidity on this draw is not concentrated enough to incentivize bots to claim prizes. The malicious actor claims a single prize at a loss again, to keep the tier active, also claiming any prizes they may have won.</p>\n<p>This results in a situation where, depending on how much liquidity is added to each draw, many draws could result as inactive. Meaning, that unless users claim their own prizes, no one is going to claim them; while the malicious actor has an advantage, since their bot will claim their prizes, apart from maintaining the highest tier active.</p>\n<h3 id=\"recommended-mitigation-steps-22\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-22\" aria-label=\"recommended mitigation steps 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Change the mechanism by which <code>largestTierClaimed</code> is set, so that it’s resistant to a single user performing a claim.</p>\n<h3 id=\"assessed-type-17\" style=\"position:relative;\"><a href=\"#assessed-type-17\" aria-label=\"assessed type 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>DoS</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/331#issuecomment-1644654806\">asselstine (PoolTogether) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/331#issuecomment-1666978581\">Picodes (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>It seems to me that Medium severity is more appropriate here, as the profitability and the damage done by this attack scenario are hypothetical. It assumes that it is worth claiming prizes at a loss of, say <code>maxFeePortionOfPrize * prize</code>, to increase the attacker’s chances of winning. The damage is that users not claiming their prize (which requires multiple winners, as the attacker is claiming one price) will lose it.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs\">PoolTogether mitigated</a>:</strong></p>\n<blockquote>\n<p>Improved tier shrinking, retention, and expansion logic.<br>\nPR: <a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/pull/17\">https://github.com/GenerationSoftware/pt-v5-prize-pool/pull/17</a></p>\n</blockquote>\n<p><strong>Status</strong>: Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/93\">0xStalin</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/101\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/55\">rvierdiiev</a>.</p>\n<hr>\n<h2 id=\"m-16-the-threshold-check-for-adding-of-new-tiers-is-skipped-when-_nextnumberoftiers-is-at-the-maximum-amount\" style=\"position:relative;\"><a href=\"#m-16-the-threshold-check-for-adding-of-new-tiers-is-skipped-when-_nextnumberoftiers-is-at-the-maximum-amount\" aria-label=\"m 16 the threshold check for adding of new tiers is skipped when _nextnumberoftiers is at the maximum amount permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/314\">[M-16] The threshold check for adding of new tiers is skipped when <code>_nextNumberOfTiers</code> is at the maximum amount</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/314\">yixxas</a></em></p>\n<p>The wrong implementation allows a new tier to be added as the threshold check is not done when we currently have 14 tiers. This means, that with just a single canary claim, a new tier will be added when number of tiers <code>=</code> 14.</p>\n<h3 id=\"proof-of-concept-22\" style=\"position:relative;\"><a href=\"#proof-of-concept-22\" aria-label=\"proof of concept 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>In order for the prize pool to add new tiers, the normal prize claim count and canary tier claim count must pass a certain threshold. This check is done by the below code snippet:</p>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L794-L804\">PrizePool.sol#L794-L804</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"62\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_nextNumberOfTiers</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">_numTiers</span><span class=\"mtk1\"> &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">canaryClaimCount</span><span class=\"mtk1\"> &gt;=</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">fromUD60x18</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">intoUD60x18</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_claimExpansionThreshold</span><span class=\"mtk1\">).</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk11\">_canaryPrizeCountFractional</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_numTiers</span><span class=\"mtk1\">).</span><span class=\"mtk11\">floor</span><span class=\"mtk1\">())</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ) &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">claimCount</span><span class=\"mtk1\"> &gt;=</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">fromUD60x18</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">intoUD60x18</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_claimExpansionThreshold</span><span class=\"mtk1\">).</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk11\">toUD60x18</span><span class=\"mtk1\">(</span><span class=\"mtk11\">_estimatedPrizeCount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_numTiers</span><span class=\"mtk1\">)))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) {</span></span></span></code></pre>\n<p>However, in the case where <code>_nextNumberOfTiers >= MAXIMUM_NUMBER_OF_TIERS</code>, <code>MAXIMUM_NUMBER_OF_TIERS</code> this is instantly returned, skipping this check.</p>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L784C1-L791C6\">PrizePool.sol#L784C1-L791C6</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"63\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_nextNumberOfTiers</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">largestTierClaimed</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">2</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// canary tier, then length</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_nextNumberOfTiers</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_nextNumberOfTiers</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">MINIMUM_NUMBER_OF_TIERS</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ? </span><span class=\"mtk12\">_nextNumberOfTiers</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      : </span><span class=\"mtk12\">MINIMUM_NUMBER_OF_TIERS</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_nextNumberOfTiers</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">MAXIMUM_NUMBER_OF_TIERS</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAXIMUM_NUMBER_OF_TIERS</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>As seen from the above code, if we currently have 14 tiers and the canary tier is claimed in this draw, hence <code>largestTierClaimed = 13</code>, then we have <code>_nextNumberOfTiers = 15</code>. Since <code>MAXIMUM_NUMBER_OF_TIERS == 15</code>, we <code>return MAXIMUM_NUMBER_OF_TIERS</code> and the new number of tiers is going to be 15, even if the number of claims for this draw does not pass the threshold check.</p>\n<h3 id=\"recommended-mitigation-steps-23\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-23\" aria-label=\"recommended mitigation steps 23 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Make sure that we do the threshold check specifically, in the case where <code>_numTiers == 14</code> and <code>canaryClaimCount >= 1</code>.</p>\n<h3 id=\"assessed-type-18\" style=\"position:relative;\"><a href=\"#assessed-type-18\" aria-label=\"assessed type 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Invalid Validation</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/314#issuecomment-1644577015\">asselstine (PoolTogether) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs\">PoolTogether mitigated</a>:</strong></p>\n<blockquote>\n<p>Simplified tier expansion logic.<br>\nPR: <a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/pull/17\">https://github.com/GenerationSoftware/pt-v5-prize-pool/pull/17</a></p>\n</blockquote>\n<p><strong>Status</strong>: Mitigation error. Full details in report from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/104\">dirk_y</a> and in the <a href=\"#mitigation-review\">Mitigation Review</a> section below.</p>\n<hr>\n<h2 id=\"m-17-vaultfactory-allows-deployment-of-vaults-with-non-authentic-twabcontroller-and-prizepool\" style=\"position:relative;\"><a href=\"#m-17-vaultfactory-allows-deployment-of-vaults-with-non-authentic-twabcontroller-and-prizepool\" aria-label=\"m 17 vaultfactory allows deployment of vaults with non authentic twabcontroller and prizepool permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/300\">[M-17] <code>VaultFactory</code> allows deployment of vaults with non-authentic <code>TwabController</code> and <code>PrizePool</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/300\">Jeiwan</a>, also found by dev0cloo (<a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/474\">1</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/462\">2</a>), <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/447\">jaraxxus</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/437\">0xSmartContract</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/324\">oxchsyston</a>, 0xStalin (<a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/239\">1</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/232\">2</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/29\">3</a>), <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/233\">keccak123</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/222\">dirk_y</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/193\">btk</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/181\">neumo</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/158\">grearlake</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/114\">3docSec</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/82\">rvierdiiev</a>, and <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/66\">ABAIKUNANBAEV</a></em></p>\n<p>A malicious vault can be deployed via the official <code>VaultFactory</code> contract. Users may lose funds while interacting with such vaults.</p>\n<h3 id=\"proof-of-concept-23\" style=\"position:relative;\"><a href=\"#proof-of-concept-23\" aria-label=\"proof of concept 23 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/VaultFactory.sol#L55\">VaultFactory.deployVault</a> function allows deploying <code>Vault</code> contracts. The factory contract maintains a <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/VaultFactory.sol#L32-L36\">mapping to verify that a vault has been deployed via the factory</a>. This allows users to check the authenticity of a vault to ensure the that implementation of a vault is authentic (i.e. not altered/malicious).</p>\n<p>However, the business logic of vaults is split into multiple contracts: <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol\">Vault</a>, <a href=\"https://github.com/GenerationSoftware/pt-v5-twab-controller/blob/0145eeac23301ee5338c659422dd6d69234f5d50/src/TwabController.sol\">TwabController</a>, and <a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol\">PrizePool</a>. <code>TwabController</code> tracks the historical balances of users to determine their chances of winning prizes. <code>PrizePool</code> runs regular draws and distributes prizes among winners. Thus, it’s critical that in every authentic <code>Vault</code> contract, the implementations of <code>TwabController</code> and <code>PrizePool</code> are also authentic. Otherwise, a malicious actor could deploy an authentic vault via the official <code>VaultFactory</code> and provide malicious <code>TwabController</code> and <code>PrizePool</code> contracts; which can incorrectly determine user balances, favors some specific addresses when determining winners, or steals the prize token. In the current implementation, users are be able to check the authenticity of a vault contract, but not the authenticity of the <code>TwabController</code> and the <code>PrizePool</code> contracts that a vault integrates with.</p>\n<h3 id=\"recommended-mitigation-steps-24\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-24\" aria-label=\"recommended mitigation steps 24 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider implementing <code>TwabController</code> and <code>PrizePool</code> factory contracts. In the contracts, consider tracking the addresses of the deployed <code>TwabController</code> and <code>PrizePool</code> contracts. In the <code>VaultFactory.deployVault</code> function, consider checking that the passed <code>_twabController</code> and <code>_prizePool</code> address were deployed via the respective factory contracts.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/300#issuecomment-1666995677\">Picodes (judge) commented</a>:</strong></p>\n<blockquote>\n<p>See <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/324#issuecomment-1637047041\">Issue #324</a>.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/324#issuecomment-1644594809\">asselstine (PoolTogether) acknowledged and commented via duplicate issue #324</a>:</strong></p>\n<blockquote>\n<p>This the point of V5: we are replacing protocol gatekeeping with curation by front-ends.</p>\n<p>The responsibility of curation will rest on front-ends, who will curate which vaults they show their users.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-18-the-exchange-rate-change-in-the-case-of-lossy-strategy-will-cause-the-vault-to-be-under-collateralized-for-generic-erc4626-yield-vaults\" style=\"position:relative;\"><a href=\"#m-18-the-exchange-rate-change-in-the-case-of-lossy-strategy-will-cause-the-vault-to-be-under-collateralized-for-generic-erc4626-yield-vaults\" aria-label=\"m 18 the exchange rate change in the case of lossy strategy will cause the vault to be under collateralized for generic erc4626 yield vaults permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/256\">[M-18] The exchange rate change in the case of Lossy Strategy will cause the Vault to be under-collateralized for generic ERC4626 Yield Vaults</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/256\">GalloDaSballo</a></em></p>\n<p>For Yield Vaults that use Lossy Strategies, the PT Vault will burn more Yield Vault Shares than intended when processing a withdrawal, socializing a loss at the advantage of early withdrawers.</p>\n<p><code>withdraw</code> calls <code>_convertToShares</code>:</p>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L517\">https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L517</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"64\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_shares</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_convertToShares</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_assets</span><span class=\"mtk1\">, </span><span class=\"mtk10\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Rounding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Up</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Which uses the <code>_currentExchangeRate()</code>. This in turn, computes the <code>withdrawableAssets</code> by fetching <code>yieldVault.maxWithdraw</code> and then mapping the principal vs. the <code>totalSupply</code>.</p>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L1169C1-L1187C4\">https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L1169C1-L1187C4</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"65\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_yieldVault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">maxWithdraw</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">_totalSupplyToAssets</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> - (</span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">_totalSupplyToAssets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_totalSupplyAmount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulDiv</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_assetUnit</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_totalSupplyAmount</span><span class=\"mtk1\">, </span><span class=\"mtk10\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Rounding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Down</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>This calculation is based on <code>maxWithdraw</code>, which is a <code>view</code> function.</p>\n<p>Most implementations of <code>maxWithdraw</code> will simply map the available tokens to the shares owned by the owner. See OZ for example:</p>\n<p><a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/121be5dd09caa2f7ce731f0806b0e14761023bd6/contracts/token/ERC20/extensions/ERC4626.sol#L141-L143\">https://github.com/OpenZeppelin/openzeppelin-contracts/blob/121be5dd09caa2f7ce731f0806b0e14761023bd6/contracts/token/ERC20/extensions/ERC4626.sol#L141-L143</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"66\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">maxWithdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_convertToAssets</span><span class=\"mtk1\">(</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">), </span><span class=\"mtk10\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Rounding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Floor</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>Or similarly, <a href=\"https://github.com/yearn/yearn-vaults-v3/blob/1e6bc67cf70352e9567e67404d73856cc343b634/contracts/VaultV3.vy#L559-L562\">Yearn V3</a>.</p>\n<p>Due to the implementation, losses can be applied during <code>YieldVault.withdraw</code>, causing the burning of more shares than intended.</p>\n<p>Because the PT Vault computes the shares to burn before accounting for a potential loss:</p>\n<ul>\n<li>No loss will be accounted for in <code>maxWithdraw</code> (since it will use static value for assets in the vault and assets in the strategy).</li>\n<li>The loss will be locked during <code>_withdraw</code>, but it will not be checked. The specifics of the loss are that it will cause burning of more shares in order to receive the intended <code>assets</code>.</li>\n<li>This will cause the user to pay <code>shares</code> from PT Vault.</li>\n<li>But it will cause PT Vault to pay more <code>yieldVault Shares</code> than intended, effectively diluting everyone else and socializing the losses on the laggards.</li>\n</ul>\n<h3 id=\"proof-of-concept-24\" style=\"position:relative;\"><a href=\"#proof-of-concept-24\" aria-label=\"proof of concept 24 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof Of Concept</h3>\n<ul>\n<li>Call <code>withdraw</code>.</li>\n<li>This will compute the shares to burn to the user via <code>_convertToShares</code>.</li>\n<li>PT Vault will call <code>YieldVault.withdraw</code> with the amount necessary to withdraw.</li>\n<li>The Vault will take a loss. The loss will cause more shares from PT Vault to be burned, socializing a loss to other depositors.</li>\n</ul>\n<h3 id=\"mitigation\" style=\"position:relative;\"><a href=\"#mitigation\" aria-label=\"mitigation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation</h3>\n<p>Ensures that the PPFS of the Yield Vault doesn’t decrease, or add functions to handle lossy withdrawals.</p>\n<h3 id=\"assessed-type-19\" style=\"position:relative;\"><a href=\"#assessed-type-19\" aria-label=\"assessed type 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>ERC4626</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/256#issuecomment-1642899385\">asselstine (PoolTogether) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/256#issuecomment-1674020085\">PierrickGT (PoolTogether) commented</a>:</strong></p>\n<blockquote>\n<p>I don’t entirely understand the issue here; to me it looks like this is the intended behavior.</p>\n<p>Users knowingly deposit in a Vault relying on a <code>YieldVault</code> that employs Lossy Strategies to generate yield. Let’s say for example, an option protocol, the position of the Vault loses value so all shares are backed by less underlying assets. When withdrawing, people will only be able to withdraw their shares of deposits, which indeed socializes the loss.</p>\n<p>I think for this kind of YieldVaults, we will need to develop custom Vaults,  because it’s a pretty specific use case.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs\">PoolTogether mitigated</a>:</strong></p>\n<blockquote>\n<p>Redeemed underlying liquidity using shares, not assets directly. This socializes losses, if any.<br>\nPR: <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/27\">https://github.com/GenerationSoftware/pt-v5-vault/pull/27</a></p>\n</blockquote>\n<p><strong>Status</strong>: Not fully mitigated. Full details in report from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/97\">dirk_y</a> and in the <a href=\"#mitigation-review\">Mitigation Review</a> section below.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/256#issuecomment-1687247658\">PierrickGT (PoolTogether) commented</a>:</strong></p>\n<blockquote>\n<p>Working PR here: <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/37\">https://github.com/GenerationSoftware/pt-v5-vault/pull/37</a>.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-19-silent-overflow-could-alter-computation-when-calculating-the-vaultportion-in-the-prizepool-contract\" style=\"position:relative;\"><a href=\"#m-19-silent-overflow-could-alter-computation-when-calculating-the-vaultportion-in-the-prizepool-contract\" aria-label=\"m 19 silent overflow could alter computation when calculating the vaultportion in the prizepool contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/243\">[M-19] Silent overflow could alter computation when calculating the <code>vaultPortion</code> in the <code>PrizePool</code> contract</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/243\">0xStalin</a></em></p>\n<p>If an overflow happens, the computed value of the vault portion will be a totally different value than what should really be; which would end up causing the rewards to disperse and be lower for the draw that was used to compute the vault portion.</p>\n<p>Note: Even though <a href=\"https://gist.github.com/itsmetechjay/e7fd03943bbacff1984a33b9f89c4149#low-4-use-safecast-to-safely-downcast-variables\">the bot reported issues about downcasting variables</a>, it didn’t mention this specific unsafe casting; which if an overflow occurs, could cause a huge impact on the calculation of the vault portions.</p>\n<h3 id=\"proof-of-concept-25\" style=\"position:relative;\"><a href=\"#proof-of-concept-25\" aria-label=\"proof of concept 25 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>When computing the <code>vaultPortion</code> to the PrizePool over a specific duration in draw, the values of the <a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L963-L968\"><code>vaultContributed</code></a> &#x26; <a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L951-L956\"><code>totalContributed</code></a> variables are computed on the <code>DrawAccumulatorLib</code> library, and <a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/libraries/DrawAccumulatorLib.sol#L166-L307\">they are computed and returned as <code>uint256</code> values.</a></p>\n<p>The issue is, that in the <code>PrizePool::_getVaultPortion()</code> the <code>vaultContributed</code> &#x26; <code>totalContributed</code> variables are unsafely cast from uint256 to int256, which could lead to a silent overflow if any of the two original values don’t fit on an <code>int256</code>.</p>\n<p>As a result of a silent overflow, the computed value of the vault portion will be a totally different value than what should really be; which would end up causing the rewards to disperse and be lower for the draw that was used to compute the vault portion.</p>\n<h3 id=\"recommended-mitigation-steps-25\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-25\" aria-label=\"recommended mitigation steps 25 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Make sure to implement a safe cast that checks if overflows occur to prevent computing a totally different value than what it should really be. Use <code>OZ safeCast</code> library for this type of operation.</p>\n<h3 id=\"assessed-type-20\" style=\"position:relative;\"><a href=\"#assessed-type-20\" aria-label=\"assessed type 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Under/Overflow</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/243#issuecomment-1642897877\">asselstine (PoolTogether) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>The <code>DrawAccumulator</code> stores the available balance as <code>uint96</code>, but we could definitely tighten up the data types and make casting safe.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs\">PoolTogether mitigated</a>:</strong></p>\n<blockquote>\n<p>Added SafeCast.<br>\nPR: <a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/pull/22\">https://github.com/GenerationSoftware/pt-v5-prize-pool/pull/22</a></p>\n</blockquote>\n<p><strong>Status</strong>: Mitigation confirmed. Full details in report from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/95\">0xStalin</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/19\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/58\">rvierdiiev</a>.</p>\n<hr>\n<h2 id=\"m-20-improper-handling-of-cases-when-withdrawable-assets--0\" style=\"position:relative;\"><a href=\"#m-20-improper-handling-of-cases-when-withdrawable-assets--0\" aria-label=\"m 20 improper handling of cases when withdrawable assets  0 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/180\">[M-20] Improper handling of cases when withdrawable assets = 0</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/180\">ktg</a></em></p>\n<ul>\n<li>Improper handling of cases when withdrawable assets = 0.</li>\n<li>The vault will not function correctly.</li>\n</ul>\n<h3 id=\"proof-of-concept-26\" style=\"position:relative;\"><a href=\"#proof-of-concept-26\" aria-label=\"proof of concept 26 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The functions <code>_currentExchangeRate</code> and <code>_isVaultCollateralized</code> of <code>Vault</code> are implemented as follows:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"67\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_currentExchangeRate</span><span class=\"mtk1\">() </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_totalSupplyAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_totalSupply</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_totalSupplyToAssets</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_convertToAssets</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_totalSupplyAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_lastRecordedExchangeRate</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Rounding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Down</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_yieldVault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">maxWithdraw</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">_totalSupplyToAssets</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> - (</span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">_totalSupplyToAssets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_totalSupplyAmount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulDiv</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_assetUnit</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_totalSupplyAmount</span><span class=\"mtk1\">, </span><span class=\"mtk10\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Rounding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Down</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_assetUnit</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_isVaultCollateralized</span><span class=\"mtk1\">() </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_currentExchangeRate</span><span class=\"mtk1\">() &gt;= </span><span class=\"mtk12\">_assetUnit</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>The function calculates the exchange rate between the amount of assets withdrawable from the <code>YieldVault</code> and the amount of shares minted by this Vault.</p>\n<p>However, if <code>_withdrawableAssets</code> is 0, then the function returns <code>_assetUnit</code> (which means 1-1 ratio). This means, that even when the <code>vault</code> has no withdrawable assets from <code>_yieldVault</code>, it’s still considered collateralized.</p>\n<p>To illustrate the oddity of this special case, consider when <code>_withdrawableAssets</code> <code>= 1</code> and <code>_totalSupplyAmount</code> <code>> 0</code>; in this scenario, <code>_currentExchangeRate</code> returns 0 and the vault is considered under-collateralized (since <code>1 &#x3C;</code> <code>_assetUnit</code>). However, if <code>_withdrawableAssets</code> <code>= 0</code>, the vault is considered collateralized.</p>\n<p><strong>This case has profound impact since a lot of vault logic is based on the vault’s collateralized status.</strong></p>\n<p>Below is a POC for the above example. For ease of testing, let’s place these 2 test cases\nin file <code>vault/test/unit/Vault/Deposit.t.sol</code> under contract <code>VaultDepositTest</code>,\nthen test them using commands:</p>\n<ul>\n<li><code>forge test --match-path test/unit/Vault/Deposit.t.sol --match-test testOneWithdrawableAmount -vvvv</code></li>\n<li><code>forge test --match-path test/unit/Vault/Deposit.t.sol --match-test testZeroWithdrawableAmount -vvvv</code></li>\n</ul>\n<p><code>testOneWithdrawableAmount</code> is to demonstrate when <code>_withdrawableAssets</code> <code>= 1</code> and the vault is considered not collateralized.\n<code>testZeroWithdrawableAmount</code> is to demonstrate when <code>_withdrawableAssets</code> <code>= 0</code> and the vault is considered collateralized.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"68\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testZeroWithdrawableAmount</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1000e18</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">underlyingAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">underlyingAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">), </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Now make the withdrawable asset = 0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Burn the balance of yieldVault</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">yieldVaultAsset</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">underlyingAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">yieldVault</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">underlyingAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">burn</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">yieldVault</span><span class=\"mtk1\">), </span><span class=\"mtk12\">yieldVaultAsset</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">underlyingAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">yieldVault</span><span class=\"mtk1\">)), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Although the vault has no asset withdrawable in yieldVault</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// the exchange rate is 10**18 = assetUnit and the vault is &quot;collateralized&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">yieldVault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">maxWithdraw</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">)), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">exchangeRate</span><span class=\"mtk1\">(), </span><span class=\"mtk7\">10</span><span class=\"mtk1\">**</span><span class=\"mtk7\">18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">isVaultCollateralized</span><span class=\"mtk1\">(), </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testOneWithdrawableAmount</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1000e18</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">underlyingAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">underlyingAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">), </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Now make the withdrawable asset = 0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Burn the balance of yieldVault</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">yieldVaultAsset</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">underlyingAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">yieldVault</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">underlyingAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">burn</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">yieldVault</span><span class=\"mtk1\">), </span><span class=\"mtk12\">yieldVaultAsset</span><span class=\"mtk1\"> -</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">underlyingAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">yieldVault</span><span class=\"mtk1\">)), </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// vault only has 1 asset token withdrawable, and the exchangeRate is 0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// the vault is not collateralized</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">yieldVault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">maxWithdraw</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">)), </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">exchangeRate</span><span class=\"mtk1\">(), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">isVaultCollateralized</span><span class=\"mtk1\">(), </span><span class=\"mtk4\">false</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-26\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-26\" aria-label=\"recommended mitigation steps 26 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Since <code>_withdrawableAssets</code> is the dividend, there seems to be no harm in removing the check if <code>_withdrawableAssets</code> <code>= 0</code>. Therefore, I recommend removing it from the condition.</p>\n<h3 id=\"assessed-type-21\" style=\"position:relative;\"><a href=\"#assessed-type-21\" aria-label=\"assessed type 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Invalid Validation</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/180#issuecomment-1642684778\">asselstine (PoolTogether) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/180#issuecomment-1666959751\">Picodes (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>There is definitely a bug here, but I don’t see why it should be high severity.\n“This case has a profound impact since a lot of vault logic is based on the vault’s collateralized status” is a bit light to pass the burden or proof. At first sight, as there are no funds in the vault anymore, there is no loss of funds. Then there is the case where assets are re-added to the vault for some reason; but this would be a Medium severity scenario, considering it’s very unlikely and not described by the report.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/180#issuecomment-1672472579\">ktg9 (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Hi @Picodes, thank you for your response!</p>\n<p>Sorry I didn’t make it clearer. As you can see in the report, the affected function is <code>_currentExchangeRate</code>, so not only is the <code>Vault</code> incorrectly specified as collateralized, the <code>currentExchangeRate</code> also <code>= 1</code> (<code>assetUnit</code>). These 2 functions affect many other functions, for example:</p>\n<ul>\n<li>Function <code>mintYieldFee</code> requires that vault is collateralized, so a user can mint the yield fee even when it’s not.</li>\n<li>Function <code>liquidate</code> requires that vault is collateralized, so a user can liquidate asset even when vault’s withdrawable asset <code>= 0</code>.</li>\n<li>\n<p>For <code>deposit</code> function, first <code>deposit</code> will calculate <code>maxDeposit</code> to limit the input tokens:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"69\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">maxDeposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_isVaultCollateralized</span><span class=\"mtk1\">() ? </span><span class=\"mtk8\">`type(uint96).max`</span><span class=\"mtk1\"> : </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n</li>\n</ul>\n<p>If the Vault is under-collateralized, a user can’t deposit since <code>maxDeposit</code> will return 0; however, a user can still deposit in this case:</p>\n<ul>\n<li>User calls <code>exchangeRate</code> and receives 1, this can lead them to bad decisions.</li>\n</ul>\n<p>To conclude, I agree that this will not lead to direct loss of funds for the vault, but will greatly impact the user, making them send tokens to the vault (through liquidate or deposit) when it’s not collateralized and will potentially suffer economically. I think it should be marked as High severity.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/180#issuecomment-1676025503\">Picodes (judge) commented</a>:</strong></p>\n<blockquote>\n<p>@ktg9 - I still think that the original reports perfectly fit with the definition of Med severity:</p>\n<blockquote>\n<p>“leak value with a hypothetical attack path with stated assumptions, but external requirements”.</p>\n</blockquote>\n<p>The described scenarios require that we are in a situation with <code>withdrawable assets = 0</code> and that some users behave incorrectly. Also note that I can’t consider scenarios that are not described in the original report.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/180#issuecomment-1681398000\">PierrickGT (PoolTogether) commented</a>:</strong></p>\n<blockquote>\n<p>This issue has been fixed and the exchange rate between the Vault and YieldVault is now 1 to 1. We’ve replaced the exchange rate function by a collateral one, which simplifies the conversions from shares to assets and assets to shares.</p>\n<p>If the Vault is collateralized, meaning the amount of withdrawable assets from the YieldVault is greater than the amount of underlying assets supplied to the YieldVault, then users can only withdraw the amount they deposited. Otherwise, any remaining collateral within the YieldVault is available and distributed proportionally among depositors.</p>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/8985bead1be85ae6822cd329933f5a53de05c237/src/Vault.sol#L1208\">https://github.com/GenerationSoftware/pt-v5-vault/blob/8985bead1be85ae6822cd329933f5a53de05c237/src/Vault.sol#L1208</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs\">PoolTogether mitigated</a>:</strong></p>\n<blockquote>\n<p>Vault shares are now 1:1 with an underlying asset, and the exchange logic has been simplified.<br>\nPR: <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/18\">https://github.com/GenerationSoftware/pt-v5-vault/pull/18</a></p>\n</blockquote>\n<p><strong>Status</strong>: Mitigation confirmed. Full details in report from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/89\">dirk_y</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/59\">rvierdiiev</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/78\">0xStalin</a>.</p>\n<hr>\n<h2 id=\"m-21-vault-contribution-calculations-wrongly-include-the-current-round-when-claiming-prizes\" style=\"position:relative;\"><a href=\"#m-21-vault-contribution-calculations-wrongly-include-the-current-round-when-claiming-prizes\" aria-label=\"m 21 vault contribution calculations wrongly include the current round when claiming prizes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/150\">[M-21] Vault contribution calculations wrongly include the current round when claiming prizes</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/150\">dirk_y</a></em></p>\n<h3 id=\"lines-of-code-7\" style=\"position:relative;\"><a href=\"#lines-of-code-7\" aria-label=\"lines of code 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lines of code</h3>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L366\">https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L366</a> <a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L421\">https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L421</a>\n<a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L903-L908\">https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L903-L908</a></p>\n<h3 id=\"impact-8\" style=\"position:relative;\"><a href=\"#impact-8\" aria-label=\"impact 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>When claiming prizes, the higher the contribution percentage of the given vault, the higher the odds of a user contributing to that vault receiving a prize. Because the vault contributions are wrongly calculated, a vault gets credit for distributions that haven’t actually been made yet. A vault can swing the odds in its favour by contributing prize tokens to the prize pool in a recent round before claiming prizes (based on a normal value of alpha). This is particularly important when considering prize tiers that occur frequently (the highest tiers).</p>\n<h3 id=\"proof-of-concept-27\" style=\"position:relative;\"><a href=\"#proof-of-concept-27\" aria-label=\"proof of concept 27 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>A draw is closed by the draw manager by calling <code>closeDraw</code>. During this process, new liquidity is distributed among the tiers to be available for prize claims:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"70\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">_nextDraw(_nextNumberOfTiers, uint96(_contributionsForDraw(lastClosedDrawId + 1)));</span></span></code></pre>\n<p>In the above line, the contributions are calculated based on <code>lastClosedDrawId + 1</code> because <code>lastClosedDrawId</code> has not yet been incremented. It is incremented at the end of the <code>_nextDraw</code> method.</p>\n<p>A prize is claimed when a vault calls (via a claimer) <code>claimPrize</code>. In this process, the contribution percentage of the vault is calculated because it affects the winning region (i.e. odds) for a user:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"71\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">(SD59x18 _vaultPortion, SD59x18 _tierOdds, uint16 _drawDuration) = _computeVaultTierDetails(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      msg.sender,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _tier,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      numberOfTiers,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      lastClosedDrawId</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span></code></pre>\n<p>As can be seen above, the vault portion is calculated based on <code>lastClosedDrawId</code>, which is the value which was incremented when closing the draw previously. This method makes the following underlying call:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"72\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">vaultPortion = _getVaultPortion(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _vault,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      uint16(drawDuration &gt; _lastClosedDrawId ? 0 : _lastClosedDrawId - drawDuration + 1),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _lastClosedDrawId + 1,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      smoothing.intoSD59x18()</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span></code></pre>\n<p>This calculates the value dispersed between a start and end draw INCLUSIVE. Therefore, this is actually calculating the vault contributions based on the current in-progress round as well, which hasn’t yet been dispersed to the tiers. In fact, it also wrongly increments the start round ID.</p>\n<h3 id=\"recommended-mitigation-steps-27\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-27\" aria-label=\"recommended mitigation steps 27 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The <code>_computeVaultTierDetails</code> method should not increment the start and end draw IDs:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"73\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">diff --git a/src/PrizePool.sol b/src/PrizePool.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">index a42a27e..34548c9 100644</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--- a/src/PrizePool.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+++ b/src/PrizePool.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">@@ -902,8 +902,8 @@ contract PrizePool is TieredLiquidityDistributor {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     drawDuration = uint16(TierCalculationLib.estimatePrizeFrequencyInDraws(tierOdds));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     vaultPortion = _getVaultPortion(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">       _vault,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-      uint16(drawDuration &gt; _lastClosedDrawId ? 0 : _lastClosedDrawId - drawDuration + 1),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-      _lastClosedDrawId + 1,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+      uint16(drawDuration &gt; _lastClosedDrawId ? 0 : _lastClosedDrawId - drawDuration),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+      _lastClosedDrawId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">       smoothing.intoSD59x18()</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   }</span></span></code></pre>\n<h3 id=\"assessed-type-22\" style=\"position:relative;\"><a href=\"#assessed-type-22\" aria-label=\"assessed type 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Math</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/150#issuecomment-1641182501\">asselstine (PoolTogether) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs\">PoolTogether mitigated</a>:</strong></p>\n<blockquote>\n<p>Draw query ends on closed draw.<br>\nPR: <a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/pull/10\">https://github.com/GenerationSoftware/pt-v5-prize-pool/pull/10</a></p>\n</blockquote>\n<p><strong>Status</strong>: Mitigation confirmed. Full details in report from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/20\">dirk_y</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/60\">rvierdiiev</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/100\">0xStalin</a>.</p>\n<hr>\n<h2 id=\"m-22-loss-of-precision-leads-to-under-collateralized\" style=\"position:relative;\"><a href=\"#m-22-loss-of-precision-leads-to-under-collateralized\" aria-label=\"m 22 loss of precision leads to under collateralized permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/143\">[M-22] Loss of precision leads to under-collateralized</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/143\">bin2chen</a></em></p>\n<p>Since <code>_yieldVault</code> mostly calculates <code>shares</code> and uses <code>round down</code> when depositing, there is often a <code>1 wei</code> loss of precision, which can cause the <code>vault</code> to go into under-collateralized mode by mistake.</p>\n<h3 id=\"proof-of-concept-28\" style=\"position:relative;\"><a href=\"#proof-of-concept-28\" aria-label=\"proof of concept 28 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>When a user deposits an asset, we update <code>_lastRecordedExchangeRate</code>; the calculation is done by method <code>_currentExchangeRate()</code>.</p>\n<p>The code is as follows:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"74\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_currentExchangeRate</span><span class=\"mtk1\">() </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_totalSupplyAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_totalSupply</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_totalSupplyToAssets</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_convertToAssets</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_totalSupplyAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_lastRecordedExchangeRate</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Rounding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Down</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@&gt;  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_yieldVault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">maxWithdraw</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">_totalSupplyToAssets</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> - (</span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">_totalSupplyToAssets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_totalSupplyAmount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulDiv</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_assetUnit</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_totalSupplyAmount</span><span class=\"mtk1\">, </span><span class=\"mtk10\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Rounding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Down</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_assetUnit</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>This method takes <code>_yieldVault.maxWithdraw(address(this))</code> as the maximum value to calculate the current exchange rate. If the exchange rate is lower than <code>_assetUnit</code>, then it goes into an under-collateralized mode, where it can only be withdrawn, not deposited. So if <code>_yieldVault</code> is losing money, it goes into under-collateralized.</p>\n<p>But there is one missing consideration here:</p>\n<p>As long as <code>_yieldVault</code> is not exclusive, there will be precision loss issues. After <code>_yieldVault.deposit()</code>, <code>maxWithdraw()</code> will lose precision because most vaults will “round down” the shares calculations. For example, depositing <code>1000000000</code>; however, it can only withdraw <code>999999999</code>.</p>\n<p>This leads to the problem that when the first deposit is made, it is likely to go into an under-collateralized mode immediately due to the <code>1 wei</code> loss.</p>\n<p>The following code demonstrates that when a non-exclusive <code>_yieldVault</code>, once Alice first deposits normally, it immediately enters an under-collateralized mode.</p>\n<p>Add to <code>Deposit.t.sol</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"75\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testLossPrecision</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//0.Constructing a yieldVault that is already profitable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">333e18</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">underlyingAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">underlyingAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">yieldVault</span><span class=\"mtk1\">), </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);   </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">yieldVault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">,</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//profitable 0.1e18</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">underlyingAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">yieldVault</span><span class=\"mtk1\">), </span><span class=\"mtk7\">0.1e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//1.alice deposit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">100e18</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">underlyingAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">underlyingAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">), </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">console2</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;deposit:&quot;</span><span class=\"mtk1\">,</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">console2</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;maxWithdraw:&quot;</span><span class=\"mtk1\">,</span><span class=\"mtk12\">yieldVault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">maxWithdraw</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">console2</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;loss :&quot;</span><span class=\"mtk1\">,</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">yieldVault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">maxWithdraw</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">console2</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;isVaultCollateralized:&quot;</span><span class=\"mtk1\">,</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">isVaultCollateralized</span><span class=\"mtk1\">());  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"console\" data-index=\"76\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">$ forge test --match-test testLossPrecision -vvv</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[PASS] testLossPrecision() (gas: 402881)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Logs:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  deposit: 100000000000000000000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  maxWithdraw: 99999999999999999999</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  loss : 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  isVaultCollateralized: false</span></span></code></pre>\n<p>This small loss of precision should not be treated as a loss. We can avoid it by adding <code>1wei</code> when calculating the exchange rate.</p>\n<h3 id=\"recommended-mitigation-steps-28\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-28\" aria-label=\"recommended mitigation steps 28 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Have <code>_yieldVault.maxWithdraw() + 1</code> to avoid loss of precision into an under-collateralized mode.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"77\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_currentExchangeRate</span><span class=\"mtk1\">() </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_totalSupplyAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_totalSupply</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_totalSupplyToAssets</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_convertToAssets</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_totalSupplyAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_lastRecordedExchangeRate</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Rounding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Down</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-   </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_yieldVault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">maxWithdraw</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+   </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_yieldVault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">maxWithdraw</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">_totalSupplyToAssets</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> - (</span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">_totalSupplyToAssets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_totalSupplyAmount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulDiv</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_assetUnit</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_totalSupplyAmount</span><span class=\"mtk1\">, </span><span class=\"mtk10\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Rounding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Down</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_assetUnit</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h3 id=\"assessed-type-23\" style=\"position:relative;\"><a href=\"#assessed-type-23\" aria-label=\"assessed type 23 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Decimal</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/143#issuecomment-1641157818\">asselstine (PoolTogether) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/143#issuecomment-1675562805\">PierrickGT (PoolTogether) commented</a>:</strong></p>\n<blockquote>\n<p>Nice catch.\nSince we don’t have any control over the YieldVault exchange rate, if it gets manipulated at any time, we should revert any deposits where the amount of withdrawable assets from the YieldVault is lower than the expected amount.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs\">PoolTogether mitigated</a>:</strong></p>\n<blockquote>\n<p>Improved vault share / asset calculation.<br>\nPR: <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/18\">https://github.com/GenerationSoftware/pt-v5-vault/pull/18</a></p>\n</blockquote>\n<p><strong>Status</strong>: Not fully mitigated. Full details in report from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/96\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/79\">0xStalin</a>, and in the <a href=\"#mitigation-review\">Mitigation Review</a> section below.</p>\n<hr>\n<h2 id=\"m-23-vault-does-not-conform-to-erc4626\" style=\"position:relative;\"><a href=\"#m-23-vault-does-not-conform-to-erc4626\" aria-label=\"m 23 vault does not conform to erc4626 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/129\">[M-23] Vault does not conform to ERC4626</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/129\">degensec</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/264\">pontifex</a></em></p>\n<h3 id=\"lines-of-code-8\" style=\"position:relative;\"><a href=\"#lines-of-code-8\" aria-label=\"lines of code 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lines of code</h3>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L375-L377\">https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L375-L377</a>\n<a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L383-L385\">https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L383-L385</a></p>\n<h3 id=\"impact-9\" style=\"position:relative;\"><a href=\"#impact-9\" aria-label=\"impact 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p><code>Vault</code> does not conform to ERC4626 which may break external integrations.</p>\n<h3 id=\"proof-of-concept-29\" style=\"position:relative;\"><a href=\"#proof-of-concept-29\" aria-label=\"proof of concept 29 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The <a href=\"https://eips.ethereum.org/EIPS/eip-4626\">ERC4626 specification</a> states that <code>maxDeposit</code> <em>MUST return the maximum amount of assets <code>deposit</code> would allow to be deposited for receiver and not cause a revert, which MUST NOT be higher than the actual maximum that would be accepted</em>.</p>\n<p>Similarly, <code>maxMint</code> <em>MUST return the maximum amount of shares <code>mint</code> would allow to be deposited to receiver and not cause a revert, which MUST NOT be higher than the actual maximum that would be accepted.</em></p>\n<p>The PoolTogether V5 <code>Vault</code> connects to an external ERC4626-compliant Vault (<code>_yieldVault</code>) and deposits incoming assets in it. This means, that <code>maxDeposit</code> and <code>maxMint</code> of the PoolTogether Vault must be constrained by the <code>maxDeposit</code> and <code>maxMint</code> of the external Vault.</p>\n<h3 id=\"tools-used-9\" style=\"position:relative;\"><a href=\"#tools-used-9\" aria-label=\"tools used 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p><a href=\"https://eips.ethereum.org/EIPS/eip-4626\">ERC-4626: Tokenized Vaults</a></p>\n<h3 id=\"recommended-mitigation-steps-29\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-29\" aria-label=\"recommended mitigation steps 29 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Replace the implementation of <code>maxDeposit</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"78\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function maxDeposit(address) public view virtual override returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    return _isVaultCollateralized() ? `type(uint96).max` : 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p>with:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"79\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function maxDeposit(address receiver) public view virtual override returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (!_isVaultCollateralized()) return 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 yvMaxDeposit = _yieldVault.maxDeposit(receiver);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    return yvMaxDeposit &lt; `type(uint96).max` ? yvMaxDeposit : `type(uint96).max`;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p>Analogously, change the implementation of <code>maxMint</code> from:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"80\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function maxMint(address) public view virtual override returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    return _isVaultCollateralized() ? `type(uint96).max` : 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p>to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"81\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function maxMint(address receiver) public view virtual override returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if(!_isVaultCollateralized()) return 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 yvMaxMint = _yieldVault.maxDeposit(receiver);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    return yvMaxMint &lt; `type(uint96).max` ? yvMaxMint : `type(uint96).max`;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<h3 id=\"assessed-type-24\" style=\"position:relative;\"><a href=\"#assessed-type-24\" aria-label=\"assessed type 24 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>ERC4626</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/129#issuecomment-1641138024\">asselstine (PoolTogether) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs\">PoolTogether mitigated</a>:</strong></p>\n<blockquote>\n<p>Fixed compliance with 4626.<br>\nPR: <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/11\">https://github.com/GenerationSoftware/pt-v5-vault/pull/11</a></p>\n</blockquote>\n<p><strong>Status</strong>: Mitigation confirmed. Full details in report from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/75\">0xStalin</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/8\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/62\">rvierdiiev</a>.</p>\n<hr>\n<h2 id=\"m-24-claimerclaimprizes-can-be-front-runned-in-order-to-make-losses-for-the-claim-bot\" style=\"position:relative;\"><a href=\"#m-24-claimerclaimprizes-can-be-front-runned-in-order-to-make-losses-for-the-claim-bot\" aria-label=\"m 24 claimerclaimprizes can be front runned in order to make losses for the claim bot permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/115\">[M-24] <code>Claimer.claimPrizes</code> can be front-runned in order to make losses for the claim bot</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/115\">rvierdiiev</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/283\">MiniGlome</a></em></p>\n<h3 id=\"proof-of-concept-30\" style=\"position:relative;\"><a href=\"#proof-of-concept-30\" aria-label=\"proof of concept 30 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>All prizes in the system should be claimed during the draw period. Anyone can call the <code>claimPrizes</code> function for any winner and prize. But the idea of protocol is to incentivize claim bots to do all claims instead of users. These should benefit from batching claims together in 1 call.</p>\n<p>Also the <code>Claimer</code> contract is using <code>vrgda</code> which can increase/decrease fee for the claimer, depending of amount of already claimed prizes. That actually means, that in case not enough prizes are claimed in some point of time, then the fee will be increased to incentivize more bots.</p>\n<p>So as bots will try to batch a lot of prize claims together, that means that they will spent a lot on gas. A malicious actor can see which prizes the bot is going to claim and front-run them with the last prize in the list. As a result, <a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L434-L436\">claiming will fail</a> and the bot will face losses.</p>\n<p>Another reason why a malicious actor can do that is to make <code>vrgda</code> to provide bigger fees. They can create a bot that will block claims of other bots with a big amount of claims in the batch, in order to wait and get better prices and claim those prize by themself and receive fees.</p>\n<h3 id=\"tools-used-10\" style=\"position:relative;\"><a href=\"#tools-used-10\" aria-label=\"tools used 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VsCode</p>\n<h3 id=\"recommended-mitigation-steps-30\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-30\" aria-label=\"recommended mitigation steps 30 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>In the case of if a price is already claimed, then you can return early from the <code>PrizePool.claimPrize</code> function and emit some event. In this case, bots will not receive fee for the already claimed prize and their tx will continue with other prizes in the batch.</p>\n<h3 id=\"assessed-type-25\" style=\"position:relative;\"><a href=\"#assessed-type-25\" aria-label=\"assessed type 25 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Error</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/115#issuecomment-1641122424\">asselstine (PoolTogether) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/115#issuecomment-1669595229\">Picodes (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I’ll keep medium severity, as the sponsor confirmed with their label that it was valuable to them. I think we could also justify this being low. As in such cases, it is up to the bot to use a private rpc or some other solution to avoid being front-ran.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs\">PoolTogether mitigated</a>:</strong></p>\n<blockquote>\n<p>Added <code>minVrgdaFee</code> and allowed silent failure of claims.<br>\nPRs: <a href=\"https://github.com/GenerationSoftware/pt-v5-claimer/pull/8\">https://github.com/GenerationSoftware/pt-v5-claimer/pull/8</a><br>\n<a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/22\">https://github.com/GenerationSoftware/pt-v5-vault/pull/22</a><br>\n<a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/pull/23\">https://github.com/GenerationSoftware/pt-v5-prize-pool/pull/23</a></p>\n</blockquote>\n<p><strong>Status</strong>: Mitigation confirmed. Full details in report from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/63\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/21\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/106\">0xStalin</a>.</p>\n<hr>\n<h2 id=\"m-25-depositwithpermit-and-mintwithpermit-are-allowed-to-be-called-by-the-permit-creator-only\" style=\"position:relative;\"><a href=\"#m-25-depositwithpermit-and-mintwithpermit-are-allowed-to-be-called-by-the-permit-creator-only\" aria-label=\"m 25 depositwithpermit and mintwithpermit are allowed to be called by the permit creator only permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/113\">[M-25] <code>depositWithPermit</code> and <code>mintWithPermit</code> are allowed to be called by the permit creator only</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/113\">rvierdiiev</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/102\">xuwinnie</a></em></p>\n<p>Functions <code>depositWithPermit</code> and <code>mintWithPermit</code> are allowed to be called by the permit creator only. Not any other contracts will be able to execute these function on behalf of signer.</p>\n<h3 id=\"proof-of-concept-31\" style=\"position:relative;\"><a href=\"#proof-of-concept-31\" aria-label=\"proof of concept 31 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The <code>depositWithPermit</code> function is allowed to provide a signed permit in order to receive, approve and deposit funds into the vault.</p>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L427-L437\">https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L427-L437</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"82\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">depositWithPermit</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_assets</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_receiver</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_deadline</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_v</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_r</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_s</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_permit</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20Permit</span><span class=\"mtk1\">(</span><span class=\"mtk11\">asset</span><span class=\"mtk1\">()), </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_deadline</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_v</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_r</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_s</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_receiver</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>This function calls <code>_permit</code> and pass <code>msg.sender</code> as <code>_owner</code> to that function.</p>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L1093-L1104\">https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L1093-L1104</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"83\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_permit</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IERC20Permit</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_owner</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_spender</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_assets</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_deadline</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_v</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_r</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_s</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">permit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_spender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_deadline</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_v</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_r</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_s</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>This means, that the signer can be only the same person that called <code>depositWithPermit</code> function.</p>\n<p>However, the purpose of the permit is to allow someone to sign the approve signature, so that this signature can be used by another contract to call some function on behalf of signer.</p>\n<p>In this case, anyone should be able to sign permit for the vault, and vault should check that <code>_receiver</code> is same who signed permit.</p>\n<h3 id=\"tools-used-11\" style=\"position:relative;\"><a href=\"#tools-used-11\" aria-label=\"tools used 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VsCode</p>\n<h3 id=\"recommended-mitigation-steps-31\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-31\" aria-label=\"recommended mitigation steps 31 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Use <code>_receiver</code> instead of <code>msg.sender</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"84\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">depositWithPermit</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_assets</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_receiver</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_deadline</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_v</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_r</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_s</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_permit</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20Permit</span><span class=\"mtk1\">(</span><span class=\"mtk11\">asset</span><span class=\"mtk1\">()), </span><span class=\"mtk12\">_receiver</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_deadline</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_v</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_r</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_s</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_receiver</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h3 id=\"assessed-type-26\" style=\"position:relative;\"><a href=\"#assessed-type-26\" aria-label=\"assessed type 26 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Error</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/113#issuecomment-1641122074\">asselstine (PoolTogether) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs\">PoolTogether mitigated</a>:</strong></p>\n<blockquote>\n<p>Fixed permit implementations.<br>\nPR: <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/20\">https://github.com/GenerationSoftware/pt-v5-vault/pull/20</a></p>\n</blockquote>\n<p><strong>Status</strong>: Mitigation confirmed. Full details in report from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/22\">dirk_y</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/64\">rvierdiiev</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/80\">0xStalin</a>.</p>\n<hr>\n<h2 id=\"m-26-transfer-of-vault-tokens-can-cause-accounting-errors-in-other-contracts\" style=\"position:relative;\"><a href=\"#m-26-transfer-of-vault-tokens-can-cause-accounting-errors-in-other-contracts\" aria-label=\"m 26 transfer of vault tokens can cause accounting errors in other contracts permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/91\">[M-26] Transfer of Vault tokens can cause accounting errors in other contracts</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/91\">shaka</a></em></p>\n<h3 id=\"lines-of-code-9\" style=\"position:relative;\"><a href=\"#lines-of-code-9\" aria-label=\"lines of code 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lines of code</h3>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L1155\">https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L1155</a>\n<a href=\"https://github.com/GenerationSoftware/pt-v5-twab-controller/blob/0145eeac23301ee5338c659422dd6d69234f5d50/src/libraries/TwabLib.sol#L48\">https://github.com/GenerationSoftware/pt-v5-twab-controller/blob/0145eeac23301ee5338c659422dd6d69234f5d50/src/libraries/TwabLib.sol#L48</a></p>\n<h3 id=\"vulnerability-details\" style=\"position:relative;\"><a href=\"#vulnerability-details\" aria-label=\"vulnerability details permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerability details</h3>\n<p><code>Vault::_transfer</code> overrides the <code>ERC20::_transfer</code> function so the transfer is performed using the <code>TwabController</code> contract. In the implementation, <code>_shares</code> is downcasted to <code>uint96</code> and this can result in an underflow silently.</p>\n<p>There are nat spec comments indicating that the balance in <code>TwapController</code> is stored in <code>uint96</code>, which would mean that there is no real risk of underflow. However, the <code>TwapController</code> contract uses <code>uint112</code> to store the balance, so the risk of underflow is real.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"85\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">TwabLib</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">47</span><span class=\"mtk1\">  </span><span class=\"mtk12\">struct</span><span class=\"mtk1\"> </span><span class=\"mtk12\">AccountDetails</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">48</span><span class=\"mtk1\">    </span><span class=\"mtk12\">uint112</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balance</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// &lt;== not uint96</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">49</span><span class=\"mtk1\">    </span><span class=\"mtk12\">uint112</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delegateBalance</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">50</span><span class=\"mtk1\">    </span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nextObservationIndex</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">51</span><span class=\"mtk1\">    </span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">cardinality</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">52</span><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h3 id=\"impact-10\" style=\"position:relative;\"><a href=\"#impact-10\" aria-label=\"impact 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Integrations of other contracts or protocols with the <code>Vault</code> contract may result in accounting errors, due to the amount of shares transferred being less than expected due to silent underflow.</p>\n<h3 id=\"proof-of-concept-32\" style=\"position:relative;\"><a href=\"#proof-of-concept-32\" aria-label=\"proof of concept 32 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Foundry test:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"86\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) </span><span class=\"mtk12\">userToBalance</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testTransferUnderflow</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint112</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">underlyingAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">underlyingAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">), </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk8\">`type(uint96).max`</span><span class=\"mtk1\">, </span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk8\">`type(uint96).max`</span><span class=\"mtk1\">, </span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">), </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">`type(uint96).max`</span><span class=\"mtk1\">) * </span><span class=\"mtk7\">2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Alice has now a balance of `type(uint96).max` * 2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Let&#39;s imagine some integration of another contract with the Vault contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// that performs the following operations:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 1. Alice approves all the Vault shares to the contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 2. The contract transfers all the Vault shares from Alice and registers them</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// in in a mapping</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">aliceBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">aliceBalance</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">userToBalance</span><span class=\"mtk1\">[</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">aliceBalance</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 3. Only `type(uint96).max` shares are transferred, but the double of that amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// is registered as transfer underflows silently. So alice can now transfer the</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// remaining balance from the vault.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">, </span><span class=\"mtk8\">`type(uint96).max`</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-32\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-32\" aria-label=\"recommended mitigation steps 32 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Use OpenZeppelin’s <code>SafeCast</code> library to convert <code>uint256</code> to <code>uint96</code>.</p>\n<h3 id=\"assessed-type-27\" style=\"position:relative;\"><a href=\"#assessed-type-27\" aria-label=\"assessed type 27 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Under/Overflow</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/91#issuecomment-1641114152\">asselstine (PoolTogether) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/91#issuecomment-1668604251\">PierrickGT (PoolTogether) commented</a>:</strong></p>\n<blockquote>\n<p>Regarding the <code>TwabController</code>, we need to figure out if we want to keep <code>uint112</code> for balances or if we want to use <code>uint96</code>. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs\">PoolTogether mitigated</a>:</strong></p>\n<blockquote>\n<p>Added SafeCast.<br>\nPR: <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/9\">https://github.com/GenerationSoftware/pt-v5-vault/pull/9</a></p>\n</blockquote>\n<p><strong>Status</strong>: Mitigation confirmed. Full details in report from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/81\">0xStalin</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/23\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/65\">rvierdiiev</a>.</p>\n<hr>\n<h2 id=\"m-27-inconsistent-behavior-for-canary-claims-in-the-claimer\" style=\"position:relative;\"><a href=\"#m-27-inconsistent-behavior-for-canary-claims-in-the-claimer\" aria-label=\"m 27 inconsistent behavior for canary claims in the claimer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/61\">[M-27] Inconsistent behavior for canary claims in the <code>claimer</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/61\">volodya</a></em></p>\n<h3 id=\"proof-of-concept-33\" style=\"position:relative;\"><a href=\"#proof-of-concept-33\" aria-label=\"proof of concept 33 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Whenever a <code>claimer</code> claims prizes they compute fees per <code>claim</code> without considering canary claims.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"87\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">claimPrizes</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">Vault</span><span class=\"mtk1\"> </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tier</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">winners</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\">[][] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">prizeIndices</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_feeRecipient</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalFees</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">claimCount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">winners</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">claimCount</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">prizeIndices</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint96</span><span class=\"mtk1\"> </span><span class=\"mtk12\">feePerClaim</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint96</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">_computeFeePerClaim</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_computeMaxFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tier</span><span class=\"mtk1\">, </span><span class=\"mtk12\">prizePool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">numberOfTiers</span><span class=\"mtk1\">()),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">claimCount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">prizePool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">claimCount</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">claimPrizes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tier</span><span class=\"mtk1\">, </span><span class=\"mtk12\">winners</span><span class=\"mtk1\">, </span><span class=\"mtk12\">prizeIndices</span><span class=\"mtk1\">, </span><span class=\"mtk12\">feePerClaim</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_feeRecipient</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">feePerClaim</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">claimCount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-claimer/blob/57a381aef690a27c9198f4340747155a71cae753/src/Claimer.sol#L76\">src/Claimer.sol#L76</a></p>\n<h3 id=\"recommended-mitigation-steps-33\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-33\" aria-label=\"recommended mitigation steps 33 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider canary as a <code>claim</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"88\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    uint96 feePerClaim = uint96(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      _computeFeePerClaim(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        _computeMaxFee(tier, prizePool.numberOfTiers()),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        claimCount,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        prizePool.claimCount()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        prizePool.claimCount() + prizePool.canaryClaimCount()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span></code></pre>\n<h3 id=\"assessed-type-28\" style=\"position:relative;\"><a href=\"#assessed-type-28\" aria-label=\"assessed type 28 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Error</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/61#issuecomment-1641093811\">asselstine (PoolTogether) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation#individual-prs\">PoolTogether mitigated</a>:</strong></p>\n<blockquote>\n<p>Unified standard and canary tier.<br>\nPR: <a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/pull/17\">https://github.com/GenerationSoftware/pt-v5-prize-pool/pull/17</a></p>\n</blockquote>\n<p><strong>Status</strong>: Mitigation confirmed. Full details in report from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/66\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/103\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/94\">0xStalin</a>.</p>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this audit, 37 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/146\">report highlighted below</a> by <strong>bin2chen</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/445\">kutugu</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/424\">markus_ether</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/422\">catellatech</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/410\">alymurtazamemon</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/311\">yixxas</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/304\">Jeiwan</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/127\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/75\">volodya</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/51\">dacian</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/472\">naman1778</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/421\">lanrebayode77</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/413\">alexzoid</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/411\">GREY-HAWK-REACH</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/394\">Kaysoft</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/392\">0xbepresent</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/383\">banpaleo5</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/379\">0x11singh99</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/374\">MohammedRizwan</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/372\">nadin</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/354\">Inspecktor</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/348\">Bauchibred</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/339\">squeaky_cactus</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/310\">erebus</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/301\">Vagner</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/296\">Rolezn</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/272\">DadeKuma</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/258\">GalloDaSballo</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/235\">keccak123</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/219\">joaovwfreire</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/182\">grearlake</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/176\">ayden</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/119\">ArmedGoose</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/96\">fatherOfBlocks</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/60\">eyexploit</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/53\">ABAIKUNANBAEV</a>, and <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/2\">0xWaitress</a>.</em></p>\n<h2 id=\"l-01-vault_mint-forcing-conversion-to-uint96-may-result-in-missing-values\" style=\"position:relative;\"><a href=\"#l-01-vault_mint-forcing-conversion-to-uint96-may-result-in-missing-values\" aria-label=\"l 01 vault_mint forcing conversion to uint96 may result in missing values permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01] <code>vault._mint()</code> forcing conversion to <code>uint96</code> may result in missing values</h2>\n<p>The current protocol <code>Vault.sol</code> has <code>uint256</code> for shares, but <code>uint96</code> is used in <code>TwabController.sol</code>. So in <code>mint/burn/transfer</code>, it is forced to convert to <code>uint96</code>. This causes the value to exceed <code>type(uint96).max</code> if <code>asset.decimals()>18</code>, resulting in a loss of value.</p>\n<p>Suggesting to add a method like <code>SaftToUint96()</code> to revert if it is larger than <code>uint96</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"89\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-   </span><span class=\"mtk12\">_twabController</span><span class=\"mtk1\">.</span><span class=\"mtk11\">burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_owner</span><span class=\"mtk1\">, </span><span class=\"mtk11\">uint96</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+   </span><span class=\"mtk12\">_twabController</span><span class=\"mtk1\">.</span><span class=\"mtk11\">burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">.</span><span class=\"mtk11\">SafeToUint96</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_updateExchangeRate</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_owner</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>Note: <code>mint()</code> and <code>transfer()</code> have the same problem.</p>\n<h2 id=\"l-02-targetof-incorrectly-uses-_token---_liquidationpairtokenin\" style=\"position:relative;\"><a href=\"#l-02-targetof-incorrectly-uses-_token---_liquidationpairtokenin\" aria-label=\"l 02 targetof incorrectly uses _token   _liquidationpairtokenin permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-02] <code>targetOf()</code> incorrectly uses <code>_token ! = _liquidationPair.tokenIn()</code></h2>\n<p>Currently, <code>targetOf()</code> uses <code>_liquidationPair.tokenIn()</code> but the actual comparison in <code>liquidate()</code> is <code>_tokenIn ! = address(_prizePool.prizeToken())</code>. So it’s <code>_prizePool.prizeToken()</code> that should be used instead.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"90\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">targetOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_token</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-   </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_token</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">_liquidationPair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">tokenIn</span><span class=\"mtk1\">()) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">TargetTokenNotSupported</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+   </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_tokenIn</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_prizePool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prizeToken</span><span class=\"mtk1\">())) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">TargetTokenNotSupported</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_prizePool</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h2 id=\"l-03-setliquidationpair-may-not-be-able-to-set-the-old-liquidationpair\" style=\"position:relative;\"><a href=\"#l-03-setliquidationpair-may-not-be-able-to-set-the-old-liquidationpair\" aria-label=\"l 03 setliquidationpair may not be able to set the old liquidationpair permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-03] <code>setLiquidationPair()</code> may not be able to set the old <code>liquidationPair</code></h2>\n<p>Use the <code>safeApprove()</code> method in <code>setLiquidationPair()</code> to set the allowance.</p>\n<p>The <code>safeApprove()</code> method requires the current allowance to be 0 for the setting to succeed. If the <code>liquidationPair_</code> has been used before, this is the second time it is used and there are residual allowances, it may not be possible to set it.</p>\n<p>I suggest to clear the allowance to 0 before setting.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"91\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setLiquidationPair</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">LiquidationPair</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liquidationPair_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">liquidationPair_</span><span class=\"mtk1\">) == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LPZeroAddress</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_asset</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk11\">asset</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_previousLiquidationPair</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_liquidationPair</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_previousLiquidationPair</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeApprove</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_previousLiquidationPair</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+   </span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeApprove</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">liquidationPair_</span><span class=\"mtk1\">), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeApprove</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">liquidationPair_</span><span class=\"mtk1\">), </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_liquidationPair</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">liquidationPair_</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LiquidationPairSet</span><span class=\"mtk1\">(</span><span class=\"mtk12\">liquidationPair_</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">liquidationPair_</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h2 id=\"l-04-in-_withdraw-by-calling-_burn-and-then-executing-_yieldvaultwithdraw-it-may-lead-_updateexchangerate-inaccuracy\" style=\"position:relative;\"><a href=\"#l-04-in-_withdraw-by-calling-_burn-and-then-executing-_yieldvaultwithdraw-it-may-lead-_updateexchangerate-inaccuracy\" aria-label=\"l 04 in _withdraw by calling _burn and then executing _yieldvaultwithdraw it may lead _updateexchangerate inaccuracy permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-04] in <code>_withdraw()</code>, by calling <code>_burn()</code> and then executing <code>_yieldVault.withdraw()</code>, it may lead <code>_updateExchangeRate()</code> inaccuracy</h2>\n<p>In <code>withdraw()</code>, execute <code>_burn()</code> first in <code>_yieldVault.withdraw()</code>.</p>\n<p>Code as follows:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"92\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_withdraw</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_caller</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_receiver</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_owner</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_assets</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_shares</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">....</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@&gt;  </span><span class=\"mtk11\">_burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@&gt;  </span><span class=\"mtk12\">_yieldVault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_assets</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">SafeERC20</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk11\">asset</span><span class=\"mtk1\">()), </span><span class=\"mtk12\">_receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_assets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_caller</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>In <code>_burn()</code>, the method will execute <code>_updateExchangeRate()</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"93\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@&gt;  </span><span class=\"mtk12\">_twabController</span><span class=\"mtk1\">.</span><span class=\"mtk11\">burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_owner</span><span class=\"mtk1\">, </span><span class=\"mtk11\">uint96</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@&gt;  </span><span class=\"mtk11\">_updateExchangeRate</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_owner</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>Then, <code>_currentExchangeRate()</code> will read <code>_yieldVault.maxWithdraw</code>():</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"94\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_currentExchangeRate</span><span class=\"mtk1\">() </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_totalSupplyAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_totalSupply</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_totalSupplyToAssets</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_convertToAssets</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_totalSupplyAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_lastRecordedExchangeRate</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Rounding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Down</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@&gt;  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_yieldVault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">maxWithdraw</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">_totalSupplyToAssets</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> - (</span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">_totalSupplyToAssets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_totalSupplyAmount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_withdrawableAssets</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulDiv</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_assetUnit</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_totalSupplyAmount</span><span class=\"mtk1\">, </span><span class=\"mtk10\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Rounding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Down</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_assetUnit</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }  </span></span></span></code></pre>\n<p>This results in a wrong order:</p>\n<ol>\n<li><code>vault.burn()</code> reduces <code>shares</code>.</li>\n<li>Read <code>shares</code> and <code>total assets</code> calculate the exchange rate.</li>\n<li><code>_yieldVault.withdraw()</code> reduces <code>total assets</code>.</li>\n</ol>\n<p>The result is that the second step of reading <code>total assets</code> is not correct and the third step should be put before the second step.</p>\n<p>Suggestion:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"95\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_withdraw</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_caller</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_receiver</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_owner</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_assets</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_shares</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">....</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+   </span><span class=\"mtk12\">_yieldVault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_assets</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-   </span><span class=\"mtk12\">_yieldVault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_assets</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">SafeERC20</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk11\">asset</span><span class=\"mtk1\">()), </span><span class=\"mtk12\">_receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_assets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_caller</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h2 id=\"l-05-liquidate-is-at-risk-of-a-sandwich-attack\" style=\"position:relative;\"><a href=\"#l-05-liquidate-is-at-risk-of-a-sandwich-attack\" aria-label=\"l 05 liquidate is at risk of a sandwich attack permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-05] <code>liquidate()</code> is at risk of a sandwich attack</h2>\n<p>Currently <code>liquidate()</code> requires <code>_amountOut >= _vaultAssets</code> to execute <code>_yieldVault.deposit()</code> if there is a residual balance in the contract. This presents some risk for a sandwich attack.</p>\n<p>Example:</p>\n<ol>\n<li>A malicious user monitors <code>memory pool</code>, <code>_liquidationPair</code> transfer assets to the contract, and executes <code>liquidate()</code>.</li>\n<li>Front-runs the transaction in step 1, transferring an <code>asset</code> larger than <code>_amountOut</code>.</li>\n<li>Waits until the first transaction, because <code>_amountOut >= _vaultAssets</code>, will not execute <code>_yieldVault.deposit()</code>, the funds are still in the contract.</li>\n<li>A malicious user uses the balance left in the contract by executing <code>vault.deposit()</code>.</li>\n</ol>\n<p>Suggesting to remove the <code>_amountOut >= _vaultAssets</code> restriction.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"96\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">liquidate</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_account</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_tokenIn</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amountIn</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_tokenOut</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amountOut</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_vaultAssets</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk11\">asset</span><span class=\"mtk1\">()).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-   </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_vaultAssets</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_amountOut</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">_vaultAssets</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+   </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_vaultAssets</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_yieldVault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_vaultAssets</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amountOut</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }  </span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/146#issuecomment-1641167297\">asselstine (PoolTogether) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/146#issuecomment-1710904631\">PierrickGT (PoolTogether) commented</a>:</strong></p>\n<blockquote>\n<p>L-01: has been fixed.<br>\nL-02 and 03: have been removed.<br>\nL-04 and 05: has been fixed.</p>\n</blockquote>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this audit, 19 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/440\">report highlighted below</a> by <strong>c3phas</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/449\">SAQ</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/448\">Udsen</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/432\">hunter_w3b</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/401\">alymurtazamemon</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/315\">petrichor</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/469\">0xAnah</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/467\">naman1778</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/402\">ybansal2403</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/358\">SM3_SS</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/345\">0x11singh99</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/317\">Raihan</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/312\">ReyAdmirado</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/298\">Rolezn</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/254\">Rageur</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/247\">SAAJ</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/139\">0xn006e7</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/50\">LeoS</a>, and <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/34\">koxuan</a>.</em></p>\n<h2 id=\"auditors-disclaimer\" style=\"position:relative;\"><a href=\"#auditors-disclaimer\" aria-label=\"auditors disclaimer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Auditor’s Disclaimer</h2>\n<p>While we try our best to maintain readability in the provided code snippets, some functions have been truncated to highlight the affected portions.</p>\n<p>It’s important to note that during the implementation of these suggested changes, developers must exercise caution to avoid introducing vulnerabilities. Although the optimizations have been tested prior to these recommendations, it is the responsibility of the developers to conduct thorough testing again.</p>\n<p>Code reviews and additional testing are strongly advised to minimize any potential risks associated with the refactoring process.</p>\n<h2 id=\"note-on-gas-estimates\" style=\"position:relative;\"><a href=\"#note-on-gas-estimates\" aria-label=\"note on gas estimates permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Note on Gas estimates</h2>\n<p>I’ve tried to give the exact amount of gas being saved from running the included tests. Whenever the function is within the test coverage, the average gas before and after will be included, and often a diff of the code will also accompany this.</p>\n<p>Some functions are not covered by the test cases or are internal/private functions. In this case, the gas can be estimated by looking at the opcodes involved or simply benchmark any function that calls our function of interest.</p>\n<h2 id=\"tightly-pack-storage-variablesoptimize-the-order-of-variable-declaration-saves-21k-gas\" style=\"position:relative;\"><a href=\"#tightly-pack-storage-variablesoptimize-the-order-of-variable-declaration-saves-21k-gas\" aria-label=\"tightly pack storage variablesoptimize the order of variable declaration saves 21k gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tightly pack storage variables/optimize the order of variable declaration (saves 2.1K gas)</h2>\n<p>The EVM works with 32 byte words. Variables less than 32 bytes can be declared next to each other in storage and this will pack the values together into a single 32 byte storage slot (if the values combined are &#x3C;= 32 bytes). </p>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L215-L224\">https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L215-L224</a></p>\n<h3 id=\"we-can-pack-_liquidationpair-with-_yieldfeepercentage-by-reducing-size-of-_yieldfeepercentage--to-uint64\" style=\"position:relative;\"><a href=\"#we-can-pack-_liquidationpair-with-_yieldfeepercentage-by-reducing-size-of-_yieldfeepercentage--to-uint64\" aria-label=\"we can pack _liquidationpair with _yieldfeepercentage by reducing size of _yieldfeepercentage  to uint64 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>We can pack <code>_liquidationPair</code> with <code>_yieldFeePercentage</code> by reducing size of <code>_yieldFeePercentage</code>  to <code>uint64</code></h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"97\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Vault</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">215</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">LiquidationPair</span><span class=\"mtk1\"> </span><span class=\"mtk12\">private</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_liquidationPair</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">218</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">private</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_assetUnit</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">221</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">private</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_lastRecordedExchangeRate</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">224</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">private</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_yieldFeePercentage</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>When setting the value of <code>_yieldFeePercentage</code> we have some bounds that constrain the max value. The assigned value can be:</p>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L1218-L1223\">https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L1218-L1223</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"98\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1218</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_setYieldFeePercentage</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">yieldFeePercentage_</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1219</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">yieldFeePercentage_</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">FEE_PRECISION</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1220</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">YieldFeePercentageGTPrecision</span><span class=\"mtk1\">(</span><span class=\"mtk12\">yieldFeePercentage_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">FEE_PRECISION</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1221</span><span class=\"mtk1\">:    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1222</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">_yieldFeePercentage</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">yieldFeePercentage_</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1223</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<p>From the above setter, it is evident the value of <code>_yieldFeePercentage</code> cannot be greater than <code>FEE_PRECISION</code>, lest we revert. <code>FEE_PRECISION</code> is a constant defined as shown below:</p>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L232-L233\">https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L232-L233</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"99\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">232</span><span class=\"mtk1\">:  </span><span class=\"mtk3\">/// @notice Fee precision denominated in 9 decimal places and used to calculate yield fee percentage.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">233</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">private</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FEE_PRECISION</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1e9</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>This means, the value assigned to <code>_yieldFeePercentage</code> cannot be greater than <code>1e9</code>. Using <code>uint64</code>, we get a max of <code>18446744073709551615</code> which should be more than enough.</p>\n<p>As such, we can refactor and pack the variables as shown below:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"100\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/Vault.sol b/src/Vault.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index e92ecaf..4c21912 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/Vault.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/Vault.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -213,6 +213,9 @@ contract Vault is ERC4626, ERC20Permit, ILiquidationSource, Ownable {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   /// @notice Address of the LiquidationPair used to liquidate yield for prize token.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   LiquidationPair private _liquidationPair;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  /// @notice Yield fee percentage represented in integer format with 9 decimal places (i.e. 10000000 = 0.01 = 1%).</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  uint64 private _yieldFeePercentage;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   /// @notice Underlying asset unit (i.e. 10 ** 18 for DAI).</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   uint256 private _assetUnit;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -220,9 +223,6 @@ contract Vault is ERC4626, ERC20Permit, ILiquidationSource, Ownable {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   /// @notice Most recent exchange rate recorded when burning or minting Vault shares.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   uint256 private _lastRecordedExchangeRate;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  /// @notice Yield fee percentage represented in integer format with 9 decimal places (i.e. 10000000 = 0.01 = 1%).</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  uint256 private _yieldFeePercentage;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   /// @notice Address of the yield fee recipient that receives the fee amount when yield is captured.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   address private _yieldFeeRecipient;</span></span></span></code></pre>\n<p>Note: We would need to refactor all places this value is used to change the type to <code>uint64</code>.</p>\n<h2 id=\"expensive-operation-inside-a-for-loop\" style=\"position:relative;\"><a href=\"#expensive-operation-inside-a-for-loop\" aria-label=\"expensive operation inside a for loop permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Expensive operation inside a for loop</h2>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/abstract/TieredLiquidityDistributor.sol#L361-L369\">https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/abstract/TieredLiquidityDistributor.sol#L361-L369</a></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Min</th>\n<th>Average</th>\n<th>Median</th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>1901</td>\n<td>59662</td>\n<td>67737</td>\n<td>79917</td>\n</tr>\n<tr>\n<td>After</td>\n<td>1901</td>\n<td>59649</td>\n<td>67723</td>\n<td>79903</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"101\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">abstract</span><span class=\"mtk1\">/</span><span class=\"mtk12\">TieredLiquidityDistributor</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">361</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">start</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">end</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">362</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">_tiers</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">Tier</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">363</span><span class=\"mtk12\">:</span><span class=\"mtk1\">        </span><span class=\"mtk12\">drawId</span><span class=\"mtk1\">: </span><span class=\"mtk12\">closedDrawId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">364</span><span class=\"mtk12\">:</span><span class=\"mtk1\">        </span><span class=\"mtk12\">prizeTokenPerShare</span><span class=\"mtk1\">: </span><span class=\"mtk12\">prizeTokenPerShare</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">365</span><span class=\"mtk12\">:</span><span class=\"mtk1\">        </span><span class=\"mtk12\">prizeSize</span><span class=\"mtk1\">: </span><span class=\"mtk11\">uint96</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">366</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">_computePrizeSize</span><span class=\"mtk1\">(</span><span class=\"mtk12\">i</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_nextNumberOfTiers</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_prizeTokenPerShare</span><span class=\"mtk1\">, </span><span class=\"mtk12\">newPrizeTokenPerShare</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">367</span><span class=\"mtk1\">:        )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">368</span><span class=\"mtk1\">:      });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">369</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"102\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/abstract/TieredLiquidityDistributor.sol b/src/abstract/TieredLiquidityDistributor.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 8238103..ba0587b 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/abstract/TieredLiquidityDistributor.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/abstract/TieredLiquidityDistributor.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -358,10 +358,11 @@ contract TieredLiquidityDistributor {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       start = _nextNumberOfTiers - 1;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       end = _nextNumberOfTiers;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+     UD34x4  prizeTokenPerShare_ = prizeTokenPerShare ;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     for (uint8 i = start; i &lt; end; i++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       _tiers[i] = Tier({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         drawId: closedDrawId,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        prizeTokenPerShare: prizeTokenPerShare,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        prizeTokenPerShare: prizeTokenPerShare_,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         prizeSize: uint96(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">           _computePrizeSize(i, _nextNumberOfTiers, _prizeTokenPerShare, newPrizeTokenPerShare)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         )</span></span></span></code></pre>\n<h2 id=\"use-calldata-instead-of-memory-for-function-parameters\" style=\"position:relative;\"><a href=\"#use-calldata-instead-of-memory-for-function-parameters\" aria-label=\"use calldata instead of memory for function parameters permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Use <code>calldata</code> instead of <code>memory</code> for function parameters</h2>\n<p>If a reference type function parameter is read-only, it is cheaper in gas to use <code>calldata</code> instead of <code>memory</code>. <code>Calldata</code> is a non-modifiable, non-persistent area where function arguments are stored, and behaves mostly like memory.</p>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/VaultFactory.sol#L55-L66\">https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/VaultFactory.sol#L55-L66</a></p>\n<h3 id=\"use-calldata-on-_name-and-_symbol-saves-524-gas-on-average\" style=\"position:relative;\"><a href=\"#use-calldata-on-_name-and-_symbol-saves-524-gas-on-average\" aria-label=\"use calldata on _name and _symbol saves 524 gas on average permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Use calldata on <code>_name</code> and <code>_symbol</code> (saves 524 gas on average)</h3>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Min</th>\n<th>Average</th>\n<th>Median</th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>3737309</td>\n<td>3737309</td>\n<td>3737309</td>\n<td>3737309</td>\n</tr>\n<tr>\n<td>After</td>\n<td>3736785</td>\n<td>3736785</td>\n<td>3736785</td>\n<td>3736785</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"103\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">VaultFactory</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">55</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deployVault</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">56:    </span><span class=\"mtk10\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_asset</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">57:    </span><span class=\"mtk10\">string</span><span class=\"mtk1\"> </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_name</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">58:    </span><span class=\"mtk10\">string</span><span class=\"mtk1\"> </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_symbol</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">59:    </span><span class=\"mtk10\">TwabController</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_twabController</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">60:    </span><span class=\"mtk10\">IERC4626</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_yieldVault</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">61:    </span><span class=\"mtk10\">PrizePool</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_prizePool</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">62:    </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_claimer</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">63:    </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_yieldFeeRecipient</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">64:    </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_yieldFeePercentage</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">65:    </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_owner</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">66</span><span class=\"mtk1\">:  ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"104\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/VaultFactory.sol b/src/VaultFactory.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 559fd90..2b85cba 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/VaultFactory.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/VaultFactory.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -54,8 +54,8 @@ contract VaultFactory {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   function deployVault(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     IERC20 _asset,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    string memory _name,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    string memory _symbol,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    string calldata _name,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    string calldata _symbol,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     TwabController _twabController,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     IERC4626 _yieldVault,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     PrizePool _prizePool,</span></span></span></code></pre>\n<h2 id=\"repeatedly-doing-the-same-operation-addition-involving-a-state-variable-should-be-avoided\" style=\"position:relative;\"><a href=\"#repeatedly-doing-the-same-operation-addition-involving-a-state-variable-should-be-avoided\" aria-label=\"repeatedly doing the same operation addition involving a state variable should be avoided permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Repeatedly doing the same operation (addition) involving a state variable should be avoided</h2>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L316-L328\">https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L316-L328</a></p>\n<p><strong>Note this was not found by the bot under caching state variables. Gas saved on average: 548</strong></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Min</th>\n<th>Average</th>\n<th>Median</th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>17709</td>\n<td>181028</td>\n<td>190311</td>\n<td>226423</td>\n</tr>\n<tr>\n<td>After</td>\n<td>17709</td>\n<td>180480</td>\n<td>189753</td>\n<td>225865</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"105\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PrizePool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">316</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">DrawAccumulatorLib</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">317</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">vaultAccumulator</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_prizeVault</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">318</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">319</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">lastClosedDrawId</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">320</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">smoothing</span><span class=\"mtk1\">.</span><span class=\"mtk11\">intoSD59x18</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">321</span><span class=\"mtk1\">:    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">322</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">DrawAccumulatorLib</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">323</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">totalAccumulator</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">324</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">325</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">lastClosedDrawId</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">326</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">smoothing</span><span class=\"mtk1\">.</span><span class=\"mtk11\">intoSD59x18</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">327</span><span class=\"mtk1\">:    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">328</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ContributePrizeTokens</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_prizeVault</span><span class=\"mtk1\">, </span><span class=\"mtk12\">lastClosedDrawId</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>In the function above, the operation <code>lastClosedDrawId + 1</code> is being done repeatedly. As <code>lastClosedDrawId</code> is a state variable, the amount of gas becomes too much. We should do the operation and cache the result in a <code>memory</code> variable.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"106\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/PrizePool.sol b/src/PrizePool.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index a42a27e..6a850ae 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/PrizePool.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/PrizePool.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -313,19 +313,20 @@ contract PrizePool is TieredLiquidityDistributor {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     if (_deltaBalance &lt; _amount) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       revert ContributionGTDeltaBalance(_amount, _deltaBalance);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    uint16 _lastClosedDrawIdPlusOne = lastClosedDrawId + 1;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     DrawAccumulatorLib.add(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       vaultAccumulator[_prizeVault],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       _amount,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      lastClosedDrawId + 1,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      _lastClosedDrawIdPlusOne,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       smoothing.intoSD59x18()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     DrawAccumulatorLib.add(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       totalAccumulator,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       _amount,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      lastClosedDrawId + 1,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      _lastClosedDrawIdPlusOne,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       smoothing.intoSD59x18()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    emit ContributePrizeTokens(_prizeVault, lastClosedDrawId + 1, _amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    emit ContributePrizeTokens(_prizeVault, _lastClosedDrawIdPlusOne, _amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     return _deltaBalance;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span></code></pre>\n<h2 id=\"use-the-existing-memory-value-to-do-the-subtraction\" style=\"position:relative;\"><a href=\"#use-the-existing-memory-value-to-do-the-subtraction\" aria-label=\"use the existing memory value to do the subtraction permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Use the existing memory value to do the subtraction</h2>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L483-L493\">https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L483-L493</a></p>\n<p><strong>Average Gas Saved: 77</strong></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Min</th>\n<th>Average</th>\n<th>Median</th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>2750</td>\n<td>18704</td>\n<td>23717</td>\n<td>29646</td>\n</tr>\n<tr>\n<td>After</td>\n<td>2750</td>\n<td>18627</td>\n<td>23615</td>\n<td>29518</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"107\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PrizePool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">483</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdrawClaimRewards</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">484</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_available</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">claimerRewards</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">486</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">_available</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">487</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InsufficientRewardsError</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_available</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">488</span><span class=\"mtk1\">:    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">490</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">claimerRewards</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] -= </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">491</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">_transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">492</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">WithdrawClaimRewards</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_available</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">493</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"108\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/PrizePool.sol b/src/PrizePool.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index a42a27e..596fa1c 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/PrizePool.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/PrizePool.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -487,7 +487,7 @@ contract PrizePool is TieredLiquidityDistributor {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       revert InsufficientRewardsError(_amount, _available);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    claimerRewards[msg.sender] -= _amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    claimerRewards[msg.sender] = _available - _amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     _transfer(_to, _amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     emit WithdrawClaimRewards(_to, _amount, _available);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span></code></pre>\n<h2 id=\"emitting-storage-values-instead-of-the-memory-one\" style=\"position:relative;\"><a href=\"#emitting-storage-values-instead-of-the-memory-one\" aria-label=\"emitting storage values instead of the memory one permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Emitting storage values instead of the memory one.</h2>\n<p>Here, the values emitted shouldn’t be read from storage. The existing memory values should be used instead:</p>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L372-L385\">https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L372-L385</a></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Min</th>\n<th>Average</th>\n<th>Median</th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>1901</td>\n<td>59662</td>\n<td>67737</td>\n<td>79917</td>\n</tr>\n<tr>\n<td>After</td>\n<td>1901</td>\n<td>59649</td>\n<td>67723</td>\n<td>79903</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"109\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PrizePool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">372</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">_lastClosedDrawStartedAt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">openDrawStartedAt_</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">373</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">_lastClosedDrawAwardedAt</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint64</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">375</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">DrawClosed</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">376</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">lastClosedDrawId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">377</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">winningRandomNumber_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">378</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">_numTiers</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">379</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">_nextNumberOfTiers</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">380</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">_reserve</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">381</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">prizeTokenPerShare</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">382</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">_lastClosedDrawStartedAt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">383</span><span class=\"mtk1\">:    );</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"110\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/PrizePool.sol b/src/PrizePool.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index a42a27e..74d3a25 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/PrizePool.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/PrizePool.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -379,7 +379,7 @@ contract PrizePool is TieredLiquidityDistributor {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       _nextNumberOfTiers,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       _reserve,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       prizeTokenPerShare,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      _lastClosedDrawStartedAt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      openDrawStartedAt_</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     return lastClosedDrawId;</span></span></span></code></pre>\n<h2 id=\"optimizing-the-check-order-for-cost-efficient-function-execution\" style=\"position:relative;\"><a href=\"#optimizing-the-check-order-for-cost-efficient-function-execution\" aria-label=\"optimizing the check order for cost efficient function execution permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Optimizing the check order for cost efficient function execution</h2>\n<p>Checks that involve constants should come before checks that involve state variables, function calls, and calculations. By doing these checks first, the function is able to revert before wasting a Gcoldsload (2100 gas) in a function that may ultimately revert, in the unhappy case.</p>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/abstract/TieredLiquidityDistributor.sol#L235-L326\">https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/abstract/TieredLiquidityDistributor.sol#L235-L326</a></p>\n<h3 id=\"validate-parameters-before-doing-any-sstores-more-than-2200-gas-could-be-saved-in-case-of-a-revert\" style=\"position:relative;\"><a href=\"#validate-parameters-before-doing-any-sstores-more-than-2200-gas-could-be-saved-in-case-of-a-revert\" aria-label=\"validate parameters before doing any sstores more than 2200 gas could be saved in case of a revert permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Validate parameters before doing any <code>sstores</code> (more than 2200 gas could be saved in case of a revert)</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"111\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">abstract</span><span class=\"mtk1\">/</span><span class=\"mtk12\">TieredLiquidityDistributor</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">235</span><span class=\"mtk1\">:  </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_numberOfTiers</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_tierShares</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_canaryShares</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_reserveShares</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">236</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">numberOfTiers</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_numberOfTiers</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">237</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">tierShares</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_tierShares</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">238</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">canaryShares</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_canaryShares</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">239</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">reserveShares</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_reserveShares</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">320</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_numberOfTiers</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">MINIMUM_NUMBER_OF_TIERS</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">321</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NumberOfTiersLessThanMinimum</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_numberOfTiers</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">322</span><span class=\"mtk1\">:    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">323</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_numberOfTiers</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">MAXIMUM_NUMBER_OF_TIERS</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">324</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NumberOfTiersGreaterThanMaximum</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_numberOfTiers</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">325</span><span class=\"mtk1\">:    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">326</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<p>We are assigning some Storage variables a function parameter on top of doing so other minor operations. We then check if the parameters passed to the constructor meet the required specification; i.e.:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"112\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_numberOfTiers</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">MINIMUM_NUMBER_OF_TIERS</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NumberOfTiersLessThanMinimum</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_numberOfTiers</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_numberOfTiers</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">MAXIMUM_NUMBER_OF_TIERS</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NumberOfTiersGreaterThanMaximum</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_numberOfTiers</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>If the above checks fail, we end up reverting the whole transaction, meaning the gas spent writing to storage would go to waste.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"113\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/abstract/TieredLiquidityDistributor.sol b/src/abstract/TieredLiquidityDistributor.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 8238103..34c2050 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/abstract/TieredLiquidityDistributor.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/abstract/TieredLiquidityDistributor.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -233,6 +233,12 @@ contract TieredLiquidityDistributor {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    * @param _reserveShares The number of shares to allocate to the reserve.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   constructor(uint8 _numberOfTiers, uint8 _tierShares, uint8 _canaryShares, uint8 _reserveShares) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    if (_numberOfTiers &lt; MINIMUM_NUMBER_OF_TIERS) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      revert NumberOfTiersLessThanMinimum(_numberOfTiers);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    if (_numberOfTiers &gt; MAXIMUM_NUMBER_OF_TIERS) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      revert NumberOfTiersGreaterThanMaximum(_numberOfTiers);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     numberOfTiers = _numberOfTiers;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     tierShares = _tierShares;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     canaryShares = _canaryShares;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -317,12 +323,6 @@ contract TieredLiquidityDistributor {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       _tierShares</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    if (_numberOfTiers &lt; MINIMUM_NUMBER_OF_TIERS) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      revert NumberOfTiersLessThanMinimum(_numberOfTiers);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    if (_numberOfTiers &gt; MAXIMUM_NUMBER_OF_TIERS) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      revert NumberOfTiersGreaterThanMaximum(_numberOfTiers);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span></code></pre>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L550-L568\">https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L550-L568</a></p>\n<h3 id=\"reorder-the-checks-to-have-the-cheaper-validations-come-first\" style=\"position:relative;\"><a href=\"#reorder-the-checks-to-have-the-cheaper-validations-come-first\" aria-label=\"reorder the checks to have the cheaper validations come first permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reorder the checks to have the cheaper validations come first</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"114\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Vault</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">550</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">liquidate</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">551:    </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_account</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">552:    </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_tokenIn</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">553:    </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_amountIn</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">554:    </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_tokenOut</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">555:    </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_amountOut</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">556</span><span class=\"mtk1\">:  ) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">557</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">_requireVaultCollateralized</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">558</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_liquidationPair</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">559</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LiquidationCallerNotLP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_liquidationPair</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">560</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_tokenIn</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_prizePool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prizeToken</span><span class=\"mtk1\">()))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">561</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LiquidationTokenInNotPrizeToken</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenIn</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_prizePool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prizeToken</span><span class=\"mtk1\">()));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">562</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_tokenOut</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">563</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LiquidationTokenOutNotVaultShare</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenOut</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">564</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_amountOut</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LiquidationAmountOutZero</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">566</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_liquidableYield</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_liquidatableBalanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenOut</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">567</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_amountOut</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">_liquidableYield</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">568</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LiquidationAmountOutGTYield</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amountOut</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_liquidableYield</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>The first few checks are either reading from storage or making some external calls. These operations are quite expensive in terms of gas. We also have some checks that validate some function parameters. Reading function parameters is very cheap. As it is, in case we revert on the function parameter check, the gas consumed doing external calls or state reads would be wasted. We should reorder the checks to reduce gas consumed in case of a revert. Cheaper checks should be done first as shown below:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"115\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/Vault.sol b/src/Vault.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index e92ecaf..7652d7a 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/Vault.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/Vault.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -554,19 +554,23 @@ contract Vault is ERC4626, ERC20Permit, ILiquidationSource, Ownable {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     address _tokenOut,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     uint256 _amountOut</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   ) public virtual override returns (bool) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    _requireVaultCollateralized();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    if (msg.sender != address(_liquidationPair))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      revert LiquidationCallerNotLP(msg.sender, address(_liquidationPair));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    if (_tokenIn != address(_prizePool.prizeToken()))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      revert LiquidationTokenInNotPrizeToken(_tokenIn, address(_prizePool.prizeToken()));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    if (_amountOut == 0) revert LiquidationAmountOutZero();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     if (_tokenOut != address(this))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       revert LiquidationTokenOutNotVaultShare(_tokenOut, address(this));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    if (_amountOut == 0) revert LiquidationAmountOutZero();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     uint256 _liquidableYield = _liquidatableBalanceOf(_tokenOut);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     if (_amountOut &gt; _liquidableYield)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       revert LiquidationAmountOutGTYield(_amountOut, _liquidableYield);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    _requireVaultCollateralized();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    if (msg.sender != address(_liquidationPair))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      revert LiquidationCallerNotLP(msg.sender, address(_liquidationPair));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    if (_tokenIn != address(_prizePool.prizeToken()))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      revert LiquidationTokenInNotPrizeToken(_tokenIn, address(_prizePool.prizeToken()));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     _prizePool.contributePrizeTokens(address(this), _amountIn);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     if (_yieldFeePercentage != 0) {</span></span></span></code></pre>\n<h2 id=\"dont-cache-a-state-variable-if-its-used-only-once\" style=\"position:relative;\"><a href=\"#dont-cache-a-state-variable-if-its-used-only-once\" aria-label=\"dont cache a state variable if its used only once permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Don’t cache a state variable if it’s used only once</h2>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L851-L877\">https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L851-L877</a></p>\n<p><strong>Gas benchmarks are based on function <code>isWinner</code> that calls this internal function.</strong></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Min</th>\n<th>Average</th>\n<th>Median</th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>1046</td>\n<td>26982</td>\n<td>20177</td>\n<td>55866</td>\n</tr>\n<tr>\n<td>After</td>\n<td>1046</td>\n<td>27014</td>\n<td>20232</td>\n<td>55921</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"116\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PrizePool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">851</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_numberOfTiers</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">numberOfTiers</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">852</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tierPrizeCount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getTierPrizeCount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tier</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_numberOfTiers</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">854</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_prizeIndex</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">tierPrizeCount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">855</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidPrizeIndex</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_prizeIndex</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tierPrizeCount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tier</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">856</span><span class=\"mtk1\">:    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">858</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">userSpecificRandomNumber</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">TierCalculationLib</span><span class=\"mtk1\">.</span><span class=\"mtk11\">calculatePseudoRandomNumber</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">859</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">_user</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">860</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">_tier</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">861</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">_prizeIndex</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">862</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">_winningRandomNumber</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">863</span><span class=\"mtk1\">:    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">864</span><span class=\"mtk1\">:    (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_userTwab</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_vaultTwabTotalSupply</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">_getVaultUserBalanceAndTotalSupplyTwab</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">865</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">_vault</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">866</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">_user</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">867</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">_drawDuration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">868</span><span class=\"mtk1\">:    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">870</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">return</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">871</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">TierCalculationLib</span><span class=\"mtk1\">.</span><span class=\"mtk11\">isWinner</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">872</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">userSpecificRandomNumber</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">873</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">uint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_userTwab</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">874</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">uint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_vaultTwabTotalSupply</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">875</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">_vaultPortion</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">876</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">_tierOdds</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">877</span><span class=\"mtk1\">:      );</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"117\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/PrizePool.sol b/src/PrizePool.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index a42a27e..9407b1c 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/PrizePool.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/PrizePool.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -848,8 +848,7 @@ contract PrizePool is TieredLiquidityDistributor {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     SD59x18 _tierOdds,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     uint16 _drawDuration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   ) internal view returns (bool) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    uint8 _numberOfTiers = numberOfTiers;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    uint32 tierPrizeCount = _getTierPrizeCount(_tier, _numberOfTiers);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    uint32 tierPrizeCount = _getTierPrizeCount(_tier, numberOfTiers);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     if (_prizeIndex &gt;= tierPrizeCount) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       revert InvalidPrizeIndex(_prizeIndex, tierPrizeCount, _tier);</span></span></span></code></pre>\n<h2 id=\"do-not-cache-immutable-values\" style=\"position:relative;\"><a href=\"#do-not-cache-immutable-values\" aria-label=\"do not cache immutable values permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Do not cache immutable values</h2>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L781-L810\">https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/4bc8a12b857856828c018510b5500d722b79ca3a/src/PrizePool.sol#L781-L810</a></p>\n<p><strong>Benchmark is based on the function <code>nextNumberOfTiers</code>, which calls our internal function.</strong></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Min</th>\n<th>Average</th>\n<th>Median</th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>765</td>\n<td>765</td>\n<td>765</td>\n<td>765</td>\n</tr>\n<tr>\n<td>After</td>\n<td>757</td>\n<td>757</td>\n<td>757</td>\n<td>757</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"118\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PrizePool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">781</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_computeNextNumberOfTiers</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_numTiers</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint8</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">782</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">UD2x18</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_claimExpansionThreshold</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">claimExpansionThreshold</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">793</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">// check to see if we need to expand the number of tiers</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">794</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">795</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">_nextNumberOfTiers</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">_numTiers</span><span class=\"mtk1\"> &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">796</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">canaryClaimCount</span><span class=\"mtk1\"> &gt;=</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">797</span><span class=\"mtk1\">:      </span><span class=\"mtk11\">fromUD60x18</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">798</span><span class=\"mtk1\">:</span><span class=\"mtk11\">intoUD60x18</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_claimExpansionThreshold</span><span class=\"mtk1\">).</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk11\">_canaryPrizeCountFractional</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_numTiers</span><span class=\"mtk1\">).</span><span class=\"mtk11\">floor</span><span class=\"mtk1\">())</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">799</span><span class=\"mtk1\">:      ) &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">800</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">claimCount</span><span class=\"mtk1\"> &gt;=</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">801</span><span class=\"mtk1\">:      </span><span class=\"mtk11\">fromUD60x18</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">802</span><span class=\"mtk1\">:</span><span class=\"mtk11\">intoUD60x18</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_claimExpansionThreshold</span><span class=\"mtk1\">).</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk11\">toUD60x18</span><span class=\"mtk1\">(</span><span class=\"mtk11\">_estimatedPrizeCount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_numTiers</span><span class=\"mtk1\">)))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">803</span><span class=\"mtk1\">:      )</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"119\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/PrizePool.sol b/src/PrizePool.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index a42a27e..accf0a8 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/PrizePool.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/PrizePool.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -779,7 +779,6 @@ contract PrizePool is TieredLiquidityDistributor {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   /// @param _numTiers The current number of tiers</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   /// @return The number of tiers for the next draw</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   function _computeNextNumberOfTiers(uint8 _numTiers) internal view returns (uint8) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    UD2x18 _claimExpansionThreshold = claimExpansionThreshold;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     uint8 _nextNumberOfTiers = largestTierClaimed + 2; // canary tier, then length</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     _nextNumberOfTiers = _nextNumberOfTiers &gt; MINIMUM_NUMBER_OF_TIERS</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -795,11 +794,11 @@ contract PrizePool is TieredLiquidityDistributor {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       _nextNumberOfTiers &gt;= _numTiers &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       canaryClaimCount &gt;=</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       fromUD60x18(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        intoUD60x18(_claimExpansionThreshold).mul(_canaryPrizeCountFractional(_numTiers).floor())</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        intoUD60x18(claimExpansionThreshold).mul(_canaryPrizeCountFractional(_numTiers).floor())</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       ) &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       claimCount &gt;=</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       fromUD60x18(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        intoUD60x18(_claimExpansionThreshold).mul(toUD60x18(_estimatedPrizeCount(_numTiers)))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        intoUD60x18(claimExpansionThreshold).mul(toUD60x18(_estimatedPrizeCount(_numTiers)))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       // increase the number of tiers to include a new tier</span></span></span></code></pre>\n<h2 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p>It is important to emphasize that the provided recommendations aim to enhance the efficiency of the code without compromising its readability. We understand the value of maintainable and easily understandable code to both developers and auditors.</p>\n<p>As you proceed with implementing the suggested optimizations, please exercise caution and be diligent in conducting thorough testing. It is crucial to ensure that the changes are not introducing any new vulnerabilities and that the desired performance improvements are achieved. Review code changes, and perform thorough testing to validate the effectiveness and security of the refactored code.</p>\n<p>Should you have any questions or need further assistance, please don’t hesitate to reach out.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/440#issuecomment-1644754496\">asselstine (PoolTogether) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/440#issuecomment-1714662253\">PierrickGT (PoolTogether) commented</a>:</strong></p>\n<blockquote>\n<p>1 - Fixed in this commit: <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/45/commits/8ea87b645abc72443efbc2696092950f7751e9b7.\">https://github.com/GenerationSoftware/pt-v5-vault/pull/45/commits/8ea87b645abc72443efbc2696092950f7751e9b7.</a><br>\n2, 4, 5, 6, 7, 8, 9, 10: have been fixed.<br>\n3: does not save gas anymore now that we use <code>CREATE2</code>.</p>\n</blockquote>\n<hr>\n<h1 id=\"audit-analysis\" style=\"position:relative;\"><a href=\"#audit-analysis\" aria-label=\"audit analysis permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Audit Analysis</h1>\n<p>For this audit, 13 analysis reports were submitted by wardens. An analysis report examines the codebase as a whole, providing observations and advice on such topics as architecture, mechanism, or approach. The <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/429\">report highlighted below</a> by <strong>0xStalin</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/355\">DadeKuma</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/471\">peanuts</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/441\">0xSmartContract</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/420\">catellatech</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/405\">dirk_y</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/340\">squeaky_cactus</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/338\">K42</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/323\">keccak123</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/289\">Jeiwan</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/161\">ABAIKUNANBAEV</a>, <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/116\">3docSec</a>, and <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/18\">0xWaitress</a>.</em></p>\n<h2 id=\"introduction\" style=\"position:relative;\"><a href=\"#introduction\" aria-label=\"introduction permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Introduction</h2>\n<p>The PoolTogether protocol proposition is to gamify the yields earned by depositing assets into vaults. It is an interesting proposition to allow users that are attracted to all-or-nothing types of games because the PoolTogether vaults allow vault depositors to play at random the possibility to win everyone’s yields.</p>\n<p>The protocol aims to make the vaults creations fully autonomous and in a permissionless way. This will allow anybody to create vaults that offer the gamification feature that the PoolTogether protocol is building.</p>\n<h2 id=\"analysis-of-the-codebase\" style=\"position:relative;\"><a href=\"#analysis-of-the-codebase\" aria-label=\"analysis of the codebase permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Analysis of the Codebase</h2>\n<p>The codebase of this audit included 4 components of the PoolTogether protocol, the <code>Vault</code>, the <code>PrizePool</code>, the <code>TwabController</code> &#x26; the <code>Claimer</code>. The 4 components are highly interconnected and dependent on each other.</p>\n<p>The Vault can be thought of as the core component because it interacts with all the others.</p>\n<ul>\n<li>It is in charge of updating the <code>PrizePool</code> accounting and sending and reading data from the <code>TwabController</code> where all the user’s balances are tracked.</li>\n<li>The <code>Claimer</code> is a more optional component because it is up to the <code>Vault</code>’s owner to set a claimer using a deployed <code>Claimer</code> contract or not.</li>\n</ul>\n<p><img src=\"https://res.cloudinary.com/djt3zbrr3/image/upload/v1689360530/relationship_diagram_ivtfu4.png\" alt=\"Relationship Diagram\"></p>\n<p>There is a Vault Factory that is in charge of deploying new Vaults.</p>\n<ul>\n<li>The deployment of new vaults is fully decentralized. It is not required to ask permission from the protocol to deploy a new Vault, or belong to a whitelist or a restriction of any type; it is fully autonomous and decentralized.</li>\n</ul>\n<p>The <code>YieldVault</code> is not exactly a contract coded by the Protocol team, but it is expected to be an ERC4626-compliant contract.</p>\n<ul>\n<li>Even though there is not much documentation about the <code>YieldVault</code>, I consider it to be a key component of the protocol because all the user’s assets will end up being deposited into the <code>YieldVaults</code>.</li>\n</ul>\n<p>I think that this protocol uniqueness feature is how they’ve accomplished generating on-chain randomness to match the pseudo-randomness values with past values that have been generated by the user’s &#x26; vault’s balances during a specific period of time.</p>\n<ul>\n<li>\n<p>Using past values makes it near to impossible to try to compute &#x26; force a specific account to be the winner. The reason is, that even though the pseudorandom value can be computed before the tx is actually executed, the past values can’t be modified and forced to match the pseudorandom value.</p>\n<ul>\n<li>The Math &#x26; Logic involved in this process is quite complex, it is really an artwork.</li>\n</ul>\n</li>\n<li>Also, the proposition to gamify the yields and allow users to “gamble” their yields in exchange for potentially earning the yields of all the other depositors is quite interesting because most of the crypto users are investors of high-risk profiles, which I’m pretty sure more than 1 will be interested in this offer.</li>\n</ul>\n<h2 id=\"architecture-feedback-centralization--systemic-risks\" style=\"position:relative;\"><a href=\"#architecture-feedback-centralization--systemic-risks\" aria-label=\"architecture feedback centralization  systemic risks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Architecture Feedback, Centralization &#x26; Systemic Risks</h2>\n<p>The protocol is aiming to achieve a fully autonomous and decentralized architecture, but with decentralization comes risks.</p>\n<p>The Asset Flows when depositing and withdrawing to/from the PoolTogether vaults are similar to the process explained in the below diagrams.</p>\n<p>As we can see, <strong>all the user assets are really deposited in the <code>YieldVaults</code></strong>, which is why ensuring that the <code>YieldVaults</code> are real and safe vaults is a critical task that the protocol should take care of.</p>\n<p><img src=\"https://res.cloudinary.com/djt3zbrr3/image/upload/v1689359894/deposit_asset_flow.png\" alt=\"Deposit Assets Flow\"></p>\n<p><img src=\"https://res.cloudinary.com/djt3zbrr3/image/upload/v1689360088/withdraw_assets_flow_sbestw.png\" alt=\"Withdraw Assets Flow\"></p>\n<p>The decentralization part is about allowing anybody to create new vaults by using the <code>VaultFactory</code> that is created by the Protocol. Problems can arise if the protocol doesn’t enforce the newly created vaults to use the expected contracts for the accounting and holding of the user’s assets</p>\n<ul>\n<li>Malicious users could abuse and deploy fake contracts and set them as the <code>PrizePool</code>, <code>TwabController</code>, and also create fake <code>YieldVaults</code>. This is a critical risk for users’ safeness because all the vaults created by the <code>VaultFactory</code> should indicate to the users that these vaults are safe to interact with.</li>\n</ul>\n<p>That is a critical problem that arises with decentralization, because the creation of the vaults is decentralized, but the ownership of each vault isn’t, there is a vault owner who could abuse its power if the contracts don’t limitate it.</p>\n<ul>\n<li>Limitate the vault owner’s power is a task of the protocol because the protocol is the one who is allowing anybody to create new vaults using their VaultFactory.</li>\n</ul>\n<p>About the Liquidity Distribution fully relies on some advanced math formulas, which basically compute the number of liquidity to be disbursed across the different draws and in each draw computes how much liquidity to distribute among the different tiers.</p>\n<ul>\n<li>Tiers are flexible, meaning, they can grow or shrink if required.</li>\n</ul>\n<p><img src=\"https://res.cloudinary.com/djt3zbrr3/image/upload/v1689360403/liquidity_distribution_en7oxo.png\" alt=\"Liquidity Distribution\"></p>\n<p><img src=\"https://res.cloudinary.com/djt3zbrr3/image/upload/v1689360483/draw_liquidity_distribution_oo0hgg.png\" alt=\"Draw&#x27;s Liquidity Distribution\"></p>\n<p>The winners are determined based on pseudorandom-generated values and matching values that have been generated in the past between a specific period of time</p>\n<ul>\n<li>To achieve this, the protocol does some computation between the <code>PrizePool</code> and <code>TwabController</code> contracts.</li>\n</ul>\n<p><img src=\"https://res.cloudinary.com/djt3zbrr3/image/upload/v1689360322/determing_the_winner_k1jy6m.png\" alt=\"determing the winner\"></p>\n<p>The <code>Claimer</code> is only one in charge to claim the prizes of the winners (all the prizes are sent to the corresponding winner). The <code>Claimer</code> earns a fee in exchange for claiming the prizes on behalf of the winners.</p>\n<h2 id=\"recommendations\" style=\"position:relative;\"><a href=\"#recommendations\" aria-label=\"recommendations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendations</h2>\n<p>Always have in mind the fact that if something goes wrong in a vault that was deployed using the <code>VaultFactory</code>, most users will blame the protocol, not the vault owner. In a normal user’s mind, the protocol is responsible to ensure that each individual vault is safe and sound.</p>\n<p>That being said, even though the creation of vaults will be fully decentralized, make sure that the contracts limitate the vault’s owners to the minimum privileges that they require to manage the vault.</p>\n<p>Also, make sure that the contracts enforce the vaults to use the right and expected contracts. Most of the time allowing users to set arbitrary addresses for contracts that interact with the protocol opens up some attack vectors.</p>\n<p>Always try to mitigate the number of open doors that could be exploited or abused by the vault owners.</p>\n<h2 id=\"time-spent\" style=\"position:relative;\"><a href=\"#time-spent\" aria-label=\"time spent permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Time spent</h2>\n<p>40 hours</p>\n<p>I spent 6 days on this audit, each day I put in around 5-8 hours of work. In total would be around 40 hours.</p>\n<ul>\n<li>3 days were to analyze and fully understand the codebase.</li>\n<li>2 days were dedicated only to bug hunting. I didn’t follow the recognition pattern; I was mostly focused on identifying critical issues caused by incorrect assumptions and bugs in the code.</li>\n<li>The last day was dedicated to filling out the reports and writing this analysis, as well as creating the diagrams.</li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/429#issuecomment-1644740838\">asselstine (PoolTogether) confirmed</a></strong></p>\n<hr>\n<h1 id=\"mitigation-review\" style=\"position:relative;\"><a href=\"#mitigation-review\" aria-label=\"mitigation review permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"#mitigation-review\">Mitigation Review</a></h1>\n<h2 id=\"introduction-1\" style=\"position:relative;\"><a href=\"#introduction-1\" aria-label=\"introduction 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Introduction</h2>\n<p>Following the C4 audit, 3 wardens (<a href=\"https://code4rena.com/@dirk_y\">dirk_y</a>, <a href=\"https://code4rena.com/@rvierdiiev\">rvierdiiev</a> and <a href=\"https://code4rena.com/@0xStalin\">0xStalin</a>) reviewed the mitigations for all identified issues. Additional details can be found within the <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation\">PoolTogether Mitigation Review repository</a>.</p>\n<h2 id=\"overview-of-changes\" style=\"position:relative;\"><a href=\"#overview-of-changes\" aria-label=\"overview of changes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview of Changes</h2>\n<ul>\n<li>\n<p>Twab Controller now checks query timestamps for safety. When requesting a twab, timestamps:</p>\n<ol>\n<li>are required to be finalized; i.e. cannot occur during an overwrite period</li>\n<li>are aligned to period boundaries.</li>\n</ol>\n</li>\n<li>\n<p>Tier adjustment algorithm</p>\n<ol>\n<li>The canary tier has been simplified, so that the prize size is adjusted instead of the number of prizes. Now the unified claim count across normal + canary tiers is used to determine the next number of tiers.</li>\n</ol>\n</li>\n<li>\n<p>Vault exchange rate</p>\n<ol>\n<li>The Vault now assumes shares are 1:1 with underlying assets, unless the vault is undercollateralized. No exchange rate is stored.</li>\n</ol>\n</li>\n</ul>\n<h2 id=\"mitigation-review-scope\" style=\"position:relative;\"><a href=\"#mitigation-review-scope\" aria-label=\"mitigation review scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation Review Scope</h2>\n<h3 id=\"branch\" style=\"position:relative;\"><a href=\"#branch\" aria-label=\"branch permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Branch</h3>\n<ul>\n<li><a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool\">pt-v5-prize-pool</a></li>\n<li><a href=\"https://github.com/GenerationSoftware/pt-v5-twab-controller\">pt-v5-twab-controller</a></li>\n<li><a href=\"https://github.com/GenerationSoftware/pt-v5-vault\">pt-v5-vault</a></li>\n<li><a href=\"https://github.com/GenerationSoftware/pt-v5-claimer\">pt-v5-claimer</a></li>\n</ul>\n<p>(all PRs have been merged into main)</p>\n<h3 id=\"individual-prs\" style=\"position:relative;\"><a href=\"#individual-prs\" aria-label=\"individual prs permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Individual PRs</h3>\n<table>\n<thead>\n<tr>\n<th>URL</th>\n<th>Mitigation of</th>\n<th>Purpose</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/13\">VAULT-PR-13</a></td>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/443\">H-01</a></td>\n<td>The issue turned out not to be the case; the exchange rate is always &#x3C;= 1 (yield is liquidated). However, comments were added to clarify the behaviour</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/9\">VAULT-PR-9</a></td>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/439\">H-02</a></td>\n<td>Added SafeCast</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/6\">VAULT-PR-6</a></td>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/427\">H-03</a></td>\n<td>Fixed conversion and naming of field</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/7\">VAULT-PR-7</a></td>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/396\">H-04</a></td>\n<td>Removed recipient param</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/19\">VAULT-PR-19</a></td>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/351\">H-05</a></td>\n<td>Removed recipient param</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/GenerationSoftware/pt-v5-twab-controller/pull/7\">TWAB-PR-7</a></td>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/206\">H-06</a></td>\n<td>Added check for zero address</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/13\">VAULT-PR-13</a></td>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/190\">H-07</a></td>\n<td>Fixed check for partial collateralization</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/pull/18\">PRIZE-PR-18</a></td>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/147\">H-08</a></td>\n<td>Fixed reserve accounting</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/37\">VAULT-PR-37</a></td>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/79\">H-09</a></td>\n<td>Fixed undercollateralized redemption while providing an exit</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/21\">VAULT-PR-21</a></td>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/465\">M-02</a></td>\n<td>Added hook gas limits and error handling</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/GenerationSoftware/pt-v5-twab-controller/pull/5\">TWAB-PR-5</a></td>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/464\">M-03</a></td>\n<td>Ensure search timestamps are on or at period end timestamps</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/11\">VAULT-PR-11</a></td>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/458\">M-04</a></td>\n<td>Fixed 4626 compliance</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/GenerationSoftware/pt-v5-twab-controller/pull/6\">TWAB-PR-6</a></td>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/452\">M-05</a></td>\n<td>Reject transfers to the sponsorship address</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/pull/31\">PRIZE-PR-31</a></td>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/431\">M-06</a></td>\n<td>Record deployer and permission draw manager</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/commit/ba56ea8bac3bce06f1e08ae071a19954dd720b1f\">PRIZE-COMMIT-ba56ea8b</a></td>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/423\">M-07</a></td>\n<td>Upgrade PRBMath to v4 and Solidity to 0.8.19</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/25\">VAULT-PR-25</a></td>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/416\">M-08</a></td>\n<td>Used CREATE2 for VaultFactory</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/GenerationSoftware/pt-v5-claimer/pull/7\">CLAIMER-PR-7</a></td>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/415\">M-09</a></td>\n<td>Made max fee a function of the tier’s prize size, not the smallest prize size</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/pull/16\">PRIZE-PR-16</a></td>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/399\">M-10</a></td>\n<td>Improved handling of prize size overflow</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/15\">VAULT-PR-15</a></td>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/384\">M-11</a></td>\n<td>Removed <code>mintWithPermit</code></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/pull/24\">PRIZE-PR-24</a></td>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/352\">M-12</a></td>\n<td>Recomputed Tier odds, reduced number of tiers, made grand prize period draws configurable</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/GenerationSoftware/pt-v5-twab-controller/pull/5\">TWAB-PR-5</a></td>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/334\">M-13</a></td>\n<td>Aligned twab queries on period boundaries</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/pull/17\">PRIZE-PR-17</a></td>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/332\">M-14</a></td>\n<td>Superseceded by the simplification of tier expansion logic</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/pull/17\">PRIZE-PR-17</a></td>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/331\">M-15</a></td>\n<td>Improved tier shrinking, retention, and expansion logic</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/pull/17\">PRIZE-PR-17</a></td>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/314\">M-16</a></td>\n<td>Simplified tier expansion logic</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/27\">VAULT-PR-27</a></td>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/256\">M-18</a></td>\n<td>Redeemed underlying liquidity using shares, not assets directly. This socializes losses, if any.</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/pull/22\">PRIZE-PR-22</a></td>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/243\">M-19</a></td>\n<td>Added SafeCast</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/18\">VAULT-PR-17</a></td>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/180\">M-20</a></td>\n<td>Vault shares are now 1:1 with underlying asset, and the exchange logic has been simplified</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/pull/10\">PRIZE-PR-10</a></td>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/150\">M-21</a></td>\n<td>Draw query ends on closed draw</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/18\">VAULT-PR-18</a></td>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/143\">M-22</a></td>\n<td>Improved vault share / asset calculation</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/11\">VAULT-PR-11</a></td>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/129\">M-23</a></td>\n<td>Fixed compliance with 4626</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/GenerationSoftware/pt-v5-claimer/pull/8\">CLAIMER-PR-8</a> <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/22\">VAULT-PR-22</a> <a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/pull/23\">PRIZE-PR-23</a></td>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/115\">M-24</a></td>\n<td>Added minVrgdaFee and allowed silent failure of claims</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/20\">VAULT-PR-20</a></td>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/113\">M-25</a></td>\n<td>Fixed permit implementations</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/9\">VAULT-PR-9</a></td>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/91\">M-26</a></td>\n<td>Added SafeCast</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/pull/17\">PRIZE-PR-17</a></td>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/61\">M-27</a></td>\n<td>Unified standard and canary tier</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"out-of-scope\" style=\"position:relative;\"><a href=\"#out-of-scope\" aria-label=\"out of scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Out of Scope</h2>\n<table>\n<thead>\n<tr>\n<th>Issue</th>\n<th>Reason</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/470\">M-01</a></td>\n<td>Acknowledged issue but it will not be fixed.</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/300\">M-17</a></td>\n<td>Permissionless nature of vaults means that anyone can create custom vaults.</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"mitigation-review-summary\" style=\"position:relative;\"><a href=\"#mitigation-review-summary\" aria-label=\"mitigation review summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation Review Summary</h2>\n<table>\n<thead>\n<tr>\n<th>Original Issue</th>\n<th>Status</th>\n<th>Full Details</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/443\">H-01</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/37\">0xStalin</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/86\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/27\">rvierdiiev</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/439\">H-02</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/3\">dirk_y</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/28\">rvierdiiev</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/25\">0xStalin</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/427\">H-03</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/4\">dirk_y</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/29\">rvierdiiev</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/36\">0xStalin</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/396\">H-04</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/30\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/5\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/26\">0xStalin</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/351\">H-05</a></td>\n<td>Mitigation error</td>\n<td>Report from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/31\">rvierdiiev</a> - details also shared below</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/206\">H-06</a></td>\n<td>Mitigation confirmed with comments</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/39\">0xStalin</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/9\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/32\">rvierdiiev</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/190\">H-07</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/40\">0xStalin</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/87\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/33\">rvierdiiev</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/147\">H-08</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/6\">dirk_y</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/34\">rvierdiiev</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/41\">0xStalin</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/79\">H-09</a></td>\n<td>Not fully mitigated</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/68\">0xStalin</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/35\">rvierdiiev</a> - details also shared below</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/465\">M-02</a></td>\n<td>Not fully mitigated</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/24\">dirk_y</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/42\">rvierdiiev</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/69\">0xStalin</a> - details also shared below</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/464\">M-03</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/98\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/43\">rvierdiiev</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/458\">M-04</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/74\">0xStalin</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/7\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/44\">rvierdiiev</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/452\">M-05</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/73\">0xStalin</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/11\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/45\">rvierdiiev</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/431\">M-06</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/46\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/12\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/83\">0xStalin</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/423\">M-07</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/84\">0xStalin</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/13\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/47\">rvierdiiev</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/416\">M-08</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/14\">dirk_y</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/48\">rvierdiiev</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/82\">0xStalin</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/415\">M-09</a></td>\n<td>Mitigation error</td>\n<td>Report from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/15\">dirk_y</a> - details also shared below</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/399\">M-10</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/85\">0xStalin</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/16\">dirk_y</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/384\">M-11</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/17\">dirk_y</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/51\">rvierdiiev</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/76\">0xStalin</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/352\">M-12</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/90\">0xStalin</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/18\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/52\">rvierdiiev</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/334\">M-13</a></td>\n<td>Mitigation confirmed with comments</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/99\">dirk_y</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/72\">0xStalin</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/53\">rvierdiiev</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/332\">M-14</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/91\">0xStalin</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/102\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/54\">rvierdiiev</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/331\">M-15</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/93\">0xStalin</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/101\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/55\">rvierdiiev</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/314\">M-16</a></td>\n<td>Mitigation error</td>\n<td>Report from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/104\">dirk_y</a> - details also shared below</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/256\">M-18</a></td>\n<td>Not fully mitigated</td>\n<td>Report from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/97\">dirk_y</a> - details also shared below</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/243\">M-19</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/95\">0xStalin</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/19\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/58\">rvierdiiev</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/180\">M-20</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/89\">dirk_y</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/59\">rvierdiiev</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/78\">0xStalin</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/150\">M-21</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/20\">dirk_y</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/60\">rvierdiiev</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/100\">0xStalin</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/143\">M-22</a></td>\n<td>Not fully mitigated</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/96\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/79\">0xStalin</a> - details also shared below</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/129\">M-23</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/75\">0xStalin</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/8\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/62\">rvierdiiev</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/115\">M-24</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/63\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/21\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/106\">0xStalin</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/113\">M-25</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/22\">dirk_y</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/64\">rvierdiiev</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/80\">0xStalin</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/91\">M-26</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/81\">0xStalin</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/23\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/65\">rvierdiiev</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/61\">M-27</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/66\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/103\">dirk_y</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/94\">0xStalin</a></td>\n</tr>\n</tbody>\n</table>\n<p><strong>The wardens determined that 4 findings from the original audit were not fully mitigated. They also surfaced 4 mitigation errors (1 High and 3 Medium severity) and 1 new Medium severity issue.</strong></p>\n<h2 id=\"h-05-mitigation-error-the-sponsorwithpermit-function-allows-anyone-to-provide-a-valid-permit-for-asset\" style=\"position:relative;\"><a href=\"#h-05-mitigation-error-the-sponsorwithpermit-function-allows-anyone-to-provide-a-valid-permit-for-asset\" aria-label=\"h 05 mitigation error the sponsorwithpermit function allows anyone to provide a valid permit for asset permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/31\">H-05 Mitigation error: The <code>sponsorWithPermit</code> function allows anyone to provide a valid permit for asset</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/31\">rvierdiiev</a></em></p>\n<p><strong>Severity: Medium</strong></p>\n<p>The <code>sponsor</code> function allows a caller to delegate their shares to the special address. In this case, the caller losses the ability to win prizes. The previous version of code had the <code>sponsor</code> function, which allowed the deposit of funds on behalf of the owner and delegate all user’s funds to the <code>SPONSORSHIP_ADDRESS</code>. As result, an attacker had the ability to deposit small amount of funds (or 0) on behalf of user and make them delegate to the <code>SPONSORSHIP_ADDRESS</code>.</p>\n<h3 id=\"solution\" style=\"position:relative;\"><a href=\"#solution\" aria-label=\"solution permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Solution</h3>\n<p>The PoolTogether team has fixed that issue by removing <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/b1deb5d494c25f885c34c83f014c8a855c5e2749/src/Vault.sol#L480-L482\">this function</a>. So now, the attacker can’t directly call <code>sponsor</code> for any address.</p>\n<p>However, there is another function, <code>sponsorWithPermit</code>. This function allows anyone to provide a valid permit for asset and then do the sponsoring. It’s possible that a user will create a permit for other purposes (to just run the <code>depositWithPermit</code> function). In this case, an attacker (which can be some other web portal) can reuse this permit and make the user delegate all of their balance to the <code>SPONSORSHIP_ADDRESS</code>, instead of just depositing.</p>\n<p>This issues stands, because currently the user can’t be sure how their signed message (permit) will be used. A user can sign the permit to deposit, but it will be used to deposit and delegate to the sponsorship address.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/31#issuecomment-1698345655\">PierrickGT (PoolTogether) commented</a>:</strong></p>\n<blockquote>\n<p>Nice find, indeed. I’ve removed the <code>sponsorWithPermit</code> function in the following PR: <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/40\">https://github.com/GenerationSoftware/pt-v5-vault/pull/40</a>.</p>\n</blockquote>\n<p><em>Note: For full discussion, see <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/31\">here</a>.</em></p>\n<hr>\n<h2 id=\"h-09-not-fully-mitigated-_yieldvaultmaxwithdraw-returning-a-different-value-than-the-expected-real-balance-of-the-caller\" style=\"position:relative;\"><a href=\"#h-09-not-fully-mitigated-_yieldvaultmaxwithdraw-returning-a-different-value-than-the-expected-real-balance-of-the-caller\" aria-label=\"h 09 not fully mitigated _yieldvaultmaxwithdraw returning a different value than the expected real balance of the caller permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/68\">H-09 Not fully mitigated: <code>_yieldVault.maxWithdraw()</code> returning a different value than the expected real balance of the caller</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/68\">0xStalin</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/35\">rvierdiiev</a></em></p>\n<h3 id=\"original-issue\" style=\"position:relative;\"><a href=\"#original-issue\" aria-label=\"original issue permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Original Issue</h3>\n<p><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/79\">H-09: Vault is not compatible with some ERC4626 vaults</a></p>\n<h3 id=\"details\" style=\"position:relative;\"><a href=\"#details\" aria-label=\"details permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Details</h3>\n<p>The issue is about the Vault contract not being compatible with some ERC4626 vaults, such as <code>DnGmxSeniorVault</code>.</p>\n<ul>\n<li>The warning is about vaults that don’t stick to the ERC4626 standard, and their <code>maxWithdraw()</code> function returns a different value than the expected real balance of the caller.</li>\n</ul>\n<h3 id=\"mitigation-1\" style=\"position:relative;\"><a href=\"#mitigation-1\" aria-label=\"mitigation 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation</h3>\n<p>The mitigation implemented new logic to determine if the Vault is collateralized or not. Now, all shares are backed 1:1 with deposited assets.</p>\n<p>When withdrawing and redeeming, the new implementation checks if the vault is collateralized or not; if it’s collateralized, the shares:asset ratio is 1:1, if it’s under-collateralized, the ratio will be different, and the functions will compute how many shares are required to withdraw the desired amount of assets.</p>\n<ul>\n<li>\n<p>If the vault is under-collateralized:</p>\n<ul>\n<li>The <code>withdraw()</code> function will compute the required amount of shares that are required to get the desired amount of assets.</li>\n<li>The <code>redeem()</code> function will compute how many assets the specified amount of shares can get.</li>\n</ul>\n</li>\n</ul>\n<p>The new implementation mitigates socializing losses when the vault is under-collateralized. Now, each user can withdraw/redeem up to their <code>maxWithdraw()</code>/<code>maxRedeem()</code> amounts of assets, which those values are determined based on the amount of shares that the owner has.</p>\n<h3 id=\"conclusion-1\" style=\"position:relative;\"><a href=\"#conclusion-1\" aria-label=\"conclusion 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h3>\n<p>I consider that the new implementation mitigates issues that can arise because of ERC4626 vaults not implementing the expected ERC4626 standard.</p>\n<p>In regards to the exact issue pointed out in the original finding about the <code>_yieldVault.maxWithdraw()</code> returning a different value than the expected real balance of the caller, I do agree with the sponsor’s comment that the issue is more of warning about possible incompatibilities with some ERC4626 vaults. For that reason, I think that there is not such a fix for that exact “issue”, that is more a thing at the administration level when creating new vaults. The vault’s creator should do their due diligence to verify that the ERC4626 Vault follows in the most part the standard.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/35#issuecomment-1698153901\">dirk_y (warden) commented via issue #35</a>:</strong></p>\n<blockquote>\n<p>Sounds like we’ve all kind of come to the same conclusion here (see <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/68\">#68</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/97\">#97</a>). Basically, the only real resolution is discouraging certain types of underlying yield vaults</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/35#issuecomment-1698356003\">0xStalin (warden) commented via issue #35</a>:</strong></p>\n<blockquote>\n<p>@dirk_y - I agree with your comment. I think this can be classified as a Q&#x26;A, since this is more of an administration thing. It is up to the vault’s creator to select the underlying vault, and it is up to the users to decide if they want to put their assets in a PT Vault using an underlying vault that doesn’t stick to the standard and/or implements lossy strategies.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/35#issuecomment-1698468800\">asselstine (PoolTogether) commented via issue #35</a>:</strong></p>\n<blockquote>\n<p>Our mitigation is that we will declare that vault compatibility needs to be checked before integrating, and that yield vaults that round down on deposit are problematic. </p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-not-fully-mitigated-a-malicious-user-can-still-gas-grief-a-claimer-by-deliberately-reverting-in-a-hook\" style=\"position:relative;\"><a href=\"#m-02-not-fully-mitigated-a-malicious-user-can-still-gas-grief-a-claimer-by-deliberately-reverting-in-a-hook\" aria-label=\"m 02 not fully mitigated a malicious user can still gas grief a claimer by deliberately reverting in a hook permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/24\">M-02 Not fully mitigated: A malicious user can still gas grief a claimer by deliberately reverting in a hook</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/24\">dirk_y</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/42\">rvierdiiev</a> and <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/69\">0xStalin</a></em></p>\n<h3 id=\"original-issue-1\" style=\"position:relative;\"><a href=\"#original-issue-1\" aria-label=\"original issue 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Original Issue</h3>\n<p><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/465\">M-02: Unintended or malicious use of prize winners’ hooks</a></p>\n<h3 id=\"lines-of-code-10\" style=\"position:relative;\"><a href=\"#lines-of-code-10\" aria-label=\"lines of code 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lines of code</h3>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/main/src/Vault.sol#L1397\">https://github.com/GenerationSoftware/pt-v5-vault/blob/main/src/Vault.sol#L1397</a><br>\n<a href=\"https://github.com/GenerationSoftware/pt-v5-claimer/blob/main/src/Claimer.sol#L163\">https://github.com/GenerationSoftware/pt-v5-claimer/blob/main/src/Claimer.sol#L163</a></p>\n<h3 id=\"comments\" style=\"position:relative;\"><a href=\"#comments\" aria-label=\"comments permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Comments</h3>\n<p>In the previous implementation, a malicious user could set arbitrary vault hooks for <code>afterClaimPrize</code> and <code>beforeClaimPrize</code> that could be used to gas grief the claimer; or cause other claims in the same call to fail by deliberately reverting.</p>\n<h3 id=\"mitigation-2\" style=\"position:relative;\"><a href=\"#mitigation-2\" aria-label=\"mitigation 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation</h3>\n<p>The referenced PR does solve the original issue by capping the gas sent to external calls and safely catching reverts. I was slightly concerned that enough gas was being passed to the hooks for a single reentrant call to front-run a prize claim; however, this has been fixed by another change where previously claimed prizes safely return 0. However, this mitigation is unresolved by another change.</p>\n<h3 id=\"persisting-issue\" style=\"position:relative;\"><a href=\"#persisting-issue\" aria-label=\"persisting issue permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Persisting issue</h3>\n<p>There was another change made to the repo where claiming logic was simplified and mainly moved out of the Vault contract. However, with this change any reverts are not being safely caught:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"120\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function _claim(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    Vault _vault,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint8 _tier,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address[] calldata _winners,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint32[][] calldata _prizeIndices,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address _feeRecipient,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint96 _feePerClaim</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ) internal returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 actualClaimCount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 winnersLength = _winners.length;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    for (uint256 w = 0; w &lt; winnersLength; w++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      uint256 prizeIndicesLength = _prizeIndices[w].length;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      for (uint256 p = 0; p &lt; prizeIndicesLength; p++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (0 != _vault.claimPrize(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          _winners[w],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          _tier,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          _prizeIndices[w][p],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          _feePerClaim,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          _feeRecipient</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        )) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          actualClaimCount++;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          emit AlreadyClaimed(_winners[w], _tier, _prizeIndices[w][p]);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    return actualClaimCount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p>This is a problem because if the hook reverts, this is caught and then another revert is thrown:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"121\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function claimPrize(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address _winner,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint8 _tier,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint32 _prizeIndex,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint96 _fee,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address _feeRecipient</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ) external onlyClaimer returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    VaultHooks memory hooks = _hooks[_winner];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address recipient;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (hooks.useBeforeClaimPrize) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      try</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        hooks.implementation.beforeClaimPrize{ gas: HOOK_GAS }(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          _winner,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          _tier,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          _prizeIndex,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          _fee,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          _feeRecipient</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      returns (address result) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        recipient = result;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      } catch (bytes memory reason) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        revert BeforeClaimPrizeFailed(reason);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      recipient = _winner;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>As a result, a malicious user can still gas grief a claimer by deliberately reverting in a hook.</p>\n<h3 id=\"recommendation\" style=\"position:relative;\"><a href=\"#recommendation\" aria-label=\"recommendation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>The reverts should be safely caught in the Claimer contract, similarly to the initial change (and linked PR) that fixed this issue originally.</p>\n<h3 id=\"assessed-type-29\" style=\"position:relative;\"><a href=\"#assessed-type-29\" aria-label=\"assessed type 29 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Loop</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/24#issuecomment-1698387526\">asselstine (PoolTogether) commented</a>:</strong></p>\n<blockquote>\n<p>Handled here <a href=\"https://github.com/GenerationSoftware/pt-v5-claimer/pull/13\">https://github.com/GenerationSoftware/pt-v5-claimer/pull/13</a>.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-09-mitigation-error-auctions-run-at-significantly-different-speeds-for-different-prize-tiers\" style=\"position:relative;\"><a href=\"#m-09-mitigation-error-auctions-run-at-significantly-different-speeds-for-different-prize-tiers\" aria-label=\"m 09 mitigation error auctions run at significantly different speeds for different prize tiers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/15\">M-09 Mitigation error: Auctions run at significantly different speeds for different prize tiers</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/15\">dirk_y</a></em></p>\n<p><strong>Severity: Medium</strong></p>\n<h3 id=\"lines-of-code-11\" style=\"position:relative;\"><a href=\"#lines-of-code-11\" aria-label=\"lines of code 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lines of code</h3>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-claimer/blob/main/src/Claimer.sol#L76-L78\">https://github.com/GenerationSoftware/pt-v5-claimer/blob/main/src/Claimer.sol#L76-L78</a><br>\n<a href=\"https://github.com/GenerationSoftware/pt-v5-claimer/blob/main/src/Claimer.sol#L136\">https://github.com/GenerationSoftware/pt-v5-claimer/blob/main/src/Claimer.sol#L136</a><br>\n<a href=\"https://github.com/GenerationSoftware/pt-v5-claimer/blob/main/src/Claimer.sol#L262-L264\">https://github.com/GenerationSoftware/pt-v5-claimer/blob/main/src/Claimer.sol#L262-L264</a><br>\n<a href=\"https://github.com/GenerationSoftware/pt-v5-claimer/blob/main/src/Claimer.sol#L223-L250\">https://github.com/GenerationSoftware/pt-v5-claimer/blob/main/src/Claimer.sol#L223-L250</a><br>\n<a href=\"https://github.com/GenerationSoftware/pt-v5-claimer/blob/main/src/Claimer.sol#L289\">https://github.com/GenerationSoftware/pt-v5-claimer/blob/main/src/Claimer.sol#L289</a></p>\n<h3 id=\"comments-1\" style=\"position:relative;\"><a href=\"#comments-1\" aria-label=\"comments 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Comments</h3>\n<p>The V5 implementation delegates the task of claiming prizes to a network of claimers. The fees received by a claimer are calculated based on a dutch auction and limited based on the prize size of the highest tier (the smallest prize). As a result, it is possible that the gas price could exceed the fee received by claimers, leading to prizes not being claimed. If any high value prizes happen to be drawn during this period then they will go unclaimed.</p>\n<h3 id=\"mitigation-3\" style=\"position:relative;\"><a href=\"#mitigation-3\" aria-label=\"mitigation 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation</h3>\n<p>The new implementation only computes the <code>maxFee</code> size based on the prize tier that is being claimed for. As a result, the fees received by claimers are now larger for larger prize tiers; thereby, incentivising lower tiers (i.e. those with higher prizes) to be claimed first and resulting in more fees paid to claimers.</p>\n<h3 id=\"new-issue\" style=\"position:relative;\"><a href=\"#new-issue\" aria-label=\"new issue permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>New issue</h3>\n<p>Because all the tiers run on the same auction, each auction will now run at a completely different speed.</p>\n<h3 id=\"impact-11\" style=\"position:relative;\"><a href=\"#impact-11\" aria-label=\"impact 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>If the <code>_maximumFee</code> parameter specified in the constructor is relatively small, then the <code>maxFee</code> for the lower prize tiers (higher prizes) will never be reached anyway. If the <code>_maximumFee</code> is relatively large to give sufficient range for the auctions, the auctions for higher tiers (lower prizes) will ramp up very quickly to the max limit based on the prize tier. The real impact of this is that auctions are now running inefficiently, where fees are likely to be higher than they could be for the higher tiers (i.e. the bots are getting more fees than they would be willing to accept).</p>\n<h3 id=\"proof-of-concept-34\" style=\"position:relative;\"><a href=\"#proof-of-concept-34\" aria-label=\"proof of concept 34 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Based on the updated implementation, the maximum fee to be paid is now a function of the tier being claimed for, not the total number of active tiers:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"122\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function _computeMaxFee(uint8 _tier) internal view returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    return UD60x18.unwrap(maxFeePortionOfPrize.intoUD60x18().mul(UD60x18.wrap(prizePool.getTierPrizeSize(_tier))));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p>The return value of this call is used as the first parameter for calls to <code>_computeFeePerClaim</code> and in turn the last parameter of <code>_computeFeeForNextClaim</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"123\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function _computeFeeForNextClaim(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _minimumFee,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    SD59x18 _decayConstant,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    SD59x18 _perTimeUnit,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _elapsed,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _sold,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _maxFee</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ) internal pure returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 fee = LinearVRGDALib.getVRGDAPrice(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _minimumFee,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _elapsed,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _sold,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _perTimeUnit,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _decayConstant</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    return fee &gt; _maxFee ? _maxFee : fee;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p>As you can see, the fee is capped based on the <code>maxFee</code> for the prize tier being claimed for. This seems to be doing what was intended; however, there is only one auction for all the tiers, and thus the auction decay constant is consistent across all the tiers:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"124\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  constructor(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    PrizePool _prizePool,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _minimumFee,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _maximumFee,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _timeToReachMaxFee,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    UD2x18 _maxFeePortionOfPrize</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (_minimumFee &gt;= _maximumFee) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      revert MinFeeGeMax(_minimumFee, _maximumFee);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    prizePool = _prizePool;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    maxFeePortionOfPrize = _maxFeePortionOfPrize;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    decayConstant = LinearVRGDALib.getDecayConstant(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      LinearVRGDALib.getMaximumPriceDeltaScale(_minimumFee, _maximumFee, _timeToReachMaxFee)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    minimumFee = _minimumFee;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    timeToReachMaxFee = _timeToReachMaxFee;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p>Whichever is the lowest of the auction <code>_maximumFee</code> and the tier <code>maxFee</code> is the max fee that could possibly be collected. In order to allow all prize tiers to be claimed it is likely that the <code>_maximumFee</code> in the constructor will be increased; however, this now means the decay constant is greater and therefore, the auctions ramp up faster. For tiers with a lower max fee, this means the <code>maxFee</code> is reached significantly faster, leading to inefficient auctions.</p>\n<h3 id=\"recommendation-1\" style=\"position:relative;\"><a href=\"#recommendation-1\" aria-label=\"recommendation 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Potentially, there is another angle to resolve the issue reported in the original audit by having a mechanism that allows the <code>maxFee</code> to be increased if not enough prizes have been redeemed in the last draw, although this introduces additional complexity.</p>\n<p>Alternatively there needs to be an auction for each tier with its own decay constant (i.e. min and max fees) to ensure that all the auctions are ramping up in a similar (but not necessarily identical) manner. In my opinion, this option makes the most sense and is the least complex and therefore, also the hardest to manipulate (if at all).</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/15#issuecomment-1698092072\">asselstine (PoolTogether) acknowledged</a></strong></p>\n<p><em>Note: For full discussion, see <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/15\">here</a>.</em></p>\n<hr>\n<h2 id=\"m-16-mitigation-error-number-of-prize-tiers-may-never-scale-due-to-aggressive-new-algorithm\" style=\"position:relative;\"><a href=\"#m-16-mitigation-error-number-of-prize-tiers-may-never-scale-due-to-aggressive-new-algorithm\" aria-label=\"m 16 mitigation error number of prize tiers may never scale due to aggressive new algorithm permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/104\">M-16 Mitigation error: Number of prize tiers may never scale due to aggressive new algorithm</a>.</h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/97\">dirk_y</a></em></p>\n<p><strong>Severity: Medium</strong></p>\n<h3 id=\"lines-of-code-12\" style=\"position:relative;\"><a href=\"#lines-of-code-12\" aria-label=\"lines of code 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lines of code</h3>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/main/src/PrizePool.sol#L369\">https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/main/src/PrizePool.sol#L369</a><br>\n<a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/main/src/PrizePool.sol#L807-L811\">https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/main/src/PrizePool.sol#L807-L811</a><br>\n<a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/main/src/abstract/TieredLiquidityDistributor.sol#L602-L619\">https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/main/src/abstract/TieredLiquidityDistributor.sol#L602-L619</a><br>\n<a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/main/src/abstract/TieredLiquidityDistributor.sol#L156\">https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/main/src/abstract/TieredLiquidityDistributor.sol#L156</a><br>\n<a href=\"https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/main/src/libraries/TierCalculationLib.sol#L134-L147\">https://github.com/GenerationSoftware/pt-v5-prize-pool/blob/main/src/libraries/TierCalculationLib.sol#L134-L147</a></p>\n<h3 id=\"comments-2\" style=\"position:relative;\"><a href=\"#comments-2\" aria-label=\"comments 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Comments</h3>\n<p>This issue is very similar to M-14 but covers another edge case where the threshold check is not performed when there are currently 14 prize tiers and at least 1 canary tier is claimed. This is due to an early return of <code>MAXIMUM_NUMBER_OF_TIERS</code>.</p>\n<h3 id=\"mitigation-4\" style=\"position:relative;\"><a href=\"#mitigation-4\" aria-label=\"mitigation 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation</h3>\n<p>The updated implementation has significantly changed the tier expansion logic so that it only depends on the total number of prize claims. The current number of tiers and the number of canary tier claims has no impact on the tier expansion logic and therefore, the original issue has been resolved. However, the updated logic has introduced a new issue.</p>\n<p>Note: The same PR fixes multiple issues, but I have arbitrarily chosen to link this new issue with M-16.</p>\n<h3 id=\"new-issue-1\" style=\"position:relative;\"><a href=\"#new-issue-1\" aria-label=\"new issue 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>New issue</h3>\n<p>With the new tier expansion algorithm, it is highly likely that the number of prize tiers will stagnate since the percentage of prizes that need to be claimed for a tier expansion increases as the number of tiers increase.</p>\n<h3 id=\"proof-of-concept-35\" style=\"position:relative;\"><a href=\"#proof-of-concept-35\" aria-label=\"proof of concept 35 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>When a draw is closed, the next number of tiers is computed based on the total number of claims with a call to <code>_computeNextNumberOfTiers</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"125\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function _computeNextNumberOfTiers(uint32 _claimCount) internal view returns (uint8) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // claimCount is expected to be the estimated number of claims for the current prize tier.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint8 numTiers = _estimateNumberOfTiersUsingPrizeCountPerDraw(_claimCount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    return numTiers &gt; MAXIMUM_NUMBER_OF_TIERS ? MAXIMUM_NUMBER_OF_TIERS : numTiers; // add new canary tier</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p>Where the first part of the underlying <code>_estimateNumberOfTiersUsingPrizeCountPerDraw</code> method looks like:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"126\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function _estimateNumberOfTiersUsingPrizeCountPerDraw(uint32 _prizeCount) internal view returns (uint8) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (_prizeCount &lt; ESTIMATED_PRIZES_PER_DRAW_FOR_4_TIERS) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      return 3;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    } else if (_prizeCount &lt; ESTIMATED_PRIZES_PER_DRAW_FOR_5_TIERS) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      return 4;</span></span></code></pre>\n<p>Thus, for the number of tiers to increase from 3 to 4, the number of prize claims must be greater than or equal to <code>ESTIMATED_PRIZES_PER_DRAW_FOR_4_TIERS</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"127\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">ESTIMATED_PRIZES_PER_DRAW_FOR_4_TIERS = TierCalculationLib.estimatedClaimCount(3, _grandPrizePeriodDraws);</span></span></code></pre>\n<p>Here, the estimated claim count is the sum of the number of prizes for a tier multiplied by the tier odds for all the tiers:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"128\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function estimatedClaimCount(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint8 _numberOfTiers,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint24 _grandPrizePeriod</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ) internal pure returns (uint32) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint32 count = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    for (uint8 i = 0; i &lt; _numberOfTiers; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      count += uint32(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          unwrap(sd(int256(prizeCount(i))).mul(getTierOdds(i, _numberOfTiers, _grandPrizePeriod)))</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    return count;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p>If we consider the actual number of prizes available for 3 tiers it is:\n<code>1 * 1/365 + 4 * 1 + 16 * 1 = 20 + 1/365 ~= 20</code></p>\n<p>The return value of <code>ESTIMATED_PRIZES_PER_DRAW_FOR_4_TIERS</code> is:\n<code>1 * 1/365 + 4 * 1/sqrt(365) + 16 * 1 ~= 16</code></p>\n<p>This difference is due to the fact that the <code>getTierOdds</code> in <code>TierCalculationLib.sol</code> doesn’t return 1 for both the highest normal prize tier and the canary tier (it just returns 1 for the canary tier).</p>\n<p>In this case, in order for the number of prize tiers to increase, at least 16 prizes (i.e. 80%) need to be claimed in the previous claim window. This doesn’t sound too bad, but because the number of prizes per tier scales exponentially, the percentage of prizes that need to be claimed increases as the number of prize tiers increase.</p>\n<p>The effect is that as a higher number of tiers are reached, a higher percentage of canary prizes need to be claimed in order to increase the number of prize tiers. The end result is that it is likely the number of prize tiers will stagnate despite there being enough liquidity available to increase the number of prize tiers.</p>\n<h3 id=\"recommendation-2\" style=\"position:relative;\"><a href=\"#recommendation-2\" aria-label=\"recommendation 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>I recommend applying a reverse exponential weighting to the number of prize claims required for a tier expansion based on the number of tiers. By this, I mean that since the number of prizes per tier is <code>4^i</code>, a similar weighting should be applied in the reverse direction to try to keep the percentage of prize claims required for a tier expansion relatively stable.</p>\n<p>Alternatively, I would update <code>_estimateNumberOfTiersUsingPrizeCountPerDraw</code> to apply a fixed percentage to the actual number of prizes available (based on tiers odds of 1 for both the canary prize tier and the highest standard prize tier). I feel like this is the easier and also more logical fix.</p>\n<h2 id=\"assessed-type-30\" style=\"position:relative;\"><a href=\"#assessed-type-30\" aria-label=\"assessed type 30 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h2>\n<p>Math</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/104#issuecomment-1698085444\">asselstine (PoolTogether) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>The solution we propose for this is to adjust two things:</p>\n<ol>\n<li><code>estimatedClaimCount</code> now includes canary tiers; this means that each of the constants <code>ESTIMATED_PRIZES_PER_DRAW_FOR_*_TIERS</code> will include canary prizes.</li>\n<li><code>_estimateNumberOfTiersUsingPrizeCountPerDraw</code> now <em>doubles</em> the given prize count before comparing against the <code>ESTIMATED</code> prize values. This is because each tier is approx 4x the previous, so by only doubling the prize count we create a safe buffer.</li>\n</ol>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/104#issuecomment-1698447294\">dirk_y (warden) commented</a>:</strong></p>\n<blockquote>\n<p>So just to confirm the intended behaviour of the suggested change, you want the number of tiers to increase if >50% of the estimated prizes in a tier are claimed?</p>\n<p>I agree that sounds safe to me. It’s not possible to scale up by more than 1 tier at a time this way.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-18-not-fully-mitigated-_redeem-method-doesnt-handle-the-case-where-the-withdrawal-from-the-underlying-yield-vault-realises-losses\" style=\"position:relative;\"><a href=\"#m-18-not-fully-mitigated-_redeem-method-doesnt-handle-the-case-where-the-withdrawal-from-the-underlying-yield-vault-realises-losses\" aria-label=\"m 18 not fully mitigated _redeem method doesnt handle the case where the withdrawal from the underlying yield vault realises losses permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/97\">M-18 Not fully mitigated: <code>_redeem</code> method doesn’t handle the case where the withdrawal from the underlying yield vault realises losses</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/97\">dirk_y</a></em></p>\n<h3 id=\"original-issue-2\" style=\"position:relative;\"><a href=\"#original-issue-2\" aria-label=\"original issue 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Original Issue</h3>\n<p><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/256\">M-18: Exchange rate change in case of Lossy Strategy will cause the Vault to under-collateralized for generic ERC4626 Yield Vaults</a></p>\n<h3 id=\"comments-3\" style=\"position:relative;\"><a href=\"#comments-3\" aria-label=\"comments 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Comments</h3>\n<p>The original implementation didn’t handle lossy withdrawals from underlying ERC-4626 yield vaults properly. During withdrawals from the V5 vault, the calculation of amount to withdraw/shares to burn is based on a <code>maxWithdraw</code> view function in the underlying yield vault. However, when the actual withdraw is performed from the yield vault, it is possible for the vault to apply losses. Based on the original implementation, this could cause the V5 vault to pay more shares (of the underlying yield vault) than intended, effectively diluting other vault depositors and causing losses for the last users who withdraw.</p>\n<h3 id=\"mitigation-5\" style=\"position:relative;\"><a href=\"#mitigation-5\" aria-label=\"mitigation 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation</h3>\n<p>The updated implementation in the linked diff is further updated based on the changes for H-09. The key changes related to the original issue is that now V5 vault shares can be converted into the underlying yield vault shares through methods like <code>_convertAssetsToYVAssets</code> (for asset conversions in this instance) to ensure that withdrawals burn the correct number of V5 vault shares in exchange for the underlying yield vault shares when the vault is in an under-collateralised state.</p>\n<p>However, technically the updated implementation doesn’t solve the original issue because the <code>_redeem</code> method still doesn’t handle the case where the withdrawal from the underlying yield vault realises losses. The vault is still considered collateralised based on the underlying <code>maxWithdraw</code> call, so it is possible that withdrawing a given number of assets actually burns more of the underlying yield vault shares owned by the V5 vault than intended; this still impacts those that withdraw/redeem later from the V5 vault.  </p>\n<h3 id=\"conclusion-2\" style=\"position:relative;\"><a href=\"#conclusion-2\" aria-label=\"conclusion 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h3>\n<p>Although the mitigation is technically unsuccessful, I personally agree with <a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/256#issuecomment-1674020085\">this comment</a> from the sponsor on the original issue.</p>\n<p>Although I do disagree with: “When withdrawing, people will only be able to withdraw their shares of deposits which indeed socializes the loss.” </p>\n<p>The losses only impact those that try to withdraw last from the V5 vault since there aren’t enough of the underlying yield vault shares left to redeem.</p>\n<p>To summarise, I think this is quite a specific use case that either needs to be explicitly supported, or the use of underlying lossy strategies should be discouraged. My personal opinion is that despite the mitigation not being resolved, I wouldn’t suggest any further changes; just wanted to be explicit that the original mitigation technically isn’t resolved. I would suggest that vaults employing underlying lossy strategies should be discouraged instead.</p>\n<h3 id=\"assessed-type-31\" style=\"position:relative;\"><a href=\"#assessed-type-31\" aria-label=\"assessed type 31 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>ERC4626</p>\n<h2 id=\"m-22-not-fully-mitigated-deposits-could-revert-if-there-is-a-loss-of-precision-of-1-wei-in-the-underlying-yield-vault\" style=\"position:relative;\"><a href=\"#m-22-not-fully-mitigated-deposits-could-revert-if-there-is-a-loss-of-precision-of-1-wei-in-the-underlying-yield-vault\" aria-label=\"m 22 not fully mitigated deposits could revert if there is a loss of precision of 1 wei in the underlying yield vault permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/96\">M-22 Not fully mitigated: deposits could revert if there is a loss of precision of 1 wei in the underlying yield vault</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/96\">dirk_y</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/79\">0xStalin</a></em></p>\n<h3 id=\"original-issue-3\" style=\"position:relative;\"><a href=\"#original-issue-3\" aria-label=\"original issue 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Original Issue</h3>\n<p><a href=\"https://github.com/code-423n4/2023-07-pooltogether-findings/issues/143\">M-22: Loss of precision leads to under-collateralized</a></p>\n<h3 id=\"lines-of-code-13\" style=\"position:relative;\"><a href=\"#lines-of-code-13\" aria-label=\"lines of code 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lines of code</h3>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/main/src/Vault.sol#L1183-L1184\">https://github.com/GenerationSoftware/pt-v5-vault/blob/main/src/Vault.sol#L1183-L1184</a></p>\n<h3 id=\"comments-4\" style=\"position:relative;\"><a href=\"#comments-4\" aria-label=\"comments 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Comments</h3>\n<p>The underlying yield vaults used by the V5 vaults usually round down shares received when depositing. As a result, if the Vault deposits to an underlying yield vault that has already issued shares, it is possible that a deposit could be rounded down to a lower number of shares. As a result, user deposits could fail because the vault will be considered not-collateralised due to the 1 wei difference in expected withdrawable assets from the yield vault.</p>\n<h3 id=\"mitigation-6\" style=\"position:relative;\"><a href=\"#mitigation-6\" aria-label=\"mitigation 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation</h3>\n<p>The updated implementation now compares the withdrawable assets after a deposit with the expected withdrawal amount based on the size of the deposit and reverts if the former is less than the latter. This ensures that the vault isn’t inadvertently becoming undercollateralised during a deposit.</p>\n<h3 id=\"mitigation-not-resolved\" style=\"position:relative;\"><a href=\"#mitigation-not-resolved\" aria-label=\"mitigation not resolved permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation not resolved</h3>\n<p>The new implementation doesn’t necessarily solve the original issue because it just reverts if the updated withdrawable assets from the underlying yield vault is less than the assets we’ve just deposited; yes, it prevents the vault from being under-collateralised, but now deposits could revert if there is a loss of precision of 1 wei in the underlying yield vault. If we wanted to protect against a rounding issue we should add in a 1 wei tolerance to the updated deposit computation. Even though the model OZ implementation rounds up for conversion in one direction and then rounds down for for conversion in the other direction, we cannot guarantee that all underlying yield vaults will do this. Thus, we should still have a small wei buffer to account for any rounding issues; otherwise, we might inadvertently end up bricking deposits for users in certain conditions where the deposit amount paired with the underlying vault balance leads to a rounding discrepancy.</p>\n<h3 id=\"suggestion\" style=\"position:relative;\"><a href=\"#suggestion\" aria-label=\"suggestion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Suggestion</h3>\n<p>In order to prevent a user from deliberately depositing assets that will result in a loss of precision in the underlying yield vault (and therefore, lead to undercollateralisation with the first deposit), I’d recommend allowing the V5 vault owner to specify a minimum deposit value that is then enforced in the deposit and mint methods. Any further loss of precision should be guarded against as suggested in the original report.</p>\n<p>Below is a suggested diff:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"129\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">diff --git a/src/Vault.sol b/src/Vault.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">index 4da1d00..b784477 100644</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--- a/src/Vault.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+++ b/src/Vault.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">@@ -1180,7 +1180,7 @@ contract Vault is IERC4626, ERC20Permit, ILiquidationSource, Ownable {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     uint256 _expectedWithdrawableAssets = _withdrawableAssets + _assets;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     uint256 _withdrawableAssetsAfter = _totalAssets();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-    if (_withdrawableAssetsAfter &lt; _expectedWithdrawableAssets)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    if (_withdrawableAssetsAfter + 1 &lt; _expectedWithdrawableAssets)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">       revert YVWithdrawableAssetsLTExpected(_withdrawableAssetsAfter, _expectedWithdrawableAssets);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     _mint(_receiver, _assets);</span></span></code></pre>\n<h3 id=\"assessed-type-32\" style=\"position:relative;\"><a href=\"#assessed-type-32\" aria-label=\"assessed type 32 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Math</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/96#issuecomment-1698231160\">PierrickGT (PoolTogether) commented</a>:</strong></p>\n<blockquote>\n<p>The suggestion proposed is not really fixing the issue though, no?\nIf I deposit <code>1000000000</code> but this deposit is only worth <code>999999999</code>, when I will withdraw, I will only receive back <code>999999999</code>?</p>\n<p>So the protocol would not be no loss anymore.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/96#issuecomment-1698239830\">dirk_y (warden) commented</a>:</strong></p>\n<blockquote>\n<p>That’s true, the “no loss” claim then technically isn’t guaranteed, although a 1 wei loss is ~0 in practically every token, so I’m not sure this should hold too much weight.</p>\n<p>The proposed suggestion was more around ensuring deposits wouldn’t be reverted if the amount happened to cause a rounding issue based on the balance of the underlying vault. Since you don’t have control of the underlying yield vault, you have to either revert on loss of precision (which you’re doing now) or absorb the 1 wei loss; I’d argue the former has a greater impact on the user since the gas used is worth more than 1 wei of a token.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/96#issuecomment-1698468503\">asselstine (PoolTogether) commented</a>:</strong></p>\n<blockquote>\n<p>Our mitigation is that we will declare that vault compatibility needs to be checked before integrating, and that yield vaults that round down on deposit are problematic.</p>\n</blockquote>\n<p>*Note: for full discussion, see <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/96\">here</a>.</p>\n<hr>\n<h2 id=\"claiming-prizes-will-be-bricked-if-prize-periods-are-not-aligned-with-twab-periods\" style=\"position:relative;\"><a href=\"#claiming-prizes-will-be-bricked-if-prize-periods-are-not-aligned-with-twab-periods\" aria-label=\"claiming prizes will be bricked if prize periods are not aligned with twab periods permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/99\">Claiming prizes will be bricked if prize periods are not aligned with twab periods</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/99\">dirk_y</a></em></p>\n<h3 id=\"lines-of-code-14\" style=\"position:relative;\"><a href=\"#lines-of-code-14\" aria-label=\"lines of code 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lines of code</h3>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-twab-controller/blob/main/src/TwabController.sol#L281-L299\">https://github.com/GenerationSoftware/pt-v5-twab-controller/blob/main/src/TwabController.sol#L281-L299</a><br>\n<a href=\"https://github.com/GenerationSoftware/pt-v5-twab-controller/blob/main/src/libraries/TwabLib.sol#L244-L251\">https://github.com/GenerationSoftware/pt-v5-twab-controller/blob/main/src/libraries/TwabLib.sol#L244-L251</a><br>\n<a href=\"https://github.com/GenerationSoftware/pt-v5-twab-controller/blob/main/src/libraries/TwabLib.sol#L650-L658\">https://github.com/GenerationSoftware/pt-v5-twab-controller/blob/main/src/libraries/TwabLib.sol#L650-L658</a></p>\n<h3 id=\"comments-5\" style=\"position:relative;\"><a href=\"#comments-5\" aria-label=\"comments 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Comments</h3>\n<p>The previous implementation allowed a malicious user to keep updating their balances, provided if the previous observation fell within the same period. As such, if a draw ends part of the way through a period, the user would be able to manipulate their average balance for period and therefore, increase their odds of winning in that draw despite the draw already being closed.</p>\n<p>Note: I have arbitrarily chosen M-13 for this report rather than M-03 since both share the same PR for their respective mitigations.</p>\n<h3 id=\"mitigation-7\" style=\"position:relative;\"><a href=\"#mitigation-7\" aria-label=\"mitigation 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation</h3>\n<p>The updated implementation overlaps with M-03 and ensures that twab queries are aligned on twab period boundaries. It also ensures that any Twab queries have an end time that is finalised; i.e. the period that is being queried for has ended. This ensures that a user can’t manipulate their Twab balance between the time that a draw period ends and a Twab period ends. The original issue has been resolved, but a new issue has been introduced.</p>\n<h3 id=\"new-issue-2\" style=\"position:relative;\"><a href=\"#new-issue-2\" aria-label=\"new issue 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>New issue</h3>\n<p>Claiming prizes is bricked if prize periods are not aligned with twab periods</p>\n<h3 id=\"proof-of-concept-36\" style=\"position:relative;\"><a href=\"#proof-of-concept-36\" aria-label=\"proof of concept 36 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof Of Concept</h3>\n<p>Although the updated logic solves the original issue about ensuring that the observations are safe (i.e. finalised) and observations can’t be manipulated, the change has introduced a new issue where prize claiming is bricked if the twab periods are not completely aligned or are not significantly shorter than the prize pool periods (claiming is still bricked, but for a shorter duration). This was not the case before and in fact the only requirement was that “It is imperative that PoolTogether uses periods that are smaller than a single draw”. With the change, this is now only partially true. Either the Twab period needs to be significantly smaller than a prize draw period, or alternatively the period needs to be exactly aligned with the draw period. For example, if a draw is 1 day but the period for the accumulator is 20 hours, it is possible that the there will be a 20 hour period during which any claims will revert due to the end time not yet being finalised. This could result in two possible issues: either prizes will go unclaimed altogether, or more fees are paid to claimers since the price of the auction is increasing during this bricked period. Claiming prizes will be bricked up to the maximum period length of the accumulator, assuming the twab period started 1 second before the draw period ended and the twab period was the same length as the draw period.</p>\n<p>To illustrate this issue further, let’s explore the updated implementation. When prizes are claimed, the winning odds are calculated, which includes a call to <code>getTwabBetween</code> in the <code>TwabController.sol</code> contract:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"130\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function getTwabBetween(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address vault,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address user,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint32 startTime,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint32 endTime</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ) external view returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    TwabLib.Account storage _account = userObservations[vault][user];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // We snap the timestamps to the period end on or after the timestamp because the total supply records will be sparsely populated.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // if two users update during a period, then the total supply observation will only exist for the last one.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    return</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      TwabLib.getTwabBetween(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        PERIOD_LENGTH,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        PERIOD_OFFSET,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _account.observations,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _account.details,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _periodEndOnOrAfter(startTime),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _periodEndOnOrAfter(endTime)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p>The start and end times passed as arguments corresponds to the start and end times of the prize tier draw frequency (i.e. daily for the highest prize tier). These times are then aligned to Twab period boundaries with the underlying <code>_periodEndOnOrAfter</code> call.</p>\n<p>The key point now is that the underlying <code>getTwabBetween</code> call requires the end time to be finalised:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"131\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function getTwabBetween(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint32 PERIOD_LENGTH,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint32 PERIOD_OFFSET,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ObservationLib.Observation[MAX_CARDINALITY] storage _observations,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    AccountDetails memory _accountDetails,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint32 _startTime,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint32 _endTime</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ) internal view requireFinalized(PERIOD_LENGTH, PERIOD_OFFSET, _endTime) returns (uint256) {</span></span></code></pre>\n<p>Where <code>requireFinalized</code> looks like:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"132\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">modifier requireFinalized(uint32 PERIOD_LENGTH, uint32 PERIOD_OFFSET, uint256 _timestamp) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // The current period can still be changed; so the start of the period marks the beginning of unsafe timestamps.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint32 overwritePeriodStartTime = _currentOverwritePeriodStartedAt(PERIOD_LENGTH, PERIOD_OFFSET);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // timestamp == overwritePeriodStartTime doesn&#39;t matter, because the cumulative balance won&#39;t be impacted</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (_timestamp &gt; overwritePeriodStartTime) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      revert TimestampNotFinalized(_timestamp, overwritePeriodStartTime);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p>For the sake of argument, let’s say that a claimer is trying to claim a prize for the highest tier that is drawn daily, and the twab period ends 1 hour before the draw period. Now, when a claimer tries to claim the prize, the initial <code>getTwabBetween</code> call will align the start and end times to twab period boundaries. So the start time will align to the end of the last period, and the end time will align to the end of the current period. However, the current period hasn’t finalised yet! The current period finalises 23 hours after the draw has completed, which means that any prize claims for the tier will revert. During this time, the auction is still running, so the fee is perpetually increasing. After the 23 hours have elapsed, the claimers now only have 1 hour to claim the prizes, leading to either of the two scenarios mentioned above.</p>\n<h3 id=\"recommendation-3\" style=\"position:relative;\"><a href=\"#recommendation-3\" aria-label=\"recommendation 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>I recommend aligning the shortest prize period to the twab period and enforcing this in the constructor of the Prize Pool contract.</p>\n<h3 id=\"assessed-type-33\" style=\"position:relative;\"><a href=\"#assessed-type-33\" aria-label=\"assessed type 33 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Timing</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/99#issuecomment-1698091760\">asselstine (PoolTogether) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/99#issuecomment-1698361456\">0xStalin (warden) commented</a>:</strong></p>\n<blockquote>\n<p>This is a good finding. Although, it looks like there needs to be a couple of onchain conditions for the two scenarios to occur. I think this should be classified as a medium sev because of the number of onchain requirements for the issue to occur.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/99#issuecomment-1698371929\">dirk_y (warden) commented</a>:</strong></p>\n<blockquote>\n<p>There is only one condition that needs to be true: twab periods are not aligned with prize pool periods. And in fact, this behaviour would have been guaranteed based on the <a href=\"https://dev.pooltogether.com/protocol/next/design/twab-controller/#recording-an-observation\">official documentation</a>.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/99#issuecomment-1706990178\">Picodes (judge) commented</a>:</strong></p>\n<blockquote>\n<p>On first analysis, I do agree that the external conditions are minimal so it fits High severity.</p>\n</blockquote>\n<hr>\n<h2 id=\"vault-will-stop-participating-in-draws-in-the-case-they-deposited-maximum-assets-to-the-underlying-vault\" style=\"position:relative;\"><a href=\"#vault-will-stop-participating-in-draws-in-the-case-they-deposited-maximum-assets-to-the-underlying-vault\" aria-label=\"vault will stop participating in draws in the case they deposited maximum assets to the underlying vault permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/67\">Vault will stop participating in draws in the case they deposited maximum assets to the underlying vault</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/67\">rvierdiiev</a></em></p>\n<h3 id=\"lines-of-code-15\" style=\"position:relative;\"><a href=\"#lines-of-code-15\" aria-label=\"lines of code 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lines of code</h3>\n<p><a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/main/src/Vault.sol#L1399\">https://github.com/GenerationSoftware/pt-v5-vault/blob/main/src/Vault.sol#L1399</a></p>\n<h3 id=\"proof-of-concept-37\" style=\"position:relative;\"><a href=\"#proof-of-concept-37\" aria-label=\"proof of concept 37 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Vault contract <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/main/src/Vault.sol#L506-L515\">has a <code>maxMint</code> function</a>. This function first checks allowed amount to mint in the <code>PtVault</code> and then also <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/main/src/Vault.sol#L512-L514\">checks the amount allowed in underlying vault</a>. It is very likely that this value will be less than what is in <code>PtVault</code>, as some vaults can have restriction for 1 staker.</p>\n<p>This means, that once such amount of shares is minted, then <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/main/src/Vault.sol#L1398-L1399\">it’s not allowed to mint anymore</a>, so each deposit/mint will revert.</p>\n<p>In order to contribute earned yield to the prize pool, the liquidation pair should call the <code>liquidate</code> function.\nIt’s the only way to send earned yield to the prize pool.</p>\n<p>The next process is <code>liquidator</code> will provide POOL tokens on behalf of <code>Vault</code> and <code>Vault</code> <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/blob/main/src/Vault.sol#L783\">should mint the corresponding amount of shares</a> for <code>liquidator</code>. In this case, the call will be done after the max amount is minted. Then, it will revert, which means that it will be not possible to send the earned yield to the pool and earn prizes. In this moment, the main purpose of vault stopped working; users earned yield to participate in prize distributions, but they can’t do that.</p>\n<p>Of course, when someone will withdraw, it will be possible to liquidate again, but that will lead to bad a user experience and also someone can DoS pool by depositing again to not allow send contributions to the prize pool.</p>\n<p>Another thing that is related to this issue, is that in the case <code>maxMint</code> was reached, then <code>mintYieldFee</code> can’t be called as well, as it also mints shares.</p>\n<h3 id=\"tools-used-12\" style=\"position:relative;\"><a href=\"#tools-used-12\" aria-label=\"tools used 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VsCode</p>\n<h3 id=\"recommended-mitigation-steps-34\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-34\" aria-label=\"recommended mitigation steps 34 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Maybe it will be best to not check for <code>maxMint</code> for liquidations and fee minting.</p>\n<h3 id=\"assessed-type-34\" style=\"position:relative;\"><a href=\"#assessed-type-34\" aria-label=\"assessed type 34 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Error</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/67#issuecomment-1698112742\">asselstine (PoolTogether) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/67#issuecomment-1699594339\">PierrickGT (PoolTogether) commented</a>:</strong></p>\n<blockquote>\n<p>Interesting reasoning.</p>\n<p>Vault shares must be backed 1:1 by underlying assets deposited into the Yield Vault. If we mint more Vault shares than underlying assets withdrawable, we will enter in an under-collateralized state.</p>\n<p>That being said, the yield that accumulated in the Yield Vault is liquidated in exchange of Prize Tokens by minting more Vault shares. So even if <code>maxMint</code> is reached, we should be able to liquidate this yield.</p>\n<p>Fixed in this PR: <a href=\"https://github.com/GenerationSoftware/pt-v5-vault/pull/43\">https://github.com/GenerationSoftware/pt-v5-vault/pull/43</a>.</p>\n</blockquote>\n<p><em>Note: for full discussion, see <a href=\"https://github.com/code-423n4/2023-08-pooltogether-mitigation-findings/issues/67\">here</a>.</em></p>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Audits incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Audit submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-9\">High Risk Findings (9)</a></p>\n<ul>\n<li><a href=\"#h-01-the-_currentexchangerate-of-the-vault-contract-cant-increase-and-will-always-be-lower-than-or-equal-to-_assetunit\">[H-01] The <code>_currentExchangeRate</code> of the Vault contract can’t increase and will always be lower than or equal to <code>_assetUnit</code></a></li>\n<li><a href=\"#h-02-a-malicious-user-can-steal-other-users-deposits-from-vaultsol\">[H-02] A malicious user can steal other user’s deposits from Vault.sol</a></li>\n<li><a href=\"#h-03-_amountout-is-representing-assets-and-shares-at-the-same-time-in-the-liquidate-function\">[H-03] <code>_amountOut</code> is representing assets and shares at the same time in the <code>liquidate</code> function</a></li>\n<li><a href=\"#h-04-vaultmintyieldfee-function-can-be-called-by-anyone-to-mint-vault-shares-to-any-recipient-address\">[H-04] <code>Vault.mintYieldFee</code> function can be called by anyone to mint <code>Vault Shares</code> to any recipient address</a></li>\n<li><a href=\"#h-05-delegated-amounts-can-be-forcefully-removed-from-anyone-in-the-twabcontroller\">[H-05] Delegated amounts can be forcefully removed from anyone in the <code>TwabController</code></a></li>\n<li><a href=\"#h-06-resetting-delegation-will-result-in-user-funds-being-lost-forever\">[H-06] Resetting delegation will result in user funds being lost forever</a></li>\n<li><a href=\"#h-07-_requirevaultcollateralized-is-called-at-the-beginning-of-the-functions-mintyieldfee-and-liquidate-\">[H-07] <code>_requireVaultCollateralized()</code> is called at the beginning of the functions <code>mintYieldFee()</code> and <code>liquidate()</code> </a></li>\n<li><a href=\"#h-08-increasing-reserves-breaks-prizepool-accounting\">[H-08] Increasing reserves breaks PrizePool accounting</a></li>\n<li><a href=\"#h-09-vault-is-not-compatible-with-some-erc4626-vaults\">[H-09] <code>Vault</code> is not compatible with some ERC4626 vaults</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-27\">Medium Risk Findings (27)</a></p>\n<ul>\n<li><a href=\"#m-01-if-the-underlying-asset-is-a-fee-on-transfer-token-it-could-break-the-internal-accounting-of-the-vault\">[M-01] If the underlying asset is a fee on transfer token, it could break the internal accounting of the vault</a></li>\n<li><a href=\"#m-02-unintended-or-malicious-use-of-prize-winners-hooks\">[M-02] Unintended or malicious use of prize winners’ hooks</a></li>\n<li><a href=\"#m-03-twablibgettwabbetween-can-return-inaccurate-balances-if-_starttime-and-_endtime-arent-safely-bound\">[M-03] <code>TwabLib::getTwabBetween</code> can return inaccurate balances if <code>_startTime</code> and <code>_endTime</code> aren’t safely bound</a></li>\n<li><a href=\"#m-04-the-deposit-function-does-not-check-for-the-maxmint-amount\">[M-04] The deposit function does not check for the <code>maxMint</code> amount</a></li>\n<li><a href=\"#m-05-balance-invariant-between-the-individual-and-total-twabs-can-be-broken\">[M-05] Balance invariant between the individual and total <code>twabs</code> can be broken</a></li>\n<li><a href=\"#m-06-drawmanager-can-be-set-to-a-malicious-address\">[M-06] <code>drawManager</code> can be set to a malicious address</a></li>\n<li><a href=\"#m-07-in-important-libraries-of-pooltogether-the-pow-function-of-prbmath-is-used-which-exhibits-inconsistent-return-values\">[M-07] In important libraries of PoolTogether, the <code>pow()</code> function of PRBMath is used, which exhibits inconsistent return values</a></li>\n<li><a href=\"#m-08-an-attacker-can-front-run-deployvault-to-deploy-at-the-same-address\">[M-08] An attacker can front-run <code>deployVault</code> to deploy at the same address</a></li>\n<li><a href=\"#m-09-high-prizes-might-not-be-claimed\">[M-09] High Prizes might not be claimed</a></li>\n<li><a href=\"#m-10-prizepool---winners-wouldnt-be-able-to-claim-prize-correctly-in-claimprize-function-\">[M-10] <code>PrizePool</code> -> Winners wouldn’t be able to claim prize correctly in <code>claimPrize</code> function </a></li>\n<li><a href=\"#m-11-vaultmintwithpermit-can-be-dosd-\">[M-11] <code>Vault.mintWithPermit()</code> can be DoS’d </a></li>\n<li><a href=\"#m-12-the-tier-odds-in-tieredliquiditydistributor-are-incorrect\">[M-12] The tier odds in <code>TieredLiquidityDistributor</code> are incorrect</a></li>\n<li><a href=\"#m-13-users-can-manipulate-the-observation-creation\">[M-13] Users can manipulate the observation creation</a></li>\n<li><a href=\"#m-14-number-of-prize-tiers-always-increases-if-just-1-canary-prize-is-claimed\">[M-14] Number of prize tiers always increases if just 1 canary prize is claimed</a></li>\n<li><a href=\"#m-15-tiers-can-be-maintained-active-to-give-unfair-advantage-to-user-through-dos\">[M-15] Tiers can be maintained active to give unfair advantage to user through DoS</a></li>\n<li><a href=\"#m-16-the-threshold-check-for-adding-of-new-tiers-is-skipped-when-_nextnumberoftiers-is-at-the-maximum-amount\">[M-16] The threshold check for adding of new tiers is skipped when <code>_nextNumberOfTiers</code> is at the maximum amount</a></li>\n<li><a href=\"#m-17-vaultfactory-allows-deployment-of-vaults-with-non-authentic-twabcontroller-and-prizepool\">[M-17] <code>VaultFactory</code> allows deployment of vaults with non-authentic <code>TwabController</code> and <code>PrizePool</code></a></li>\n<li><a href=\"#m-18-the-exchange-rate-change-in-the-case-of-lossy-strategy-will-cause-the-vault-to-be-under-collateralized-for-generic-erc4626-yield-vaults\">[M-18] The exchange rate change in the case of Lossy Strategy will cause the Vault to be under-collateralized for generic ERC4626 Yield Vaults</a></li>\n<li><a href=\"#m-19-silent-overflow-could-alter-computation-when-calculating-the-vaultportion-in-the-prizepool-contract\">[M-19] Silent overflow could alter computation when calculating the <code>vaultPortion</code> in the <code>PrizePool</code> contract</a></li>\n<li><a href=\"#m-20-improper-handling-of-cases-when-withdrawable-assets--0\">[M-20] Improper handling of cases when withdrawable assets = 0</a></li>\n<li><a href=\"#m-21-vault-contribution-calculations-wrongly-include-the-current-round-when-claiming-prizes\">[M-21] Vault contribution calculations wrongly include the current round when claiming prizes</a></li>\n<li><a href=\"#m-22-loss-of-precision-leads-to-under-collateralized\">[M-22] Loss of precision leads to under-collateralized</a></li>\n<li><a href=\"#m-23-vault-does-not-conform-to-erc4626\">[M-23] Vault does not conform to ERC4626</a></li>\n<li><a href=\"#m-24-claimerclaimprizes-can-be-front-runned-in-order-to-make-losses-for-the-claim-bot\">[M-24] <code>Claimer.claimPrizes</code> can be front-runned in order to make losses for the claim bot</a></li>\n<li><a href=\"#m-25-depositwithpermit-and-mintwithpermit-are-allowed-to-be-called-by-the-permit-creator-only\">[M-25] <code>depositWithPermit</code> and <code>mintWithPermit</code> are allowed to be called by the permit creator only</a></li>\n<li><a href=\"#m-26-transfer-of-vault-tokens-can-cause-accounting-errors-in-other-contracts\">[M-26] Transfer of Vault tokens can cause accounting errors in other contracts</a></li>\n<li><a href=\"#m-27-inconsistent-behavior-for-canary-claims-in-the-claimer\">[M-27] Inconsistent behavior for canary claims in the <code>claimer</code></a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#l-01-vault_mint-forcing-conversion-to-uint96-may-result-in-missing-values\">L-01 <code>vault._mint()</code> forcing conversion to <code>uint96</code> may result in missing values</a></li>\n<li><a href=\"#l-02-targetof-incorrectly-uses-_token---_liquidationpairtokenin\">L-02 <code>targetOf()</code> incorrectly uses <code>_token ! = _liquidationPair.tokenIn()</code></a></li>\n<li><a href=\"#l-03-setliquidationpair-may-not-be-able-to-set-the-old-liquidationpair\">L-03 <code>setLiquidationPair()</code> may not be able to set the old <code>liquidationPair</code></a></li>\n<li><a href=\"#l-04-in-_withdraw-by-calling-_burn-and-then-executing-_yieldvaultwithdraw-it-may-lead-_updateexchangerate-inaccuracy\">L-04 in <code>_withdraw()</code>, by calling <code>_burn()</code> and then executing <code>_yieldVault.withdraw()</code>, it may lead <code>_updateExchangeRate()</code> inaccuracy</a></li>\n<li><a href=\"#l-05-liquidate-is-at-risk-of-a-sandwich-attack\">L-05 <code>liquidate()</code> is at risk of a sandwich attack</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#auditors-disclaimer\">Auditor’s Disclaimer</a></li>\n<li><a href=\"#note-on-gas-estimates\">Note on Gas estimates</a></li>\n<li><a href=\"#tightly-pack-storage-variablesoptimize-the-order-of-variable-declaration-saves-21k-gas\">Tightly pack storage variables/optimize the order of variable declaration (saves 2.1K gas)</a></li>\n<li><a href=\"#expensive-operation-inside-a-for-loop\">Expensive operation inside a for loop</a></li>\n<li><a href=\"#use-calldata-instead-of-memory-for-function-parameters\">Use <code>calldata</code> instead of <code>memory</code> for function parameters</a></li>\n<li><a href=\"#repeatedly-doing-the-same-operation-addition-involving-a-state-variable-should-be-avoided\">Repeatedly doing the same operation (addition) involving a state variable should be avoided</a></li>\n<li><a href=\"#use-the-existing-memory-value-to-do-the-subtraction\">Use the existing memory value to do the subtraction</a></li>\n<li><a href=\"#emitting-storage-values-instead-of-the-memory-one\">Emitting storage values instead of the memory one.</a></li>\n<li><a href=\"#optimizing-the-check-order-for-cost-efficient-function-execution\">Optimizing the check order for cost efficient function execution</a></li>\n<li><a href=\"#dont-cache-a-state-variable-if-its-used-only-once\">Don’t cache a state variable if it’s used only once</a></li>\n<li><a href=\"#do-not-cache-immutable-values\">Do not cache immutable values</a></li>\n<li><a href=\"#conclusion\">Conclusion</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#audit-analysis\">Audit Analysis</a></p>\n<ul>\n<li><a href=\"#introduction\">Introduction</a></li>\n<li><a href=\"#analysis-of-the-codebase\">Analysis of the Codebase</a></li>\n<li><a href=\"#architecture-feedback-centralization--systemic-risks\">Architecture Feedback, Centralization &#x26; Systemic Risks</a></li>\n<li><a href=\"#recommendations\">Recommendations</a></li>\n<li><a href=\"#time-spent\">Time spent</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#mitigation-review\">Mitigation Review</a></p>\n<ul>\n<li><a href=\"#introduction-1\">Introduction</a></li>\n<li><a href=\"#overview-of-changes\">Overview of Changes</a></li>\n<li><a href=\"#mitigation-review-scope\">Mitigation Review Scope</a></li>\n<li><a href=\"#out-of-scope\">Out of Scope</a></li>\n<li><a href=\"#mitigation-review-summary\">Mitigation Review Summary</a></li>\n<li><a href=\"#h-05-mitigation-error-the-sponsorwithpermit-function-allows-anyone-to-provide-a-valid-permit-for-asset\">H-05 Mitigation error: The <code>sponsorWithPermit</code> function allows anyone to provide a valid permit for asset</a></li>\n<li><a href=\"#h-09-not-fully-mitigated-_yieldvaultmaxwithdraw-returning-a-different-value-than-the-expected-real-balance-of-the-caller\">H-09 Not fully mitigated: <code>_yieldVault.maxWithdraw()</code> returning a different value than the expected real balance of the caller</a></li>\n<li><a href=\"#m-02-not-fully-mitigated-a-malicious-user-can-still-gas-grief-a-claimer-by-deliberately-reverting-in-a-hook\">M-02 Not fully mitigated: A malicious user can still gas grief a claimer by deliberately reverting in a hook</a></li>\n<li><a href=\"#m-09-mitigation-error-auctions-run-at-significantly-different-speeds-for-different-prize-tiers\">M-09 Mitigation error: Auctions run at significantly different speeds for different prize tiers</a></li>\n<li><a href=\"#m-16-mitigation-error-number-of-prize-tiers-may-never-scale-due-to-aggressive-new-algorithm\">M-16 Mitigation error: Number of prize tiers may never scale due to aggressive new algorithm.</a></li>\n<li><a href=\"#assessed-type-30\">Assessed type</a></li>\n<li><a href=\"#m-18-not-fully-mitigated-_redeem-method-doesnt-handle-the-case-where-the-withdrawal-from-the-underlying-yield-vault-realises-losses\">M-18 Not fully mitigated: <code>_redeem</code> method doesn’t handle the case where the withdrawal from the underlying yield vault realises losses</a></li>\n<li><a href=\"#m-22-not-fully-mitigated-deposits-could-revert-if-there-is-a-loss-of-precision-of-1-wei-in-the-underlying-yield-vault\">M-22 Not fully mitigated: deposits could revert if there is a loss of precision of 1 wei in the underlying yield vault</a></li>\n<li><a href=\"#claiming-prizes-will-be-bricked-if-prize-periods-are-not-aligned-with-twab-periods\">Claiming prizes will be bricked if prize periods are not aligned with twab periods</a></li>\n<li><a href=\"#vault-will-stop-participating-in-draws-in-the-case-they-deposited-maximum-assets-to-the-underlying-vault\">Vault will stop participating in draws in the case they deposited maximum assets to the underlying vault</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>"
}