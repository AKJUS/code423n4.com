{
  "circa": {
    "title": "Moonwell",
    "sponsor": "Moonwell",
    "slug": "2023-07-moonwell",
    "date": "2023-10-04",
    "findings": "https://github.com/code-423n4/2023-07-moonwell-findings/issues",
    "contest": 267
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit outlined in this document, C4 conducted an analysis of the Moonwell smart contract system written in Solidity. The audit took place between July 24—July 31 2023.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>78 Wardens contributed reports to the Moonwell:</p>\n<ol>\n<li><a href=\"https://code4rena.com/@immeas\">immeas</a></li>\n<li><a href=\"https://code4rena.com/@T1MOH\">T1MOH</a></li>\n<li><a href=\"https://code4rena.com/@kankodu\">kankodu</a></li>\n<li><a href=\"https://code4rena.com/@Udsen\">Udsen</a></li>\n<li><a href=\"https://code4rena.com/@0xWaitress\">0xWaitress</a></li>\n<li><a href=\"https://code4rena.com/@said\">said</a></li>\n<li><a href=\"https://code4rena.com/@ravikiranweb3\">ravikiranweb3</a></li>\n<li><a href=\"https://code4rena.com/@volodya\">volodya</a></li>\n<li><a href=\"https://code4rena.com/@cryptonue\">cryptonue</a></li>\n<li><a href=\"https://code4rena.com/@catellatech\">catellatech</a></li>\n<li><a href=\"https://code4rena.com/@hals\">hals</a></li>\n<li><a href=\"https://code4rena.com/@mert_eren\">mert_eren</a></li>\n<li><a href=\"https://code4rena.com/@nadin\">nadin</a></li>\n<li><a href=\"https://code4rena.com/@kutugu\">kutugu</a></li>\n<li><a href=\"https://code4rena.com/@Nyx\">Nyx</a></li>\n<li><a href=\"https://code4rena.com/@berlin-101\">berlin-101</a></li>\n<li><a href=\"https://code4rena.com/@Sathish9098\">Sathish9098</a></li>\n<li><a href=\"https://code4rena.com/@Aymen0909\">Aymen0909</a></li>\n<li><a href=\"https://code4rena.com/@kodyvim\">kodyvim</a></li>\n<li><a href=\"https://code4rena.com/@ast3ros\">ast3ros</a></li>\n<li><a href=\"https://code4rena.com/@jaraxxus\">jaraxxus</a></li>\n<li><a href=\"https://code4rena.com/@sces60107\">sces60107</a></li>\n<li><a href=\"https://code4rena.com/@markus_ether\">markus_ether</a></li>\n<li><a href=\"https://code4rena.com/@0xComfyCat\">0xComfyCat</a></li>\n<li><a href=\"https://code4rena.com/@ABAIKUNANBAEV\">ABAIKUNANBAEV</a></li>\n<li><a href=\"https://code4rena.com/@0xkazim\">0xkazim</a></li>\n<li><a href=\"https://code4rena.com/@Jigsaw\">Jigsaw</a></li>\n<li><a href=\"https://code4rena.com/@Vagner\">Vagner</a></li>\n<li><a href=\"https://code4rena.com/@bin2chen\">bin2chen</a></li>\n<li><a href=\"https://code4rena.com/@MohammedRizwan\">MohammedRizwan</a></li>\n<li><a href=\"https://code4rena.com/@niki\">niki</a></li>\n<li><a href=\"https://code4rena.com/@Kaysoft\">Kaysoft</a></li>\n<li><a href=\"https://code4rena.com/@solsaver\">solsaver</a></li>\n<li><a href=\"https://code4rena.com/@BRONZEDISC\">BRONZEDISC</a></li>\n<li><a href=\"https://code4rena.com/@Auditwolf\">Auditwolf</a></li>\n<li><a href=\"https://code4rena.com/@Hama\">Hama</a></li>\n<li><a href=\"https://code4rena.com/@okolicodes\">okolicodes</a></li>\n<li><a href=\"https://code4rena.com/@R-Nemes\">R-Nemes</a></li>\n<li><a href=\"https://code4rena.com/@dacian\">dacian</a></li>\n<li><a href=\"https://code4rena.com/@Tendency\">Tendency</a></li>\n<li><a href=\"https://code4rena.com/@0x70C9\">0x70C9</a></li>\n<li>RED-LOTUS-REACH (<a href=\"https://code4rena.com/@BlockChomper\">BlockChomper</a>, <a href=\"https://code4rena.com/@DedOhWale\">DedOhWale</a>, <a href=\"https://code4rena.com/@SaharDevep\">SaharDevep</a>, <a href=\"https://code4rena.com/@reentrant\">reentrant</a>, and <a href=\"https://code4rena.com/@escrow\">escrow</a>)</li>\n<li><a href=\"https://code4rena.com/@0xSmartContract\">0xSmartContract</a></li>\n<li><a href=\"https://code4rena.com/@K42\">K42</a></li>\n<li><a href=\"https://code4rena.com/@0xAnah\">0xAnah</a></li>\n<li><a href=\"https://code4rena.com/@ChrisTina\">ChrisTina</a></li>\n<li><a href=\"https://code4rena.com/@JP_Courses\">JP_Courses</a></li>\n<li><a href=\"https://code4rena.com/@josephdara\">josephdara</a></li>\n<li><a href=\"https://code4rena.com/@twcctop\">twcctop</a></li>\n<li>LosPollosHermanos (<a href=\"https://code4rena.com/@jc1\">jc1</a> and <a href=\"https://code4rena.com/@scaraven\">scaraven</a>)</li>\n<li><a href=\"https://code4rena.com/@Arz\">Arz</a></li>\n<li><a href=\"https://code4rena.com/@Jorgect\">Jorgect</a></li>\n<li><a href=\"https://code4rena.com/@33audits\">33audits</a></li>\n<li><a href=\"https://code4rena.com/@cats\">cats</a></li>\n<li><a href=\"https://code4rena.com/@Rolezn\">Rolezn</a></li>\n<li><a href=\"https://code4rena.com/@Stormreckson\">Stormreckson</a></li>\n<li><a href=\"https://code4rena.com/@fatherOfBlocks\">fatherOfBlocks</a></li>\n<li><a href=\"https://code4rena.com/@souilos\">souilos</a></li>\n<li><a href=\"https://code4rena.com/@0xl51\">0xl51</a></li>\n<li><a href=\"https://code4rena.com/@Topmark\">Topmark</a></li>\n<li><a href=\"https://code4rena.com/@naman1778\">naman1778</a></li>\n<li><a href=\"https://code4rena.com/@wahedtalash77\">wahedtalash77</a></li>\n<li><a href=\"https://code4rena.com/@jamshed\">jamshed</a></li>\n<li><a href=\"https://code4rena.com/@petrichor\">petrichor</a></li>\n<li><a href=\"https://code4rena.com/@0xackermann\">0xackermann</a></li>\n<li><a href=\"https://code4rena.com/@0xArcturus\">0xArcturus</a></li>\n<li><a href=\"https://code4rena.com/@lanrebayode77\">lanrebayode77</a></li>\n<li><a href=\"https://code4rena.com/@2997ms\">2997ms</a></li>\n<li><a href=\"https://code4rena.com/@John_Femi\">John_Femi</a></li>\n<li><a href=\"https://code4rena.com/@banpaleo5\">banpaleo5</a></li>\n<li><a href=\"https://code4rena.com/@albertwh1te\">albertwh1te</a></li>\n<li><a href=\"https://code4rena.com/@codetilda\">codetilda</a></li>\n<li><a href=\"https://code4rena.com/@eeshenggoh\">eeshenggoh</a></li>\n</ol>\n<p>This audit was judged by <a href=\"https://twitter.com/alcueca\">alcueca</a>.</p>\n<p>Final report assembled by PaperParachute.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 17 unique vulnerabilities. Of these vulnerabilities, 0 received a risk rating in the category of HIGH severity and 17 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 56 reports detailing issues with a risk rating of LOW severity or non-critical.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2023-07-moonwell\">C4 Moonwell repository</a>, and is composed of 15 smart contracts written in the Solidity programming language and includes 3,569 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities based on three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>For more information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>, specifically our section on <a href=\"https://docs.code4rena.com/awarding/judging-criteria/severity-categorization\">Severity Categorization</a>.</p>\n<h1 id=\"medium-risk-findings-17\" style=\"position:relative;\"><a href=\"#medium-risk-findings-17\" aria-label=\"medium risk findings 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (17)</h1>\n<h2 id=\"m-01-borrowers-can-avoid-liquidations-if-erc777-token-is-configured-as-an-emissiontoken-\" style=\"position:relative;\"><a href=\"#m-01-borrowers-can-avoid-liquidations-if-erc777-token-is-configured-as-an-emissiontoken-\" aria-label=\"m 01 borrowers can avoid liquidations if erc777 token is configured as an emissiontoken  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/343\">[M-01] Borrowers can avoid liquidations, if ERC777 token is configured as an <code>emissionToken</code> </a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/343\">Udsen</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MErc20.sol#L139-L142\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MErc20.sol#L139-L142</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MToken.sol#L1002\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MToken.sol#L1002</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MultiRewardDistributor/MultiRewardDistributor.sol#L1235-L1239\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MultiRewardDistributor/MultiRewardDistributor.sol#L1235-L1239</a></p>\n<p>If a borrower is <code>undercollateralized</code> then he can be liquidated by a liquidator by calling the <code>MErc20.liquidateBorrow</code> function. <code>liquidateBorrow</code> function calls the <code>MToken.liquidateBorrowFresh</code> in its execution process. Inside the <code>liquidateBorrowFresh</code> function the <code>MToken.repayBorrowFresh</code> is called which verifies whether repayment of borrowed amount is allowed by calling the <code>Comptroller.repayBorrowAllowed</code> function. The <code>repayBorrowAllowed</code> function updates the <code>borrower eligible rewards</code> by calling the <code>MultiRewardDistributor.updateMarketBorrowIndexAndDisburseBorrowerRewards</code>.</p>\n<p>The <code>MultiRewardDistributor.updateMarketBorrowIndexAndDisburseBorrowerRewards</code> function calls the <code>disburseBorrowerRewardsInternal</code> to ditribute the multi rewards to the <code>borrower</code>.\nThe <code>disburseBorrowerRewardsInternal</code> calls the <code>sendReward</code> function if the <code>_sendTokens</code> flag is set to <code>true</code>.</p>\n<p><code>sendReward</code> function is called for each <code>emissionConfig.config.emissionToken</code> token of the <code>MarketEmissionConfig[]</code> array of the given <code>_mToken</code> market.</p>\n<p><code>sendReward</code> function transafers the rewards to the <code>borrower</code> using the <code>safeTransfer</code> function as shown below:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">        token.safeTransfer(_user, _amount);</span></span></code></pre>\n<p>Problem here is that <code>emissionToken</code> can be <code>ERC777</code> token (which is backward compatible with ERC20) thus allowing a <code>malicious borrower</code> (the <code>recipient contract</code> of rewards in this case) to implement <code>tokensReceived</code> hook in its contract and revert the transaction inside the hook. This will revert the entire <code>liquidation</code> transaction. Hence the <code>undercollateralized borrower</code> can avoid the liquidation thus putting both depositors and protocol in danger.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">liquidateBorrow</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">repayAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MTokenInterface</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mTokenCollateral</span><span class=\"mtk1\">) </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">err</span><span class=\"mtk1\">,) = </span><span class=\"mtk11\">liquidateBorrowInternal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">, </span><span class=\"mtk12\">repayAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">mTokenCollateral</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">err</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MErc20.sol#L139-L142\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MErc20.sol#L139-L142</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">repayBorrowError</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">actualRepayAmount</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">repayBorrowFresh</span><span class=\"mtk1\">(</span><span class=\"mtk12\">liquidator</span><span class=\"mtk1\">, </span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">, </span><span class=\"mtk12\">repayAmount</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MToken.sol#L1002\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MToken.sol#L1002</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">currentTokenHoldings</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Ensure we use SafeERC20 to revert even if the reward token isn&#39;t ERC20 compliant</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MultiRewardDistributor/MultiRewardDistributor.sol#L1235-L1239\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MultiRewardDistributor/MultiRewardDistributor.sol#L1235-L1239</a></p>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VSCode</p>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Hence it is recommended to disallow any ERC777 tokens being configured as <code>emissionToken</code> in any <code>MToken</code> market and only allow ERC20 tokens as <code>emissionTokens</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/343#issuecomment-1663473308\">sorrynotsorry (Lookout) commented</a>:</strong></p>\n<blockquote>\n<p>This logic is a bit off as the malicious user will not be having the ERC777 MToken rewards anyway, so the value extracted from this scenario doesn’t match. </p>\n<blockquote>\n<p>Only allow ERC20 tokens as emissionTokens</p>\n</blockquote>\n<p>Above mitigation recommendation is also matching the start of the submission. Erc777’s are Erc20 tokens as well.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/343#issuecomment-1679011711\">alcueca (Judge) decreased severity to Medium and commented</a>:</strong>\nThe finding shows that rewards are distributed as part of a liquidation.</p>\n<p>If an ERC777 token is set as an emissionsToken, which has transfer hooks, a malicious borrower can revert on receiving rewards, and avoid liquidation. Avoiding liquidation in certain situations accrues bad debt for the protocol, or can be compounded with other vulnerabilities. This would be a valid Medium.</p>\n<p>@ElliotFriedman, do you have in your documentation anything mentioning that ERC777 tokens should not be used as emission tokens?</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/343#issuecomment-1679335514\">ElliotFriedman (Moonwell) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>This is a valid finding.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-missing-check-for-the-maxmin-price-in-the-chainlinkoraclesol-contract\" style=\"position:relative;\"><a href=\"#m-02-missing-check-for-the-maxmin-price-in-the-chainlinkoraclesol-contract\" aria-label=\"m 02 missing check for the maxmin price in the chainlinkoraclesol contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/340\">[M-02] Missing check for the max/min price in the <code>chainlinkOracle.sol</code> contract</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/340\">0xkazim</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/335\">BRONZEDISC</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/282\">markus_ether</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/195\">Auditwolf</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/189\">Hama</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/183\">okolicodes</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/168\">R-Nemes</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/130\">kodyvim</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/91\">nadin</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/57\">MohammedRizwan</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/48\">dacian</a>, and <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/16\">niki</a></em></p>\n<p>The <code>chainlinkOracle.sol</code> contract specially the <code>getChainlinkPrice</code> function using the aggregator v2 and v3 to get/call the <code>latestRoundData</code>. the function should check for the min and max amount return to prevent some case happen, something like this:</p>\n<p><a href=\"https://solodit.xyz/issues/missing-checks-for-chainlink-oracle-spearbit-connext-pdf\">https://solodit.xyz/issues/missing-checks-for-chainlink-oracle-spearbit-connext-pdf</a> </p>\n<p><a href=\"https://solodit.xyz/issues/m-16-chainlinkadapteroracle-will-return-the-wrong-price-for-asset-if-underlying-aggregator-hits-minanswer-sherlock-blueberry-blueberry-git\">https://solodit.xyz/issues/m-16-chainlinkadapteroracle-will-return-the-wrong-price-for-asset-if-underlying-aggregator-hits-minanswer-sherlock-blueberry-blueberry-git</a></p>\n<p>If a case like LUNA happens then the oracle will return the minimum price and not the crashed price.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The function <code>getChainlinkPrice</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"soliditiy\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function getChainlinkPrice(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        AggregatorV3Interface feed</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) internal view returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        (, int256 answer, , uint256 updatedAt, ) = AggregatorV3Interface(feed)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            .latestRoundData();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(answer &gt; 0, &quot;Chainlink price cannot be lower than 0&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(updatedAt != 0, &quot;Round is in incompleted state&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Chainlink USD-denominated feeds store answers at 8 decimals</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 decimalDelta = uint256(18).sub(feed.decimals());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Ensure that we don&#39;t multiply the result by 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (decimalDelta &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            return uint256(answer).mul(10 ** decimalDelta);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            return uint256(answer);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>The function did not check for the min and max price.</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Some check like this can be added to avoid returning of the min price or the max price in case of the price crashes.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">answer</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_maxPrice</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Upper price bound breached&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">answer</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">_minPrice</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Lower price bound breached&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/340#issuecomment-1660090896\">sorrynotsorry (Lookout) commented</a>:</strong></p>\n<blockquote>\n<p>The implementation does not set a min/max value by design. Also Chainlink does not return min/max price as per the AggregatorV3 docs <a href=\"https://docs.chain.link/data-feeds/api-reference#latestrounddata\">HERE</a>  contrary to the reported below;</p>\n</blockquote>\n<blockquote>\n<p>ChainlinkAggregators have minPrice and maxPrice circuit breakers built into them.</p>\n</blockquote>\n<blockquote>\n<p>Further proof required as per the context.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/340#issuecomment-1676380695\">alcueca (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden is actually right. <a href=\"https://docs.chain.link/data-feeds#check-the-latest-answer-against-reasonable-limits\">It is a bit difficult to find</a>, but the <code>minAnswer</code> and <code>maxAnswer</code> can be retrieved from the Chainlink Aggregator, one step through the proxy. A circuit breaker should be implemented on the Moonwell oracle so that when the price edges close to <code>minAnswer</code> or <code>maxAnswer</code> it starts reverting, to avoid consuming stale prices when Chainlink freezes.</p>\n</blockquote>\n<p> <strong><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/340\">ElliotFriedman (Moonwell) acknowledged</a></strong></p>\n<hr>\n<h2 id=\"m-03-excuteproposal-can-fail-due-to-wormhole-guardian-change\" style=\"position:relative;\"><a href=\"#m-03-excuteproposal-can-fail-due-to-wormhole-guardian-change\" aria-label=\"m 03 excuteproposal can fail due to wormhole guardian change permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/325\">[M-03] <code>excuteProposal</code> can fail due to Wormhole guardian change</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/325\">immeas</a></em></p>\n<p>Wormhole governance can change signing guardian sets. If this happens between a proposal is queued and a proposal is executed. The second verification in <code>_executeProposal</code> will fail as the guardian set has changed between queuing and executing.</p>\n<p>This would cause a proposal to fail to execute after the <code>proposalDelay</code> has passed. Causing a lengthy re-sending of the message from <code>Timelock</code> on source chain, then <code>proposalDelay</code> again.</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>To execute a proposal on <code>TemporalGovernor</code> it first needs to be queued. When queued it is checked that the message is valid against the Wormhole bridge contract:</p>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L295-L306\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L295-L306</a></p>\n<details>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">Governance</span><span class=\"mtk1\">/</span><span class=\"mtk12\">TemporalGovernor</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">295</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_queueProposal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">VAA</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">296</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">/// Checks</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">297</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">298</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// This call accepts single VAAs and headless VAAs</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">299</span><span class=\"mtk1\">:        (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">300</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">IWormhole</span><span class=\"mtk1\">.</span><span class=\"mtk12\">VM</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">301</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">valid</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">302</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">reason</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">303</span><span class=\"mtk1\">:        ) = </span><span class=\"mtk12\">wormholeBridge</span><span class=\"mtk1\">.</span><span class=\"mtk11\">parseAndVerifyVM</span><span class=\"mtk1\">(</span><span class=\"mtk12\">VAA</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">304</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">305</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// Ensure VAA parsing verification succeeded.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">306</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">valid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">reason</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>After some more checks are done the message is <a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L338-L339\">queued by its wormhole hash</a>.</p>\n<p>Then, after <code>proposalDelay</code>, anyone can call <code>executeProposal</code>.</p>\n<p>Before the proposal is executed though, a second check against the Wormhole bridge contract is done:</p>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L344-L350\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L344-L350</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">Governance</span><span class=\"mtk1\">/</span><span class=\"mtk12\">TemporalGovernor</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">344</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_executeProposal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">VAA</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">overrideDelay</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">345</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// This call accepts single VAAs and headless VAAs</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">346</span><span class=\"mtk1\">:        (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">347</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">IWormhole</span><span class=\"mtk1\">.</span><span class=\"mtk12\">VM</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">348</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">valid</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">349</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">reason</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">350</span><span class=\"mtk1\">:        ) = </span><span class=\"mtk12\">wormholeBridge</span><span class=\"mtk1\">.</span><span class=\"mtk11\">parseAndVerifyVM</span><span class=\"mtk1\">(</span><span class=\"mtk12\">VAA</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>The issue is that the second time the verification might fail.</p>\n<p>During the wormhole contract check for validity there is a check that the correct guardian set has signed the message:</p>\n<p><a href=\"https://github.com/wormhole-foundation/wormhole/blob/f11299b888892d5b4abaa624737d0e5117d1bbb2/ethereum/contracts/Messages.sol#L79-L82\">https://github.com/wormhole-foundation/wormhole/blob/f11299b888892d5b4abaa624737d0e5117d1bbb2/ethereum/contracts/Messages.sol#L79-L82</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">79</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">/// @dev Checks if VM guardian set index matches the current index (unless the current set is expired).</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">80</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk12\">guardianSetIndex</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">getCurrentGuardianSetIndex</span><span class=\"mtk1\">() &amp;&amp; </span><span class=\"mtk12\">guardianSet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">expirationTime</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">81</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;guardian set has expired&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">82</span><span class=\"mtk1\">:        }</span></span></span></code></pre>\n<p>But(!), Wormhole governance can change the signers:</p>\n<p><a href=\"https://github.com/wormhole-foundation/wormhole/blob/f11299b888892d5b4abaa624737d0e5117d1bbb2/ethereum/contracts/Governance.sol#L76-L112\">https://github.com/wormhole-foundation/wormhole/blob/f11299b888892d5b4abaa624737d0e5117d1bbb2/ethereum/contracts/Governance.sol#L76-L112</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk7\">76</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> 77:     * </span><span class=\"mtk4\">@dev</span><span class=\"mtk3\"> Deploys a new `guardianSet` via Governance VAA/VM</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> 78:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk7\">79</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">submitNewGuardianSet</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_vm</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// ... parsing and verification</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">104</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// Trigger a time-based expiry of current guardianSet</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">105</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">expireGuardianSet</span><span class=\"mtk1\">(</span><span class=\"mtk11\">getCurrentGuardianSetIndex</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">106</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">107</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// Add the new guardianSet to guardianSets</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">108</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">storeGuardianSet</span><span class=\"mtk1\">(</span><span class=\"mtk12\">upgrade</span><span class=\"mtk1\">.</span><span class=\"mtk12\">newGuardianSet</span><span class=\"mtk1\">, </span><span class=\"mtk12\">upgrade</span><span class=\"mtk1\">.</span><span class=\"mtk12\">newGuardianSetIndex</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">109</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">110</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// Makes the new guardianSet effective</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">111</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">updateGuardianSetIndex</span><span class=\"mtk1\">(</span><span class=\"mtk12\">upgrade</span><span class=\"mtk1\">.</span><span class=\"mtk12\">newGuardianSetIndex</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">112</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n</details>\n<p><br>Were this to happen between <code>queueProposal</code> and <code>executeProposal</code> the proposal would fail to execute.</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider only check the <code>VAA</code>s validity against Wormhole in <code>_executeProposal</code> when it is fasttracked (<code>overrideDelay==true</code>).</p>\n<p>However then anyone can just just take the hash from the proposal <code>VAA</code> and submit whatever commands. One idea to prevent this is to instead of storing the <code>VAA</code> <code>vm.hash</code>, use the hash of the complete <code>VAA</code> as key in <code>queuedTransactions</code>. Thus, the content cannot be altered.</p>\n<p>Or, the whole <code>VAA</code> can be stored alongside the timestamp and the <code>executeProposal</code> call can be made with just the hash.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/325#issuecomment-1664719948\">ElliotFriedman (Moonwell) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Good finding and this is expected behavior as wormhole guardians may change if signers are ever compromised.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-04-malicious-emissiontoken-could-poison-rewards-for-a-market\" style=\"position:relative;\"><a href=\"#m-04-malicious-emissiontoken-could-poison-rewards-for-a-market\" aria-label=\"m 04 malicious emissiontoken could poison rewards for a market permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/320\">[M-04] Malicious <code>emissionToken</code> could poison rewards for a market</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/320\">immeas</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/138\">mert_eren</a></em></p>\n<p>When distributing rewards for a market, each <code>emissionConfig</code> is looped over and sent rewards for. <code>disburseBorrowerRewardsInternal</code> as an example, the same holds true for <code>disburseSupplierRewardsInternal</code>:</p>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MultiRewardDistributor/MultiRewardDistributor.sol#L1147-L1247\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MultiRewardDistributor/MultiRewardDistributor.sol#L1147-L1247</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">MultiRewardDistributor</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MultiRewardDistributor</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1147</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">disburseBorrowerRewardsInternal</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">1148:        </span><span class=\"mtk10\">MToken</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_mToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">1149:        </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_borrower</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">1150:        </span><span class=\"mtk10\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_sendTokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1151</span><span class=\"mtk1\">:    ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1152</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">MarketEmissionConfig</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">configs</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">marketConfigs</span><span class=\"mtk1\">[</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1153</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_mToken</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1154</span><span class=\"mtk1\">:        ];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             </span><span class=\"mtk3\">// ... mToken balance and borrow index</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1162</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// Iterate over all market configs and update their indexes + timestamps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1163</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">index</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">index</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">configs</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">index</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1164</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">MarketEmissionConfig</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">emissionConfig</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">configs</span><span class=\"mtk1\">[</span><span class=\"mtk12\">index</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 </span><span class=\"mtk3\">// ... index updates</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1192</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_sendTokens</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1193</span><span class=\"mtk1\">:                </span><span class=\"mtk3\">// Emit rewards for this token/pair</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1194</span><span class=\"mtk1\">:                </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pendingRewards</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">sendReward</span><span class=\"mtk1\">( </span><span class=\"mtk3\">// &lt;-- will trigger transfer on `emissionToken`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1195</span><span class=\"mtk1\">:                    </span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_borrower</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1196</span><span class=\"mtk1\">:                    </span><span class=\"mtk12\">emissionConfig</span><span class=\"mtk1\">.</span><span class=\"mtk12\">borrowerRewardsAccrued</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_borrower</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1197</span><span class=\"mtk1\">:                    </span><span class=\"mtk12\">emissionConfig</span><span class=\"mtk1\">.</span><span class=\"mtk12\">config</span><span class=\"mtk1\">.</span><span class=\"mtk12\">emissionToken</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1198</span><span class=\"mtk1\">:                );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1199</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1200</span><span class=\"mtk1\">:                </span><span class=\"mtk12\">emissionConfig</span><span class=\"mtk1\">.</span><span class=\"mtk12\">borrowerRewardsAccrued</span><span class=\"mtk1\">[</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1201</span><span class=\"mtk1\">:                    </span><span class=\"mtk12\">_borrower</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1202</span><span class=\"mtk1\">:                ] = </span><span class=\"mtk12\">pendingRewards</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1203</span><span class=\"mtk1\">:            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1204</span><span class=\"mtk1\">:        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1205</span><span class=\"mtk1\">:    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1214</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">sendReward</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">1215:        </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_user</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">1216:        </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">1217:        </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_rewardToken</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1218</span><span class=\"mtk1\">:    ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             </span><span class=\"mtk3\">// ... short circuits breakers</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1232</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentTokenHoldings</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1233</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1234</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// Only transfer out if we have enough of a balance to cover it (otherwise just accrue without sending)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1235</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">currentTokenHoldings</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1236</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">// Ensure we use SafeERC20 to revert even if the reward token isn&#39;t ERC20 compliant</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1237</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// &lt;-- if this reverts all emissions fail</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1238</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1239</span><span class=\"mtk1\">:        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 </span><span class=\"mtk3\">// .. default return _amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1245</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1246</span><span class=\"mtk1\">:        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1247</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<p>If one transfer reverts the whole transaction fails and no rewards will be paid out for this user. Hence if there is a malicious token that would revert on transfer it would cause no rewards to paid out. As long as there is some rewards accrued for the malicious <code>emissionConfig</code>.\nThe users with already unclaimed rewards for this <code>emissionConfig</code> would have their rewards permanently locked.</p>\n<p>The <code>admin</code> (<code>TemporalGovernor</code>) of <code>MultiRewardsDistributor</code> could update the reward speed for the token to <code>0</code> but that would just prevent further damage from being done.</p>\n<p>Upgradeable tokens aren’t unusual and hence the token might seem harmless to begin with but be upgraded to a malicious implementation that reverts on transfer.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Test in <code>MultiRewardDistributor.t.sol</code>, <code>MultiRewardSupplySideDistributorUnitTest</code>, most of the test is copied from <code>testSupplierHappyPath</code> with the addition of <code>MaliciousToken</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MaliciousToken</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">revert</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;No transfer for you&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testAddMaliciousEmissionToken</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">startTime</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1678340000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">startTime</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">MultiRewardDistributor</span><span class=\"mtk1\"> </span><span class=\"mtk12\">distributor</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">createDistributorWithRoundValuesAndConfig</span><span class=\"mtk1\">(</span><span class=\"mtk7\">2e18</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0.5e18</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0.5e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// malicious token added</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">MaliciousToken</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">MaliciousToken</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">distributor</span><span class=\"mtk1\">.</span><span class=\"mtk11\">_addEmissionConfig</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">mToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">365</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">comptroller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">_setRewardDistributor</span><span class=\"mtk1\">(</span><span class=\"mtk12\">distributor</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emissionToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">allocateTo</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">distributor</span><span class=\"mtk1\">), </span><span class=\"mtk7\">10000e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">mToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk7\">2e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk11\">MTokenInterface</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mToken</span><span class=\"mtk1\">).</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">(), </span><span class=\"mtk7\">2e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Wait 12345 seconds after depositing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">12345</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// claim fails as the malicious token reverts on transfer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;No transfer for you&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">comptroller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">claimReward</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// no rewards handed out</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">emissionToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider adding a way for <code>admin</code> to remove an <code>emissionConfig</code>.</p>\n<p>Alternatively, the reward transfer could be wrapped in a <code>try</code>/<code>catch</code> and returning <code>_amount</code> in <code>catch</code>. Be mindful to only allow a certain amount of gas to the transfer then as otherwise the same attack works with consuming all gas available.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/320#issuecomment-1664718290\">ElliotFriedman (Moonwell) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>Emission creator (comptroller admin) and emission owners are trusted, it is assumed they will not add any poison reward tokens.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/320#issuecomment-1676115974\">alcueca (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>@ElliotFriedman, I’m not sure yet if anyone else has reported this, but the emissions token doesn’t need to be even suspicious. USDC and USDT can blacklist users. If you use those tokens as emissions and <strong>any</strong> of your rewards holders get blacklisted, this issue will get triggered.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/320#issuecomment-1676115974\">lyoungblood (Warden) commented</a>:</strong></p>\n<blockquote>\n<p>Since tokens (EmissionConfig) cannot be added except by admin (the DAO), I still dispute the validity of the finding, or at least the severity. We have to be reasonable in our assumptions and the assumption that the admin will add a malicious/censorable token can’t really be a precursor to a valid finding. The admin can directly remove funds from the contract with removeReserves, but we wouldn’t consider a finding like that valid.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/320#issuecomment-1676115974\">alcueca (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>@lyoungblood, USDC and USDT are both censorable, and it sounds pretty reasonable that would be used as emission tokens.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-05-only-guardian-can-change-guardian\" style=\"position:relative;\"><a href=\"#m-05-only-guardian-can-change-guardian\" aria-label=\"m 05 only guardian can change guardian permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/315\">[M-05] Only <code>guardian</code> can change <code>guardian</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/315\">immeas</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L27\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L27</a> </p>\n<p><a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/access/Ownable.sol#L81-L86\">https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/access/Ownable.sol#L81-L86</a></p>\n<p><code>guardian</code> is mentioned as an area of concern in the <a href=\"https://github.com/code-423n4/2023-07-moonwell#overview\">docs</a>:</p>\n<blockquote>\n<p>Specific areas of concern include:</p>\n<ul>\n<li>TemporalGovernor which is the cross chain governance contract. Specific areas of concern include delays, <strong>the pause guardian</strong>, …</li>\n</ul>\n</blockquote>\n<p><code>guardian</code> is a roll that has the ability to pause and unpause <code>TemporalGovernor</code>. In code, it uses the <code>owner</code> from OpenZeppelin <code>Ownable</code> as <code>guardian</code>. The issue is that <a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/access/Ownable.sol#L81-L86\"><code>Ownable::transferOwnership</code></a> is not overridden. Only <code>guardian</code> (<code>owner</code>) can transfer the role.</p>\n<p>This can be a conflict of interest if there is a falling out between governance and the guardian. If the <code>guardian</code> doesn’t want to abstain, governance only option would be to call <a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L205-L221\"><code>revokeGuardian</code></a> which sets <code>owner</code> to <code>address(0)</code>. This permanently removes the ability to pause the contract which can be undesirable.</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Simple test in  <code>TemporalGovernorExec.t.sol</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testGovernanceCannotTransferGuardian</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">targets</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">address</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">targets</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">governor</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">values</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payloads</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">bytes</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">payloads</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSelector</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Ownable</span><span class=\"mtk1\">.</span><span class=\"mtk12\">transferOwnership</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">,</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newAdmin</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payload</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">governor</span><span class=\"mtk1\">), </span><span class=\"mtk12\">targets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">values</span><span class=\"mtk1\">, </span><span class=\"mtk12\">payloads</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">mockCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setStorage</span><span class=\"mtk1\">(</span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk12\">trustedChainid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">governor</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addressToBytes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">admin</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;reeeeeee&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">payload</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">governor</span><span class=\"mtk1\">.</span><span class=\"mtk11\">queueProposal</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">proposalDelay</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// governance cannot transfer guardian</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSignature</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Error(string)&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Ownable: caller is not the owner&quot;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">governor</span><span class=\"mtk1\">.</span><span class=\"mtk11\">executeProposal</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider overriding <code>transferOwnership</code> and either limit it to only governance (<code>msg.sender == address(this)</code>) or both <code>guardian</code> and governance.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/315#issuecomment-1664715890\">ElliotFriedman (Moonwell) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>This is an interesting finding. Only <code>guardian</code> can change <code>guardian</code>, however, <code>guardian</code> can only pause once and is limited in abilities to being able to fast track execution, and unpause. After a single malicious pause, the <code>guardian</code> would no longer be able to pause, and 30 days later, governance would reopen.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-06-temporalgovernor-can-be-bricked-by-guardian\" style=\"position:relative;\"><a href=\"#m-06-temporalgovernor-can-be-bricked-by-guardian\" aria-label=\"m 06 temporalgovernor can be bricked by guardian permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/314\">[M-06] <code>TemporalGovernor</code> can be bricked by <code>guardian</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/314\">immeas</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/232\">markus_ether</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/383\">0xkazim</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/240\">kutugu</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/99\">T1MOH</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/33\">bin2chen</a>, berlin-101 (<a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/26\">1</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/25\">2</a>), and <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/47\">ABAIKUNANBAEV</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L27\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L27</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L188-L198\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L188-L198</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L256\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L256</a></p>\n<p>When a <code>guardian</code> pauses <code>TemporalGovernor</code> they <a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L283\">lose the ability to pause again</a>. This can then be reinstated by governance using <a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L188-L198\"><code>grantGuardiansPause</code></a>.</p>\n<p>However <code>grantGuardiansPause</code> can be called when the contract is still paused. This would break the assertions in <a href=\"(https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L256)\"><code>permissionlessUnpause</code></a> and <a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L289\"><code>togglePause</code></a>: <code>assert(!guardianPauseAllowed)</code>.</p>\n<p>Also, <code>TemporalGovernor</code> <a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L27\">inherits from OpenZeppelin <code>Ownable</code></a>. There the <code>owner</code> has the ability to <a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/access/Ownable.sol#L73-L75\"><code>renounceOwnership</code></a>.</p>\n<p>This could cause <code>TemporalGovernor</code> to end up in a bad state, since <a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L205-L221\"><code>revokeGuardian</code></a> call that has special logic for revoking the guardian.</p>\n<p>There is the ability to combine these two issues to brick the contract:</p>\n<ol>\n<li><code>guardian</code> pauses the contract.</li>\n<li>governance sends an instruction for <code>grantGuardiansPause</code> which the <code>guardian</code> executes (while still paused). This step disables both <code>permissionlessUnpause</code> and <code>togglePause</code>. Though the contract is still rescuable through <code>revokeGuardian</code>.</li>\n<li><code>guardian</code> calls <code>renounceOwnership</code> from <code>Ownable</code>. Which disables any possibility to execute commands on <code>TemporalGovernor</code>. Hence no more ability to call <code>revokeGuardian</code>.</li>\n</ol>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>The contract is bricked. Since <code>permissionlessUnpause</code> can’t be called due to the <code>assert(!guardianPauseAllowed)</code>. No cross chain calls an be processed because <code>executeProposal</code> is <code>whenNotPaused</code> and there is no <code>guardian</code> to execute <code>fastTrackProposalExecution</code>. Thus the <code>TemporalGovernor</code> will be stuck in paused state.</p>\n<p>It is also possible for the <code>guardian</code> to hold the contract hostage before step 3 (<code>renounceOwnership</code>) as they are the only ones who can execute calls on it (through <code>fastTrackProposalExecution</code>).</p>\n<p>This is scenario relies on governance sending a cross chain <code>grantGuardiansPause</code> while the contract is still paused and a malicious <code>guardian</code> which together are unlikely. Though the <a href=\"https://github.com/code-423n4/2023-07-moonwell#overview\">docs</a> mention this as a concern:</p>\n<blockquote>\n<p>Specific areas of concern include:\n…</p>\n<ul>\n<li>TemporalGovernor which is the cross chain governance contract. Specific areas of concern include delays, the pause guardian, and putting the contract into a state where it cannot be updated.</li>\n</ul>\n</blockquote>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Test in <code>TemporalGovernorExec.t.sol</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testBrickTemporalGovernor</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// 1. guardian pauses contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">governor</span><span class=\"mtk1\">.</span><span class=\"mtk11\">togglePause</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertTrue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">governor</span><span class=\"mtk1\">.</span><span class=\"mtk11\">paused</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertFalse</span><span class=\"mtk1\">(</span><span class=\"mtk12\">governor</span><span class=\"mtk1\">.</span><span class=\"mtk11\">guardianPauseAllowed</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// 2. grantGuardianPause is called</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">targets</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">address</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">targets</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">governor</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">values</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payloads</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">bytes</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">payloads</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSelector</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TemporalGovernor</span><span class=\"mtk1\">.</span><span class=\"mtk12\">grantGuardiansPause</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payload</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">governor</span><span class=\"mtk1\">), </span><span class=\"mtk12\">targets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">values</span><span class=\"mtk1\">, </span><span class=\"mtk12\">payloads</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">mockCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setStorage</span><span class=\"mtk1\">(</span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk12\">trustedChainid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">governor</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addressToBytes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">admin</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;reeeeeee&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">payload</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">governor</span><span class=\"mtk1\">.</span><span class=\"mtk11\">fastTrackProposalExecution</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertTrue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">governor</span><span class=\"mtk1\">.</span><span class=\"mtk11\">guardianPauseAllowed</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// 3. guardian revokesOwnership</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">governor</span><span class=\"mtk1\">.</span><span class=\"mtk11\">renounceOwnership</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// TemporalGovernor is bricked</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// contract is paused so no proposals can be sent</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Pausable: paused&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">governor</span><span class=\"mtk1\">.</span><span class=\"mtk11\">executeProposal</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// guardian renounced so no fast track execution or togglePause</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">),</span><span class=\"mtk12\">governor</span><span class=\"mtk1\">.</span><span class=\"mtk11\">owner</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// permissionlessUnpause impossible because of assert</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">permissionlessUnpauseTime</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">governor</span><span class=\"mtk1\">.</span><span class=\"mtk11\">permissionlessUnpause</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>However unlikely this is to happen, there are some simple steps that can be taken to prevent if from being possible:</p>\n<p>Consider adding <code>whenNotPaused</code> to <code>grantGuardiansPause</code> to prevent mistakes (or possible abuse). And also overriding the calls <code>renounceOwnership</code> and <code>transferOwnership</code>. <code>transferOwnership</code> should be a governance call (<code>msg.sender == address(this)</code>) to move the <code>guardian</code> to a new trusted account.</p>\n<p>Perhaps also consider if the <code>assert(!guardianPauseAllowed)</code> is worth just for pleasing the SMT solver.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/314#issuecomment-1659400867\">ElliotFriedman (Moonwell) confirmed</a></strong></p>\n<hr>\n<h2 id=\"m-07-fasttrackproposalexecution-doesnt-check-intendedrecipient\" style=\"position:relative;\"><a href=\"#m-07-fasttrackproposalexecution-doesnt-check-intendedrecipient\" aria-label=\"m 07 fasttrackproposalexecution doesnt check intendedrecipient permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/308\">[M-07] <code>fastTrackProposalExecution</code> doesn’t check <code>intendedRecipient</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/308\">immeas</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/269\">0xComfyCat</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/280\">Vagner</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/219\">markus_ether</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/216\">kutugu</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/205\">ast3ros</a>, and <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/87\">volodya</a></em></p>\n<p>Wormhole cross chain communication <a href=\"https://docs.wormhole.com/wormhole/explore-wormhole/core-contracts#multicast\">is multicasted</a> to all their supported chains:</p>\n<blockquote>\n<p>Please notice that there is no destination address or chain in these functions.\nVAAs simply attest that “this contract on this chain said this thing.” Therefore, VAAs are multicast by default and will be verified as authentic on any chain they are brought to.</p>\n</blockquote>\n<p>The <code>TermporalGovernor</code> contract handles this by checking <code>queueProposal</code> that the <code>intendedRecipient</code> is itself:</p>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L320-L322\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L320-L322</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Governance</span><span class=\"mtk1\">/</span><span class=\"mtk12\">TemporalGovernor</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">320</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// Very important to check to make sure that the VAA we&#39;re processing is specifically designed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">321</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// to be sent to this contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">322</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">intendedRecipient</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;TemporalGovernor: Incorrect destination&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>There is also a <code>fastTrackProposalExecution</code> that the guardian can perform (<code>owner</code> is referred ot as <code>guardian</code>):</p>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L261-L268\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L261-L268</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Governance</span><span class=\"mtk1\">/</span><span class=\"mtk12\">TemporalGovernor</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">261</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">/// @notice Allow the guardian to process a VAA when the</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">262</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">/// Temporal Governor is paused this is only for use during</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">263</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">/// periods of emergency when the governance on moonbeam is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">264</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">/// compromised and we need to stop additional proposals from going through.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">265</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">/// @param VAA The signed Verified Action Approval to process</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">266</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">fastTrackProposalExecution</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">VAA</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">267</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">_executeProposal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">VAA</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">); </span><span class=\"mtk3\">/// override timestamp checks and execute</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">268</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<p>This will bypass the <code>queueProposal</code> flow and execute commands immediately.</p>\n<p>The issue here is that there is no check in <code>_executeProposal</code> that the <code>intendedRecipient</code> is this <code>TemporalGovernor</code>.</p>\n<h3 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p><code>governor</code> can execute any commands communicated across <code>Wormhole</code> as long as they are from a trusted source.</p>\n<p>This requires that the <code>targets</code> line up between chains for a <code>governor</code> to abuse this. However only one <code>target</code> must line up as the <code>.call</code> made <a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L395-L402\">does not check for contract existence</a>. Since “unaligned” addresses between chains will most likely not exist on other chains these calls will succeeed.</p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Test in <code>TemporalGovernorExec.t.sol</code>, all of the test is copied from <code>testProposeFailsIncorrectDestination</code> with just the change at the end where instead of calling <code>queueProposal</code>, <code>fastTrackProposalExecution</code> is called instead, which doesn’t revert, thus highligting the issue.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testFasttrackExecuteSucceedsIncorrectDestination</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">targets</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">address</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">targets</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">governor</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">values</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">values</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">TemporalGovernor</span><span class=\"mtk1\">.</span><span class=\"mtk12\">TrustedSender</span><span class=\"mtk1\">[]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">trustedSenders</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">TemporalGovernor</span><span class=\"mtk1\">.</span><span class=\"mtk10\">TrustedSender</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">trustedSenders</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">ITemporalGovernor</span><span class=\"mtk1\">.</span><span class=\"mtk11\">TrustedSender</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">chainId:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">trustedChainid</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">addr:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newAdmin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payloads</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">bytes</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">payloads</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSignature</span><span class=\"mtk1\">( </span><span class=\"mtk3\">/// if issues use encode with selector</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;setTrustedSenders((uint16,address)[])&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">trustedSenders</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">/// wrong intendedRecipient</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payload</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newAdmin</span><span class=\"mtk1\">, </span><span class=\"mtk12\">targets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">values</span><span class=\"mtk1\">, </span><span class=\"mtk12\">payloads</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">mockCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setStorage</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4\">true</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">trustedChainid</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">governor</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addressToBytes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">admin</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;reeeeeee&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">payload</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// guardian can fast track execute calls intended for other contracts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">governor</span><span class=\"mtk1\">.</span><span class=\"mtk11\">fastTrackProposalExecution</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider adding a check in <code>_executeProposal</code> for <code>intendedRecipient</code> same as is done in <code>_queueProposal</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/308#issuecomment-1664693231\">ElliotFriedman (Moonwell) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>This is a valid finding. However, in order for this to be exploitable, the proper governor would have to emit the proper calldata on another chain, with the exactly needed calldata formatting, and call publishMessage for this to be exploitable which is a 0% chance of happening.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-08-fasttrackproposalexecution-should-only-be-callable-when-temporalgovernor-is-paused\" style=\"position:relative;\"><a href=\"#m-08-fasttrackproposalexecution-should-only-be-callable-when-temporalgovernor-is-paused\" aria-label=\"m 08 fasttrackproposalexecution should only be callable when temporalgovernor is paused permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/276\">[M-08] <code>fastTrackProposalExecution</code> should only be callable when <code>TemporalGovernor</code> is paused</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/276\">Aymen0909</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/408\">hals</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/245\">sces60107</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/128\">Jigsaw</a>, and <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/49\">ABAIKUNANBAEV</a></em></p>\n<p>The function <code>fastTrackProposalExecution</code> is supposed to be used by the <code>TemporalGovernor</code> owner during periods of emergency, when the contract is paused to fast track a certain proposal (queue and execute a proposal directly without delay or voting), with gaol of ensuring the protocol safety.</p>\n<p>But the function <code>fastTrackProposalExecution</code> is missing the <code>whenPaused</code> modifier which means it can be called at any time to fast track any proposal and not just when the <code>TemporalGovernor</code> is paused.</p>\n<p>I submit this issue as only Medium risk because only the <code>TemporalGovernor</code> owner can call the <code>fastTrackProposalExecution</code> function (and i suppose that the owner is trusted and will not execute malicious actions), but this issue still goes against the intent of the governance process in which the members of the DAO are supposed to propose, vote and execute the proposals in a permissionless and decentralized manner and where the owner should not be able to execute actions on the protocol without the agreement of the members (except for those emergency situation of course).</p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The issue is present in the <code>fastTrackProposalExecution</code> function below :</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @notice Allow the guardian to process a VAA when the</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// Temporal Governor is paused this is only for use during</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// periods of emergency when the governance on moonbeam is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// compromised and we need to stop additional proposals from going through.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @param VAA The signed Verified Action Approval to process</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">fastTrackProposalExecution</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">VAA</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// @audit can be called when contract is not paused </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_executeProposal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">VAA</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">); </span><span class=\"mtk3\">/// override timestamp checks and execute</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>As it can be seen the function does not contain the <code>whenPaused</code> modifier and thus it can be called at any moment by the owner to fast track a proposal.</p>\n<p>We can also notice that the function comments do mention the fact that it should only be called when the Temporal Governor is paused.</p>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>I recommend to add the <code>whenPaused</code> modifier to the <code>fastTrackProposalExecution</code> function, in order to ensure that the governance process will always work as a real DAO and the owner only intervene in the emergency cases.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/245\">ElliotFriedman (Moonwell) confirmed in a duplicate issue (245)</a></strong></p>\n<hr>\n<h2 id=\"m-09-proposals-which-intend-to-send-native-tokens-to-target-addresses-cant-be-executed\" style=\"position:relative;\"><a href=\"#m-09-proposals-which-intend-to-send-native-tokens-to-target-addresses-cant-be-executed\" aria-label=\"m 09 proposals which intend to send native tokens to target addresses cant be executed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/268\">[M-09] Proposals which intend to send native tokens to target addresses can’t be executed</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/268\">hals</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/309\">immeas</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/294\">0xComfyCat</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/200\">RED-LOTUS-REACH</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/159\">Kaysoft</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/333\">Tendency</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/284\">Vagner</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/275\">0xl51</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/249\">sces60107</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/125\">kodyvim</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/105\">0x70C9</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/63\">T1MOH</a>, and <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/34\">bin2chen</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/fced18035107a345c31c9a9497d0da09105df4df/src/core/Governance/TemporalGovernor.sol#L237-L239\">https://github.com/code-423n4/2023-07-moonwell/blob/fced18035107a345c31c9a9497d0da09105df4df/src/core/Governance/TemporalGovernor.sol#L237-L239</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/fced18035107a345c31c9a9497d0da09105df4df/src/core/Governance/TemporalGovernor.sol#L400-L402\">https://github.com/code-423n4/2023-07-moonwell/blob/fced18035107a345c31c9a9497d0da09105df4df/src/core/Governance/TemporalGovernor.sol#L400-L402</a></p>\n<ul>\n<li>In <code>TemporalGovernor</code> contract: any verified action approval (VAA)/proposal can be executed by anyone if it has been queued and passed the time delay.</li>\n<li>But if the proposal is intended to send native tokens to the target address; it will revert since <code>TemporalGovernor</code> contract doesn’t have any balance, as there’s no <code>receive()</code> or payable functions to receive the funds that will be sent to the proposal’s target address.</li>\n<li>So any proposal with a value (decoded from <code>vm.payload</code>) will not be executed since the<br>\n<code>target.call{value:value}(data)</code> will revert.</li>\n</ul>\n<h3 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ul>\n<li>Code:\n<a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/fced18035107a345c31c9a9497d0da09105df4df/src/core/Governance/TemporalGovernor.sol#L237-L239\">Line 237-239</a></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Governance</span><span class=\"mtk1\">/</span><span class=\"mtk12\">TemporalGovernor</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Line</span><span class=\"mtk1\"> </span><span class=\"mtk7\">237</span><span class=\"mtk1\">-</span><span class=\"mtk7\">239</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">executeProposal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">VAA</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">whenNotPaused</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_executeProposal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">VAA</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/fced18035107a345c31c9a9497d0da09105df4df/src/core/Governance/TemporalGovernor.sol#L400-L402\">Line 400-402</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Governance</span><span class=\"mtk1\">/</span><span class=\"mtk12\">TemporalGovernor</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Line</span><span class=\"mtk1\"> </span><span class=\"mtk7\">400</span><span class=\"mtk1\">-</span><span class=\"mtk7\">402</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">returnData</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">target</span><span class=\"mtk1\">.</span><span class=\"mtk12\">call</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">value</span><span class=\"mtk1\">}(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">data</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span></code></pre>\n<ul>\n<li>Foundry PoC:</li>\n<li>This test is copied from <code>testExecuteSucceeds</code> test in <code>TemporalGovernorExec.t.sol</code> file,and modified to demonstrate the issue; where a proposal is set to send an EOA receiverAddress a value of 1 ether, but will revert due to lack of funds (follow the comments in the test):</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testProposalWithValueExecutionFails</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receiverAddress</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">targets</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">address</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">targets</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">receiverAddress</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">values</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">values</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// the proposal has a value of 1 eth to send it to the receiverAddress</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payloads</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">bytes</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">payloads</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSignature</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">/// to be unbundled by the temporal governor</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payload</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">governor</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">targets</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">values</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">payloads</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">mockCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setStorage</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4\">true</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">trustedChainid</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">governor</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addressToBytes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">admin</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;reeeeeee&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">payload</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">governor</span><span class=\"mtk1\">.</span><span class=\"mtk11\">queueProposal</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">hash</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">executed</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint248</span><span class=\"mtk1\"> </span><span class=\"mtk12\">queueTime</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">governor</span><span class=\"mtk1\">.</span><span class=\"mtk11\">queuedTransactions</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hash</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">queueTime</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertFalse</span><span class=\"mtk1\">(</span><span class=\"mtk12\">executed</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">//---executing the reposal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">proposalDelay</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">//check that the balance of receiverAddress is zero before execution:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">receiverAddress</span><span class=\"mtk1\">.</span><span class=\"mtk12\">balance</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// executeProposal function will revert due to lack of funds:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">governor</span><span class=\"mtk1\">.</span><span class=\"mtk11\">executeProposal</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertFalse</span><span class=\"mtk1\">(</span><span class=\"mtk12\">executed</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// the proposal wasn&#39;t executed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">receiverAddress</span><span class=\"mtk1\">.</span><span class=\"mtk12\">balance</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// the receiverAddress hasn&#39;t received any funds because the proposal execution has reverted due to lack of funds</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<ol start=\"2\">\n<li>Test result:</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"bash\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">$ forge </span><span class=\"mtk11\">test</span><span class=\"mtk1\"> --match-test testProposalWithValueExecutionFails -vvv</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">Running 1 </span><span class=\"mtk11\">test</span><span class=\"mtk1\"> </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> test/unit/TemporalGovernor/TemporalGovernorExec.t.sol:TemporalGovernorExecutionUnitTest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">[PASS] </span><span class=\"mtk11\">testProposalWithValueExecutionFails</span><span class=\"mtk1\">() (gas: 458086)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">Test result: ok. 1 passed; 0 failed; finished </span><span class=\"mtk15\">in</span><span class=\"mtk1\"> 2.05ms</span></span></span></code></pre>\n<h3 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Foundry.</p>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add <code>receive()</code> function to the <code>TemporalGovernor</code> contract; so that it can receive funds (native tokens) to be sent with proposals.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/268#issuecomment-1664712747\">ElliotFriedman (Moonwell) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Good finding!</p>\n</blockquote>\n<hr>\n<h2 id=\"m-10-initial-deploy-wont-succeed-because-of-too-high-initialmintamount-for-usdc-market\" style=\"position:relative;\"><a href=\"#m-10-initial-deploy-wont-succeed-because-of-too-high-initialmintamount-for-usdc-market\" aria-label=\"m 10 initial deploy wont succeed because of too high initialmintamount for usdc market permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/143\">[M-10] Initial deploy won’t succeed because of too high <code>initialMintAmount</code> for USDC market</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/143\">T1MOH</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/322\">immeas</a></em></p>\n<p>At the time of deploy, deployer initializes token markets with initial amount to prevent exploit. At least USDC and WETH markets will be initialized during deploy.\nBut <code>initialMintAmount</code> is hardcoded to <code>1e18</code> which is of for WETH (1,876 USD), but unrealistic for USDC (1,000,000,000,000 USD). Therefore deploy will fail.</p>\n<h3 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Here <code>initialMintAmount = 1 ether</code>: <br><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/fced18035107a345c31c9a9497d0da09105df4df/test/proposals/Configs.sol#L55\">https://github.com/code-423n4/2023-07-moonwell/blob/fced18035107a345c31c9a9497d0da09105df4df/test/proposals/Configs.sol#L55</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @notice initial mToken mint amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">initialMintAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>Here this amount is approved to MToken contract and supplied to mint MToken: <br><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/fced18035107a345c31c9a9497d0da09105df4df/test/proposals/mips/mip00.sol#L334-L379\">https://github.com/code-423n4/2023-07-moonwell/blob/fced18035107a345c31c9a9497d0da09105df4df/test/proposals/mips/mip00.sol#L334-L379</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">cTokenConfigs</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">Configs</span><span class=\"mtk1\">.</span><span class=\"mtk12\">CTokenConfiguration</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">config</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">cTokenConfigs</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">cTokenAddress</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">config</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addressesString</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">               ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">/// Approvals</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">_pushCrossChainAction</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">config</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSignature</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        </span><span class=\"mtk8\">&quot;approve(address,uint256)&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        </span><span class=\"mtk12\">cTokenAddress</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        </span><span class=\"mtk12\">initialMintAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    ),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk8\">&quot;Approve underlying token to be spent by market&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">/// Initialize markets</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">_pushCrossChainAction</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">cTokenAddress</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSignature</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;mint(uint256)&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">initialMintAmount</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk8\">&quot;Initialize token market to prevent exploit&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Specify <code>initialMintAmount</code> for every token separately in config</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/143#issuecomment-1664684681\">ElliotFriedman (Moonwell) confirmed, but disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Valid issue, but we have already fixed this. Probably a low severity issue as this deploy script was only configured to work on local testnets where we control the ERC20 tokens.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/143#issuecomment-1676098751\">alcueca (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>The issue is still valid as Medium with the code and knowledge available to the wardens.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-11-incorrect-address-is-set-as-wormhole-bridge-which-breaks-deploy\" style=\"position:relative;\"><a href=\"#m-11-incorrect-address-is-set-as-wormhole-bridge-which-breaks-deploy\" aria-label=\"m 11 incorrect address is set as wormhole bridge which breaks deploy permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/118\">[M-11] Incorrect address is set as Wormhole Bridge, which breaks deploy</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/118\">T1MOH</a></em></p>\n<p>Wormhole Bridge will have incorrect address, which disables whole TemporalGovernance contract and therefore administration of Moonbeam. But during deployment markets are initialized with initial token amounts to prevent exploits, therefore TemporalGovernance must own this initial tokens. But because of incorrect bridge address TemporalGovernance can’t perform any action and these tokens are brick.\nProtocol needs redeployment and loses initial tokens.</p>\n<h3 id=\"proof-of-concept-10\" style=\"position:relative;\"><a href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>To grab this report easily I divided it into 3 parts</p>\n<ol>\n<li>Why <code>WORMHOLE_CORE</code> set incorrectly</li>\n</ol>\n<p>There is no config for Base Mainnet, however this comment states for used parameters: <br><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/fced18035107a345c31c9a9497d0da09105df4df/test/proposals/mips/mip00.sol#L55-L61\">https://github.com/code-423n4/2023-07-moonwell/blob/fced18035107a345c31c9a9497d0da09105df4df/test/proposals/mips/mip00.sol#L55-L61</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// --------------------------------------------------------------------------------------------------///</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// Chain Name\t       Wormhole Chain ID   Network ID\tAddress                                      |///</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">///  Ethereum (Goerli)   \t  2\t                5\t    0x706abc4E45D419950511e474C7B9Ed348A4a716c   |///</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">///  Ethereum (Sepolia)\t  10002          11155111\t    0x4a8bc80Ed5a4067f1CCf107057b8270E0cC11A78   |///</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">///  Base\t                 30    \t        84531\t    0xA31aa3FDb7aF7Db93d18DDA4e19F811342EDF780   |///</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">///  Moonbeam\t             16\t             1284 \t    0xC8e2b0cD52Cf01b0Ce87d389Daa3d414d4cE29f3   |///</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// --------------------------------------------------------------------------------------------------///</span></span></span></code></pre>\n<p>Why to treat this comment? Other parameters are correct except Base Network ID. But Base Network ID has reflection in code, described in #114.\n0xA31aa3FDb7aF7Db93d18DDA4e19F811342EDF780 is address of Wormhole Token Bridge on Base Testnet <a href=\"https://docs.wormhole.com/wormhole/supported-environments/evm#base\">according to docs</a> and this address has no code <a href=\"https://basescan.org/address/0xA31aa3FDb7aF7Db93d18DDA4e19F811342EDF780\">in Base Mainnet</a>.</p>\n<ol start=\"2\">\n<li>Why governor can’t execute proposals with incorrect address of Wormhole Bridge</li>\n</ol>\n<p>Proposal execution will revert here because address <code>wormholeBridge</code> doesn’t contain code: <br><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/fced18035107a345c31c9a9497d0da09105df4df/src/core/Governance/TemporalGovernor.sol#L344-L350\">https://github.com/code-423n4/2023-07-moonwell/blob/fced18035107a345c31c9a9497d0da09105df4df/src/core/Governance/TemporalGovernor.sol#L344-L350</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_executeProposal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">VAA</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">overrideDelay</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// This call accepts single VAAs and headless VAAs</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">IWormhole</span><span class=\"mtk1\">.</span><span class=\"mtk12\">VM</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">valid</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">reason</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ) = </span><span class=\"mtk12\">wormholeBridge</span><span class=\"mtk1\">.</span><span class=\"mtk11\">parseAndVerifyVM</span><span class=\"mtk1\">(</span><span class=\"mtk12\">VAA</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<ol start=\"3\">\n<li>Impact of inability to execute proposals in TemporalGovernor.sol</li>\n</ol>\n<p>Here you can see that deployer should provide initial amounts of tokens to initialize markets:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @notice the deployer should have both USDC, WETH and any other assets that will be started as</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// listed to be able to deploy on base. This allows the deployer to be able to initialize the</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// markets with a balance to avoid exploits</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deploy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Addresses</span><span class=\"mtk1\"> </span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>And here governor approves underlying token to MToken and mints initial mTokens. It means that governor has tokens on balance.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">build</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Addresses</span><span class=\"mtk1\"> </span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">/// Unitroller configuration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_pushCrossChainAction</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;UNITROLLER&quot;</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSignature</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;_acceptAdmin()&quot;</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;Temporal governor accepts admin on Unitroller&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">/// set mint unpaused for all of the deployed MTokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">cTokenConfigs</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">Configs</span><span class=\"mtk1\">.</span><span class=\"mtk12\">CTokenConfiguration</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">config</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">cTokenConfigs</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">cTokenAddress</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">config</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addressesString</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">_pushCrossChainAction</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">unitrollerAddress</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSignature</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        </span><span class=\"mtk8\">&quot;_setMintPaused(address,bool)&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        </span><span class=\"mtk12\">cTokenAddress</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    ),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk8\">&quot;Unpause MToken market&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">/// Approvals</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">_pushCrossChainAction</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">config</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSignature</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        </span><span class=\"mtk8\">&quot;approve(address,uint256)&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        </span><span class=\"mtk12\">cTokenAddress</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        </span><span class=\"mtk12\">initialMintAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    ),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk8\">&quot;Approve underlying token to be spent by market&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">/// Initialize markets</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">_pushCrossChainAction</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">cTokenAddress</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSignature</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;mint(uint256)&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">initialMintAmount</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk8\">&quot;Initialize token market to prevent exploit&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>To conclude, there is no way to return the tokens from the TemporalGovernor intended for market initialization</p>\n<h3 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Change <code>WORMHOLE_CORE</code> to 0xbebdb6C8ddC678FfA9f8748f85C815C556Dd8ac6 <a href=\"https://docs.wormhole.com/wormhole/supported-environments/evm#base\">according to docs</a></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/118#issuecomment-1664491379\">ElliotFriedman (Moonwell) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>This is correct on base goerli, however we have not added base mainnet contract yet as it has not been deployed. </p>\n</blockquote>\n<blockquote>\n<p>This can’t be a high or even medium risk bug because this is an issue in our testnet deploy configuration.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/118#issuecomment-1687098362\">alcueca (Judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Upon discussion with the sponsor about differences between this issue and #114, and actual impact of this issue, I’m instating Medium severity.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-12-incorrect-chainid-of-base-in-deploy-script-will-force-redeployment\" style=\"position:relative;\"><a href=\"#m-12-incorrect-chainid-of-base-in-deploy-script-will-force-redeployment\" aria-label=\"m 12 incorrect chainid of base in deploy script will force redeployment permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/114\">[M-12] Incorrect chainId of Base in deploy script will force redeployment</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/114\">T1MOH</a></em></p>\n<p>Incorrect chainId of Base in deploy parameters results in incorrect deploy and subsequent redeployment.</p>\n<h3 id=\"proof-of-concept-11\" style=\"position:relative;\"><a href=\"#proof-of-concept-11\" aria-label=\"proof of concept 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Contract ChainIds.sol is responsible for mapping <code>chainId -> wormholeChainId</code> which is used in contract <code>Addresses</code> to associate contract name with its address on specific chain. <code>Addresses</code> is the main contract which keeps track of all dependency addresses and passed into main <code>deploy()</code> and here addresses accessed via block.chainId: <br><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/fced18035107a345c31c9a9497d0da09105df4df/test/proposals/mips/mip00.sol#L77\">https://github.com/code-423n4/2023-07-moonwell/blob/fced18035107a345c31c9a9497d0da09105df4df/test/proposals/mips/mip00.sol#L77</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deploy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Addresses</span><span class=\"mtk1\"> </span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">trustedSenders</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk12\">chainId</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">chainIdToWormHoleId</span><span class=\"mtk1\">[</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">chainid</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">cTokenConfigs</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getCTokenConfigurations</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">chainid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>Here you can see that Network ID of Base set to 84531. But actual network id is 8453 from <a href=\"https://docs.base.org/network-information/\">Base docs</a>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ChainIds</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">baseChainId</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">84531</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">baseWormholeChainId</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">30</span><span class=\"mtk1\">; </span><span class=\"mtk3\">/// TODO update when actual base chain id is known</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">baseGoerliChainId</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">84531</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">baseGoerliWormholeChainId</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">30</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">chainIdToWormHoleId</span><span class=\"mtk1\">[</span><span class=\"mtk12\">baseChainId</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">moonBeamWormholeChainId</span><span class=\"mtk1\">; </span><span class=\"mtk3\">/// base deployment is owned by moonbeam governance</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Change Base Network ID to 8453.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/114#issuecomment-1664489765\">ElliotFriedman (Moonwell) confirmed</a></strong></p>\n<hr>\n<h2 id=\"m-13-its-not-possible-to-liquidate-deprecated-market\" style=\"position:relative;\"><a href=\"#m-13-its-not-possible-to-liquidate-deprecated-market\" aria-label=\"m 13 its not possible to liquidate deprecated market permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/67\">[M-13] It’s not possible to liquidate deprecated market</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/67\">volodya</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/368\">Udsen</a></em></p>\n<p>Currently in the code that is a function <code>_setBorrowPaused</code> that paused pause borrowing. In <a href=\"https://github.com/compound-finance/compound-protocol/blob/a3214f67b73310d547e00fc578e8355911c9d376/contracts/Comptroller.sol#L1452\">origin compound code</a> <code>borrowGuardianPaused</code> is used to do liquidate markets that are bad. So now there is not way to get rid of bad markets.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">liquidateBorrowAllowed</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mTokenBorrowed</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mTokenCollateral</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liquidator</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">repayAmount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Shh - currently unused</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">liquidator</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">markets</span><span class=\"mtk1\">[</span><span class=\"mtk12\">mTokenBorrowed</span><span class=\"mtk1\">].</span><span class=\"mtk12\">isListed</span><span class=\"mtk1\"> || !</span><span class=\"mtk12\">markets</span><span class=\"mtk1\">[</span><span class=\"mtk12\">mTokenCollateral</span><span class=\"mtk1\">].</span><span class=\"mtk12\">isListed</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">uint</span><span class=\"mtk1\">(</span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk12\">MARKET_NOT_LISTED</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">/* The borrower must have shortfall in order to be liquidatable */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk10\">Error</span><span class=\"mtk1\"> </span><span class=\"mtk12\">err</span><span class=\"mtk1\">, , </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shortfall</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">getAccountLiquidityInternal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">err</span><span class=\"mtk1\"> != </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk12\">NO_ERROR</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">uint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">err</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">shortfall</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">uint</span><span class=\"mtk1\">(</span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk12\">INSUFFICIENT_SHORTFALL</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">/* The liquidator may not repay more than what is allowed by the closeFactor */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">borrowBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">MToken</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mTokenBorrowed</span><span class=\"mtk1\">).</span><span class=\"mtk11\">borrowBalanceStored</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maxClose</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">mul_ScalarTruncate</span><span class=\"mtk1\">(</span><span class=\"mtk11\">Exp</span><span class=\"mtk1\">({</span><span class=\"mtk12\">mantissa:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">closeFactorMantissa</span><span class=\"mtk1\">}), </span><span class=\"mtk12\">borrowBalance</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">repayAmount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">maxClose</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">uint</span><span class=\"mtk1\">(</span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk12\">TOO_MUCH_REPAY</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">uint</span><span class=\"mtk1\">(</span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk12\">NO_ERROR</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/fced18035107a345c31c9a9497d0da09105df4df/src/core/Comptroller.sol#L394\">src/core/Comptroller.sol#L394</a></p>\n<p>Here is a list why liquidating deprecated markets can be necessary:</p>\n<ol>\n<li>Deprecated markets may pose security risks, especially if they are no longer actively monitored or maintained. By liquidating these markets, the platform reduces the potential for vulnerabilities and ensures that user funds are not exposed to unnecessary risks.</li>\n<li>Deprecated markets might require ongoing resources to maintain and support, including development efforts and infrastructure costs. By liquidating these markets, the platform can optimize resources and focus on more actively used markets and features.</li>\n<li>Older markets might be based on legacy smart contracts that lack the latest security enhancements and improvements. Liquidating these markets allows the platform to migrate users to more secure and up-to-date contracts.</li>\n<li>Deprecated markets may result in a fragmented user base, leading to reduced liquidity and trading activity. By consolidating users onto actively used markets, the platform can foster higher liquidity and better user engagement.</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>I think compound have a way to liquidate deprecated markets for a safety reason, so it needs to be restored.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function liquidateBorrowAllowed(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        address mTokenBorrowed,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        address mTokenCollateral,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        address liquidator,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        address borrower,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint repayAmount) override external view returns (uint) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        // Shh - currently unused</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        liquidator;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        /* allow accounts to be liquidated if the market is deprecated */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        if (isDeprecated(CToken(cTokenBorrowed))) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            require(borrowBalance &gt;= repayAmount, &quot;Can not repay more than the total borrow&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            return uint(Error.NO_ERROR);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        if (!markets[mTokenBorrowed].isListed || !markets[mTokenCollateral].isListed) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            return uint(Error.MARKET_NOT_LISTED);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        /* The borrower must have shortfall in order to be liquidatable */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (Error err, , uint shortfall) = getAccountLiquidityInternal(borrower);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        if (err != Error.NO_ERROR) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            return uint(err);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        if (shortfall == 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            return uint(Error.INSUFFICIENT_SHORTFALL);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        /* The liquidator may not repay more than what is allowed by the closeFactor */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint borrowBalance = MToken(mTokenBorrowed).borrowBalanceStored(borrower);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint maxClose = mul_ScalarTruncate(Exp({mantissa: closeFactorMantissa}), borrowBalance);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        if (repayAmount &gt; maxClose) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            return uint(Error.TOO_MUCH_REPAY);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        return uint(Error.NO_ERROR);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    function isDeprecated(CToken cToken) public view returns (bool) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        return</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        markets[address(cToken)].collateralFactorMantissa == 0 &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        borrowGuardianPaused[address(cToken)] == true &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        cToken.reserveFactorMantissa() == 1e18</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        ;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    } </span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/67#issuecomment-1664641164\">ElliotFriedman (Moonwell) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>This is a valid finding, nice find!</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/67#issuecomment-1687073680\">alcueca (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>Despite the lack of PoC, this finding states clearly why the feature should be restored.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-14-borrower-and-supplier-rewards--accrued-could-be-lost-when-admin-replaces-the-reward-distributor-with-a-new-reward-distributor\" style=\"position:relative;\"><a href=\"#m-14-borrower-and-supplier-rewards--accrued-could-be-lost-when-admin-replaces-the-reward-distributor-with-a-new-reward-distributor\" aria-label=\"m 14 borrower and supplier rewards  accrued could be lost when admin replaces the reward distributor with a new reward distributor permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/58\">[M-14] Borrower and Supplier rewards  accrued could be lost when Admin replaces the reward distributor with a new reward distributor</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/58\">ravikiranweb3</a></em></p>\n<p>Comptroller’s admin user can replace the rewards distributor contract with a new MultiRewardDistributor\nusing _setRewardDistributor() function.</p>\n<p>At that time, if the supplier and borrowers had accured rewards that are not distributed. The _setRewardDistributor() function replaces the old reward distributor with the new one without disbursing the borrower and supplier rewards accured.</p>\n<p>The new logic of computation and distribution could be different in the newer version and hence before replacement, the accured rewards should be distributed using the existing logic.</p>\n<p>The new accruals could take effect with nil accruals providing a clean slate.</p>\n<h3 id=\"proof-of-concept-12\" style=\"position:relative;\"><a href=\"#proof-of-concept-12\" aria-label=\"proof of concept 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The setRewardDistributor updates the mutiRewardDistributor contract with a new instance with out\ntransferring the accured rewards to borrowers and lenders.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function _setRewardDistributor(MultiRewardDistributor newRewardDistributor) public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(msg.sender == admin, &quot;Unauthorized&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        MultiRewardDistributor oldRewardDistributor = rewardDistributor;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rewardDistributor = newRewardDistributor;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit NewRewardDistributor(oldRewardDistributor, newRewardDistributor);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>The above set function should be added with a logic to look at all the markets and for each market,\nthe borrower and supplier rewards should be disbursed before the new instance is updated.\nAs long as there are accured rewards, the old instance should not be replaced.</p>\n<h3 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p><strong>Approach 1: Onchain approach</strong></p>\n<p>Step 1: Maintain a list of all accounts that participate in borrowing and supplying.\ngetAllParticipants() returns a list of participants.</p>\n<p>Step 2: Add an internal function disburseAllRewards() which can be called by adminOnly.\nThis function looks for all partitipant accounts and for all markets, it claims rewards before updating the rewards distributor with a new instance.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"> function disburseAllRewards() internal adminOnly {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address[] memory holders = getAllParticipants();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        MToken[] memory mTokens = getAllMarkets();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        claimReward(holders, mTokens, true, true);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> // @audit use the existing claimReward function to disburse the rewards to accounts that had accruals.</span></span></code></pre>\n<p><strong>Approach 2: Offchain approach</strong></p>\n<p>As the number of participants and markets grow, the onchain approach may result in DOS as the size of computations may not fit in a single block due to gas limit.</p>\n<p>As an alternative, the claimReward() could be called from the outside for all the holders and markets\nin smaller chunks.</p>\n<p>Use getOutstandingRewardsForUser() function to check if there are any un-disbursed rewards in the MultiRewarddistributor contract. Only if there are no un-disbursed rewards, then only allow the admin to replace the reward distributor contract with a new instance.</p>\n<p>Taking these steps will prevent the potential case where borrowers and suppliers could loose accured rewards.</p>\n<p>Key drive away with this approach is, unless all the accured are distributed and they is nothing to distribute, dont update the multi reward distributor contract.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/58#issuecomment-1664638038\">ElliotFriedman (Moonwell) confirmed, but disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>This is valid, but disagree with severity since admin is trusted. Otherwise, if admin isn’t trusted, then they could rug all the funds in the contract using the <code>_rescueFunds</code> method.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/58#issuecomment-1676107827\">alcueca (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>@ElliotFriedman - Note that the admin doesn’t need to be malicious. You could be a few months down the line, and receive a bug report that forces you to pause and replace the rewards distributor. It would be really uncomfortable to move the not claimed rewards to the new contract.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-15-accrueinterest-is-expected-to-revert-when-the-rate-is-higher-than-the-maximum-allowed-rate-which-is-possible-since-the-utilization-can-be-more-than-1\" style=\"position:relative;\"><a href=\"#m-15-accrueinterest-is-expected-to-revert-when-the-rate-is-higher-than-the-maximum-allowed-rate-which-is-possible-since-the-utilization-can-be-more-than-1\" aria-label=\"m 15 accrueinterest is expected to revert when the rate is higher than the maximum allowed rate which is possible since the utilization can be more than 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/40\">[M-15] <code>accrueInterest</code> is expected to revert when the rate is higher than the maximum allowed rate, which is possible since the utilization can be more than 1</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/40\">0xWaitress</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/37\">0xWaitress</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/207\">ast3ros</a>, catellatech (<a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/161\">1</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/75\">2</a>), Nyx (<a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/139\">1</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/135\">2</a>), <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/111\">kodyvim</a>, and nadin (<a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/82\">1</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/70\">2</a>)</em></p>\n<p>accrueInterest is expected to revert when the rate is higher than the maximum allowed rate, which is possible since the utilization can be more than 1</p>\n<p>accrueInterest is an essential function to keep updated of the global mToken interest payment from the borrower to the depositor. The function is called anytime there is a deposit/liquidate/borrow/repay/withdraw.</p>\n<p>The function is set to revert when the borrowRateMantissa is bigger than the borrowRateMaxMantissa.</p>\n<p><code>require(borrowRateMantissa &#x3C;= borrowRateMaxMantissa, \"borrow rate is absurdly high\");</code>.</p>\n<p>With proper configuration, this check should be fine since the real borrowRate should be calibrated to be within the maxRate. However, since the utilization could actually be bigger than 1 (when reserve is bigger than cash [issue-37] , the actual rate could be bigger than the expected unreachable max rate:</p>\n<p>Example:<br>\nBase: 1%<br>\nmultiplierPerTimestamp: 5% APR<br>\njumpMultiplier: 50% APR<br>\nklink: 50%<br>\nWe could reasonably assume the max APR is 1% + 5% * 0.5 + 50% * (1-0.5) = 28.5%</p>\n<p>However when reserve is more than cash it would cause the utilization be bigger than 1, let’say utilization is 101%: such that the actual rate would  be:</p>\n<p>1% + 5% * 0.5 + 50% * (1.01 - 0.5) = 29%</p>\n<p>This would cause the accurueInterest to revert.</p>\n<p>Impact: all deposit/withdraw/borrow/repay function would fail and severe brick the operation of the protocol and lock user funds. Interest accrual cannot work which impact both borrower for timely exit as well as deposit to collect their interest.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">accrueInterest</span><span class=\"mtk1\">() </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">/* Remember the initial block timestamp */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentBlockTimestamp</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getBlockTimestamp</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">accrualBlockTimestampPrior</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">accrualBlockTimestamp</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">/* Short-circuit accumulating 0 interest */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">accrualBlockTimestampPrior</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">currentBlockTimestamp</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">uint</span><span class=\"mtk1\">(</span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk12\">NO_ERROR</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">/* Read the previous values out of storage */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">cashPrior</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getCashPrior</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">borrowsPrior</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalBorrows</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">reservesPrior</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalReserves</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">borrowIndexPrior</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">borrowIndex</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">/* Calculate the current borrow interest rate */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">borrowRateMantissa</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">interestRateModel</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getBorrowRate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">cashPrior</span><span class=\"mtk1\">, </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">borrowsPrior</span><span class=\"mtk1\">, </span><span class=\"mtk12\">reservesPrior</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrowRateMantissa</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">borrowRateMaxMantissa</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;borrow rate is</span><span class=\"mtk14\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">absurdly</span><span class=\"mtk1\"> </span><span class=\"mtk12\">high</span><span class=\"mtk8\">&quot;)</span><span class=\"mtk14\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MToken.sol#L403\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MToken.sol#L403</a></p>\n<h3 id=\"utilization-can-be-above-100-when-reserve-is-more-than-cash\" style=\"position:relative;\"><a href=\"#utilization-can-be-above-100-when-reserve-is-more-than-cash\" aria-label=\"utilization can be above 100 when reserve is more than cash permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Utilization can be above 100% when reserve is more than cash</h3>\n<p><em>Note: per <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/40#issuecomment-1676358828\">judge request</a>, this information from duplicate <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/37\">issue 37</a> has been appended to M-16 for the final report.</em></p>\n<p>Utilization is calculated as <code>borrow / (cash + borrow - reserve)</code>. and the utilization would determine the interest rate in this classic jump/klink model.</p>\n<p>Consider:</p>\n<ol>\n<li>both depositor and borrowers come in. Reserves accumulates as interest revenue paid by borrowers accrues.</li>\n<li>depositor withdraws. The protocol has only borrowers and the reserve.</li>\n</ol>\n<p>When reserves becomes more than cash, the formula for utilizationRate would give a utilization rate above 1. This is different from the code comment which said to <code>@return The utilization rate as a mantissa between [0, 1e18]</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     * @</span><span class=\"mtk12\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">The</span><span class=\"mtk1\"> </span><span class=\"mtk12\">utilization</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rate</span><span class=\"mtk1\"> </span><span class=\"mtk15\">as</span><span class=\"mtk1\"> </span><span class=\"mtk10\">a</span><span class=\"mtk1\"> </span><span class=\"mtk10\">mantissa</span><span class=\"mtk1\"> </span><span class=\"mtk10\">between</span><span class=\"mtk1\"> [</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">utilizationRate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">cash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">borrows</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">reserves</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Utilization rate is 0 when there are no borrows</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">borrows</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">borrows</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">).</span><span class=\"mtk11\">div</span><span class=\"mtk1\">(</span><span class=\"mtk12\">cash</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrows</span><span class=\"mtk1\">).</span><span class=\"mtk11\">sub</span><span class=\"mtk1\">(</span><span class=\"mtk12\">reserves</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/IRModels/JumpRateModel.sol#L66-L75\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/IRModels/JumpRateModel.sol#L66-L75</a></p>\n<h3 id=\"recommended-mitigation-steps-14\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-14\" aria-label=\"recommended mitigation steps 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<ul>\n<li>Consider to cap the real-time borrowRate as the borrowRateMaxMantissa instead of reverting.</li>\n<li>Consider put a cap of 1e18 to the final output.</li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/40#issuecomment-1664681830\">ElliotFriedman (Moonwell) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>Reserves can be pulled back to admin address by admin, so this is a non issue.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-16-a-single-emissioncap-is-not-suitable-for-different-tokens-reward-if-they-have-different-underlying-decimals\" style=\"position:relative;\"><a href=\"#m-16-a-single-emissioncap-is-not-suitable-for-different-tokens-reward-if-they-have-different-underlying-decimals\" aria-label=\"m 16 a single emissioncap is not suitable for different tokens reward if they have different underlying decimals permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/19\">[M-16] A single emissionCap is not suitable for different tokens reward if they have different underlying decimals</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/19\">0xWaitress</a></em></p>\n<p>At MultiRewardDistributor, different rewards token can be set up for each mToken, which is the assetToken or debtToken of the lending protocol. When a reward token is set up, it’s emission speed cannot be bigger than the emissionCap (100 * 1e18 as suggested in the code comment). However since multiple reward tokens may be set up, and they may have different decimal places, for example USDT has a decimal of 6 and GUSD even has a decimal of 2 they are virtually not bounded by such emissionCap.</p>\n<p>On the contract, tokens with more than 18 decimal would not be practically emitted. This one-size-fit-all emissionCap might create obstacles for the protocol to effectively manage each rewardTokens.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @notice The emission cap dictates an upper limit for reward speed emission speed configs</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @dev By default, is set to 100 1e18 token emissions / sec to avoid unbounded</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">///  computation/multiplication overflows</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">emissionCap</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_updateBorrowSpeed</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">MToken</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_mToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_emissionToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_newBorrowSpeed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyEmissionConfigOwnerOrAdmin</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_mToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_emissionToken</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">MarketEmissionConfig</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">emissionConfig</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">fetchConfigByEmissionToken</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_mToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_emissionToken</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentBorrowSpeed</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">emissionConfig</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            .</span><span class=\"mtk12\">config</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            .</span><span class=\"mtk12\">borrowEmissionsPerSec</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_newBorrowSpeed</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">currentBorrowSpeed</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;Can&#39;t set new borrow emissions to be equal to current!&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_newBorrowSpeed</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">emissionCap</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;Cannot set a borrow reward speed higher than the emission cap!&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MultiRewardDistributor/MultiRewardDistributor.sol#L703-L725\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MultiRewardDistributor/MultiRewardDistributor.sol#L703-L725</a></p>\n<h3 id=\"recommended-mitigation-steps-15\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-15\" aria-label=\"recommended mitigation steps 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider creating emissionCap for each rewardTokens so they can be adapted based on their own decimals.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/19#issuecomment-1664511228\">ElliotFriedman (Moonwell) confirmed, but disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>This is a known issue, the amount of tokens created is bounded 100e18 per second. then, reward speeds will be integration tested to ensure they are properly configured.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/19#issuecomment-1676100188\">alcueca (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>@ElliotFriedman, I’m not sure if you understood the finding. How would you set up the emissions cap if emissions are in USDT (6 decimals) and WETH (18 decimals).</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/19#issuecomment-1687007409\">ElliotFriedman (Moonwell) commented</a>:</strong></p>\n<blockquote>\n<p>Valid issue, just a question of is it medium severity. I’ll leave that for judges to decide.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/19#issuecomment-1687026326\">alcueca (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>Function incorrect as to spec would be QA - This means that if the way the code works is wrong but has no real impact in the business it is QA.</p>\n</blockquote>\n<blockquote>\n<p>Function of the protocol or its availability possibly impacted would be Medium - In certain cases, the emissionsCap will either not work or stop emissions, the protocol is impacted in a non-lethal manner, and the finding is medium.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/19#issuecomment-1687026326\">lyoungblood (Warden) commented</a>:</strong></p>\n<blockquote>\n<p>Good finding - disagree with the severity as the cap is just a safety feature that didn’t exist at all in the original Compound.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-17-borrowratemaxmantissa-should-be-specific-to-the-chain-protocol-is-being-deployed-to\" style=\"position:relative;\"><a href=\"#m-17-borrowratemaxmantissa-should-be-specific-to-the-chain-protocol-is-being-deployed-to\" aria-label=\"m 17 borrowratemaxmantissa should be specific to the chain protocol is being deployed to permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/18\">[M-17] borrowRateMaxMantissa should be specific to the chain protocol is being deployed to</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/18\">kankodu</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/319\">cryptonue</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MTokenInterfaces.sol#L23\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MTokenInterfaces.sol#L23</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/fced18035107a345c31c9a9497d0da09105df4df/src/core/MToken.sol#L403\">https://github.com/code-423n4/2023-07-moonwell/blob/fced18035107a345c31c9a9497d0da09105df4df/src/core/MToken.sol#L403</a></p>\n<ul>\n<li>The purpose of <a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MTokenInterfaces.sol#L23\">borrowRateMaxMantissa</a> is to put the protocol in failure mode when absurd utilisation makes borrowRate <a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/fced18035107a345c31c9a9497d0da09105df4df/src/core/MToken.sol#L403\">absurd</a>. It is defined as a constant for all the chains. It should really be changed according to average blocktime of the chain the protocol is being deployed to.</li>\n<li>borrowRateMaxMantissa = 0.0005e16 translates to maximum borrow rate of .0005% / block.</li>\n<li>For Ethereum chain that has 12 seconds of average block time, this translates to maximum borrow rate of <code>0.0005% * (365 * 24 * 3600)/12 = 1314</code>. For BNB with 3 seconds of average block time it is <code>0.0005% * (365 * 24 * 3600)/3 = 5256%</code>. For fantom with 1 second of average block time it is  <code>0.0005% * (365 * 24 * 3600)/1 = 15768%</code>.</li>\n</ul>\n<h3 id=\"proof-of-concept-13\" style=\"position:relative;\"><a href=\"#proof-of-concept-13\" aria-label=\"proof of concept 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MTokenInterfaces.sol#L23\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MTokenInterfaces.sol#L23</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/fced18035107a345c31c9a9497d0da09105df4df/src/core/MToken.sol#L403\">https://github.com/code-423n4/2023-07-moonwell/blob/fced18035107a345c31c9a9497d0da09105df4df/src/core/MToken.sol#L403</a></p>\n<h3 id=\"recommended-mitigation-steps-16\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-16\" aria-label=\"recommended mitigation steps 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<ul>\n<li>Decide on a maximum borrow rate protocol is ok with (my suggestion is ~1000%) and change <code>borrowRateMaxMantissa</code> according to what chain it is being deployed to.</li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/18#issuecomment-1664509106\">ElliotFriedman (Moonwell) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>Agreed this could be configured on a per chain basis, however this is legacy code that we don’t want to change. This instance is only being deployed on base, so maybe instead of making it configurable, this value could be adjusted downwards.</p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this audit, 56 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/328\">report highlighted below</a> by <strong>immeas</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/399\">0xAnah</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/394\">ChrisTina</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/377\">JP_Courses</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/361\">Udsen</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/349\">cryptonue</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/337\">0xkazim</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/332\">kutugu</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/326\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/310\">0xComfyCat</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/304\">jaraxxus</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/299\">josephdara</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/288\">Kaysoft</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/274\">Vagner</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/273\">hals</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/258\">twcctop</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/228\">said</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/226\">LosPollosHermanos</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/214\">ast3ros</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/196\">Arz</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/187\">Jorgect</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/185\">33audits</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/180\">solsaver</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/164\">Tendency</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/153\">Nyx</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/146\">cats</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/140\">mert_eren</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/132\">kodyvim</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/115\">Sathish9098</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/110\">MohammedRizwan</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/103\">0x70C9</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/85\">Rolezn</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/74\">catellatech</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/71\">berlin-101</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/69\">nadin</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/62\">T1MOH</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/61\">Stormreckson</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/43\">fatherOfBlocks</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/36\">ravikiranweb3</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/24\">0xWaitress</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/20\">niki</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/3\">souilos</a>,<a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/4\">kankodu</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/403\">Topmark</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/398\">naman1778</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/387\">wahedtalash77</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/382\">jamshed</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/339\">petrichor</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/247\">0xackermann</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/221\">0xArcturus</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/170\">lanrebayode77</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/151\">2997ms</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/147\">John_Femi</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/129\">banpaleo5</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/88\">albertwh1te</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/80\">codetilda</a>, and <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/13\">eeshenggoh</a>.</em></p>\n<h2 id=\"low-risk-findings-6\" style=\"position:relative;\"><a href=\"#low-risk-findings-6\" aria-label=\"low risk findings 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low-risk findings (6)</h2>\n<h2 id=\"l-01-guardian-can-fast-track-every-proposal\" style=\"position:relative;\"><a href=\"#l-01-guardian-can-fast-track-every-proposal\" aria-label=\"l 01 guardian can fast track every proposal permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01] <code>guardian</code> can fast track every proposal</h2>\n<p>In <code>TemporalGovernor</code> the <code>guardian</code> has a special permission that they can <code>fastTrackProposalExecution</code> which will <a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L354-L367\">bypass the normal <code>queueProposal</code> flow</a>:</p>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L261-L268\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L261-L268</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Governance</span><span class=\"mtk1\">/</span><span class=\"mtk12\">TemporalGovernor</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">261</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">/// @notice Allow the guardian to process a VAA when the</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">262</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">/// Temporal Governor is paused this is only for use during</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">263</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">/// periods of emergency when the governance on moonbeam is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">264</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">/// compromised and we need to stop additional proposals from going through.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">265</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">/// @param VAA The signed Verified Action Approval to process</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">266</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">fastTrackProposalExecution</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">VAA</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">267</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">_executeProposal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">VAA</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">); </span><span class=\"mtk3\">/// override timestamp checks and execute</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">268</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<p>This as the comment suggest should only be done in emergencies.</p>\n<p>However there is nothing indicating that the <code>VAA</code> in question is supposed to be fast tracked. Hence a <code>guardian</code> can always fast track any <code>VAA</code>s that they please, bypassing the <code>queueProposal</code> functionality.</p>\n<h3 id=\"recommendation\" style=\"position:relative;\"><a href=\"#recommendation\" aria-label=\"recommendation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Consider adding another parameter to the <code>payload</code> indicating if the <code>VAA</code> is intended to be fast tracked or not.</p>\n<h2 id=\"l-02-temporalgovernor-can-get-the-same-address-on-different-chains\" style=\"position:relative;\"><a href=\"#l-02-temporalgovernor-can-get-the-same-address-on-different-chains\" aria-label=\"l 02 temporalgovernor can get the same address on different chains permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-02] <code>TemporalGovernor</code> can get the same address on different chains</h2>\n<p>In <code>mip00.sol</code> the deploy and configuration proceedure for the <code>TemporalGovernor</code> is detailed:</p>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/test/proposals/mips/mip00.sol#L103-L109\">https://github.com/code-423n4/2023-07-moonwell/blob/main/test/proposals/mips/mip00.sol#L103-L109</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">test</span><span class=\"mtk1\">/</span><span class=\"mtk12\">proposals</span><span class=\"mtk1\">/</span><span class=\"mtk12\">mips</span><span class=\"mtk1\">/</span><span class=\"mtk12\">mip00</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">103</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">/// this will be the governor for all the contracts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">104</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">TemporalGovernor</span><span class=\"mtk1\"> </span><span class=\"mtk12\">governor</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">TemporalGovernor</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">105</span><span class=\"mtk1\">:                </span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;WORMHOLE_CORE&quot;</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">106</span><span class=\"mtk1\">:                </span><span class=\"mtk12\">proposalDelay</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">107</span><span class=\"mtk1\">:                </span><span class=\"mtk12\">permissionlessUnpauseTime</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">108</span><span class=\"mtk1\">:                </span><span class=\"mtk12\">trustedSenders</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">109</span><span class=\"mtk1\">:            );</span></span></span></code></pre>\n<p><code>new</code> will invoke the <code>CREATE</code> opcode. This only relies on the <code>msg.sender</code> and <code>nonce</code>. Since the <code>deploy</code> call executes a certain amount of calls when it executes the deploy of <code>TemporalGovernor</code> it will have certain <code>nonce</code>. Hence the address of <code>TemporalGovernor</code> will be dependent on the account that executes it. If this is run by a new account the address of <code>TemporalGovernor</code> can be the same if it is executed by the same new account on another chain.</p>\n<p>This is important because if two <code>TemporalGovernor</code> contracts on different chains gets the same address they can execute each others proposals:</p>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L320-L322\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L320-L322</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Governance</span><span class=\"mtk1\">/</span><span class=\"mtk12\">TemporalGovernor</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">320</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// Very important to check to make sure that the VAA we&#39;re processing is specifically designed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">321</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// to be sent to this contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">322</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">intendedRecipient</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;TemporalGovernor: Incorrect destination&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h3 id=\"recommendation-1\" style=\"position:relative;\"><a href=\"#recommendation-1\" aria-label=\"recommendation 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Pay attention to which accounts and how the execution of the deploy script is done. Perhaps use <code>CREATE2</code> with a random <code>salt</code> to deploy <code>TemporalGovernor</code> to guarantee it gets a different address on each chain.</p>\n<h2 id=\"l-03-temporalgovernorgrantguardianspause-can-be-called-after-guardian-is-revoked\" style=\"position:relative;\"><a href=\"#l-03-temporalgovernorgrantguardianspause-can-be-called-after-guardian-is-revoked\" aria-label=\"l 03 temporalgovernorgrantguardianspause can be called after guardian is revoked permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-03] <code>TemporalGovernor::grantGuardiansPause</code> can be called after <code>guardian</code> is revoked</h2>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L187-L198\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L187-L198</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">Governance</span><span class=\"mtk1\">/</span><span class=\"mtk12\">TemporalGovernor</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">187</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">/// @notice grant the guardians the pause ability</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">188</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">grantGuardiansPause</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">189</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">190</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">191</span><span class=\"mtk1\">:            </span><span class=\"mtk8\">&quot;TemporalGovernor: Only this contract can update grant guardian pause&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">192</span><span class=\"mtk1\">:        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">193</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">194</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">guardianPauseAllowed</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">195</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">lastPauseTime</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">196</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">197</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">GuardianPauseGranted</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">198</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<p>This doesn’t do any thing bad other than set <code>guardianPauseAllowed=true</code>, which is set to false in <a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L213\"><code>revokeGuardian</code></a>.</p>\n<h3 id=\"recommendation-2\" style=\"position:relative;\"><a href=\"#recommendation-2\" aria-label=\"recommendation 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Consider only allowing calls to <code>grantGuardiansPause</code> when <code>guardian != address(0)</code>.</p>\n<h2 id=\"l-04-no-cap-on-how-many-emissionconfigs-there-can-be-for-a-market\" style=\"position:relative;\"><a href=\"#l-04-no-cap-on-how-many-emissionconfigs-there-can-be-for-a-market\" aria-label=\"l 04 no cap on how many emissionconfigs there can be for a market permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-04] No cap on how many <code>emissionConfig</code>s there can be for a market</h2>\n<p>Too many <code>emissionConfig</code>s could lead to out of gas errors when updating reward indexes. Since every operation on an <code>mToken</code> triggers this the whole market would be DoSed if too many <code>emissionConfig</code>s would be added.</p>\n<h3 id=\"recommendation-3\" style=\"position:relative;\"><a href=\"#recommendation-3\" aria-label=\"recommendation 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Consider adding a way to remove an <code>emissionConfig</code></p>\n<h2 id=\"l-05-neither-_setmarketborrowcaps-or-_setmarketsupplycaps-checks-if-market-is-listed\" style=\"position:relative;\"><a href=\"#l-05-neither-_setmarketborrowcaps-or-_setmarketsupplycaps-checks-if-market-is-listed\" aria-label=\"l 05 neither _setmarketborrowcaps or _setmarketsupplycaps checks if market is listed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-05] Neither <code>_setMarketBorrowCaps</code> or <code>_setMarketSupplyCaps</code> checks if market is listed</h2>\n<p>When adding a cap on borrow/supply <code>admin</code> or <code>borrow/supplyCapGuardian</code> can call [<code>_setMarketBorrowCaps</code>])(<a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Comptroller.sol#L807-L819\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Comptroller.sol#L807-L819</a>) or <a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Comptroller.sol#L844-L856\"><code>_setMarketSupplyCaps</code></a> respectively.</p>\n<p>However in none of the there is any check that the market (<code>MToken</code>) for which they add the supply/borrow cap is actually listed. Hence <code>admin</code> or <code>guardian</code> could by mistake send the wrong address and then think that they configured the cap for that market when they didn’t.</p>\n<h3 id=\"recommendation-4\" style=\"position:relative;\"><a href=\"#recommendation-4\" aria-label=\"recommendation 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Add a check that the <code>MToken</code> is listed when setting borrow/supply caps.</p>\n<h2 id=\"l-06-lack-of-tests-for-supplycap\" style=\"position:relative;\"><a href=\"#l-06-lack-of-tests-for-supplycap\" aria-label=\"l 06 lack of tests for supplycap permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-06] Lack of tests for <code>supplyCap</code></h2>\n<p>M̀oonwell introduces a new feature to the <code>Comptroller</code>: <code>supplyCap</code> per market. This limits how much can be minted to that market. There is however no tests for this new feature. Test guarantee that the feature works as expected and will continue to work as expected when doing changes to the code. As such they are a core guarantee for code and protocol safety.</p>\n<p>Consider adding a few tests for the <code>supplyCap</code> feature</p>\n<h2 id=\"suggestions-1\" style=\"position:relative;\"><a href=\"#suggestions-1\" aria-label=\"suggestions 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Suggestions (1)</h2>\n<h2 id=\"s-01-chainlinkcompositeoraclegetderivedpricethreeoracles-is-very-specialized\" style=\"position:relative;\"><a href=\"#s-01-chainlinkcompositeoraclegetderivedpricethreeoracles-is-very-specialized\" aria-label=\"s 01 chainlinkcompositeoraclegetderivedpricethreeoracles is very specialized permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[S-01] <code>ChainlinkCompositeOracle::getDerivedPriceThreeOracles</code> is very specialized</h2>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Oracles/ChainlinkCompositeOracle.sol#L157-L159\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Oracles/ChainlinkCompositeOracle.sol#L157-L159</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">Oracles</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ChainlinkCompositeOracle</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">157</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">return</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">158</span><span class=\"mtk1\">:            ((</span><span class=\"mtk12\">firstPrice</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">secondPrice</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">thirdPrice</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">scalingFactor</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">159</span><span class=\"mtk1\">:                .</span><span class=\"mtk11\">toUint256</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p>Here the three prices for the oracles are multiplied together. This requires a setup of prices like this:\nFirst one is stated to be <code>ETH</code>/<code>USD</code></p>\n<p>so there would have to be oracles:</p>\n<p><code>ETH</code>/<code>USD</code>, <code>A</code>/<code>ETH</code>, <code>B</code>/<code>A</code> to get the price <code>B</code>/<code>USD</code></p>\n<p>This is very limited which chainlink prices support “chaining” like this, the one used in integration test seems to one of the few:</p>\n<p><code>ETH</code>/<code>USD</code>, <code>stETH</code>/<code>ETH</code>, <code>wstETH</code>/<code>stETH</code> on Arbitrum.</p>\n<h3 id=\"recommendations\" style=\"position:relative;\"><a href=\"#recommendations\" aria-label=\"recommendations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendations</h3>\n<p>Consider adding the ability to either multiply or divide by the last one, as that would give greater flexibility in which feeds can be used.</p>\n<h2 id=\"refactoring-4\" style=\"position:relative;\"><a href=\"#refactoring-4\" aria-label=\"refactoring 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Refactoring (4)</h2>\n<h2 id=\"r-01-multirewarddistributorcalculatenewindex-parameter-_currenttimestamp-is-confusing\" style=\"position:relative;\"><a href=\"#r-01-multirewarddistributorcalculatenewindex-parameter-_currenttimestamp-is-confusing\" aria-label=\"r 01 multirewarddistributorcalculatenewindex parameter _currenttimestamp is confusing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[R-01] <code>MultiRewardDistributor::calculateNewIndex</code> parameter <code>_currentTimestamp</code> is confusing</h2>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MultiRewardDistributor/MultiRewardDistributor.sol#L906\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MultiRewardDistributor/MultiRewardDistributor.sol#L906</a></p>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MultiRewardDistributor/MultiRewardDistributor.sol#L914\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MultiRewardDistributor/MultiRewardDistributor.sol#L914</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">MultiRewardDistributor</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MultiRewardDistributor</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">906</span><span class=\"mtk1\">:     * @</span><span class=\"mtk12\">param</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_currentTimestamp</span><span class=\"mtk1\"> </span><span class=\"mtk12\">The</span><span class=\"mtk1\"> </span><span class=\"mtk12\">current</span><span class=\"mtk1\"> </span><span class=\"mtk12\">index</span><span class=\"mtk1\"> </span><span class=\"mtk12\">timestamp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">914</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_currentTimestamp</span><span class=\"mtk1\">,</span></span></span></code></pre>\n<p><code>_currentTimestamp</code> implies <em>now</em> when it is however the last index timestamp. Consider renaming it to <code>lastIndexTimestamp</code>.</p>\n<h2 id=\"r-02-unnecessary-_amount-0-check\" style=\"position:relative;\"><a href=\"#r-02-unnecessary-_amount-0-check\" aria-label=\"r 02 unnecessary _amount 0 check permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[R-02] Unnecessary <code>_amount> 0</code> check</h2>\n<p>In <code>sendReward</code>, the function sort circuit if <code>_amount</code> to be sent is <code>0</code>, later however it is checked that this <code>amount</code> is <code>>0</code> which there is no way it cannot be:</p>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MultiRewardDistributor/MultiRewardDistributor.sol#L1219-L1222\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MultiRewardDistributor/MultiRewardDistributor.sol#L1219-L1222</a></p>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MultiRewardDistributor/MultiRewardDistributor.sol#L1235\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MultiRewardDistributor/MultiRewardDistributor.sol#L1235</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">MultiRewardDistributor</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MultiRewardDistributor</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1219</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// Short circuit if we don&#39;t have anything to send out</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1220</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1221</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1222</span><span class=\"mtk1\">:        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t </span><span class=\"mtk3\">// @audit due to check above there is no way _amount cannot be &gt;0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1235</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">currentTokenHoldings</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<p>Consider removing the <code>_amount > 0</code> check since it is always true.</p>\n<h2 id=\"r-03-multirewarddistributor-indexupdate-struct-is-unnecessary\" style=\"position:relative;\"><a href=\"#r-03-multirewarddistributor-indexupdate-struct-is-unnecessary\" aria-label=\"r 03 multirewarddistributor indexupdate struct is unnecessary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[R-03] <code>MultiRewardDistributor</code>: <code>IndexUpdate</code> struct is unnecessary</h2>\n<p><code>IndexUpdate</code> is used to return the result of <code>calculateNewIndex</code>.</p>\n<p>However in <code>calculateNewIndex</code> the same value for <code>IndexUpdate.newTimestamp</code> is always used, <code>block.timestamp</code>:</p>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MultiRewardDistributor/MultiRewardDistributor.sol#L949-L953\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MultiRewardDistributor/MultiRewardDistributor.sol#L949-L953</a></p>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MultiRewardDistributor/MultiRewardDistributor.sol#L967\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MultiRewardDistributor/MultiRewardDistributor.sol#L967</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">949</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">return</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">950</span><span class=\"mtk1\">:                </span><span class=\"mtk11\">IndexUpdate</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">951</span><span class=\"mtk12\">:</span><span class=\"mtk1\">                    </span><span class=\"mtk12\">newIndex</span><span class=\"mtk1\">: </span><span class=\"mtk12\">_currentIndex</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">952</span><span class=\"mtk12\">:</span><span class=\"mtk1\">                    </span><span class=\"mtk12\">newTimestamp</span><span class=\"mtk1\">: </span><span class=\"mtk12\">blockTimestamp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">953</span><span class=\"mtk1\">:                });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">967</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">IndexUpdate</span><span class=\"mtk1\">({</span><span class=\"mtk12\">newIndex:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newIndex</span><span class=\"mtk1\">, </span><span class=\"mtk12\">newTimestamp:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">blockTimestamp</span><span class=\"mtk1\">});</span></span></span></code></pre>\n<p>Hence, <code>calculateNewIndex</code> could simply return <code>newIndex</code> (<code>uin224</code>). Then in <code>updateMarketSupplyIndexInternal</code> and <code>updateMarketBorrowIndexInternal</code> the <code>supply/borrowGlobalTimestamp</code> can be set directly to <code>block.timestamp</code>.</p>\n<h2 id=\"r-04-parameter-_mtokendata-for-multirewarddistributorcalculateborrowrewardsforuser-is-unnecessary\" style=\"position:relative;\"><a href=\"#r-04-parameter-_mtokendata-for-multirewarddistributorcalculateborrowrewardsforuser-is-unnecessary\" aria-label=\"r 04 parameter _mtokendata for multirewarddistributorcalculateborrowrewardsforuser is unnecessary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[R-04] Parameter <code>_mTokenData</code> for <code>MultiRewardDistributor::calculateBorrowRewardsForUser</code> is unnecessary</h2>\n<p>The struct <code>MTokenData</code> has two fields: <a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MultiRewardDistributor/MultiRewardDistributorCommon.sol#L50-L53\"><code>mTokenBalance</code> and <code>borrowBalanceStored</code></a>. However only <a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MultiRewardDistributor/MultiRewardDistributor.sol#L887\">one of them is used</a> in <code>calculateBorrowRewardsForUser</code>.</p>\n<p>Therefore it is confusing that the whole struct is passed to the function as that implies that both fields would be used.</p>\n<p>Consider just passing <code>borrowBalanceStored</code> directly instead of the struct.</p>\n<h2 id=\"non-critical-6\" style=\"position:relative;\"><a href=\"#non-critical-6\" aria-label=\"non critical 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Non-critical (6)</h2>\n<h2 id=\"n-01-wrong-grammatical-number-in-grantguardianspause\" style=\"position:relative;\"><a href=\"#n-01-wrong-grammatical-number-in-grantguardianspause\" aria-label=\"n 01 wrong grammatical number in grantguardianspause permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-01] Wrong grammatical number in <code>grantGuardiansPause</code></h2>\n<p><code>grantGuardiansPause</code> grants <code>guardian</code> pause. Since there is only one <code>guardian</code> the name should be singular not plural: <strong><code>grantGuardianPause</code></strong>.</p>\n<h2 id=\"n-02-erroneous-docs\" style=\"position:relative;\"><a href=\"#n-02-erroneous-docs\" aria-label=\"n 02 erroneous docs permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-02] Erroneous docs</h2>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/docs/TEMPORALGOVERNOR.md\">https://github.com/code-423n4/2023-07-moonwell/blob/main/docs/TEMPORALGOVERNOR.md</a></p>\n<blockquote>\n<p>Guardian Pause: The guardian has the ability to pause the contract temporarily. When the guardian pauses the contract, all proposal executions are halted. The contract can only be unpaused by a governance proposal after a specified time delay.</p>\n</blockquote>\n<p>This is not true. A governance proposal cannot unpause the <code>TemporalGovernor</code>. Unpause can only be performed by <code>governor</code> through <a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L274-L290\"><code>togglePause</code></a> or by the <a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L242-L259\"><code>permissionlessUnpause</code></a> after a delay. The only way governance could unpause is by calling <a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Governance/TemporalGovernor.sol#L205-L221\"><code>revokeGuardian</code></a> which is final. This would require the <code>guardian</code> to execute it though since only <code>guardian</code> is allowed to execute commands while the contract is paused.</p>\n<h2 id=\"n-03-weird-word-describing-the-future\" style=\"position:relative;\"><a href=\"#n-03-weird-word-describing-the-future\" aria-label=\"n 03 weird word describing the future permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-03] Weird word describing the future</h2>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MultiRewardDistributor/MultiRewardDistributor.sol#L788-L792\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MultiRewardDistributor/MultiRewardDistributor.sol#L788-L792</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">MultiRewardDistributor</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MultiRewardDistributor</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">788</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// Must be older than our existing end time AND the current block</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">789</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">790</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">_newEndTime</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">currentEndTime</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">791</span><span class=\"mtk1\">:            </span><span class=\"mtk8\">&quot;_newEndTime MUST be &gt; currentEndTime&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">792</span><span class=\"mtk1\">:        );</span></span></span></code></pre>\n<p><code>older</code> here is confusing. Either say <code>Must be further in the future</code> or simply <code>larger</code></p>\n<h2 id=\"n-04-forgotten-ctoken-references\" style=\"position:relative;\"><a href=\"#n-04-forgotten-ctoken-references\" aria-label=\"n 04 forgotten ctoken references permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-04] Forgotten <code>cToken</code> references</h2>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MultiRewardDistributor/MultiRewardDistributor.sol#L842\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MultiRewardDistributor/MultiRewardDistributor.sol#L842</a></p>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MultiRewardDistributor/MultiRewardDistributor.sol#L847\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MultiRewardDistributor/MultiRewardDistributor.sol#L847</a></p>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MultiRewardDistributor/MultiRewardDistributor.sol#L881\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MultiRewardDistributor/MultiRewardDistributor.sol#L881</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"48\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">MultiRewardDistributor</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MultiRewardDistributor</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">842</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// Calculate change in the cumulative sum of the reward per cToken accrued</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">843</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// Calculate reward accrued: cTokenAmount * accruedPerCToken</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">844</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// Calculate change in the cumulative sum of the reward per cToken accrued</span></span></span></code></pre>\n<h2 id=\"n-05-incorrect-comments\" style=\"position:relative;\"><a href=\"#n-05-incorrect-comments\" aria-label=\"n 05 incorrect comments permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-05] Incorrect comments</h2>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MultiRewardDistributor/MultiRewardDistributor.sol#L835-L840\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MultiRewardDistributor/MultiRewardDistributor.sol#L835-L840</a></p>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MultiRewardDistributor/MultiRewardDistributor.sol#L874-L879\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/MultiRewardDistributor/MultiRewardDistributor.sol#L874-L879</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"49\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">MultiRewardDistributor</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MultiRewardDistributor</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">835</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// If our user&#39;s index isn&#39;t set yet, set to the current global supply index</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">836</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">837</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">userSupplyIndex</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_globalSupplyIndex</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">initialIndexConstant</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">838</span><span class=\"mtk1\">:        ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">839</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">userSupplyIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">initialIndexConstant</span><span class=\"mtk1\">; </span><span class=\"mtk3\">//_globalSupplyIndex;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">840</span><span class=\"mtk1\">:        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">874</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// If our user&#39;s index isn&#39;t set yet, set to the current global borrow index</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">875</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">876</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">userBorrowIndex</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_globalBorrowIndex</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">initialIndexConstant</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">877</span><span class=\"mtk1\">:        ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">878</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">userBorrowIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">initialIndexConstant</span><span class=\"mtk1\">; </span><span class=\"mtk3\">//userBorrowIndex = _globalBorrowIndex;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">879</span><span class=\"mtk1\">:        }</span></span></span></code></pre>\n<p>If the index is not yet set it’s set to <code>initialIndexConstant</code> not the global index as the comment suggests.</p>\n<h2 id=\"n-06-comment-slash-off-by-one\" style=\"position:relative;\"><a href=\"#n-06-comment-slash-off-by-one\" aria-label=\"n 06 comment slash off by one permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-06] Comment slash off by one</h2>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Comptroller.sol#L984-L988\">https://github.com/code-423n4/2023-07-moonwell/blob/main/src/core/Comptroller.sol#L984-L988</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"50\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk3\">/** &lt;-- slash only 3 whitespaces in</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     * </span><span class=\"mtk4\">@notice</span><span class=\"mtk3\"> Call out to the reward distributor to update its borrow index and this user&#39;s index too</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     * </span><span class=\"mtk4\">@param</span><span class=\"mtk3\"> </span><span class=\"mtk12\">mToken</span><span class=\"mtk3\"> The market to synchronize indexes for</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     * </span><span class=\"mtk4\">@param</span><span class=\"mtk3\"> </span><span class=\"mtk12\">borrower</span><span class=\"mtk3\"> The borrower to whom rewards are going</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     */</span></span></span></code></pre>\n<p>The slash is only 3 not 4 whitespaces in.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/328#issuecomment-1664463166\">ElliotFriedman (Moonwell) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>L-01- correct that guardian can fast track, however this is intended behavior.<br>\nL-02- correct, however this system is only going to be deployed on a single chain.<br>\nL-03- correct, however this doesn’t matter as the guardian would not be able to pause or unpause because address 0 is the guardian, so that doesn’t work.<br>\nL-04- duplicate finding, this is true, however this is expected behavior.<br>\nL-05- true, but there isn’t any negative effect to this happening as an unlisted token in the comptroller cannot be minted or borrowed.</p>\n</blockquote>\n<hr>\n<h1 id=\"audit-analysis\" style=\"position:relative;\"><a href=\"#audit-analysis\" aria-label=\"audit analysis permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Audit Analysis</h1>\n<p>For this audit, 12 analysis reports were submitted by wardens. An analysis report examines the codebase as a whole, providing observations and advice on such topics as architecture, mechanism, or approach. The <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/313\">report highlighted below</a> by <strong>Sathish9098</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/362\">hals</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/359\">kutugu</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/330\">jaraxxus</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/300\">berlin-101</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/298\">cryptonue</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/73\">catellatech</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/402\">Udsen</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/297\">kodyvim</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/181\">solsaver</a>, <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/152\">0xSmartContract</a>, and <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/38\">K42</a>.</em></p>\n<h2 id=\"summary-1\" style=\"position:relative;\"><a href=\"#summary-1\" aria-label=\"summary 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h2>\n<table>\n<thead>\n<tr>\n<th align=\"left\">List</th>\n<th align=\"left\">Head</th>\n<th align=\"left\">Details</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"left\">1</td>\n<td align=\"left\">Overview of Moonwell Protocol</td>\n<td align=\"left\">overview of the key components and features of Moonwell</td>\n</tr>\n<tr>\n<td align=\"left\">2</td>\n<td align=\"left\">My Thoughts</td>\n<td align=\"left\">My own thoughts about future of the this protocol</td>\n</tr>\n<tr>\n<td align=\"left\">3</td>\n<td align=\"left\">Audit approach</td>\n<td align=\"left\">Process and steps i followed</td>\n</tr>\n<tr>\n<td align=\"left\">4</td>\n<td align=\"left\">Learnings</td>\n<td align=\"left\">Learnings from this protocol</td>\n</tr>\n<tr>\n<td align=\"left\">5</td>\n<td align=\"left\">Possible Systemic Risks</td>\n<td align=\"left\">The possible systemic risks based on my analysis</td>\n</tr>\n<tr>\n<td align=\"left\">6</td>\n<td align=\"left\">Code Commentary</td>\n<td align=\"left\">Suggestions for existing code base</td>\n</tr>\n<tr>\n<td align=\"left\">7</td>\n<td align=\"left\">Centralization risks</td>\n<td align=\"left\">Concerns associated with centralized systems</td>\n</tr>\n<tr>\n<td align=\"left\">8</td>\n<td align=\"left\">Gas Optimizations</td>\n<td align=\"left\">Details about my gas optimizations findings and gas savings</td>\n</tr>\n<tr>\n<td align=\"left\">9</td>\n<td align=\"left\">Risks as per Analysis</td>\n<td align=\"left\">Possible risks</td>\n</tr>\n<tr>\n<td align=\"left\">10</td>\n<td align=\"left\">Non-functional aspects</td>\n<td align=\"left\">General suggestions</td>\n</tr>\n<tr>\n<td align=\"left\">11</td>\n<td align=\"left\">Time spent on analysis</td>\n<td align=\"left\">The Over all time spend for this reports</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"overview-1\" style=\"position:relative;\"><a href=\"#overview-1\" aria-label=\"overview 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h2>\n<p><code>Moonwell Protocol</code> is a fork of <code>Compound v2</code> with features.</p>\n<p>Moonwell is an open lending and borrowing protocol built on <code>Base</code>, <code>Moonbeam</code>, and <code>Moonriver</code>.The protocol’s intuitive design ensures a seamless user experience, enabling users to easily navigate through various features and perform operations effortlessly.</p>\n<h3 id=\"important-contracts\" style=\"position:relative;\"><a href=\"#important-contracts\" aria-label=\"important contracts permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Important Contracts:</h3>\n<ul>\n<li>\n<p><code>ChainlinkCompositeOracle</code></p>\n<ul>\n<li>which aggregates mulitple exchange rates together</li>\n</ul>\n</li>\n<li>\n<p><code>MultiRewardDistributor</code></p>\n<ul>\n<li>Allow distributing and rewarding users with multiple tokens per MToken. Parts of this system that require special attention are what happens when hooks fail in the Comptroller</li>\n</ul>\n</li>\n<li>\n<p><code>Comptroller</code></p>\n<ul>\n<li>This contract is based on the Flywheel logic</li>\n</ul>\n</li>\n<li>\n<p><code>TemporalGovernor</code></p>\n<ul>\n<li>which is the cross chain governance contract. Specific areas of concern include delays, the pause guardian, putting the contract into a state where it cannot be updated</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"special-features-of-moonwell-protocol\" style=\"position:relative;\"><a href=\"#special-features-of-moonwell-protocol\" aria-label=\"special features of moonwell protocol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Special features of Moonwell Protocol</h3>\n<ul>\n<li>Non-Custodial</li>\n<li>User Experience</li>\n<li>Security </li>\n<li>Transparency</li>\n<li>Onchain Governance</li>\n</ul>\n<h3 id=\"my-thoughts\" style=\"position:relative;\"><a href=\"#my-thoughts\" aria-label=\"my thoughts permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>My Thoughts</h3>\n<p>Moonwell Protocol may changes <code>Lending and Borrowing</code> to next level.</p>\n<p>Moonwell’s approach to lending and borrowing in DeFi can be a catalyst for positive changes in the ecosystem. By setting a standard for user experience, security, transparency, and governance, it may inspire other projects to improve and innovate, leading to a more mature, inclusive, and trustworthy DeFi lending and borrowing landscape in the future.</p>\n<p>Decentralization and Governance: Moonwell’s onchain governance model can pave the way for more decentralized decision-making processes in other DeFi projects. As protocols adopt similar governance mechanisms, the community’s voice and participation may play a more significant role in shaping the future of DeFi platforms.</p>\n<p>Trust and Transparency: The emphasis on transparency in Moonwell’s onchain operations can foster trust among users. As other protocols adopt similar transparency practices, users may feel more confident in interacting with DeFi platforms, leading to increased trust within the ecosystem.</p>\n<p>Non-Custodial Solutions: Moonwell’s non-custodial approach to lending and borrowing may become a trend in the DeFi space. More protocols might adopt non-custodial models to allow users to retain control over their assets, aligning with the core principles of DeFi.</p>\n<p>Global Reach: Moonwell’s focus on accessibility and usability may lead to increased global adoption of DeFi lending and borrowing. As the protocol reaches users in different regions, DeFi’s impact could become more widespread and inclusive.</p>\n<h2 id=\"audit-approach\" style=\"position:relative;\"><a href=\"#audit-approach\" aria-label=\"audit approach permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Audit approach</h2>\n<p>I followed below steps while analyzing and auditing the code base.</p>\n<ol>\n<li>Read the Audit Readme.md and took the required notes.</li>\n<li>Moonwell Protocol protocol uses </li>\n<li>inheritance</li>\n<li>Tests only covered 80%</li>\n<li>Multi-Chain</li>\n<li>ERC-20 Token</li>\n<li>Timelock function</li>\n<li>Need to understand moonbeam and temporal governance to understand the governance system </li>\n<li>Uses Chainlink price oracle </li>\n<li>This protocol if fork of Compound with MRD</li>\n<li>Analyzed the over all codebase one iterations very fast</li>\n<li>Study of documentation to understand each contract purposes, its functionality, how it is connected with other contracts, etc.</li>\n<li>Then I read old audits and already known findings. Then go through the bot races findings </li>\n<li>Then setup my testing environment things. Run the tests to checks all test passed. I used foundry to test moonwell protocol. I used forge comments for testing </li>\n<li>Finally, I started with the auditing the code base in depth way I started understanding line by line code and took the necessary notes to ask some questions to sponsors.</li>\n</ol>\n<h2 id=\"stages-of-audit\" style=\"position:relative;\"><a href=\"#stages-of-audit\" aria-label=\"stages of audit permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Stages of audit</h2>\n<ul>\n<li><code>The first stage of the audit</code></li>\n</ul>\n<p>During the initial stage of the audit for Moonwell Protocol, the primary focus was on analyzing gas usage and quality assurance (QA) aspects. This phase of the audit aimed to ensure the efficiency of gas consumption and verify the robustness of the platform.</p>\n<p>Found <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/115\">14 QA Findings</a></p>\n<ul>\n<li><code>The second stage of the audit</code></li>\n</ul>\n<p>In the second stage of the audit for Moonwell Protocol, the focus shifted towards understanding the protocol usage in more detail. This involved identifying and analyzing the important contracts and functions within the system. By examining these key components, the audit aimed to gain a comprehensive understanding of the protocol’s functionality and potential risks. </p>\n<ul>\n<li><code>The third stage of the audit</code></li>\n</ul>\n<p>During the third stage of the audit for Moonwell Protocol, the focus was on thoroughly examining and marking any doubtful or vulnerable areas within the protocol. This stage involved conducting comprehensive vulnerability assessments and identifying potential weaknesses in the system. Found <code>60-70</code> <code>vulnerable</code> and <code>weakness</code> code parts all marked with <code>@audit tags</code>.</p>\n<ul>\n<li><code>The fourth stage of the audit</code></li>\n</ul>\n<p>During the fourth stage of the audit for Moonwell Protocol, a comprehensive analysis and testing of the previously identified doubtful and vulnerable areas were conducted. This stage involved diving deeper into these areas, performing in-depth examinations, and subjecting them to rigorous testing, including fuzzing with various inputs. Finally concluded findings after all research’s and tests. Then i reported C4 with proper formats </p>\n<p>Found one medium risk findings <a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/119\"><code>admin</code> may receive less token than expected because of this check  <code>_amount == type(uint256).max</code></a></p>\n<h2 id=\"learnings\" style=\"position:relative;\"><a href=\"#learnings\" aria-label=\"learnings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Learnings</h2>\n<p> The Moonwell Protocol team can draw lessons from other DeFi protocols that have faced similar challenges. Studying security incidents, best practices, and successful governance mechanisms from other projects can provide valuable insights for building a more robust and resilient platform.</p>\n<p>By prioritizing security, conducting thorough risk assessments, and actively involving the community in governance decisions, the Moonwell Protocol can proactively address these areas of concern and strengthen its position as a secure and community-driven DeFi lending and borrowing platform</p>\n<h2 id=\"possible-systemic-risks\" style=\"position:relative;\"><a href=\"#possible-systemic-risks\" aria-label=\"possible systemic risks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Possible Systemic Risks</h2>\n<ul>\n<li><code>Smart Contract Vulnerabilities</code>: The use of inheritance and integration of multiple features can introduce potential smart contract vulnerabilities. Bugs, logic flaws, or improper implementations could lead to exploits and financial losses.</li>\n<li><code>Test Coverage Risks</code>:  With only 80% test coverage, the protocol may have undiscovered vulnerabilities. Inadequate security audits could leave critical issues unnoticed, increasing the risk of attacks</li>\n<li><code>Governance Challenges</code>: Understanding Moonbeam and Temporal Governance systems may be complex for some users, potentially leading to governance inefficiencies or suboptimal decision-making.</li>\n<li><code>Chainlink Oracle Risks</code>: Relying on a single oracle provider, like Chainlink, exposes the protocol to potential risks associated with oracle failures, data manipulation, or centralization issues.</li>\n<li><code>Protocol Fork Risks</code>: Forking from other protocols may inherit vulnerabilities present in the original codebase. Failure to address these risks could result in potential attacks.</li>\n<li><code>Liquidity and Market Risks</code>: Insufficient liquidity or market manipulation risks can affect the protocol’s stability and overall performance.</li>\n</ul>\n<h2 id=\"code-commentary\" style=\"position:relative;\"><a href=\"#code-commentary\" aria-label=\"code commentary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Code Commentary</h2>\n<ul>\n<li>Use consistant <code>SPDX-License</code> for all contracts </li>\n<li>Inconsistance <code>solidity versions</code> used </li>\n<li>Ensure that variable and function names follow <code>consistent naming conventions</code> for better <code>readability</code> and <code>maintainability</code>. For example, use camelCase or snake_case consistently throughout the contract</li>\n<li>In the <code>Status</code> and <code>DistributionStatus</code> structs, consider using an <code>enum type</code> for stage to improve readability and avoid potential bugs caused by using numbers directly</li>\n<li>Some functions like <code>updateMarketSupplyIndexAndDisburseSupplierRewards</code> and <code>updateMarketBorrowIndexAndDisburseBorrowerRewards</code> are similar. You can <code>consolidate them into a single function</code> that takes an additional parameter to specify the action (supplier rewards or borrower rewards)</li>\n<li>Instead of importing the <code>whole</code> contract code for <code>IERC20</code> and <code>MToken</code>, use interfaces to define only the <code>required functions</code>. This reduces the gas cost and enhances code readability</li>\n<li>Add    inline comments    to explain complex logic, especially in mathematical calculations, to make the code more understandable</li>\n<li>Add appropriate    error messages     in require statements to provide more <code>informative feedback</code> to users when a transaction fails</li>\n<li>In some functions like <code>exitMarket</code>, multiple emit statements are used for the <code>same event</code>. <code>Consolidate</code> the event emissions to a <code>single location</code> to reduce <code>code duplication</code> and improve <code>readability</code>.</li>\n<li>It’s a good practice to add more detailed information in the <code>event logs</code>, such as the account addresses involved in certain actions.</li>\n<li>Some functions return error codes <code>(e.g., uint(Error.NO_ERROR))</code>, but the exact meaning of these <code>error codes</code> is not explicitly defined. Proper error code documentation or the use of error enums would enhance <code>clarity</code> and <code>usability</code>.</li>\n<li>In the <code>addressToBytes</code> function, you can use <code>bytes20(addr)</code> directly instead of <code>casting</code> it as a <code>bytes20</code>. It will not have any impact on gas costs, but it <code>simplifies the code</code></li>\n<li>In the <code>setTrustedSenders</code> and <code>unSetTrustedSenders</code> functions, avoid encoding and decoding the same data by directly using the addr parameter as the key for the mapping</li>\n<li><code>Emit</code> events for significant <code>contract state changes</code>, as it helps in tracking contract activities and provides transparency to external applications</li>\n<li>Consider <code>refactoring</code> the code to break down <code>complex functions</code> into smaller, more manageable pieces, following the principles of <code>modularity</code></li>\n<li>Instead of using separate bool variables like <code>guardianPauseAllowed</code>, you can use an enum to represent different contract states, such as<code>enum ContractState</code> <code>{ Active, Paused, GuardianRevoked }</code>. This can help make the contract state more explicit and easier to understand</li>\n</ul>\n<h2 id=\"centralization-risks\" style=\"position:relative;\"><a href=\"#centralization-risks\" aria-label=\"centralization risks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Centralization risks</h2>\n<p>A single point of failure is not acceptable for this project Centrality risk is high in the project, the role of <code>onlyOwner</code>detailed below has very critical and important powers</p>\n<p>Project and funds may be compromised by a malicious or stolen private key <code>onlyOwner</code> <code>msg.sender</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"51\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Governance</span><span class=\"mtk1\">/</span><span class=\"mtk12\">TemporalGovernor</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">266</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">fastTrackProposalExecution</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">VAA</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">274</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">togglePause</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-07-moonwell/blob/4aaa7d6767da3bc42e31c18ea2e75736a4ea53d4/src/core/Governance/TemporalGovernor.sol#L266-L266\">https://github.com/code-423n4/2023-07-moonwell/blob/4aaa7d6767da3bc42e31c18ea2e75736a4ea53d4/src/core/Governance/TemporalGovernor.sol#L266-L266</a></p>\n<h2 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h2>\n<ol>\n<li>Using <code>token.balanceOf(address(this))</code> every time can potentially reduce the contract’s performance. Frequent external calls to other contracts, such as reading the balance of the token contract, can be expensive in terms of gas costs and execution time. This can lead to higher transaction costs and slower contract execution</li>\n<li>Explicitly <code>initializing default values</code> for variables consumes <code>additional ga</code>s during contract deployment. If you rely on the EVM’s automatic default initialization, you can save gas costs associated with these unnecessary operations</li>\n<li><code>Minimize the number of state variable reads and writes</code>. Use <code>local variables</code> when possible to avoid additional storage operations</li>\n<li><code>Limit</code> the number of iterations in <code>loops</code> to prevent <code>excessive gas consumption</code>. Consider using other patterns like <code>mapping</code>, where possible, to reduce the need for loops</li>\n<li>Whenever applicable, consider <code>batching multiple operations</code> together to save on gas costs. For example, you can combine multiple token transfers into a single function call</li>\n<li>Remove any <code>unused or commented-out code</code> to save space and simplify contract logic</li>\n<li>Check if <code>modifiers</code> can be <code>combined</code> or <code>reused across multiple functions</code> to reduce the number of modifier calls. This can save gas by avoiding redundant checks.</li>\n<li>The <code>enterMarkets</code> function currently loops through the list of <code>mTokens</code> and <code>emits an event</code> for each entry. Consider <code>batching</code> the <code>events</code> or using other gas-saving techniques to reduce transaction costs</li>\n<li>In the <code>addToMarketInternal</code> function, you can optimize the code by storing <code>markets[address(mToken)]</code>in a local variable, rather than repeatedly accessing it within the function</li>\n<li>Some operations, such as updating <code>supply and borrow indexes</code>, are performed in a loop for each market in the <code>claimReward</code> function. This could lead to exceeding the block gas limit if the number of markets is substantial</li>\n<li>Evaluate whether certain loops can be simplified or avoided altogether to reduce gas costs. For instance, consider whether iterating over the allMarkets array in the <code>_addMarketInternal</code> function can be optimized</li>\n<li><code>Reuse variables</code> instead of creating new ones when possible. This can reduce <code>memory usage</code> and, in turn, save gas</li>\n<li>For functions that <code>don't modify state</code>, use the <code>view or pure</code> modifiers to avoid unnecessary gas costs associated with state changes</li>\n<li>For <code>small and simple functions</code>, consider <code>inlining</code> them within other functions to save gas costs associated with function calls</li>\n<li>Use gas-efficient math libraries, if available, to perform arithmetic operations. Check if there are any <code>gas-efficient</code> replacements for the current <code>math operations</code></li>\n<li>If certain variables, such as <code>admin, borrowCapGuardian, pauseGuardian,</code> etc., are not intended to be changed after deployment, mark them as <code>immutable</code> to enhance <code>security</code> and <code>gas efficiency</code> </li>\n<li>Simplify code logic and eliminate <code>redundant calculations</code></li>\n<li>In the <code>executeProposal</code> function, there are two function calls to <code>trustedSenders[vm.emitterChainId]</code>.<code>contains(vm.emitterAddress)</code>. Consider storing the result of this call in a variable and using that variable to avoid calling the function <code>twice</code></li>\n<li>In the <code>setTrustedSenders</code> and <code>unSetTrustedSenders</code> functions, you can move the <code>msg.sender == address(this)</code> check outside the loop to minimize <code>storage access</code> in each iteration saves gas</li>\n<li>In the <code>constructor</code>, you can use emit to emit the <code>TrustedSenderUpdated</code> event instead of using emit in the loop. This can reduce the gas cost by avoiding multiple event emissions</li>\n<li>In the <code>executeProposal</code> function, the return value <code>returnData</code> is not used. You can <code>remove</code> it if it’s not required.</li>\n</ol>\n<h2 id=\"risks-as-per-analysis\" style=\"position:relative;\"><a href=\"#risks-as-per-analysis\" aria-label=\"risks as per analysis permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Risks as per Analysis</h2>\n<ul>\n<li>Lack of integer validations in <code>_setEmissionCap()</code> function leads unexpected behavior </li>\n<li>if <code>(_amount == type(uint256).max)</code> check is wrong . There is no gurantee that <code>type(uint256).max</code> and contract balance or same </li>\n<li><code>updateMarketSupplyIndexInternal()</code>,<code>updateMarketSupplyIndexInternal()</code> there is no limits checked when updating totalsupply   </li>\n<li><code>Inline assembly</code> should be used with caution as it can introduce security risks. Whenever possible, prefer using <code>built-in Solidity functions</code> and <code>libraries</code>.</li>\n</ul>\n<p><code>MultiRewardDistributor.sol</code></p>\n<ul>\n<li>The contract interacts with external contracts, such as <code>comptroller, IERC20, and MToken</code>, through external calls. These external calls are not checked for<code>success or failure</code>, and there is no handling for potential exceptions or revert reasons, which can lead to <code>unexpected results</code>.</li>\n<li>The contract involves various <code>mathematical calculations</code>, such as <code>index updates</code> and <code>reward distributions</code>. It’s crucial to ensure that these operations are handled correctly and do not result in <code>integer overflows</code> or <code>underflows</code>.</li>\n<li>Some of the functions in the contract, such as <code>updateMarketSupplyIndexInternal</code>, <code>updateMarketBorrowIndexInternal</code>, <code>disburseSupplierRewardsInternal</code>, and <code>disburseBorrowerRewardsInternal</code>, perform calculations and iterations that could potentially consume a significant amount of gas. It’s essential to ensure that these functions are optimized to prevent gas limitations and high transaction costs.</li>\n<li>The contract uses <code>uint224</code> data type for some of the index values <code>(_globalSupplyIndex, _globalBorrowIndex, etc.)</code>. If these indices grow <code>too large</code>, it could potentially lead to overflow issues and incorrect <code></code>reward calculations`<code></code>.</li>\n<li>The <code>sendReward</code> function performs a token transfer and is marked as <code>nonReentrant</code>, but it’s essential to ensure that all external contract calls, especially token transfers, are safe against reentrancy attacks</li>\n<li>The contract allows the owner to update <code>supply</code> and <code>borrow emission speeds</code>. There should be careful consideration of the emission rates and their effects on the overall <code>token economy</code> to avoid unintended consequences</li>\n<li>The contract has two functions <code>(calculateSupplyRewardsForUser and calculateBorrowRewardsForUser)</code> for calculating rewards for <code>suppliers and borrowers</code>, respectively. Ensure that both functions use consistent calculations and share the <code>same index</code> values to<code>prevent discrepancies</code></li>\n<li>Consider using <code>upgradeable contract patterns</code> to allow for <code>future updates</code> without redeploying the entire contract</li>\n</ul>\n<p><code>Comptroller.sol</code></p>\n<ul>\n<li>In the transferAllowed function, there’s a comment mentioning the use of local vars to <code>avoid stack-depth limits</code> in calculating account liquidity. While it’s a good practice to use <code>local variables</code> for <code>complex calculations</code>, it’s important to ensure that the <code>overall stack depth</code> is managed appropriately, especially in functions that could be called in <code>nested scenarios</code></li>\n<li>The contract appears to have some administrative functions like <code>_setPriceOracle, _setCloseFactor, _setCollateralFactor,</code> etc., which should only be callable by the <code>admin</code>. However, the access control checks are not consistently applied in all these functions, potentially allowing unauthorized users to modify critical parameters</li>\n<li>Several functions call external contracts, like the <code>rewardDistributor</code>,<code>oracle</code>, and token contracts, but they do <code>not have proper error handling</code> for potential failures. Lack of error handling can lead to unexpected behavior and vulnerabilities</li>\n<li>The contract has several functions for pausing different actions <code>(_setMintPaused, _setBorrowPaused, _setTransferPaused, _setSeizePaused)</code>. However, there is no mechanism for <code>time-based unpausing or emergency unpause</code>, which could be essential for the contract’s safety</li>\n<li>The <code>liquidateCalculateSeizeTokens</code> function, used during liquidation, performs arithmetic calculations using external data (e.g., exchangeRateMantissa). Failing to <code>handle or validate external data correctly</code> could lead to vulnerabilities in the liquidation process</li>\n<li>The <code>claimReward</code> function, responsible for distributing rewards, has a complex design with nested loops, and it calls an external contract multiple times. High complexity increases the risk of errors and makes the contract harder to audit</li>\n<li>The <code>getBlockTimestamp</code> function retrieves the current block timestamp using block.timestamp. It’s worth noting that relying solely on block timestamps for time-sensitive operations can be manipulated by miners to some extent</li>\n<li>Certain functions that modify contract parameters (e.g., _setPriceOracle, _setCloseFactor, etc.) do not include <code>time limitations</code> for changes. Adding <code>time restrictions</code> for critical parameter modifications could prevent<code>malicious or mistaken changes</code></li>\n</ul>\n<p><code>TemporalGovernor.sol</code></p>\n<ul>\n<li>The contract relies on trusted emitters from the Wormhole bridge using <code>isTrustedSender</code>. However, relying solely on a <code>chain ID</code> and a 32-byte emitter address might not be sufficient to ensure the <code>authenticity</code> of the signed messages. Consider using a more <code>robust signature verification</code> mechanism to ensure the validity of messages</li>\n<li>The contract doesn’t have any explicit <code>reentrancy protection</code>. Ensure that critical state changes are performed before any external calls to prevent potential <code>reentrancy attacks</code></li>\n<li>The contract uses <code>uint248</code> for <code>lastPauseTime</code>, which might be susceptible to integer overflow if the pause timestamp becomes larger than the <code>maximum value</code></li>\n<li>The fastTrackProposalExecution function allows the owner to bypass the usual delay for proposal execution. This can be risky as it doesn’t have any checks on the validity of the proposal. It should be handled with caution and only used in specific emergency scenarios</li>\n<li>The function <code>allTrustedSender</code>s iterates through the entire trustedSenders set to return the list of trusted senders for a chain. This operation may become inefficient as the size of the set grows. Consider alternative data structures or optimizations if needed</li>\n</ul>\n<p><code>ChainlinkCompositeOracle.sol</code></p>\n<ul>\n<li>The contract relies on <code>Chainlink oracles</code> to provide accurate price data. If a Chainlink oracle is <code>compromised</code> or <code>provides incorrect data</code>, the ChainlinkCompositeOracle contract could also be compromised</li>\n<li>The contract does not have any mechanisms in place to <code>prevent front-running</code> or<code>other forms of market manipulation</code>. This could allow malicious actors to exploit the contract and profit at the expense of other users</li>\n<li>The contract relies on the <code>decimals</code> value returned by Chainlink oracles. If the decimals value is misaligned with the <code>contract's expectations</code>, it could result in <code>incorrect price calculations</code> and pose a vulnerability</li>\n</ul>\n<h2 id=\"non-functional-aspects\" style=\"position:relative;\"><a href=\"#non-functional-aspects\" aria-label=\"non functional aspects permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Non-functional aspects</h2>\n<ul>\n<li>Aim for high test coverage to validate the contract’s behavior and catch potential bugs or vulnerabilities</li>\n<li>The protocol execution flow is not explained in efficient way. </li>\n<li>Its best to explain over all protocol with architecture is easy to understandings </li>\n<li>Consider designing the contract to be upgradable or allow for versioning. This can help address issues, introduce new features, or adapt to evolving requirements without disrupting the entire system</li>\n</ul>\n<h2 id=\"time-spent-on-analysis\" style=\"position:relative;\"><a href=\"#time-spent-on-analysis\" aria-label=\"time spent on analysis permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Time spent on analysis</h2>\n<p><code>15 Hours</code></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-moonwell-findings/issues/313#issuecomment-1664714369\">ElliotFriedman (Moonwell) acknowledged</a></strong></p>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Audits incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Audit submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .mtk14 { color: #F44747; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#medium-risk-findings-17\">Medium Risk Findings (17)</a></p>\n<ul>\n<li><a href=\"#m-01-borrowers-can-avoid-liquidations-if-erc777-token-is-configured-as-an-emissiontoken-\">[M-01] Borrowers can avoid liquidations, if ERC777 token is configured as an <code>emissionToken</code> </a></li>\n<li><a href=\"#m-02-missing-check-for-the-maxmin-price-in-the-chainlinkoraclesol-contract\">[M-02] Missing check for the max/min price in the <code>chainlinkOracle.sol</code> contract</a></li>\n<li><a href=\"#m-03-excuteproposal-can-fail-due-to-wormhole-guardian-change\">[M-03] <code>excuteProposal</code> can fail due to Wormhole guardian change</a></li>\n<li><a href=\"#m-04-malicious-emissiontoken-could-poison-rewards-for-a-market\">[M-04] Malicious <code>emissionToken</code> could poison rewards for a market</a></li>\n<li><a href=\"#m-05-only-guardian-can-change-guardian\">[M-05] Only <code>guardian</code> can change <code>guardian</code></a></li>\n<li><a href=\"#m-06-temporalgovernor-can-be-bricked-by-guardian\">[M-06] <code>TemporalGovernor</code> can be bricked by <code>guardian</code></a></li>\n<li><a href=\"#m-07-fasttrackproposalexecution-doesnt-check-intendedrecipient\">[M-07] <code>fastTrackProposalExecution</code> doesn’t check <code>intendedRecipient</code></a></li>\n<li><a href=\"#m-08-fasttrackproposalexecution-should-only-be-callable-when-temporalgovernor-is-paused\">[M-08] <code>fastTrackProposalExecution</code> should only be callable when <code>TemporalGovernor</code> is paused</a></li>\n<li><a href=\"#m-09-proposals-which-intend-to-send-native-tokens-to-target-addresses-cant-be-executed\">[M-09] Proposals which intend to send native tokens to target addresses can’t be executed</a></li>\n<li><a href=\"#m-10-initial-deploy-wont-succeed-because-of-too-high-initialmintamount-for-usdc-market\">[M-10] Initial deploy won’t succeed because of too high <code>initialMintAmount</code> for USDC market</a></li>\n<li><a href=\"#m-11-incorrect-address-is-set-as-wormhole-bridge-which-breaks-deploy\">[M-11] Incorrect address is set as Wormhole Bridge, which breaks deploy</a></li>\n<li><a href=\"#m-12-incorrect-chainid-of-base-in-deploy-script-will-force-redeployment\">[M-12] Incorrect chainId of Base in deploy script will force redeployment</a></li>\n<li><a href=\"#m-13-its-not-possible-to-liquidate-deprecated-market\">[M-13] It’s not possible to liquidate deprecated market</a></li>\n<li><a href=\"#m-14-borrower-and-supplier-rewards--accrued-could-be-lost-when-admin-replaces-the-reward-distributor-with-a-new-reward-distributor\">[M-14] Borrower and Supplier rewards  accrued could be lost when Admin replaces the reward distributor with a new reward distributor</a></li>\n<li><a href=\"#m-15-accrueinterest-is-expected-to-revert-when-the-rate-is-higher-than-the-maximum-allowed-rate-which-is-possible-since-the-utilization-can-be-more-than-1\">[M-15] <code>accrueInterest</code> is expected to revert when the rate is higher than the maximum allowed rate, which is possible since the utilization can be more than 1</a></li>\n<li><a href=\"#m-16-a-single-emissioncap-is-not-suitable-for-different-tokens-reward-if-they-have-different-underlying-decimals\">[M-16] A single emissionCap is not suitable for different tokens reward if they have different underlying decimals</a></li>\n<li><a href=\"#m-17-borrowratemaxmantissa-should-be-specific-to-the-chain-protocol-is-being-deployed-to\">[M-17] borrowRateMaxMantissa should be specific to the chain protocol is being deployed to</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#low-risk-findings-6\">Low-risk findings (6)</a></li>\n<li><a href=\"#l-01-guardian-can-fast-track-every-proposal\">L-01 <code>guardian</code> can fast track every proposal</a></li>\n<li><a href=\"#l-02-temporalgovernor-can-get-the-same-address-on-different-chains\">L-02 <code>TemporalGovernor</code> can get the same address on different chains</a></li>\n<li><a href=\"#l-03-temporalgovernorgrantguardianspause-can-be-called-after-guardian-is-revoked\">L-03 <code>TemporalGovernor::grantGuardiansPause</code> can be called after <code>guardian</code> is revoked</a></li>\n<li><a href=\"#l-04-no-cap-on-how-many-emissionconfigs-there-can-be-for-a-market\">L-04 No cap on how many <code>emissionConfig</code>s there can be for a market</a></li>\n<li><a href=\"#l-05-neither-_setmarketborrowcaps-or-_setmarketsupplycaps-checks-if-market-is-listed\">L-05 Neither <code>_setMarketBorrowCaps</code> or <code>_setMarketSupplyCaps</code> checks if market is listed</a></li>\n<li><a href=\"#l-06-lack-of-tests-for-supplycap\">L-06 Lack of tests for <code>supplyCap</code></a></li>\n<li><a href=\"#suggestions-1\">Suggestions (1)</a></li>\n<li><a href=\"#s-01-chainlinkcompositeoraclegetderivedpricethreeoracles-is-very-specialized\">S-01 <code>ChainlinkCompositeOracle::getDerivedPriceThreeOracles</code> is very specialized</a></li>\n<li><a href=\"#refactoring-4\">Refactoring (4)</a></li>\n<li><a href=\"#r-01-multirewarddistributorcalculatenewindex-parameter-_currenttimestamp-is-confusing\">R-01 <code>MultiRewardDistributor::calculateNewIndex</code> parameter <code>_currentTimestamp</code> is confusing</a></li>\n<li><a href=\"#r-02-unnecessary-_amount-0-check\">R-02 Unnecessary <code>_amount> 0</code> check</a></li>\n<li><a href=\"#r-03-multirewarddistributor-indexupdate-struct-is-unnecessary\">R-03 <code>MultiRewardDistributor</code>: <code>IndexUpdate</code> struct is unnecessary</a></li>\n<li><a href=\"#r-04-parameter-_mtokendata-for-multirewarddistributorcalculateborrowrewardsforuser-is-unnecessary\">R-04 Parameter <code>_mTokenData</code> for <code>MultiRewardDistributor::calculateBorrowRewardsForUser</code> is unnecessary</a></li>\n<li><a href=\"#non-critical-6\">Non-critical (6)</a></li>\n<li><a href=\"#n-01-wrong-grammatical-number-in-grantguardianspause\">N-01 Wrong grammatical number in <code>grantGuardiansPause</code></a></li>\n<li><a href=\"#n-02-erroneous-docs\">N-02 Erroneous docs</a></li>\n<li><a href=\"#n-03-weird-word-describing-the-future\">N-03 Weird word describing the future</a></li>\n<li><a href=\"#n-04-forgotten-ctoken-references\">N-04 Forgotten <code>cToken</code> references</a></li>\n<li><a href=\"#n-05-incorrect-comments\">N-05 Incorrect comments</a></li>\n<li><a href=\"#n-06-comment-slash-off-by-one\">N-06 Comment slash off by one</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#audit-analysis\">Audit Analysis</a></p>\n<ul>\n<li><a href=\"#summary-1\">Summary</a></li>\n<li><a href=\"#overview-1\">Overview</a></li>\n<li><a href=\"#audit-approach\">Audit approach</a></li>\n<li><a href=\"#stages-of-audit\">Stages of audit</a></li>\n<li><a href=\"#learnings\">Learnings</a></li>\n<li><a href=\"#possible-systemic-risks\">Possible Systemic Risks</a></li>\n<li><a href=\"#code-commentary\">Code Commentary</a></li>\n<li><a href=\"#centralization-risks\">Centralization risks</a></li>\n<li><a href=\"#gas-optimizations\">Gas Optimizations</a></li>\n<li><a href=\"#risks-as-per-analysis\">Risks as per Analysis</a></li>\n<li><a href=\"#non-functional-aspects\">Non-functional aspects</a></li>\n<li><a href=\"#time-spent-on-analysis\">Time spent on analysis</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>"
}