{
  "circa": {
    "title": "Centrifuge",
    "sponsor": "Centrifuge",
    "slug": "2023-09-centrifuge",
    "date": "2023-10-11",
    "findings": "https://github.com/code-423n4/2023-09-centrifuge-findings/issues",
    "contest": 285
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit outlined in this document, C4 conducted an analysis of the Centrifuge smart contract system written in Solidity. The audit took place between September 8—September 14 2023.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>85 Wardens contributed reports to the Centrifuge:</p>\n<ol>\n<li><a href=\"https://code4rena.com/@ciphermarco\">ciphermarco</a></li>\n<li><a href=\"https://code4rena.com/@alexfilippov314\">alexfilippov314</a></li>\n<li><a href=\"https://code4rena.com/@0x3b\">0x3b</a></li>\n<li><a href=\"https://code4rena.com/@jaraxxus\">jaraxxus</a></li>\n<li><a href=\"https://code4rena.com/@twicek\">twicek</a></li>\n<li><a href=\"https://code4rena.com/@J4X\">J4X</a></li>\n<li><a href=\"https://code4rena.com/@0xStalin\">0xStalin</a></li>\n<li><a href=\"https://code4rena.com/@Aymen0909\">Aymen0909</a></li>\n<li><a href=\"https://code4rena.com/@bin2chen\">bin2chen</a></li>\n<li><a href=\"https://code4rena.com/@imtybik\">imtybik</a></li>\n<li><a href=\"https://code4rena.com/@castle_chain\">castle_chain</a></li>\n<li><a href=\"https://code4rena.com/@HChang26\">HChang26</a></li>\n<li><a href=\"https://code4rena.com/@merlin\">merlin</a></li>\n<li><a href=\"https://code4rena.com/@maanas\">maanas</a></li>\n<li><a href=\"https://code4rena.com/@nobody2018\">nobody2018</a></li>\n<li><a href=\"https://code4rena.com/@0xnev\">0xnev</a></li>\n<li><a href=\"https://code4rena.com/@mert_eren\">mert_eren</a></li>\n<li><a href=\"https://code4rena.com/@Bauchibred\">Bauchibred</a></li>\n<li><a href=\"https://code4rena.com/@josephdara\">josephdara</a></li>\n<li>BARW (<a href=\"https://code4rena.com/@BenRai\">BenRai</a> and <a href=\"https://code4rena.com/@albertwh1te\">albertwh1te</a>)</li>\n<li><a href=\"https://code4rena.com/@ast3ros\">ast3ros</a></li>\n<li><a href=\"https://code4rena.com/@Ch_301\">Ch_301</a></li>\n<li><a href=\"https://code4rena.com/@degensec\">degensec</a></li>\n<li><a href=\"https://code4rena.com/@0xpiken\">0xpiken</a></li>\n<li><a href=\"https://code4rena.com/@ravikiranweb3\">ravikiranweb3</a></li>\n<li><a href=\"https://code4rena.com/@lsaudit\">lsaudit</a></li>\n<li><a href=\"https://code4rena.com/@catellatech\">catellatech</a></li>\n<li><a href=\"https://code4rena.com/@Sathish9098\">Sathish9098</a></li>\n<li><a href=\"https://code4rena.com/@cats\">cats</a></li>\n<li><a href=\"https://code4rena.com/@kaveyjoe\">kaveyjoe</a></li>\n<li><a href=\"https://code4rena.com/@0xbrett8571\">0xbrett8571</a></li>\n<li><a href=\"https://code4rena.com/@0xfuje\">0xfuje</a></li>\n<li><a href=\"https://code4rena.com/@rvierdiiev\">rvierdiiev</a></li>\n<li><a href=\"https://code4rena.com/@0xmystery\">0xmystery</a></li>\n<li><a href=\"https://code4rena.com/@Kow\">Kow</a></li>\n<li><a href=\"https://code4rena.com/@0xRobsol\">0xRobsol</a></li>\n<li><a href=\"https://code4rena.com/@codegpt\">codegpt</a></li>\n<li><a href=\"https://code4rena.com/@0xkazim\">0xkazim</a></li>\n<li><a href=\"https://code4rena.com/@nmirchev8\">nmirchev8</a></li>\n<li><a href=\"https://code4rena.com/@gumgumzum\">gumgumzum</a></li>\n<li><a href=\"https://code4rena.com/@T1MOH\">T1MOH</a></li>\n<li><a href=\"https://code4rena.com/@Kral01\">Kral01</a></li>\n<li><a href=\"https://code4rena.com/@pipidu83\">pipidu83</a></li>\n<li><a href=\"https://code4rena.com/@Vagner\">Vagner</a></li>\n<li><a href=\"https://code4rena.com/@KrisApostolov\">KrisApostolov</a></li>\n<li><a href=\"https://code4rena.com/@0xTiwa\">0xTiwa</a></li>\n<li><a href=\"https://code4rena.com/@0xgrbr\">0xgrbr</a></li>\n<li><a href=\"https://code4rena.com/@PENGUN\">PENGUN</a></li>\n<li><a href=\"https://code4rena.com/@bitsurfer\">bitsurfer</a></li>\n<li><a href=\"https://code4rena.com/@ether_sky\">ether_sky</a></li>\n<li><a href=\"https://code4rena.com/@0xklh\">0xklh</a></li>\n<li><a href=\"https://code4rena.com/@Phantasmagoria\">Phantasmagoria</a></li>\n<li><a href=\"https://code4rena.com/@ladboy233\">ladboy233</a></li>\n<li><a href=\"https://code4rena.com/@deth\">deth</a></li>\n<li><a href=\"https://code4rena.com/@IceBear\">IceBear</a></li>\n<li><a href=\"https://code4rena.com/@0xPacelli\">0xPacelli</a></li>\n<li><a href=\"https://code4rena.com/@MaslarovK\">MaslarovK</a></li>\n<li><a href=\"https://code4rena.com/@grearlake\">grearlake</a></li>\n<li><a href=\"https://code4rena.com/@rokinot\">rokinot</a></li>\n<li><a href=\"https://code4rena.com/@fouzantanveer\">fouzantanveer</a></li>\n<li><a href=\"https://code4rena.com/@K42\">K42</a></li>\n<li><a href=\"https://code4rena.com/@hals\">hals</a></li>\n<li><a href=\"https://code4rena.com/@emerald7017\">emerald7017</a></li>\n<li><a href=\"https://code4rena.com/@foxb868\">foxb868</a></li>\n<li><a href=\"https://code4rena.com/@0xLook\">0xLook</a></li>\n<li><a href=\"https://code4rena.com/@MohammedRizwan\">MohammedRizwan</a></li>\n<li><a href=\"https://code4rena.com/@jkoppel\">jkoppel</a></li>\n<li><a href=\"https://code4rena.com/@jolah1\">jolah1</a></li>\n<li><a href=\"https://code4rena.com/@alexzoid\">alexzoid</a></li>\n<li><a href=\"https://code4rena.com/@sandy\">sandy</a></li>\n<li><a href=\"https://code4rena.com/@btk\">btk</a></li>\n<li><a href=\"https://code4rena.com/@Kaysoft\">Kaysoft</a></li>\n<li><a href=\"https://code4rena.com/@klau5\">klau5</a></li>\n<li><a href=\"https://code4rena.com/@0xAadi\">0xAadi</a></li>\n<li><a href=\"https://code4rena.com/@Bughunter101\">Bughunter101</a></li>\n<li><a href=\"https://code4rena.com/@0xblackskull\">0xblackskull</a></li>\n<li><a href=\"https://code4rena.com/@SanketKogekar\">SanketKogekar</a></li>\n<li><a href=\"https://code4rena.com/@m_Rassska\">m_Rassska</a></li>\n<li><a href=\"https://code4rena.com/@7ashraf\">7ashraf</a></li>\n<li><a href=\"https://code4rena.com/@JP_Courses\">JP_Courses</a></li>\n<li><a href=\"https://code4rena.com/@Krace\">Krace</a></li>\n<li><a href=\"https://code4rena.com/@mrudenko\">mrudenko</a></li>\n<li><a href=\"https://code4rena.com/@fatherOfBlocks\">fatherOfBlocks</a></li>\n<li><a href=\"https://code4rena.com/@0xHelium\">0xHelium</a></li>\n</ol>\n<p>This audit was judged by <a href=\"https://code4rena.com/@gzeon\">gzeon</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/liveactionllama\">liveactionllama</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 8 unique vulnerabilities. Of these vulnerabilities, 0 received a risk rating in the category of HIGH severity and 8 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 39 reports detailing issues with a risk rating of LOW severity or non-critical.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2023-09-centrifuge\">C4 Centrifuge audit repository</a>, and is composed of 18 smart contracts written in the Solidity programming language and includes 2,657 lines of Solidity code.</p>\n<p>In addition to the known issues identified by the project team, a Code4rena bot race was conducted at the start of the audit. The winning bot, <strong>IllIllI-bot</strong> from warden IllIllI, generated the <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/bot-report.md\">Automated Findings report</a> and all findings therein were classified as out of scope.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities based on three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>For more information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>, specifically our section on <a href=\"https://docs.code4rena.com/awarding/judging-criteria/severity-categorization\">Severity Categorization</a>.</p>\n<h1 id=\"medium-risk-findings-8\" style=\"position:relative;\"><a href=\"#medium-risk-findings-8\" aria-label=\"medium risk findings 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (8)</h1>\n<h2 id=\"m-01-onlycentrifugechainorigin-cant-require-msgsender-equal-axelargateway\" style=\"position:relative;\"><a href=\"#m-01-onlycentrifugechainorigin-cant-require-msgsender-equal-axelargateway\" aria-label=\"m 01 onlycentrifugechainorigin cant require msgsender equal axelargateway permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/537\">[M-01] <code>onlyCentrifugeChainOrigin()</code> can’t require <code>msg.sender</code> equal <code>axelarGateway</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/537\">bin2chen</a>, also found by <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/549\">maanas</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/442\">nobody2018</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/290\">castle_chain</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/289\">mert_eren</a>, and <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/212\">merlin</a></em></p>\n<p>In <code>AxelarRouter.sol</code>, we need to ensure the legitimacy of the <code>execute()</code> method execution, mainly through two methods:</p>\n<ol>\n<li><code>axelarGateway.validateContractCall ()</code> to validate if the <code>command</code> is approved or not.</li>\n<li><code>onlyCentrifugeChainOrigin()</code> is used to validate that <code>sourceChain</code> <code>sourceAddress</code> is legal.</li>\n</ol>\n<p>Let’s look at the implementation of <code>onlyCentrifugeChainOrigin()</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">modifier</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyCentrifugeChainOrigin</span><span class=\"mtk1\">(</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sourceChain</span><span class=\"mtk1\">, </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sourceAddress</span><span class=\"mtk1\">) {        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@&gt;      </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">axelarGateway</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;AxelarRouter/invalid-origin&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk11\">bytes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">axelarCentrifugeChainId</span><span class=\"mtk1\">)) == </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk11\">bytes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sourceChain</span><span class=\"mtk1\">)),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;AxelarRouter/invalid-source-chain&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk11\">bytes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">axelarCentrifugeChainAddress</span><span class=\"mtk1\">)) == </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk11\">bytes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sourceAddress</span><span class=\"mtk1\">)),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;AxelarRouter/invalid-source-address&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>The problem is that this restriction <code>msg.sender == address(axelarGateway)</code>.</p>\n<p>When we look at the official <code>axelarGateway.sol</code> contract, it doesn’t provide any call external contract ‘s<code>execute()</code> method.</p>\n<p>So <code>msg.sender</code> cannot be <code>axelarGateway</code>, and the official example does not restrict <code>msg.sender</code>.</p>\n<p>The security of the command can be guaranteed by <code>axelarGateway.validateContractCall()</code>, <code>sourceChain</code>, <code>sourceAddress</code>.</p>\n<p>There is no need to restrict <code>msg.sender</code>.</p>\n<p><code>axelarGateway</code> code address<br>\n<a href=\"https://github.com/axelarnetwork/axelar-cgp-solidity/blob/main/contracts/AxelarGateway.sol\">https://github.com/axelarnetwork/axelar-cgp-solidity/blob/main/contracts/AxelarGateway.sol</a></p>\n<p>Can’t find anything that calls <code>router.execute()</code>.</p>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p><code>router.execute()</code> cannot be executed properly, resulting in commands from other chains not being executed， protocol not working properly.</p>\n<h3 id=\"recommended-mitigation\" style=\"position:relative;\"><a href=\"#recommended-mitigation\" aria-label=\"recommended mitigation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation</h3>\n<p>Remove <code>msg.sender</code> restriction</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    modifier onlyCentrifugeChainOrigin(string calldata sourceChain, string calldata sourceAddress) {        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       require(msg.sender == address(axelarGateway), &quot;AxelarRouter/invalid-origin&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        require(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            keccak256(bytes(axelarCentrifugeChainId)) == keccak256(bytes(sourceChain)),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            &quot;AxelarRouter/invalid-source-chain&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        require(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            keccak256(bytes(axelarCentrifugeChainAddress)) == keccak256(bytes(sourceAddress)),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            &quot;AxelarRouter/invalid-source-address&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        _;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"assessed-type\" style=\"position:relative;\"><a href=\"#assessed-type\" aria-label=\"assessed type permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Context</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/537#issuecomment-1723464758\">hieronx (Centrifuge) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/537#issuecomment-1733894416\">gzeon (judge) increased severity to High and commented</a>:</strong></p>\n<blockquote>\n<p>This seems High risk to me since the Axelar bridge is a centerpiece of this protocol, and when deployed in a certain way where the AxelarRouter is the only ward, it might cause user deposits to be stuck forever. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/537#issuecomment-1735848904\">gzeon (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Reconsidering severity to Medium here since the expected setup would have DelayedAdmin able to unstuck the system.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/537#issuecomment-1745247688\">hieronx (Centrifuge) commented</a>:</strong></p>\n<blockquote>\n<p>Mitigated in <a href=\"https://github.com/centrifuge/liquidity-pools/pull/168\">https://github.com/centrifuge/liquidity-pools/pull/168</a></p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-liquiditypoolrequestredeemwithpermit-transaction-can-be-front-run-with-the-different-liquidity-pool\" style=\"position:relative;\"><a href=\"#m-02-liquiditypoolrequestredeemwithpermit-transaction-can-be-front-run-with-the-different-liquidity-pool\" aria-label=\"m 02 liquiditypoolrequestredeemwithpermit transaction can be front run with the different liquidity pool permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/227\">[M-02] <code>LiquidityPool::requestRedeemWithPermit</code> transaction can be front run with the different liquidity pool</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/227\">alexfilippov314</a></em></p>\n<p>The permit signature is linked only to the tranche token. That’s why it can be used with any liquidity pool with the same tranche token. Since anyone can call <code>LiquidityPool::requestRedeemWithPermit</code> the following scenario is possible:</p>\n<ol>\n<li>Let’s assume that some user has some amount of tranche tokens. Let’s also assume that there are multiple liquidity pools with the same tranche token. For example, USDX pool and USDY pool.</li>\n<li>The user wants to redeem USDX from the USDX pool using <code>requestRedeemWithPermit</code>. The user signs the permit and sends a transaction.</li>\n<li>A malicious actor can see this transaction in the mempool and use the signature from it to request a redemption from the USDY pool with a greater fee amount.</li>\n<li>Since this transaction has a greater fee amount it will likely be executed before the valid transaction.</li>\n<li>The user’s transaction will be reverted since the permit has already been used.</li>\n<li>If the user will not cancel this malicious request until the end of the epoch this request will be executed, and the user will be forced to claim USDY instead of USDX.</li>\n</ol>\n<p>This scenario assumes some user’s negligence and usually doesn’t lead to a significant loss. But in some cases (for example, USDY depeg) a user can end up losing significantly.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The test below illustrates the scenario described above:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testPOCIssue1</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint64</span><span class=\"mtk1\"> </span><span class=\"mtk12\">poolId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenName</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenSymbol</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">trancheId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">assume</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">assume</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">MAX_UINT128</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">assume</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Use a wallet with a known private key so we can sign the permit message</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">investor</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addr</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0xABCD</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addr</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0xABCD</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">LiquidityPool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lPool</span><span class=\"mtk1\"> =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">LiquidityPool</span><span class=\"mtk1\">(</span><span class=\"mtk11\">deployLiquidityPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">poolId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">erc20</span><span class=\"mtk1\">.</span><span class=\"mtk11\">decimals</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">tokenName</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenSymbol</span><span class=\"mtk1\">, </span><span class=\"mtk12\">trancheId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">erc20</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">investor</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">homePools</span><span class=\"mtk1\">.</span><span class=\"mtk11\">updateMember</span><span class=\"mtk1\">(</span><span class=\"mtk12\">poolId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">trancheId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">investor</span><span class=\"mtk1\">, </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint64</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Sign permit for depositing investment currency</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">v</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">r</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">s</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sign</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">0xABCD</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk8\">&quot;</span><span class=\"mtk6\">\\x19\\x01</span><span class=\"mtk8\">&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">erc20</span><span class=\"mtk1\">.</span><span class=\"mtk11\">DOMAIN_SEPARATOR</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        </span><span class=\"mtk12\">erc20</span><span class=\"mtk1\">.</span><span class=\"mtk11\">PERMIT_TYPEHASH</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">investor</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">investmentManager</span><span class=\"mtk1\">), </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">lPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">requestDepositWithPermit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">investor</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">, </span><span class=\"mtk12\">v</span><span class=\"mtk1\">, </span><span class=\"mtk12\">r</span><span class=\"mtk1\">, </span><span class=\"mtk12\">s</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// To avoid stack too deep errors</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">delete</span><span class=\"mtk1\"> </span><span class=\"mtk12\">v</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">delete</span><span class=\"mtk1\"> </span><span class=\"mtk12\">r</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">delete</span><span class=\"mtk1\"> </span><span class=\"mtk12\">s</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// ensure funds are locked in escrow</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">erc20</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">escrow</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">erc20</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">investor</span><span class=\"mtk1\">), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// collect 50% of the tranche tokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">homePools</span><span class=\"mtk1\">.</span><span class=\"mtk11\">isExecutedCollectInvest</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">poolId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">trancheId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk11\">bytes20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">investor</span><span class=\"mtk1\">)),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">poolManager</span><span class=\"mtk1\">.</span><span class=\"mtk11\">currencyAddressToId</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">erc20</span><span class=\"mtk1\">)),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">uint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">uint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maxMint</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">lPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">maxMint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">investor</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">lPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">maxMint</span><span class=\"mtk1\">, </span><span class=\"mtk12\">investor</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">TrancheToken</span><span class=\"mtk1\"> </span><span class=\"mtk12\">trancheToken</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">TrancheToken</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">share</span><span class=\"mtk1\">()));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">trancheToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">investor</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">maxMint</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Sign permit for redeeming tranche tokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">v</span><span class=\"mtk1\">, </span><span class=\"mtk12\">r</span><span class=\"mtk1\">, </span><span class=\"mtk12\">s</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sign</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">0xABCD</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk8\">&quot;</span><span class=\"mtk6\">\\x19\\x01</span><span class=\"mtk8\">&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">trancheToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">DOMAIN_SEPARATOR</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                            </span><span class=\"mtk12\">trancheToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">PERMIT_TYPEHASH</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                            </span><span class=\"mtk12\">investor</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                            </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">investmentManager</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                            </span><span class=\"mtk12\">maxMint</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                            </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                            </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Let&#39;s assume that there is another liquidity pool with the same poolId and trancheId</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// but a different currency</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">LiquidityPool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newLPool</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">123</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newErc20</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk11\">_newErc20</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Y&#39;s Dollar&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;USDY&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk7\">6</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">homePools</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addCurrency</span><span class=\"mtk1\">(</span><span class=\"mtk7\">123</span><span class=\"mtk1\">, </span><span class=\"mtk12\">newErc20</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">homePools</span><span class=\"mtk1\">.</span><span class=\"mtk11\">allowPoolCurrency</span><span class=\"mtk1\">(</span><span class=\"mtk12\">poolId</span><span class=\"mtk1\">, </span><span class=\"mtk7\">123</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">newLPool</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">LiquidityPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">poolManager</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deployLiquidityPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">poolId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">trancheId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">newErc20</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assert</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lPool</span><span class=\"mtk1\">) != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newLPool</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Malicious actor can use the signature extracted from the mempool to </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// request redemption from the different liquidity pool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">makeAddr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;malicious&quot;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">newLPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">requestRedeemWithPermit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">maxMint</span><span class=\"mtk1\">, </span><span class=\"mtk12\">investor</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">, </span><span class=\"mtk12\">v</span><span class=\"mtk1\">, </span><span class=\"mtk12\">r</span><span class=\"mtk1\">, </span><span class=\"mtk12\">s</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// User&#39;s transaction will fail since the signature has already been used</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">lPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">requestRedeemWithPermit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">maxMint</span><span class=\"mtk1\">, </span><span class=\"mtk12\">investor</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">, </span><span class=\"mtk12\">v</span><span class=\"mtk1\">, </span><span class=\"mtk12\">r</span><span class=\"mtk1\">, </span><span class=\"mtk12\">s</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>One of the ways to mitigate this issue is to add some identifier of the liquidity pool to the permit message. This way permit will be linked to a specific liquidity pool.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/227#issuecomment-1745023712\">hieronx (Centrifuge) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Mitigated in <a href=\"https://github.com/centrifuge/liquidity-pools/pull/159\">https://github.com/centrifuge/liquidity-pools/pull/159</a></p>\n</blockquote>\n<hr>\n<h2 id=\"m-03-cached-domain_separator-is-incorrect-for-tranche-tokens-potentially-breaking-permit-integrations\" style=\"position:relative;\"><a href=\"#m-03-cached-domain_separator-is-incorrect-for-tranche-tokens-potentially-breaking-permit-integrations\" aria-label=\"m 03 cached domain_separator is incorrect for tranche tokens potentially breaking permit integrations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/146\">[M-03] Cached <code>DOMAIN_SEPARATOR</code> is incorrect for tranche tokens potentially breaking permit integrations</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/146\">Kow</a>, also found by <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/746\">0xRobsol</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/730\">codegpt</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/710\">0xkazim</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/697\">josephdara</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/586\">Aymen0909</a>, 0xpiken (<a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/539\">1</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/345\">2</a>), <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/536\">bin2chen</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/426\">nmirchev8</a>, rvierdiiev (<a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/404\">1</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/402\">2</a>), lsaudit (<a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/313\">1</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/306\">2</a>), <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/247\">0xfuje</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/214\">gumgumzum</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/102\">T1MOH</a>, and ravikiranweb3 (<a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/65\">1</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/52\">2</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/51\">3</a>)</em></p>\n<p>Attempts to interact with tranche tokens via <code>permit</code> may always revert.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>When new tranche tokens are deployed, the initial <code>DOMAIN_SEPARATOR</code> is calculated and cached in the constructor.<br>\n<a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/token/ERC20.sol#L42-L49\">https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/token/ERC20.sol#L42-L49</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">decimals_</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">deploymentChainId</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">chainid</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_DOMAIN_SEPARATOR</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_calculateDomainSeparator</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">chainid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>This uses an empty string since <code>name</code> is only set after deployment.<br>\n<a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/util/Factory.sol#L81-L109\">https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/util/Factory.sol#L81-L109</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">newTrancheToken</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint64</span><span class=\"mtk1\"> </span><span class=\"mtk12\">poolId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">trancheId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">name</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">symbol</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">trancheTokenWards</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">restrictionManagerWards</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">auth</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">TrancheToken</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">TrancheToken</span><span class=\"mtk1\">{</span><span class=\"mtk12\">salt</span><span class=\"mtk1\">: </span><span class=\"mtk10\">salt</span><span class=\"mtk1\">}(</span><span class=\"mtk12\">decimals</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">file</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;name&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">name</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>Consequently, the domain separator is incorrect (when <code>block.chainid == deploymentChainId</code> where the domain separator is not recalculated) and will cause reverts when signatures for <code>permit</code> are attempted to be constructed using the tranche token’s <code>name</code> (which will not be empty).</p>\n<p>It should also be noted that the tranche token <code>name</code> could be changed by a call to <code>updateTranchTokenMetadata</code> which may also introduce complications with the domain separator.</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider setting the name in the constructor before the cached domain separator is calculated.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/146#issuecomment-1745025208\">hieronx (Centrifuge) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Mitigated in <a href=\"https://github.com/centrifuge/liquidity-pools/pull/142\">https://github.com/centrifuge/liquidity-pools/pull/142</a></p>\n</blockquote>\n<hr>\n<h2 id=\"m-04-you-can-deposit-really-small-amount-for-other-users-to-dos-them\" style=\"position:relative;\"><a href=\"#m-04-you-can-deposit-really-small-amount-for-other-users-to-dos-them\" aria-label=\"m 04 you can deposit really small amount for other users to dos them permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/143\">[M-04] You can deposit really small amount for other users to DoS them</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/143\">0x3b</a>, also found by <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/686\">jaraxxus</a> and <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/283\">twicek</a></em></p>\n<p>Deposit and mint under <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/LiquidityPool.sol#L141-L152\"><strong>LiquidityPool</strong></a> lack access control, which enables any user to <strong>proceed</strong> the  mint/deposit for another user. Attacker can deposit (this does not require tokens) some wai before users TX to DoS the deposit.</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/LiquidityPool.sol#L141-L144\">deposit</a> and <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/LiquidityPool.sol#L148-L152\">mint</a> do <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/InvestmentManager.sol#L427-L441\">processDeposit</a>/<a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/InvestmentManager.sol#L451-L465\">processMint</a> which are the secondary functions to the requests. These function do not take any value in the form of tokens, but only send shares to the receivers. This means they can be called for free.</p>\n<p>With this an attacker who wants to DoS a user, can wait him to make the request to deposit and on the next epoch front run him by calling  <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/LiquidityPool.sol#L141-L144\">deposit</a> with something small like 1 wei. Afterwards when the user calls <code>deposit</code>, his TX will inevitable revert, as he will not have enough balance for the full deposit.</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Have some access control modifiers like <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/LiquidityPool.sol#L97-L100\"><strong>withApproval</strong></a> used also in <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/LiquidityPool.sol#L200-L208\">redeem</a>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    function deposit(uint256 assets, address receiver) public returns (uint256 shares)  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    function deposit(uint256 assets, address receiver) public returns (uint256 shares) withApproval(receiver) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        shares = investmentManager.processDeposit(receiver, assets);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        emit Deposit(address(this), receiver, assets, shares);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    function mint(uint256 shares, address receiver) public returns (uint256 assets) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    function mint(uint256 shares, address receiver) public returns (uint256 assets) withApproval(receiver) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        assets = investmentManager.processMint(receiver, shares);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        emit Deposit(address(this), receiver, assets, shares);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span></code></pre>\n<h3 id=\"assessed-type-1\" style=\"position:relative;\"><a href=\"#assessed-type-1\" aria-label=\"assessed type 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Access Control</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/143#issuecomment-1745028559\">hieronx (Centrifuge) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Mitigated in <a href=\"https://github.com/centrifuge/liquidity-pools/pull/136\">https://github.com/centrifuge/liquidity-pools/pull/136</a></p>\n</blockquote>\n<hr>\n<h2 id=\"m-05-investors-claiming-their-maxdeposit-by-using-the-liquiditypooldeposit-will-cause-other-users-to-be-unable-to-claim-their-maxdepositmaxmint\" style=\"position:relative;\"><a href=\"#m-05-investors-claiming-their-maxdeposit-by-using-the-liquiditypooldeposit-will-cause-other-users-to-be-unable-to-claim-their-maxdepositmaxmint\" aria-label=\"m 05 investors claiming their maxdeposit by using the liquiditypooldeposit will cause other users to be unable to claim their maxdepositmaxmint permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/118\">[M-05] Investors claiming their <code>maxDeposit</code> by using the <code>LiquidityPool.deposit()</code> will cause other users to be unable to claim their <code>maxDeposit</code>/<code>maxMint</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/118\">0xStalin</a>, also found by <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/647\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/532\">imtybik</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/321\">HChang26</a>, and <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/210\">J4X</a></em></p>\n<p>Claiming deposits using the <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/LiquidityPool.sol#L141-L144\"><code>LiquidityPool.deposit()</code></a> will cause the Escrow contract to not have enough shares to allow other investors to claim their maxDeposit or maxMint values for their deposited assets.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ul>\n<li>Before an investor can claim their deposits, they first needs to request the deposit and wait for the Centrigue Chain to validate it in the next epoch.</li>\n<li>Investors can request deposits at different epochs without the need to claim all the approved deposits before requesting a new deposit, in the end, the maxDeposit and maxMint values that the investor can claim will be increased accordingly based on all the request deposits that the investor makes.</li>\n<li>When the requestDeposit of the investor is processed in the Centrifuge chain, a number of TrancheShares will be minted based on the price at the moment when the request was processed and the total amount of deposited assets, this TrancheShares will be deposited to the Escrow contract, and the TrancheShares will be waiting for the investors to claim their deposits.</li>\n<li>When investors decide to claim their deposit they can use the <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/LiquidityPool.sol#L141-L144\"><code>LiquidityPool.deposit()</code></a> function, this function receives as arguments the number of assets that are being claimed and the address of the account to claim the deposits for.</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">shares</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">investmentManager</span><span class=\"mtk1\">.</span><span class=\"mtk11\">processDeposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Deposit</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<ul>\n<li>The <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/LiquidityPool.sol#L141-L144\"><code>LiquidityPool.deposit()</code></a> function calls the <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/InvestmentManager.sol#L427-L441\"><code>InvestmentManager::processDeposit()</code></a> which will validate that the amount of assets being claimed doesn’t exceed the investor’s deposit limits, will compute the deposit price in the <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/InvestmentManager.sol#L551-L558\"><code>InvestmentManager::calculateDepositPrice()</code></a>, which basically computes an average price for all the request deposits that have been accepted in the Centrifuge Chain, each of those request deposits could’ve been executed at a different price, so, this function, based on the values of maxDeposit and maxMint will estimate an average price for all the unclaimed deposits, later, using this computed price for the deposits will compute the equivalent of TrancheTokens for the CurrencyAmount being claimed, and finally, processDeposit() will transferFrom the escrow to the investor account the computed amount of TranchTokens.</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">processDeposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyAmount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">auth</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">trancheTokenAmount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_currencyAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_toUint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currencyAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">//@audit-info =&gt; orderbook[][].maxDeposit is updated when the handleExecutedCollectInvest() was executed!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">//@audit-info =&gt; The orderbook keeps track of the number of TrancheToken shares that have been minted to the Escrow contract on the user&#39;s behalf!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">_currencyAmount</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">orderbook</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">][</span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\">].</span><span class=\"mtk12\">maxDeposit</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_currencyAmount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">&quot;InvestmentManager/amount-exceeds-deposit-limits&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//@audit-info =&gt; computes an average price for all the request deposits that have been accepted in the Centrifuge Chain and haven&#39;t been claimed yet!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">depositPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">calculateDepositPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">depositPrice</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;LiquidityPool/deposit-token-price-0&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//@audit-info =&gt; Based on the computed depositPrice will compute the equivalent of TrancheTokens for the CurrencyAmount being claimed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_trancheTokenAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_calculateTrancheTokenAmount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_currencyAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\">, </span><span class=\"mtk12\">depositPrice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//@audit-info =&gt; transferFrom the escrow to the investor account the computed amount of TranchTokens.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_trancheTokenAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_currencyAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\">, </span><span class=\"mtk12\">user</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">trancheTokenAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_trancheTokenAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong>The problem</strong> occurs when an investor hasn’t claimed their deposits and has requested multiple deposits on different epochs at different prices. The <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/InvestmentManager.sol#L551-L558\"><code>InvestmentManager::calculateDepositPrice()</code></a> function will compute an equivalent/average price for all the requestDeposits that haven’t been claimed yet. Because of the different prices that the request deposits where processed at, the computed price will compute the most accurate average of the deposit’s price, but there is a slight rounding error that causes the computed value of trancheTokenAmount to be slightly different from what it should exactly be.</p>\n<ul>\n<li>That slight difference will make that the Escrow contract transfers slightly more shares to the investor claiming the deposits by using the <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/LiquidityPool.sol#L141-L144\"><code>LiquidityPool.deposit()</code></a></li>\n<li><strong>As a result</strong>, when another investor tries to claim their <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/LiquidityPool.sol#L129-L132\">maxDeposit</a> or <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/LiquidityPool.sol#L154-L157\">maxMint</a>, now the Escrow contract doesn’t have enough shares to make whole the request of the other investor, and as a consequence the other investor transaction will be reverted. That means the second investor won’t be able to claim all the shares that it is entitled to claim because the Escrow contract doesn’t have all those shares anymore.</li>\n</ul>\n<p><strong>Coded PoC</strong></p>\n<ul>\n<li>I used the <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/test/LiquidityPool.t.sol\"><code>LiquidityPool.t.sol</code></a> test file as the base file for this PoC, please add the below testPoC to the LiquidityPool.t.sol file</li>\n<li>In this PoC I demonstrate that Alice (A second investor) won’t be able to claim her maxDeposit or maxMint amounts after the first investor uses the <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/LiquidityPool.sol#L141-L144\"><code>LiquidityPool.deposit()</code></a> function to claim his <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/LiquidityPool.sol#L129-L132\">maxDeposit() assets</a>. The first investor makes two requestDeposit, each of them at a different epoch and at a different price, Alice on the other hand only does 1 requestDeposit in the second epoch.</li>\n<li>\n<p>Run this PoC two times, check the comments on the last 4 lines, one time we want to test Alice claiming her deposits using LiquidityPool::deposit(), and the second time using LiquidityPool::mint()</p>\n<ul>\n<li>The two executions should fail with the same problem.</li>\n</ul>\n</li>\n</ul>\n<details>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testDepositAtDifferentPricesPoC</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint64</span><span class=\"mtk1\"> </span><span class=\"mtk12\">poolId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">trancheId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">assume</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">TRANCHE_TOKEN_DECIMALS</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">18</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// Like DAI</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">INVESTMENT_CURRENCY_DECIMALS</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">6</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// 6, like USDC</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currency</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_newErc20</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Currency&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;CR&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">INVESTMENT_CURRENCY_DECIMALS</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lPool_</span><span class=\"mtk1\"> =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">deployLiquidityPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">poolId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">TRANCHE_TOKEN_DECIMALS</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">trancheId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currency</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">LiquidityPool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lPool</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">LiquidityPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lPool_</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">homePools</span><span class=\"mtk1\">.</span><span class=\"mtk11\">updateTrancheTokenPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">poolId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">trancheId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1000000000000000000</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">//@audit-info =&gt; Add Alice as a Member</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">alice</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x23232323</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">homePools</span><span class=\"mtk1\">.</span><span class=\"mtk11\">updateMember</span><span class=\"mtk1\">(</span><span class=\"mtk12\">poolId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">trancheId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">alice</span><span class=\"mtk1\">, </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint64</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// invest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">investmentAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">100000000</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// 100 * 10**6</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">homePools</span><span class=\"mtk1\">.</span><span class=\"mtk11\">updateMember</span><span class=\"mtk1\">(</span><span class=\"mtk12\">poolId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">trancheId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">self</span><span class=\"mtk1\">, </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint64</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">currency</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">investmentManager</span><span class=\"mtk1\">), </span><span class=\"mtk12\">investmentAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">currency</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">self</span><span class=\"mtk1\">, </span><span class=\"mtk12\">investmentAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">lPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">requestDeposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">investmentAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">self</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// trigger executed collectInvest at a price of 1.25</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_currencyId</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">poolManager</span><span class=\"mtk1\">.</span><span class=\"mtk11\">currencyAddressToId</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currency</span><span class=\"mtk1\">)); </span><span class=\"mtk3\">// retrieve currencyId</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyPayout</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">100000000</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// 100 * 10**6                                          </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">firstTrancheTokenPayout</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">80000000000000000000</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// 100 * 10**18 / 1.25, rounded down</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">homePools</span><span class=\"mtk1\">.</span><span class=\"mtk11\">isExecutedCollectInvest</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">poolId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">trancheId</span><span class=\"mtk1\">, </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk11\">bytes20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">self</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">_currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">currencyPayout</span><span class=\"mtk1\">, </span><span class=\"mtk12\">firstTrancheTokenPayout</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// assert deposit &amp; mint values adjusted</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">maxDeposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">self</span><span class=\"mtk1\">), </span><span class=\"mtk12\">currencyPayout</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">maxMint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">self</span><span class=\"mtk1\">), </span><span class=\"mtk12\">firstTrancheTokenPayout</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// deposit price should be ~1.25*10**18 === 1250000000000000000</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">investmentManager</span><span class=\"mtk1\">.</span><span class=\"mtk11\">calculateDepositPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">self</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lPool</span><span class=\"mtk1\">)), </span><span class=\"mtk7\">1250000000000000000</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// second investment in a different epoch =&gt; different price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">currency</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">investmentManager</span><span class=\"mtk1\">), </span><span class=\"mtk12\">investmentAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">currency</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">self</span><span class=\"mtk1\">, </span><span class=\"mtk12\">investmentAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">lPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">requestDeposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">investmentAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">self</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// trigger executed collectInvest at a price of 2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">currencyPayout</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">100000000</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// 100 * 10**6</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">secondTrancheTokenPayout</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">50000000000000000000</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// 100 * 10**18 / 1.4, rounded down</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">homePools</span><span class=\"mtk1\">.</span><span class=\"mtk11\">isExecutedCollectInvest</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">poolId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">trancheId</span><span class=\"mtk1\">, </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk11\">bytes20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">self</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">_currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">currencyPayout</span><span class=\"mtk1\">, </span><span class=\"mtk12\">secondTrancheTokenPayout</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Alice invests the same amount as the other investor in the second epoch - Price is at 2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">currency</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">, </span><span class=\"mtk12\">investmentAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">currency</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">investmentManager</span><span class=\"mtk1\">), </span><span class=\"mtk12\">investmentAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">lPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">requestDeposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">investmentAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">homePools</span><span class=\"mtk1\">.</span><span class=\"mtk11\">isExecutedCollectInvest</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">poolId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">trancheId</span><span class=\"mtk1\">, </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk11\">bytes20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">_currencyId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">currencyPayout</span><span class=\"mtk1\">, </span><span class=\"mtk12\">secondTrancheTokenPayout</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">AliceTrancheTokenPayout</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">50000000000000000000</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// 100 * 10**18 / 1.4, rounded down</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">//@audit-info =&gt; At this point, the Escrow contract should have the firstTrancheTokenPayout + secondTrancheTokenPayout + AliceTrancheTokenPayout</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">escrow</span><span class=\"mtk1\">)),</span><span class=\"mtk12\">firstTrancheTokenPayout</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">secondTrancheTokenPayout</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">AliceTrancheTokenPayout</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Investor collects his the deposited assets using the LiquidityPool::deposit()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">lPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">maxDeposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">self</span><span class=\"mtk1\">), </span><span class=\"mtk12\">self</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Alice tries to collect her deposited assets and gets her transactions reverted because the Escrow doesn&#39;t have the required TokenShares for Alice!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">//@audit-info =&gt; Run the PoC one time to test Alice trying to claim their deposit using LiquidityPool.deposit()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">lPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">maxDeposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">), </span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">//@audit-info =&gt; Run the PoC a second time, but now using LiquidityPool.mint()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// lPool.mint(lPool.maxMint(alice), alice);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n</details>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<ul>\n<li>I’d recommend to add a check to the computed value of the <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/InvestmentManager.sol#L438\"><code>_trancheTokenAmount</code></a> in the <code>InvestmentManager::processDeposit()</code>, if the <code>_trancheTokenAmount</code> exceeds the <code>maxMint()</code> of the user, update it and set it to be the maxMint(), in this way, the rounding differences will be discarded before doing the actual transfer of shares from the Escrow to the user, and this will prevent the Escrow from not having all the required TranchToken for the other investors</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">processDeposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyAmount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">auth</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">trancheTokenAmount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_currencyAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_toUint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currencyAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">_currencyAmount</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">orderbook</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">][</span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\">].</span><span class=\"mtk12\">maxDeposit</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_currencyAmount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">&quot;InvestmentManager/amount-exceeds-deposit-limits&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">depositPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">calculateDepositPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">depositPrice</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;LiquidityPool/deposit-token-price-0&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_trancheTokenAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_calculateTrancheTokenAmount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_currencyAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\">, </span><span class=\"mtk12\">depositPrice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//@audit =&gt; Add this check to prevent any rounding errors from causing problems when transfering shares from the Escrow to the Investor!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+   </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_trancheTokenAmount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">orderbook</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">][</span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\">].</span><span class=\"mtk12\">maxMint</span><span class=\"mtk1\">) </span><span class=\"mtk12\">_trancheTokenAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">orderbook</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">][</span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\">].</span><span class=\"mtk12\">maxMint</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_trancheTokenAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_currencyAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\">, </span><span class=\"mtk12\">user</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">trancheTokenAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_trancheTokenAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<ul>\n<li>After applying the suggested recommendation, you can use the provided PoC on this report to verify that the problem has been solved.</li>\n</ul>\n<h3 id=\"assessed-type-2\" style=\"position:relative;\"><a href=\"#assessed-type-2\" aria-label=\"assessed type 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Math</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/118#issuecomment-1728512469\">hieronx (Centrifuge) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/210#issuecomment-1728512207\">hieronx (Centrifuge) commented via duplicate issue <code>#210</code></a>:</strong></p>\n<blockquote>\n<p>I believe issues <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/210\">210</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/34\">34</a> and <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/118\">118</a> all come down to the same underlying issues, and I will try to respond with our current understanding (although we are still digging further).</p>\n<p>There are actually multiple rounding issues coming together in the system right now:</p>\n<ol>\n<li>If there are multiple executions of an order, there can be loss of precision when these values are added to each other.</li>\n<li>If there are multiple <code>deposit</code> or <code>mint</code> calls, there can be loss of precision in the amount of tranche tokens they receive, based on the computed deposit price.</li>\n<li>If there are multiple <code>deposit</code> or <code>mint</code> calls, there can be loss of precision in the implied new price through the subtracted <code>maxDeposit</code> / <code>maxMint</code> values.</li>\n</ol>\n<p>We’ve written <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/210#issuecomment-1728512207\">a new fuzz test</a>, building on the work from the reported findings, that clearly shows the underlying issue.</p>\n<p>Unfortunately it also makes clear that this issue cannot be solved by the recommended mitigation steps from the 3 different findings on their own, and it requires deeper changes. We are still investigating this.</p>\n<p>Now, in terms of the severity, it does not directly lead to a loss of funds. As noted in <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/210\">issue 210</a>, the <code>UserEscrow</code> logic prevents users from withdrawing more currency/funds than they are entitled to. However, it does lead to users being able to receive more tranche tokens (shares). I will leave it to the judges to make a decision on the severity for this.</p>\n<p>Thanks to the 3 wardens for reporting these issues!</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/118#issuecomment-1733725182\">gzeon (judge) commented</a>:</strong></p>\n<blockquote>\n<p>This issue described a protocol specific issue with multiple deposit/withdrawal, where <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/34\">issue 34</a> is a generic 4626 rounding issue, and therefore not marked as duplicate of issue 34. In terms of severity, this does not directly lead to a loss of fund but will affect the availability of the protocol, hence Medium.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/118#issuecomment-1745029786\">hieronx (Centrifuge) commented</a>:</strong></p>\n<blockquote>\n<p>Mitigated in <a href=\"https://github.com/centrifuge/liquidity-pools/pull/166\">https://github.com/centrifuge/liquidity-pools/pull/166</a></p>\n</blockquote>\n<hr>\n<h2 id=\"m-06-delayedadmin-cannot-pauseadminremovepauser\" style=\"position:relative;\"><a href=\"#m-06-delayedadmin-cannot-pauseadminremovepauser\" aria-label=\"m 06 delayedadmin cannot pauseadminremovepauser permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/92\">[M-06] DelayedAdmin Cannot <code>PauseAdmin.removePauser</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/92\">ciphermarco</a></em></p>\n<p>As per the audit repository’s documentation, which is confirmed as up-to-date, there are carefully considered emergency scenarios. Among these scenarios, one is described as follows:</p>\n<p><a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/README.md?plain=1#L74-L77\">https://github.com/code-423n4/2023-09-centrifuge/blob/main/README.md?plain=1#L74-L77</a>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">**Someone controls 1 pause admin and triggers a malicious `pause()`**</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">* The delayed admin is a `ward` on the pause admin and can trigger `PauseAdmin.removePauser`.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">* It can then trigger `root.unpause()`.</span></span></code></pre>\n<p>That makes perfect sense from a security perspective. However the provided <code>DelayedAdmin</code> implementation lacks the necessary functionality to execute <code>PauseAdmin.removePauser</code> in the case of an emergency.</p>\n<p>Striving to adhere to the documented <a href=\"https://docs.code4rena.com/awarding/judging-criteria/severity-categorization\">Severity Categorization</a>, I have categorized this as Medium instead of Low. The reason is that it does not qualify as Low due to representing both a “function incorrect as to spec” issue and a critical feature missing from the project’s security model. Without this emergency action for <code>PauseAdmin</code>, other recovery paths may have to wait for <code>Root</code>’s delay period or, at least temporarily, change the protocol’s security model to make a recovery. In my view, this aligns with the “Assets not at direct risk, but the function of the protocol or its availability could be impacted” requirement for Medium severity. With that said, I realize the sponsors and judges will ultimately evaluate and categorise it based on their final risk analysis, not mine. I’m simply streamlining the process by presenting my perspective in advance.</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>In order to remove a pauser from the <code>PauseAdmin</code> contract, the <code>removePause</code> function must be called:</p>\n<p><a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/admins/PauseAdmin.sol#L39-L42\">https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/admins/PauseAdmin.sol#L39-L42</a>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function removePauser(address user) external auth {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        pausers[user] = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit RemovePauser(user);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>Since it is a short contract, here is the whole <code>DelayedAdmin</code> implementation:</p>\n<p><a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/admins/DelayedAdmin.sol\">https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/admins/DelayedAdmin.sol</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">// SPDX-License-Identifier: AGPL-3.0-only</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">pragma solidity 0.8.21;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {Root} from &quot;../Root.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {Auth} from &quot;./../util/Auth.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/// @title  Delayed Admin</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/// @dev    Any ward on this contract can trigger</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">///         instantaneous pausing and unpausing</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">///         on the Root, as well as schedule and cancel</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">///         new relys through the timelock.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">contract DelayedAdmin is Auth {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    Root public immutable root;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // --- Events ---</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    event File(bytes32 indexed what, address indexed data);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    constructor(address root_) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        root = Root(root_);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        wards[msg.sender] = 1;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit Rely(msg.sender);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // --- Admin actions ---</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function pause() public auth {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        root.pause();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function unpause() public auth {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        root.unpause();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function scheduleRely(address target) public auth {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        root.scheduleRely(target);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function cancelRely(address target) public auth {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        root.cancelRely(target);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>No implemented functionalities exist to trigger <code>PauseAdmin.removePauser</code>. Additionally, the contract features an unused <code>event File</code>,\na and fails to record the <code>PauseAdmin</code>’s address upon initiation or elsewhere.</p>\n<p>As anticipated, <code>Auth</code> (inherited) also does not handle this responsibility:</p>\n<p>To confirm that I did not misunderstand anything, I thoroughly searched the entire audit repository for occurrences of <code>removePauser</code>.\nHowever, I could only find them in <code>PauseAdmin.sol</code>, where the function to remove a pauser is implemented, and in a test case that\ndirectly calls the <code>PauseAdmin</code>.</p>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p><strong>1. Implement the <code>PauseAdmin.removePauser</code> Functionality in <code>DelayedAdmin.sol</code> with This Diff:</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">5a6</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">&gt; import {PauseAdmin} from &quot;./PauseAdmin.sol&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">13a15</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">&gt;     PauseAdmin public immutable pauseAdmin;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">18c20</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">&lt;     constructor(address root_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">---</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">&gt;     constructor(address root_, address pauseAdmin_) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">19a22</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">&gt;         pauseAdmin = PauseAdmin(pauseAdmin_);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">41,42c44,48</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">&lt;     // @audit HM? How can delayed admin call `PauseAdmin.removePauser if not coded here?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">&lt;     // @audit According to documentation: &quot;The delayed admin is a ward on the pause admin and can trigger PauseAdmin.removePauser.&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">---</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">&gt; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">&gt;     // --- Emergency actions --</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">&gt;     function removePauser(address pauser) public auth {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">&gt;         pauseAdmin.removePauser(pauser);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">&gt;     }</span></span></span></code></pre>\n<p><strong>2. Add This Test Function to <code>AdminTest</code> Contract in <code>test/Admin.t.sol</code></strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function testEmergencyRemovePauser() public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address evilPauser = address(0x1337);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        pauseAdmin.addPauser(evilPauser);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        assertEq(pauseAdmin.pausers(evilPauser), 1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        delayedAdmin.removePauser(evilPauser);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        assertEq(pauseAdmin.pausers(evilPauser), 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p><strong>3. Change the <code>DelayedAdmin</code> Creation in <code>script/Deployer.sol</code> with This diff:</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">55c55</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">&lt;         delayedAdmin = new DelayedAdmin(address(root));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">---</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">&gt;         delayedAdmin = new DelayedAdmin(address(root), address(pauseAdmin));</span></span></span></code></pre>\n<p><strong>4. Test</strong></p>\n<p><code>$ forge test</code></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/92#issuecomment-1720289509\">RaymondFam (lookout) commented</a>:</strong></p>\n<blockquote>\n<p>The sponsor has highlighted in Discord that these are EOAs capable of triggering to removePauser.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/92#issuecomment-1735729992\">gzeon (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Since the <code>removePauser</code> usecase is explicitly documented in the README and DelayedAdmin.sol is in-scope, I believe this is a valid Medium issue as the warden described.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/92#issuecomment-1745030969\">hieronx (Centrifuge) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Mitigated in <a href=\"https://github.com/centrifuge/liquidity-pools/pull/139\">https://github.com/centrifuge/liquidity-pools/pull/139</a></p>\n</blockquote>\n<hr>\n<h2 id=\"m-07-tranchetokenamount-should-be-rounded-up-when-proceeding-to-a-withdrawal-or-previewing-a-withdrawal\" style=\"position:relative;\"><a href=\"#m-07-tranchetokenamount-should-be-rounded-up-when-proceeding-to-a-withdrawal-or-previewing-a-withdrawal\" aria-label=\"m 07 tranchetokenamount should be rounded up when proceeding to a withdrawal or previewing a withdrawal permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/34\">[M-07] <code>trancheTokenAmount</code> should be rounded UP when proceeding to a withdrawal or previewing a withdrawal</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/34\">pipidu83</a>, also found by <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/798\">Vagner</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/774\">KrisApostolov</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/680\">0xTiwa</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/664\">josephdara</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/644\">0xgrbr</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/562\">PENGUN</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/542\">Kral01</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/535\">bitsurfer</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/470\">ether_sky</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/444\">0xklh</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/421\">merlin</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/367\">maanas</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/349\">Phantasmagoria</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/318\">lsaudit</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/287\">castle_chain</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/281\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/106\">deth</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/105\">IceBear</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/82\">0xPacelli</a>, and <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/76\">MaslarovK</a></em></p>\n<p>This is good practice when implementing the EIP-4626 vault standard as it is more secure to favour the vault than its users in that case.<br>\nThis can also lead to issues down the line for other protocol integrating Centrifuge, that may assume that rounding was handled according to EIP-4626 best practices.</p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>When calling the <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/InvestmentManager.sol#L515\"><code>processWithdraw</code></a> function, the <code>trancheTokenAmount</code> is computed through the <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/InvestmentManager.sol#L591\"><code>_calculateTrancheTokenAmount</code></a> function, which rounds DOWN the number of shares required to be burnt to receive the <code>currencyAmount</code> payout/withdrawal.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @dev Processes user&#39;s tranche token redemption after the epoch has been executed on Centrifuge.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// In case user&#39;s redempion order was fullfilled on Centrifuge during epoch execution MaxRedeem and MaxWithdraw</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// are increased and LiquidityPool currency can be transferred to user&#39;s wallet on calling processRedeem or processWithdraw.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// Note: The trancheTokenAmount required to fullfill the redemption order was already locked in escrow upon calling requestRedeem and burned upon collectRedeem.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @notice trancheTokenAmount return value is type of uint256 to be compliant with EIP4626 LiquidityPool interface</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @return trancheTokenAmount the amount of trancheTokens redeemed/burned required to receive the currencyAmount payout/withdrawel.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">processWithdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">auth</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">trancheTokenAmount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_currencyAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_toUint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currencyAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">(</span><span class=\"mtk12\">_currencyAmount</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">orderbook</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">][</span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\">].</span><span class=\"mtk12\">maxWithdraw</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_currencyAmount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">&quot;InvestmentManager/amount-exceeds-withdraw-limits&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">redeemPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">calculateRedeemPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">redeemPrice</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;LiquidityPool/redeem-token-price-0&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_trancheTokenAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_calculateTrancheTokenAmount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_currencyAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\">, </span><span class=\"mtk12\">redeemPrice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">_redeem</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_trancheTokenAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_currencyAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\">, </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">user</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">trancheTokenAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_trancheTokenAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_calculateTrancheTokenAmount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">price</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">internal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">view</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">trancheTokenAmount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">(</span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyDecimals</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">trancheTokenDecimals</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">_getPoolDecimals</span><span class=\"mtk1\">(</span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyAmountInPriceDecimals</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_toPriceDecimals</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currencyAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">currencyDecimals</span><span class=\"mtk1\">, </span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\">).</span><span class=\"mtk11\">mulDiv</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">10</span><span class=\"mtk1\"> ** </span><span class=\"mtk12\">PRICE_DECIMALS</span><span class=\"mtk1\">, </span><span class=\"mtk12\">price</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MathLib</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Rounding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Down</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">trancheTokenAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_fromPriceDecimals</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currencyAmountInPriceDecimals</span><span class=\"mtk1\">, </span><span class=\"mtk12\">trancheTokenDecimals</span><span class=\"mtk1\">, </span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>As an additional reason the round UP the amount, the computed amount of shares is also used to <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/InvestmentManager.sol#L635C14-L635C39\"><code>_decreaseRedemptionLimits</code></a>, which could potentially lead to a rounded UP remaining redemption limit post withdrawal (note that for the same reason it would we wise to round UP the <code>_currency</code> amount as well when calling <code>_decreaseRedemptionLimits</code>).</p>\n<p>The same function is used in the <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/InvestmentManager.sol#L396\"><code>previewWithdraw</code></a> function, where is should be rounded UP for the same reasons.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @return trancheTokenAmount is type of uin256 to support the EIP4626 Liquidity Pool interface</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">previewWithdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_currencyAmount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">view</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">trancheTokenAmount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_toUint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_currencyAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">redeemPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">calculateRedeemPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">redeemPrice</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">trancheTokenAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk11\">_calculateTrancheTokenAmount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currencyAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\">, </span><span class=\"mtk12\">redeemPrice</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Visual Studio / Manual Review</p>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>As the we do not always want to round the amount of shares UP in <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/InvestmentManager.sol#L591\"><code>_calculateTrancheTokenAmount</code></a> (e.g. when used in <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/InvestmentManager.sol#L370\"><code>previewDeposit</code></a> or <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/InvestmentManager.sol#L427\"><code>processDeposit</code></a> the shares amount is correctly rounded DOWN), the function would actually require an extra argument like below:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_calculateTrancheTokenAmount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">price</span><span class=\"mtk1\">, Math.Rounding </span><span class=\"mtk12\">rounding</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">internal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">view</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">trancheTokenAmount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">(</span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyDecimals</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">trancheTokenDecimals</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">_getPoolDecimals</span><span class=\"mtk1\">(</span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currencyAmountInPriceDecimals</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_toPriceDecimals</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currencyAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">currencyDecimals</span><span class=\"mtk1\">, </span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\">).</span><span class=\"mtk11\">mulDiv</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">10</span><span class=\"mtk1\"> ** </span><span class=\"mtk12\">PRICE_DECIMALS</span><span class=\"mtk1\">, </span><span class=\"mtk12\">price</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MathLib</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Rounding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Down</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">trancheTokenAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_fromPriceDecimals</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currencyAmountInPriceDecimals</span><span class=\"mtk1\">, </span><span class=\"mtk12\">trancheTokenDecimals</span><span class=\"mtk1\">, </span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>And be used as</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">_calculateTrancheTokenAmount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currencyAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\">, </span><span class=\"mtk12\">redeemPrice</span><span class=\"mtk1\">, </span><span class=\"mtk10\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Rounding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Ceil</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<p>In <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/InvestmentManager.sol#L396\"><code>previewWithdraw</code></a> and <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/InvestmentManager.sol#L515\"><code>processWithdraw</code></a></p>\n<p>And</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">_calculateTrancheTokenAmount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_currencyAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\">, </span><span class=\"mtk12\">depositPrice</span><span class=\"mtk1\">, </span><span class=\"mtk10\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Rounding</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Floor</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<p>In <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/InvestmentManager.sol#L370\"><code>previewDeposit</code></a> and <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/InvestmentManager.sol#L427\"><code>processDeposit</code></a>.</p>\n<h3 id=\"assessed-type-3\" style=\"position:relative;\"><a href=\"#assessed-type-3\" aria-label=\"assessed type 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Math</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/34#issuecomment-1745030227\">hieronx (Centrifuge) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Mitigated in <a href=\"https://github.com/centrifuge/liquidity-pools/pull/166\">https://github.com/centrifuge/liquidity-pools/pull/166</a></p>\n</blockquote>\n<hr>\n<h2 id=\"m-08-the-restriction-manager-does-not-completely-implement-erc1404-which-leads-to-accounts-that-are-supposed-to-be-restricted-actually-having-access-to-do-with-their-tokens-as-they-see-fit\" style=\"position:relative;\"><a href=\"#m-08-the-restriction-manager-does-not-completely-implement-erc1404-which-leads-to-accounts-that-are-supposed-to-be-restricted-actually-having-access-to-do-with-their-tokens-as-they-see-fit\" aria-label=\"m 08 the restriction manager does not completely implement erc1404 which leads to accounts that are supposed to be restricted actually having access to do with their tokens as they see fit permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/779\">[M-08] The Restriction Manager does not completely implement ERC1404 which leads to accounts that are supposed to be restricted actually having access to do with their tokens as they see fit</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/779\">Bauchibred</a>, also found by <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/792\">josephdara</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/625\">ast3ros</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/413\">Ch_301</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/388\">BARW</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/356\">0xnev</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/49\">degensec</a>, and <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/14\">J4X</a></em></p>\n<p>Medium, contract’s intended logic is for <em>blacklisted</em> users not to be able to interact with their system so as to follow rules set by regulationary bodies in the case where a user does anything that warrants them to be blacklisted, but this is clearly broken since only half the window is closed as current implementation only checks on receiver being blacklisted and not sender.</p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The current implementation of the ERC1404 restrictions within the <code>RestrictionManager.sol</code> contract only places restrictions on the receiving address in token transfer instances. This oversight means that the sending addresses are not restricted, which poses a regulatory and compliance risk. Should a user be <code>blacklisted</code> for any reason, they can continue to transfer tokens as long as the receiving address is a valid member. This behaviour is contrary to expectations from regulatory bodies, especially say in the U.S where these bodies are very strict and a little in-compliance could land Centrifuge a lawsuit., which may expect complete trading restrictions for such blacklisted individuals.</p>\n<p>Within the <code>RestrictionManager</code> contract, the method <code>detectTransferRestriction</code> only checks if the receiving address (<code>to</code>) is a valid member:</p>\n<p><a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/token/RestrictionManager.sol#L28-L34\">RestrictionManager.sol#L28-L34</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">detectTransferRestriction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">value</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint8</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk11\">hasMember</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">DESTINATION_NOT_A_MEMBER_RESTRICTION_CODE</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">SUCCESS_CODE</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>In the above code, the sending address (<code>from</code>) is never checked against the membership restrictions, which means blacklisted users can still initiate transfers and when checking the transfer restriction from both <code>tranchtoken.sol</code> and the <code>liquiditypool.sol</code> it’s going to wrongly return true for a personnel that should be false</p>\n<p>See <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/token/Tranche.sol#L80-L82\">Tranche.sol#L80-L82)</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// function checkTransferRestriction(address from, address to, uint256 value) public view returns (bool) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">//     return share.checkTransferRestriction(from, to, value);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// }</span></span></span></code></pre>\n<p>Also <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/token/Tranche.sol#L35-L39\">Tranche.sol#L35-L39</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">modifier</span><span class=\"mtk1\"> </span><span class=\"mtk11\">restricted</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">value</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">restrictionCode</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">detectTransferRestriction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">value</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">restrictionCode</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">restrictionManager</span><span class=\"mtk1\">.</span><span class=\"mtk11\">SUCCESS_CODE</span><span class=\"mtk1\">(), </span><span class=\"mtk11\">messageForTransferRestriction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">restrictionCode</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>This function suggests that the system’s logic may rely on the <code>detectTransferRestriction</code> method in other parts of the ecosystem. Consequently, if the restriction manager’s logic is flawed, these other parts may also allow unauthorised transfers.</p>\n<p><strong>Foundry POC</strong></p>\n<p>Add this to the <code>Tranche.t.sol</code> contract</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testTransferFromTokensFromBlacklistedAccountWorks</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">targetUser</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">validUntil</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">assume</span><span class=\"mtk1\">(</span><span class=\"mtk11\">baseAssumptions</span><span class=\"mtk1\">(</span><span class=\"mtk12\">validUntil</span><span class=\"mtk1\">, </span><span class=\"mtk12\">targetUser</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">restrictionManager</span><span class=\"mtk1\">.</span><span class=\"mtk11\">updateMember</span><span class=\"mtk1\">(</span><span class=\"mtk12\">targetUser</span><span class=\"mtk1\">, </span><span class=\"mtk12\">validUntil</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">restrictionManager</span><span class=\"mtk1\">.</span><span class=\"mtk11\">members</span><span class=\"mtk1\">(</span><span class=\"mtk12\">targetUser</span><span class=\"mtk1\">), </span><span class=\"mtk12\">validUntil</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">restrictionManager</span><span class=\"mtk1\">.</span><span class=\"mtk11\">updateMember</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">restrictionManager</span><span class=\"mtk1\">.</span><span class=\"mtk11\">members</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">targetUser</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">targetUser</span><span class=\"mtk1\">), </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>As seen even after <code>address(this)</code> stops being a member they could still transfer tokens to another user in as much as said user is still a member, which means a <em>blacklisted</em> user could easily do anything with their tokens all they need to do is to delegate to another member.</p>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Refactor<code>detectTransferRestriction()</code>, i.e modify the method to also validate the sending address (<code>from</code>). Ensure both <code>from</code> and <code>to</code> addresses are valid members before allowing transfers.</p>\n<p>If this is contract’s intended logic then this information should be duly passed to the regulatory bodies that a <code>user</code> can’t really get blacklisted and more of user’s could be stopped from receiving tokens.</p>\n<h3 id=\"assessed-type-4\" style=\"position:relative;\"><a href=\"#assessed-type-4\" aria-label=\"assessed type 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Context</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/779#issuecomment-1734178040\">hieronx (Centrifuge) commented</a>:</strong></p>\n<blockquote>\n<p>This is a design decision. Transferring to a valid member is fine if that destination is still allowed to hold the tokens.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/779#issuecomment-1735811683\">gzeon (judge) commented</a>:</strong></p>\n<blockquote>\n<blockquote>\n<p>This is a design decision. Transferring to a valid member is fine if that destination is still allowed to hold the tokens.</p>\n</blockquote>\n<p>This seems to contradict with <code>Removing an investor from the memberlist in the Restriction Manager locks their tokens. This is expected behaviour.</code> (See <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/README.md?plain=1#L140\">here</a>)</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/779#issuecomment-1735838137\">hieronx (Centrifuge) commented</a>:</strong></p>\n<blockquote>\n<p>Yes you’re right, that’s unfortunate wording. What I said above is correct, and the text in the README is incorrect. What was meant was that it locks their tranche tokens from being redeemed.</p>\n<p>It is indeed fair to say though that, based on the README text, the above issue is valid.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/779#issuecomment-1745021967\">hieronx (Centrifuge) commented</a>:</strong></p>\n<blockquote>\n<p>Mitigated in <a href=\"https://github.com/centrifuge/liquidity-pools/pull/138\">https://github.com/centrifuge/liquidity-pools/pull/138</a></p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this audit, 39 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/548\">report highlighted below</a> by <strong>castle_chain</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/784\">Bauchibred</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/468\">0xpiken</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/427\">BARW</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/397\">0xmystery</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/392\">0xfuje</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/770\">0xLook</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/767\">merlin</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/765\">MohammedRizwan</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/761\">jkoppel</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/740\">jolah1</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/663\">alexzoid</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/653\">sandy</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/649\">btk</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/642\">Kaysoft</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/636\">klau5</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/626\">ast3ros</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/606\">0xAadi</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/597\">Bughunter101</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/585\">0xblackskull</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/559\">0xnev</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/545\">SanketKogekar</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/509\">m_Rassska</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/475\">grearlake</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/471\">nobody2018</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/463\">7ashraf</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/460\">JP_Courses</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/420\">Krace</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/410\">Ch_301</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/319\">lsaudit</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/314\">catellatech</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/246\">imtybik</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/213\">mrudenko</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/207\">Sathish9098</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/187\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/46\">rokinot</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/43\">fatherOfBlocks</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/32\">0xHelium</a>, and <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/25\">degensec</a>.</em></p>\n<h2 id=\"l-01-the-function-addtranche-should-validate-the-tranche-token-decimals-to-make-sure-that-the-decimals-are-not-greater-than-18\" style=\"position:relative;\"><a href=\"#l-01-the-function-addtranche-should-validate-the-tranche-token-decimals-to-make-sure-that-the-decimals-are-not-greater-than-18\" aria-label=\"l 01 the function addtranche should validate the tranche token decimals to make sure that the decimals are not greater than 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01] The function <code>addTranche()</code> should validate the tranche token decimals to make sure that the decimals are not greater than 18</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">addTranche</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint64</span><span class=\"mtk1\"> </span><span class=\"mtk12\">poolId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">trancheId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenName</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenSymbol</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">decimals</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGateway</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Pool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pool</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pools</span><span class=\"mtk1\">[</span><span class=\"mtk12\">poolId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">createdAt</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;PoolManager/invalid-pool&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Tranche</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tranche</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tranches</span><span class=\"mtk1\">[</span><span class=\"mtk12\">trancheId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tranche</span><span class=\"mtk1\">.</span><span class=\"mtk12\">createdAt</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;PoolManager/tranche-already-exists&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">tranche</span><span class=\"mtk1\">.</span><span class=\"mtk12\">poolId</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">poolId</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">tranche</span><span class=\"mtk1\">.</span><span class=\"mtk12\">trancheId</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">trancheId</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   @&gt;   </span><span class=\"mtk12\">tranche</span><span class=\"mtk1\">.</span><span class=\"mtk12\">decimals</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">tranche</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenName</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">tokenName</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">tranche</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenSymbol</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">tokenSymbol</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">tranche</span><span class=\"mtk1\">.</span><span class=\"mtk12\">createdAt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">TrancheAdded</span><span class=\"mtk1\">(</span><span class=\"mtk12\">poolId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">trancheId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h2 id=\"l-02-unlimiting-the-delay-period-with-minimum-threshold-allows-the-delay-period-to-be-set-too-low-and-allows-a-malicious-scheduleupgrade-message-to-be-executed-on-the-root-contract-and-gain-access-on-the-other-contracts\" style=\"position:relative;\"><a href=\"#l-02-unlimiting-the-delay-period-with-minimum-threshold-allows-the-delay-period-to-be-set-too-low-and-allows-a-malicious-scheduleupgrade-message-to-be-executed-on-the-root-contract-and-gain-access-on-the-other-contracts\" aria-label=\"l 02 unlimiting the delay period with minimum threshold allows the delay period to be set too low and allows a malicious scheduleupgrade message to be executed on the root contract and gain access on the other contracts permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/298\">[L-02] Unlimiting the delay period with minimum threshold allows the delay period to be set too low and allows a malicious <code>ScheduleUpgrade</code> message to be executed on the root contract and gain access on the other contracts</a></h2>\n<p><em>Note: this finding was originally submitted separately by the warden at a higher severity; however, it was downgraded to low severity and considered by the judge in scoring. It is being included here for completeness.</em></p>\n<p>Allowing to modify the delay period without minimum threshold can result in set the <code>delay</code> period to a too short period or even zero ,which is allowed according to the code , and this could lead to allowing a malicious <code>ScheduleUpgrade</code> message to pass and a malicious account can gain control over all the contracts of the protocols. </p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>In the <code>Root.sol</code> contract, the protocol implements a maximum threshold in the function <code>file()</code> which can modify the <code>delay</code> variable, so the possibility of the set the delay period to a very long period exists and also setting the delay period to a very short period is still possible, as shown in the <code>file()</code> which will not prevent set the <code>delay</code> period to zero or any short period : </p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">file</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">what</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">data</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">auth</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">what</span><span class=\"mtk1\"> == </span><span class=\"mtk8\">&quot;delay&quot;</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">data</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">MAX_DELAY</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Root/delay-too-long&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">delay</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">data</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">revert</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Root/file-unrecognized-param&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">File</span><span class=\"mtk1\">(</span><span class=\"mtk12\">what</span><span class=\"mtk1\">, </span><span class=\"mtk12\">data</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>So if the <code>delay</code> was set to a very short period and Someone gains control over a router and triggers a malicious <code>ScheduleUpgrade</code> message , the malicious attacker can trigger the <code>executeScheduledRely()</code> function after the <code>delay</code> period, which is too short, to give his address or any contract an <code>auth</code> role on any of the protocol contracts, the attacker can be <code>auth</code> on the <code>escrow</code> contract and steals all the funds from the protocol. </p>\n<p>This attack does not assume that the <code>auth</code> admin on the <code>Root</code> contract is malicious, but it is all about the possibility of setting the <code>delay</code> period to a very short period or even zero, which can be happened mistakenly or intentionally.  </p>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>This vulnerability can be mitigated by implementing a minimum threshold <code>MIN_DELAY</code> to the <code>delay</code> period, so this will prevent setting the <code>delay</code> period to zero or even a very short period. </p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    uint256 private MIN_DELAY = 2 days ;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function file(bytes32 what, uint256 data) external auth {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        if (what == &quot;delay&quot;) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            require(data &lt;= MAX_DELAY, &quot;Root/delay-too-long&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+           require(data &gt;= MIN_DELAY, &quot;Root/delay-too-short&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            delay = data;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            revert(&quot;Root/file-unrecognized-param&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        emit File(what, data);</span></span></span></code></pre>\n<h2 id=\"n-01-unnecessary-checks-can-be-removed-to-enhance-the-code\" style=\"position:relative;\"><a href=\"#n-01-unnecessary-checks-can-be-removed-to-enhance-the-code\" aria-label=\"n 01 unnecessary checks can be removed to enhance the code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-01] Unnecessary checks can be removed, to enhance the code</h2>\n<p><a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/PoolManager.sol#L310\">https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/PoolManager.sol#L310</a></p>\n<p>The <code>require</code> keyword can be removed in the function <code>deployLiquidityPool ()</code>, because the function <code>isAllowedAsPoolCurrency</code> revert on failure in case of the currency is not supported  and always return true on success, so if the check fails the function will revert without executing the <code>require</code> key word.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function isAllowedAsPoolCurrency(uint64 poolId, address currencyAddress) public view returns (bool) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint128 currency = currencyAddressToId[currencyAddress];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(currency != 0, &quot;PoolManager/unknown-currency&quot;); // Currency index on the Centrifuge side should start at 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(pools[poolId].allowedCurrencies[currencyAddress], &quot;PoolManager/pool-currency-not-allowed&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return true;</span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deployLiquidityPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint64</span><span class=\"mtk1\"> </span><span class=\"mtk12\">poolId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">trancheId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currency</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Tranche</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tranche</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pools</span><span class=\"mtk1\">[</span><span class=\"mtk12\">poolId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">tranches</span><span class=\"mtk1\">[</span><span class=\"mtk12\">trancheId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tranche</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;PoolManager/tranche-does-not-exist&quot;</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// Tranche must have been added</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@&gt;        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">isAllowedAsPoolCurrency</span><span class=\"mtk1\">(</span><span class=\"mtk12\">poolId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">currency</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;PoolManager/currency-not-supported&quot;</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// Currency must be supported by pool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">tranche</span><span class=\"mtk1\">.</span><span class=\"mtk12\">liquidityPools</span><span class=\"mtk1\">[</span><span class=\"mtk12\">currency</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;PoolManager/liquidityPool-already-deployed&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pools</span><span class=\"mtk1\">[</span><span class=\"mtk12\">poolId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">createdAt</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;PoolManager/pool-does-not-exist&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h2 id=\"n-02-the-destination-address-should-be-emitted-in-the-userescrow-contract-in-the-function-transferout\" style=\"position:relative;\"><a href=\"#n-02-the-destination-address-should-be-emitted-in-the-userescrow-contract-in-the-function-transferout\" aria-label=\"n 02 the destination address should be emitted in the userescrow contract in the function transferout permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-02] The <code>destination</code> address should be emitted in the userEscrow contract in the function <code>transferOut</code></h2>\n<p><a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/UserEscrow.sol#L49\">https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/UserEscrow.sol#L49</a></p>\n<p>Due to that the receiver can be different address from the user address , the <code>destination</code> address should be emitted.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">transferOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">destination</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">auth</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">destinations</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">][</span><span class=\"mtk12\">destination</span><span class=\"mtk1\">] &gt;= </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;UserEscrow/transfer-failed&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">destination</span><span class=\"mtk1\"> || (</span><span class=\"mtk11\">ERC20Like</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">).</span><span class=\"mtk11\">allowance</span><span class=\"mtk1\">(</span><span class=\"mtk12\">destination</span><span class=\"mtk1\">, </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">) == </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;UserEscrow/receiver-has-no-allowance&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">destinations</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">][</span><span class=\"mtk12\">destination</span><span class=\"mtk1\">] -= </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">SafeTransferLib</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">TransferOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h2 id=\"n-03-the-gettranche-function-should-be-created-in-the-poolmanager-contract-and-used-to-get-the-tranche-from-the-storage-by-specifying-the-poolid-and-trancheid\" style=\"position:relative;\"><a href=\"#n-03-the-gettranche-function-should-be-created-in-the-poolmanager-contract-and-used-to-get-the-tranche-from-the-storage-by-specifying-the-poolid-and-trancheid\" aria-label=\"n 03 the gettranche function should be created in the poolmanager contract and used to get the tranche from the storage by specifying the poolid and trancheid permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-03] The <code>getTranche</code> function should be created in the <code>poolManager</code> contract and used to get the <code>tranche</code> from the storage by specifying the <code>poolId</code> and <code>trancheId</code></h2>\n<p><a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/PoolManager.sol#L308\">https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/PoolManager.sol#L308</a></p>\n<p>The function <code>getTranche()</code> will increase the simplicity and the modularity of the code instead of get the tranche from the storage each time in different functions.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getTranche</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint64</span><span class=\"mtk1\"> </span><span class=\"mtk12\">poolId</span><span class=\"mtk1\"> , </span><span class=\"mtk12\">bytes16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">trancheId</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> ( </span><span class=\"mtk12\">Tranche</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tranche</span><span class=\"mtk1\"> ){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk12\">tranche</span><span class=\"mtk1\"> =  </span><span class=\"mtk12\">pools</span><span class=\"mtk1\">[</span><span class=\"mtk12\">poolId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">tranches</span><span class=\"mtk1\">[</span><span class=\"mtk12\">trancheId</span><span class=\"mtk1\">];</span></span></span></code></pre>\n<p>This function can be used instead of the line of code in the poolManager.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Tranche</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tranche</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pools</span><span class=\"mtk1\">[</span><span class=\"mtk12\">poolId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">tranches</span><span class=\"mtk1\">[</span><span class=\"mtk12\">trancheId</span><span class=\"mtk1\">];</span></span></span></code></pre>\n<h2 id=\"n-04-the-check-of-the-creation-of-the-liquidity-pool-in-the-function-deployliquiditypool-in-the-poolmanager-contract-can-be-removed\" style=\"position:relative;\"><a href=\"#n-04-the-check-of-the-creation-of-the-liquidity-pool-in-the-function-deployliquiditypool-in-the-poolmanager-contract-can-be-removed\" aria-label=\"n 04 the check of the creation of the liquidity pool in the function deployliquiditypool in the poolmanager contract can be removed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-04] The check of the creation of the liquidity pool in the function <code>deployLiquidityPool()</code> in the PoolManager contract can be removed</h2>\n<p><a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/PoolManager.sol#L309\">https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/PoolManager.sol#L309</a></p>\n<p><a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/PoolManager.sol#L314\">https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/PoolManager.sol#L314</a></p>\n<p>The <code>require</code> statement that checks that the pool is created can be removed since there is a check before it that make sure that the tranche token is deployed and the address of it is stored in the <code>pool</code> struct which be be stored only after the pool has been created, so the check of the deployment of the tranche token do the same check of the creation of the pool, so the second check can be removed.</p>\n<p>The check in the function <code>addTranche()</code>, which make sure that the pool is created.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">addTranche</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint64</span><span class=\"mtk1\"> </span><span class=\"mtk12\">poolId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">trancheId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenName</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenSymbol</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">decimals</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGateway</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Pool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pool</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pools</span><span class=\"mtk1\">[</span><span class=\"mtk12\">poolId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@&gt;      </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">createdAt</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;PoolManager/invalid-pool&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Tranche</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tranche</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tranches</span><span class=\"mtk1\">[</span><span class=\"mtk12\">trancheId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tranche</span><span class=\"mtk1\">.</span><span class=\"mtk12\">createdAt</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;PoolManager/tranche-already-exists&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>And the check of the creation of the pool in the function <code>deployLiquidityPool()</code>, which make sure that the tranche token is added and deployed. </p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deployLiquidityPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint64</span><span class=\"mtk1\"> </span><span class=\"mtk12\">poolId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">trancheId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currency</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Tranche</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tranche</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pools</span><span class=\"mtk1\">[</span><span class=\"mtk12\">poolId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">tranches</span><span class=\"mtk1\">[</span><span class=\"mtk12\">trancheId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tranche</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;PoolManager/tranche-does-not-exist&quot;</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// Tranche must have been added</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">isAllowedAsPoolCurrency</span><span class=\"mtk1\">(</span><span class=\"mtk12\">poolId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">currency</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;PoolManager/currency-not-supported&quot;</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// Currency must be supported by pool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">tranche</span><span class=\"mtk1\">.</span><span class=\"mtk12\">liquidityPools</span><span class=\"mtk1\">[</span><span class=\"mtk12\">currency</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;PoolManager/liquidityPool-already-deployed&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pools</span><span class=\"mtk1\">[</span><span class=\"mtk12\">poolId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">createdAt</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;PoolManager/pool-does-not-exist&quot;</span><span class=\"mtk1\">); </span></span></span></code></pre>\n<p>So the check <code>require(pools[poolId].createdAt != 0, \"PoolManager/pool-does-not-exist\");</code> can be removed.</p>\n<h2 id=\"n-05-the-function-updatemember-change-the-state-of-the-contract-but-there-is-no-emitted-event-so-an-event-should-be-emitted\" style=\"position:relative;\"><a href=\"#n-05-the-function-updatemember-change-the-state-of-the-contract-but-there-is-no-emitted-event-so-an-event-should-be-emitted\" aria-label=\"n 05 the function updatemember change the state of the contract but there is no emitted event so an event should be emitted permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-05] The function <code>updateMember()</code> change the state of the contract, but there is no emitted event, so an event should be emitted</h2>\n<p>The function <code>updateMember</code> in the restriction manager contract should emit the event <code>updatedMember()</code> with the right parameters.<br>\n<a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/token/RestrictionManager.sol#L57-L60\">https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/token/RestrictionManager.sol#L57-L60</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">updateMember</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">validUntil</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">auth</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">validUntil</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;RestrictionManager/invalid-valid-until&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">members</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">validUntil</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span></span></span></code></pre>\n<h2 id=\"n-06-the-poolmanager-should-emit-events-in-case-of-transfer-the-tokens-to-the-centrifuge-chains\" style=\"position:relative;\"><a href=\"#n-06-the-poolmanager-should-emit-events-in-case-of-transfer-the-tokens-to-the-centrifuge-chains\" aria-label=\"n 06 the poolmanager should emit events in case of transfer the tokens to the centrifuge chains permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-06] The <code>poolManager</code> should emit events in case of transfer the tokens to the centrifuge chains</h2>\n<p>In the functions <code>transferTrancheTokensToCentrifuge</code>, <code>transferTrancheTokensToEVM</code> and <code>transfer()</code> which burn the tokens and transfer the assets, which is a crucial part of the contract that should emit events in case of transfer of the assets and the burn of the tokens. </p>\n<p><a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/PoolManager.sol#L136-L147\">https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/PoolManager.sol#L136-L147</a></p>\n<p><a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/PoolManager.sol#L149-L163\">https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/PoolManager.sol#L149-L163</a></p>\n<p><a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/PoolManager.sol#L128-L134\">https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/PoolManager.sol#L128-L134</a></p>\n<h2 id=\"n-07-checktransferrestriction-check-can-be-removed-because-the-tranche-token-transferfrom-function-do-this-check-before-transfer-the-tokens\" style=\"position:relative;\"><a href=\"#n-07-checktransferrestriction-check-can-be-removed-because-the-tranche-token-transferfrom-function-do-this-check-before-transfer-the-tokens\" aria-label=\"n 07 checktransferrestriction check can be removed because the tranche token transferfrom function do this check before transfer the tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-07] <code>checkTransferRestriction</code> check can be removed because the tranche token <code>transferFrom</code> function do this check before transfer the tokens</h2>\n<p><a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/InvestmentManager.sol#L473\">https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/InvestmentManager.sol#L473</a><br>\n<a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/InvestmentManager.sol#L474-L477\">https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/InvestmentManager.sol#L474-L477</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkTransferRestriction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;InvestmentManager/trancheTokens-not-a-member&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">lPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">escrow</span><span class=\"mtk1\">), </span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">trancheTokenAmount</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;InvestmentManager/trancheTokens-transfer-failed&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span></code></pre>\n<p>The <code>checkTransferRestriction</code> is performed in the <code>transferFrom</code> call of the tranche token. </p>\n<h2 id=\"n-08-consider-adding-getlpvalues-to-get-the-lpvaluse-from-the-orderbook-to-enhance-the-code\" style=\"position:relative;\"><a href=\"#n-08-consider-adding-getlpvalues-to-get-the-lpvaluse-from-the-orderbook-to-enhance-the-code\" aria-label=\"n 08 consider adding getlpvalues to get the lpvaluse from the orderbook to enhance the code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-08] Consider adding <code>getLpValues()</code> to get the lpValuse from the orderBook to enhance the code</h2>\n<p><a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/InvestmentManager.sol#L247\">https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/InvestmentManager.sol#L247</a></p>\n<p><a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/InvestmentManager.sol#L268\">https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/InvestmentManager.sol#L268</a></p>\n<p><a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/InvestmentManager.sol#L561\">https://github.com/code-423n4/2023-09-centrifuge/blob/512e7a71ebd9ae76384f837204216f26380c9f91/src/InvestmentManager.sol#L561</a></p>\n<p>The contract repeats the code of getting the lpValuse from the storage more than 10 times so the function <code>getLpValues()</code> should be added.  </p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_getLpValues</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\"> , </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> </span><span class=\"mtk11\">retruns</span><span class=\"mtk1\"> ( </span><span class=\"mtk12\">LPValues</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lpValues</span><span class=\"mtk1\"> ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">lpValues</span><span class=\"mtk1\"> =  </span><span class=\"mtk12\">orderbook</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">][</span><span class=\"mtk12\">liquidityPool</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/548#issuecomment-1723506341\">hieronx (Centrifuge) confirmed</a></strong></p>\n<hr>\n<h1 id=\"audit-analysis\" style=\"position:relative;\"><a href=\"#audit-analysis\" aria-label=\"audit analysis permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Audit Analysis</h1>\n<p>For this audit, 20 analysis reports were submitted by wardens. An analysis report examines the codebase as a whole, providing observations and advice on such topics as architecture, mechanism, or approach. The <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/316\">report highlighted below</a> by <strong>ciphermarco</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/719\">cats</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/716\">Sathish9098</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/657\">kaveyjoe</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/555\">0xnev</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/480\">0xbrett8571</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/326\">catellatech</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/782\">jaraxxus</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/747\">Kral01</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/677\">fouzantanveer</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/646\">0xmystery</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/616\">K42</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/598\">hals</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/588\">grearlake</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/574\">rokinot</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/572\">castle_chain</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/571\">lsaudit</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/508\">emerald7017</a>, <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/428\">0x3b</a>, and <a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/266\">foxb868</a>.</em></p>\n<h3 id=\"1-executive-summary\" style=\"position:relative;\"><a href=\"#1-executive-summary\" aria-label=\"1 executive summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Executive Summary</h3>\n<p>For this analysis, I will center my attention on the scope of the ongoing audit <code>2023-09-centrifuge</code>. I begin by outlining the code audit approach employed for the in-scope contracts, followed by sharing my perspective on the architecture, and concluding with observations about the implementation’s code.</p>\n<p><strong>Please note</strong> that unless explicitly stated otherwise, any architectural risks or implementation issues mentioned in this document are not to be considered vulnerabilities or recommendations for altering the architecture or code solely based on this analysis. As an auditor, I acknowledge the importance of thorough evaluation for design decisions in a complex project, taking associated risks into consideration as one single part of an overarching process. It is also important to recognise that the project team may have already assessed these risks and determined the most suitable approach to address or coexist with them.</p>\n<h3 id=\"2-code-audit-approach\" style=\"position:relative;\"><a href=\"#2-code-audit-approach\" aria-label=\"2 code audit approach permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Code Audit Approach</h3>\n<p>Time spent: 18 hours</p>\n<p><strong>2.1 Audit Documentation and Scope</strong></p>\n<p>The initial step involved examining <a href=\"https://github.com/code-423n4/2023-09-centrifuge\">audit documentation and scope</a> to grasp the audit’s concepts and boundaries, and prioritise my efforts. It is worth highlighting the good quality of the <code>README</code> for this audit, as it provides valuable insights and actionable guidance that greatly facilitate the onboarding process for auditors.</p>\n<p><strong>2.2 Setup and Tests</strong></p>\n<p>Setting up to execute <code>forge test</code> was remarkably effortless, greatly enhancing the efficiency of the auditing process. With a fully functional test harness at our disposal, we not only accelerate the testing of intricate concepts and potential vulnerabilities but also gain insights into the developer’s expectations regarding the implementation. Moreover, we can deliver\nmore value to the project by incorporating our proofs of concept into its tests wherever feasible.</p>\n<p><strong>2.3 Code review</strong></p>\n<p>The code review commenced with understanding the ”<code>ward</code> pattern” used to manage authorization accross the system. Thoroughly understanding this pattern made understanding the protocol contracts and its relations much smoother. Throughout this stage, I documented observations and raised questions concerning potential exploits without going too deep.</p>\n<p><strong>2.4 Threat Modelling</strong></p>\n<p>I began formulating specific assumptions that, if compromised, could pose security risks to the system. This process aids me in determining the most effective exploitation strategies. While not a comprehensive threat modeling exercise, it shares numerous similarities with one.</p>\n<p><strong>2.5 Exploitation and Proofs of Concept</strong></p>\n<p>From this step forward, the main process became a loop conditionally encompassing each of the steps 2.3, 2.4, and 2.5, involving attempts at exploitation and the creation of proofs of concept with a little help of documentation or the ever helpful sponsors on Discord. My primary objective in this phase is to challenge critical assumptions, generate new ones in the process, and enhance this process by leveraging coded proofs of concept to expedite the development of successful exploits.</p>\n<p><strong>2.6 Report Issues</strong></p>\n<p>Alghough this step may seem self-explanatory, it comes with certain nuances. Rushing to report vulnerabilities immediately and then neglecting them is unwise. The most effective approach to bring more value to sponsors (and, hopefully, to auditors) is to document what can be gained by exploiting each vulnerability. This assessment helps in evaluating whether these exploits can be strategically combined to create a more significant impact on the system’s security. In some cases, seemingly minor and moderate issues can compound to form a critical vulnerability when leveraged wisely. This has to be balanced with any risks that users may face. In the context of Code4rena audits, zero-days or highly sensitive bugs affecting deployed contracts are given a more cautious and immediate reporting channel.</p>\n<h3 id=\"3-architecture-overview\" style=\"position:relative;\"><a href=\"#3-architecture-overview\" aria-label=\"3 architecture overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Architecture overview</h3>\n<p><strong>3.1 <code>Ward</code> Pattern</strong></p>\n<p>In grasping the audited architecture, one must comprehend some simple yet potent principles. The first concept is the <code>ward</code> pattern, employed to oversee authorisation throughout the protocol. I consider it an elegant and secure method. Below is the ‘ward’ graph supplied by the Centrifuge team:</p>\n<p><img src=\"https://raw.githubusercontent.com/code-423n4/2023-09-centrifuge/main/images/wards.png?raw=true\" alt=\"Wards Overview\"></p>\n<p>And, to better contextualise, this is a quote from the audit’s <code>README</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">The Root contract is a ward on all other contracts. The PauseAdmin can instantaneously pause the protocol. The DelayedAdmin can make itself ward on any contract through Root.relyContract, but this needs to go through the timelock specified in Root.delay. The Root.delay will initially be set to 48 hours.</span></span></code></pre>\n<p>So how does this work in practice?</p>\n<p>As <code>Root</code> is a ward on all other contracts, any ward on <code>Root</code> can use its <code>relyContract</code> function to become a ward in any of these contracts:</p>\n<p><a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/Root.sol#L90-L93\">https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/Root.sol#L90-L93</a>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function relyContract(address target, address user) public auth {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        AuthLike(target).rely(user);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit RelyContract(target, user);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>The opposite being the <code>denyContract</code> function:</p>\n<p><a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/Root.sol#L98-L102\">https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/Root.sol#L98-L102</a>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function denyContract(address target, address user) public auth {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        AuthLike(target).deny(user);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit DenyContract(target, user);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>The term “rely” is employed to signify “becoming a ward.” Thus, when I state that contract X relies on contract Y, it implies that contract Y assumes the role of a ward within contract X. Conversely, the verb “deny” is utilised to describe the opposing action.</p>\n<p>Contracts within the system are anticipated to inherit (or implement) the <a href=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/src/util/Auth.sol\"><code>Auth</code> contract</a>. The <code>Auth</code> contract is exceptionally minimal, and for your reference, I have included it below:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">// SPDX-License-Identifier: AGPL-3.0-only</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">// Copyright (C) Centrifuge 2020, based on MakerDAO dss https://github.com/makerdao/dss</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">pragma solidity 0.8.21;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/// @title  Auth</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/// @notice Simple authentication pattern</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">contract Auth {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    mapping(address =&gt; uint256) public wards;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    event Rely(address indexed user);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    event Deny(address indexed user);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /// @dev Give permissions to the user</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function rely(address user) external auth {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        wards[user] = 1;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit Rely(user);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /// @dev Remove permissions from the user</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function deny(address user) external auth {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        wards[user] = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit Deny(user);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /// @dev Check if the msg.sender has permissions</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    modifier auth() {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(wards[msg.sender] == 1, &quot;Auth/not-authorized&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>With these capabilities at their disposal, any <code>ward</code> in <code>Root</code> has the ability to invoke <code>root.allowContract(address target, address user)</code>. This action designates <code>user</code> — whether an Externally Owned Account (EOA) or Contract — as a <code>ward</code> within the <code>contract</code>. As a result, the <code>Root</code>’s existing <code>wards</code> can execute functions within any of the contracts to which <code>Root</code> serves as a <code>ward</code> (i.e. all other contracts in the system).</p>\n<p><strong>3.1.1 The <code>PauseAdmin</code></strong></p>\n<p>The <code>PauseAdmin</code> represents a concise contract equipped with functions to manage <code>pausers</code>, those who can call its <code>pause</code> function. Its <code>pause</code> function, in turn, invokes the <code>Root.pause</code> function to suspend protocol operations. We will shortly delve into the mechanics of this pausing process. To facilitate the ability to call <code>Root.pause</code>, <code>PauseAdmin</code> holds the status of a <code>ward</code> within the <code>Root</code> contract.</p>\n<p><strong>3.1.2 The <code>DelayedAdmin</code></strong></p>\n<p>The <code>DelayedAdmin</code> is another concise contract with the capability to pause and unpause the protocol. Additionally, it possesses the ability, after a <code>delay</code> set in the <code>Root</code> contract by its deployer (the first ward) and other wards, to designate itself or other Externally Owned Accounts (EOAs) or contracts as <code>wards</code> within the <code>Root</code> contract. This delay is enforced due to the <code>DelayedAdmin</code> implementing a function to invoke <code>root.scheduleRely</code>. The <code>root.scheduleRely</code> function is responsible for scheduling an address to become a <code>ward</code> within the <code>Root</code> contract.</p>\n<p>The <code>pauseAdmin.scheduleRely</code> function:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    // PauseAdmin.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function scheduleRely(address target) public auth {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        root.scheduleRely(target);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>Which calls the <code>root.scheduleRely</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Root.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function scheduleRely(address target) external auth {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        schedule[target] = block.timestamp + delay;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit RelyScheduled(target, schedule[target]);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>As per the documentation provided, the initial setting for this <code>delay</code> is 48 hours. Once a rely is scheduled, it can subsequently be cancelled using the <code>delayedAdmin.cancelRely</code> function:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    // PauseAdmin.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function cancelRely(address target) public auth {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        root.cancelRely(target);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>That function calls the <code>root.cancelRely</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Root.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function cancelRely(address target) external auth {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        schedule[target] = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit RelyCancelled(target);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>Or executed to make it effective by <code>executeScheduledRely</code> in the <code>Root</code> contract after the <code>delay</code> has passed:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Root.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function executeScheduledRely(address target) public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(schedule[target] != 0, &quot;Root/target-not-scheduled&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(schedule[target] &lt; block.timestamp, &quot;Root/target-not-ready&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        wards[target] = 1;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit Rely(target);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        schedule[target] = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p><strong>3.1.3 A Problem with <code>DelayedAdmin</code></strong></p>\n<p>Whilst conducting a comparison between the audit documentation and the system, I identified a critical discrepancy in the <code>DelayedAdmin</code>. The project team outlined several potential emergency scenarios to aid auditors in comprehending the protocol’s security model. One of these scenarios is outlined below:</p>\n<blockquote>\n<p>”<strong>Someone controls 1 pause admin and triggers a malicious <code>pause()</code></strong></p>\n<ul>\n<li>The delayed admin is a <code>ward</code> on the pause admin and can trigger <code>PauseAdmin.removePauser</code>.</li>\n<li>It can then trigger <code>root.unpause()</code>.”</li>\n</ul>\n</blockquote>\n<p>The issue I have identified is that the <code>DelayedAdmin</code>, in its current form, does not incorporate any functions to <code>PauseAdmin.removePauser</code>. Given that I believe this deviates from a critical aspect of the protocol’s security model, I have chosen to report this discovery with a Medium severity rating. However, I acknowledge that it could be argued as more appropriate for a Low severity rating if it is ultimately deemed a mere deviation from the specification. I have expressed my viewpoint in the issue report, and I am confident that it will be evaluated with care and a comprehensive consideration of the real-world risks it may present, which might diverge from my own assessment.</p>\n<p>Following discussions with sponsors to gain deeper insights into the implications of a <code>DelayedAdmin</code> unable to execute <code>pauseAdmin.removePause</code>, they exposed two workarounds to address this issue. These workarounds do not alter my stance on the severity within the context of an audit competition but offer valuable perspectives from the project team to enhance our understanding of the system’s security model and its ability to withstand unforeseen failures.</p>\n<p><strong>3.1.3.1 The Delayed Rescue</strong></p>\n<p>In a delayed rescue the project team could use the <code>DelayedAdmin</code> to:</p>\n<ol>\n<li>Call <code>root.scheduleRely</code> to make a contract or EOA (let’s call it <code>delayedRescuer</code>) an <code>ward</code> in the <code>Root</code> contract;</li>\n<li>Wait the set <code>delay</code>, initially be set to 48 hours, to pass;</li>\n<li>Use <code>Rescuer</code> to call <code>root.relyContract(address(pauseAdmin), address(delayedRescuer))</code> to become a ward on the <code>pauseAdmin</code>;</li>\n<li>Finally call <code>pauseAdmin.removePauser(address(maliciousPauser))</code> to remove the malicious <code>pauser</code>.</li>\n</ol>\n<p>It is elegant but comes with the drawback of having to wait for the <code>delay</code> set in the <code>Root</code> contract, which is not the intended design of this setup.</p>\n<p><strong>3.1.3.2 The Prompt Rescue</strong></p>\n<p>In the prompt rescue, a contract (let’s call it <code>promptRescuer</code>) could be made a ward in the <code>root</code> contract to:</p>\n<ol>\n<li>Call <code>root.relyContract(address(pauseAdmin), address(promptRescuer))</code>;</li>\n<li>Call <code>pauseAdmin.removePauser(address(maliciousPauser))</code>;</li>\n<li>Possibly call <code>root.denyContract(address(promptRescuer))</code>;</li>\n</ol>\n<p>In <code>Root</code>, when one contract designates another as its ward, it always introduces certain risks. However, by employing the Spell pattern, it significantly mitigates at least one of these risks.</p>\n<p><strong>3.2 The Spell Pattern</strong></p>\n<p>Having understood how these two admins fit into the <code>ward</code> pattern, and analysing the rescue operation, shows how simple and potentially powerful the pattern can be. But to realise its power in a more secure manner, we need to enter the Spell pattern.</p>\n<p>References to spells can be identified within the codebase’s tests, and the sponsors have publicly shared their intentions through the audit competition’s Discord channel. When utilising <code>root.relyContract</code>, it is essential to anticipate that the intended targets for the <code>wards</code> in <code>Root</code> will employ the <a href=\"https://docs.makerdao.com/smart-contract-modules/governance-module/spell-detailed-documentation\">spell pattern from MakerDAO</a>. Besides implementation details and other factors to consider, the utmost detail to retain in the context of this analysis is that <em>“a spell can only be cast once”</em>.</p>\n<p>By joining the project’s <code>ward</code> pattern with the Spell pattern, we can fully understand how critical security operations are expected to flow throughout the system.</p>\n<p><strong>3.3 Pausing the Protocol</strong></p>\n<p>As mentioned before, the <code>PauseAdmin</code> has the responsibility to manage the <code>pausers</code> who can pause the protocol. We have seen that the <code>pauseAdmin</code>, triggered by one of its <code>pausers</code>, calls the <code>pause</code> function in the <code>Root</code> contract. The <code>Root</code> contract then sets the variable <code>bool public paused</code> to <code>true</code>. Here is the <code>root.pause</code> function’s implementation:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"48\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Root.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function pause() external auth {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        paused = true;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit Pause();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>But how can it pause the whole protocol?</p>\n<p>The protocol’s flow of communication uses a hub-and-spoke model with the <code>Gateway</code> in the middle. According to the audit’s <code>README</code> documentation, the <code>Gateway</code> contract is an intermediary contract that encodes and decodes messages using the <code>Message</code> contract, and handles routing to and from Centrifuge. This is the graph made available by the project team:</p>\n<p><img src=\"https://github.com/code-423n4/2023-09-centrifuge/blob/main/images/contracts.png?raw=true\" alt=\"High Level Contract Overview\"></p>\n<p>The <code>Gateway</code> implements the <code>pauseable</code> modifier:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"49\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Gateway.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    modifier pauseable() {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(!root.paused(), &quot;Gateway/paused&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>This modifier is employed in all critical incoming and outgoing operations within the <code>Gateway</code>. Then if <code>root.paused</code> is set to <code>true</code>, it halts the “hub” by blocking these operations, thus interrupting the flow of communication in the protocol.</p>\n<p><strong>3.3.1 Redundancy?</strong></p>\n<p>It is important to highlight that both <code>DelayedAdmin</code> and <code>PauseAdmin</code> have the capability to invoke <code>root.pause</code> directly in order to pause the protocol. What might initially appear as redundancy seems to be, in fact, a well-considered implementation of secure compartmentalization.</p>\n<p><code>DelayedAdmin</code> possesses a broader range of powers beyond the functions to <code>pause</code> and <code>unpause</code> the protocol. In contrast, <code>PauseAdmin</code> primarily oversees <code>pausers</code> with the singular purpose of allowing them to pause the protocol. Considering that <code>DelayedAdmin</code> has the potential to cause more harm to the protocol, it should be subject to a stricter oversight, while <code>pausers</code> may adhere to a less stringent regime. While <code>PauseAdmin</code> can disrupt the protocol and cause damage by initiating pauses, this impact pales in comparison to what <code>DelayedAdmin</code>\ncould potentially do if not restricted during the <code>Root</code>’s <code>delay</code>.</p>\n<p><strong>3.4 Liquidity Pools</strong></p>\n<p>Supported by this architecture lies the liquidity pools. These liquidity pools can be deployed on any EVM-compatible blockchain, whether it’s on a Layer 1 or Layer 2, in response to market demand. All of these systems are ultimately interconnected with the Centrifuge chain, which holds the responsibility of managing the Real-World Assets (RWA) pools:</p>\n<p><img src=\"https://gist.githubusercontent.com/ciphermarco/438959a403457ab4bb4fc54838cde63c/raw/4a6da758fcb013c6a954d9309634c972034b1a0e/liquidity-pools.png\" alt=\"Liquidity Pools\"></p>\n<p>Every tranche, symbolized by a Tranche Token (TT), represents varying levels of risk exposure for investors. For an overview of the authorization relations, you can refer to the <a href=\"#31-ward-pattern\">Ward Pattern section</a>, and to understand the communication flow, visit the <a href=\"#33-pausing-the-protocol\">Pausing the Protocol section</a>.</p>\n<p><strong>3.5 Upgrading the Protocol</strong></p>\n<p>Another interesting aspect of the architecture is the deliberate choice to use contract migrations instead of upgradeable proxy patterns. Upgrades to the protocol can be achieved by utilising the Spell pattern to re-organize <code>wards</code> and “rely” links across the system. To initiate an upgrade, a Spell contract is scheduled through the <code>root.scheduleRely</code> function. After the specified <code>delay</code> period, the upgrade can be executed by using <code>root.executeScheduledRely</code> to complete its tasks in a one-shot fashion. Should the need to cancel the upgrade arise, <code>root.cancelRely</code> can be called to cancel the scheduled rely operation.”</p>\n<p><strong>3.6 Centralisation Risks</strong></p>\n<p>In the context of this analysis, it is imperative to underscore that the usage of “centralisation” specifically pertains to the potential single point of failure within the project team’s assets, such as the scenario where only one key needs to be compromised in order to compromise the whole system. I am not delving into concerns associated with the likelihood of collusion amongst key personnel.</p>\n<p>The most significant concern regarding centralisation lies in the <code>Root</code> contract’s <code>wards</code>. Therefore, it is highly recommended to manage these <code>wards</code> through multi-signature schemes to mitigate the risk of a single point of failure within the system. This encompasses any contract that could potentially become a <code>ward</code> in <code>Root</code>, including contracts like <code>DelayedAdmin</code> despite its temporary limitation of having to await the <code>delay</code> set in the <code>Root</code> contract.</p>\n<p>Another noteworthy potential single point of failure lies in the <code>Router</code> contract, should it become compromised, as mentioned in the audit’s <code>README</code> documentation. This situation can be rectified through a sequence of operations involving the <code>PauseAdmin</code> and <code>DelayedAdmin</code>, or even solely relying on the <code>DelayedAdmin</code>’s capabilities.</p>\n<p>There are other critical entities within the architecture that have the potential to act as single points of failure, leading to varying degrees of damage. However, for the specific use case at hand, I find the existing tools and safeguards to be adequate for mitigating risks, particularly when keys are safeguarded through multi-signature schemes and other strategies that require careful consideration. These aspects are beyond the scope of this analysis; the same applies to what occurs within the Centrifuge chain.</p>\n<h3 id=\"4-implementation-notes\" style=\"position:relative;\"><a href=\"#4-implementation-notes\" aria-label=\"4 implementation notes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. Implementation Notes</h3>\n<p>Throughout the audit, certain implementation details stood out as note worthy, and a portion of these could prove valuable for this analysis.</p>\n<p><strong>4.1 General Impressions</strong></p>\n<p>The codebase stood to what is promised in the audit’s <code>README</code>, so I will just paste it here:</p>\n<blockquote>\n<p>The coding style of the liquidity-pools code base is heavily inspired by MakerDAO’s coding style. Composition over inheritance, no upgradeable proxies but rather using contract migrations, and as few dependencies as possible. Authentication uses the ward pattern, in which addresses can be relied or denied to get access. Key parameter updates of contracts are executed through file methods.</p>\n</blockquote>\n<p>It was genuinely enjoyable to review this codebase. The code has been meticulously designed to prioritise simplicity. It strikes the right balance of complexity, avoiding unnecessary complications.</p>\n<p><strong>4.2 Composition over Inheritance</strong></p>\n<p>The codebase’s pivotal choice of favoring composition over inheritance, coupled with thoughtful coding practices, has allowed for the creation of clean and very comprehensible code, free from convoluted inheritance hierarchies that confuse even the project developers themselves. The significance of this choice in enhancing the security of the protocol cannot be overstated. Clear and well-organised code not only prevents the introduction of vulnerabilities but also simplifies the process of detecting and resolving any potential issues. And, my opinion is that opting for composition over inheritance significantly contributed to achieving this objective.</p>\n<p><strong>4.3 Tests</strong></p>\n<p>As mentioned in <strong>2.2 Setup and Tests</strong>, executing the tests using <code>forge</code> was effortless, significantly expediting our work as auditors. Running <code>forge coverage</code> also provides a convenient table summarizing the code coverage for these tests:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"50\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">$ forge coverage</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[... snip ...]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| File                                  | % Lines           | % Statements      | % Branches       | % Funcs          |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">|---------------------------------------|-------------------|-------------------|------------------|------------------|</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| script/Axelar.s.sol                   | 0.00% (0/32)      | 0.00% (0/35)      | 0.00% (0/2)      | 0.00% (0/2)      |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| script/Deployer.sol                   | 0.00% (0/40)      | 0.00% (0/42)      | 100.00% (0/0)    | 0.00% (0/4)      |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| script/Permissionless.s.sol           | 0.00% (0/20)      | 0.00% (0/21)      | 0.00% (0/2)      | 0.00% (0/2)      |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| src/Escrow.sol                        | 100.00% (2/2)     | 100.00% (2/2)     | 100.00% (0/0)    | 100.00% (1/1)    |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| src/InvestmentManager.sol             | 97.37% (185/190)  | 96.47% (246/255)  | 61.11% (55/90)   | 97.62% (41/42)   |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| src/LiquidityPool.sol                 | 100.00% (64/64)   | 100.00% (86/86)   | 100.00% (4/4)    | 100.00% (38/38)  |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| src/PoolManager.sol                   | 95.96% (95/99)    | 94.59% (105/111)  | 74.07% (40/54)   | 94.12% (16/17)   |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| src/Root.sol                          | 100.00% (22/22)   | 100.00% (22/22)   | 100.00% (8/8)    | 100.00% (8/8)    |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| src/UserEscrow.sol                    | 100.00% (8/8)     | 100.00% (8/8)     | 100.00% (4/4)    | 100.00% (2/2)    |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| src/admins/DelayedAdmin.sol           | 100.00% (4/4)     | 100.00% (4/4)     | 100.00% (0/0)    | 100.00% (4/4)    |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| src/admins/PauseAdmin.sol             | 100.00% (5/5)     | 100.00% (5/5)     | 100.00% (0/0)    | 100.00% (3/3)    |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| src/gateway/Gateway.sol               | 93.42% (71/76)    | 91.86% (79/86)    | 76.47% (26/34)   | 100.00% (17/17)  |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| src/gateway/Messages.sol              | 59.26% (96/162)   | 59.77% (153/256)  | 16.67% (1/6)     | 55.00% (44/80)   |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| src/gateway/routers/axelar/Router.sol | 100.00% (8/8)     | 100.00% (9/9)     | 100.00% (4/4)    | 100.00% (3/3)    |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| src/gateway/routers/xcm/Router.sol    | 0.00% (0/38)      | 0.00% (0/46)      | 0.00% (0/20)     | 0.00% (0/9)      |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| src/token/ERC20.sol                   | 97.40% (75/77)    | 96.51% (83/86)    | 95.00% (38/40)   | 93.33% (14/15)   |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| src/token/RestrictionManager.sol      | 100.00% (15/15)   | 100.00% (17/17)   | 80.00% (8/10)    | 100.00% (6/6)    |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| src/token/Tranche.sol                 | 100.00% (18/18)   | 100.00% (31/31)   | 100.00% (4/4)    | 75.00% (9/12)    |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| src/util/Auth.sol                     | 100.00% (4/4)     | 100.00% (4/4)     | 100.00% (0/0)    | 100.00% (2/2)    |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| src/util/BytesLib.sol                 | 0.00% (0/28)      | 0.00% (0/28)      | 0.00% (0/16)     | 0.00% (0/7)      |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| src/util/Context.sol                  | 100.00% (1/1)     | 100.00% (1/1)     | 100.00% (0/0)    | 100.00% (1/1)    |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| src/util/Factory.sol                  | 100.00% (24/24)   | 100.00% (37/37)   | 100.00% (0/0)    | 100.00% (3/3)    |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| src/util/MathLib.sol                  | 0.00% (0/30)      | 0.00% (0/38)      | 0.00% (0/6)      | 0.00% (0/3)      |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| src/util/SafeTransferLib.sol          | 100.00% (7/7)     | 100.00% (9/9)     | 66.67% (4/6)     | 100.00% (3/3)    |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| test/TestSetup.t.sol                  | 0.00% (0/49)      | 0.00% (0/72)      | 0.00% (0/6)      | 0.00% (0/9)      |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| test/mock/AxelarGatewayMock.sol       | 100.00% (4/4)     | 100.00% (4/4)     | 100.00% (0/0)    | 100.00% (2/2)    |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| test/mock/GatewayMock.sol             | 2.13% (1/47)      | 2.13% (1/47)      | 100.00% (0/0)    | 9.09% (1/11)     |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| test/mock/Mock.sol                    | 25.00% (1/4)      | 25.00% (1/4)      | 100.00% (0/0)    | 25.00% (1/4)     |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| Total                                 | 65.86% (710/1078) | 66.40% (907/1366) | 62.03% (196/316) | 70.65% (219/310) |</span></span></code></pre>\n<p>Coverage, while not providing a comprehensive view of what is tested and how thoroughly, can serve as a valuable indicator of the project’s commitment to testing practices. Based on the coverage within the audit’s scope and my closer assessment of the test files, I deem the testing practices fitting for this stage of development.</p>\n<p><strong>4.4 Comments</strong></p>\n<p>As previously mentioned, the code is generally clean and strategically straightforward; even so, comments can further enhance the experience for both auditors and developers. In the context of this codebase, I believe comments are generally effective in delivering value to readers; however, there are a few sections that could benefit from additional comments.</p>\n<p>I expect special attention to more detailed comments in mathematical and pricing operations like, such as those found in <code>InvestmentManager.convertToShares</code> and <code>InvestmentManager.converToAssets</code>. While these operations are not inherently complex, such comments are crucial because there are two phases of finding bugs in mathematical operations in a code. Usually, the easier one for most auditors is to spot a discrepancy between the intention the comments documenting the code transmit and the code itself. The other one is questioning the mathematical foundations and correctness of the formulas used. Being specific when commenting on the expected outcomes of calculations within the code greatly aids to address the former.</p>\n<p><strong>4.5 Solidity Versions</strong></p>\n<p>When evaluating the quality of a codebase, it is a sensible approach to examine the range of Solidity versions accepted throughout the codebase:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"51\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">$ grep --include \\*.sol --exclude-dir forge-std -hr &quot;pragma solidity&quot; | sort | uniq -c | sort -n</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      1 pragma solidity ^0.8.20;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      1 // pragma solidity 0.8.21;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     47 pragma solidity 0.8.21;</span></span></code></pre>\n<p>The majority of our codebase currently relies on version <code>0.8.21</code>, a choice that I consider highly advantageous. And, using <code>^0.8.20</code> is obviously not a problem.</p>\n<p>Whilst it is true that there are valid points both in favor of and against adopting the latest Solidity version, I believe this debate holds little relevance for the project at this stage. Opting for the most recent version is unquestionably a superior choice over potentially risky outdated versions.</p>\n<h3 id=\"5-conclusion\" style=\"position:relative;\"><a href=\"#5-conclusion\" aria-label=\"5 conclusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. Conclusion</h3>\n<p>Auditing this codebase and its architectural choices has been a delightful experience. Inherently complex systems greatly benefit from strategically implemented simplifications, and I believe this project has successfully struck a harmonious balance between the imperative for simplicity and the challenge of managing complexity. I hope that I have been able to offer a valuable overview of the methodology utilised during the audit of the contracts within scope, along with pertinent insights for the project team and any party interested in analysing this codebase.</p>\n<p><strong>Time spent:</strong><br>\n18 hours</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-09-centrifuge-findings/issues/316#issuecomment-1723507559\">hieronx (Centrifuge) acknowledged</a></strong></p>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Audits incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Audit submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk6 { color: #D7BA7D; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#medium-risk-findings-8\">Medium Risk Findings (8)</a></p>\n<ul>\n<li><a href=\"#m-01-onlycentrifugechainorigin-cant-require-msgsender-equal-axelargateway\">[M-01] <code>onlyCentrifugeChainOrigin()</code> can’t require <code>msg.sender</code> equal <code>axelarGateway</code></a></li>\n<li><a href=\"#m-02-liquiditypoolrequestredeemwithpermit-transaction-can-be-front-run-with-the-different-liquidity-pool\">[M-02] <code>LiquidityPool::requestRedeemWithPermit</code> transaction can be front run with the different liquidity pool</a></li>\n<li><a href=\"#m-03-cached-domain_separator-is-incorrect-for-tranche-tokens-potentially-breaking-permit-integrations\">[M-03] Cached <code>DOMAIN_SEPARATOR</code> is incorrect for tranche tokens potentially breaking permit integrations</a></li>\n<li><a href=\"#m-04-you-can-deposit-really-small-amount-for-other-users-to-dos-them\">[M-04] You can deposit really small amount for other users to DoS them</a></li>\n<li><a href=\"#m-05-investors-claiming-their-maxdeposit-by-using-the-liquiditypooldeposit-will-cause-other-users-to-be-unable-to-claim-their-maxdepositmaxmint\">[M-05] Investors claiming their <code>maxDeposit</code> by using the <code>LiquidityPool.deposit()</code> will cause other users to be unable to claim their <code>maxDeposit</code>/<code>maxMint</code></a></li>\n<li><a href=\"#m-06-delayedadmin-cannot-pauseadminremovepauser\">[M-06] DelayedAdmin Cannot <code>PauseAdmin.removePauser</code></a></li>\n<li><a href=\"#m-07-tranchetokenamount-should-be-rounded-up-when-proceeding-to-a-withdrawal-or-previewing-a-withdrawal\">[M-07] <code>trancheTokenAmount</code> should be rounded UP when proceeding to a withdrawal or previewing a withdrawal</a></li>\n<li><a href=\"#m-08-the-restriction-manager-does-not-completely-implement-erc1404-which-leads-to-accounts-that-are-supposed-to-be-restricted-actually-having-access-to-do-with-their-tokens-as-they-see-fit\">[M-08] The Restriction Manager does not completely implement ERC1404 which leads to accounts that are supposed to be restricted actually having access to do with their tokens as they see fit</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#l-01-the-function-addtranche-should-validate-the-tranche-token-decimals-to-make-sure-that-the-decimals-are-not-greater-than-18\">L-01 The function <code>addTranche()</code> should validate the tranche token decimals to make sure that the decimals are not greater than 18</a></li>\n<li><a href=\"#l-02-unlimiting-the-delay-period-with-minimum-threshold-allows-the-delay-period-to-be-set-too-low-and-allows-a-malicious-scheduleupgrade-message-to-be-executed-on-the-root-contract-and-gain-access-on-the-other-contracts\">[L-02] Unlimiting the delay period with minimum threshold allows the delay period to be set too low and allows a malicious <code>ScheduleUpgrade</code> message to be executed on the root contract and gain access on the other contracts</a></li>\n<li><a href=\"#n-01-unnecessary-checks-can-be-removed-to-enhance-the-code\">N-01 Unnecessary checks can be removed, to enhance the code</a></li>\n<li><a href=\"#n-02-the-destination-address-should-be-emitted-in-the-userescrow-contract-in-the-function-transferout\">N-02 The <code>destination</code> address should be emitted in the userEscrow contract in the function <code>transferOut</code></a></li>\n<li><a href=\"#n-03-the-gettranche-function-should-be-created-in-the-poolmanager-contract-and-used-to-get-the-tranche-from-the-storage-by-specifying-the-poolid-and-trancheid\">N-03 The <code>getTranche</code> function should be created in the <code>poolManager</code> contract and used to get the <code>tranche</code> from the storage by specifying the <code>poolId</code> and <code>trancheId</code></a></li>\n<li><a href=\"#n-04-the-check-of-the-creation-of-the-liquidity-pool-in-the-function-deployliquiditypool-in-the-poolmanager-contract-can-be-removed\">N-04 The check of the creation of the liquidity pool in the function <code>deployLiquidityPool()</code> in the PoolManager contract can be removed</a></li>\n<li><a href=\"#n-05-the-function-updatemember-change-the-state-of-the-contract-but-there-is-no-emitted-event-so-an-event-should-be-emitted\">N-05 The function <code>updateMember()</code> change the state of the contract, but there is no emitted event, so an event should be emitted</a></li>\n<li><a href=\"#n-06-the-poolmanager-should-emit-events-in-case-of-transfer-the-tokens-to-the-centrifuge-chains\">N-06 The <code>poolManager</code> should emit events in case of transfer the tokens to the centrifuge chains</a></li>\n<li><a href=\"#n-07-checktransferrestriction-check-can-be-removed-because-the-tranche-token-transferfrom-function-do-this-check-before-transfer-the-tokens\">N-07 <code>checkTransferRestriction</code> check can be removed because the tranche token <code>transferFrom</code> function do this check before transfer the tokens</a></li>\n<li><a href=\"#n-08-consider-adding-getlpvalues-to-get-the-lpvaluse-from-the-orderbook-to-enhance-the-code\">N-08 Consider adding <code>getLpValues()</code> to get the lpValuse from the orderBook to enhance the code</a></li>\n</ul>\n</li>\n<li><a href=\"#audit-analysis\">Audit Analysis</a></li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>"
}